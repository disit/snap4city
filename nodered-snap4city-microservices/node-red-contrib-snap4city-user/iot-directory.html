<!--/* NODE-RED-CONTRIB-SNAP4CITY-USER
   Copyright (C) 2018 DISIT Lab http://www.disit.org - University of Florence

   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU Affero General Public License as
   published by the Free Software Foundation, either version 3 of the
   License, or (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Affero General Public License for more details.

   You should have received a copy of the GNU Affero General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>. */-->
<style>



#node-input-nodes-target-container {
    position: relative;
}
#node-input-nodes-target-container li {
    padding: 2px 5px; get
    background: none;
    font-size: 0.8em;
    margin:0;
    white-space: nowrap;
}
#node-input-nodes-target-container li label {
    margin-bottom: 0;
    width: 100%;
}
#node-input-nodes-target-container li label input {
    vertical-align: top;
    width:15px;
    margin-right: 10px;
}
#node-input-nodes-target-container li:hover,
#node-input-nodes-target-container li:hover .node-input-target-node-sublabel {
    background: #f0f0f0;
}

#node-input-nodes-target-container li:hover .node-input-target-node-sublabel2 {
    background: #f0f0f0;
}

/* labels inside rows,  tab1 */
.node-input-target-node-label{
	style:"white-space:nowrap";
	font-size: 0.85em;
}
.node-input-target-node-sublabel {
    position:absolute;
    right: 0px;
    padding-right: 10px;
    padding-left: 10px;
    font-size: 0.85em;
    background: #fbfbfb;
}

.node-input-target-node-sublabel2 {
    position:absolute; 
  	left:40%;
    padding-right: 10px;
    padding-left: 10px;
    font-size: 0.85em;
    background: #fbfbfb;
}

/* labels inside rows,  tab2 */

#node-input-nodes-target-container-tab2 {
    position: relative;
}
#node-input-nodes-target-container-tab2 li {
    padding: 2px 5px; get
    background: none;
    font-size: 0.8em;
    margin:0;
    white-space: nowrap;
}
#node-input-nodes-target-container-tab2 li label {
    margin-bottom: 0;
    width: 100%;
}
#node-input-nodes-target-container-tab2 li label input {
    vertical-align: top;
    width:15px;
    margin-right: 10px;
}
#node-input-nodes-target-container-tab2 li:hover,
#node-input-nodes-target-container-tab2 li:hover .node-input-target-node-sublabel-tab2 {
    background: #f0f0f0;
}

#node-input-nodes-target-container-tab2 li:hover .node-input-target-node-sublabel2-tab2 {
    background: #f0f0f0;
}

#node-input-nodes-target-container-tab2 li:hover .node-input-target-node-sublabel3-tab2 {
    background: #f0f0f0;
}





.node-input-target-node-label-tab2{
	style:"white-space:nowrap";
	font-size: 0.85em;
}
.node-input-target-node-sublabel-tab2 {
    position:absolute;
    right: 0px;
    padding-right: 10px;
    padding-left: 10px;
    font-size: 0.85em;
    background: #fbfbfb;
}

.node-input-target-node-sublabel2-tab2 {
    position:absolute; 
  	left:40%;
    padding-right: 10px;
    padding-left: 10px;
    font-size: 0.85em;
    background: #fbfbfb;
}

.node-input-target-node-sublabel3-tab2 {
    position:absolute; 
  	left:60%;
    padding-right: 10px;
    padding-left: 10px;
    font-size: 0.85em;
    background: #fbfbfb;
}

.form-row.iot-directory-form-row label{
	min-width:30%!important;
}

.form-row.iot-directory-form-row input{
	width: 220px;

}

.form-row.iot-directory-form-row .icon-tag{

	margin-right: 5px;
} 

/* Style the tab */
.tab {
    overflow: hidden;
    border: 1px solid #ccc;
    background-color: #f1f1f1;
    width: 100%;
}

/* Style the buttons inside the tab */
.tab button {
    background-color: inherit;
    float: left;
    border: none;
    outline: none;
    cursor: pointer;
    padding: 14px 16px;
    transition: 0.3s;
    font-size: 17px;
    width: 50%;
}

/* Change background color of buttons on hover */
.tab button:hover {
    background-color: #ddd;
}

/* Create an active/current tablink class */
.tab button.active {
    background-color: #ccc;
}

/* Style the tab content */
.tabcontent {
    
    padding: 6px 12px;
    padding-top: 25px;
    border:1px solid #ccc;
    border-top: none;
}

#retrieve-selected{
	display:  none;
}

#retrieve-wrapper{
	display: none;
}
#target-wrapper{
	display: inline;
}

#marker-wrapper{
	display: none;
}

#path-wrapper{
	display: none;
}

#polygon-wrapper{
	display: none;
}

#retrieve-wrapper-tab2{
	display: none;
}
#target-wrapper-tab2{
	display: inline;
}


    
/*.my-div-icon {
				width: 25px;
				height:25px;
				background: red;
				border: 3px dotted black;
			}
    
 .my-div-icon {
      width: 20px;
      height: 20px;
     border: 2px;
      border-radius: 60% 60% 60% 0;
      background: #00cae9;
      position: absolute;
      transform: rotate(-45deg);
      left: 50%;
      top: 50%;
      margin: -20px 0 0 -20px;
    }


.myPin {
    background: #2f2f2f;
    width: 15px;
    height: 50px;
    background: #00cae9;
    position: relative;
    box-shadow: 0 0 0 10px #89849b;
    margin:1px;

}*/



    
</style>

<script type="text/javascript" src="s4c/js/leaflet.js"></script>
<script type="text/javascript" src="s4c/js/leaflet.draw.js"></script>
<script type="text/javascript" src="s4c/js/jquery.fancytree-all.min.js"></script>
<script type="text/javascript" src="s4c/js/require.js"></script>
<script type="text/javascript" src="s4c/js/jquery-simulate-ext-master/libs/jquery.simulate.js"></script>
<script type="text/javascript" src="s4c/js/jquery-simulate-ext-master/libs/bililiteRange.js"></script>



////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
//			IOT DIRECTORY IN
////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
<!--
<script type="text/javascript">
RED.nodes.registerType('label',{
        category: 'S4CIoT',
        color: '#FFFFFF',
        defaults: {
            name: {
                value: ""
            },
            modcom: {
				required: true
			},
			motivation: {
				required: true
			},
            range: {
                value: "",
                required: false
            }
        },
        inputs:0,
        outputs:0,
        icon: "",
        label: function() {
           return this.name||"label";

        },

        paletteLabel: "label",
    oneditprepare:function(){},
    oneditresize: function(){},
    oneditsave: function(){}
    });

</script>
-->

<script type="text/javascript">

     
    RED.nodes.registerType('iot-directory-in',{
        category: 'S4CIoT',
        color: '#a6bbcf',
        defaults: {
            name: {
                value: ""
            },
            modcom: {
				required: true
			},
			motivation: {
				required: true
			},
			latitude: {
                value: 0.0,
                required: false,
                validate: RED.validators.number()
            },
            longitude: {
                value: 0.0,
                required: false,
                validate: RED.validators.number()
            },
            range: {
                value: "",
                required: false
            },
            maxdists: {
                value: 1,
                required: false,
                validate: RED.validators.number()
            },
            maxresults: {
                value: 100,
                required: false,
                validate: RED.validators.number()
            }
        },
        inputs:0,
        outputs:0,
        icon: "bridge.png",
        label: function() {
           return this.name||"iot directory";

        },

        paletteLabel: "iot directory",


       
      
         /******* ON EDIT PREPARE  START ********/
        
        oneditprepare: function(){


        openedTab="Device-based-search"; 
        $("#deviceTabButton").simulate("click");
         
        $("#target-wrapper").fadeIn("fast");
        //$("#node-input-kind-of-search-select").simulate("change");
		if (window.node_input_map) {
		                window.node_input_map.invalidateSize(true);
		            };
		if (window.node_input_map_2) {
		                window.node_input_map_2.invalidateSize(true);
		            };
        
         map = L.map('node-input-map').setView([45.4858914, 9.202094], 10);
         L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
           attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
           }).addTo(map);
         window.node_input_map = map;
         
         
         map2 = L.map('node-input-map-tab2').setView([45.4858914, 9.202094], 10);
         L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
           attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
           }).addTo(map2);
         window.node_input_map_2 = map2;
            
         blueIcon = L.icon({
                        iconUrl: 'data:image/svg+xml;utf-8, \
                                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" width="512px" height="512px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"><g><path d="M256,0C167.641,0,96,71.625,96,160c0,24.75,5.625,48.219,15.672,69.125C112.234,230.313,256,512,256,512l142.594-279.375   C409.719,210.844,416,186.156,416,160C416,71.625,344.375,0,256,0z M256,256c-53.016,0-96-43-96-96s42.984-96,96-96   c53,0,96,43,96,96S309,256,256,256z" fill="#006DF0"/></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>',
                        iconSize:     [38, 95], // size of the icon
                        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
                    });
            //from https://www.flaticon.com/free-icon/map-marker_33622#
        redIcon = L.icon({
                        iconUrl: 'data:image/svg+xml;utf-8, \
                                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" width="512px" height="512px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"><g><path d="M256,0C167.641,0,96,71.625,96,160c0,24.75,5.625,48.219,15.672,69.125C112.234,230.313,256,512,256,512l142.594-279.375   C409.719,210.844,416,186.156,416,160C416,71.625,344.375,0,256,0z M256,256c-53.016,0-96-43-96-96s42.984-96,96-96   c53,0,96,43,96,96S309,256,256,256z" fill="#D80027"/></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>',
                        iconSize:     [38, 95], // size of the icon
                        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
                    });
            
            
 		
        function drawMap(){
		//$(".editor-tray-content").attr("style","width:1000px");
		//$(".editor-tray").css("width","1000px");
			 node = this;
           /* map = L.map('node-input-map').setView([45.4858914, 9.202094], 10);
		//	map=map.update;
		//map._onResize(); 
		//map.invalidateSize(true);
		
            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            window.node_input_map = map;*/
			var mapLayers = {};

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            var editControl = new L.Control.Draw({
                draw: false,
                
                edit: {
                    remove: false,
                    featureGroup: drawnItems,
                    poly: {
                        allowIntersection: false
                    },
                }
            });
            map.addControl(editControl);

            drawControl = new L.Control.Draw({
                remove: false,
                draw: {
                    position: 'topleft',
                    //polyline: false,
                    //marker: false,
                    circlemarker: false,
                   //polygon: false,
                    rectangle: false,
                    polygon: {
                        allowIntersection: false,
                        showArea: true
                    }
            		
                }
            });
            map.addControl(drawControl);

            L.control.layers(mapLayers, {
                'drawlayer': drawnItems
            }, {
                collapsed: true
            }).addTo(map);
            
           

			
            map.on(L.Draw.Event.CREATED, function(e) {
                var fence = e.layer;
                fence.nodeID = node.id;
                if (drawnItems.hasLayer(fence) == false) {
                    drawnItems.addLayer(fence);
                }

                drawControl.remove();
                
                TYPE = e.layerType,
                layer = e.layer;
                
                var resultsIn=drawSelection(layer, drawnItems, TYPE, allDataIn);
                
            	var el;
				$("#node-input-nodes-target-container li input").prop('checked', false);
				$("#node-input-nodes-target-container li").hide();
				for(i=0;i<resultsIn.length;i++){
					el =  $("#node-input-nodes-target-container li input#node-input-target-node-"+resultsIn[i]);
					el.parent().parent().show();
					el.prop('checked', true);

					}
            });

            map.on('draw:edited', function(e) {
                var fences = e.layers;
                fences.eachLayer(function(fence) {
                    fence.shape = "geofence";
                    if (drawnItems.hasLayer(fence) == false) {
                        drawnItems.addLayer(fence);
                    }
                });

               

                drawnItems.eachLayer(function(layer) {
                    var resultsIn=drawSelection(layer, drawnItems, TYPE, allDataIn);
                    var el;
                    $("#node-input-nodes-target-container li input").prop('checked', false);
                    $("#node-input-nodes-target-container li").hide();
                    for(i=0;i<resultsIn.length;i++){
                        el =  $("#node-input-nodes-target-container li input#node-input-target-node-"+resultsIn[i]);
                        el.parent().parent().show();
                        el.prop('checked', true);      

					}
                });


				
				
				
            });

           /* map.on('draw:deleted', function(e) {
                drawControl.addTo(map);
                
                $("#node-input-nodes-target-container li").each(function(){
                    $(this).find("input").prop('checked', false);
                    $(this).show();
                    });
            });*/
            
            L.Control.RemoveAll = L.Control.extend(
                    {
                        options:
                        {
                            position: 'topleft',
                        },
                        onAdd: function (map) {
                            var controlDiv = L.DomUtil.create('div', 'leaflet-draw-toolbar leaflet-bar');
                            L.DomEvent
                                .addListener(controlDiv, 'click', L.DomEvent.stopPropagation)
                                .addListener(controlDiv, 'click', L.DomEvent.preventDefault)
                            .addListener(controlDiv, 'click', function () {
                                drawnItems.clearLayers();
                                 drawControl.addTo(map);
                
                                $("#node-input-nodes-target-container li").each(function(){
                                    $(this).find("input").prop('checked', false);
                                    $(this).show();
                                    });
                            });

                            var controlUI = L.DomUtil.create('a', 'leaflet-draw-edit-remove', controlDiv);
                            controlUI.title = 'Delete';
                            controlUI.href = '#';
                            return controlDiv;
                        }
                    });
                var removeAllControl = new L.Control.RemoveAll();
                map.addControl(removeAllControl);
			
		
        setTimeout(function(){ window.node_input_map.invalidateSize(true)}, 400);
    
			}
			
            
        function drawSelection(layer, drItems, type, data){
                 
                var results=[]; 
                switch(type){
                 
                    case 'circle':
                
		                var circles = {};
		
		                drItems.eachLayer(function(layer) {
		                    circles = layer.toGeoJSON();
		                    circles.properties.radius = Math.round(layer.getRadius()) / 1000;
		                });
		
						var lat_map = (circles.geometry.coordinates[1]);
						var long_map = (circles.geometry.coordinates[0]);
						var center_latlong = new L.LatLng(lat_map, long_map);
						var rad_map = (circles.properties.radius);
						
						
						for (var sensorTocheck in data){
							
							
							var sensorLatLng = new L.LatLng(Number(data[sensorTocheck]["latitude"]), Number(data[sensorTocheck]["longitude"]));
												
							
							if(Math.abs(center_latlong.distanceTo(sensorLatLng)/1000) <= rad_map){
								
								results.push(sensorTocheck);
							
								}
						}
						break;
				
							                                        
                        
			         case 'polygon':
                        
                            var polyPoints = layer._latlngs[0]
                            for (var sensorTocheck in data){

                                //Ray Casting algorithm for checking if a point lies inside of a polygon
                                var x = Number(data[sensorTocheck]["latitude"]), y= Number(data[sensorTocheck]["longitude"]);

                                var inside = false;
                                for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
                                    var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
                                    var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

                                    var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                                    if (intersect) {
                                        inside = !inside;
                                    }
                                }

                                if(inside){

                                    results.push(sensorTocheck);

                                    }
                            }
                        break;
                        
                    case 'marker': 				
			  
                        var markerPoint = layer.getLatLng();
                        for (var sensorTocheck in data){

                                var sensorLatLng = new L.LatLng(Number(data[sensorTocheck]["latitude"]), Number(data[sensorTocheck]["longitude"]));

                                if(Math.abs(markerPoint.distanceTo(sensorLatLng)/1000) <= 5){ //5 km 

                                    results.push(sensorTocheck);

                                    }
                            }
                        break;
          		
          	
                
                    case 'polyline':
					
                        var polyVerts = layer._latlngs;
                        for (var sensorTocheck in data){

                                isclose=false;

                                var sensorLatLng = new L.LatLng(Number(data[sensorTocheck]["latitude"]), Number(data[sensorTocheck]["longitude"]));

                                for (var vi=0, vl=polyVerts.length; vi<vl; vi++) {
                                    var d = polyVerts[vi].distanceTo(sensorLatLng);
                                    if (d/1000 <= 5) {
                                        isclose= true;
                                        break;
                                    }
                                }

                                if (isclose){
                                    results.push(sensorTocheck);
                                }
                            }
          	  
          	
                
                }
                
                return results;
            }
        
        
        function drawMap2(){
    			node2 = this;
                
    			/*map2 = L.map('node-input-map-tab2').setView([45.4858914, 9.202094], 10);
    		
    		
                L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map2);
                window.node_input_map_2 = map;*/
    			var mapLayers = {};

                drawnItems2 = new L.FeatureGroup();
                map2.addLayer(drawnItems2);

                var editControl2 = new L.Control.Draw({
                    draw: false,
                    edit: {
                         remove: false,
                        featureGroup: drawnItems2,
                        poly: {
                            allowIntersection: false
                        }
                    }
                });
                map2.addControl(editControl2);

                drawControl2 = new L.Control.Draw({
                    remove: false,
                    draw: {
                        position: 'topleft',
                        //polyline: false,
                        //marker: false,
                        circlemarker: false,
                       //polygon: false,
                        rectangle: false,
                        polygon: {
                            allowIntersection: false,
                            showArea: true
                        }
                		
                    }
                });
                map2.addControl(drawControl2);

                L.control.layers(mapLayers, {
                    'drawlayer': drawnItems2
                }, {
                    collapsed: true
                }).addTo(map2);
                
               

    			
                map2.on(L.Draw.Event.CREATED, function(e) {
                    var fence = e.layer;
                    fence.nodeID = node2.id;
                    if (drawnItems2.hasLayer(fence) == false) {
                        drawnItems2.addLayer(fence);
                    }

                    drawControl2.remove();
                    
                    TYPE2 = e.layerType,
                    layer = e.layer;
                    
                    var resultsIn2=drawSelection(layer, drawnItems2, TYPE2, allDataIn2);
                	var el;
    				$("#node-input-nodes-target-container-tab2 li input").prop('checked', false);
    				$("#node-input-nodes-target-container-tab2 li").hide();

    				for(i=0;i<resultsIn2.length;i++){
    					el =  $("#node-input-nodes-target-container-tab2 li input#node-input-target-node-tab2"+resultsIn2[i]);
    					//console.log(el);
    					el.parent().parent().show();
    					el.prop('checked', true);

    					}
                });

                map2.on('draw:edited', function(e) {
                    var fences = e.layers;
                    fences.eachLayer(function(fence) {
                        fence.shape = "geofence";
                        if (drawnItems2.hasLayer(fence) == false) {
                            drawnItems2.addLayer(fence);
                        }
                    });


                    drawnItems2.eachLayer(function(layer) {
                        var resultsIn2=drawSelection(layer, drawnItems2, TYPE2, allDataIn2);
                        var el;
                        $("#node-input-nodes-target-container-tab2 li input").prop('checked', false);
                        $("#node-input-nodes-target-container-tab2 li").hide();

                        for(i=0;i<resultsIn2.length;i++){
                            el =  $("#node-input-nodes-target-container-tab2 li input#node-input-target-node-tab2"+resultsIn2[i]);
                            //console.log(el);
                            el.parent().parent().show();
                            el.prop('checked', true);

                            }
                    });

    				
                });

               /* map2.on('draw:deleted', function(e) {
                    drawControl2.addTo(map2);
                    
                    $("#node-input-nodes-target-container-tab2 li").each(function(){
                        $(this).find("input").prop('checked', false);
                        $(this).show();
                        });
                });*/
    			
                L.Control.RemoveAll = L.Control.extend(
                    {
                        options:
                        {
                            position: 'topleft',
                        },
                        onAdd: function (map) {
                            var controlDiv = L.DomUtil.create('div', 'leaflet-draw-toolbar leaflet-bar');
                            L.DomEvent
                                .addListener(controlDiv, 'click', L.DomEvent.stopPropagation)
                                .addListener(controlDiv, 'click', L.DomEvent.preventDefault)
                            .addListener(controlDiv, 'click', function () {
                                    drawnItems2.clearLayers();
                                 
                                    drawControl2.addTo(map2);
                    
                                    $("#node-input-nodes-target-container-tab2 li").each(function(){
                                        $(this).find("input").prop('checked', false);
                                        $(this).show();
                                        });     
                            });

                            var controlUI = L.DomUtil.create('a', 'leaflet-draw-edit-remove', controlDiv);
                            controlUI.title = 'Delete';
                            controlUI.href = '#';
                            return controlDiv;
                        }
                    });
                var removeAllControl = new L.Control.RemoveAll();
                map2.addControl(removeAllControl);
            
            
            
    		setTimeout(function(){ window.node_input_map_2.invalidateSize(true)}, 400);
        
    			}
        
    	
    	


/******* SAMPLE CONFIG DATA START ********/		
     			/* 
				"ARDUINO_ST_4201": {
				  	"contextBroker" : "orionUNIMI" , 
				  	"ip": "159.149.129.184",
				  	"port" : "1026",
				  	"type" : "temperature",
				  	"kind" : "sensor",
				  	"latitude" : "45.54",
				  	"longitude" : "91.21",

				 },
				*/ 

			/******* SAMPLE CONFIG DATA END ********/	

	    	 /******* PANNELLO  RETRIEVE   START ********/

	    	 /****
				desc:
					recupera i dati per popolare i menu a tendina del pannello retrieve e li popola tramite la funzione addSelectData

	    	 ****/
	    	 function  createRetrievePanel(){
	    	 	   var types = getDistinctValues(node.configData,"entityType");
                   addSelectData('node-input-type-select',types);
			       var kinds = getDistinctValues(node.configData,"kind");
			       addSelectData('node-input-kind-select',kinds);
			       var contextBrokers = getDistinctValues(node.configData,"contextBroker");
			       addSelectData('node-input-context-broker-select',contextBrokers);
				    var maps = getDistinctValues(node.configData,"map");
			       addSelectData('node-input-map-select',maps);
			 }
				 
	    	 function  createRetrievePanel2(){
	    	 	   var types = getDistinctValues(node2.configData,"value_type");
	    	 	  addSelectDataTab2('node-input-value-type-select-tab2',types);
			       var names = getDistinctValues(node2.configData,"value_name");
			       addSelectDataTab2('node-input-value-name-select-tab2',names);
			       var contextBrokers = getDistinctValues(node2.configData,"cb");
			       addSelectDataTab2('node-input-context-broker-select-tab2',contextBrokers);
			       var editables = getDistinctValues(node2.configData,"editable");
			       addSelectDataTab2('node-input-editable-select-tab2',editables);
			       var healthiness = getDistinctValues(node2.configData,"healthiness_criteria");
			       addSelectDataTab2('node-input-healthiness-select-tab2',healthiness);
				    var maps = getDistinctValues(node2.configData,"map2");
				    addSelectDataTab2('node-input-map-select-tab2',maps);
			 } 

	    	 /****
				desc:
					quando viene selezionato o deselezionato qualche valore nel pannello retrieve
					viene effettuata la verifica sui filtri (type, kind, broker) e vengono 
					resi visibili i sensori o gli attuatori per i filtri corrispondenti.


	    	 ****/
    		function  onChangeRetrieveSelect(){


    			//$("#node-input-nodes-target-container li input").prop('checked', false);
    			$("#node-input-nodes-target-container li").hide();

    			var selTypes =  $("#node-input-type-select :selected").map(function(i, el) {
					    return $(el).val();
					});
    			
				var selKind=  $("#node-input-kind-select :selected").val();

    			var selBrokers =  $("#node-input-context-broker-select :selected").map(function(i, el) {
					    return $(el).val();
					});

    			var hasType,hasKind,hasBroker;
    			
    			$("#node-input-nodes-target-container li").each(function(){

    				 
    				hasType=false;
					if(selTypes.length==0  || $.inArray("all", selTypes)>=0  ||  $.inArray($(this).data("type"), selTypes)>=0){
  						hasType = true;
					}

					console.log(selTypes);
					console.log($.inArray("all", selTypes>=0 ));



					hasKind=false;
					if(selKind=="all"||  $(this).data("kind") == selKind ){
  						hasKind = true;
					}

					hasBroker=false;
					if(selBrokers.length==0 || $.inArray("all", selBrokers) >=0   ||  $.inArray($(this).data("context-broker"), selBrokers)>=0){
  						hasBroker = true;
					}
                    

					console.log("hasType"+hasType);
					console.log("hasKind"+hasKind);
					console.log("hasBroker"+hasBroker);

					if(hasType && hasKind && hasBroker){
							$(this).show();
							//$(this).find("input").prop('checked', true);
					}

    			})

    		}
			 
    		function  onChangeRetrieveSelect2(){
        		
    			//$("#node-input-nodes-target-container li input").prop('checked', false);
    			$("#node-input-nodes-target-container-tab2 li").hide();
    			var selTypes =  $("#node-input-value-type-select-tab2 :selected").map(function(i, el) {
					    return $(el).val();
					});
    			
				var selNames=  $("#node-input-value-name-select-tab2 :selected").val();

    			var selBrokers =  $("#node-input-context-broker-select-tab2 :selected").map(function(i, el) {
					    return $(el).val();
					});
    			
    			var selEditables = ""+ $("#node-input-editable-select-tab2 :selected").val();

    			var selHealthiness =  $("#node-input-healthiness-select-tab2 :selected").map(function(i, el) {
				    return $(el).val();
				});

    			var hasType,hasName,hasBroker, hasEditable, hasHealthiness;
    			
    			$("#node-input-nodes-target-container-tab2 li").each(function(){

    				 
    				hasType=false;
					if(selTypes.length==0  || $.inArray("all", selTypes)>=0  ||  $.inArray($(this).data("type"), selTypes)>=0){
  						hasType = true;
					}

					hasName=false;
					if(selNames=="all"||  $(this).data("name") == selNames ){
						hasName = true;
					}

					hasBroker=false;
					if(selBrokers.length==0 || $.inArray("all", selBrokers) >=0   ||  $.inArray($(this).data("context-broker"), selBrokers)>=0){
  						hasBroker = true;
					}
					hasEditable=false;
					if(selEditables=="all" || $(this).data("editable")==selEditables){
						hasEditable = true;
					}
					
					hasHealthiness=false;
					if(selHealthiness.length==0 || $.inArray("all", selHealthiness) >=0   ||  $.inArray($(this).data("healthiness"), selHealthiness)>=0){
						hasHealthiness = true;
					}
                   

					if(hasType && hasName && hasBroker && hasHealthiness && hasEditable){
							$(this).show();
							//$(this).find("input").prop('checked', true);
					}



    				
    			})

    		}

	    	 /****
	    	 	input:
	    	 		selectId: id del menu  a tendina
	    	 	output:
	    	 		data: dati per popolare il menu a tendina
	    	 	desc:
					inserisce i valori nei menu a tendina
	    	 ****/
			function addSelectData(selectId, data){
				data  = data.sort();
				$('#'+selectId).html("");
				$('#'+selectId).append($('<option>', { value : "all" })
					          .text("all"));

			    $.each(data, function(key, value) {
					     $('#'+selectId)
					          .append($('<option>', { value : value })
					          .text(value));
					});

				$('#'+selectId).change(function(){
					 onChangeRetrieveSelect();
					 onTextSearch();
				});
                    

			}
    			
			function addSelectDataTab2(selectId, data){
				data  = data.sort();
				$('#'+selectId).html("");
				$('#'+selectId).append($('<option>', { value : "all" })
					          .text("all"));

			    $.each(data, function(key, value) {
					     $('#'+selectId)
					          .append($('<option>', { value : value })
					          .text(value));
					});

				$('#'+selectId).change(function(){
					 onChangeRetrieveSelect2();
					 onTextSearch2Tab2();
				});
                    

			}

             /*********
             input: 
             	dataObj: array da cui  recuperare i dati
             	matchKey:  chiave di dui recuperare i dati
             output:
             	ar: array filtrato
             desc:
             	restituisce i valori esistenti  per una determinata chiave
             	per esempio  tutti i type restituisce ["sensor","actuator"]

             **********/
			 function getDistinctValues(dataObj, matchKey)
			 {
			 	var ar = [];
			 	var val;

			 	for(key in dataObj) {
			 		val = dataObj[key][matchKey];
			 		console.log($.inArray(ar,val));
			 		if(val!=undefined  && val!="" && $.inArray(val,ar)<0){

			 			ar.push(val);
			 		}
			 	}

			 	return ar;

			 }
			 
			   /*********
             desc:
             filtra i sensori nel pannello di configurazione nascondendo quelli che non cominciano col testo inserito nella text box

             **********/
			function onTextSearch(){
			toMatch = $("#node-input-text-search").val().toLowerCase();
			var sensorId;
			if(toMatch=="") return;
			$("#node-input-nodes-target-container li").each(function(){
            		sensorId = $(this).find(".node-input-target-node-label").html().toLowerCase();
            		if(!sensorId.startsWith(toMatch)){
            				$(this).hide();
            		}
            });

			}
		function onTextSearch2(){
			toMatch = $("#node-input-text-search2").val().toLowerCase();
			var sensorId;
			if(toMatch=="") return;
			$("#node-input-nodes-target-container li").each(function(){
            		sensorId = $(this).find(".node-input-target-node-label").html().toLowerCase();
            		if(!sensorId.startsWith(toMatch)){
            				$(this).hide();
            		}
            });

			}
		
		function onTextSearch2Tab2(){
			toMatch = $("#node-input-text-search2-tab2").val().toLowerCase();
			var sensorId;
			if(toMatch=="")return;
			
			$("#node-input-nodes-target-container-tab2 li").each(function(){
            		sensorId = $(this).find(".node-input-target-node-label-tab2").html().toLowerCase();
            		$("#node-input-text-search2").val(sensorId);
            		if(!sensorId.startsWith(toMatch)){
            				$(this).hide();
            		}
            });

			}
		     /******* PANNELLO  RETRIEVE FUNCTIONS  END  ********/


		      /******* PANNELLO  SENSORS  START  ********/

             /*********
             desc:
             	crea la lista con tutti i sensori selezionabili

             **********/

			 function createNodeList() {
			 	 console.log("create node list");
			 	 var data = node.configData;
			 	 console.log(node.configData);
			 	  console.log("create node list 2");
			     var isChecked = false;
			     nodeList.empty();
			     for(key in data) {
			     	var container = $('<li/>',{class:"node-input-target-node"});
			     	container.attr('data-type', data[key]["entityType"]);
			     	container.attr('data-kind', data[key]["kind"]);
			     	container.attr('data-context-broker', data[key]["contextBroker"]);

			     	var row = $('<label/>',{for:"node-input-target-node-"+key}).appendTo(container);
			     	$('<input>',{type:"checkbox",class:"node-input-target-node-checkbox",id:"node-input-target-node-"+key})
	                        .data('node-id',key)
	                        .prop('checked', isChecked)
	                        .appendTo(row);

			     	var labelSpan = $('<span>');
	                var label = key;
	                var sublabel = data[key]["contextBroker"];
	                var sublabel2= data[key]["entityType"];


	                $('<span>',{class:"node-input-target-node-label",style:"white-space:nowrap"}).text(label).appendTo(row);
	                if (sublabel) {
	                	$('<span>',{class:"node-input-target-node-sublabel"}).text(sublabel).appendTo(row);
	                }
	                if (sublabel2) {
	                	$('<span>',{class:"node-input-target-node-sublabel2"}).text(sublabel2).appendTo(row);
	                }

	                container.appendTo(nodeList);
			     }

			 }
			
			 function createNodeList2() {
				 console.log("create node list");
			 	 var data = node2.configData;
			     var isChecked = false;
			     nodeList2.empty();
			     for(key in data) {
			     	var container = $('<li/>',{class:"node-input-target-node-tab2"});
			     	container.attr('data-device', data[key]["device"]);
			     	container.attr('data-type', data[key]["value_type"]);
			     	container.attr('data-name', data[key]["value_name"]);
			     	container.attr('data-context-broker', data[key]["cb"]);
			     	container.attr('data-editable', data[key]["editable"]);
			     	container.attr('data-healthiness', data[key]["healthiness_criteria"]);
			     	

			     	var row = $('<label/>',{for:"node-input-target-node-tab2"+key}).appendTo(container);
			     	$('<input>',{type:"checkbox",class:"node-input-target-node-checkbox-tab2",id:"node-input-target-node-tab2"+key})
	                        .data('node-id',key)
	                        .prop('checked', isChecked)
	                        .appendTo(row);

			     	var labelSpan = $('<span>');
	                var label = data[key]["value_type"];
	                var sublabel = data[key]["cb"];
	                var sublabel2= data[key]["device"];
	              //  var sublabel3 = data[key]["value_name"];


	                $('<span>',{class:"node-input-target-node-label-tab2",style:"white-space:nowrap"}).text(label).appendTo(row);
	                if (sublabel) {
	                	$('<span>',{class:"node-input-target-node-sublabel-tab2"}).text(sublabel).appendTo(row);
	                }
	                if (sublabel2) {
	                	$('<span>',{class:"node-input-target-node-sublabel2-tab2"}).text(sublabel2).appendTo(row);
	                }
	       //         if (sublabel3) {
	         //       	$('<span>',{class:"node-input-target-node-sublabel3-tab2"}).text(sublabel3).appendTo(row);
	           //     }

	                container.appendTo(nodeList2);
			     }

			 }

    
            
           
            
            
            /*********
             desc:
	             ordinamento dei sensori

             **********/
			function sortNodeList(sortOn) {
                var currentSort = nodeList.data('currentSort');
                var currentSortOrder = nodeList.data('currentSortOrder');

                if (!currentSort) {
                    currentSort = sortOn;
                    currentSortOrder = 'a';
                } else {
                    if (currentSort === sortOn) {
                        currentSortOrder = (currentSortOrder === 'a'?'d':'a');
                    } else { 
                        currentSortOrder = 'a';
                    }
                    currentSort = sortOn;
                }
                nodeList.data('currentSort',currentSort);
                nodeList.data('currentSortOrder',currentSortOrder);

                $("#node-input-status-target-container-div .fa").hide();
                $(".node-input-status-sort-"+currentSort+"-"+currentSortOrder).show();


                var items = nodeList.find("li").get();
                items.sort(function(a,b) {
                    var labelA = $(a).find(".node-input-target-node-"+currentSort).text().toLowerCase();
                    var labelB = $(b).find(".node-input-target-node-"+currentSort).text().toLowerCase();
                    if (labelA < labelB) { return currentSortOrder==='a'?-1:1; }
                    if (labelA > labelB) { return currentSortOrder==='a'?1:-1; }
                    return 0;
                });
                $.each(items, function(i, li) {
                    nodeList.append(li);
                });
            }
			 
			 
			function sortNodeListTab2(sortOn) {
                var currentSort = nodeList2.data('currentSort');
                var currentSortOrder = nodeList2.data('currentSortOrder');

                if (!currentSort) {
                    currentSort = sortOn;
                    currentSortOrder = 'a';
                } else {
                    if (currentSort === sortOn) {
                        currentSortOrder = (currentSortOrder === 'a'?'d':'a');
                    } else { 
                        currentSortOrder = 'a';
                    }
                    currentSort = sortOn;
                }
                nodeList2.data('currentSort',currentSort);
                nodeList2.data('currentSortOrder',currentSortOrder);

                $("#node-input-status-target-container-div .fa").hide();
                $(".node-input-status-sort-"+currentSort+"-"+currentSortOrder).show();


                var items = nodeList2.find("li").get();
                items.sort(function(a,b) {
                    var labelA = $(a).find(".node-input-target-node-"+currentSort).text().toLowerCase();
                    var labelB = $(b).find(".node-input-target-node-"+currentSort).text().toLowerCase();
                    if (labelA < labelB) { return currentSortOrder==='a'?-1:1; }
                    if (labelA > labelB) { return currentSortOrder==='a'?1:-1; }
                    return 0;
                });
                $.each(items, function(i, li) {
                    nodeList2.append(li);
                });
            }


             /*********	
				  definizione  evento click per sui pulsanti di ordinamento
             **********/
            $("#node-input-target-sort-label").click(function(e) {
                e.preventDefault();
                sortNodeList('label');
            });

            $("#node-input-target-sort-type").click(function(e) {
                e.preventDefault();
                sortNodeList('sublabel');
            });
            $("#node-input-target-sort-label2").click(function(e) {
                e.preventDefault();
                sortNodeList('sublabel2');
            });
            
            /*---------------*/
            
            $("#node-input-target-sort-label-tab2").click(function(e) {
                e.preventDefault();
                sortNodeListTab2('label-tab2');
            });

            $("#node-input-target-sort-device-tab2").click(function(e) {
                e.preventDefault();
                sortNodeListTab2('sublabel2-tab2');
            });
            $("#node-input-target-sort-name-tab2").click(function(e) {
                e.preventDefault();
                sortNodeListTab2('sublabel3-tab2');
            });
            
            $("#node-input-target-sort-type-tab2").click(function(e) {
                e.preventDefault();
                sortNodeListTab2('sublabel-tab2');
            });
             /*********	
				  definizione  evento click su checkbox per selezionare tutti i sensori
             **********/
            $("#node-input-target-node-checkbox-all").change(function() {
                $(".node-input-target-node-checkbox:visible").prop('checked',this.checked);
            });
			
            $("#node-input-target-node-checkbox-all-tab2").change(function() {
                $(".node-input-target-node-checkbox-tab2:visible").prop('checked',this.checked);
            });
			   /*********
				  definizione  evento keyup per la ricerca testuale
             **********/
            $("#node-input-text-search").keyup(function() {
            onChangeRetrieveSelect();
            onTextSearch();
            });
			$("#node-input-text-search2").keyup(function() {
            onChangeRetrieveSelect();
            onTextSearch2();
            });
			$("#node-input-text-search2-tab2").keyup(function() {
				onChangeRetrieveSelect2();
	            onTextSearch2Tab2();
	            });
			
			
 			
 			/******* PANNELLO  SENSORS END *****/



 			/******* SELECT  SENSORS START  *****/

 			 /*********	
				  definizione della evento change su select per tipo ricerca (parametric search, map , slected nodes)
             **********/
			
			   $("#node-input-kind-of-search-select").change(function() {
            	//$("#node-input-nodes-target-container li input").prop('checked', false);
            	
                if($(this).val()=="retrieve") // parametric search - retrieve
	                {
	                	console.log("retrieve");
	                	$("#retrieve-wrapper").fadeIn("fast");
	                	$("#target-wrapper").fadeOut("fast");
						$("#retrieve-selected").fadeOut("fast");
						$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeOut("fast");
	                }

	                else if($(this).val()=="map") // map search - target
	                {
	                	

	                	$("#target-wrapper").fadeIn("fast");
						$("#retrieve-selected").fadeOut("fast");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeOut("fast");
						if (window.node_input_map) {
	                window.node_input_map.invalidateSize(true);
	            };
						
	                }
	                
	                /*else if($(this).val()=="map_marker") // map search - target
	                {
	                	

	                	$("#target-wrapper").fadeIn("fast");
						$("#retrieve-selected").fadeOut("fast");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#marker-wrapper").fadeIn("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeOut("fast");
						if (window.node_input_map) {
	                window.node_input_map.invalidateSize(true);
	            };
						
	                }
	                
	                else if($(this).val()=="map_path") // map search - target
	                {
	                	

	                	$("#target-wrapper").fadeIn("fast");
						$("#retrieve-selected").fadeOut("fast");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeIn("fast");
						$("#polygon-wrapper").fadeOut("fast");
						if (window.node_input_map) {
	                window.node_input_map.invalidateSize(true);
	            };
						
	                }
	                
	                else if($(this).val()=="map_polygon") // map search - target
	                {
	                	

	                	$("#target-wrapper").fadeIn("fast");
						$("#retrieve-selected").fadeOut("fast");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeIn("fast");
						if (window.node_input_map) {
	                window.node_input_map.invalidateSize(true);
	            };
						
	                }

	                else // specific devices - selected
	                {
	                	console.log("selected");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#target-wrapper").fadeOut("fast");
						$("#retrieve-selected").fadeIn("fast");
						$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeOut("fast");
	                	$("#node-input-nodes-target-container li").each(function(){
	                	 	$(this).show();
	                	})
	                }*/
                   

            });
 			
			   $("#node-input-kind-of-search-select-tab2").change(function() {
	            	//$("#node-input-nodes-target-container li input").prop('checked', false);
	            	
	                if($(this).val()=="retrieve") // parametric search - retrieve
		                {
		                	console.log("retrieve");
		                	$("#retrieve-wrapper-tab2").fadeIn("fast");
		                	$("#target-wrapper-tab2").fadeOut("fast");
		                }

		                else if($(this).val()=="map") // map search - target
		                {

		                	$("#target-wrapper-tab2").fadeIn("fast");
		                	$("#retrieve-wrapper-tab2").fadeOut("fast");
							if (window.node_input_map_2) {
		                window.node_input_map_2.invalidateSize(true);
		            };
							
		                }
                  

	            });

            /******* SELECT  SENSORS END  *****/
           


			var nodeList = $("#node-input-nodes-target-container");
			var node = this;
			
			
			var nodeList2 = $("#node-input-nodes-target-container-tab2");
			var node2 = this;
			

			/*********	
				  recupero dei dati  da  server node
            **********/
         	//var jqxhr = $.getJSON( "http://localhost:3001/api/get-config-data", function(data) {
			//var jqxhr = $.getJSON( "http://iot-app.snap4city.org/iotdirectory/api/get-config-data", function(data) {
            //var jqxhr = $.getJSON( "https://iotdirectory.snap4city.org/management/get_data.php?action=get-config-data", function(data) {
			//var jqxhr = $.getJSON("https://iotdirectory.snap4city.org/management/get_data.php?action=get-config-data", function(data) {
			
            
            
            var accesstoken="";
            try{ 
                console.log("in retrieving access token");
                console.log("this.id "+ this.id);
                 var accesstoken= "";
                        $.ajax({
                            url: "deviceregistration/"+this.id,
                            type:"GET",
                            async: false,
                            success: function(resp) {
                                console.log(resp);
                                accesstoken = resp.refreshToken;
                                
                                var url= "https://iotdirectory.snap4city.org/api/device.php?action=get_config_data&nodered=yes&token="+accesstoken;
                                console.log("url");
                                console.log(url);
                                
                                var jqxhr = $.getJSON(url, function(data) {	
                                              console.log( "success" );
                                              console.log( data );
                                            })
                                              .done(function(data) {

                                                  if(data.status=="ok"){
                                                  console.log( "second success" );

                                                    data=data.content;
                                                      allDataIn=data;

                                                       // crea lista entiti principale
                                                       node.configData = data;
                                                       createNodeList();
                                                       //crea dati per le select
                                                       createRetrievePanel();
                                                       // crea map
                                                        drawMap();

                                                        var marker_array=[];

                                                        for(var k in data){

                                                            lat=Number(data[k]["latitude"]); //45.4858914;
                                                             est_lat= lat+(Math.random() * (0.000700 - 0.000010) + 0.000010);
                                                             lng=Number(data[k]["longitude"]);//9.202094;
                                                             est_lng= lng+(Math.random() * (0.000700 - 0.000010) + 0.000010);
                                                            popup= "<b>"+data[k]['name']+"</b><br>"+data[k]['entityType']+ "<br>"+data[k]['kind']; 
                                                            if(data[k]["visibility"]=="public"){

                                                               m = L.marker([est_lat, est_lng],{icon: blueIcon}).bindPopup(popup);
                                                            }
                                                            else{
                                                                m = L.marker([est_lat, est_lng], {icon: redIcon}).bindPopup(popup);
                                                            }

                                                        marker_array.push(m);
                                                     }

                                                        var markersGroup = L.layerGroup(marker_array);
                                                        markersGroup.addTo(map);

                                                  }
                                                  else{
                                                      console.log(data.status);
                                                  }


                                              })
                                              .fail(function() {
                                                console.log( "error" );
                                              })
                                              .always(function() {
                                                console.log( "complete" );
                                              });
                                
                                
                                
                    var url_values= "https://iotdirectory.snap4city.org/api/device.php?action=get_config_data_values&nodered=yes&token="+accesstoken;
                        var jqxhrValues = $.getJSON( url_values,                         
                                            function(data) {
                                                  console.log( "success" );
                                                  console.log( data );
                                                })
                                                  .done(function(data) {
                                                      if(data.status=="ok"){
                                                            console.log( "second success" );
                                                            data=data.content;

                                                            allDataIn2=data;

                                                               // crea lista entiti principale
                                                               node2.configData = data;
                                                               createNodeList2();
                                                               //crea dati per le select
                                                               createRetrievePanel2();
                                                               // crea map
                                                                drawMap2();

                                                                var marker_array=[];
                                                                for(var k in data){

                                                                    lat=Number(data[k]["latitude"]); //45.4858914;
                                                                     est_lat= lat+(Math.random() * (0.000700 - 0.000010) + 0.000010);
                                                                     lng= Number(data[k]["longitude"]);//9.202094;
                                                                     est_lng= lng+(Math.random() * (0.000700 - 0.000010) + 0.000010);
                                                                     popup= "<b>"+data[k]['device']+"</b><br>"+data[k]['value_type']; 
                                                                        if(data[k]["visibility"]=="private"){

                                                                           m = L.marker([est_lat, est_lng],{icon: redIcon}).bindPopup(popup);
                                                                        }
                                                                        else{
                                                                            m = L.marker([est_lat, est_lng], {icon: blueIcon}).bindPopup(popup);
                                                                        }

                                                                            marker_array.push(m);
                                                                         }

                                                                var markersGroup = L.layerGroup(marker_array);
                                                                markersGroup.addTo(map2);    

                                                      }
                                                      else{
                                                          console.log(data.status);
                                                      }
                                                  })
                                                  .fail(function() {
                                                    console.log( "error" );
                                                  })
                                                  .always(function() {
                                                    console.log( "complete" );
                                                  });
                                
                                
                            },
                            error: function(jqXHR,textStatus,errorThrown) {
                                console.log("ERROR");
                            }
                        });
                
                
             
            }
            catch(err){
                console.log("error creating the token "+ err);
                accesstoken="";
            }
            
		     
  		    /******* ON EDIT PREPARE  END********/

			 
			 
	
		},

		oneditresize: function() {
            if (window.node_input_map) {
                window.node_input_map.invalidateSize(true);
            }
        },
		
		
        oneditsave: function() {
        	
        	console.log("edit save");
        	
        	 

        	var configData;
        	var sensors =[];
			idValueArray=[]; //array of ["device_id",[array of "values"] ] used in case of value based search, remain empty in device based search
        	if(openedTab=="Device-based-search"){
        		sensors =[];
        		configData = allDataIn; //= this.configData;
        		console.log("configData is ");
           	 	console.log(configData);
        		
        		/*** crea un arrei con i  sensori  che sono stati selezionati e sono  visibili nel pannello di configurazione  ***/
                $(".node-input-target-node-checkbox").each(function(n) {
                        if ($(this).prop("checked") ) { //&& $(this).is(":visible")
                           sensors.push($(this).data('node-id'));
                        }
                	});
                
                console.log("sensors are:")
                console.log(sensors);
                
                var is_checked= $("#checkbox_aggr_in_device").prop("checked");
                console.log("is_checked "+is_checked);
                if(is_checked){
                    device_types=[];//for the aggregation according to the device type, it contains the unique types of selected devices

                    for (var i=0; i<sensors.length; i++){

                        var t= configData[sensors[i]]["entityType"];
                        if (device_types.length==0){
                        device_types.push(t);
                        }
                        else{
                            var exist=0;
                            for (var j=0; j<device_types.length; j++){
                                if (device_types[j]==t) {
                                    exist=1;
                                    break;
                                }
                            }
                            if(exist==0){
                                device_types.push(t);
                            }
                        }

                    }
                    console.log("device_types:");
                    console.log(device_types);
                    createFlow_agg_device(sensors, configData);
                }
                
                else{
                    createFlow(sensors, configData);
                }
                
        		
        	}
        	
        	else{
        		sensors =[];
        		configData = allDataIn2;
        		
        		console.log("configData is ");
           	 	console.log(configData);
        		
        		/*** crea un arrei con i  sensori  che sono stati selezionati e sono  visibili nel pannello di configurazione  ***/
                $(".node-input-target-node-checkbox-tab2").each(function(n) {
                        if ($(this).prop("checked") ) { //&& $(this).is(":visible")
                           sensors.push($(this).data('node-id'));
                        }
                	});
                
        		if (sensors.length==0) return;
                
        		
        		
                
                value_types=[];//for the aggregation according to the value type, it contains the unique value types of selected devices
        		for (var i=0; i<sensors.length; i++){
                
                    var t= configData[sensors[i]]["value_type"];
                    if (value_types.length==0){
					   value_types.push(t);
					}
					else{
						var exist=0;
						for (var j=0; j<value_types.length; j++){
							if (value_types[j]==t) {
								exist=1;
								break;
							}
						}
						if(exist==0){
							value_types.push(t);
						}
					}
                
                }
                console.log("value_types:");
                console.log(value_types);
               
                var uniqueDevices=[];
        		for (var i=0; i<sensors.length; i++){
        			console.log("in for");
        			var id_s= configData[sensors[i]]["device"];
        			console.log("in for, id_s is "+ id_s);
        			
        			if (uniqueDevices.length==0){
					uniqueDevices.push(id_s);
					}
					else{
						var exist=0;
						for (var j=0; j<uniqueDevices.length; j++){
							if (uniqueDevices[j]==id_s) {
								exist=1;
								break;
							}
						}
						if(exist==0){
							uniqueDevices.push(id_s);
						}
					}
        			
        			var added=0;
					for (var j=0; j<idValueArray.length; j++){
					
                        if ( idValueArray[j].id== configData[sensors[i]]["device"]){
							var vr= idValueArray[j].values;
							vr.push(configData[sensors[i]]["value_type"]);
							added=1;
							break;
						}
					}
					if(added==0){
						var z= {id: configData[sensors[i]]["device"], values:[configData[sensors[i]]["value_type"]]};
						idValueArray.push(z);
					}
        			       
        			}
        		//console.log("idSensorsMap is "+ idSensorsMap[configData[sensors[0]]["device"]]);
        		/*var Ssensors=[];
        		for (var x in idSensorsMap){
        			
        			arrSensors= idSensorsMap[x];
        			Ssensors.push(arrSensors);
        			
        			//createFlow(arrSensors, configData);
        			
        		}*/
        		console.log("idValueArray length is "+idValueArray.length);
				for(var j=0; j<idValueArray.length; j++){
					console.log("id: "+ idValueArray[j].id+" values: "+ idValueArray[j].values);
				}
        		console.log("uniqueDevices "+uniqueDevices);
                
                var is_checked= $("#checkbox_aggr_in_value").prop("checked");
                console.log("is_checked "+is_checked);
                if(is_checked){
        		  createFlow_agg_value(uniqueDevices, configData);	
                }
                else{
                    createFlow(uniqueDevices, configData);
                }
        			
        	}
        	
    function createFlow(sensors, configData){
                configData=allDataIn;
        		if(!sensors.length) return;
        
        //numero id dei nodi che  devono essere generati
              var idAmount = sensors.length * 4 + 7;

              var jqxhr = $.getJSON( "get-id?n="+idAmount, function(data) {
			  console.log( "success" );
			  console.log( data );
			})
			  .done(function(data) {
			    console.log( "second success..." );

			 
 				console.log( data );



 				var offsetY =200;
                var offsetYstep = 100;  
                var middleY = offsetY + offsetYstep*(sensors.length-1)/2;

              //new flow
 				var counter_id = 0;
				var flow_id = data.ids[counter_id++]; //0
				var debug_id = data.ids[counter_id++]; //1
				var function_id = data.ids[counter_id++]; //2
				var inject_id = data.ids[counter_id++] //3
                var link_out_id = data.ids[counter_id++] //4

                //curr flow
                var link_in_id = data.ids[counter_id++] //5
                var curr_flow_id = data.ids[counter_id++]; //6


				


				console.log("counterid="+counter_id);

			    var newflow = [];


			  //link in
                newflow.push({
                    "id": link_in_id,
                    "type": "link in",
                    "z": curr_flow_id,
                    "name": "flow"+ link_out_id,
                    "links": [link_out_id],
                    "x": 200,
                    "y": 200,
                    "wires": [
                        []
                    ]
                },),

                //flow
                newflow.push({
                    "id": flow_id,
                    "type": "tab",
                    "label": "Flow " + flow_id
                }),


                //link out
                newflow.push(    {
                    "id": link_out_id,
                    "type": "link out",
                    "z": flow_id,
                    "name": "flow out",
                    "links": [link_in_id],
                    "x": 1200,
                    "y": middleY,
                    "wires": []
                }),




			    //function
			    newflow.push({
							"id": function_id,
							"type": "function",
							"z": flow_id,
							"name": "collect",
							"func": "\nreturn msg;",
							"outputs": 1,
							"noerr": 0,
							"x": 1000,
							"y": middleY,
							"wires": [
							[
									link_out_id
								]
							]
						})


			    //sensori

			    var addInjectNode=false;
   
                var orion_ids=[];
                var protocol;


                

                for(var i=0;i<sensors.length;i++){
                	console.log("orion--")
                	console.log(configData[sensors[i]])
                	try {
                		protocol = configData[sensors[i]]["protocol"];
							}
					catch(err) {
   						 protocol="none";
							}
					
					console.log("protocol is "+ protocol);
                	
                	var conf_id = data.ids[counter_id++];
                	var log_id = data.ids[counter_id++];
                	var node_id = data.ids[counter_id++];
                	var fun_id = data.ids[counter_id++];
                    
                    var attributes=[];
                  	console.log("idValueArray is "+idValueArray);
					console.log("sensors[i] "+sensors[i]);
                  	for (var j=0; j< idValueArray.length; j++ ){
						console.log("idValueArray[j].id "+idValueArray[j].id);
						if (idValueArray[j].id==sensors[i])
						attributes= idValueArray[j].values;
					}
                  	console.log("attributes is "+attributes);
					var attributes_string="";
					for (var j=0; j<attributes.length; j++){
						if(j< attributes.length-1){
							attributes_string+="'"+ attributes[j]+"',";
						}
						else{
							attributes_string+="'"+ attributes[j]+"'";
						}
					}
                    

                	console.log(counter_id);
                	//orion
                	switch(protocol){
			  	    	case "ngsi":
	                		//addInjectNode=true;
	                        orion_ids.push(node_id)
	                	    newflow.push({
								"id": conf_id,
								"type": "orion-service",
								"z": "",
								"name": configData[sensors[i]]["ip"]+":"+configData[sensors[i]]["port"],
								"url": configData[sensors[i]]["ip"],
								"port": configData[sensors[i]]["port"]
								})



                            newflow.push({
                                "id": node_id,
                                "type": "fiware orion in",
                                "z": flow_id,
                                "name": "",
                                "service": conf_id,
                                "throttle": "PT5S",
                                "entype": configData[sensors[i]]["entityType"],
                                "enid": sensors[i],
                                "ispattern": false,
                                "duration": "P1W",
                                "attributes": ""+attributes,
                                "condvalues": "*.",
                                "includeattr": true,
                                "noderedhost": "",
                                "noderedhostauto": true,
                                "x": 400,
                                "y": offsetY,
                                "wires": [
                                    [
                                    fun_id
                                    ]
                                ]
                                })
						break;


                        //mosquitto
						case "mqtt":

	                	    newflow.push({
								"id": conf_id,
								"type": "mqtt-broker",
								"z": "",
								"broker": configData[sensors[i]]["ip"],
								"port":  configData[sensors[i]]["port"],
								"clientid": "",
								"usetls": false,
								"compatmode": true,
								"keepalive": "60",
								"cleansession": true,
								"willTopic": "",
								"willQos": "0",
								"willRetain": "false",
								"willPayload": "",
								"birthTopic": "",
								"birthQos": "0",
								"birthRetain": "false",
								"birthPayload": ""
							})





	                	    newflow.push({
								"id": node_id,
								"type": "mqtt in",
								"z": flow_id,
								"name": sensors[i],
								"topic": sensors[i],
								"qos": "2",
								"broker": conf_id,
								"x": 400,
								"y": offsetY,
								"wires": [
									[
										fun_id
									]
								]
							})

						break;

						//rabbit
						  //	$("#node-input-ioname").val(rabbitNodes[rabbitCount]["sensorId"]);
	  					   //  	$("#node-input-iotype").val(4);
						case "amqp":
							newflow.push({
								"id": conf_id,
								"type": "amqp-server",
								"z": "",
								"host": configData[sensors[i]]["ip"],
								"port": configData[sensors[i]]["port"],
								"vhost": "",
								"keepalive": "30",
								"usetls": false,
								"verifyservercert": true,
								"usetopology": false,
								"topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}"
							})

							newflow.push({
								"id": node_id,
								"type": "amqp in",
								"z": flow_id,
								"name": sensors[i],
								"topic": "",
								"iotype": "4",
								"ioname": sensors[i],
								"server": conf_id,
								"x": 400,
								"y": offsetY,
								"wires": [
									[fun_id]
								]
							})

						break;

                	}

newflow.push({
						"id": fun_id,
						"type": "function",
						"z": flow_id,
						"name": "transform",
						"func": "\r\n\r\n\/* determine type of value and extract the contained attributes according to the following formats \r\n- format A (comma separated pairs):\r\n  attribute:value, ...., attribute:value  \r\n- format B (comma separated basic values):\r\n  value, ..., value (in this case the attribute name would be csv_\"pos\" where pos is the position) \r\n- format C (JSON values):\r\n  {attribute:value, ..., attribute:value}\r\n- format D (XML values):\r\n  <record><attribute>value<\/attribute>...<attribute>value<\/attribute><\/record>  \r\n*\/\r\n\/*\r\n{\r\n  \"id\": \"Room1\",\r\n  \"type\": \"Room\",\r\n  \"temperature\": {\r\n    \"value\": 23,\r\n    \"type\": \"Float\"\r\n  },\r\n  \"pressure\": {\r\n    \"value\": 720,\r\n    \"type\": \"Integer\"\r\n  }\r\n}\r\n*\/\r\nfunction snap4cityParser(sensorID, protocol, value, selectedAttributes)\r\n{\r\n  var attributes=[];\r\n  var newType=\"\"; \r\n  var newId=\"\";   \r\n  if (protocol==\"ngsi\") \r\n   {  \r\n     var x=\"\";\r\n     value=JSON.parse(value); \r\n     for (x in value)\r\n\t {\r\n\t   if (x==\"id\") newId= value[x];\r\n\t   else if (x==\"type\") newType=value[x];\r\n\t   else attributes[x]=value[x];\r\n\t }\r\n   }\r\n  else{   \r\n\t  var f = \"\"; \/\/ identified format\r\n\t  value=value.trim();\r\n\t  var first = value.charAt(0);\r\n\t  switch (first)\r\n\t  {\r\n\t\tcase \"{\": \/\/ Format C\r\n\t\t\tattributes = parseJSON(value);\r\n\t\t\tf=\"JSON\";\r\n\t\t\tbreak;\r\n\t\tcase \"<\": \/\/ Format D\r\n\t\t\tattributes = parseXML(value);\r\n\t\t\tf=\"XML\";\r\n\t\t\tbreak;\r\n\t\tdefault: \/\/ Format A or B\r\n\t\t   attributes = parseCSV(value);\r\n\t\t   f=\"CSV\";\r\n\t  }\r\n   }  \r\n   if (selectedAttributes.length==0)\r\n   {         \r\n\t  return {\"id\": sensorID, \"source\": protocol, \"type\": newType, attributes};\r\n   }\r\n   else\r\n   {\r\n      for (x in attributes)\r\n\t  {\r\n\t    if (selectedAttributes.indexOf(x)==-1)  delete attributes[x];\r\n\t  }\r\n      return {\"id\": sensorID, \"source\": protocol, \"type\": newType, attributes};\r\n   }    \r\n}\r\n\r\nNumber.prototype.padLeft = function(base,chr){\r\n   var  len = (String(base || 10).length - String(this).length)+1;\r\n   return len > 0? new Array(len).join(chr || \'0\')+this : this;\r\n}\r\n\r\n\r\nfunction parseCSV(value)\r\n{\r\n  \/*\r\n  parse comma separated values \r\n  each value can assume the following formats:\r\n  format A (comma separated pair): attribute:value  \r\n  format B (comma separated basic value):  value\r\n  *\/\r\n    \r\n  \r\n  var delims = \",\"; \r\n  var properties = value.split(delims);\r\n  var attributes = {};\r\n  var format = \"A\";\r\n  var cv;\r\n  var pos=1;\r\n  for (i = 0; i < properties.length; i++)\r\n  {\r\n    var prop = properties[i].trim();\r\n    if (prop.indexOf(\":\")==-1 || (prop.indexOf(\":\")>0 && prop.indexOf(\":\")!=prop.lastIndexOf(\":\")))\r\n    { \/\/ condition is that \":\" do not occur or\r\n      \/\/ \":\"  occurs once in any prop and not in the first position\r\n        id =\"csv_\" + pos;\r\n        pos++;\r\n        val =properties[i].trim();\r\n        if (determineType(val)==\"date\")\r\n          {\r\n            var d = new Date(val);\r\n            val =[ (d.getMonth()+1).padLeft(),\r\n                    d.getDate().padLeft(),\r\n                    d.getFullYear()].join(\'\/\')+\r\n                    \' \' +\r\n                  [ d.getHours().padLeft(),\r\n                    d.getMinutes().padLeft(),\r\n                    d.getSeconds().padLeft()].join(\':\');\r\n\r\n          }\r\n          attributes[id]={\"type\": determineType(val),\"value\" : val};\r\n    }\r\n    else\r\n    {\r\n\t  cv= properties[i].split(\":\");\r\n\t  myid=cv[0].trim();\r\n          val=cv[1].trim();\r\n          var attr={};\r\n          if (determineType(val)==\"date\") \r\n          {\r\n            var d = new Date(val);\r\n            val =[ (d.getMonth()+1).padLeft(),\r\n                    d.getDate().padLeft(),\r\n                    d.getFullYear()].join(\'\/\')+\r\n                    \' \' +\r\n                  [ d.getHours().padLeft(),\r\n                    d.getMinutes().padLeft(),\r\n                    d.getSeconds().padLeft()].join(\':\');\r\n\r\n          }\r\n          attributes[myid]= {\"type\": determineType(val), \"value\":val};\r\n    }\r\n  }\r\n  \/\/ console.log(attributes);\r\n  return attributes;\r\n}\r\n\r\n\/*  this function should be completed *\/\r\nfunction parseXML(value)\r\n{\r\n    var parser = new DOMParser();\r\n    var xmlDoc = parser.parseFromString(value, \"text\/xml\");\r\n    \r\n    var element = xmlDoc.documentElement;\r\n    var elements = element.querySelectorAll(\"*\");\r\n    \r\n    var attributes = [];\r\n\r\n    for (var i = 0; i < elements.length; i++) {\r\n        var text = null;\r\n        if (elements[i].childNodes.length == 1 && elements[i].childNodes[0].nodeType == 3) \/\/if nodeType == text node\r\n        {\r\n            text = elements[i].textContent; \/\/get text of the element\r\n            var id =elements[i].tagName;\r\n            var val =text.trim();\r\n            \r\n             if (determineType(val)==\"date\") {\r\n                 val= dateThing(val);\r\n             }\r\n            attributes[id]= {\"type\": determineType(val), \"value\":val};\r\n            \r\n        }\r\n        \/\/console.log(\"TagName : \", id, \", value : \", val);\r\n        \r\n        \r\n    }\r\n    return attributes;\r\n    \r\n}\r\n\r\n\/*  this function should be completed *\/\r\nfunction parseJSON(value)\r\n{  try{\r\n   jsonvalue= JSON.parse(value);\r\n    var attributes = [];\r\n    \r\n    for (var key in jsonvalue){\r\n     \r\n        var id =key; \r\n        if (id==\"type\" || id==\"id\") continue; \/\/these are not attribute, we don\'t need them\r\n        var val =jsonvalue[id];\r\n        if(typeof(val)==\'object\') {\r\n            \r\n            jsonSubValue=val;\r\n            \r\n            for (var k in jsonSubValue){\r\n                if (k==\"type\" || k==\"id\") continue; \/\/these are not attribute, we don\'t need them\r\n                v= jsonSubValue[k];\r\n                \r\n                try{v=v.trim();} catch(err){}\r\n                if (determineType(v)== \"date\") {\r\n                    v= dateThing(v);\r\n                    }\r\n                attributes.push({\"name\":key ,\"type\": determineType(v),\"value\" : v});\r\n            }\r\n        }\r\n        else{\r\n            val= val.trim(); \r\n            if (determineType(val)== \"date\") {\r\n                 val= dateThing(val);\r\n             }\r\n            \r\n            attributes.push({\"name\":id ,\"type\": determineType(val),\"value\" : val});\r\n        }\r\n            \r\n    }\r\n    \r\n  return attributes;\r\n}\r\n catch(err){\r\n     return [];\r\n}\r\n}\r\n\r\n\r\nfunction validateFloat(strFloat) {\r\n    if (\/^(\\-|\\+)?([0-9]+(\\.[0-9]+)?|Infinity)$\/\r\n      .test(strFloat))\r\n      return true;\r\n  return false;\r\n}\r\n\r\nfunction validateInt(strInt) {\r\n    if (\/^(\\-|\\+)?([0-9]+)$\/\r\n      .test(strInt))\r\n      return true;\r\n  return false;\r\n}\r\n\r\n\/\/ YYYY\/MM\/DD or MM\/DD\/YYYY\r\nfunction validateDate(strDate) {\r\n\/\/  var t = \/^(?=.+([\\\/.-])..\\1)(?=.{10}$)(?:(\\d{4}).|)(\\d\\d).(\\d\\d)(?:.(\\d{4})|)$\/;\r\n\/\/  strDate.replace(t, function($, _, y, m, d, y2) {\r\n\/\/    $ = new Date(y = y || y2, m, d);\r\n\/\/    t = $.getFullYear() != y || $.getMonth() != m || $.getDate() != d;\r\n\/\/  });\r\n\/\/  return !t;\r\n   var mydate= Date.parse(strDate);\r\n   if (isNaN(mydate)) return false;\r\n   else return true; \r\n}\r\n\r\nfunction determineType(value)\r\n{\r\n  var selectorType= \"\";\r\n  if (validateInt(value)) {selectorType = \"integer\";}\r\n  else if (value.match(\"[A-Za-z][A-Za-z0-9]*\")) {selectorType = \"string\";}\r\n  else if (validateFloat(value)) {selectorType = \"float\";}\r\n  else if (validateDate(value)) {selectorType = \"date\";\r\n  }else {selectorType = \"object\";}\r\n  return selectorType;\r\n}\r\n\r\nfunction dateThing(value){\r\n    var d = new Date(value);\r\n            value =[ (d.getMonth()+1).padLeft(),\r\n                    d.getDate().padLeft(),\r\n                    d.getFullYear()].join(\'\/\')+\r\n                    \' \' +\r\n                  [ d.getHours().padLeft(),\r\n                    d.getMinutes().padLeft(),\r\n                    d.getSeconds().padLeft()].join(\':\');\r\n    return value;\r\n}\r\n msg.payload = snap4cityParser(\""+sensors[i]+"\", \"ngsi\", msg.payload, ["+attributes_string+"] );\r\n return msg;\r\n\r\n\r\n",
						"outputs": 1,
						"noerr": 0,
						"x": 600,
						"y": offsetY,
						"wires": [
							[log_id]
						]
					});

					//eventlog
					newflow.push({
						"id": log_id,
						"type": "event-log",
						"z": flow_id,
						"name": "",
						"modcom": "TX",
						"motivation": "IoT_Service",
						"x": 800,
						"y": offsetY,
						"wires": [
							[
								function_id
							],
							[]
							]
					})

													
					offsetY+=offsetYstep;

                }
                 //$("#btn-sidemenu").simulate("click");
                 console.log("simulate click")

                 setTimeout(function(){ 
                 	$("#menu-item-import-clipboard").simulate("click");
                 	$("#clipboard-dialog textarea").html(JSON.stringify(newflow));
                 	$("#clipboard-dialog-ok").removeClass("ui-button-disabled");
                 	$("#clipboard-dialog-ok").removeClass("ui-state-disabled");
                 	$("#clipboard-dialog-ok").attr("aria-disabled",false);
                 	$('#clipboard-dialog-ok').removeAttr("disabled");
                 //	$('#import-tab-current').removeClass("selected");
            //     	$('#import-tab-new').addClass("selected");
                 	
                 }, 250);





                console.log("newflow is");
				console.log(JSON.stringify(newflow));

			  })
			  .fail(function() {
			    console.log( "error" );
			  })
			  .always(function() {
			    console.log( "complete" );
			  });

             
               return;




        
    }
            
    function createFlow_agg_device(sensors, configData){
        		
        		configData=allDataIn;
        		if(!sensors.length) return;
        		
        		//console.log( "Big, I am here, for Ssensors ", Ssensors );
        		
        		//var sensors=Ssensors[0];
        		
        		//if(!sensors.length) return;
        		
        		//console.log( "small, I am here, for Ssensors ", Ssensors );


                //numero id dei nodi che  devono essere generati
                //var idAmount = sensors.length * 4 + 7;
                var idAmount = sensors.length * 4 + 2+ device_types.length*4;

                var jqxhr = $.getJSON( "get-id?n="+idAmount, function(data) {
    			  console.log( "success" );
    			 // console.log( data );
    			})
    			  .done(function(data) {
                      console.log( "second success..." );

                      console.log( data );

                      var offsetY =200;
                      var offsetYstep = 100;  
                      var middleY = offsetY + offsetYstep*(sensors.length-1)/2;

                //new flow
                      var counter_id = 0;
                      var flow_id = data.ids[counter_id++]; //0
    				//var debug_id = data.ids[counter_id++]; //1
    				//var function_id = data.ids[counter_id++]; //2
    				//var inject_id = data.ids[counter_id++] //3
                    //var link_out_id = data.ids[counter_id++] //4

                    //curr flow
                    //var link_in_id = data.ids[counter_id++] //5
                      var curr_flow_id = data.ids[counter_id++]; //6
                      
                      linkFunctionDTable=[];
                    
                      for (var d=0; d<device_types.length; d++){
                            var obj={};
                            obj.link_out_id=data.ids[counter_id++];
                            obj.link_out_type= device_types[d];
                            linkFunctionDTable.push(obj);

                        } 
                      
                      deviceLinkDTable=[];
                      for (var i=0; i<sensors.length; i++){
                          var obj={};
                          obj.device= sensors[i];
                          obj.device_id=data.ids[counter_id++];
                          obj.eventId=data.ids[counter_id++];
                          for(var j=0; j<linkFunctionDTable.length; j++){
                              if (configData[sensors[i]]["entityType"]==linkFunctionDTable[j].link_out_type){
                                  obj.link_out_id=linkFunctionDTable[j].link_out_id;
                                  break; //because in this case 1 to 1 relationship
                              }
                                  
                          }
                          deviceLinkDTable.push(obj);
                      }
                      
                      //update the linkFunctionDTable
                      
                      for (var i=0; i<linkFunctionDTable.length; i++){
                          var relatedEvents=[];
                          for(var j=0; j<deviceLinkDTable.length; j++){
                              if (deviceLinkDTable[j].link_out_id==linkFunctionDTable[i].link_out_id){
                                  relatedEvents.push(deviceLinkDTable[j].eventId);
                                  //we do not put break because relationship may be one to many
                              }
                          }
                          linkFunctionDTable[i].events=relatedEvents;
                          linkFunctionDTable[i].correspondingLinkIn=data.ids[counter_id++];
                      }


    				


    				//console.log("counterid="+counter_id);

    			    var newflow = [];


    			  //link in (that appears in the current flow not in the new created one)
                  for (var i=0; i<linkFunctionDTable.length; i++){
                  
                      newflow.push({
                          "id": linkFunctionDTable[i].correspondingLinkIn,
                          "type": "link in",
                          "z": curr_flow_id,
                          "name": linkFunctionDTable[i].link_out_type,
                          "links": [linkFunctionDTable[i].link_out_id],
                          "x": 200+150,
                          "y": 200+i*offsetY/2,
                          "wires": [
                              []
                          ]
                  });
                      
                     /* newflow.push(    {
                          "id": data.ids[counter_id++],
                           "icon":"",
                          "type": "label",
                          "z": curr_flow_id,
                          "name": linkFunctionDTable[i].link_out_type,
                          "x": 200,
                          "y": 200+i*offsetY/2,
                          "wires": []
                      });*/
                  
                  }

                  //flow
                  newflow.push({
                      "id": flow_id,
                      "type": "tab",
                      "label": "Flow " + flow_id
                  });


                  //link out
                  for (var i=0; i<linkFunctionDTable.length; i++){
                        newflow.push(    {
                          "id": linkFunctionDTable[i].link_out_id,
                          "type": "link out",
                          "z": flow_id,
                          "name": linkFunctionDTable[i].link_out_type,
                          "links": [linkFunctionDTable[i].correspondingLinkIn],
                          "x": 1200,
                          "y": middleY-linkFunctionDTable.length*offsetYstep/2+ i*offsetYstep,
                          "wires": []
                      });
                      /* newflow.push(    {
                          "id": data.ids[counter_id++],
                           "icon":"",
                          "type": "label",
                          "z": flow_id,
                          "name": linkFunctionDTable[i].link_out_type,
                          "x": 1200+100,
                          "y": middleY-linkFunctionDTable.length*offsetYstep/2+ i*offsetYstep,
                          "wires": []
                      });*/
                  }
                      console.log("linkFunctionDTable");
                      console.log(linkFunctionDTable);
                      

    			   /* //debug
    			    newflow.push({
    			    		"id": debug_id,
    						"type": "debug",
    						"z": flow_id,
    						"name": "",
    						"active": true,
    						"console": "false",
    						"complete": "false",
    						"x": 1200,
    						"y": middleY,
    						"wires": []
    						})
                  */



    			    //collect
    			   /* newflow.push({
    							"id": function_id,
    							"type": "function",
    							"z": flow_id,
    							"name": "collect",
    							"func": "\nreturn msg;",
    							"outputs": 1,
    							"noerr": 0,
    							"x": 1000,
    							"y": middleY,
    							"wires": [
    							[
    									link_out_id
    								]
    							]
    						})*/


    			    //sensori

    			    var addInjectNode=false;
     
                  var orion_ids=[];
                  var protocol;


                  

                  for(var i=0;i<sensors.length;i++){
                  	console.log("orion--")
                  	console.log(configData[sensors[i]])
                  	try {
                  		protocol = configData[sensors[i]]["protocol"];
    							}
    					catch(err) {
     						 protocol="none";
    							}
    					
    					console.log("protocol is "+ protocol);
                  	
                  	var conf_id = data.ids[counter_id++];
                  	//var log_id = data.ids[counter_id++];
                  	var function_id;
                    var node_id;
                    var corresponding_out_id;
                    for(var j =0; j< deviceLinkDTable.length; j++){
                          if(sensors[i]==deviceLinkDTable[j].device){
                              function_id= deviceLinkDTable[j].eventId;
                              node_id= deviceLinkDTable[j].device_id;
                              corresponding_out_id=deviceLinkDTable[j].link_out_id;
                          }
                      }
                  	var ev_id = data.ids[counter_id++];
                  	
                  	var attributes=[];
                  	console.log("idValueArray is "+idValueArray);
					console.log("sensors[i] "+sensors[i]);
                  	for (var j=0; j< idValueArray.length; j++ ){
						console.log("idValueArray[j].id "+idValueArray[j].id);
						if (idValueArray[j].id==sensors[i])
						attributes= idValueArray[j].values;
					}
                  	console.log("attributes is "+attributes);
					var attributes_string="";
					for (var j=0; j<attributes.length; j++){
						if(j< attributes.length-1){
							attributes_string+="'"+ attributes[j]+"',";
						}
						else{
							attributes_string+="'"+ attributes[j]+"'";
						}
					}
                  	console.log(counter_id);
                  	
                      //device
                      switch(protocol){
    			  	    	case "ngsi":
    	                		//addInjectNode=true;
    	                        orion_ids.push(node_id)
    	                	    newflow.push({
    								"id": conf_id,
    								"type": "orion-service",
    								"z": "",
    								"name": configData[sensors[i]]["ip"]+":"+configData[sensors[i]]["port"],
    								"url": configData[sensors[i]]["ip"],
    								"port": configData[sensors[i]]["port"]
    								})

    						
    /* 
    	                	    newflow.push({
    								"id": node_id,
    								"type": "fiware orion",
    								"z": flow_id,
    								"name":  sensors[i],
    								"service": conf_id,
    								"entype": configData[sensors[i]]["type"],
    								"enid": sensors[i],
    								"attributes": "",
    								"rtype": "",
    								"rvalue": "",
    								"limit": 20,
    								"includeattr": true,
    								"x": 400,
    								"y": offsetY,
    								"wires": [
    									[
    										ev_id
    									]
    								]
    							})*/

                              newflow.push({
                                  "id": node_id,
                                  "type": "fiware orion in",
                                  "z": flow_id,
                                  "name": "",
                                  "service": conf_id,
                                  "throttle": "PT5S",
                                  "entype": configData[sensors[i]]["entityType"],
                                  "enid": sensors[i],
                                  "ispattern": false,
                                  "duration": "P1W",
                                  "attributes": ""+attributes,
                                  "condvalues": ".*",
                                  "includeattr": true,
                                  "noderedhost": "",
                                  "noderedhostauto": true,
                                  "x": 400,
                                  "y": offsetY,
                                  "wires": [
                                      [
                                      ev_id
                                      ]
                                  ]
                                  })
    						break;


                          //mosquitto
    						case "mqtt":

    	                	    newflow.push({
    								"id": conf_id,
    								"type": "mqtt-broker",
    								"z": "",
    								"broker": configData[sensors[i]]["ip"],
    								"port":  configData[sensors[i]]["port"],
    								"clientid": "",
    								"usetls": false,
    								"compatmode": true,
    								"keepalive": "60",
    								"cleansession": true,
    								"willTopic": "",
    								"willQos": "0",
    								"willRetain": "false",
    								"willPayload": "",
    								"birthTopic": "",
    								"birthQos": "0",
    								"birthRetain": "false",
    								"birthPayload": ""
    							})





    	                	    newflow.push({
    								"id": node_id,
    								"type": "mqtt in",
    								"z": flow_id,
    								"name": sensors[i],
    								"topic": sensors[i],
    								"qos": "2",
    								"broker": conf_id,
    								"x": 400,
    								"y": offsetY,
    								"wires": [
    									[
    										ev_id
    									]
    								]
    							})

    						break;

    						//rabbit
    						  //	$("#node-input-ioname").val(rabbitNodes[rabbitCount]["sensorId"]);
    	  					   //  	$("#node-input-iotype").val(4);
                        case "AMQP":  
                        case "amqp":
    							newflow.push({
    								"id": conf_id,
    								"type": "amqp-server",
    								"z": "",
    								"host": configData[sensors[i]]["ip"],
    								"port": configData[sensors[i]]["port"],
    								"vhost": "",
    								"keepalive": "30",
    								"usetls": false,
    								"verifyservercert": true,
    								"usetopology": false,
    								"topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}"
    							})

    							newflow.push({
    								"id": node_id,
    								"type": "amqp in",
    								"z": flow_id,
    								"name": sensors[i],
    								"topic": "",
    								"iotype": "4",
    								"ioname": sensors[i],
    								"server": conf_id,
    								"x": 400,
    								"y": offsetY,
    								"wires": [
    									[ev_id]
    								]
    							})

    						break;

                  	}
					
					//eventlog	
                      newflow.push({
    						"id": ev_id,
    						"type": "event-log",
    						"z": flow_id,
    						"name": "",
    						"modcom": "TX",
    						"motivation": "IoT_Service",
    						"x": 600,
    						"y": offsetY,
    						"wires": [
    							[
    								function_id
    							],
    							[]
    							]
    					});

                      //function  
                      newflow.push({
    						"id": function_id,
    						"type": "function",
    						"z": flow_id,
    						"name": "transform",
    						"func": "\r\n\r\n\/* determine type of value and extract the contained attributes according to the following formats \r\n- format A (comma separated pairs):\r\n  attribute:value, ...., attribute:value  \r\n- format B (comma separated basic values):\r\n  value, ..., value (in this case the attribute name would be csv_\"pos\" where pos is the position) \r\n- format C (JSON values):\r\n  {attribute:value, ..., attribute:value}\r\n- format D (XML values):\r\n  <record><attribute>value<\/attribute>...<attribute>value<\/attribute><\/record>  \r\n*\/\r\n\/*\r\n{\r\n  \"id\": \"Room1\",\r\n  \"type\": \"Room\",\r\n  \"temperature\": {\r\n    \"value\": 23,\r\n    \"type\": \"Float\"\r\n  },\r\n  \"pressure\": {\r\n    \"value\": 720,\r\n    \"type\": \"Integer\"\r\n  }\r\n}\r\n*\/\r\nfunction snap4cityParser(sensorID, protocol, value, selectedAttributes)\r\n{\r\n  var attributes=[];\r\n  var newType=\"\"; \r\n  var newId=\"\";   \r\n  if (protocol==\"ngsi\") \r\n   {  \r\n     var x=\"\";\r\n     value=JSON.parse(value); \r\n     for (x in value)\r\n\t {\r\n\t   if (x==\"id\") newId= value[x];\r\n\t   else if (x==\"type\") newType=value[x];\r\n\t   else attributes[x]=value[x];\r\n\t }\r\n   }\r\n  else{   \r\n\t  var f = \"\"; \/\/ identified format\r\n\t  value=value.trim();\r\n\t  var first = value.charAt(0);\r\n\t  switch (first)\r\n\t  {\r\n\t\tcase \"{\": \/\/ Format C\r\n\t\t\tattributes = parseJSON(value);\r\n\t\t\tf=\"JSON\";\r\n\t\t\tbreak;\r\n\t\tcase \"<\": \/\/ Format D\r\n\t\t\tattributes = parseXML(value);\r\n\t\t\tf=\"XML\";\r\n\t\t\tbreak;\r\n\t\tdefault: \/\/ Format A or B\r\n\t\t   attributes = parseCSV(value);\r\n\t\t   f=\"CSV\";\r\n\t  }\r\n   }  \r\n   if (selectedAttributes.length==0)\r\n   {         \r\n\t  return {\"id\": sensorID, \"source\": protocol, \"type\": newType, attributes};\r\n   }\r\n   else\r\n   {\r\n      for (x in attributes)\r\n\t  {\r\n\t    if (selectedAttributes.indexOf(x)==-1)  delete attributes[x];\r\n\t  }\r\n      return {\"id\": sensorID, \"source\": protocol, \"type\": newType, attributes};\r\n   }    \r\n}\r\n\r\nNumber.prototype.padLeft = function(base,chr){\r\n   var  len = (String(base || 10).length - String(this).length)+1;\r\n   return len > 0? new Array(len).join(chr || \'0\')+this : this;\r\n}\r\n\r\n\r\nfunction parseCSV(value)\r\n{\r\n  \/*\r\n  parse comma separated values \r\n  each value can assume the following formats:\r\n  format A (comma separated pair): attribute:value  \r\n  format B (comma separated basic value):  value\r\n  *\/\r\n    \r\n  \r\n  var delims = \",\"; \r\n  var properties = value.split(delims);\r\n  var attributes = {};\r\n  var format = \"A\";\r\n  var cv;\r\n  var pos=1;\r\n  for (i = 0; i < properties.length; i++)\r\n  {\r\n    var prop = properties[i].trim();\r\n    if (prop.indexOf(\":\")==-1 || (prop.indexOf(\":\")>0 && prop.indexOf(\":\")!=prop.lastIndexOf(\":\")))\r\n    { \/\/ condition is that \":\" do not occur or\r\n      \/\/ \":\"  occurs once in any prop and not in the first position\r\n        id =\"csv_\" + pos;\r\n        pos++;\r\n        val =properties[i].trim();\r\n        if (determineType(val)==\"date\")\r\n          {\r\n            var d = new Date(val);\r\n            val =[ (d.getMonth()+1).padLeft(),\r\n                    d.getDate().padLeft(),\r\n                    d.getFullYear()].join(\'\/\')+\r\n                    \' \' +\r\n                  [ d.getHours().padLeft(),\r\n                    d.getMinutes().padLeft(),\r\n                    d.getSeconds().padLeft()].join(\':\');\r\n\r\n          }\r\n          attributes[id]={\"type\": determineType(val),\"value\" : val};\r\n    }\r\n    else\r\n    {\r\n\t  cv= properties[i].split(\":\");\r\n\t  myid=cv[0].trim();\r\n          val=cv[1].trim();\r\n          var attr={};\r\n          if (determineType(val)==\"date\") \r\n          {\r\n            var d = new Date(val);\r\n            val =[ (d.getMonth()+1).padLeft(),\r\n                    d.getDate().padLeft(),\r\n                    d.getFullYear()].join(\'\/\')+\r\n                    \' \' +\r\n                  [ d.getHours().padLeft(),\r\n                    d.getMinutes().padLeft(),\r\n                    d.getSeconds().padLeft()].join(\':\');\r\n\r\n          }\r\n          attributes[myid]= {\"type\": determineType(val), \"value\":val};\r\n    }\r\n  }\r\n  \/\/ console.log(attributes);\r\n  return attributes;\r\n}\r\n\r\n\/*  this function should be completed *\/\r\nfunction parseXML(value)\r\n{\r\n    var parser = new DOMParser();\r\n    var xmlDoc = parser.parseFromString(value, \"text\/xml\");\r\n    \r\n    var element = xmlDoc.documentElement;\r\n    var elements = element.querySelectorAll(\"*\");\r\n    \r\n    var attributes = [];\r\n\r\n    for (var i = 0; i < elements.length; i++) {\r\n        var text = null;\r\n        if (elements[i].childNodes.length == 1 && elements[i].childNodes[0].nodeType == 3) \/\/if nodeType == text node\r\n        {\r\n            text = elements[i].textContent; \/\/get text of the element\r\n            var id =elements[i].tagName;\r\n            var val =text.trim();\r\n            \r\n             if (determineType(val)==\"date\") {\r\n                 val= dateThing(val);\r\n             }\r\n            attributes[id]= {\"type\": determineType(val), \"value\":val};\r\n            \r\n        }\r\n        \/\/console.log(\"TagName : \", id, \", value : \", val);\r\n        \r\n        \r\n    }\r\n    return attributes;\r\n    \r\n}\r\n\r\n\/*  this function should be completed *\/\r\nfunction parseJSON(value)\r\n{  try{\r\n   jsonvalue= JSON.parse(value);\r\n    var attributes = [];\r\n    \r\n    for (var key in jsonvalue){\r\n     \r\n        var id =key; \r\n        if (id==\"type\" || id==\"id\") continue; \/\/these are not attribute, we don\'t need them\r\n        var val =jsonvalue[id];\r\n        if(typeof(val)==\'object\') {\r\n            \r\n            jsonSubValue=val;\r\n            \r\n            for (var k in jsonSubValue){\r\n                if (k==\"type\" || k==\"id\") continue; \/\/these are not attribute, we don\'t need them\r\n                v= jsonSubValue[k];\r\n                \r\n                try{v=v.trim();} catch(err){}\r\n                if (determineType(v)== \"date\") {\r\n                    v= dateThing(v);\r\n                    }\r\n                attributes.push({\"name\":key ,\"type\": determineType(v),\"value\" : v});\r\n            }\r\n        }\r\n        else{\r\n            val= val.trim(); \r\n            if (determineType(val)== \"date\") {\r\n                 val= dateThing(val);\r\n             }\r\n            \r\n            attributes.push({\"name\":id ,\"type\": determineType(val),\"value\" : val});\r\n        }\r\n            \r\n    }\r\n    \r\n  return attributes;\r\n}\r\n catch(err){\r\n     return [];\r\n}\r\n}\r\n\r\n\r\nfunction validateFloat(strFloat) {\r\n    if (\/^(\\-|\\+)?([0-9]+(\\.[0-9]+)?|Infinity)$\/\r\n      .test(strFloat))\r\n      return true;\r\n  return false;\r\n}\r\n\r\nfunction validateInt(strInt) {\r\n    if (\/^(\\-|\\+)?([0-9]+)$\/\r\n      .test(strInt))\r\n      return true;\r\n  return false;\r\n}\r\n\r\n\/\/ YYYY\/MM\/DD or MM\/DD\/YYYY\r\nfunction validateDate(strDate) {\r\n\/\/  var t = \/^(?=.+([\\\/.-])..\\1)(?=.{10}$)(?:(\\d{4}).|)(\\d\\d).(\\d\\d)(?:.(\\d{4})|)$\/;\r\n\/\/  strDate.replace(t, function($, _, y, m, d, y2) {\r\n\/\/    $ = new Date(y = y || y2, m, d);\r\n\/\/    t = $.getFullYear() != y || $.getMonth() != m || $.getDate() != d;\r\n\/\/  });\r\n\/\/  return !t;\r\n   var mydate= Date.parse(strDate);\r\n   if (isNaN(mydate)) return false;\r\n   else return true; \r\n}\r\n\r\nfunction determineType(value)\r\n{\r\n  var selectorType= \"\";\r\n  if (validateInt(value)) {selectorType = \"integer\";}\r\n  else if (value.match(\"[A-Za-z][A-Za-z0-9]*\")) {selectorType = \"string\";}\r\n  else if (validateFloat(value)) {selectorType = \"float\";}\r\n  else if (validateDate(value)) {selectorType = \"date\";\r\n  }else {selectorType = \"object\";}\r\n  return selectorType;\r\n}\r\n\r\nfunction dateThing(value){\r\n    var d = new Date(value);\r\n            value =[ (d.getMonth()+1).padLeft(),\r\n                    d.getDate().padLeft(),\r\n                    d.getFullYear()].join(\'\/\')+\r\n                    \' \' +\r\n                  [ d.getHours().padLeft(),\r\n                    d.getMinutes().padLeft(),\r\n                    d.getSeconds().padLeft()].join(\':\');\r\n    return value;\r\n}\r\n msg.payload = snap4cityParser(\""+sensors[i]+"\", \"ngsi\", msg.payload, ["+attributes_string+"] );\r\n return msg;\r\n\r\n\r\n",
    						"outputs": 1,
    						"noerr": 0,
    						"x": 800,
    						"y": offsetY,
    						"wires": [corresponding_out_id]
    					})

    					
                      

    													
    					offsetY+=offsetYstep;

                  	   




                  }

          
              
    				//inject node //set to false, dunno what that was supposed to be
                  if(addInjectNode){
                      newflow.push(
    						{
    								"id": inject_id,
    								"type": "inject",
    								"z": flow_id,
    								"name": "",
    								"topic": "",
    								"payload": "",
    								"payloadType": "date",
    								"repeat": "5",
    								"crontab": "",
    								"once": false,
    								"x": 200,
    								"y": middleY,
    								"wires": [
    							
    									orion_ids
    								
    								]
    						}
    					)


                   }

                   //$("#btn-sidemenu").simulate("click");
                   console.log("simulate click")

                   setTimeout(function(){ 
                   	$("#menu-item-import-clipboard").simulate("click");
                   	$("#clipboard-dialog textarea").html(JSON.stringify(newflow));
                   	$("#clipboard-dialog-ok").removeClass("ui-button-disabled");
                   	$("#clipboard-dialog-ok").removeClass("ui-state-disabled");
                   	$("#clipboard-dialog-ok").attr("aria-disabled",false);
                   	$('#clipboard-dialog-ok').removeAttr("disabled");
                   //	$('#import-tab-current').removeClass("selected");
              //     	$('#import-tab-new').addClass("selected");
                   	
                   }, 250);




                  console.log("newflow is");
    				console.log(JSON.stringify(newflow));
    				
    				//function instead of .shift() because for some reasons it's not working!
    				/*var Asensors=[];
    				
    				if(Ssensors.length >2){
	    				for (var i=1; i<Ssensors.length; i++){
	    					Asensors.push(Ssensors[i]);
	    				}
	    				createFlow(Asensors, configData);
    				}
    				else if(Ssensors.length>0) 
    					{
    						Asensors.push(Ssensors[0]);
    						createFlow(Asensors, configData);
    					}*/
    				

    			  })
    			  .fail(function() {
    			    console.log( "error" );
    			  })
    			  .always(function() {
    			    console.log( "complete" );
    			  });

               
                 return;
        	}
        	
    function createFlow_agg_value(sensors, configData){
        		
        		configData=allDataIn;
        		if(!sensors.length) return;
        		
        		
                var idAmount = sensors.length * 4 + 2+ value_types.length*4;

                var jqxhr = $.getJSON( "get-id?n="+idAmount, function(data) {
    			  console.log( "success" );
    			 // console.log( data );
    			})
    			  .done(function(data) {
                      console.log( "second success..." );

                      console.log( data );

                      var offsetY =200;
                      var offsetYstep = 100;  
                      var middleY = offsetY + offsetYstep*(sensors.length-1)/2;

                //new flow
                      var counter_id = 0;
                      var flow_id = data.ids[counter_id++]; 
                      var curr_flow_id = data.ids[counter_id++]; 
                      
                      linkFunctionVTable=[];
                    
                      for (var d=0; d<value_types.length; d++){
                            var obj={};
                            obj.link_out_id=data.ids[counter_id++];
                            obj.link_out_type= value_types[d];
                            linkFunctionVTable.push(obj);

                        } 
                      console.log("before sorting");
                      console.log(linkFunctionVTable);
                      linkFunctionVTable.sort(function(a,b){
                          if(a.link_out_type < b.link_out_type) return -1;
                          else return 1;
                      });
                      console.log("after sorting");
                      console.log(linkFunctionVTable);
                      
                      deviceLinkVTable=[];
                      for (var i=0; i<idValueArray.length; i++){
                          var obj={};
                          obj.device= idValueArray[i].id;
                          obj.device_id=data.ids[counter_id++];
                          obj.functionId=data.ids[counter_id++];
                          obj.link_out_ids=[];
                          for(var j=0; j<linkFunctionVTable.length; j++){
                              for(var k=0; k<idValueArray[i].values.length; k++){
                                  if (linkFunctionVTable[j].link_out_type == idValueArray[i].values[k] ){
                                  obj.link_out_ids.push(linkFunctionVTable[j].link_out_id);
                                  //no break because in this case many to many relationship
                                  }
                              }
                              
                                  
                          }
                          deviceLinkVTable.push(obj);
                          console.log("obj.link_out_ids");
                          console.log(obj.link_out_ids);
                      }
                      
                      //update the linkEventTable
                      
                      for (var i=0; i<linkFunctionVTable.length; i++){
                          var relatedFunctions=[];
                          for(var j=0; j<deviceLinkVTable.length; j++){
                              for(var k=0; k<deviceLinkVTable[j].link_out_ids.length; k++){
                                  if (linkFunctionVTable[i].link_out_id == deviceLinkVTable[j].link_out_ids[k]){
                                  relatedFunctions.push(deviceLinkVTable[j].functionId);
                                  //we do not put break because relationship may be one to many
                                  }
                              }
                              
                          }
                          linkFunctionVTable[i].events=relatedFunctions;
                          linkFunctionVTable[i].correspondingLinkIn=data.ids[counter_id++];
                          console.log("relatedFunctions");
                          console.log(relatedFunctions);
                          
                      }
                      
                      

    				//console.log("counterid="+counter_id);

    			    var newflow = [];


    			  //link in (that appears in the current flow not in the new created one)
                  for (var i=0; i<linkFunctionVTable.length; i++){
                  
                      newflow.push({
                          "id": linkFunctionVTable[i].correspondingLinkIn,
                          "type": "link in",
                          "z": curr_flow_id,
                          "name": linkFunctionVTable[i].link_out_type,
                          "links": [linkFunctionVTable[i].link_out_id],
                          "x": 200+150,
                          "y": 200+i*offsetY/2,
                          "wires": [
                              []
                          ]
                  });
                      
                     /* newflow.push(    {
                          "id": data.ids[counter_id++],
                           "icon":"",
                          "type": "label",
                          "z": curr_flow_id,
                          "name": linkFunctionVTable[i].link_out_type,
                          "x": 200,
                          "y": 200+i*offsetY/2,
                          "wires": []
                      });*/
                  
                  }

                  //flow
                  newflow.push({
                      "id": flow_id,
                      "type": "tab",
                      "label": "Flow " + flow_id
                  });


                  //link out
                  for (var i=0; i<linkFunctionVTable.length; i++){
                        newflow.push(    {
                          "id": linkFunctionVTable[i].link_out_id,
                          "type": "link out",
                          "z": flow_id,
                          "name": linkFunctionVTable[i].link_out_type,
                          "links": [linkFunctionVTable[i].correspondingLinkIn],
                          "x": 1200,
                          "y": middleY-linkFunctionVTable.length*offsetYstep/2+ i*offsetYstep,
                          "wires": []
                      });
                      /* newflow.push(    {
                          "id": data.ids[counter_id++],
                           "icon":"",
                          "type": "label",
                          "z": flow_id,
                          "name": linkFunctionVTable[i].link_out_type,
                          "x": 1200+100,
                          "y": middleY-linkFunctionVTable.length*offsetYstep/2+ i*offsetYstep,
                          "wires": []
                      });*/
                  }
                      console.log("linkEventTable");
                      console.log(linkFunctionVTable);
                      

   
                  var orion_ids=[];
                  var protocol;



                 for(var i=0;i<sensors.length;i++){
                  	console.log("orion--")
                  	console.log(configData[sensors[i]])
                  	try {
                  		protocol = configData[sensors[i]]["protocol"];
    							}
    					catch(err) {
     						 protocol="none";
    							}
    					
    					console.log("protocol is "+ protocol);
                  	
                  	var conf_id = data.ids[counter_id++];
                  	//var log_id = data.ids[counter_id++];
                  	var function_id;
                    var node_id;
                    var corresponding_out_ids=[];
                    for(var j =0; j< deviceLinkVTable.length; j++){
                          if(sensors[i]==deviceLinkVTable[j].device){
                              function_id= deviceLinkVTable[j].functionId;
                              node_id= deviceLinkVTable[j].device_id;
                              corresponding_out_ids=deviceLinkVTable[j].link_out_ids;
                          }
                      }
                     console.log("corresponding_out_ids");
                     console.log(corresponding_out_ids);
                     
                  	var ev_id = data.ids[counter_id++];
                  	
                  	var attributes=[];
                  	console.log("idValueArray is "+idValueArray);
					console.log("sensors[i] "+sensors[i]);
                  	for (var j=0; j< idValueArray.length; j++ ){
						console.log("idValueArray[j].id "+idValueArray[j].id);
						if (idValueArray[j].id==sensors[i])
						attributes= idValueArray[j].values;
					}
                  	console.log("attributes is "+attributes);
					var attributes_string="";
					for (var j=0; j<attributes.length; j++){
						if(j< attributes.length-1){
							attributes_string+="'"+ attributes[j]+"',";
						}
						else{
							attributes_string+="'"+ attributes[j]+"'";
						}
					}
                  	console.log(counter_id);
                  	
                      //device
                      switch(protocol){
    			  	    	case "ngsi":
    	                		//addInjectNode=true;
    	                        orion_ids.push(node_id)
    	                	    newflow.push({
    								"id": conf_id,
    								"type": "orion-service",
    								"z": "",
    								"name": configData[sensors[i]]["ip"]+":"+configData[sensors[i]]["port"],
    								"url": configData[sensors[i]]["ip"],
    								"port": configData[sensors[i]]["port"]
    								})

    						
   

                              newflow.push({
                                  "id": node_id,
                                  "type": "fiware orion in",
                                  "z": flow_id,
                                  "name": "",
                                  "service": conf_id,
                                  "throttle": "PT5S",
                                  "entype": configData[sensors[i]]["entityType"],
                                  "enid": sensors[i],
                                  "ispattern": false,
                                  "duration": "P1W",
                                  "attributes": ""+attributes,
                                  "condvalues": ".*",
                                  "includeattr": true,
                                  "noderedhost": "",
                                  "noderedhostauto": true,
                                  "x": 400,
                                  "y": offsetY,
                                  "wires": [
                                      [
                                      ev_id
                                      ]
                                  ]
                                  })
    						break;


                          //mosquitto
    						case "mqtt":

    	                	    newflow.push({
    								"id": conf_id,
    								"type": "mqtt-broker",
    								"z": "",
    								"broker": configData[sensors[i]]["ip"],
    								"port":  configData[sensors[i]]["port"],
    								"clientid": "",
    								"usetls": false,
    								"compatmode": true,
    								"keepalive": "60",
    								"cleansession": true,
    								"willTopic": "",
    								"willQos": "0",
    								"willRetain": "false",
    								"willPayload": "",
    								"birthTopic": "",
    								"birthQos": "0",
    								"birthRetain": "false",
    								"birthPayload": ""
    							})





    	                	    newflow.push({
    								"id": node_id,
    								"type": "mqtt in",
    								"z": flow_id,
    								"name": sensors[i],
    								"topic": sensors[i],
    								"qos": "2",
    								"broker": conf_id,
    								"x": 400,
    								"y": offsetY,
    								"wires": [
    									[
    										ev_id
    									]
    								]
    							})

    						break;

    						//rabbit
    						  //	$("#node-input-ioname").val(rabbitNodes[rabbitCount]["sensorId"]);
    	  					   //  	$("#node-input-iotype").val(4);
                        case "AMQP":  
                        case "amqp":
    							newflow.push({
    								"id": conf_id,
    								"type": "amqp-server",
    								"z": "",
    								"host": configData[sensors[i]]["ip"],
    								"port": configData[sensors[i]]["port"],
    								"vhost": "",
    								"keepalive": "30",
    								"usetls": false,
    								"verifyservercert": true,
    								"usetopology": false,
    								"topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}"
    							})

    							newflow.push({
    								"id": node_id,
    								"type": "amqp in",
    								"z": flow_id,
    								"name": sensors[i],
    								"topic": "",
    								"iotype": "4",
    								"ioname": sensors[i],
    								"server": conf_id,
    								"x": 400,
    								"y": offsetY,
    								"wires": [
    									[ev_id]
    								]
    							})

    						break;

                  	}

                      //eventlog	
                      newflow.push({
    						"id": ev_id,
    						"type": "event-log",
    						"z": flow_id,
    						"name": "",
    						"modcom": "TX",
    						"motivation": "IoT_Service",
    						"outputs": 1,
                            "x": 600,
    						"y": offsetY,
    						"wires": 
    							[
    							[function_id]
    						]
    								
    							
    					})

					  
					  //function  
                      newflow.push({
    						"id": function_id,
    						"type": "function",
    						"z": flow_id,
    						"name": "transform",
    						"func": "\r\n\r\n\/* determine type of value and extract the contained attributes according to the following formats \r\n- format A (comma separated pairs):\r\n  attribute:value, ...., attribute:value  \r\n- format B (comma separated basic values):\r\n  value, ..., value (in this case the attribute name would be csv_\"pos\" where pos is the position) \r\n- format C (JSON values):\r\n  {attribute:value, ..., attribute:value}\r\n- format D (XML values):\r\n  <record><attribute>value<\/attribute>...<attribute>value<\/attribute><\/record>  \r\n*\/\r\n\/*\r\n{\r\n  \"id\": \"Room1\",\r\n  \"type\": \"Room\",\r\n  \"temperature\": {\r\n    \"value\": 23,\r\n    \"type\": \"Float\"\r\n  },\r\n  \"pressure\": {\r\n    \"value\": 720,\r\n    \"type\": \"Integer\"\r\n  }\r\n}\r\n*\/\r\nfunction snap4cityParser(sensorID, protocol, value, selectedAttributes)\r\n{\r\n  if (selectedAttributes.length==0)\r\n      return [];\r\n  \r\n  var attributes=[];\r\n  var newType=\"\"; \r\n  var newId=\"\";   \r\n  \/\/if (protocol== \"ngsi\") \r\n    if (false)\r\n   {  \r\n     var x=\"\";\r\n     value=JSON.parse(value); \r\n     for (x in value)\r\n\t {\r\n\t   if (x== \"id\") newId= value[x];\r\n\t   else if (x== \"type\") newType=value[x];\r\n\t   else attributes[x]=value[x];\r\n\t }\r\n   }\r\n  else{   \r\n      var f = \"\"; \/\/ identified format\r\n\t  value=value.trim();\r\n\t  var first = value.charAt(0);\r\n\t  switch (first)\r\n\t  {\r\n\t\tcase \"{\": \/\/ Format C\r\n\t\t\tattributes = parseJSON(value);\r\n\t\t\tf=\"JSON\";\r\n\t\t\tbreak;\r\n\t\tcase \"<\": \/\/ Format D\r\n\t\t\tattributes = parseXML(value);\r\n\t\t\tf=\"XML\";\r\n\t\t\tbreak;\r\n\t\tdefault: \/\/ Format A or B\r\n\t\t   attributes = parseCSV(value);\r\n\t\t   f=\"CSV\";\r\n\t  }\r\n   }  \r\n  \r\n    \r\n    used_values=[];  \r\n    attributes.sort(function(a,b){\r\n                          if(a.name < b.name) return -1;\r\n                          else return 1;\r\n                      });\r\n    \r\n    for (var i=0; i<attributes.length; i++)\r\n\t  {\r\n        var exist=0;\r\n\t    for (var j=0; j< selectedAttributes.length; j++){\r\n            if (selectedAttributes[j]== attributes[i].name){\r\n                exist=1;\r\n                break;\r\n            } \r\n        }\r\n          if(exist==1)\r\n              used_values.push(attributes[i].value);\r\n          \r\n\t  }\r\n    \r\n    \r\n    \r\n \r\n    \r\n    return used_values;\r\n       \r\n}\r\n\r\nNumber.prototype.padLeft = function(base,chr){\r\n   var  len = (String(base || 10).length - String(this).length)+1;\r\n   return len > 0? new Array(len).join(chr || \'0\')+this : this;\r\n}\r\n\r\n\r\nfunction parseCSV(value)\r\n{\r\n  \/*\r\n  parse comma separated values \r\n  each value can assume the following formats:\r\n  format A (comma separated pair): attribute:value  \r\n  format B (comma separated basic value):  value\r\n  *\/\r\n    \r\n  \r\n  var delims = \",\"; \r\n  var properties = value.split(delims);\r\n  var attributes =[];\r\n  var format = \"A\";\r\n  var cv;\r\n  var pos=1;\r\n  for (i = 0; i < properties.length; i++)\r\n  {\r\n    var prop = properties[i].trim();\r\n    if (prop.indexOf(\":\")==-1 || (prop.indexOf(\":\")>0 && prop.indexOf(\":\")!=prop.lastIndexOf(\":\")))\r\n    { \/\/ condition is that \":\" do not occur or\r\n      \/\/ \":\"  occurs once in any prop and not in the first position\r\n        id =\"csv_\" + pos;\r\n        pos++;\r\n        val =properties[i].trim();\r\n        if (determineType(val)== \"date\")\r\n          {\r\n            var d = new Date(val);\r\n            val =[ (d.getMonth()+1).padLeft(),\r\n                    d.getDate().padLeft(),\r\n                    d.getFullYear()].join(\'\/\')+\r\n                    \' \' +\r\n                  [ d.getHours().padLeft(),\r\n                    d.getMinutes().padLeft(),\r\n                    d.getSeconds().padLeft()].join(\':\');\r\n\r\n          }\r\n          attributes.push({\"name\":id ,\"type\": determineType(val),\"value\" : val});\r\n    }\r\n    else\r\n    {\r\n\t  cv= properties[i].split(\":\");\r\n\t  myid=cv[0].trim();\r\n          val=cv[1].trim();\r\n          var attr={};\r\n          if (determineType(val)== \"date\") \r\n          {\r\n            var d = new Date(val);\r\n            val =[ (d.getMonth()+1).padLeft(),\r\n                    d.getDate().padLeft(),\r\n                    d.getFullYear()].join(\'\/\')+\r\n                    \' \' +\r\n                  [ d.getHours().padLeft(),\r\n                    d.getMinutes().padLeft(),\r\n                    d.getSeconds().padLeft()].join(\':\');\r\n\r\n          }\r\n         attributes.push({\"name\":myid ,\"type\": determineType(val),\"value\" : val});\r\n    }\r\n  }\r\n  \/\/ console.log(attributes);\r\n  return attributes;\r\n}\r\n\r\n\/*  this function should be completed *\/\r\nfunction parseXML(value)\r\n{\r\n    var parser = new DOMParser();\r\n    var xmlDoc = parser.parseFromString(value, \"text\/xml\");\r\n    \r\n    var element = xmlDoc.documentElement;\r\n    var elements = element.querySelectorAll(\"*\");\r\n    \r\n    var attributes = [];\r\n\r\n    for (var i = 0; i < elements.length; i++) {\r\n        var text = null;\r\n        if (elements[i].childNodes.length == 1 && elements[i].childNodes[0].nodeType == 3) \/\/if nodeType == text node\r\n        {\r\n            text = elements[i].textContent; \/\/get text of the element\r\n            var id =elements[i].tagName;\r\n            var val =text.trim();\r\n            \r\n             if (determineType(val)== \"date\") {\r\n                 val= dateThing(val);\r\n             }\r\n            attributes.push({\"name\":id ,\"type\": determineType(val),\"value\" : val});\r\n            \r\n        }\r\n \r\n        \r\n        \r\n    }\r\n    return attributes;\r\n    \r\n}\r\n\r\n\/*  this function should be completed *\/\r\nfunction parseJSON(value)\r\n{  try{\r\n    jsonvalue= JSON.parse(value);\r\n    var attributes = [];\r\n    \r\n    for (var key in jsonvalue){\r\n     \r\n        var id =key; \r\n        if (id==\"type\" || id==\"id\") continue; \/\/these are not attribute, we don\'t need them\r\n        var val =jsonvalue[id];\r\n        if(typeof(val)==\'object\') {\r\n            \r\n            jsonSubValue=val;\r\n            \r\n            for (var k in jsonSubValue){\r\n                if (k==\"type\" || k==\"id\") continue; \/\/these are not attribute, we don\'t need them\r\n                v= jsonSubValue[k];\r\n                \r\n                try{v=v.trim();} catch(err){}\r\n                if (determineType(v)== \"date\") {\r\n                    v= dateThing(v);\r\n                    }\r\n                attributes.push({\"name\":key ,\"type\": determineType(v),\"value\" : v});\r\n            }\r\n        }\r\n        else{\r\n            val= val.trim(); \r\n            if (determineType(val)== \"date\") {\r\n                 val= dateThing(val);\r\n             }\r\n            \r\n            attributes.push({\"name\":id ,\"type\": determineType(val),\"value\" : val});\r\n        }\r\n            \r\n    }\r\n    \r\n  return attributes;\r\n}\r\n catch(err){\r\n     return [];\r\n}\r\n}\r\n\r\n\r\nfunction validateFloat(strFloat) {\r\n    if (\/^(\\-|\\+)?([0-9]+(\\.[0-9]+)?|Infinity)$\/\r\n      .test(strFloat))\r\n      return true;\r\n  return false;\r\n}\r\n\r\nfunction validateInt(strInt) {\r\n    if (\/^(\\-|\\+)?([0-9]+)$\/\r\n      .test(strInt))\r\n      return true;\r\n  return false;\r\n}\r\n\r\n\/\/ YYYY\/MM\/DD or MM\/DD\/YYYY\r\nfunction validateDate(strDate) {\r\n\/\/  var t = \/^(?=.+([\\\/.-])..\\1)(?=.{10}$)(?:(\\d{4}).|)(\\d\\d).(\\d\\d)(?:.(\\d{4})|)$\/;\r\n\/\/  strDate.replace(t, function($, _, y, m, d, y2) {\r\n\/\/    $ = new Date(y = y || y2, m, d);\r\n\/\/    t = $.getFullYear() != y || $.getMonth() != m || $.getDate() != d;\r\n\/\/  });\r\n\/\/  return !t;\r\n   var mydate= Date.parse(strDate);\r\n   if (isNaN(mydate)) return false;\r\n   else return true; \r\n}\r\n\r\nfunction determineType(value)\r\n{\r\n  var selectorType= \"\";\r\n  if (validateInt(value)) {selectorType = \"integer\";}\r\n  else if (value.match(\"[A-Za-z][A-Za-z0-9]*\")) {selectorType = \"string\";}\r\n  else if (validateFloat(value)) {selectorType = \"float\";}\r\n  else if (validateDate(value)) {selectorType = \"date\";\r\n  }else {selectorType = \"object\";}\r\n  return selectorType;\r\n}\r\n\r\nfunction dateThing(value){\r\n    var d = new Date(value);\r\n            value =[ (d.getMonth()+1).padLeft(),\r\n                    d.getDate().padLeft(),\r\n                    d.getFullYear()].join(\'\/\')+\r\n                    \' \' +\r\n                  [ d.getHours().padLeft(),\r\n                    d.getMinutes().padLeft(),\r\n                    d.getSeconds().padLeft()].join(\':\');\r\n    return value;\r\n}\r\n\ msg.payload = snap4cityParser(\""+sensors[i]+"\", \"ngsi\", msg.payload, ["+attributes_string+"] );\r\n return msg;\r\n\r\n\r\n",
    						"outputs":  corresponding_out_ids.length,
    						"noerr": 0,
    						"x": 800,
    						"y": offsetY,
    						"wires": corresponding_out_ids
    					});

    					

    													
    					offsetY+=offsetYstep;

   
                  }

          
    

                   //$("#btn-sidemenu").simulate("click");
                   console.log("simulate click")

                   setTimeout(function(){ 
                   	$("#menu-item-import-clipboard").simulate("click");
                   	$("#clipboard-dialog textarea").html(JSON.stringify(newflow));
                   	$("#clipboard-dialog-ok").removeClass("ui-button-disabled");
                   	$("#clipboard-dialog-ok").removeClass("ui-state-disabled");
                   	$("#clipboard-dialog-ok").attr("aria-disabled",false);
                   	$('#clipboard-dialog-ok').removeAttr("disabled");
                   //	$('#import-tab-current').removeClass("selected");
              //     	$('#import-tab-new').addClass("selected");
                   	
                   }, 250);




                  console.log("newflow is");
    				console.log(JSON.stringify(newflow));
    				
    				

    			  })
    			  .fail(function() {
    			    console.log( "error" );
    			  })
    			  .always(function() {
    			    console.log( "complete" );
    			  });

               
                 return;
        	}    	
        	 
        
			/*** controllo iniziale se sono stati selzionati sensori  ***/
            


        }
    });
    
   
</script>



////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
//			IOT DIRECTORY OUT
////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
<script type="text/javascript">

    RED.nodes.registerType('iot-directory-out',{
        category: 'S4CIoT',
        color: '#a6bbcf',
defaults: {
            name: {
                value: ""
            },
            modcom: {
				required: true
			},
			motivation: {
				required: true
			},
			latitude: {
                value: 0.0,
                required: false,
                validate: RED.validators.number()
            },
            longitude: {
                value: 0.0,
                required: false,
                validate: RED.validators.number()
            },
            range: {
                value: "",
                required: false
            },
            maxdists: {
                value: 1,
                required: false,
                validate: RED.validators.number()
            },
            maxresults: {
                value: 100,
                required: false,
                validate: RED.validators.number()
            }
        },
        inputs:0,
        outputs:0,
        icon: "bridge.png",
        align:"right",


        label: function() {
           return this.name||"iot directory";

        },
  	    paletteLabel: "iot directory",


       

      
         /******* ON EDIT PREPARE  START ********/
        
        oneditprepare: function(){

		 	
        	openedTab="Device-based-search"; 
            $("#deviceTabButton").simulate("click");
             
            $("#target-wrapper").fadeIn("fast");
		if (window.node_input_map) {
		                window.node_input_map.invalidateSize(true);
		            };
		if (window.node_input_map_2) {
		                window.node_input_map_2.invalidateSize(true);
		            };
        
    		 
             map = L.map('node-input-map').setView([45.4858914, 9.202094], 10);
             L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
               attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
               }).addTo(map);
             window.node_input_map = map;
             
            
             
             map2 = L.map('node-input-map-tab2').setView([45.4858914, 9.202094], 10);
             L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
               attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
               }).addTo(map2);
             window.node_input_map_2 = map2;
        	
        blueIcon = L.icon({
                        iconUrl: 'data:image/svg+xml;utf-8, \
                                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" width="512px" height="512px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"><g><path d="M256,0C167.641,0,96,71.625,96,160c0,24.75,5.625,48.219,15.672,69.125C112.234,230.313,256,512,256,512l142.594-279.375   C409.719,210.844,416,186.156,416,160C416,71.625,344.375,0,256,0z M256,256c-53.016,0-96-43-96-96s42.984-96,96-96   c53,0,96,43,96,96S309,256,256,256z" fill="#006DF0"/></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>',
                        iconSize:     [38, 95], // size of the icon
                        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
                    });
            //from https://www.flaticon.com/free-icon/map-marker_33622#
        redIcon = L.icon({
                        iconUrl: 'data:image/svg+xml;utf-8, \
                                  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" width="512px" height="512px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve"><g><path d="M256,0C167.641,0,96,71.625,96,160c0,24.75,5.625,48.219,15.672,69.125C112.234,230.313,256,512,256,512l142.594-279.375   C409.719,210.844,416,186.156,416,160C416,71.625,344.375,0,256,0z M256,256c-53.016,0-96-43-96-96s42.984-96,96-96   c53,0,96,43,96,96S309,256,256,256z" fill="#D80027"/></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>',
                        iconSize:     [38, 95], // size of the icon
                        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
                    });
        	
        	function drawMap(){
			 node = this;
            

            var mapLayers = {};

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            var editControl = new L.Control.Draw({
                draw: false,
                edit: {
                    remove: false,
                    featureGroup: drawnItems,
                    poly: {
                        allowIntersection: false
                    }
                }
            });
            map.addControl(editControl);
            
          

            drawControl = new L.Control.Draw({
                remove: false,
                draw: {
                    position: 'topleft',
                    //polyline: false,
                    //marker: false,
                    circlemarker: false,
                    //polygon: false,
                    rectangle: false,
                    polygon: {
                        allowIntersection: false,
                        showArea: true
                    }
                }
            });
            map.addControl(drawControl);

            L.control.layers(mapLayers, {
                'drawlayer': drawnItems
            }, {
                collapsed: true
            }).addTo(map);

            map.on(L.Draw.Event.CREATED, function(e) {
                var fence = e.layer;
                fence.nodeID = node.id;
                if (drawnItems.hasLayer(fence) == false) {
                    drawnItems.addLayer(fence);
                }

                drawControl.remove();
                TYPE = e.layerType,
                layer = e.layer;
                
                var resultsOut=drawSelection(layer, drawnItems, TYPE, allDataOut);
                
                var el;
				$("#node-input-nodes-target-container li input").prop('checked', false);
				$("#node-input-nodes-target-container li").hide();
				for(i=0;i<resultsOut.length;i++){
					el =  $("#node-input-nodes-target-container li input#node-input-target-node-"+resultsOut[i]);
					//console.log(el);
					el.parent().parent().show();
					el.prop('checked', true);

					}

               
            });

            map.on('draw:edited', function(e) {
                var fences = e.layers;
                fences.eachLayer(function(fence) {
                    fence.shape = "geofence";
                    if (drawnItems.hasLayer(fence) == false) {
                        drawnItems.addLayer(fence);
                    }
                });


                drawnItems.eachLayer(function(layer) {
                    var resultsOut=drawSelection(layer,drawnItems, TYPE, allDataOut);
                    var el;
                    $("#node-input-nodes-target-container li input").prop('checked', false);
                    $("#node-input-nodes-target-container li").hide();
                    for(i=0;i<resultsOut.length;i++){
                        el =  $("#node-input-nodes-target-container li input#node-input-target-node-"+resultsOut[i]);
                        //console.log(el);
                        el.parent().parent().show();
                        el.prop('checked', true);

                        }
                });


				
				
            });

          /*  map.on('draw:deleted', function(e) {
                drawControl.addTo(map);
                
                $("#node-input-nodes-target-container li").each(function(){
                    $(this).find("input").prop('checked', false);
                    $(this).show();
                    });
            });*/
                
              L.Control.RemoveAll = L.Control.extend(
                    {
                        options:
                        {
                            position: 'topleft',
                        },
                        onAdd: function (map) {
                            var controlDiv = L.DomUtil.create('div', 'leaflet-draw-toolbar leaflet-bar');
                            L.DomEvent
                                .addListener(controlDiv, 'click', L.DomEvent.stopPropagation)
                                .addListener(controlDiv, 'click', L.DomEvent.preventDefault)
                            .addListener(controlDiv, 'click', function () {
                                drawnItems.clearLayers();
                                 
                                    drawControl.addTo(map);
                
                                    $("#node-input-nodes-target-container li").each(function(){
                                        $(this).find("input").prop('checked', false);
                                        $(this).show();
                                        });    
                            });

                            var controlUI = L.DomUtil.create('a', 'leaflet-draw-edit-remove', controlDiv);
                            controlUI.title = 'Delete';
                            controlUI.href = '#';
                            return controlDiv;
                        }
                    });
                var removeAllControl = new L.Control.RemoveAll();
                map.addControl(removeAllControl);  
			
		
    
			}
        	
    function drawSelection(layer, drItems, type, data){
                 
                var results=[]; 
                switch(type){
                 
                    case 'circle':
                
		                var circles = {};
		
		                drItems.eachLayer(function(layer) {
		                    circles = layer.toGeoJSON();
		                    circles.properties.radius = Math.round(layer.getRadius()) / 1000;
		                });
		
						var lat_map = (circles.geometry.coordinates[1]);
						var long_map = (circles.geometry.coordinates[0]);
						var center_latlong = new L.LatLng(lat_map, long_map);
						var rad_map = (circles.properties.radius);
						
						
						for (var sensorTocheck in data){
							
							
							var sensorLatLng = new L.LatLng(Number(data[sensorTocheck]["latitude"]), Number(data[sensorTocheck]["longitude"]));
												
							
							if(Math.abs(center_latlong.distanceTo(sensorLatLng)/1000) <= rad_map){
								
								results.push(sensorTocheck);
							
								}
						}
						break;
				
							                                        
                        
			         case 'polygon':
                        
                            var polyPoints = layer._latlngs[0]
                            for (var sensorTocheck in data){

                                //Ray Casting algorithm for checking if a point lies inside of a polygon
                                var x = Number(data[sensorTocheck]["latitude"]), y= Number(data[sensorTocheck]["longitude"]);

                                var inside = false;
                                for (var i = 0, j = polyPoints.length - 1; i < polyPoints.length; j = i++) {
                                    var xi = polyPoints[i].lat, yi = polyPoints[i].lng;
                                    var xj = polyPoints[j].lat, yj = polyPoints[j].lng;

                                    var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                                    if (intersect) {
                                        inside = !inside;
                                    }
                                }

                                if(inside){

                                    results.push(sensorTocheck);

                                    }
                            }
                        break;
                        
                    case 'marker': 				
			  
                        var markerPoint = layer.getLatLng();
                        for (var sensorTocheck in data){

                                var sensorLatLng = new L.LatLng(Number(data[sensorTocheck]["latitude"]), Number(data[sensorTocheck]["longitude"]));

                                if(Math.abs(markerPoint.distanceTo(sensorLatLng)/1000) <= 5){ //5 km 

                                    results.push(sensorTocheck);

                                    }
                            }
                        break;
          		
          	
                
                    case 'polyline':
					
                        var polyVerts = layer._latlngs;
                        for (var sensorTocheck in data){

                                isclose=false;

                                var sensorLatLng = new L.LatLng(Number(data[sensorTocheck]["latitude"]), Number(data[sensorTocheck]["longitude"]));

                                for (var vi=0, vl=polyVerts.length; vi<vl; vi++) {
                                    var d = polyVerts[vi].distanceTo(sensorLatLng);
                                    if (d/1000 <= 5) {
                                        isclose= true;
                                        break;
                                    }
                                }

                                if (isclose){
                                    results.push(sensorTocheck);
                                }
                            }
          	  
          	
                
                }
                
                return results;
            }
        	
        
        	
    function drawMap2(){
    			node2 = this;
                
    			
    			var mapLayers = {};

                drawnItems2 = new L.FeatureGroup();
                map2.addLayer(drawnItems2);

                var editControl2 = new L.Control.Draw({
                    draw: false,
                    edit: {
                        remove: false,
                        featureGroup: drawnItems2,
                        poly: {
                            allowIntersection: false
                        }
                    }
                });
                map2.addControl(editControl2);

                drawControl2 = new L.Control.Draw({
                    remove: false,
                    draw: {
                        position: 'topleft',
                        //polyline: false,
                        //marker: false,
                        circlemarker: false,
                       //polygon: false,
                        rectangle: false,
                        polygon: {
                            allowIntersection: false,
                            showArea: true
                        }
                		
                    }
                });
                map2.addControl(drawControl2);

                L.control.layers(mapLayers, {
                    'drawlayer': drawnItems2
                }, {
                    collapsed: true
                }).addTo(map2);
                
               

    			
                map2.on(L.Draw.Event.CREATED, function(e) {
                    var fence = e.layer;
                    fence.nodeID = node2.id;
                    if (drawnItems2.hasLayer(fence) == false) {
                        drawnItems2.addLayer(fence);
                    }

                    drawControl2.remove();
                    
                    TYPE2 = e.layerType,
                    layer = e.layer;
                    
                    var resultsOut2=drawSelection(layer, drawnItems2, TYPE2, allDataOut2);
                    
                	
                	var el;
    				$("#node-input-nodes-target-container-tab2 li input").prop('checked', false);
    				$("#node-input-nodes-target-container-tab2 li").hide();
    				
    				for(i=0;i<resultsOut2.length;i++){
    					el =  $("#node-input-nodes-target-container-tab2 li input#node-input-target-node-tab2"+resultsOut2[i]);
    					el.parent().parent().show();
    					el.prop('checked', true);

    					}
                });

                map2.on('draw:edited', function(e) {
                    var fences = e.layers;
                    fences.eachLayer(function(fence) {
                        fence.shape = "geofence";
                        if (drawnItems2.hasLayer(fence) == false) {
                            drawnItems2.addLayer(fence);
                        }
                    });


                    drawnItems2.eachLayer(function(layer) {
                        var resultsOut2=drawSelection(layer, drawnItems2, TYPE2, allDataOut2);
                        var el;
                        $("#node-input-nodes-target-container-tab2 li input").prop('checked', false);
                        $("#node-input-nodes-target-container-tab2 li").hide();

                        for(i=0;i<resultsOut2.length;i++){
                            el =  $("#node-input-nodes-target-container-tab2 li input#node-input-target-node-tab2"+resultsOut2[i]);
                            el.parent().parent().show();
                            el.prop('checked', true);

                            }
                    });

    				
                });

               /* map2.on('draw:deleted', function(e) {
                    drawControl2.addTo(map2);
                    
                    $("#node-input-nodes-target-container-tab2 li").each(function(){
                        $(this).find("input").prop('checked', false);
                        $(this).show();
                        });
                });
    			*/
        
                 L.Control.RemoveAll = L.Control.extend(
                    {
                        options:
                        {
                            position: 'topleft',
                        },
                        onAdd: function (map) {
                            var controlDiv = L.DomUtil.create('div', 'leaflet-draw-toolbar leaflet-bar');
                            L.DomEvent
                                .addListener(controlDiv, 'click', L.DomEvent.stopPropagation)
                                .addListener(controlDiv, 'click', L.DomEvent.preventDefault)
                            .addListener(controlDiv, 'click', function () {
                                drawnItems2.clearLayers();
                                 
                                    drawControl2.addTo(map2);
                    
                                    $("#node-input-nodes-target-container-tab2 li").each(function(){
                                        $(this).find("input").prop('checked', false);
                                        $(this).show();
                                        });     
                            });

                            var controlUI = L.DomUtil.create('a', 'leaflet-draw-edit-remove', controlDiv);
                            controlUI.title = 'Delete';
                            controlUI.href = '#';
                            return controlDiv;
                        }
                    });
                var removeAllControl = new L.Control.RemoveAll();
                map2.addControl(removeAllControl);  
        
                
    		
        
    			}

	    	 /******* PANNELLO  RETRIEVE   START ********/
	    	 function  createRetrievePanel(){


	    	 	   var types = getDistinctValues(node.configData,"entityType");
                   addSelectData('node-input-type-select',types);
			       var kinds = getDistinctValues(node.configData,"kind");
			       addSelectData('node-input-kind-select',kinds);
			       var contextBrokers = getDistinctValues(node.configData,"contextBroker");
			       addSelectData('node-input-context-broker-select',contextBrokers);
				   var maps = getDistinctValues(node.configData,"map");
			       addSelectData('node-input-map-select',maps);
			 }
	    	 
	    	 function  createRetrievePanel2(){
	    	 	 console.log("here, and configdata is");  
	    	 	console.log(node2.configData);
	    		 var types = getDistinctValues(allDataOut2,"value_type");
	    	 	  addSelectDataTab2('node-input-value-type-select-tab2',types);
	    	 	  var names = getDistinctValues(node2.configData,"value_name");
			       addSelectDataTab2('node-input-value-name-select-tab2',names);
			       var contextBrokers = getDistinctValues(node2.configData,"cb");
			       addSelectDataTab2('node-input-context-broker-select-tab2',contextBrokers);
			       var editables = getDistinctValues(node2.configData,"editable");
			       addSelectDataTab2('node-input-editable-select-tab2',editables);
			       var healthiness = getDistinctValues(node2.configData,"healthiness_criteria");
			       addSelectDataTab2('node-input-healthiness-select-tab2',healthiness);
				    var maps = getDistinctValues(node2.configData,"map2");
				    addSelectDataTab2('node-input-map-select-tab2',maps);
			 } 



    		function  onChangeRetrieveSelect(){


    			//$("#node-input-nodes-target-container li input").prop('checked', false);
    			$("#node-input-nodes-target-container li").hide();

    			var selTypes =  $("#node-input-type-select :selected").map(function(i, el) {
					    return $(el).val();
					});
    			
				var selKind=  $("#node-input-kind-select :selected").val();

    			var selBrokers =  $("#node-input-context-broker-select :selected").map(function(i, el) {
					    return $(el).val();
					});

    			var hasType,hasKind,hasBroker;
    			
    			$("#node-input-nodes-target-container li").each(function(){

    				 
    				hasType=false;
					if(selTypes.length==0  || $.inArray("all", selTypes)>=0  ||  $.inArray($(this).data("type"), selTypes)>=0){
  						hasType = true;
					}

					console.log(selTypes);
					console.log($.inArray("all", selTypes>=0 ));



					hasKind=false;
					if(selKind=="all"||  $(this).data("kind") == selKind ){
  						hasKind = true;
					}

					hasBroker=false;
					if(selBrokers.length==0 || $.inArray("all", selBrokers) >=0   ||  $.inArray($(this).data("context-broker"), selBrokers)>=0){
  						hasBroker = true;
					}
                    

					console.log("hasType"+hasType);
					console.log("hasKind"+hasKind);
					console.log("hasBroker"+hasBroker);

					if(hasType && hasKind && hasBroker){
							$(this).show();
							//$(this).find("input").prop('checked', true);
					}



    				
    			})

    		}
    		
function  onChangeRetrieveSelect2(){
        		
    			//$("#node-input-nodes-target-container li input").prop('checked', false);
    			$("#node-input-nodes-target-container-tab2 li").hide();
    			var selTypes =  $("#node-input-value-type-select-tab2 :selected").map(function(i, el) {
					    return $(el).val();
					});
    			
				var selNames=  $("#node-input-value-name-select-tab2 :selected").val();

    			var selBrokers =  $("#node-input-context-broker-select-tab2 :selected").map(function(i, el) {
					    return $(el).val();
					});
    			
    			var selEditables = ""+ $("#node-input-editable-select-tab2 :selected").val();

    			var selHealthiness =  $("#node-input-healthiness-select-tab2 :selected").map(function(i, el) {
				    return $(el).val();
				});

    			var hasType,hasName,hasBroker, hasEditable, hasHealthiness;
    			
    			$("#node-input-nodes-target-container-tab2 li").each(function(){

    				 
    				hasType=false;
					if(selTypes.length==0  || $.inArray("all", selTypes)>=0  ||  $.inArray($(this).data("type"), selTypes)>=0){
  						hasType = true;
					}

					hasName=false;
					if(selNames=="all"||  $(this).data("name") == selNames ){
						hasName = true;
					}

					hasBroker=false;
					if(selBrokers.length==0 || $.inArray("all", selBrokers) >=0   ||  $.inArray($(this).data("context-broker"), selBrokers)>=0){
  						hasBroker = true;
					}
					hasEditable=false;
					if(selEditables=="all" || $(this).data("editable")==selEditables){
						hasEditable = true;
					}
					
					hasHealthiness=false;
					if(selHealthiness.length==0 || $.inArray("all", selHealthiness) >=0   ||  $.inArray($(this).data("healthiness"), selHealthiness)>=0){
						hasHealthiness = true;
					}
                   

					if(hasType && hasName && hasBroker && hasHealthiness && hasEditable){
							$(this).show();
							//$(this).find("input").prop('checked', true);
					}



    				
    			})

    		}
    		
    		
    		


			function addSelectData(selectId, data){
				data  = data.sort();
				$('#'+selectId).html("");
				$('#'+selectId).append($('<option>', { value : "all" })
					          .text("all"));

			    $.each(data, function(key, value) {
					     $('#'+selectId)
					          .append($('<option>', { value : value })
					          .text(value));
					});

				$('#'+selectId).change(function(){
					 onChangeRetrieveSelect();
					  onTextSearch();
				})
                    

			}
			
			function addSelectDataTab2(selectId, data){
				data  = data.sort();
				$('#'+selectId).html("");
				$('#'+selectId).append($('<option>', { value : "all" })
					          .text("all"));

			    $.each(data, function(key, value) {
					     $('#'+selectId)
					          .append($('<option>', { value : value })
					          .text(value));
					});

				$('#'+selectId).change(function(){
					 onChangeRetrieveSelect2();
					 onTextSearch2Tab2();
				});
                    

			}


			 function getDistinctValues(dataObj, matchKey)
			 {
			 	var ar = [];
			 	var val;

			 	for(key in dataObj) {
			 		val = dataObj[key][matchKey];
			 		console.log($.inArray(ar,val));
			 		if(val!=undefined  && val!="" && $.inArray(val,ar)<0 ){ //&& dataObj[key]["kind"] == "actuator"){

			 			ar.push(val);
			 		}
			 	}

			 	return ar;

			 }
			  /*********
             desc:
             filtra i sensori nel pannello di configurazione nascondendo quelli che non cominciano col testo inserito nella text box

             **********/
			function onTextSearch(){
			toMatch = $("#node-input-text-search").val().toLowerCase();
			var sensorId;
			if(toMatch=="") return;
			$("#node-input-nodes-target-container li").each(function(){
            		sensorId = $(this).find(".node-input-target-node-label").html().toLowerCase();
            		if(!sensorId.startsWith(toMatch)){
            				$(this).hide();
            		}
            })
			}
		function onTextSearch2(){
			toMatch = $("#node-input-text-search2").val().toLowerCase();
			var sensorId;
			if(toMatch=="") return;
			$("#node-input-nodes-target-container li").each(function(){
            		sensorId = $(this).find(".node-input-target-node-label").html().toLowerCase();
            		if(!sensorId.startsWith(toMatch)){
            				$(this).hide();
            		}
            })

			}
		
		function onTextSearch2Tab2(){
			toMatch = $("#node-input-text-search2-tab2").val().toLowerCase();
			var sensorId;
			if(toMatch=="")return;
			
			$("#node-input-nodes-target-container-tab2 li").each(function(){
            		sensorId = $(this).find(".node-input-target-node-label-tab2").html().toLowerCase();
            		$("#node-input-text-search2").val(sensorId);
            		if(!sensorId.startsWith(toMatch)){
            				$(this).hide();
            		}
            });

			}
		     /******* PANNELLO  RETRIEVE FUNCTIONS  END  ********/


		      /******* PANNELLO  SENSORS  START  ********/
			 function createNodeList() {
			 	 console.log("create node list");
			 	 var data = node.configData;
			 	 console.log(node.configData);
			 	  console.log("create node list 2");
			     var isChecked = false;
			     nodeList.empty();
			     for(key in data) {
			     	var container = $('<li/>',{class:"node-input-target-node"});
			     	container.attr('data-type', data[key]["entityType"]);
			     	container.attr('data-kind', data[key]["kind"]);
			     	container.attr('data-context-broker', data[key]["contextBroker"]);

			     	//solo per  iot out metti solo  attuatori

			     //	if(data[key]["kind"]=="actuator"){
				     	var row = $('<label/>',{for:"node-input-target-node-"+key}).appendTo(container);
				     	$('<input>',{type:"checkbox",class:"node-input-target-node-checkbox",id:"node-input-target-node-"+key})
		                        .data('node-id',key)
		                        .prop('checked', isChecked)
		                        .appendTo(row);

				     	var labelSpan = $('<span>');
		                var label = key;
		                var sublabel = data[key]["contextBroker"];
		                var sublabel2= data[key]["entityType"];


		                $('<span>',{class:"node-input-target-node-label",style:"white-space:nowrap"}).text(label).appendTo(row);
		                if (sublabel) {
		                	$('<span>',{class:"node-input-target-node-sublabel"}).text(sublabel).appendTo(row);
		                }
		                if (sublabel2) {
		                	$('<span>',{class:"node-input-target-node-sublabel2"}).text(sublabel2).appendTo(row);
		                }

		                container.appendTo(nodeList);
		     //       }
			     }

			 }
		     
			 function createNodeList2() {
				 console.log("create node list");
			 	 var data = node2.configData;
			     var isChecked = false;
			     nodeList2.empty();
			     for(key in data) {
			     	var container = $('<li/>',{class:"node-input-target-node-tab2"});
			     	container.attr('data-device', data[key]["device"]);
			     	container.attr('data-type', data[key]["value_type"]);
			     	container.attr('data-name', data[key]["value_name"]);
			     	container.attr('data-context-broker', data[key]["cb"]);
			     	container.attr('data-editable', data[key]["editable"]);
			     	container.attr('data-healthiness', data[key]["healthiness_criteria"]);
			     	

			     	var row = $('<label/>',{for:"node-input-target-node-tab2"+key}).appendTo(container);
			     	$('<input>',{type:"checkbox",class:"node-input-target-node-checkbox-tab2",id:"node-input-target-node-tab2"+key})
	                        .data('node-id',key)
	                        .prop('checked', isChecked)
	                        .appendTo(row);

			     	var labelSpan = $('<span>');
	                var label = data[key]["value_type"];
	                var sublabel = data[key]["cb"];
	                var sublabel2= data[key]["device"];
	         //       var sublabel3 = data[key]["value_name"];


	                $('<span>',{class:"node-input-target-node-label-tab2",style:"white-space:nowrap"}).text(label).appendTo(row);
	                if (sublabel) {
	                	$('<span>',{class:"node-input-target-node-sublabel-tab2"}).text(sublabel).appendTo(row);
	                }
	                if (sublabel2) {
	                	$('<span>',{class:"node-input-target-node-sublabel2-tab2"}).text(sublabel2).appendTo(row);
	                }
	        //        if (sublabel3) {
	          //      	$('<span>',{class:"node-input-target-node-sublabel3-tab2"}).text(sublabel3).appendTo(row);
	          //      }

	                container.appendTo(nodeList2);
			     }

			 }


			function sortNodeList(sortOn) {
                var currentSort = nodeList.data('currentSort');
                var currentSortOrder = nodeList.data('currentSortOrder');

                if (!currentSort) {
                    currentSort = sortOn;
                    currentSortOrder = 'a';
                } else {
                    if (currentSort === sortOn) {
                        currentSortOrder = (currentSortOrder === 'a'?'d':'a');
                    } else {
                        currentSortOrder = 'a';
                    }
                    currentSort = sortOn;
                }
                nodeList.data('currentSort',currentSort);
                nodeList.data('currentSortOrder',currentSortOrder);

                $("#node-input-status-target-container-div .fa").hide();
                $(".node-input-status-sort-"+currentSort+"-"+currentSortOrder).show();


                var items = nodeList.find("li").get();
                items.sort(function(a,b) {
                    var labelA = $(a).find(".node-input-target-node-"+currentSort).text().toLowerCase();
                    var labelB = $(b).find(".node-input-target-node-"+currentSort).text().toLowerCase();
                    if (labelA < labelB) { return currentSortOrder==='a'?-1:1; }
                    if (labelA > labelB) { return currentSortOrder==='a'?1:-1; }
                    return 0;
                });
                $.each(items, function(i, li) {
                    nodeList.append(li);
                });
            }
			
			function sortNodeListTab2(sortOn) {
                var currentSort = nodeList2.data('currentSort');
                var currentSortOrder = nodeList2.data('currentSortOrder');

                if (!currentSort) {
                    currentSort = sortOn;
                    currentSortOrder = 'a';
                } else {
                    if (currentSort === sortOn) {
                        currentSortOrder = (currentSortOrder === 'a'?'d':'a');
                    } else { 
                        currentSortOrder = 'a';
                    }
                    currentSort = sortOn;
                }
                nodeList2.data('currentSort',currentSort);
                nodeList2.data('currentSortOrder',currentSortOrder);

                $("#node-input-status-target-container-div .fa").hide();
                $(".node-input-status-sort-"+currentSort+"-"+currentSortOrder).show();


                var items = nodeList2.find("li").get();
                items.sort(function(a,b) {
                    var labelA = $(a).find(".node-input-target-node-"+currentSort).text().toLowerCase();
                    var labelB = $(b).find(".node-input-target-node-"+currentSort).text().toLowerCase();
                    if (labelA < labelB) { return currentSortOrder==='a'?-1:1; }
                    if (labelA > labelB) { return currentSortOrder==='a'?1:-1; }
                    return 0;
                });
                $.each(items, function(i, li) {
                    nodeList2.append(li);
                });
            }
            
        
    
        


            $("#node-input-target-sort-label").click(function(e) {
                e.preventDefault();
                sortNodeList('label');
            });

            $("#node-input-target-sort-type").click(function(e) {
                e.preventDefault();
                sortNodeList('sublabel');
            });
            
            $("#node-input-target-sort-label2").click(function(e) {
                e.preventDefault();
                sortNodeList('sublabel2');
            });
            
/*---------------*/
            
            $("#node-input-target-sort-label-tab2").click(function(e) {
                e.preventDefault();
                sortNodeListTab2('label-tab2');
            });

            $("#node-input-target-sort-device-tab2").click(function(e) {
                e.preventDefault();
                sortNodeListTab2('sublabel2-tab2');
            });
            $("#node-input-target-sort-name-tab2").click(function(e) {
                e.preventDefault();
                sortNodeListTab2('sublabel3-tab2');
            });
            
            $("#node-input-target-sort-type-tab2").click(function(e) {
                e.preventDefault();
                sortNodeListTab2('sublabel-tab2');
            });
            
            
            $("#node-input-target-node-checkbox-all").change(function() {
                $(".node-input-target-node-checkbox:visible").prop('checked',this.checked);
            });
            
            $("#node-input-target-node-checkbox-all-tab2").change(function() {
                $(".node-input-target-node-checkbox-tab2:visible").prop('checked',this.checked);
            });
            
            
 			       /*********
				  definizione  evento keyup per la ricerca testuale
             **********/
            $("#node-input-text-search").keyup(function() {
            onChangeRetrieveSelect();
            onTextSearch();
            });
            $("#node-input-text-search2").keyup(function() {
            onChangeRetrieveSelect();
            onTextSearch2();
            });
            
            $("#node-input-text-search2-tab2").keyup(function() {
				onChangeRetrieveSelect2();
	            onTextSearch2Tab2();
	            });


 			/******* PANNELLO  SENSORS END *****/



 			/******* SELECT  SENSORS START  *****/
 			
			   $("#node-input-kind-of-search-select").change(function() {
            	//$("#node-input-nodes-target-container li input").prop('checked', false);
            	
                if($(this).val()=="retrieve") // parametric search - retrieve
	                {
	                	console.log("retrieve");
	                	$("#retrieve-wrapper").fadeIn("fast");
	                	$("#target-wrapper").fadeOut("fast");
						$("#retrieve-selected").fadeOut("fast");
						$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeOut("fast");
	                }

	                else if($(this).val()=="map") // map search - target
	                {
	                	

	                	$("#target-wrapper").fadeIn("fast");
						$("#retrieve-selected").fadeOut("fast");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeOut("fast");
						if (window.node_input_map) {
	                window.node_input_map.invalidateSize(true);
	            };
						
	                }
	                
	               /* else if($(this).val()=="map_marker") // map search - target
	                {
	                	

	                	$("#target-wrapper").fadeIn("fast");
						$("#retrieve-selected").fadeOut("fast");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#marker-wrapper").fadeIn("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeOut("fast");
						if (window.node_input_map) {
	                window.node_input_map.invalidateSize(true);
	            };
						
	                }
	                
	                else if($(this).val()=="map_path") // map search - target
	                {
	                	

	                	$("#target-wrapper").fadeIn("fast");
						$("#retrieve-selected").fadeOut("fast");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeIn("fast");
						$("#polygon-wrapper").fadeOut("fast");
						if (window.node_input_map) {
	                window.node_input_map.invalidateSize(true);
	            };
						
	                }
	                
	                else if($(this).val()=="map_polygon") // map search - target
	                {
	                	

	                	$("#target-wrapper").fadeIn("fast");
						$("#retrieve-selected").fadeOut("fast");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeIn("fast");
						if (window.node_input_map) {
	                window.node_input_map.invalidateSize(true);
	            };
						
	                }

	                else // specific devices - selected
	                {
	                	console.log("selected");
	                	$("#retrieve-wrapper").fadeOut("fast");
	                	$("#target-wrapper").fadeOut("fast");
						$("#retrieve-selected").fadeIn("fast");
						$("#marker-wrapper").fadeOut("fast");
						$("#path-wrapper").fadeOut("fast");
						$("#polygon-wrapper").fadeOut("fast");
	                	$("#node-input-nodes-target-container li").each(function(){
	                	 	$(this).show();
	                	})
	                }*/
                   
                   

            });
 			
			   $("#node-input-kind-of-search-select-tab2").change(function() {
	            	//$("#node-input-nodes-target-container li input").prop('checked', false);
	            	
	                if($(this).val()=="retrieve") // parametric search - retrieve
		                {
		                	console.log("retrieve");
		                	$("#retrieve-wrapper-tab2").fadeIn("fast");
		                	$("#target-wrapper-tab2").fadeOut("fast");
		                }

		                else if($(this).val()=="map") // map search - target
		                {

		                	$("#target-wrapper-tab2").fadeIn("fast");
		                	$("#retrieve-wrapper-tab2").fadeOut("fast");
							if (window.node_input_map_2) {
		                window.node_input_map_2.invalidateSize(true);
		            };
							
		                }
		                
                  

	            });

            /******* SELECT  SENSORS END  *****/
           


			 
			var nodeList = $("#node-input-nodes-target-container");
			var node = this;
			
			var nodeList2 = $("#node-input-nodes-target-container-tab2");
			var node2 = this;
			
			
			//var jqxhr = $.getJSON( "http://localhost:3001/api/get-config-data", function(data) {
         	//var jqxhr = $.getJSON( "http://iot-app.snap4city.org/iotdirectory/api/get-config-data", function(data) {
			//var jqxhr = $.getJSON( "http://159.149.129.184:3001/api/get-config-data", function(data) {
			//var jqxhr = $.getJSON( "https://iotdirectory.snap4city.org/management/get_data.php?action=get-config-data", function(data) {
            
            var accesstokenOut="";
            try{
               console.log("in retrieving access token");
                console.log("this.id "+ this.id);
                
                var accesstokenOut= "";
                        $.ajax({
                            url: "deviceregistration/"+this.id,
                            type:"GET",
                            async: false,
                            success: function(resp) {
                                console.log(resp);
                                //accesstoken = resp.accessToken;
                                accesstokenOut = resp.refreshToken;
                                
                                var url= "https://iotdirectory.snap4city.org/api/device.php?action=get_config_data&nodered=yes&token="+accesstokenOut;
                                console.log("url");
                                console.log(url);
                                
                                var jqxhr = $.getJSON( url, function(data) {
                                  console.log( "success" );
                                  console.log( data );
                                })
                                  .done(function(data) {
                                    console.log( "second success" );
                                      if(data.status=="ok"){

                                        data=data.content;
                                          allDataOut=data;   
                                        // crea lista entiti principale
                                           node.configData = data;
                                           createNodeList();
                                           //crea dati per le select
                                           createRetrievePanel();
                                           // crea map
                                           drawMap();

                                           var marker_array=[];
                                            for(var k in data){

                                                lat=Number(data[k]["latitude"]); //45.4858914;
                                                 est_lat= lat+(Math.random() * (0.000700 - 0.000010) + 0.000010);
                                                 lng= Number(data[k]["longitude"]);//9.202094;
                                                 est_lng= lng+(Math.random() * (0.000700 - 0.000010) + 0.000010);
                                                    popup= "<b>"+data[k]['name']+"</b><br>"+data[k]['entityType']+ "<br>"+data[k]['kind']; 
                                                    if(data[k]["visibility"]=="public"){

                                                       m = L.marker([est_lat, est_lng],{icon: blueIcon}).bindPopup(popup);
                                                    }
                                                    else{
                                                        m = L.marker([est_lat, est_lng], {icon: redIcon}).bindPopup(popup);
                                                    }
                                            marker_array.push(m);
                                         }

                                            var markersGroup = L.layerGroup(marker_array);
                                            markersGroup.addTo(map);

                                          }
                                      else{
                                          console.log( data.status );
                                      }

                                  })
                                  .fail(function() {
                                    console.log( "error" );
                                  })
                                  .always(function() {
                                    console.log( "complete" );
                                  });
                                
                                
                                var url_values="https://iotdirectory.snap4city.org/api/device.php?action=get_config_data_values&nodered=yes&token="+accesstokenOut;
                                
                                var jqxhrValues = $.getJSON( url_values,                            
                                    function(data) {
                                          console.log( "success" );
                                          console.log( data );
                                        })
                                          .done(function(data) {
                                            if(data.status=="ok"){
                                                  console.log( "second success" );


                                                data=data.content;
                                                allDataOut2=data;

                                                   // crea lista entiti principale
                                                   node2.configData = data;
                                                   createNodeList2();
                                                   //crea dati per le select
                                                   createRetrievePanel2();
                                                   // crea map
                                                    drawMap2();

                                                    var marker_array=[];
                                                    for(var k in data){

                                                        lat=Number(data[k]["latitude"]); //45.4858914;
                                                         est_lat= lat+(Math.random() * (0.000700 - 0.000010) + 0.000010);
                                                         lng= Number(data[k]["longitude"]);//9.202094;
                                                         est_lng= lng+(Math.random() * (0.000700 - 0.000010) + 0.000010);
                                                        popup= "<b>"+data[k]['device']+"</b><br>"+data[k]['value_type']; 
                                                                if(data[k]["visibility"]=="private"){

                                                                   m = L.marker([est_lat, est_lng],{icon: redIcon}).bindPopup(popup);
                                                                }
                                                                else{
                                                                    m = L.marker([est_lat, est_lng], {icon: blueIcon}).bindPopup(popup);
                                                                }

                                                    marker_array.push(m);
                                                 }

                                                    var markersGroup = L.layerGroup(marker_array);
                                                    markersGroup.addTo(map2);

                                            }


                                          })
                                          .fail(function() {
                                            console.log( "error" );
                                          })
                                          .always(function() {
                                            console.log( "complete" );
                                          });
            }
                        });
                
            }
            catch(err){
                console.log("error creating the token "+ err);
                accesstokenOut="";
            }
           
            
            
            
            
	
		     
  		    /******* ON EDIT PREPARE  END********/

			 
			 
	
		},

		oneditresize: function() {
            if (window.node_input_map) {
                window.node_input_map.invalidateSize(true);
            }
        },
		
        oneditsave: function() {

			/*** ON EDIT SAVE START  ***/


        	console.log("edit save");

        	var configData;
        	var sensors =[];
			idValueArray=[]; //array of ["device_id",[array of "values"] ] used in case of value based search, remain empty in device based search	
        	if(openedTab=="Device-based-search"){
        		configData = allDataOut; //= this.configData;
        		sensors =[];
        		$(".node-input-target-node-checkbox").each(function(n) {
                    if ($(this).prop("checked")   ) { //&& $(this).is(":visible")
                          sensors.push($(this).data('node-id'));
                       }
               });
        		console.log("configData is ");
           	 	console.log(configData);
           	 	
                var is_checked= $("#checkbox_aggr_out_device").prop("checked");
                console.log("is_checked "+is_checked);
                if(is_checked){
                    device_types=[];//for the aggregation according to the device type, it contains the unique types of selected devices

                    for (var i=0; i<sensors.length; i++){

                        var t= configData[sensors[i]]["entityType"];
                        if (device_types.length==0){
                        device_types.push(t);
                        }
                        else{
                            var exist=0;
                            for (var j=0; j<device_types.length; j++){
                                if (device_types[j]==t) {
                                    exist=1;
                                    break;
                                }
                            }
                            if(exist==0){
                                device_types.push(t);
                            }
                        }

                    }
                    console.log("device_types:");
                    console.log(device_types);
                    createFlow_agg_device(sensors, configData);
                }
                else{
           	        createFlow(sensors, configData);
                }
        	}
            
        	else{
        		configData = allDataOut2;
        		sensors =[];
        		
        		 $(".node-input-target-node-checkbox-tab2").each(function(n) {
                     if ($(this).prop("checked") ) {//&& $(this).is(":visible")
                        sensors.push($(this).data('node-id'));
                     }
             	});
             
     			if (sensors.length==0) return;
                
                value_types=[];//for the aggregation according to the value type, it contains the unique value types of selected devices
        		for (var i=0; i<sensors.length; i++){
                
                    var t= configData[sensors[i]]["value_type"];
                    if (value_types.length==0){
					   value_types.push(t);
					}
					else{
						var exist=0;
						for (var j=0; j<value_types.length; j++){
							if (value_types[j]==t) {
								exist=1;
								break;
							}
						}
						if(exist==0){
							value_types.push(t);
						}
					}
                
                }
     			
        		var uniqueDevices=[];
        		for (var i=0; i<sensors.length; i++){
        			
        			console.log("in for");
        			var id_s= configData[sensors[i]]["device"];
        			console.log("in for, id_s is "+ id_s);
        			
        			if (uniqueDevices.length==0){
					uniqueDevices.push(id_s);
					}
					else{
						var exist=0;
						for (var j=0; j<uniqueDevices.length; j++){
							if (uniqueDevices[j]==id_s) {
								exist=1;
								break;
							}
						}
						if(exist==0){
							uniqueDevices.push(id_s);
						}
					}
        			
        			var added=0;
					for (var j=0; j<idValueArray.length; j++){
					
						if ( idValueArray[j].id== configData[sensors[i]]["device"]){
							var vr= idValueArray[j].values;
							vr.push(configData[sensors[i]]["value_type"]);
							added=1;
							break;
						}
					}
					if(added==0){
						var z= {id: configData[sensors[i]]["device"], values:[configData[sensors[i]]["value_type"]]};
						idValueArray.push(z);
					}
        			
        			}
        		
        		console.log("uniqueDevices "+uniqueDevices);
                 var is_checked= $("#checkbox_aggr_out_value").prop("checked");
                console.log("is_checked "+is_checked);
                if(is_checked){
        		  createFlow_agg_value(uniqueDevices, configData);	
                }
                else{
                    createFlow(uniqueDevices, configData);
                }
        			
        		
        	}
        	
        	//console.log("configData is ");
       	 	//console.log(configData);





			   /*** array di sensori  selezionati da pannello di configurazione  ***/
             
            
             console.log("sensors are:")
             console.log(sensors);

               
    function createFlow(sensors, configData){
        	   /*** controllo iniziale se sono stati selzionati sensori  ***/
               
        	   configData=allDataOut;
        	   if(!sensors.length) return;



                      //numero id che servono
               var idAmount = sensors.length * 3 + 7;

               var jqxhr = $.getJSON( "get-id?n="+idAmount, function(data) {
   			  console.log( "success" );
   			  console.log( data );
   			})
   			  .done(function(data) {
   			    console.log( "second success..." );

   			 
    				console.log( data );



    				var offsetY =200;
                   var offsetYstep = 100;  
                   var middleY = offsetY + offsetYstep*(sensors.length-1)/2;

                 //flow id
    				var counter_id = 0;
   				var flow_id = data.ids[counter_id++]; //0
   				var debug_id = data.ids[counter_id++]; //1
   				var function_id = data.ids[counter_id++]; //2
   				var inject_id = data.ids[counter_id++] //3
                   var link_out_id = data.ids[counter_id++] //4
                   //curr flow
                   var link_in_id = data.ids[counter_id++] //5
                   var curr_flow_id = data.ids[counter_id++]; //6


   				


   				console.log("counterid="+counter_id);

   			    var newflow = [];


   			  //link in
                /*   newflow.push({
                       "id": link_in_id,
                       "type": "link in",
                       "z": curr_flow_id,
                       "name": "",
                       "links": [link_out_id],
                       "x": 200,
                       "y": 200,
                       "wires": [
                           []
                       ]
                   },),

                   //flow
                   newflow.push({
                       "id": flow_id,
                       "type": "tab",
                       "label": "Flow " + flow_id
                   }),


                   //link out
                   newflow.push(    {
                       "id": link_out_id,
                       "type": "link out",
                       "z": flow_id,
                       "name": "",
                       "links": [link_in_id],
                       "x": 1000,
                       "y": middleY,
                       "wires": []
                   })*/


   			    //debug
   			 /*   newflow.push({
   			    		"id": debug_id,
   						"type": "debug",
   						"z": flow_id,
   						"name": "",
   						"active": true,
   						"console": "false",
   						"complete": "false",
   						"x": 1000,
   						"y": middleY,
   						"wires": []
   						})*/

   		


   			    //sensori

   			    var addInjectNode=false;
      
                   var orion_ids=[];
                   var mosquitto_ids=[];
                   var rabbit_ids=[];
                   var sensor_ids=[];
   				var log_ids = [];				 
                   var protocol;

                   

                   for(var i=0;i<sensors.length;i++){
                   	console.log("orion--")
                   	console.log(configData[sensors[i]])
                   	try {
                   		protocol = configData[sensors[i]]["protocol"];
   							}
   					catch(err) {
      						 protocol="none";
   							}
                   	var conf_id = data.ids[counter_id++];
   					var log_id = data.ids[counter_id++];							 
                   	var node_id = data.ids[counter_id++];
                   	
					

                   	console.log(counter_id);
                   	//orion
                   	switch(protocol){
   			  	    	case "ngsi":
   	                		orion_ids.push(node_id);

                               /*
                                newflow.push({
                                   "id": conf_id,
                                   "type": "orion-service",
                                   "z": "",
                                   "name": configData[sensors[i]]["ip"]+":"+configData[sensors[i]]["port"],
                                   "url": configData[sensors[i]]["ip"],
                                   "port": configData[sensors[i]]["port"]
                                   })

                               newflow.push({
                                   "id": node_id,
                                   "type": "fiware orion in",
                                   "z": flow_id,
                                   "name": "",
                                   "service": conf_id,
                                   "throttle": "PT5S",
                                   "entype": configData[sensors[i]]["type"],
                                   "enid": sensors[i],
                                   "ispattern": false,
                                   "duration": "P1W",
                                   "attributes": "",
                                   "condvalues": "",
                                   "includeattr": true,
                                   "noderedhost": "",
                                   "noderedhostauto": true,
                                   "x": 400,
                                   "y": offsetY,
                                   "wires": [
                                       []
                                   ]
                                   })
                               */
                               /*

                               [{"id":"5e144820.fe4668","type":"fiware orion in","z":"78fd82f6.a1df4c","name":"","service":"71e5538a.8861bc","throttle":"PT5S","entype":"Temperature","enid":"ARDUINO_ST_4201","ispattern":false,"duration":"P1W","attributes":"","condvalues":"","includeattr":true,"noderedhost":"","noderedhostauto":true,"x":420,"y":440,"wires":[[]]},{"id":"71e5538a.8861bc","type":"orion-service","z":"","name":"159.149.129.184:1026","url":"159.149.129.184","port":"1026"}]
   	                        */
                               
                   	    	newflow.push({
   								"id": node_id,
   								"type": "http request",
   								"z": flow_id,
   								"name": sensors[i],
   								"method": "POST",
   								"ret": "txt",
   								"url": "http://"+configData[sensors[i]]["ip"]+":"+configData[sensors[i]]["port"]+"/v2/entities/"+sensors[i]+"/attrs/",
   								"tls": "",
   								"x": 800,
   								"y": offsetY,
   								"wires": [
   									[
   										link_out_id
   									]
   								]
   							
                               })


   						break;


                           //mosquitto
   						case "mqtt":
   							mosquitto_ids.push(node_id);
   	                	    newflow.push({
   								"id": conf_id,
   								"type": "mqtt-broker",
   								"z": "",
   								"broker": configData[sensors[i]]["ip"],
   								"port":  configData[sensors[i]]["port"],
   								"clientid": "",
   								"usetls": false,
   								"compatmode": true,
   								"keepalive": "60",
   								"cleansession": true,
   								"willTopic": "",
   								"willQos": "0",
   								"willRetain": "false",
   								"willPayload": "",
   								"birthTopic": "",
   								"birthQos": "0",
   								"birthRetain": "false",
   								"birthPayload": ""
   							})





   	                	     newflow.push({
   								"id": node_id,
   								"type": "mqtt out",
   								"z": flow_id,
   								"name": sensors[i],
   								"topic": sensors[i],
   								"qos": "2",
   								"retain": "",
   								"broker": conf_id,
   								"x": 800,
   								"y": offsetY,
   								"wires": [
   									[
   										link_out_id
   									]
   								]
   							})

   						break;

   	                	  //rabbit
   							  //	$("#node-input-ioname").val(rabbitNodes[rabbitCount]["sensorId"]);
   		  					   //  	$("#node-input-iotype").val(4);
   							case "amqp":
                        case "AMQP":
   								rabbit_ids.push(node_id);
   								newflow.push({
   									"id": conf_id,
   									"type": "amqp-server",
   									"z": "",
   									"host": configData[sensors[i]]["ip"],
   									"port": configData[sensors[i]]["port"],
   									"vhost": "",
   									"keepalive": "30",
   									"usetls": false,
   									"verifyservercert": true,
   									"usetopology": false,
   									"topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}"
   								})

   								newflow.push({
   									"id": node_id,
   									"type": "amqp out",
   									"z": flow_id,
   									"name": sensors[i],
   									"routingkey": "",
   									"iotype": "4",
   									"ioname": sensors[i],
   									"server": conf_id,
   									"x": 800,
   									"y": offsetY,
   									"wires": [
   										[
   	                                    link_out_id
   	                                    ]
   									]
   								})

   							break;

                   	}

                   	//eventlog
   					log_ids.push(log_id);
   					newflow.push({
   						"id": log_id,
   						"type": "event-log",
   						"z": flow_id,
   						"name": "",
   						"modcom": "RX",
   						"motivation": "IoT_Service",
   						"x": 600,
   						"y": offsetY,
   						"wires": [
   							[
   								node_id
   							],
   							[]
   						]
   					})
   					offsetY+=offsetYstep;

                   

                   }
                 //function
                   sensor_ids = orion_ids.concat(mosquitto_ids).concat(rabbit_ids);
				   
					var b="";
					
					
					if(idValueArray.length>1){
						for(var j=0;j<idValueArray.length; j++){
								b+='\n \/\/ please check and complete the following \r\n\/\/ attributes with the value arriving from \r\n\/\/ the payload\r\nvar attributes={};\n';
								
								for(var k=0; k<idValueArray[j].values.length; k++){
										b+='attributes["'+idValueArray[j].values[k]+'"]="val"; \/\/' +idValueArray[j].id+'\n';
									}
								
								b+='\n\n';
								try {
								pro = configData[idValueArray[j].id]["protocol"];
								}
								catch(err) {
									pro="none";
								}
								if(pro=="mqtt" || pro=="amqp"){
									b+= 'var js'+(j+1)+' = attributes;\n';
								}
								else{
									b+= 'var js'+(j+1)+' = {id:"'+idValueArray[j].id+'", type: "command", attributes};\n';
								}
								
							
								b+='var jsonstrg'+(j+1)+' = JSON.stringify(js'+(j+1)+');\n';
							}
						}
					else{
					
						for(var j=0;j<sensors.length;j++){
								b+='\n \/\/ please check and complete the following \r\n\/\/ attributes with the value arriving from \r\n\/\/ the payload\r\nvar attributes={};\n';

						
							try {
								pro = configData[sensors[j]]["protocol"];
   							}
							catch(err) {
								pro="none";
   							}
							if(pro=="mqtt" || pro=="amqp"){
									b+= 'var js'+(j+1)+' = attributes;\n';
								}
							else{
									b+= 'var js'+(j+1)+' = {id:"'+sensors[j]+'", type: "command", attributes};\n';
								}
							b+='var jsonstrg'+(j+1)+' = JSON.stringify(js'+(j+1)+');\n';
						}
					
					}
					
					


                   var functionBody='var temp= msg.payload;\n '+b+'\n\nvar head = {};\nhead["Content-Type"]= \'application/json\';\n';
     						functionBody+= "var messages = [";
     						
     						for(var i=0;i<sensors.length;i++){
     								protocol = configData[sensors[i]]["protocol"];	
   								if(protocol=="ngsi"){
   									functionBody+= "{ payload: jsonstrg"+(i+1)+",  headers: head }";
   								}else{
   									functionBody+= "{ payload:jsonstrg"+(i+1)+ "}";
   								}
   								
   								
   								if(i<sensors.length-1){
   	  								functionBody+=",";
   	  							}
   						}

                    
   					
   						functionBody+="];\n"
   	  					functionBody+="return messages;"

   			    newflow.push({
   							"id": function_id,
   							"type": "function",
   							"z": flow_id,
   							"name": "transform",
   							"func": functionBody,
   							"outputs": 1,
   							"noerr": 0,
   							"x": 400,
   							"y": middleY,
   							"wires": [
   									log_ids								
   							]
   						})
               
				
				 newflow.push({
                       "id": link_in_id,
                       "type": "link out",
                       "z": curr_flow_id,
                       "name": "",
                       "links": [inject_id],
                       "x": 200,
                       "y": 200,
                       "wires": [
                           []
                       ]
                   },),

                   //flow
                   newflow.push({
                       "id": flow_id,
                       "type": "tab",
                       "label": "Flow " + flow_id
                   }),


                   //link out
                   newflow.push(    {
                       "id": inject_id,
                       "type": "link in",
                       "z": flow_id,
                       "name": "",
                       "links": [link_in_id],
                       "x": 200,
                       "y": middleY,
                       "wires": [function_id]
                   })
				
				




                    

                    //$("#btn-sidemenu").simulate("click");
                    console.log("simulate click")

                     setTimeout(function(){ 
                    	$("#menu-item-import-clipboard").simulate("click");
                    	$("#clipboard-dialog textarea").html(JSON.stringify(newflow));
                    	$("#clipboard-dialog-ok").removeClass("ui-button-disabled");
                    	$("#clipboard-dialog-ok").removeClass("ui-state-disabled");
                    	$("#clipboard-dialog-ok").attr("aria-disabled",false);
                    	$('#clipboard-dialog-ok').removeAttr("disabled");
                 //   	$('#import-tab-current').removeClass("selected");
              //      	$('#import-tab-new').addClass("selected");
                    	
                    }, 250);




           

                      

   	






                    console.log("newflow is");
                    console.log(JSON.stringify(newflow));

   			  })
   			  .fail(function() {
   			    console.log( "error" );
   			  })
   			  .always(function() {
   			    console.log( "complete" );
   			  });

           }
            
    function createFlow_agg_value(sensors, configData){	
          
              
        
          /*** controllo iniziale se sono stati selzionati sensori  ***/
               
        	   configData=allDataOut;
        	   if(!sensors.length) return;



                      //numero id che servono
               var idAmount = sensors.length * 4 + 2+ value_types.length*4;

               var jqxhr = $.getJSON( "get-id?n="+idAmount, function(data) {
   			  console.log( "success" );
   			  console.log( data );
   			})
   			  .done(function(data) {
   			    console.log( "second success..." );

   			 
    				console.log( data );



    				var offsetY =200;
                   var offsetYstep = 100;  
                   var middleY = offsetY + offsetYstep*(sensors.length-1)/2;

                 //flow id
    			var counter_id = 0;
   				var flow_id = data.ids[counter_id++]; //0
                var curr_flow_id = data.ids[counter_id++]; //6		;

   			    linkFunctionVTable=[];
                    
                      for (var d=0; d<value_types.length; d++){
                            var obj={};
                            obj.link_id=data.ids[counter_id++];
                            obj.link_type= value_types[d];
                            obj.ev_id=data.ids[counter_id++];
                            obj.fun_id=data.ids[counter_id++];
                            linkFunctionVTable.push(obj);

                        }
                  console.log("before sorting");
                      console.log(linkFunctionVTable);
                      linkFunctionVTable.sort(function(a,b){
                          if(a.link_type < b.link_type) return -1;
                          else return 1;
                      });
                      console.log("after sorting");
                      console.log(linkFunctionVTable);
                      
                deviceLinkVTable=[];
                      for (var i=0; i<idValueArray.length; i++){
                          
                          var obj={};
                          obj.device= idValueArray[i].id;
                          obj.device_id=data.ids[counter_id++];
                          obj.fun_ids=[];
                          for(var j=0; j<linkFunctionVTable.length; j++){
                              for(var k=0; k<idValueArray[i].values.length; k++){
                                  if (linkFunctionVTable[j].link_type == idValueArray[i].values[k] ){
                                  obj.fun_ids.push(linkFunctionVTable[j].fun_id);
                                  //no break because in this case many to many relationship
                                  }
                              }
                              
                                  
                          }
                          deviceLinkVTable.push(obj);
                          console.log("obj.link_out_ids");
                          console.log(obj.link_out_ids);
                          
                          
                      }
                      
                      //update the linkFunctionVTable
                      
                for (var i=0; i<linkFunctionVTable.length; i++){
                          var relatedDevices=[];
                          for(var j=0; j<deviceLinkVTable.length; j++){
                              for (var k= 0; k< deviceLinkVTable[j].fun_ids.length; k++){
                                 if (deviceLinkVTable[j].fun_ids[k]==linkFunctionVTable[i].fun_id){
                                  relatedDevices.push(deviceLinkVTable[j].device_id);
                                  //we do not put break because relationship may be one to many
                              } 
                              }
                              
                          }
                          linkFunctionVTable[i].relatedDevices=relatedDevices;
                          linkFunctionVTable[i].correspondingLinkIn=data.ids[counter_id++];
                      }
                  
                 
                  
                var newflow = [];


   			    //sensori

   			    var addInjectNode=false;
      
                   var orion_ids=[];
                   var mosquitto_ids=[];
                   var rabbit_ids=[];
                   var sensor_ids=[];
                   var protocol;

                   

    for(var i=0;i<sensors.length;i++){
                   	console.log("orion--")
                   	console.log(configData[sensors[i]])
                   	try {
                   		protocol = configData[sensors[i]]["protocol"];
   							}
   					catch(err) {
      						 protocol="none";
   							}
                   	var conf_id = data.ids[counter_id++];							 
                   	var node_id;
                   	
					

                   	
                    for(var j =0; j< deviceLinkVTable.length; j++){
                          if(sensors[i]==deviceLinkVTable[j].device){
                              node_id= deviceLinkVTable[j].device_id;
                          }
                      }

                  	
                  	var attributes=[];
                  	console.log("idValueArray is "+idValueArray);
					console.log("sensors[i] "+sensors[i]);
                  	for (var j=0; j< idValueArray.length; j++ ){
						console.log("idValueArray[j].id "+idValueArray[j].id);
						if (idValueArray[j].id==sensors[i])
						attributes= idValueArray[j].values;
					}
                  	console.log("attributes is "+attributes);
					var attributes_string="";
					for (var j=0; j<attributes.length; j++){
						if(j< attributes.length-1){
							attributes_string+="'"+ attributes[j]+"',";
						}
						else{
							attributes_string+="'"+ attributes[j]+"'";
						}
					}
                  	console.log(counter_id);;
                   	//orion
                   	switch(protocol){
   			  	    	case "ngsi":
   	                		orion_ids.push(node_id);

                               
                               
                   	    	newflow.push({
   								"id": node_id,
   								"type": "http request",
   								"z": flow_id,
   								"name": sensors[i],
   								"method": "POST",
   								"ret": "txt",
   								"url": "http://"+configData[sensors[i]]["ip"]+":"+configData[sensors[i]]["port"]+"/v2/entities/"+sensors[i]+"/attrs/",
   								"tls": "",
   								"x": 800,
   								"y": offsetY,
   								"wires": [
   									[
   										
   									]
   								]
   							
                               })


   						break;


                           //mosquitto
   						case "mqtt":
   							mosquitto_ids.push(node_id);
   	                	    newflow.push({
   								"id": conf_id,
   								"type": "mqtt-broker",
   								"z": "",
   								"broker": configData[sensors[i]]["ip"],
   								"port":  configData[sensors[i]]["port"],
   								"clientid": "",
   								"usetls": false,
   								"compatmode": true,
   								"keepalive": "60",
   								"cleansession": true,
   								"willTopic": "",
   								"willQos": "0",
   								"willRetain": "false",
   								"willPayload": "",
   								"birthTopic": "",
   								"birthQos": "0",
   								"birthRetain": "false",
   								"birthPayload": ""
   							});





   	                	     newflow.push({
   								"id": node_id,
   								"type": "mqtt out",
   								"z": flow_id,
   								"name": sensors[i],
   								"topic": sensors[i],
   								"qos": "2",
   								"retain": "",
   								"broker": conf_id,
   								"x": 800,
   								"y": offsetY,
   								"wires": [
   									[
   										
   									]
   								]
   							})

   						break;

   	                	  //rabbit
   							  //	$("#node-input-ioname").val(rabbitNodes[rabbitCount]["sensorId"]);
   		  					   //  	$("#node-input-iotype").val(4);
   							case "amqp":
                        case "AMQP":
   								rabbit_ids.push(node_id);
   								newflow.push({
   									"id": conf_id,
   									"type": "amqp-server",
   									"z": "",
   									"host": configData[sensors[i]]["ip"],
   									"port": configData[sensors[i]]["port"],
   									"vhost": "",
   									"keepalive": "30",
   									"usetls": false,
   									"verifyservercert": true,
   									"usetopology": false,
   									"topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}"
   								});

   								newflow.push({
   									"id": node_id,
   									"type": "amqp out",
   									"z": flow_id,
   									"name": sensors[i],
   									"routingkey": "",
   									"iotype": "4",
   									"ioname": sensors[i],
   									"server": conf_id,
   									"x": 800,
   									"y": offsetY,
   									"wires": [
   										[
   	                                    
   	                                    ]
   									]
   								})

   							break;

                   	}

                   	
   					offsetY+=offsetYstep;

                   

                   }
                 //function
        for (var i=0; i<linkFunctionVTable.length; i++){
                      
                
                   sensor_ids = orion_ids.concat(mosquitto_ids).concat(rabbit_ids);
				   
					var b="";
					
                    var devicesIdsForFunction= linkFunctionVTable[i].relatedDevices;
                    var devicesNamesForFunction=[];
                    for(var j= 0; j<deviceLinkVTable.length; j++){
                        for(var k= 0; k<devicesIdsForFunction.length; k++){
                            if (deviceLinkVTable[j].device_id==devicesIdsForFunction[k]){
                                devicesNamesForFunction.push(deviceLinkVTable[j].device);
                            }
                        }
                    }
                    
			var count=0;	
            for(var j=0;j<idValueArray.length; j++){
								
								
                                var proceed= false;
								for(var k=0; k<devicesNamesForFunction.length; k++){
                                    if(idValueArray[j].id==devicesNamesForFunction[k]){
                                        proceed= true;
                                    }
                                }
                            
                                if(!proceed) continue;
                    
                                proceed= false;
                                var valuesForFunction=[];
                                for(var k=0; k<idValueArray[j].values.length; k++){
										if(idValueArray[j].values[k]==linkFunctionVTable[i].link_type){
                                            valuesForFunction.push(idValueArray[j].values[k]);
                                            proceed=true;
                                        }
									}
                                if(!proceed) continue;
                            
                                b+='\n \/\/ please check and complete the following \r\n\/\/ attributes with the value arriving from \r\n\/\/ the payload\r\nvar attributes={};\n';
                            
                                for(var k=0; k<valuesForFunction.length; k++){
										b+='attributes["'+valuesForFunction[k]+'"]="val"; \/\/' +idValueArray[j].id+'\n';
									}
								
								b+='\n\n';
								try {
								pro = configData[idValueArray[j].id]["protocol"];
								}
								catch(err) {
									pro="none";
								}
								if(pro=="mqtt" || pro=="amqp"){
									b+= 'var js'+(count+1)+' = attributes;\n';
								}
								else{
									b+= 'var js'+(count+1)+' = {id:"'+idValueArray[j].id+'", type: "command", attributes};\n';
								}
								
							
								b+='var jsonstrg'+(count+1)+' = JSON.stringify(js'+(count+1)+');\n';
                                
                                count++;
							}
						
					


                   var functionBody='var temp= msg.payload;\n '+b+'\n\nvar head = {};\nhead["Content-Type"]= \'application/json\';\n';
     						functionBody+= "var messages = [";
     						
     						for(var j=0;j<devicesNamesForFunction.length;j++){
     								protocol = configData[devicesNamesForFunction[j]]["protocol"];	
   								if(protocol=="ngsi"){
   									functionBody+= "{ payload: jsonstrg"+(j+1)+",  headers: head }";
   								}else{
   									functionBody+= "{ payload:jsonstrg"+(j+1)+ "}";
   								}
   								
   								
   								if(j<devicesNamesForFunction.length-1){
   	  								functionBody+=",";
   	  							}
   						}

                    
   					
   						functionBody+="];\n"
   	  					functionBody+="return messages;"

                  //eventlog
   					newflow.push({
   						"id": linkFunctionVTable[i].ev_id,
   						"type": "event-log",
   						"z": flow_id,
   						"name": "",
   						"modcom": "RX",
   						"motivation": "IoT_Service",
   						"x": 400,
   						"y":  middleY-linkFunctionVTable.length*offsetYstep/2+ i*offsetYstep,
   						"wires": [
   							[
   								linkFunctionVTable[i].fun_id
   							],[]
   							
   						]
   					});
   			    
                  
                  newflow.push({
   							"id": linkFunctionVTable[i].fun_id,
   							"type": "function",
   							"z": flow_id,
   							"name": "transform",
   							"func": functionBody,
   							"outputs": 1,
   							"noerr": 0,
   							"x": 600,
   							"y":  middleY-linkFunctionVTable.length*offsetYstep/2+ i*offsetYstep,
   							"wires": [linkFunctionVTable[i].relatedDevices]								
   							
   						});
               
				
				 
               
                  
                      newflow.push({
                          "id": linkFunctionVTable[i].correspondingLinkIn,
                          "type": "link out",
                          "z": curr_flow_id,
                          "name": linkFunctionVTable[i].link_type,
                          "links": [linkFunctionVTable[i].link_id],
                          "x": 200+150,
                          "y": 200+i*100,
                          "wires": [
                              
                          ]
                  });
                }
                 
                   //flow
                   newflow.push({
                       "id": flow_id,
                       "type": "tab",
                       "label": "Flow " + flow_id
                   });
                  
                  console.log("here");
                  for (var i=0; i<linkFunctionVTable.length; i++){
                        newflow.push(    {
                          "id": linkFunctionVTable[i].link_id,
                          "type": "link in",
                          "z": flow_id,
                          "name": linkFunctionVTable[i].link_type,
                          "links": [linkFunctionVTable[i].correspondingLinkIn],
                          "x": 200,
                          "y": middleY-linkFunctionVTable.length*offsetYstep/2+ i*offsetYstep,
                          "wires": [linkFunctionVTable[i].ev_id]
                      });
					  
				  }


                
				
	
                    //$("#btn-sidemenu").simulate("click");
                    console.log("simulate click")

                     setTimeout(function(){ 
                    	$("#menu-item-import-clipboard").simulate("click");
                    	$("#clipboard-dialog textarea").html(JSON.stringify(newflow));
                    	$("#clipboard-dialog-ok").removeClass("ui-button-disabled");
                    	$("#clipboard-dialog-ok").removeClass("ui-state-disabled");
                    	$("#clipboard-dialog-ok").attr("aria-disabled",false);
                    	$('#clipboard-dialog-ok').removeAttr("disabled");
                 //   	$('#import-tab-current').removeClass("selected");
              //      	$('#import-tab-new').addClass("selected");
                    	
                    }, 250);


                    console.log("newflow is");
                    console.log(JSON.stringify(newflow));

   			  })
   			  .fail(function() {
   			    console.log( "error" );
   			  })
   			  .always(function() {
   			    console.log( "complete" );
   			  });
        
    



        }
            
            
    function createFlow_agg_device(sensors, configData){	
          
              
        
          /*** controllo iniziale se sono stati selzionati sensori  ***/
               
        	   configData=allDataOut;
        	   if(!sensors.length) return;



                      //numero id che servono
               var idAmount = sensors.length * 3 + 7;

               var jqxhr = $.getJSON( "get-id?n="+idAmount, function(data) {
   			  console.log( "success" );
   			  console.log( data );
   			})
   			  .done(function(data) {
   			    console.log( "second success..." );

   			 
    				console.log( data );



    				var offsetY =200;
                   var offsetYstep = 100;  
                   var middleY = offsetY + offsetYstep*(sensors.length-1)/2;

                 //flow id
    			var counter_id = 0;
   				var flow_id = data.ids[counter_id++]; //0
                var curr_flow_id = data.ids[counter_id++]; //6		;

   			    linkFunctionDTable=[];
                    
                      for (var d=0; d<device_types.length; d++){
                            var obj={};
                            obj.link_id=data.ids[counter_id++];
                            obj.link_type= device_types[d];
                            obj.ev_id=data.ids[counter_id++];
                            obj.fun_id=data.ids[counter_id++];
                            linkFunctionDTable.push(obj);

                        } 
                      
                deviceLinkDTable=[];
                      for (var i=0; i<sensors.length; i++){
                          var obj={};
                          obj.device= sensors[i];
                          obj.device_id=data.ids[counter_id++];
                          for(var j=0; j<linkFunctionDTable.length; j++){
                              if (configData[sensors[i]]["entityType"]==linkFunctionDTable[j].link_type){
                                  obj.fun_id=linkFunctionDTable[j].fun_id;
                                  break;
                              }
                                  
                          }
                          deviceLinkDTable.push(obj);
                      }
                      
                      //update the linkFunctionDTable
                      
                for (var i=0; i<linkFunctionDTable.length; i++){
                          var relatedDevices=[];
                          for(var j=0; j<deviceLinkDTable.length; j++){
                              if (deviceLinkDTable[j].fun_id==linkFunctionDTable[i].fun_id){
                                  relatedDevices.push(deviceLinkDTable[j].device_id);
                                  //we do not put break because relationship may be one to many
                              }
                          }
                          linkFunctionDTable[i].relatedDevices=relatedDevices;
                          linkFunctionDTable[i].correspondingLinkIn=data.ids[counter_id++];
                      }
                  
                  
                var newflow = [];


   			    //sensori

   			    var addInjectNode=false;
      
                   var orion_ids=[];
                   var mosquitto_ids=[];
                   var rabbit_ids=[];
                   var sensor_ids=[];
                   var protocol;

                   

            for(var i=0;i<sensors.length;i++){
                   	
                console.log("orion--")
                   	console.log(configData[sensors[i]])
                   	try {
                   		protocol = configData[sensors[i]]["protocol"];
   							}
   					catch(err) {
      						 protocol="none";
   							}
                   	var conf_id = data.ids[counter_id++];							 
                   	var node_id;
                   	
					

                   	
                    for(var j =0; j< deviceLinkDTable.length; j++){
                          if(sensors[i]==deviceLinkDTable[j].device){
                              node_id= deviceLinkDTable[j].device_id;
                          }
                      }

                  	
                  	var attributes=[];
                  	console.log("idValueArray is "+idValueArray);
					console.log("sensors[i] "+sensors[i]);
                  	for (var j=0; j< idValueArray.length; j++ ){
						console.log("idValueArray[j].id "+idValueArray[j].id);
						if (idValueArray[j].id==sensors[i])
						attributes= idValueArray[j].values;
					}
                  	console.log("attributes is "+attributes);
					var attributes_string="";
					for (var j=0; j<attributes.length; j++){
						if(j< attributes.length-1){
							attributes_string+="'"+ attributes[j]+"',";
						}
						else{
							attributes_string+="'"+ attributes[j]+"'";
						}
					}
                  	console.log(counter_id);;
                   	//orion
                   	switch(protocol){
   			  	    	case "ngsi":
   	                		orion_ids.push(node_id);

                               
                               
                   	    	newflow.push({
   								"id": node_id,
   								"type": "http request",
   								"z": flow_id,
   								"name": sensors[i],
   								"method": "POST",
   								"ret": "txt",
   								"url": "http://"+configData[sensors[i]]["ip"]+":"+configData[sensors[i]]["port"]+"/v2/entities/"+sensors[i]+"/attrs/",
   								"tls": "",
   								"x": 800,
   								"y": offsetY,
   								"wires": [
   									[
   										
   									]
   								]
   							
                               })


   						break;


                           //mosquitto
   						case "mqtt":
   							mosquitto_ids.push(node_id);
   	                	    newflow.push({
   								"id": conf_id,
   								"type": "mqtt-broker",
   								"z": "",
   								"broker": configData[sensors[i]]["ip"],
   								"port":  configData[sensors[i]]["port"],
   								"clientid": "",
   								"usetls": false,
   								"compatmode": true,
   								"keepalive": "60",
   								"cleansession": true,
   								"willTopic": "",
   								"willQos": "0",
   								"willRetain": "false",
   								"willPayload": "",
   								"birthTopic": "",
   								"birthQos": "0",
   								"birthRetain": "false",
   								"birthPayload": ""
   							});





   	                	     newflow.push({
   								"id": node_id,
   								"type": "mqtt out",
   								"z": flow_id,
   								"name": sensors[i],
   								"topic": sensors[i],
   								"qos": "2",
   								"retain": "",
   								"broker": conf_id,
   								"x": 800,
   								"y": offsetY,
   								"wires": [
   									[
   										
   									]
   								]
   							})

   						break;

   	                	  //rabbit
   							  //	$("#node-input-ioname").val(rabbitNodes[rabbitCount]["sensorId"]);
   		  					   //  	$("#node-input-iotype").val(4);
   							case "amqp":
                        case "AMQP":
   								rabbit_ids.push(node_id);
   								newflow.push({
   									"id": conf_id,
   									"type": "amqp-server",
   									"z": "",
   									"host": configData[sensors[i]]["ip"],
   									"port": configData[sensors[i]]["port"],
   									"vhost": "",
   									"keepalive": "30",
   									"usetls": false,
   									"verifyservercert": true,
   									"usetopology": false,
   									"topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}"
   								});

   								newflow.push({
   									"id": node_id,
   									"type": "amqp out",
   									"z": flow_id,
   									"name": sensors[i],
   									"routingkey": "",
   									"iotype": "4",
   									"ioname": sensors[i],
   									"server": conf_id,
   									"x": 800,
   									"y": offsetY,
   									"wires": [
   										[
   	                                    
   	                                    ]
   									]
   								})

   							break;

                   	}

                   	
   					offsetY+=offsetYstep;

                   

                   }
                 //function
            for (var i=0; i<linkFunctionDTable.length; i++){
                      
                
                   sensor_ids = orion_ids.concat(mosquitto_ids).concat(rabbit_ids);
				   
					var b="";
					
					var devicesIdsForFunction= linkFunctionDTable[i].relatedDevices;
					var devicesNamesForFunction=[];
                    for(var j= 0; j<deviceLinkDTable.length; j++){
                        for(var k= 0; k<devicesIdsForFunction.length; k++){
                            if (deviceLinkDTable[j].device_id==devicesIdsForFunction[k]){
                                devicesNamesForFunction.push(deviceLinkDTable[j].device);
                            }
                        }
                    }
                    
                var count =0;    
                for(var j=0;j<sensors.length;j++){
                            var proceed= false;
                            for(var k=0; k<devicesNamesForFunction.length; k++){
                                if (devicesNamesForFunction[k]==sensors[j]){
                                    proceed = true;
                                }
                            }
                        if(! proceed) continue;
								b+='\n \/\/ please check and complete the following \r\n\/\/ attributes with the value arriving from \r\n\/\/ the payload\r\nvar attributes={};\n';

						
							try {
								pro = configData[sensors[j]]["protocol"];
   							}
							catch(err) {
								pro="none";
   							}
							if(pro=="mqtt" || pro=="amqp"){
									b+= 'var js'+(count+1)+' = attributes;\n';
								}
							else{
									b+= 'var js'+(count+1)+' = {id:"'+sensors[j]+'", type: "command", attributes};\n';
								}
							b+='var jsonstrg'+(count+1)+' = JSON.stringify(js'+(count+1)+');\n';
                            
                            count++;
                        
                        }
					
					
					
					


                   var functionBody='var temp= msg.payload;\n '+b+'\n\nvar head = {};\nhead["Content-Type"]= \'application/json\';\n';
     						functionBody+= "var messages = [";
     						
     						for(var j=0;j<devicesNamesForFunction.length;j++){
     								protocol = configData[devicesNamesForFunction[j]]["protocol"];	
   								if(protocol=="ngsi"){
   									functionBody+= "{ payload: jsonstrg"+(j+1)+",  headers: head }";
   								}else{
   									functionBody+= "{ payload:jsonstrg"+(j+1)+ "}";
   								}
   								
   								
   								if(j<devicesNamesForFunction.length-1){
   	  								functionBody+=",";
   	  							}
   						}

                    
   					
   						functionBody+="];\n"
   	  					functionBody+="return messages;"

                  //eventlog
   					newflow.push({
   						"id": linkFunctionDTable[i].ev_id,
   						"type": "event-log",
   						"z": flow_id,
   						"name": "",
   						"modcom": "RX",
   						"motivation": "IoT_Service",
   						"x": 400,
   						"y":  middleY-linkFunctionDTable.length*offsetYstep/2+ i*offsetYstep,
   						"wires": [
   							[
   								linkFunctionDTable[i].fun_id
   							],[]
   							
   						]
   					});
   			    
                  
                  newflow.push({
   							"id": linkFunctionDTable[i].fun_id,
   							"type": "function",
   							"z": flow_id,
   							"name": "transform",
   							"func": functionBody,
   							"outputs": 1,
   							"noerr": 0,
   							"x": 600,
   							"y":  middleY-linkFunctionDTable.length*offsetYstep/2+ i*offsetYstep,
   							"wires": [linkFunctionDTable[i].relatedDevices]								
   							
   						});
               
				
				 
               
                  
                      newflow.push({
                          "id": linkFunctionDTable[i].correspondingLinkIn,
                          "type": "link out",
                          "z": curr_flow_id,
                          "name": linkFunctionDTable[i].link_type,
                          "links": [linkFunctionDTable[i].link_id],
                          "x": 200+150,
                          "y": 200+i*100,
                          "wires": [
                              
                          ]
                  });
                }
                 
                   //flow
                   newflow.push({
                       "id": flow_id,
                       "type": "tab",
                       "label": "Flow " + flow_id
                   });
                  
                  console.log("here");
                  for (var i=0; i<linkFunctionDTable.length; i++){
                        newflow.push(    {
                          "id": linkFunctionDTable[i].link_id,
                          "type": "link in",
                          "z": flow_id,
                          "name": linkFunctionDTable[i].link_type,
                          "links": [linkFunctionDTable[i].correspondingLinkIn],
                          "x": 200,
                          "y": middleY-linkFunctionDTable.length*offsetYstep/2+ i*offsetYstep,
                          "wires": [linkFunctionDTable[i].ev_id]
                      });
					  
				  }


                
				
	
                    //$("#btn-sidemenu").simulate("click");
                    console.log("simulate click")

                     setTimeout(function(){ 
                    	$("#menu-item-import-clipboard").simulate("click");
                    	$("#clipboard-dialog textarea").html(JSON.stringify(newflow));
                    	$("#clipboard-dialog-ok").removeClass("ui-button-disabled");
                    	$("#clipboard-dialog-ok").removeClass("ui-state-disabled");
                    	$("#clipboard-dialog-ok").attr("aria-disabled",false);
                    	$('#clipboard-dialog-ok').removeAttr("disabled");
                 //   	$('#import-tab-current').removeClass("selected");
              //      	$('#import-tab-new').addClass("selected");
                    	
                    }, 250);


                    console.log("newflow is");
                    console.log(JSON.stringify(newflow));

   			  })
   			  .fail(function() {
   			    console.log( "error" );
   			  })
   			  .always(function() {
   			    console.log( "complete" );
   			  });
        
    



        }

                    
                }
                    });
</script>


////////////////////////////////////////////////////
//			IOT DIRECTORY IN
////////////////////////////////////////////////////
<script type="text/x-red" data-template-name="iot-directory-in">

    <div class="tab">
  		<button class="tablinks" onclick="openTab(event, 'Device-based-search')" id="deviceTabButton">Device-based search</button>
  		<button class="tablinks" onclick="openTab(event, 'Value-based-search')" id="valueTabButton">Value-based search</button>
	</div>

<!-- ################### First Tab ####################### -->

<div id="Device-based-search" class="tabcontent">
      
    <div>
        <label style="font-size: 14px; padding-bottom:10px"><input type="checkbox" id="checkbox_aggr_in_device" checked /><strong> Aggregated by device types </strong></label>
    </div>
	
	<div id="divload">
        <label style="font-size: 14px; padding-bottom:10px"><strong> div load </strong></label>
    </div>
	
    <div class="form-row iot-directory-form-row">
        <label style="width: auto" for="node-input-kind-of-search"><i class="icon-tag"></i>Retrieval</label>
        <select id="node-input-kind-of-search-select">
            <!--<option value="selected" >Specific Devices</b></option>-->
            <option value="map">Map search</option>
			<option value="retrieve">Parametric Search</option>
            <!--<option value="map_marker">Map search near marker</option>-->
			<!--<option value="map_path">Map search along path</option>-->
			<!--<option value="map_polygon">Map search in polygon</option>-->
        </select>
    </div>

	  <div id="retrieve-selected" >
	
		<!-- ricerca testuale -->
   		<div class="form-row iot-directory-form-row">
            <label for="node-input-text-search"><i class="icon-tag"></i> Search</label>
            <input type="text" id="node-input-text-search" placeholder="Search">
       </div>
	   
	</div>
	
	
    <div id="retrieve-wrapper" >
	    <!-- tipo:  entity type  (light, temperature ...) multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-type-select"><i class="icon-tag"></i>Type</label>
	        <select id="node-input-type-select"><!-- multiple-->
	        </select>
	    </div>



	       <!--  tipo:  kind  (sensors, actuators) elect -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-kind-select"><i class="icon-tag"></i>Kind</label>
	        <select id="node-input-kind-select">
	        </select>
	    </div>


	      <!-- tipo:  contextBroker  multiselect -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-context-broker-select"><i class="icon-tag"></i>Context broker</label>
	        <select id="node-input-context-broker-select"><!-- multiple size=3 -->
	        </select>
    </div>
	
		<!-- ricerca testuale -->
   		<div class="form-row iot-directory-form-row">
            <label for="node-input-text-search"><i class="icon-tag"></i> Search</label>
            <input type="text" id="node-input-text-search2" placeholder="Search">
       </div>
	   
	</div>

<div id="marker-wrapper" >
		<!-- tipo:  Max distance  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-distance-select"><i class="icon-tag"></i>Max Distance</label>
	        <select id="node-input-max-distance-select" multiple>
	        </select>
	    </div>

		<!-- tipo:  Max resuts  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-results-marker-select"><i class="icon-tag"></i>Max Results</label>
	        <select id="node-input-max-results-marker-select" multiple>
	        </select>
	    </div>
	</div>

	<div id="polygon-wrapper" >
		<!-- tipo:  Max resuts  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-results-polygon-select"><i class="icon-tag"></i>Max Results</label>
	        <select id="node-input-max-results-polygon-select" multiple>
	        </select>
	    </div>
	</div>

	<div id="path-wrapper" >
		<!-- tipo:  Max distance  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-distance-path-select"><i class="icon-tag"></i>Max Distance</label>
	        <select id="node-input-max-distance-path-select" multiple>
	        </select>
	    </div>

		<!-- tipo:  Max resuts  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-results-path-select"><i class="icon-tag"></i>Max Results</label>
	        <select id="node-input-max-results-path-select" multiple>
	        </select>
	    </div>	
	</div>

	
	<div id="target-wrapper" >

    <div class="form-row iot-directory-form-row">
	<label style="width: auto" for="node-input-map-select"><i class="icon-tag"></i>map</label>
	 <div class="form-row" style="display:none">
        <label for="node-input-maxresults">Max Results</label>
        <select id="node-input-maxresults">
			<option value="100">100</option>
			<option value="200">200</option>
			<option value="500">500</option>
			<option value="1000">1000</option>
			<option value="2000">2000</option>
			<option value="0">All</option>
		</select>
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-latitude">Latitude</label>
        <input type="text" id="node-input-latitude" placeholder="Latitude" disabled>
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-longitude">Longitude</label>
        <input type="text" id="node-input-longitude" placeholder="Longitude" disabled>
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-maxdists">Max Distance</label>
        <input type="text" id="node-input-maxdists" placeholder="Max Distance" disabled>
    </div>
        <link rel="stylesheet" href="s4c/css/leaflet.css" />
        <link rel="stylesheet" href="s4c/css/leaflet.draw.css" />
        <div id="node-input-map" style="width: 100%; height: 400px"></div>
	
    </div>

	     
    </div>

    <div class="form-row node-input-target-row" / >
        <div id="node-input-nodes-target-container-div" 
				style=" min-height: 100px;
				position: relative;   box-sizing: border-box; border-radius: 2px; 
				height: 180px;  border: 1px solid #ccc;overflow:hidden; ">
         <div style="box-sizing: border-box; 
				line-height: 20px; 
				font-size: 0.8em; 
				border-bottom: 1px solid #ddd; 
				height: 20px;">
              		<input type="checkbox" data-i18n="[title]status.label.selectAll" 
									id="node-input-target-node-checkbox-all" style="width: 30px; margin: 0 2px 1px 2px;">

              		<div style="display: inline-block;">
						<a id="node-input-target-sort-label" href="#" data-i18n="[title]status.label.sortByLabel"><span data-i18n="status.label.node"></span> <i class="node-input-status-sort-label-a fa fa-caret-down"></i><i class="node-input-status-sort-label-d fa fa-caret-up"></i></a>
						<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Name</strong></label>
					</div>

					<div style="position:absolute; left:40%; width: auto; display: inline-block; ">
						<a id="node-input-target-sort-label2" href="#" data-i18n="[title]status.label.sortByLabel2"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
						<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Type</strong></label>
					</div>
              		<div style="position: absolute; right: 10px; width: auto; display: inline-block; text-align: right;">
						<a id="node-input-target-sort-type" href="#" data-i18n="[title]status.label.sortByType"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
						<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Context-Broker</strong></label>
					</div>

          </div>
          <div style="background: #fbfbfb; box-sizing: border-box; position:absolute; top:20px;bottom:0;left:0px;right:0px; 
				overflow-y: scroll; 
				overflow-x: hidden;">
                
				<ul id="node-input-nodes-target-container" style=" list-style-type:none; margin: 0;"></ul>
            
		</div>
        </div>
    </div>
    

</div>

<!-- ################### Second Tab ####################### -->

<div id="Value-based-search" class="tabcontent" style="display:none">

<div>
        <label style="font-size: 14px; padding-bottom:10px"><input type="checkbox" id="checkbox_aggr_in_value" checked /><strong> Aggregated by value types </strong></label>
    </div>

<div class="form-row iot-directory-form-row">
        <label style="width: auto" for="node-input-kind-of-search"><i class="icon-tag"></i>Retrieval</label>
        <select id="node-input-kind-of-search-select-tab2">
            <option value="map">Map search</option>
			<option value="retrieve">Parametric Search</option>  
        </select>
    </div>

	
    <div id="retrieve-wrapper-tab2" >
	    <!-- tipo:  value type -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-value-type-select-tab2"><i class="icon-tag"></i>Value type</label>
	        <select id="node-input-value-type-select-tab2">
	        </select>
	    </div>



	       <!--  tipo:  kind  value name -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-value-name-select-tab2"><i class="icon-tag"></i>Value name</label>
	        <select id="node-input-value-name-select-tab2">
	        </select>
	    </div>


	      <!-- tipo:  contextBroker   -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-context-broker-select-tab2"><i class="icon-tag"></i>Context broker</label>
	        <select id="node-input-context-broker-select-tab2">
	        </select>
   		 </div>

		<!-- tipo:  editable  -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-editable-select-tab2"><i class="icon-tag"></i>Editable</label>
	        <select id="node-input-editable-select-tab2">
	        </select>
   		 </div>

		<!-- tipo:  healthiness  -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-healthiness-select-tab2"><i class="icon-tag"></i>Healthiness</label>
	        <select id="node-input-healthiness-select-tab2">
	        </select>
   		 </div>
	
		<!-- ricerca testuale -->
   		<div class="form-row iot-directory-form-row">
            <label for="node-input-text-search"><i class="icon-tag"></i> Search</label>
            <input type="text" id="node-input-text-search2-tab2" placeholder="Search">
       </div>
	   
	</div>


	
	<div id="target-wrapper-tab2" >

    <div class="form-row iot-directory-form-row">
	<label style="width: auto" for="node-input-map-select-tab2"><i class="icon-tag"></i>map</label>
	
        <link rel="stylesheet" href="s4c/css/leaflet.css" />
        <link rel="stylesheet" href="s4c/css/leaflet.draw.css" />
        <div id="node-input-map-tab2" style="width: 100%; height: 400px"></div>
	
    </div>

	     
    </div>

    <div class="form-row node-input-target-row" / >
        <div id="node-input-nodes-target-container-div" 
				style=" min-height: 100px;
				position: relative;   box-sizing: border-box; border-radius: 2px; 
				height: 180px;  border: 1px solid #ccc;overflow:hidden; ">
         <div style="box-sizing: border-box; 
				line-height: 20px; 
				font-size: 0.8em; 
				border-bottom: 1px solid #ddd; 
				height: 20px;">
              		<input type="checkbox" data-i18n="[title]status.label.selectAll" 
									id="node-input-target-node-checkbox-all-tab2" style="width: 30px; margin: 0 2px 1px 2px;">
              		<div style="display: inline-block;">
								<a id="node-input-target-sort-label-tab2" href="#" data-i18n="[title]status.label.sortByLabel"><span data-i18n="status.label.node"></span> <i class="node-input-status-sort-label-a fa fa-caret-down"></i><i class="node-input-status-sort-label-d fa fa-caret-up"></i></a>
								<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Value type</strong></label>
					</div>
					<div style="position:absolute; left:40%; width: auto; display: inline-block; text-align: right;">
								<a id="node-input-target-sort-device-tab2" href="#" data-i18n="[title]status.label.sortByLabel2"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
								<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Name</strong></label>
					</div>
				<!--	<div style="position: absolute; left: 60%; width: 50px; display: inline-block; text-align: right;">
								<a id="node-input-target-sort-name-tab2" href="#" data-i18n="[title]status.label.sortByType"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
					</div>-->
              		<div style="position: absolute; right: 10px; width: auto; display: inline-block; text-align: right;">
								<a id="node-input-target-sort-type-tab2" href="#" data-i18n="[title]status.label.sortByType"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
								<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Context-Broker</strong></label>
					</div>

          </div>
          <div style="background: #fbfbfb; box-sizing: border-box; position:absolute; top:20px;bottom:0;left:0px;right:0px; 
				overflow-y: scroll; 
				overflow-x: hidden;">
                
				<ul id="node-input-nodes-target-container-tab2" style=" list-style-type:none; margin: 0;"></ul>
            
		</div>
        </div>
    </div>
    
</div>
 

    
</script>

<script>



function openTab(evt, cityName) {
	openedTab=cityName;

    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(cityName).style.display = "block";
    evt.currentTarget.className += " active";
	if (window.node_input_map) {
		                window.node_input_map.invalidateSize(true);
		            };
	if (window.node_input_map_2) {
		                window.node_input_map_2.invalidateSize(true);
		            };
}
</script>

<script type="text/x-red" data-help-name="iot-directory-in">
    <p>Iot Directory In Description</p>
</script>



////////////////////////////////////////////////////
//			IOT DIRECTORY IN SCRIPT OUT
////////////////////////////////////////////////////
<script type="text/x-red" data-template-name="iot-directory-out">

     <div class="tab">
  		<button class="tablinks" onclick="openTab(event, 'Device-based-search')" id="deviceTabButton">Device-based search</button>
  		<button class="tablinks" onclick="openTab(event, 'Value-based-search')" id="valueTabButton">Value-based search</button>
	</div>

	<!-- ################### First Tab ####################### -->

	<div id="Device-based-search" class="tabcontent">

	 <div>
        <label style="font-size: 14px; padding-bottom:10px"><input type="checkbox" id="checkbox_aggr_out_device" checked /><strong> Aggregated by device types </strong></label>
    </div>
    <div class="form-row iot-directory-form-row">
 		<label style="width: auto" for="node-input-kind-of-search"><i class="icon-tag"></i>Retrieval</label>
        <select id="node-input-kind-of-search-select">
            <!-- <option value="selected" >Specific Devices</b></option>-->
            <option value="map">Map search</option>
			<option value="retrieve">Parametric Search</option>
            <!--<option value="map_marker">Map search near marker</option>-->
			<!--<option value="map_path">Map search along path</option>-->
			<!--<option value="map_polygon">Map search in polygon</option>-->
        </select>
    </div>
	
	 <div id="retrieve-selected" >
	
		<!-- ricerca testuale -->
   		<div class="form-row iot-directory-form-row">
            <label for="node-input-text-search"><i class="icon-tag"></i> Search</label>
            <input type="text" id="node-input-text-search" placeholder="Search">
       </div>
	   
	</div>
	
    <div id="retrieve-wrapper">
	    <!-- tipo:  entity type  (light, temperature ...) multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-type-select"><i class="icon-tag"></i>Type</label>
	        <select id="node-input-type-select"><!-- multiple -->
	        </select>
	    </div>



	       <!--  tipo:  kind  (sensors, actuators) elect -->
	     <div class="form-row iot-directory-form-row" >
	        <label style="width: auto" for="node-input-kind-select"><i class="icon-tag"></i>Kind</label>
	        <select id="node-input-kind-select">
	        </select>
	    </div>


		
	      <!-- tipo:  contextBroker  multiselect -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-context-broker-select"><i class="icon-tag"></i>Context broker</label>
	        <select id="node-input-context-broker-select"><!-- multiple size=3 -->
	        </select>
    </div>
			<!-- ricerca testuale -->
   		<div class="form-row iot-directory-form-row">
            <label for="node-input-text-search"><i class="icon-tag"></i> Search</label>
            <input type="text" id="node-input-text-search2" placeholder="Search">
       </div>
	</div>

<div id="marker-wrapper" >
		<!-- tipo:  Max distance  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-distance-select"><i class="icon-tag"></i>Max Distance</label>
	        <select id="node-input-max-distance-select" multiple>
	        </select>
	    </div>

		<!-- tipo:  Max resuts  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-results-marker-select"><i class="icon-tag"></i>Max Results</label>
	        <select id="node-input-max-results-marker-select" multiple>
	        </select>
	    </div>
	</div>

	<div id="polygon-wrapper" >
		<!-- tipo:  Max resuts  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-results-polygon-select"><i class="icon-tag"></i>Max Results</label>
	        <select id="node-input-max-results-polygon-select" multiple>
	        </select>
	    </div>
	</div>

	<div id="path-wrapper" >
		<!-- tipo:  Max distance  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-distance-path-select"><i class="icon-tag"></i>Max Distance</label>
	        <select id="node-input-max-distance-path-select" multiple>
	        </select>
	    </div>

		<!-- tipo:  Max resuts  multiselect-->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-max-results-path-select"><i class="icon-tag"></i>Max Results</label>
	        <select id="node-input-max-results-path-select" multiple>
	        </select>
	    </div>	
	</div>


	
	<div id="target-wrapper" >

    <div class="form-row iot-directory-form-row">
	<label style="width: auto" for="node-input-map-select"><i class="icon-tag"></i>map</label>
	 <div class="form-row" style="display:none">
        <label for="node-input-maxresults">Max Results</label>
        <select id="node-input-maxresults">
			<option value="100">100</option>
			<option value="200">200</option>
			<option value="500">500</option>
			<option value="1000">1000</option>
			<option value="2000">2000</option>
			<option value="0">All</option>
		</select>
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-latitude">Latitude</label>
        <input type="text" id="node-input-latitude" placeholder="Latitude" disabled>
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-longitude">Longitude</label>
        <input type="text" id="node-input-longitude" placeholder="Longitude" disabled>
    </div>
    <div class="form-row" style="display:none">
        <label for="node-input-maxdists">Max Distance</label>
        <input type="text" id="node-input-maxdists" placeholder="Max Distance" disabled>
    </div>
        <link rel="stylesheet" href="s4c/css/leaflet.css" />
        <link rel="stylesheet" href="s4c/css/leaflet.draw.css" />
        <div id="node-input-map" style="width: 100%; height: 400px"></div>

    </div>

	     
    </div>

	
    <div class="form-row node-input-target-row" / >
        <div id="node-input-nodes-target-container-div" 
				style=" min-height: 100px;
				position: relative;   box-sizing: border-box; border-radius: 2px; 
				height: 180px;  border: 1px solid #ccc;overflow:hidden; ">
         <div style="box-sizing: border-box; 
				line-height: 20px; 
				font-size: 0.8em; 
				border-bottom: 1px solid #ddd; 
				height: 20px;">
              		<input type="checkbox" data-i18n="[title]status.label.selectAll" 
									id="node-input-target-node-checkbox-all" style="width: 30px; margin: 0 2px 1px 2px;">
              		<div style="display: inline-block;">
								<a id="node-input-target-sort-label" href="#" data-i18n="[title]status.label.sortByLabel"><span data-i18n="status.label.node"></span> <i class="node-input-status-sort-label-a fa fa-caret-down"></i><i class="node-input-status-sort-label-d fa fa-caret-up"></i></a>
								<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Name</strong></label>
					</div>
					<div style="position:absolute; left:40%; width: auto; display: inline-block;">
								<a id="node-input-target-sort-label2" href="#" data-i18n="[title]status.label.sortByLabel2"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
								<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Type</strong></label>
					</div>
              		<div style="position: absolute; right: 10px; width: auto; display: inline-block; text-align: right;">
								<a id="node-input-target-sort-type" href="#" data-i18n="[title]status.label.sortByType"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
								<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Context-Broker</strong></label>
					</div>

          </div>
          <div style="background: #fbfbfb; box-sizing: border-box; position:absolute; top:20px;bottom:0;left:0px;right:0px; 
				overflow-y: scroll; 
				overflow-x: hidden;">
                
				<ul id="node-input-nodes-target-container" style=" list-style-type:none; margin: 0;"></ul>
            
		</div>
        </div>
    </div>
    
</div>

<!-- ################### Second Tab ####################### -->

<div id="Value-based-search" class="tabcontent" style="display:none">

<div>
        <label style="font-size: 14px; padding-bottom:10px"><input type="checkbox" id="checkbox_aggr_out_value" checked /><strong> Aggregated by value types </strong></label>
    </div>

<div class="form-row iot-directory-form-row">
        <label style="width: auto" for="node-input-kind-of-search"><i class="icon-tag"></i>Retrieval</label>
        <select id="node-input-kind-of-search-select-tab2">
             <option value="map">Map search</option>
			 <option value="retrieve">Parametric Search</option>
         
        </select>
    </div>

	
    <div id="retrieve-wrapper-tab2" >
	    <!-- tipo:  value type -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-value-type-select-tab2"><i class="icon-tag"></i>Value type</label>
	        <select id="node-input-value-type-select-tab2">
	        </select>
	    </div>



	       <!--  tipo:  kind  value name -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-value-name-select-tab2"><i class="icon-tag"></i>Value name</label>
	        <select id="node-input-value-name-select-tab2">
	        </select>
	    </div>


	      <!-- tipo:  contextBroker   -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-context-broker-select-tab2"><i class="icon-tag"></i>Context broker</label>
	        <select id="node-input-context-broker-select-tab2">
	        </select>
   		 </div>

		<!-- tipo:  editable  -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-editable-select-tab2"><i class="icon-tag"></i>Editable</label>
	        <select id="node-input-editable-select-tab2">
	        </select>
   		 </div>

		<!-- tipo:  healthiness  -->
	     <div class="form-row iot-directory-form-row">
	        <label style="width: auto" for="node-input-healthiness-select-tab2"><i class="icon-tag"></i>Healthiness</label>
	        <select id="node-input-healthiness-select-tab2">
	        </select>
   		 </div>
	
		<!-- ricerca testuale -->
   		<div class="form-row iot-directory-form-row">
            <label for="node-input-text-search"><i class="icon-tag"></i> Search</label>
            <input type="text" id="node-input-text-search2-tab2" placeholder="Search">
       </div>
	   
	</div>


	
	<div id="target-wrapper-tab2" >

    <div class="form-row iot-directory-form-row">
	<label style="width: auto" for="node-input-map-select-tab2"><i class="icon-tag"></i>map</label>
	
        <link rel="stylesheet" href="s4c/css/leaflet.css" />
        <link rel="stylesheet" href="s4c/css/leaflet.draw.css" />
        <div id="node-input-map-tab2" style="width: 100%; height: 400px"></div>
	
    </div>

	     
    </div>

    <div class="form-row node-input-target-row" / >
        <div id="node-input-nodes-target-container-div" 
				style=" min-height: 100px;
				position: relative;   box-sizing: border-box; border-radius: 2px; 
				height: 180px;  border: 1px solid #ccc;overflow:hidden; ">
         <div style="box-sizing: border-box; 
				line-height: 20px; 
				font-size: 0.8em; 
				border-bottom: 1px solid #ddd; 
				height: 20px;">
              		<input type="checkbox" data-i18n="[title]status.label.selectAll" 
									id="node-input-target-node-checkbox-all-tab2" style="width: 30px; margin: 0 2px 1px 2px;">
              		<div style="display: inline-block;">
								<a id="node-input-target-sort-label-tab2" href="#" data-i18n="[title]status.label.sortByLabel"><span data-i18n="status.label.node"></span> <i class="node-input-status-sort-label-a fa fa-caret-down"></i><i class="node-input-status-sort-label-d fa fa-caret-up"></i></a>
								<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Value type</strong></label>
					</div>
					<div style="position:absolute; left:40%; width: auto; display: inline-block; text-align: right;">
								<a id="node-input-target-sort-device-tab2" href="#" data-i18n="[title]status.label.sortByLabel2"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
								<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Name</strong></label>
					</div>
				<!--	<div style="position: absolute; left: 60%; width: 50px; display: inline-block; text-align: right;">
								<a id="node-input-target-sort-name-tab2" href="#" data-i18n="[title]status.label.sortByType"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
					</div>-->
              		<div style="position: absolute; right: 10px; width: auto; display: inline-block; text-align: right;">
								<a id="node-input-target-sort-type-tab2" href="#" data-i18n="[title]status.label.sortByType"><i class="node-input-status-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-status-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="status.label.type"></span></a>
								<label style="width: auto; padding-left: 5px; font-size: 1.2em;"> <strong>Context-Broker</strong></label>
					</div>

          </div>
          <div style="background: #fbfbfb; box-sizing: border-box; position:absolute; top:20px;bottom:0;left:0px;right:0px; 
				overflow-y: scroll; 
				overflow-x: hidden;">
                
				<ul id="node-input-nodes-target-container-tab2" style=" list-style-type:none; margin: 0;"></ul>
            
		</div>
        </div>
    </div>
</div>



 

    
</script>

<script type="text/x-red" data-help-name="iot-directory-out">
    <p>Iot Directory In Description</p>
</script>







////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
//          iot-directory-link-in 
////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////





<script type="text/x-red" data-template-name="iot-directory-link-in">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row node-input-link-row"></div>
</script>

////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
//          iot-directory-link-out 
////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////



<script type="text/x-red" data-template-name="iot-directory-link-out">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row node-input-link-row"></div>
</script>


////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
//          iot-directory-link-in 
////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////


<script type="text/x-red" data-help-name="iot-directory-link-in">
    <p>Create virtual wires between flows.</p>
    <h3>Details</h3>
    <p>The node can be connected to any <code>iot-directory-link-out</code> node that exists on any tab.
       Once connected, they behave as if they were wired together.</p>
    <p>The wires between link nodes are only displayed when a link node is selected.
       If there are any wires to other tabs, a virtual node is shown that can be clicked
       on to jump to the appropriate tab.</p>
    <p><b>Note: </b>Links cannot be created going into, or out of, a subflow.</p>
</script>



////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
//          iot-directory-link-out
////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////



<script type="text/x-red" data-help-name="iot-directory-link-out">
    <p>Create virtual wires between flows.</p>
    <h3>Details</h3>
    <p>The node can be connected to any <code>iot-directory-link-in</code> node that exists on any tab.
       Once connected, they behave as if they were wired together.</p>
    <p>The wires between link nodes are only displayed when a link node is selected.
       If there are any wires to other tabs, a virtual node is show that can be clicked
       on to jump to the appropriate tab.</p>
    <p><b>Note: </b>Links cannot be created going into, or out of, a subflow.</p>
</script>



////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
//          iot-directory-link  all
////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////


<style>
#node-input-link-container {
    position: relative;
}
#node-input-link-container li {
    padding: 2px 5px;
    background: none;
    font-size: 0.8em;
    margin:0;
    white-space: nowrap;
}
#node-input-link-container li label {
    margin-bottom: 0;
    width: 100%;
}
#node-input-link-container li label input {
    vertical-align: top;
    width:15px;
    margin-right: 10px;
}
#node-input-link-container li:hover,
#node-input-link-container li:hover .node-input-target-node-sublabel {
    background: #f0f0f0;
}
.node-input-link-node-sublabel {
    position:absolute;
    right: 0px;
    padding-right: 10px;
    padding-left: 10px;
    font-size: 0.8em;
}
</style>

<script type="text/javascript">
(function() {

    function sortNodeList(nodeList,sortOn,sortOnSecond) {
        var currentSort = nodeList.data('currentSort');
        var currentSortOrder = nodeList.data('currentSortOrder');

        if (!currentSort) {
            currentSort = sortOn;
            currentSortOrder = 'a';
        } else {
            if (currentSort === sortOn) {
                currentSortOrder = (currentSortOrder === 'a'?'d':'a');
            } else {
                currentSortOrder = 'a';
            }
            currentSort = sortOn;
        }
        nodeList.data('currentSort',currentSort);
        nodeList.data('currentSortOrder',currentSortOrder);

        $("#node-input-link-container-div .fa").hide();
        $(".node-input-link-sort-"+currentSort+"-"+currentSortOrder).show();


        var items = nodeList.find("li").get();
        items.sort(function(a,b) {
            var labelA = $(a).find(".node-input-link-node-"+currentSort).text().toLowerCase();
            var labelB = $(b).find(".node-input-link-node-"+currentSort).text().toLowerCase();
            if (labelA < labelB) { return currentSortOrder==='a'?-1:1; }
            if (labelA > labelB) { return currentSortOrder==='a'?1:-1; }

            if (sortOnSecond) {
                labelA = $(a).find(".node-input-link-node-"+sortOnSecond).text().toLowerCase();
                labelB = $(b).find(".node-input-link-node-"+sortOnSecond).text().toLowerCase();
                if (labelA < labelB) { return currentSortOrder==='a'?-1:1; }
                if (labelA > labelB) { return currentSortOrder==='a'?1:-1; }
            }
            return 0;
        });
        $.each(items, function(i, li) {
            nodeList.append(li);
        });
    }
    function onEditPrepare(node,targetType) {
        if (!node.links) {
            node.links = [];
        }
        node.oldLinks = [];

        $('<div id="node-input-link-container-div" style="min-height: 100px;position: relative;   box-sizing: border-box; border-radius: 2px; height: 180px;  border: 1px solid #ccc;overflow:hidden; ">'+
            '    <div style="box-sizing: border-box; line-height: 20px; font-size: 0.8em; border-bottom: 1px solid #ddd; height: 20px;">'+
            '        <div style="display: inline-block;margin-left: 5px;"><a id="node-input-link-sort-label" href="#" data-i18n="[title]node-red:link.label.sortByLabel"><span data-i18n="node-red:link.label.node">name</span> <i class="node-input-link-sort-label-a fa fa-caret-down"></i><i class="node-input-link-sort-label-d fa fa-caret-up"></i></a></div>'+
            '        <div style="position: absolute; right: 10px; width: 50px; display: inline-block; text-align: right;"><a id="node-input-link-sort-type" href="#" data-i18n="[title]node-red:link.label.sortByFlow"><i class="node-input-link-sort-sublabel-a fa fa-caret-down"></i><i class="node-input-link-sort-sublabel-d fa fa-caret-up"></i> <span data-i18n="node-red:link.label.type">flow</span></a></div>'+
            '    </div>'+
            '    <div style="background: #fbfbfb; box-sizing: border-box; position:absolute; top:20px;bottom:0;left:0px;right:0px; overflow-y: scroll; overflow-x: hidden;">'+
            '        <ul id="node-input-link-container" style=" list-style-type:none; margin: 0;"></ul>'+
            '    </div>'+
            '</div>').appendTo('.node-input-link-row');

        var nodeList = $("#node-input-link-container");
        var candidateNodes = RED.nodes.filterNodes({type:targetType});
        var inSubflow = !!RED.nodes.subflow(node.z);
        candidateNodes.forEach(function(n) {
            if (inSubflow) {
                if (n.z !== node.z) {
                    return;
                }
            } else {
                if (!!RED.nodes.subflow(n.z)) {
                    return;
                }
            }
            var isChecked = false;

            isChecked = (node.links.indexOf(n.id) !== -1) || (n.links||[]).indexOf(node.id) !== -1;

            if (isChecked) {
                node.oldLinks.push(n.id);
            }

            var container = $('<li/>',{class:"node-input-link-node"});
            var row = $('<label/>',{for:"node-input-link-node-"+n.id}).appendTo(container);
            $('<input>',{type:"checkbox",class:"node-input-link-node-checkbox",id:"node-input-link-node-"+n.id})
                .data('node-id',n.id)
                .prop('checked', isChecked)
                .appendTo(row);
            container.on('mouseover',function(e) {
                n.highlighted = true;
                n.dirty = true;
                RED.view.redraw();
            });
            container.on('mouseout',function(e) {
                n.highlighted = false;
                n.dirty = true;
                RED.view.redraw();
            });
            var labelSpan = $('<span>');
            var label = n.name||n.id;
            var sublabel;
            var tab = RED.nodes.workspace(n.z);
            if (tab) {
                sublabel = tab.label||tab.id;
            } else {
                tab = RED.nodes.subflow(n.z);
                sublabel = "subflow : "+tab.name;
            }
            $('<span>',{class:"node-input-link-node-label",style:"white-space:nowrap"}).text(label).appendTo(row);
            if (sublabel) {
                $('<span>',{class:"node-input-link-node-sublabel"}).text(sublabel).appendTo(row);
            }
            container.appendTo(nodeList);
        });

        sortNodeList(nodeList,'sublabel','label');

        $("#node-input-link-sort-label").click(function(e) {
            e.preventDefault();
            sortNodeList(nodeList,'label');
        });

        $("#node-input-link-sort-type").click(function(e) {
            e.preventDefault();
            sortNodeList(nodeList,'sublabel');
        });
    }

    function resizeNodeList() {
        var rows = $("#dialog-form>div:not(.node-input-link-row)");
        var height = $("#dialog-form").height();
        for (var i=0;i<rows.size();i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-link-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        $("#node-input-link-container-div").css("height",height+"px");
    }

    function onEditSave(node) {
        node.links = [];
        $(".node-input-link-node-checkbox").each(function(n) {
            if ($(this).prop("checked")) {
                node.links.push($(this).data('node-id'));
            }
        });
        node.oldLinks.sort();
        node.links.sort();
        var nodeMap = {};
        var length = Math.max(node.oldLinks.length,node.links.length);
        for (var i=0;i<length;i++) {
            if (i<node.oldLinks.length) {
                nodeMap[node.oldLinks[i]] = nodeMap[node.oldLinks[i]]||{};
                nodeMap[node.oldLinks[i]].old = true;
            }
            if (i<node.links.length) {
                nodeMap[node.links[i]] = nodeMap[node.links[i]]||{};
                nodeMap[node.links[i]].new = true;
            }
        }
        var n;
        for (var id in nodeMap) {
            if (nodeMap.hasOwnProperty(id)) {
                n = RED.nodes.node(id);
                if (n) {
                    if (nodeMap[id].old && !nodeMap[id].new) {
                        // Removed id
                        i = n.links.indexOf(node.id);
                        if (i > -1) {
                            n.links.splice(i,1);
                        }
                    } else if (!nodeMap[id].old && nodeMap[id].new) {
                        // Added id
                        i = n.links.indexOf(id);
                        if (i === -1) {
                            n.links.push(node.id);
                        }
                    }
                }
            }
        }
    }

    function onAdd() {
        for (var i=0;i<this.links.length;i++) {
            var n = RED.nodes.node(this.links[i]);
            if (n && n.links.indexOf(this.id) === -1) {
                n.links.push(this.id);
            }
        }
    }

////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
//          iot-directory-link-in
////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////


    RED.nodes.registerType('iot-directory-link-in',{
        category: 'input',
        color:"#a6bbcf",//"#87D8CF",
        defaults: {
            name: {value:""},
            links: { value: [] }
        },
        inputs:0,
        outputs:1,
        category: 'S4CIoT',
        icon: "link-out.png",
        outputLabels: function(i) {
            return this.name||this._("IotLinkIn");
        },
        label: function() {
            return this.name||this._("IotLinkIn");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            onEditPrepare(this,"iot-directory-link-out");
        },
        oneditsave: function() {
            onEditSave(this);
        },
        onadd: onAdd,
        oneditresize: resizeNodeList
    });


    ////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////
//          iot-directory-link-out
////////////////////////////////////////////////////
////////////////////////////////////////////////////
////////////////////////////////////////////////////

    RED.nodes.registerType('iot-directory-link-out',{
        category: 'output',
        color:"#a6bbcf",//"#87D8CF",
        defaults: {
            name: {value:""},
            links: { value: []}
        },
        align:"right",
        inputs:1,
        outputs:0,
        icon: "link-out.png",
        category: 'S4CIoT',
        inputLabels: function(i) {
            return this.name||this._("IoTLinkOut");
        },
        label: function() {
            return this.name||this._("IotLinkOut");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            onEditPrepare(this,"iot-directory-link-in");
            
        },
        oneditsave: function() {
            onEditSave(this);
        },
        onadd: onAdd,
        oneditresize: resizeNodeList
    });
})();
</script>
