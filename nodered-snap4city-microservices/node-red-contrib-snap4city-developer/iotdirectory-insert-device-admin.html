<!--/* NODE-RED-CONTRIB-SNAP4CITY-DEVELOPER
   Copyright (C) 2018 DISIT Lab http://www.disit.org - University of Florence

   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU Affero General Public License as
   published by the Free Software Foundation, either version 3 of the
   License, or (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU Affero General Public License for more details.

   You should have received a copy of the GNU Affero General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>. */-->
<style>


.myAddButton {
	-moz-box-shadow:inset 0px 1px 0px 0px #ffffff;
	-webkit-box-shadow:inset 0px 1px 0px 0px #ffffff;
	box-shadow:inset 0px 1px 0px 0px #ffffff;
	background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #f9f9f9), color-stop(1, #e9e9e9));
	background:-moz-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
	background:-webkit-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
	background:-o-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
	background:-ms-linear-gradient(top, #f9f9f9 5%, #e9e9e9 100%);
	background:linear-gradient(to bottom, #f9f9f9 5%, #e9e9e9 100%);
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#f9f9f9', endColorstr='#e9e9e9',GradientType=0);
	background-color:#f9f9f9;
	-moz-border-radius:6px;
	-webkit-border-radius:6px;
	border-radius:6px;
	border:1px solid #dcdcdc;
	display:inline-block;
	cursor:pointer;
	color:#666666;
	font-family:Arial;
	font-size:12px;
	font-weight:bold;
	padding:6px 6px;
    margin-bottom: 3px;
    margin-top: 3px;
	text-decoration:none;
	text-shadow:0px 1px 0px #ffffff;
    
}
.myAddButton:hover {
	background:-webkit-gradient(linear, left top, left bottom, color-stop(0.05, #e9e9e9), color-stop(1, #f9f9f9));
	background:-moz-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
	background:-webkit-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
	background:-o-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
	background:-ms-linear-gradient(top, #e9e9e9 5%, #f9f9f9 100%);
	background:linear-gradient(to bottom, #e9e9e9 5%, #f9f9f9 100%);
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#e9e9e9', endColorstr='#f9f9f9',GradientType=0);
	background-color:#e9e9e9;
}
.myAddButton:active {
	position:relative;
	top:1px;
}
.myAddButton:focus {
	outline:0 !important;
    background-color:#e9e9e9;
}
    
    
.myCheckButton {
	background-color:#44c767;
	-moz-border-radius:28px;
	-webkit-border-radius:28px;
	border-radius:28px;
	border:1px solid #18ab29;
	display:inline-block;
	cursor:pointer;
	color:#ffffff;
	font-family:Arial;
	font-size:17px;
	padding:10px 25px;
    margin-bottom: 15px;
    margin-top: 15px;
	text-decoration:none;
	text-shadow:0px 1px 0px #2f6627;
}
.myCheckButton:hover {
	background-color:#5cbf2a;
}
.myCheckButton:active {
	position:relative;
	top:1px;
}
    
    
    /*################################*/
    

</style>

<!--
  Copyright 2013, 2016 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-help-name="device-registration-admin">

</script>




<script type="text/javascript">
  
    
    
    RED.nodes.registerType('device-registration-admin', {
        
        category: 'S4CIoT',
        color: //function() {
            //return nodeColor_a()|| '#a6bbcf';
      //}, 
        '#a6bbcf',
        defaults: {
            name: {
                value: ""
            },
            modcom: {
				required: true
			},
			motivation: {
				required: true
			},
			latitude: {
                value: 0.0,
                required: false,
                validate: RED.validators.number()
            },
            longitude: {
                value: 0.0,
                required: false,
                validate: RED.validators.number()
            },
            range: {
                value: "",
                required: false
            },
            maxdists: {
                value: 1,
                required: false,
                validate: RED.validators.number()
            },
            maxresults: {
                value: 100,
                required: false,
                validate: RED.validators.number()
            }
        },
      inputs: 0,
      outputs: 0,
      icon: "white-globe.png",
      label: function() {
        return this.name || "device-registration-admin";
      },
     
        
    oneditprepare: function() {
        isSuccess=0;
        var node = this;
        this._def.color= '#a6bbcf';
        console.log(this);
        console.log(this._def.color);
        isdone=false; 
        ischecked=false;
        
        allData=[];
        devicetype="";
        contextbroker= "";
        protocol= "";
        format= "";
        healthiness_criteria= "";
        healthiness_value= "";
        attributes=[];
        kind="";
        producer= "";
        frequency= "";
        
        k1= generateUUID_admin();
        k2= generateUUID_admin();
        
        $('#node-input-k-label-normal').hide();
        $('#node-input-k-label-sigfox').hide(); //in case no data received, so none of these appears, otherwise they will both appear

        
        current_model_index = 0;
        isedited=0;
                
        $("#node-dialog-ok").css('background','#FFFFFF').css('border-color','#A9A9A9');
        addAsMendatoryListener_a('node-input-name');
        addAsMendatoryListener_a('node-input-devicetype');
        addAsMendatoryListener_a('node-input-k1');
        addAsMendatoryListener_a('node-input-k2');
        //$('#node-dialog-ok').button("disable");
        
        var pos = $("#node-dialog-ok").position();
        var w= $("#node-dialog-ok").width();
        var h= $("#node-dialog-ok").height();
        coverDiv= document.createElement('div');
        coverDiv.style.position='absolute';
        coverDiv.style.top= pos.top+"px";
        coverDiv.style.left=pos.left+"px";
        coverDiv.style.width = w*2+"px";
        coverDiv.style.height = h*2+"px";
        coverDiv.style.background = "none";
        coverDiv.style.outline="none";
        coverDiv.style.opacity = "0%";
        
    
        console.log("Top: " + pos.top + " Left: " + pos.left+" width: "+w+"  height: "+h);
        
        var parentDiv= $("#node-dialog-ok").parents();
        console.log("parentNode " + parentDiv[0]);
        parentDiv[0].appendChild(coverDiv);
        //alert("Top: " + x.top + " Left: " + x.left);
        
        coverDiv.onclick= function() {
                
                console.log("here?");
                if (isdone){
                   $("#node-dialog-ok").simulate('click'); 
                }
                else{
                   //alert("Please fill in the empty fields. The required fields are marked with *"); 
                    alert("Please validate your device first by clicking on the 'Check' button"); 
                }
            
            };
        
        addonChangeListener_a('');
       
        
        
          
        map = L.map('node-input-map').setView([43.78, 11.23], 9);
            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            window.node_input_map = map;

            var mapLayers = {};

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            var editControl = new L.Control.Draw({
                draw: false,
                edit: {
                    remove: false,
                    featureGroup: drawnItems
                }
            });
            map.addControl(editControl);

            drawControl = new L.Control.Draw({
                remove: false,
                draw: {
                    position: 'topleft',
                    polyline: false,
                    marker: {
                        icon: new L.DivIcon({
                            iconSize: new L.Point(8, 8),
                            className: 'leaflet-div-icon leaflet-editing-icon test'
                        })
                    },
                    circlemarker: false,
                    circle: false,
                    polygon: false,
                    rectangle: false
                }
            });
            map.addControl(drawControl);

            L.control.layers(mapLayers, {
                'drawlayer': drawnItems
            }, {
                collapsed: true
            }).addTo(map);

            map.on(L.Draw.Event.CREATED, function(e) {
                something_Changed();
                var fence = e.layer;
                fence.nodeID = node.id;
                if (drawnItems.hasLayer(fence) == false) {
                    drawnItems.addLayer(fence);
                }

                drawControl.remove();

                markers = {};

                drawnItems.eachLayer(function(layer) {
                    markers[layer.nodeID] = layer.toGeoJSON();
                });

                $("#node-input-devicelatitude").val(markers[node.id].geometry.coordinates[1]);
                $("#node-input-devicelongitude").val(markers[node.id].geometry.coordinates[0]);
            });

            map.on('draw:edited', function(e) {
                
                something_Changed();
                var fences = e.layers;
                fences.eachLayer(function(fence) {
                    fence.shape = "geofence";
                    if (drawnItems.hasLayer(fence) == false) {
                        drawnItems.addLayer(fence);
                    }
                });

                markers = {};

                drawnItems.eachLayer(function(layer) {
                    markers[layer.nodeID] = layer.toGeoJSON();
                });

                $("#node-input-devicelatitude").val(markers[node.id].geometry.coordinates[1]);
                $("#node-input-devicelongitude").val(markers[node.id].geometry.coordinates[0]);
            });

           /* map.on('draw:deleted', function(e) {
                something_Changed();
                drawControl.addTo(map);
                $("#node-input-devicelatitude").val(0);
                $("#node-input-devicelongitude").val(0);
            });*/
        
            L.Control.RemoveAll = L.Control.extend(
                    {
                        options:
                        {
                            position: 'topleft',
                        },
                        onAdd: function (map) {
                            var controlDiv = L.DomUtil.create('div', 'leaflet-draw-toolbar leaflet-bar');
                            L.DomEvent
                                .addListener(controlDiv, 'click', L.DomEvent.stopPropagation)
                                .addListener(controlDiv, 'click', L.DomEvent.preventDefault)
                            .addListener(controlDiv, 'click', function () {
                                drawnItems.clearLayers();
                                    
                                    something_Changed();
                                    drawControl.addTo(map);
                                    $("#node-input-devicelatitude").val(0);
                                    $("#node-input-devicelongitude").val(0);
                            });

                            var controlUI = L.DomUtil.create('a', 'leaflet-draw-edit-remove', controlDiv);
                            controlUI.title = 'Delete';
                            controlUI.href = '#';
                            return controlDiv;
                        }
                    });
                var removeAllControl = new L.Control.RemoveAll();
                map.addControl(removeAllControl);

        var string = {value:"string",label:"string:"};
        var int = {value:"integer",label:"int:"};
        var float = {value:"float",label:"float:"};
        var supportedTypes = [string, int, float];

  
             /* $.ajax({
            url: "http://iotdirectory.snap4city.org/api/contextbroker.php?action=get_all_contextbroker",
            //url: "http://iotdirectory.snap4city.org/api/contextbroker.php?action=get_default",    
            type:"GET",
            async: false,
            dataType: "json",
            success: function(data) {
                if(data.status=='ok'){
                      
                    
                    
                    var contextBrokers = data.content;
                      for(var i = 0; i< contextBrokers.length; i++){
                          $("<option value=\"" + contextBrokers[i].name + "\">" + contextBrokers[i].name + "</option>").appendTo($("#node-input-contextbroker"));

                      }
                }
                else{
                    console.log(data.status);
                }
            },
            error: function(err) {
              console.log("error  in context broker is "+err);
            }
          }); */
      
        
         

        
        /*paramsValues={};
        datatype="";
        valuetype="";
        valueunits="";
            
        $.ajax({
            url: "http://iotdirectory.snap4city.org/api/device.php?action=get_param_values",
            type:"GET",
            async: true,
            dataType: "json",
            success: function(data) {
                console.log("paramsValue data: ");
                console.log(data);
                if(data.status=='ok'){
                    paramsValues=data;

                    var d= data.data_type;
                    for (var i=0; i<d.length; i++){
                        datatype+='<option value="'+d[i]+'">'+d[i]+'</option>';
                        }

                    console.log(datatype);

                    var t= data.value_type;
                    for (var i=0; i<t.length; i++){
                        valuetype+= '<option value="'+t[i]+'">'+t[i]+'</option>';  
                        }


                    console.log(valuetype);

                    var u =data.value_unit;
                    for( var i=0; i<u.length; i++){
                        valueunits+='<option value="'+u[i]+'">'+u[i]+'</option>';
                        }

                    console.log(valueunits);
            }
                else{
                   console.log(data.status); 
                }
            },
            error: function(err) {
              console.log("error in paramsValues is "+err);
            }
          });
   */
  
        
          $("#node-input-attrs-container").css('min-height','250px').css('min-width','450px').editableList({
          
            addButton: false,
            addItem: function(container,i,opt) {
            console.log("opt");
            console.log(opt);
            var attr = opt;
            if (!attr.hasOwnProperty('type')) {
              attr.type = 'string';
            }
            var row1 = $('<span/>').appendTo(container);
			var row2 = $('<span/>').appendTo(container);
			var row3 = $('<span/>').appendTo(container);
			var row4 = $('<span/>').appendTo(container);
                
            var valueName= "";
            var dataType= "";
            var valueType= "";
            var valueUnit= "";
                
           
            valueName= opt.value_name;
            if(typeof valueName != "undefined")
               {dataType= opt.type;
                valueType= opt.value_type;
                valueUnit= opt.value_unit;
               }
            else{
               valueName=""; 
            }
            
            console.log(valueName+" "+ dataType+" "+ valueType+" "+ valueUnit);
                
           row1.html('<label for="valuetype" style="width:10%; margin-left: 5px; text-align: left;">value name</label>&nbsp&nbsp <input class=\"node-input-attr-name\" name=\"value_type\" value="'+valueName+'"  onchange=\"something_Changed()\" style="width:350px; margin-left: 5px; text-align: left;">' );
           row2.html('&nbsp&nbsp&nbsp<label for="valuetype" style="width:10%; margin-left: 5px; text-align: left;">type</label>&nbsp&nbsp<input class=\"node-input-attr-datatype\" name=\"data_type\" value="'+dataType+'"  onchange=\"something_Changed()\" style="width:10%; text-align: left;"><br>');
           row3.html('<label for="valuetype style="width:10%; margin-left: 5px; text-align: left;">value type</label> <input  class=\"node-input-attr-valuetype\" name=\"value_type\" value="'+valueType+ '"  onchange=\"something_Changed()\" style="width:30%; margin-left: 5px; text-align: left;">');

           row4.html('&nbsp&nbsp&nbsp<label for="valueunit" style="width:10%; margin-left: 5px; text-align: left;">value unit</label> <input  class=\"node-input-attr-valueunit\" name=\"value_unit\" value="'+ valueUnit + '"  onchange=\"something_Changed()\" style="width:20%; margin-left: 5px; text-align: left;">');
	
            valueName=" ";
            dataType=" ";
            valueType=" ";
            valueUnit=" ";
            

          },
          removeItem: function(opt) {
            var attrs = $("#node-input-attrs-container").editableList('items');
            attrs.each(function(i) { $(this).find(".node-input-attr-index").html(i+1); });
            something_Changed();
          },
          removable: true
        });
  
        //console.log(this.attrs)
  
        if (typeof this.attrs != "undefined") {
            for (var i=0;i < this.attrs.length;i++) {
              var attr = this.attrs[i];
              $("#node-input-attrs-container").editableList('addItem',attr);
            }
        }
        
        
        $.ajax({    
            url: "https://iot-app.snap4city.org/iotdirectory/iot2/api/model.php?action=get_models",    
            type:"GET",
            async: false,
            dataType: "json",
            success: function(data) {
                if(data.status=='ok'){
                    console.log(data);
                    allData=data.content; 
                    
                    var models = data.content;
                    for(var i = 0; i< models.length; i++){
                          $("<option value=\"" + models[i].id + "\">" + models[i].name + "</option>").appendTo($("#node-input-model"));

                      }
                    console.log("allData.length " +allData.length);
                    mmodelChanged();

                }
                else{
                    console.log(data.status);
                }
            },
            error: function(err) {
              console.log("error  in context broker is "+err);
            }
          });
        
        
     },
      
        oneditsave: function() {
        console.log(" in editsave, is done is: "+ isdone);
        if(!isdone) {return;}
        console.log("It seems that isdone is true so here I am");
          
        send_To_Server(this.id);
       
		
      },
      oneditresize: function() {
          if (window.node_input_map) {
              window.node_input_map.invalidateSize(true);
          }
          
       
          
        var pos = $("#node-dialog-ok").position();
        var w= $("#node-dialog-ok").width();
        var h= $("#node-dialog-ok").height();
          
        var parentDiv= $("#node-dialog-ok").parents();  
        parentDiv[0].removeChild(coverDiv);  
          
        coverDiv= document.createElement('div');
        coverDiv.style.id='coverDiv';
        coverDiv.style.position='absolute';
        coverDiv.style.top= pos.top+"px";
        coverDiv.style.left=pos.left+"px";
        coverDiv.style.width = w*2+"px";
        coverDiv.style.height = h*2+"px";
        coverDiv.style.background = "none";
        coverDiv.style.outline = "none";
        coverDiv.style.opacity = "0%";
        
    
        console.log("Top: " + pos.top + " Left: " + pos.left+" width: "+w+"  height: "+h);
        
        
        console.log("parentNode " + parentDiv[0]);
        parentDiv[0].appendChild(coverDiv);
        //alert("Top: " + x.top + " Left: " + x.left);
        coverDiv.onclick= function() {
                
                console.log("here?");
                if (isdone){
                   $("#node-dialog-ok").simulate('click'); 
                }
                else{
                   //alert("Please fill in the empty fields. The required fields are marked with *"); 
                    alert("Please validate your device first by clicking on the 'Check' button"); 
                }
            
            };
          
  
          
      },
 
    });
    
    function addAsMendatoryListener_a(fieldId){
				$('#'+fieldId).change(function(){
					 checkIfAllMendatoriesOk_a();
				});
			}
    
    function checkIfAllMendatoriesOk_a(){
        if(typeof ($("#node-input-name").val()) != "undefined" && typeof ($("#node-input-model").val()) != "undefined" )
        {
            console.log($("#node-input-name").val());
            console.log($("#node-input-devicetype").val());
            console.log($("#node-input-model").val());
            console.log($("#node-input-k1").val());
            console.log($("#node-input-k2").val());
            
            if($("#node-input-name").val().length==0 || $("#node-input-devicetype").val().length==0 || $("#node-input-model").val().length==0 || $('#node-input-k1').val()=="" || $('#node-input-k2').val()==""){
                $("#node-dialog-ok").css('background','#FFFFFF').css('border-color','#A9A9A9');  
                ischecked=false;
                isdone=false;

              }
            else{
                $("#node-dialog-ok").css('background','#FFFFFF').css('border-color','#A9A9A9'); 
                ischecked=true;
                isdone=false;


            }
    }
    }
    
    function addFunction_a(){
        var box= $("#node-input-attrs-container")
        box.editableList('addItem');
        something_Changed();
        
    }
    
    function addAttributes_a(attrs){
        var box= $("#node-input-attrs-container")
        box.editableList('addItem',attrs);
        something_Changed();
        
    }

    
    function checkFunction_a(){
        console.log("checking");
        if(ischecked){
            check_Request();
        }
        else{
            alert("Please fill in the empty fields. The required fields are marked with *");
        }
        
    }
    
     function addonChangeListener_a(fieldId){
				$('#'+fieldId).change(function(){
					 something_Changed();
				});
			}
    
    function something_Changed(){
        $("#node-dialog-ok").css('background','#FFFFFF').css('border-color','#A9A9A9');
        isdone=false;
        console.log("something_changed");
        isedited=1;
    }
    
    function name_Changed(){
        $("#node-dialog-ok").css('background','#FFFFFF').css('border-color','#A9A9A9');
        isdone=false;
        console.log("something_changed");
    }
    
    
    
    function mmodelChanged(){
        console.log("isedited "+isedited);
        console.log(current_model_index);
        console.log($('#node-input-model').prop('selectedIndex'));
        
        if($('#node-input-model').prop('selectedIndex') != current_model_index){
           if(isedited==1){
            var conf = confirm('By changing your model selection, all your modifications will be lost. Are you sure you want to select a different device model? ');
             if(!conf){
                     $('#node-input-model').prop('selectedIndex',current_model_index);
                    // reset the select back to previous
                    return;
             }
        }
        }
        current_model_index=$('#node-input-model').prop('selectedIndex');

        
        $("#node-dialog-ok").css('background','#FFFFFF').css('border-color','#A9A9A9');
        isdone=false;
        console.log("model changeeeeeeeeeeeeed");
        console.log("allData.length "+allData);
        
        if(allData.length >0){
            var selectedModel= $("#node-input-model").val();
            console.log("selectedModel: "+selectedModel);
            
            for(var i=0; i<allData.length; i++){
                
                
                if(allData[i].id==selectedModel){
                    console.log("here");
                                      
                    devicetype=allData[i].devicetype;
                    contextbroker= allData[i].contextbroker;
                    protocol= allData[i].protocol;
                    format= allData[i].format;
                    healthiness_criteria= allData[i].healthiness_criteria;
                    healthiness_value= allData[i].healthiness_value;
                    attributes=JSON.parse(allData[i].attributes);
                    kind=allData[i].kind;
                    producer= allData[i].producer;
                    frequency= allData[i].frequency;
                    
                    $('#node-input-devicetype').val(devicetype);
                    $('#node-input-contextbroker').val(contextbroker);
                    $('#node-input-deviceprotocol').val(protocol);
                    $('#node-input-devicekind').val(kind);
                    $('#node-input-deviceformat').val(format);
                    $('#node-input-deviceproducer').val(producer);
                    $('#node-input-healthinesscriteria').val(healthiness_criteria);
                    $('#node-input-healthinessvalue').val(healthiness_value);
                    $('#node-input-frequency').val(frequency);
                
                    $("#node-input-attrs-container").empty();
                    something_Changed();
                    
                    for(var j=0; j<attributes.length; j++){
                        console.log("attribute[j]"+attributes[j]);
                        
                        addAttributes_a(attributes[j]);
                    }
                     
                    
                
                    break;
                }
            }
            
            if(selectedModel=="5")//SigFox
                {
                    $('#node-input-k1').val("");
                    $('#node-input-k2').val("");
                    $('#node-input-k-label-normal').hide();
                    $('#node-input-k-label-sigfox').show();
                    
                    $('#node-input-k1').removeAttr('disabled');
                    $('#node-input-k2').removeAttr('disabled');
                }
            else{
                
                    $('#node-input-k1').val(k1);
                    $('#node-input-k2').val(k2);
                    $('#node-input-k-label-normal').show();
                    $('#node-input-k-label-sigfox').hide();
                
                    $('#node-input-k1').attr({'disabled': 'disabled'});
                    $('#node-input-k2').attr({'disabled': 'disabled'});

            }
        }
        
        setTimeout(function(){ 
            disableAll_a(true);
            $("#checkboxdisable").prop('checked',true);
                             }, 500);
        
        isedited=0;
       
    }
    
    function nodeColor_a(){
        if (isSuccess==1){
                return '#87A980';
            }
            else if(isSuccess==-1){
                return '#E9967A';
            }
            else{
                return '#a6bbcf';
            }
    }
    
    function disable_a(){
        
        var inputs = document.getElementsByTagName('input');
        var len = inputs.length;
        console.log(inputs);

        for (var i = 0; i < len; i++) {
            inputs[i].disabled = true;
        }
        
        var selects = document.getElementsByTagName('select');
        var len = selects.length;
        console.log(selects);

        for (var i = 0; i < len; i++) {
            selects[i].disabled = true;
        }
        
            }
    
    function disableAll_a(dodisable){
        if(dodisable==true){ 
            
            $('#node-input-devicetype').attr({'disabled': 'disabled'});
            $('#node-input-contextbroker').attr({'disabled': 'disabled'});
            $('#node-input-deviceprotocol').attr({'disabled': 'disabled'});
            $('#node-input-devicekind').attr({'disabled': 'disabled'});
            $('#node-input-deviceformat').attr({'disabled': 'disabled'});
            $('#node-input-deviceproducer').attr({'disabled': 'disabled'});
            $('#node-input-healthinesscriteria').attr({'disabled': 'disabled'});
            $('#node-input-healthinessvalue').attr({'disabled': 'disabled'});
            $('#node-input-frequency').attr({'disabled': 'disabled'});
            $('#addbutton').attr({'disabled': 'disabled'});
            
            $('#node-input-attrs-container').find('input').each(function () {
                 $(this).attr({'disabled': 'disabled'});   
                });
            
        }
        else{
            
             $('#node-input-devicetype').removeAttr('disabled');
            $('#node-input-contextbroker').removeAttr('disabled');
            $('#node-input-deviceprotocol').removeAttr('disabled');
            $('#node-input-devicekind').removeAttr('disabled');
            $('#node-input-deviceformat').removeAttr('disabled');
            $('#node-input-deviceproducer').removeAttr('disabled');
            $('#node-input-healthinesscriteria').removeAttr('disabled');
            $('#node-input-healthinessvalue').removeAttr('disabled');
            $('#node-input-frequency').removeAttr('disabled');
            $('#addbutton').removeAttr('disabled');
            
            $('#node-input-attrs-container').find('input').each(function () {
                 $(this).removeAttr('disabled');
                });
        }
    }
    
    
    function checkboxclicked_a(){
        var is_checked= $("#checkboxdisable").prop("checked");
                console.log("is_checked "+is_checked);
        if (is_checked){
            disableAll_a(true);
        }
        else{
            disableAll_a(false);
        }
    }
    
    function send_To_Server(id){
         var attrs = $("#node-input-attrs-container").editableList('items');
        var attrset;
        var node = this;
        node.attrs= [];
        attrs.each(function(i) {
          var attr = $(this);
          var r = {};
       //   r.valuename = attr.find(".node-input-attr-name").typedInput('value');
       //   r.datatype = attr.find(".node-input-attr-name").typedInput('type');
		  r.valuename = document.getElementsByClassName("node-input-attr-name")[i].value; 
          r.datatype = document.getElementsByClassName("node-input-attr-datatype")[i].value; 
		  r.valuetype = document.getElementsByClassName("node-input-attr-valuetype")[i].value; 
		  r.valueunit = document.getElementsByClassName("node-input-attr-valueunit")[i].value;

		  console.log(r);
          if (r.datatype && r.valuename && r.valuetype && r.valueunit){
              node.attrs.push(r);
          }
        });
       console.log(node.attrs);
        console.log(node);
	           var mynewAttributes = [];
			  var editparam = '';
			   if ($("#node-input-devicekind").val()=='sensor')
			   {
				editparam = "0";
				} else {
				editparam = "1";
			};

			
        
          for(var i = 0; i < node.attrs.length; i++){
            var newatt= {
              value_name: node.attrs[i].valuename,
              data_type: node.attrs[i].datatype,
			  value_type: node.attrs[i].valuetype,
			  editable: editparam,
			  value_unit:node.attrs[i].valueunit,
			  healthiness_criteria:"refresh_rate",
			  healthiness_value:"300"
			  };
              mynewAttributes.push(newatt);
          }
		  

          try{
              var accesstoken=  "";
              console.log("in retrieving access token");
                console.log("this.id "+ id);
              $.ajax({
                            url: "deviceregistration/"+id,
                            type:"GET",
                            async: false,
                            success: function(resp) {
                                console.log(resp);
                                accesstoken = resp.accessToken;
                                
                                
                                 var payload = {
                                               action: "insert",
                                               attributes: JSON.stringify(mynewAttributes),
                                               id:  $("#node-input-name").val(),
                                               type: $("#node-input-devicetype").val(),
                                               kind: $("#node-input-devicekind").val(),
                                               contextbroker: $("#node-input-contextbroker").val(),
                                               protocol:$("#node-input-deviceprotocol").val(),
                                               format: $("#node-input-deviceformat").val(),// nameformat,
                                               healthiness_criteria: $("#node-input-healthinesscriteria").val(),
                                               healthiness_value: $("#node-input-healthinessvalue").val(),
                                               mac: "",
                                               model: "",
                                               producer: $("#node-input-deviceproducer").val(),
                                               latitude: $("#node-input-devicelatitude").val(),
                                               longitude: $("#node-input-devicelongitude").val(),
                                               visibility: "private",
                                               owner: "marco",
                                               frequency: $("#node-input-frequency").val(),
                                               nodered:"yes",
                                                token: accesstoken,
                                                k1: $("#node-input-k1").val(),
                                                k2: $("#node-input-k2").val()
                                        };
                                
                                        $.ajax({
                                                url:  "https://iotdirectory.snap4city.org/api/device.php",
                                                type:"POST",
                                                data: payload,
                                                dataType: "json",
                                                success: function (data) {
                                                    console.log("success"  + JSON.stringify(data));
                                                    if(data.status=="ok"){
                                                          alert("Your device registration has been done!"); 
                                                          isdone=true;
                                                          isSuccess=1; 
                                                     }
                                                    else{
                                                         alert("Your device registration is not valid. "+ data.msg +" Please try again!"); 
                                                         isdone=false;
                                                         isSuccess=-1;
                                                    }

                                                    if(isdone){
                                                       $("#node-dialog-ok").css('background','#A81A31').css('border-color','#A81A31'); 
                                                    }
                                                },
                                                error: function (data) {
                                                    console.log("error");
                                                    console.log(data);
                                            
                                                    alert("Your device registration has failed! please try again"); 
                                                   
                                                    console.log("Ko result: " + JSON.stringify(data));
                                                    isdone=false;
                                                    isSuccess=-1;

                                                }
                                              }); 
                                

                            },
                            error: function(jqXHR,textStatus,errorThrown) {
                                console.log("ERROR");
                            }
                        });
                
                  
                  
              
             
          }
        catch(err){
             console.log("error creating the token "+ err);
               
    }
          
		  
		  //console.log(payload);

           
    }
    
     function check_Request(){
        
			
         var payload = {
             action:'exist_device',
             id:  $("#node-input-name").val(),   
             contextbroker: $("#node-input-contextbroker").val()
          };


           $.ajax({
            url:  "https://iotdirectory.snap4city.org/api/device.php",
            type:"GET",
            data: payload, //JSON.stringify(payload),
            //dataType: "json",
            success: function (data) {
                console.log("success");
                console.log(data);
                if(data.status=='ok' ) {
                    if(data.content==0){
                        alert("Your device registration is valid, you can proceed.");
                        isdone=true;
                        isSuccess=1;
                    }
                    else{
                         alert("Your device registration is not valid. The device name already exists, please choose another one and try again!");     
                        isdone=false;
                        isSuccess=-1;
                    }
                }
                
                else{
                
                alert("An error occured, please try again later");     
                isdone=false;
                isSuccess=-1;
				} 
                if(isdone){
                   $("#node-dialog-ok").css('background','#A81A31').css('border-color','#A81A31'); 
                }
            },
            error: function (data) {
                alert("An error occured please try again later"); 
                    
                console.log("Ko result: " + JSON.stringify(data));
                isdone=false;
                isSuccess=-1;
            }
          }); 
    }
    
    function generateUUID_admin() { // Public Domain/MIT
    var d = new Date().getTime();
    if (typeof performance !== 'undefined' && typeof performance.now === 'function'){
        d += performance.now(); //use high-precision timer if available
    }
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = (d + Math.random() * 16) % 16 | 0;
        d = Math.floor(d / 16);
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });

    }
    
       
       
    
  </script>
  
  
  <script type="text/x-red" data-template-name="device-registration-admin">
     <div>
        <label style="font-size: 14px; padding-bottom:10px"><input type="checkbox" id="checkboxdisable" onclick="checkboxclicked_a()" checked /><strong> Disable editing </strong></label>
    </div>
     
     <div class="form-row" id="child">
        <label for="node-input-name"><i class="fa"></i> Device Name<sup><b>*</b></sup>:</label>
        <input type="text" id="node-input-name" onchange="name_Changed()">
    </div>
    <div class="form-row">
      <label for="node-input-model"><i class="fa"></i>Model</label>
      <select id="node-input-model" onchange="mmodelChanged()">
      </select>
    </div>
    <div class="form-row">
      <label for="node-input-devicetype"><i class="fa"></i>Device Type<sup><b>*</b></sup>:</label>
      <input type="text" id="node-input-devicetype" onchange="something_Changed()" >
    </div>
 
	    <div class="form-row">
      <link rel="stylesheet" href="s4c/css/leaflet.css" />
      <link rel="stylesheet" href="s4c/css/leaflet.draw.css" />
      <div id="node-input-map" style="height: 400px"></div>
    </div>
    <div class="form-row">
      <label for="node-input-contextbroker"><i class="fa"></i>Context Broker</label>
      <input  type="text" id="node-input-contextbroker" onchange="something_Changed()" >
    </div>
    <div class="form-row">
      <label for="node-input-deviceprotocol"><i class="fa"></i>Protocol</label>
      <input type="text" id="node-input-deviceprotocol" onchange="something_Changed()"  >
    </div>
    <div class="form-row">
      <label for="node-input-devicekind"><i class="fa"></i>Kind</label>
      <input type="text" id="node-input-devicekind" onchange="something_Changed()" >
    </div>
  <div class="form-row">
      <label for="node-input-deviceformat"><i class="fa"></i>Format</label>
      <input type="text" id="node-input-deviceformat" onchange="something_Changed()" >
    </div>
 
    <div class="form-row" style="display:none" >
      <label for="node-input-devicemac"><i class="fa"></i>MAC</label>
      <input type="text" id="node-input-devicemac" onchange="something_Changed()" >
    </div>
    <div class="form-row">
      <label for="node-input-deviceproducer"><i class="fa"></i>Producer</label>
      <input type="text" id="node-input-deviceproducer" onchange="something_Changed()" >
    </div>
	<div class="form-row">
      <label for="node-input-healthinesscriteria"><i class="fa"></i>Healthiness criteria</label>
      <input type="text" id="node-input-healthinesscriteria" onchange="something_Changed()" >
    </div>
	<div class="form-row">
      <label for="node-input-healthinessvalue"><i class="fa"></i>Healthiness value</label>
      <input type="text" id="node-input-healthinessvalue" onchange="something_Changed()" >
    </div>
	<div class="form-row">
      <label for="node-input-frequency"><i class="fa"></i>Frequency</label>
      <input type="text" id="node-input-frequency" onchange="something_Changed()" >
    </div>
    <div class="form-row" style="display:none">
      <label for="node-input-devicelatitude"><i class="fa"></i>Device Latitude</label>
      <input type="text" id="node-input-devicelatitude" disabled>
    </div>
    <div class="form-row" style="display:none">
      <label for="node-input-devicelongitude"><i class="fa"></i>Device Longitude</label>
      <input type="text" id="node-input-devicelongitude" disabled>
    </div>
    
    <div class="form-row" style="margin-top:20px">
      <label for="node-input-k1"><i class="fa"></i>Key 1 <sup><b>*</b></sup></label>
      <input type="text" id="node-input-k1" disabled>
    </div>
    <div class="form-row">
      <label for="node-input-k2"><i class="fa"></i>Key 2 <sup><b>*</b></sup></label>
      <input type="text" id="node-input-k2" disabled>
    </div>
	<div>
      <p id="node-input-k-label-normal" style="font-size:12px; color:#808080"><i class="fa"></i>These keys have been generated automatically for your device. Keep track of them. Details on <a style="font-size:12px; align-left: " href= "https://www.snap4city.org/drupal/node/76">info</a> </p>
    </div>
    <div>
      <p id="node-input-k-label-sigfox" style="font-size:12px; color:#808080"><i class="fa"></i>Generate in your SigFox server the keys and report them here. Details on <a style="font-size:12px; align-left: " href= "https://www.snap4city.org/drupal/node/76">info</a> </p>
    </div>

    <div class="form-row node-input-attrs-container-row">
      <label for="node-input-attrs-container"><i class="fa"></i> Value:</label>
      <button id="addbutton" class="myAddButton" onclick="addFunction_a()"><b>+</b> add</button>
      <ol id="node-input-attrs-container"></ol>
    </div>
    
    <div>
      <button id="checkbutton" class="myCheckButton" onclick="checkFunction_a()">Check!</button>
    </div>
    
    <div id="done-cover" width="0px" height="0px></div>

    
    
  </script>

  <script type="text/javascript" src="s4c/js/leaflet.js"></script>
  <script type="text/javascript" src="s4c/js/leaflet.draw.js"></script>
  
  
  
