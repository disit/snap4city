/**
 * Copyright OpenJS Foundation and other contributors, https://openjsf.org/
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
!function(){var o;!window.MSInputMethodContext||!document.documentMode||(window.DOMTokenList.prototype.toggle=function(e,t){1===arguments.length&&(t=!this.contains(e)),this[t?"add":"remove"](e)},"classList"in SVGElement.prototype||Object.defineProperty(SVGElement.prototype,"classList",Object.getOwnPropertyDescriptor(HTMLElement.prototype,"classList")),"children"in SVGElement.prototype||Object.defineProperty(SVGElement.prototype,"children",Object.getOwnPropertyDescriptor(HTMLElement.prototype,"children")),Array.from=function(){if(1<arguments.length)throw new Error("Node-RED's IE11 Array.from polyfill doesn't support multiple arguments");var e=arguments[0],t=[];if(e.forEach)e.forEach(function(e){t.push(e)});else for(var o=0;o<e.length;o++)t.push(arrayList[o]);return t},0===new Set([0]).size&&(o=Set,(Set=function(e){var t=new o;return e&&e.forEach(t.add,t),t}).prototype=o.prototype,Set.prototype.constructor=Set))}(),jQuery.propHooks.disabled={set:function(e,t){e.disabled!==t&&((e.disabled=t)?$(e).trigger("disabled"):$(e).trigger("enabled"))}};var RED=function(){function n(){p.reportProgress(RED._("event.loadPlugins"),10),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"plugins",success:function(e){p.reportProgress(RED._("event.loadPlugins"),13),RED.i18n.loadPluginCatalogs(function(){var n,e;n=function(){p.reportProgress(RED._("event.loadPalette"),20),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"nodes",success:function(e){RED.nodes.setNodeList(e),p.reportProgress(RED._("event.loadNodeCatalogs"),25),RED.i18n.loadNodeCatalogs(function(){s(t)})}})},p.reportProgress(RED._("event.loadPlugins",{count:""}),17),e=localStorage.getItem("editor-language")||RED.i18n.detectLanguage(),$.ajax({headers:{Accept:"text/html","Accept-Language":e},cache:!1,url:"plugins",success:function(e){var o=e.trim().split(/(?=<!-- --- \[red-plugin:\S+\] --- -->)/),i=(o.length,function(){var e,t;0===o.length?n():(e=o.shift(),t=i,a(e,/<!-- --- \[red-plugin:(\S+)\] --- -->/.exec(e.trim()),"#red-ui-editor-plugin-configs",t))});i()}})})}})}function a(e,t,n,a){var r;a=a||function(){},t?(r=t[1],RED._loadingModule=r):r="unknown";try{var s=!1,d=$("<div>"+e+"</div>"),o=d.find("script"),l=o.length;o.each(function(e,t){var o,i=$(t).attr("src");i&&!/^\s*(https?:|\/|\.)/.test(i)?($(t).remove(),(o=document.createElement("script")).onload=function(){0===--l&&($(n).append(d),delete RED._loadingModule,a())},"module"===$(t).attr("type")&&(o.type="module"),$(n).append(o),o.src=RED.settings.apiRootUrl+i,s=!0):((/\/ace.js$/.test(i)||/\/ext-language_tools.js$/.test(i))&&(console.warn("Blocked attempt to load",i,"by",r),$(t).remove()),l--)}),s||($(n).append(d),delete RED._loadingModule,a())}catch(e){RED.notify(RED._("notification.errors.failedToAppendNode",{module:r,error:e.toString()}),{type:"error",timeout:1e4}),console.log("["+r+"] "+e.toString()),delete RED._loadingModule,a()}}function r(e,t){a(e,/<!-- --- \[red-module:(\S+)\] --- -->/.exec(e.trim()),"#red-ui-editor-node-configs",t)}function s(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"icons",success:function(e){RED.nodes.setIconSets(e),t&&t()}})}function t(){p.reportProgress(RED._("event.loadNodes",{count:""}),30);var e=localStorage.getItem("editor-language")||RED.i18n.detectLanguage();$.ajax({headers:{Accept:"text/html","Accept-Language":e},cache:!1,url:"nodes",success:function(e){var t=e.trim().split(/(?=<!-- --- \[red-module:\S+\] --- -->)/),o=t.length,i=function(){p.reportProgress(RED._("event.loadNodes",{count:o-t.length+"/"+o}),30+(o-t.length)/o*40),0===t.length?($("#red-ui-editor").i18n(),$("#red-ui-palette > .red-ui-palette-spinner").hide(),$(".red-ui-palette-scroll").removeClass("hide"),$("#red-ui-palette-search").removeClass("hide"),RED.settings.theme("projects.enabled",!1)?RED.projects.refresh(function(t){d(function(){RED.sidebar.info.refresh();var e=!1;t||(RED.menu.setDisabled("menu-item-projects-open",!0),RED.menu.setDisabled("menu-item-projects-settings",!0),!1===t||(e=!0)),l(e)})}):d(function(){RED.sidebar.info.refresh(),l()})):r(t.shift(),i)};i()}})}function d(o){p.reportProgress(RED._("event.loadFlows"),80),$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(e){if(e){var t=window.location.hash;RED.nodes.version(e.rev),p.reportProgress(RED._("event.importFlows"),90);try{RED.nodes.import(e.flows),RED.nodes.dirty(!1),RED.view.redraw(!0),/^#flow\/.+$/.test(t)&&RED.workspaces.show(t.substring(6),!0),0===RED.workspaces.active()&&0<RED.workspaces.count()&&RED.workspaces.show(RED.nodes.getWorkspaceOrder()[0])}catch(e){console.warn(e),RED.notify(RED._("event.importError",{message:e.message}),{fixed:!0,type:"error"})}}o()}})}function l(t){var n={};RED.comms.subscribe("notification/#",function(e,t){var o,i=e.split("/")[1];if("runtime-deploy"!==i&&"node"!==i)return"project-update"===i?(p.start(RED._("event.loadingProject"),0),RED.nodes.clear(),RED.history.clear(),RED.view.redraw(!0),void RED.projects.refresh(function(){d(function(){var e=RED.projects.getActiveProject(),e={"change-branch":RED._("notification.project.change-branch",{project:e.git.branches.local}),"merge-abort":RED._("notification.project.merge-abort"),loaded:RED._("notification.project.loaded",{project:t.project}),updated:RED._("notification.project.updated",{project:t.project}),pull:RED._("notification.project.pull",{project:t.project}),revert:RED._("notification.project.revert",{project:t.project}),"merge-complete":RED._("notification.project.merge-complete")}[t.action];p.end(),RED.notify($("<p>").text(e)),RED.sidebar.info.refresh()})})):void(t.text?(t.default=t.text,e=RED._(t.text,t),o={type:t.type,fixed:void 0===t.timeout,timeout:t.timeout,id:i},"runtime-state"===i&&(RED.events.emit("runtime-state",t),"safe-mode"===t.error?o.buttons=[{text:RED._("common.label.close"),click:function(){n[i].hideNotification()}}]:"missing-types"===t.error?(e+="<ul><li>"+t.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.projects.getActiveProject()?o.buttons=[{text:RED._("notification.label.manage-project-dep"),click:function(){n[i].hideNotification(),RED.projects.settings.show("deps")}}]:o.buttons=[{text:RED._("common.label.close"),click:function(){n[i].hideNotification()}}]):"missing-modules"===t.error?(e+="<ul><li>"+t.modules.map(function(e){return RED.utils.sanitize(e.module)+(e.error?" - <small>"+RED.utils.sanitize(""+e.error)+"</small>":"")}).join("</li><li>")+"</li></ul>",o.buttons=[{text:RED._("common.label.close"),click:function(){n[i].hideNotification()}}]):"credentials_load_failed"===t.error?RED.settings.theme("projects.enabled",!1)?RED.user.hasPermission("projects.write")&&(o.buttons=[{text:RED._("notification.project.setupCredentials"),click:function(){n[i].hideNotification(),RED.projects.showCredentialsPrompt()}}]):o.buttons=[{text:RED._("common.label.close"),click:function(){n[i].hideNotification()}}]:"missing_flow_file"===t.error||"missing_package_file"===t.error?RED.user.hasPermission("projects.write")&&(o.buttons=[{text:RED._("notification.project.setupProjectFiles"),click:function(){n[i].hideNotification(),RED.projects.showFilesPrompt()}}]):"project_empty"===t.error?RED.user.hasPermission("projects.write")&&(o.buttons=[{text:RED._("notification.project.no"),click:function(){n[i].hideNotification()}},{text:RED._("notification.project.createDefault"),click:function(){n[i].hideNotification(),RED.projects.createDefaultFileSet()}}]):"git_merge_conflict"===t.error&&(RED.nodes.clear(),RED.sidebar.versionControl.refresh(!0),RED.user.hasPermission("projects.write")&&(o.buttons=[{text:RED._("notification.project.mergeConflict"),click:function(){n[i].hideNotification(),RED.sidebar.versionControl.showLocalChanges()}}]))),n.hasOwnProperty(i)?n[i].update(e,o):n[i]=RED.notify(e,o)):n.hasOwnProperty(i)&&(n[i].close(),delete n[i],"runtime-state"===i&&RED.events.emit("runtime-state",t)))}),RED.comms.subscribe("status/#",function(e,t){e=e.split("/"),e=RED.nodes.node(e[1]);e&&(t.hasOwnProperty("text")&&null!==t.text&&/^[a-zA-Z]/.test(t.text)&&(t.text=e._(t.text.toString(),{defaultValue:t.text.toString()})),e.status=t,e.dirtyStatus=!0,e.dirty=!0,RED.view.redrawStatus(e))}),RED.comms.subscribe("notification/node/#",function(e,i){var t,o,n;if("notification/node/added"==e)RED.settings.refreshSettings(function(e,t){var o=[];i.forEach(function(e){var t=e.id;RED.nodes.addNodeSet(e),o=o.concat(e.types),RED.i18n.loadNodeCatalog(t,function(){var e=localStorage.getItem("editor-language")||RED.i18n.detectLanguage();$.ajax({headers:{Accept:"text/html","Accept-Language":e},cache:!1,url:"nodes/"+t,success:function(e){r(e)}})})}),o.length&&(n="<ul><li>"+o.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:o.length})+n,"success")),s()});else if("notification/node/removed"==e){for(t=0;t<i.length;t++)o=i[t],RED.nodes.removeNodeSet(o.id).added&&(n="<ul><li>"+o.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeRemoved",{count:o.types.length})+n,"success"));s()}else"notification/node/enabled"==e?i.types&&RED.settings.refreshSettings(function(e,t){var o;RED.nodes.getNodeSet(i.id).added?(RED.nodes.enableNodeSet(i.id),n="<ul><li>"+i.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeEnabled",{count:i.types.length})+n,"success")):(o=localStorage.getItem("editor-language")||RED.i18n.detectLanguage(),$.ajax({headers:{Accept:"text/html","Accept-Language":o},cache:!1,url:"nodes/"+i.id,success:function(e){r(e),n="<ul><li>"+i.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeAdded",{count:i.types.length})+n,"success")}}))}):"notification/node/disabled"==e?i.types&&(RED.nodes.disableNodeSet(i.id),n="<ul><li>"+i.types.map(RED.utils.sanitize).join("</li><li>")+"</li></ul>",RED.notify(RED._("palette.event.nodeDisabled",{count:i.types.length})+n,"success")):"notification/node/upgraded"==e&&(RED.notify(RED._("palette.event.nodeUpgraded",{module:i.module,version:i.version}),"success"),RED.nodes.registry.setModulePendingUpdated(i.module,i.version))}),RED.comms.subscribe("event-log/#",function(e,t){e=e.substring(9);RED.eventLog.log(e,t)}),$(".red-ui-header-toolbar").show(),RED.sidebar.show(":first",!0),setTimeout(function(){var e;p.end(),!(e=function(){t&&RED.projects.showStartup()})!==RED.settings.theme("tours")&&RED.settings.get("editor.view.view-show-welcome-tours",!0)?RED.actions.invoke("core:show-welcome-tour",RED.settings.get("editor.tours.welcome"),e):e()},100)}function f(){var e=[];RED.settings.theme("projects.enabled",!1)&&e.push({id:"menu-item-projects-menu",label:RED._("menu.label.projects"),options:[{id:"menu-item-projects-new",label:RED._("menu.label.projects-new"),disabled:!1,onselect:"core:new-project"},{id:"menu-item-projects-open",label:RED._("menu.label.projects-open"),disabled:!1,onselect:"core:open-project"},{id:"menu-item-projects-settings",label:RED._("menu.label.projects-settings"),disabled:!1,onselect:"core:show-project-settings"}]}),e.push({id:"menu-item-edit-menu",label:RED._("menu.label.edit"),options:[{id:"menu-item-edit-undo",label:RED._("keyboard.undoChange"),disabled:!0,onselect:"core:undo"},{id:"menu-item-edit-redo",label:RED._("keyboard.redoChange"),disabled:!0,onselect:"core:redo"},null,{id:"menu-item-edit-cut",label:RED._("keyboard.cutNode"),onselect:"core:cut-selection-to-internal-clipboard"},{id:"menu-item-edit-copy",label:RED._("keyboard.copyNode"),onselect:"core:copy-selection-to-internal-clipboard"},{id:"menu-item-edit-paste",label:RED._("keyboard.pasteNode"),disabled:!0,onselect:"core:paste-from-internal-clipboard"},null,{id:"menu-item-edit-copy-group-style",label:RED._("keyboard.copyGroupStyle"),onselect:"core:copy-group-style"},{id:"menu-item-edit-paste-group-style",label:RED._("keyboard.pasteGroupStyle"),disabled:!0,onselect:"core:paste-group-style"},null,{id:"menu-item-edit-select-all",label:RED._("keyboard.selectAll"),onselect:"core:select-all-nodes"},{id:"menu-item-edit-select-connected",label:RED._("keyboard.selectAllConnected"),onselect:"core:select-connected-nodes"},{id:"menu-item-edit-select-none",label:RED._("keyboard.selectNone"),onselect:"core:select-none"}]}),e.push({id:"menu-item-view-menu",label:RED._("menu.label.view.view"),options:[{id:"menu-item-palette",label:RED._("menu.label.palette.show"),toggle:!0,onselect:"core:toggle-palette",selected:!0},{id:"menu-item-sidebar",label:RED._("menu.label.sidebar.show"),toggle:!0,onselect:"core:toggle-sidebar",selected:!0},{id:"menu-item-event-log",label:RED._("eventLog.title"),onselect:"core:show-event-log"},{id:"menu-item-action-list",label:RED._("keyboard.actionList"),onselect:"core:show-action-list"},null]}),e.push({id:"menu-item-arrange-menu",label:RED._("menu.label.arrange"),options:[{id:"menu-item-view-tools-move-to-back",label:RED._("menu.label.moveToBack"),disabled:!0,onselect:"core:move-selection-to-back"},{id:"menu-item-view-tools-move-to-front",label:RED._("menu.label.moveToFront"),disabled:!0,onselect:"core:move-selection-to-front"},{id:"menu-item-view-tools-move-backwards",label:RED._("menu.label.moveBackwards"),disabled:!0,onselect:"core:move-selection-backwards"},{id:"menu-item-view-tools-move-forwards",label:RED._("menu.label.moveForwards"),disabled:!0,onselect:"core:move-selection-forwards"},null,{id:"menu-item-view-tools-align-left",label:RED._("menu.label.alignLeft"),disabled:!0,onselect:"core:align-selection-to-left"},{id:"menu-item-view-tools-align-center",label:RED._("menu.label.alignCenter"),disabled:!0,onselect:"core:align-selection-to-center"},{id:"menu-item-view-tools-align-right",label:RED._("menu.label.alignRight"),disabled:!0,onselect:"core:align-selection-to-right"},null,{id:"menu-item-view-tools-align-top",label:RED._("menu.label.alignTop"),disabled:!0,onselect:"core:align-selection-to-top"},{id:"menu-item-view-tools-align-middle",label:RED._("menu.label.alignMiddle"),disabled:!0,onselect:"core:align-selection-to-middle"},{id:"menu-item-view-tools-align-bottom",label:RED._("menu.label.alignBottom"),disabled:!0,onselect:"core:align-selection-to-bottom"},null,{id:"menu-item-view-tools-distribute-horizontally",label:RED._("menu.label.distributeHorizontally"),disabled:!0,onselect:"core:distribute-selection-horizontally"},{id:"menu-item-view-tools-distribute-veritcally",label:RED._("menu.label.distributeVertically"),disabled:!0,onselect:"core:distribute-selection-vertically"}]}),e.push(null),RED.settings.theme("menu.menu-item-import-library",!0)&&e.push({id:"menu-item-import",label:RED._("menu.label.import"),onselect:"core:show-import-dialog"}),RED.settings.theme("menu.menu-item-export-library",!0)&&e.push({id:"menu-item-export",label:RED._("menu.label.export"),onselect:"core:show-export-dialog"}),e.push(null),e.push({id:"menu-item-search",label:RED._("menu.label.search"),onselect:"core:search"}),e.push(null),e.push({id:"menu-item-config-nodes",label:RED._("menu.label.displayConfig"),onselect:"core:show-config-tab"}),e.push({id:"menu-item-workspace",label:RED._("menu.label.flows"),options:[{id:"menu-item-workspace-add",label:RED._("menu.label.add"),onselect:"core:add-flow"},{id:"menu-item-workspace-edit",label:RED._("menu.label.rename"),onselect:"core:edit-flow"},{id:"menu-item-workspace-delete",label:RED._("menu.label.delete"),onselect:"core:remove-flow"}]}),e.push({id:"menu-item-subflow",label:RED._("menu.label.subflows"),options:[{id:"menu-item-subflow-create",label:RED._("menu.label.createSubflow"),onselect:"core:create-subflow"},{id:"menu-item-subflow-convert",label:RED._("menu.label.selectionToSubflow"),disabled:!0,onselect:"core:convert-to-subflow"}]}),e.push({id:"menu-item-group",label:RED._("menu.label.groups"),options:[{id:"menu-item-group-group",label:RED._("menu.label.groupSelection"),disabled:!0,onselect:"core:group-selection"},{id:"menu-item-group-ungroup",label:RED._("menu.label.ungroupSelection"),disabled:!0,onselect:"core:ungroup-selection"},null,{id:"menu-item-group-merge",label:RED._("menu.label.groupMergeSelection"),disabled:!0,onselect:"core:merge-selection-to-group"},{id:"menu-item-group-remove",label:RED._("menu.label.groupRemoveSelection"),disabled:!0,onselect:"core:remove-selection-from-group"}]}),e.push(null),!1!==RED.settings.get("externalModules.palette.allowInstall",!0)&&(e.push({id:"menu-item-edit-palette",label:RED._("menu.label.editPalette"),onselect:"core:manage-palette"}),e.push(null)),e.push({id:"menu-item-user-settings",label:RED._("menu.label.settings"),onselect:"core:show-user-settings"}),e.push(null),RED.settings.theme("menu.menu-item-keyboard-shortcuts",!0)&&e.push({id:"menu-item-keyboard-shortcuts",label:RED._("menu.label.keyboardShortcuts"),onselect:"core:show-help"}),e.push({id:"menu-item-help",label:RED.settings.theme("menu.menu-item-help.label",RED._("menu.label.help")),href:RED.settings.theme("menu.menu-item-help.url","http://nodered.org/docs")}),e.push({id:"menu-item-node-red-version",label:"v"+RED.settings.version,onselect:"core:show-about"}),$('<li><a id="red-ui-header-button-sidemenu" class="button" href="#"><i class="fa fa-bars"></i></a></li>').appendTo(".red-ui-header-toolbar"),RED.menu.init({id:"red-ui-header-button-sidemenu",options:e})}var c=null,u=!1;var p={init:function(){var e=$('<div id="red-ui-loading-progress"></div>').hide(),t=$("<div>").appendTo(e),t=($("<div>",{class:"red-ui-loading-bar-label"}).appendTo(t),$("<div>",{class:"red-ui-loading-bar"}).appendTo(t));$("<span>").appendTo(t);return e},start:function(e,t){e&&p.reportProgress(e,t),$("#red-ui-loading-progress").show()},reportProgress:function(e,t){$(".red-ui-loading-bar-label").text(e),$(".red-ui-loading-bar span").width(t+"%")},end:function(){$("#red-ui-loading-progress").hide(),p.reportProgress("",0)}};return{init:function(e){if(u)throw new Error("RED already initialised");var t,o,i;u=!0,window.ace&&window.ace.require("ace/ext/language_tools"),(e=e||{}).apiRootUrl=e.apiRootUrl||"",e.apiRootUrl&&!/\/$/.test(e.apiRootUrl)&&(e.apiRootUrl=e.apiRootUrl+"/"),e.target=$("#red-ui-editor"),e.target.addClass("red-ui-editor"),t=e,o=$('<div id="red-ui-header"></div>').appendTo(t.target),i=$('<span class="red-ui-header-logo"></span>').appendTo(o),$('<ul class="red-ui-header-toolbar hide"></ul>').appendTo(o),$('<div id="red-ui-header-shade" class="hide"></div>').appendTo(o),$('<div id="red-ui-main-container" class="red-ui-sidebar-closed hide"><div id="red-ui-workspace"></div><div id="red-ui-editor-stack"></div><div id="red-ui-palette"></div><div id="red-ui-sidebar"></div><div id="red-ui-sidebar-separator"></div></div>').appendTo(t.target),$('<div id="red-ui-editor-plugin-configs"></div>').appendTo(t.target),$('<div id="red-ui-editor-node-configs"></div>').appendTo(t.target),$('<div id="red-ui-full-shade" class="hide"></div>').appendTo(t.target),p.init().appendTo("#red-ui-main-container"),p.start("...",0),$.getJSON(t.apiRootUrl+"theme",function(e){e.header&&(e.header.url&&(i=$("<a>",{href:e.header.url}).appendTo(i)),e.header.image&&$("<img>",{src:e.header.image}).appendTo(i),e.header.title&&$("<span>").html(e.header.title).appendTo(i)),e.themes&&(c=e.themes)}),RED.i18n.init(e,function(){RED.settings.init(e,function(){c&&(RED.settings.editorTheme=RED.settings.editorTheme||{},RED.settings.editorTheme.themes=c),RED.workspaces.init(),RED.statusBar.init(),RED.view.init(),RED.userSettings.init(),RED.user.init(),RED.notifications.init(),RED.library.init(),RED.palette.init(),RED.eventLog.init(),!1!==RED.settings.get("externalModules.palette.allowInstall",!0)?RED.palette.editor.init():console.log("Palette editor disabled"),RED.sidebar.init(),RED.settings.theme("projects.enabled",!1)?RED.projects.init():console.log("Projects disabled"),RED.subflow.init(),RED.group.init(),RED.clipboard.init(),RED.search.init(),RED.actionList.init(),RED.editor.init(),RED.diff.init(),RED.deploy.init(RED.settings.theme("deployButton",null)),RED.keyboard.init(f),RED.nodes.init(),RED.comms.connect(),$("#red-ui-main-container").show(),n()})})},loader:p}}();RED.events=function(){var n={};return{on:function(e,t){n[e]=n[e]||[],n[e].push(t)},off:function(e,t){var o=n[e];if(o)for(var i=0;i<o.length;i++)if(o[i]===t)return void o.splice(i,1)},emit:function(){var t=arguments[0],e=Array.prototype.slice.call(arguments,1);if(RED.events.DEBUG&&console.warn(t,e),n[t])for(var o=0;o<n[t].length;o++)try{n[t][o].apply(null,e)}catch(e){console.warn("RED.events.emit error: ["+t+"] "+e.toString()),console.warn(e)}}}}(),RED.hooks=function(){var r={},s={};function d(e,t){var o=t.previousHook,i=t.nextHook;o?o.nextHook=i:r[e]=i,i&&(i.previousHook=o),t.removed=!0,o||i||delete r[e]}return{has:function(e){var t=(e=e.split("."))[0];return(e=e[1])?!(!s[e]||!s[e][t]):!!r[t]},clear:function(){r={},s={}},add:function(e,t){var o=e.split("."),i=o[0];if((o=o[1])&&s[o]&&s[o][i])throw new Error("Hook "+e+" already registered");var e={cb:t,previousHook:null,nextHook:null},n=r[i];if(void 0===n)r[i]=e;else{for(;null!==n.nextHook;)n=n.nextHook;(n.nextHook=e).previousHook=n}o&&(s[o]=s[o]||{},s[o][i]=e)},remove:function(e){var t=e.split("."),o=t[0],i=t[1];if(!i)throw new Error("Cannot remove hook without label: "+e);if(s[i])if("*"===o){for(var n=Object.keys(s[i]),a=0;a<n.length;a++)d(n[a],s[i][n[a]]);delete s[i]}else s[i][o]&&(d(o,s[i][o]),delete s[i][o],0===Object.keys(s[i]).length&&delete s[i])},trigger:function(e,i,n){var a=r[e];if(a)return function t(e){if(!a||e)return n&&n(e),e;if(a.removed)return a=a.nextHook,t();e=a.cb;if(1===e.length)try{var o=e(i);return!1===o?(n&&n(!1),o):(a=a.nextHook,t())}catch(e){return console.warn(e),n&&n(e),e}else try{e(i,function(e){void 0===e?(a=a.nextHook,t()):n&&n(e)})}catch(e){return console.warn(e),n&&n(e),e}}();n&&n()}}}(),RED.i18n=function(){var a;function r(){return navigator.language}return{init:function(e,t){a=e.apiRootUrl||"";var e=localStorage.getItem("editor-language")||r(),o={compatibilityJSON:"v3",backend:{loadPath:a+"locales/__ns__?lng=__lng__"},lng:"en-US",preload:["en-US"],ns:["editor","node-red","jsonata","infotips"],defaultNS:"editor",fallbackLng:["en-US"],returnObjects:!0,keySeparator:".",nsSeparator:":",interpolation:{unescapeSuffix:"HTML",escapeValue:!1,prefix:"__",suffix:"__"}};e&&(o.lng=e),i18next.use(i18nextHttpBackend).init(o,function(){t()}),jqueryI18next.init(i18next,$,{handleName:"i18n"}),RED._=function(){var e=i18next.t.apply(i18next,arguments);return"string"==typeof e?e:arguments[0]}},lang:function(){for(var e=[localStorage.getItem("editor-language")||r()].concat(i18next.languages),t=RED.settings.theme("languages")||["en-US"],o=0;o<e.length;o++)if(-1<t.indexOf(e[o]))return e[o];return"en-US"},loadNodeCatalog:function(o,i){var e=[localStorage.getItem("editor-language")||r()].concat(i18next.languages),n=e.length;e.forEach(function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:a+"nodes/"+o+"/messages?lng="+t,success:function(e){i18next.addResourceBundle(t,o,e),0===--n&&i()}})})},loadNodeCatalogs:function(e){var t=[localStorage.getItem("editor-language")||r()].concat(i18next.languages),i=t.length;t.forEach(function(o){$.ajax({headers:{Accept:"application/json"},cache:!1,url:a+"nodes/messages?lng="+o,success:function(t){Object.keys(t).forEach(function(e){i18next.addResourceBundle(o,e,t[e])}),0===--i&&e()}})})},loadPluginCatalogs:function(e){var t=[localStorage.getItem("editor-language")||r()].concat(i18next.languages),i=t.length;t.forEach(function(o){$.ajax({headers:{Accept:"application/json"},cache:!1,url:a+"plugins/messages?lng="+o,success:function(t){Object.keys(t).forEach(function(e){i18next.addResourceBundle(o,e,t[e])}),0===--i&&e()}})})},detectLanguage:r}}(),RED.settings=function(){function i(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return}}function o(e){r=e}function n(o){s(function(e,t){e||(RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-RED: "+t.version),console.groupCollapsed("Versions"),console.log("jQuery",$().jquery),console.log("jQuery UI",$.ui.version),window.ace&&console.log("ACE",ace.version),window.monaco&&console.log("MONACO",monaco.version||"unknown"),console.log("D3",d3.version),console.groupEnd(),d(o))})}var e,a={},r={},s=function(i){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(e){var t,o=e;for(t in a)a.hasOwnProperty(t)&&RED.settings.hasOwnProperty(t)&&delete RED.settings[t];for(t in o)o.hasOwnProperty(t)&&(RED.settings[t]=o[t]);a=o,i(null,e)},error:function(e,t,o){401===e.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){s(i)})):console.log("Unexpected error loading settings:",e.status,t)}})};function d(t){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings/user",success:function(e){o(e),t()},error:function(e,t,o){console.log("Unexpected error loading user settings:",e.status,t)}})}function l(){RED.user.hasPermission("settings.write")&&(e&&clearTimeout(e),e=setTimeout(function(){e=null,$.ajax({method:"POST",contentType:"application/json",url:"settings/user",data:JSON.stringify(r),success:function(e){},error:function(e,t,o){console.log("Unexpected error saving user settings:",e.status,t)}})},300))}return{init:function(o,e){var t=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);t&&(t=t[1],RED.settings.set("auth-tokens",{access_token:t}),window.location.search=""),RED.settings.apiRootUrl=o.apiRootUrl,$.ajaxSetup({beforeSend:function(e,t){/^\s*(https?:|\/|\.)/.test(t.url)||(o.apiRootUrl&&(t.url=o.apiRootUrl+t.url),(t=RED.settings.get("auth-tokens"))&&e.setRequestHeader("Authorization","Bearer "+t.access_token),e.setRequestHeader("Node-RED-API-Version","v2"))}}),n(e)},load:n,loadUserSettings:d,refreshSettings:s,set:function(e,t){i()&&("auth-tokens"===e?localStorage.setItem(e,JSON.stringify(t)):(RED.utils.setMessageProperty(r,e,t),l()))},get:function(e,t){if(i()){if("auth-tokens"===e)return JSON.parse(localStorage.getItem(e));var o;try{o=RED.utils.getMessageProperty(r,e)}catch(e){}if(void 0===o)try{o=RED.utils.getMessageProperty(RED.settings,e)}catch(e){}return o=void 0===o?t:o}},remove:function(e){i()&&("auth-tokens"===e?localStorage.removeItem(e):(delete r[e],l()))},theme:function(e,t){if(!RED.settings.editorTheme)return t;var o=e.split("."),i=RED.settings.editorTheme;try{for(var n=0;n<o.length;n++)i=i[o[n]];return void 0===i?t:i}catch(e){return t}},setLocal:function(e,t){localStorage.setItem(e,t)},getLocal:function(e){return localStorage.getItem(e)},removeLocal:function(e){localStorage.removeItem(e)}}}(),RED.user=function(){function p(){$("#red-ui-header-button-user-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),p(),RED.events.emit("login",RED.settings.user.username)})})}}):(RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("red-ui-header-button-user",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}var n=/^((.+)\.)?read$/,a=/^((.+)\.)?write$/;return{init:function(){var e;RED.settings.user&&(RED.settings.editorTheme&&RED.settings.editorTheme.hasOwnProperty("userMenu")&&!RED.settings.editorTheme.userMenu||(e=$('<li><a id="red-ui-header-button-user" class="button hide" href="#"></a></li>').prependTo(".red-ui-header-toolbar"),(RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}):$('<i class="fa fa-user"></i>')).appendTo(e.find("a")),RED.menu.init({id:"red-ui-header-button-user",options:[]}),p()))},login:function(l,c){"function"==typeof l&&(c=l,l={});var u=$('<div id="node-dialog-login" class="hide" style="display: flex; align-items: flex-end;"><div style="width: 250px; flex-grow: 0;"><img id="node-dialog-login-image" src=""/></div><div style="flex-grow: 1;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px; margin-left:20px;"></form></div></div>');u.dialog({autoOpen:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},modal:!0,closeOnEscape:!!l.cancelable,width:600,resizable:!1,draggable:!1,close:function(e,t){$("#node-dialog-login").dialog("destroy").remove(),RED.keyboard.enable()}}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(n){var e=0;if("credentials"==n.type){for(;e<n.prompts.length;e++){var t=n.prompts[e],o=$("<div/>",{class:"form-row"}),i=($('<label for="node-dialog-login-'+t.id+'">'+RED._(t.label)+":</label><br/>").appendTo(o),$('<input style="width: 100%" id="node-dialog-login-'+t.id+'" type="'+t.type+'" tabIndex="'+(e+1)+'"/>').appendTo(o));e<n.prompts.length-1&&i.keypress(function(){var t=o;return function(e){13==e.keyCode&&(t.next("div").find("input").trigger("focus"),e.preventDefault())}}()),o.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;color:var(--red-ui-text-color-error);" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(l.cancelable?'<a href="#" id="node-dialog-login-cancel" class="red-ui-button" style="margin-right: 20px;" tabIndex="'+(e+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" class="red-ui-button" style="width: auto;" tabIndex="'+(e+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").on("submit",function(e){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var t={client_id:"node-red-editor",grant_type:"password",scope:""},o=0;o<n.prompts.length;o++){var i=n.prompts[o];t[i.id]=$("#node-dialog-login-"+i.id).val()}$.ajax({url:"auth/token",type:"POST",data:t}).done(function(e,t,o){RED.settings.set("auth-tokens",e),l.updateMenu&&p(),$("#node-dialog-login").dialog("close"),c()}).fail(function(e,t,o){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),e.preventDefault()})}else if("strategy"==n.type)for(e=0;e<n.prompts.length;e++){var a,r,t=n.prompts[e],s=/[?&]session_message=(.*?)(?:$|&)/.exec(window.location.search),o=(s&&(RED.sessionMessages=RED.sessionMessages||[],RED.sessionMessages.push(s[1]),history.pushState?(s=window.location.protocol+"//"+window.location.host+window.location.pathname,window.history.replaceState({path:s},"",s)):window.location.search=""),RED.sessionMessages&&(a=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields"),RED.sessionMessages.forEach(function(e){$("<div>").css("color","var(--red-ui-text-color-error)").text(e).appendTo(a)}),delete RED.sessionMessages),$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields")),s=$('<a href="#" class="red-ui-button"></a>',{style:"padding: 10px"}).appendTo(o).on("click",function(){document.location=t.url});t.image?$("<img>",{src:t.image}).appendTo(s):t.label&&(r=$("<span></span>").text(t.label),t.icon&&($("<i></i>",{class:"fa fa-2x "+t.icon,style:"vertical-align: middle"}).appendTo(s),r.css({verticalAlign:"middle",marginLeft:"8px"})),r.appendTo(s)),s.button()}l.cancelable&&$("#node-dialog-login-cancel").button().on("click",function(e){$("#node-dialog-login").dialog("close")});var d=n.image||"red/images/node-red-256.svg";$("#node-dialog-login-image").load(function(){u.dialog("open")}).attr("src",d),RED.keyboard.disable()}})},logout:function(){var e=(e=RED.settings.get("auth-tokens"))?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:e}}).done(function(e,t,o){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)}).fail(function(e,t,o){401===e.status?document.location.reload(!0):console.log(t)})},hasPermission:function(e){return""===e||(!RED.settings.user||function e(t,o){if(""===o)return!0;var i;if(Array.isArray(o)){for(i=0;i<o.length;i++)if(!e(t,o[i]))return!1;return!0}if(Array.isArray(t)){if(0===t.length)return!1;for(i=0;i<t.length;i++)if(e(t[i],o))return!0;return!1}if("*"===t||t===o)return!0;{if("read"===t||"*.read"===t)return n.test(o);if("write"===t||"*.write"===t)return a.test(o)}return!1}(RED.settings.user.permissions||"",e))}}}(),RED.comms=function(){var n,a=null,r=null,l=null,c=10,u={},p=!1,f=0,h=!1;return{connect:function s(){h=!0,RED.settings.apiRootUrl?(t=/^(https?):\/\/(.*)$/.exec(RED.settings.apiRootUrl))&&(console.log(t),e="ws"+("https"===t[1]?"s":"")+"://"+t[2]+"comms"):(t=location.hostname,0!==(o=location.port).length&&(t=t+":"+o),t=(t+=document.location.pathname)+("/"==t.slice(-1)?"":"/")+"comms",e="ws"+("https:"==document.location.protocol?"s":"")+"://"+t);var e,t,o,i=RED.settings.get("auth-tokens");function d(){for(var e in u)u.hasOwnProperty(e)&&n.send(JSON.stringify({subscribe:e}))}p=null!=i,(n=new WebSocket(e)).onopen=function(){f=0,a&&(r=setTimeout(function(){a.close(),a=null},1e3)),p?n.send(JSON.stringify({auth:i.access_token})):d()},n.onmessage=function(e){var t=JSON.parse(e.data);if(t.auth)p&&"ok"===t.auth?(p=!1,d()):"fail"===t.auth&&(h=!1,RED.user.login({updateMenu:!0},function(){s()}));else for(var o=0;o<t.length;o++){var i=t[o];if(i.topic)for(var n in u)if(u.hasOwnProperty(n)&&new RegExp("^"+n.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(i.topic)){var a=u[n];if(a)for(var r=0;r<a.length;r++)a[r](i.topic,i.data)}}},n.onclose=function(){h&&(r&&(clearTimeout(r),r=null),++f<10?(setTimeout(s,1e3),5<f&&null==a&&(a=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):f<20?setTimeout(s,2e3):(c=60,l=setInterval(function(){var e;0==--c?(a.update(RED._("notification.errors.lostConnection")),clearInterval(l),s()):(e=RED._("notification.errors.lostConnectionReconnect",{time:c})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>",a.update(e,{silent:!0}),$(a).find("a").on("click",function(e){e.preventDefault(),a.update(RED._("notification.errors.lostConnection"),{silent:!0}),clearInterval(l),s()}))},1e3)))}},subscribe:function(e,t){null==u[e]&&(u[e]=[]),u[e].push(t),n&&1==n.readyState&&n.send(JSON.stringify({subscribe:e}))},unsubscribe:function(e,t){if(u[e]){for(var o=0;o<u[e].length;o++)if(u[e][o]===t){u[e].splice(o,1);break}0===u[e].length&&delete u[e]}}}}(),RED.text={},RED.text.bidi=function(){var t="";function o(e){return"auto"==t?function(e){for(var t,o=e.length,i=0;i<o;i++){if(1488<=(t=e.charCodeAt(i))&&t<=1535||1536<=t&&t<=1631||1642<=t&&t<=1775||1786<=t&&t<=2047||64285<=t&&t<=65023||65136<=t&&t<=65276)return 1;if(64<(t=e.charCodeAt(i))&&t<91||96<t&&t<123)return}}(e)?"rtl":"ltr":t}function i(){$(this).attr("dir",o($(this).val()))}return{setTextDirection:function(e){t=e,RED.nodes.eachNode(function(e){e.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),$("#red-ui-workspace").find("span.red-ui-text-bidi-aware").each(function(){$(this).attr("dir",o($(this).html()))}),$("#red-ui-sidebar").find("span.red-ui-text-bidi-aware").each(function(){$(this).attr("dir",o($(this).text()))})},enforceTextDirectionWithUCC:function(e){if(e){var t=o(e);if("ltr"==t)return"‪"+e+"‬";if("rtl"==t)return"‫"+e+"‬"}return e},resolveBaseTextDir:o,prepareInput:function(e){e.on("keyup",i).on("paste",i).on("cut",i),i.call(e)}}}(),RED.text.format=function(){var e,u=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},d={handleSubcontents:function(e,t,o,l,c){if(!o.content||"string"!=typeof o.content||0===o.content.length)return e;var i=!0;void 0!==o.loops&&(i=!!o.loops);for(var n=0;;n++){1;{if(n>=e.length)break;if(!(e[n].isParsed||e.keep||e[n].isSeparator)){var a=e[n].content,r=a.indexOf(o.content);if(!(r<0)){var s,d=0;if(o.continued)for(;d++,0===(s=a.indexOf(o.content,r+d*o.content.length)););else d=1;if(s=r+d*o.content.length,e.splice(n,1),0<r&&(e.splice(n,0,new u({content:a.substring(0,r),localGui:t.dir,keep:!0})),n++),e.splice(n,0,new u({content:a.substring(r,s),textDirection:o.subDir,localGui:t.dir})),s<a.length&&e.splice(n+1,0,new u({content:a.substring(s,a.length),localGui:t.dir,keep:!0})),!i)break}}}}},handleBounds:function(e,t,o,l,c){for(var i=0;i<o.length;i++)if(function(e){var t;if(e)return void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1,t=parseInt(e.startPos,10),isNaN(t)?e.usePos=!1:e.usePos=!0,t=parseInt(e.length,10),isNaN(t)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,1}(o[i]))for(var n=0;;n++){1;{if(n>=e.length)break;if(!(e[n].isParsed||e[n].inBounds||e.keep||e[n].isSeparator)){var a=function(e,t){var o,i={};for(o in t)t.hasOwnProperty(o)&&(i[o]=t[o]);var e=e.content,n=i.usePos&&i.startPos<e.length;return n&&(i.start="",i.loops=!1),i.bStart=n?i.startPos:0<i.start.length?e.indexOf(i.start):0,(n=i.useLength&&0<i.length&&i.bStart+i.length<e.length)&&(i.end=""),i.bEnd=n?i.bStart+i.length:0<i.end.length?e.indexOf(i.end,i.bStart+i.start.length)+1:e.length,i.after||(i.start=""),i.before||(i.end=""),i}(e[n],o[i]),r=a.bStart,s=a.bEnd;if(!(r<0||s<0)){var d=e[n].content;if(e.splice(n,1),0<r&&(e.splice(n,0,new u({content:d.substring(0,r),localGui:t.dir,keep:!0})),n++),a.start&&(e.splice(n,0,new u({content:a.start,localGui:t.dir,isSeparator:!0})),n++),e.splice(n,0,new u({content:d.substring(r+a.start.length,s-a.end.length),textDirection:a.subDir,localGui:t.dir,inBounds:!0})),a.end&&(n++,e.splice(n,0,new u({content:a.end,localGui:t.dir,isSeparator:!0}))),s+a.end.length<d.length&&e.splice(n+1,0,new u({content:d.substring(s+a.end.length,d.length),localGui:t.dir,keep:!0})),!a.loops)break}}}}for(i=0;i<e.length;i++)e[i].inBounds=!1;return e},handleCases:function(e,t,o,i,n){if(0===o.length)return e;var a,r={};for(a in t)t.hasOwnProperty(a)&&(r[a]=t[a]);for(var s=0;s<o.length;s++)o[s].handler&&"function"==typeof o[s].handler.handle||(o[s].handler=t.commonHandler),o[s].args?(r.cases=o[s].args.cases,r.points=o[s].args.points,r.bounds=o[s].args.bounds,r.subs=o[s].args.subs):(r.cases=[],r.points=[],r.bounds=[],r.subs={}),o[s].handler.handle(i,e,r,n);return e},handlePoints:function(e,t,o,i,n){for(var a=0;a<o.length;a++)for(var r,s,d=0;;d++){1;{if(d>=e.length)break;e[d].isParsed||e[d].keep||e[d].isSeparator||0<=(s=(r=e[d].content).indexOf(o[a]))&&(e.splice(d,1),0<s&&(e.splice(d,0,new u({content:r.substring(0,s),textDirection:t.subDir,localGui:t.dir,inPoints:!0})),d++),e.splice(d,0,new u({content:o[a],localGui:t.dir,isSeparator:!0})),s+o[a].length+1<=r.length&&e.splice(d+1,0,new u({content:r.substring(s+o[a].length),textDirection:t.subDir,localGui:t.dir,inPoints:!0})))}}for(a=0;a<e.length;a++)e[a].keep?e[a].keep=!1:e[a].inPoints&&(e[a].isParsed=!0,e[a].inPoints=!1);return e}},s={handle:function(e,t,o,i){var n=[],a=(Array.isArray(o.cases)&&(n=o.cases),[]),r=(void 0!==o.points&&(Array.isArray(o.points)?a=o.points:"string"==typeof o.points&&(a=o.points.split(""))),{}),s=("object"==typeof o.subs&&(r=o.subs),[]);return Array.isArray(o.bounds)&&(s=o.bounds),d.handleBounds(t,o,s,e,i),d.handleSubcontents(t,o,r,e,i),d.handleCases(t,o,n,e,i),d.handlePoints(t,o,a,e,i),t}},v={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){var t,o;return e=(e=e||("undefined"!=typeof navigator&&(navigator.language||navigator.userLanguage)||"")).toLowerCase(),!(o=(t=e)?t.split("-")[0]:"")||o.length<2||!["iw","he","ar","fa","ur"].some(function(e){return e===o})?{lang:"not-bidi"}:{lang:(t=e.split("-"))[0],country:t[1]||""}},removeUcc:function(e){return e&&e.replace(/[\u200E\u200F\u202A-\u202E]/g,"")},removeTags:function(e){return e&&e.replace(/<[^<]*>/g,"")},getDirection:function(e,t,o,i){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;o=/^(rtl|ltr)$/i.test(o)?o:"ltr";t=i?e.split("").reverse().join(""):e,i=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(t);return i?i[0]<="z"?"ltr":"rtl":o},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var o="",i=0;i<e.length;i++){var n=""+e.charAt(i);switch(n){case"‎":o+="<LRM>";break;case"‏":o+="<RLM>";break;case"‪":o+="<LRE>";break;case"‫":o+="<RLE>";break;case"‭":o+="<LRO>";break;case"‮":o+="<RLO>";break;case"‬":o+="<PDF>";break;default:o+=n}}t=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return t+o+(t?"‬":"")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},l=((e={}).parseAndDisplayStructure=function(e,t,o,i){return e&&t?r(n(e,t,i),t,o):e},e.parseStructure=n,e.displayStructure=r,e.restore=function(e,t){return e},e);function y(e,t){e=Array.isArray(e)?e[0]:e;return e.guiDir||(e.guiDir="ltr"),e.dir||(e.dir=e.guiDir),t&&(void 0===e.points&&(e.points=[]),e.cases||(e.cases=[]),e.bounds||(e.bounds=[]),e.commonHandler=s),e}function n(e,t,o){if(!e||!t)return new u({content:""});var t=y(t,!0),i=[new u({content:e,actual:e,localGui:t.dir})],n=s.handle;return(n=t.handler&&"function"==typeof t.handler?t.handler.handle:n)(e,i,t,o),i}function r(c,u,p){u=y(u,!1);if(p){for(var e,t,o=c,i=u,n="",f="",a=0;a<o.length;a++)stop=!o[a].isVisible||(t=o[a].textDirection,""!==(e=o[a].localGui)&&""===f?n+="<bdi dir='"+("rtl"===e?"rtl":"ltr")+"'>":""===f||""!==e&&e===f&&!stop||(n+="</bdi>"+(a==o.length-1&&""!==e?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===i.dir?"rtl":"ltr")+";'></span>"),""!==e&&(n+="<bdi dir='"+("rtl"===e?"rtl":"ltr")+"'>")),"auto"===t&&(t=v.getDirection(o[a].content,t,i.guiDir)),/^(rtl|ltr)$/i.test(t)?n+="<bdi dir='"+("rtl"===t?"rtl":"ltr")+"'>"+o[a].content+"</bdi>":(n+=o[a].content,v.getDirection(o[a].content,t,i.guiDir,!0)),a<o.length-1?(t=e&&o[a+1].localGui?e:i.dir,n+="<span style='unicode-bidi: embed; direction: "+("rtl"===t?"rtl":"ltr")+";'></span>"):""!==f&&(n+="</bdi>"),f=e,!1);p="auto"===i.dir?v.getDirection(o[0].actual,i.dir,i.guiDir):i.dir;return n=p!==i.guiDir?"<bdi dir='"+("rtl"===p?"rtl":"ltr")+"'>"+n+"</bdi>":n}for(var r,h,s=c,g=u,d="",m="",b=!1,l=0;l<s.length;l++)b=!s[l].isVisible||(h=s[l].textDirection,""!==(r=s[l].localGui)&&""===m?d+="rtl"===r?v.RLE:v.LRE:""===m||""!==r&&r===m&&!b||(d+=v.PDF+(l==s.length-1&&""!==r?"":"rtl"===g.dir?v.RLM:v.LRM),""!==r&&(d+="rtl"===r?v.RLE:v.LRE)),"auto"===h&&(h=v.getDirection(s[l].content,h,g.guiDir)),/^(rtl|ltr)$/i.test(h)?d+=("rtl"===h?v.RLE:v.LRE)+s[l].content+v.PDF:(d+=s[l].content,v.getDirection(s[l].content,h,g.guiDir,!0)),l<s.length-1?(h=r&&s[l+1].localGui?r:g.dir,d+="rtl"===h?v.RLM:v.LRM):""!==m&&(d+=v.PDF),m=r,!1);p="auto"===g.dir?v.getDirection(s[0].actual,g.dir,g.guiDir):g.dir;return d=p!==g.guiDir?("rtl"===p?v.RLE:v.LRE)+d+v.PDF:d}var t,o,i={format:function(e,t,o,i,n,a){t={guiDir:o?"rtl":"ltr",dir:t.dir||(o?"rtl":"ltr"),subs:{content:">",continued:!0,subDir:o?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:o?"ltr":"rtl"}}}]};return a?l.parseStructure(e,t,!!i,n):l.parseAndDisplayStructure(e,t,!!i,n)}},c={format:function(e,t,o,i,n,a){o={guiDir:o?"rtl":"ltr",dir:"ltr",points:","};return a?l.parseStructure(e,o,!!i,n):l.parseAndDisplayStructure(e,o,!!i,n)}},f={format:function(e,t,o,i,n,a){var r,o={guiDir:o?"rtl":"ltr",dir:(o=e,r=n,"ar"===v.getLocaleDetails(r).lang&&0<(r=o.indexOf("@"))&&r<o.length-1&&v.hasArabicChar(o.substring(r+1))?"rtl":"ltr"),points:"<>.:,;@",cases:[{handler:s,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return a?l.parseStructure(e,o,!!i,n):l.parseAndDisplayStructure(e,o,!!i,n)}},h={format:function(e,t,o,i,n,a){o={guiDir:o?"rtl":"ltr",dir:"ltr",points:"/\\:."};return a?l.parseStructure(e,o,!!i,n):l.parseAndDisplayStructure(e,o,!!i,n)}},g={format:function(e,t,o,i,n,a){o={guiDir:o?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return a?l.parseStructure(e,o,!!i,n):l.parseAndDisplayStructure(e,o,!!i,n)}},m={format:function(e,t,o,i,n,a){o={guiDir:o?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:s,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:s,args:{subs:{content:" ",continued:!0}}},{handler:s,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return a?l.parseStructure(e,o,!!i,n):l.parseAndDisplayStructure(e,o,!!i,n)}},b={format:function(e,t,o,i,n,a){o={guiDir:o?"rtl":"ltr",dir:"ltr",points:"_"};return a?l.parseStructure(e,o,!!i,n):l.parseAndDisplayStructure(e,o,!!i,n)}},w={format:function(e,t,o,i,n,a){o={guiDir:o?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return a?l.parseStructure(e,o,!!i,n):l.parseAndDisplayStructure(e,o,!!i,n)}},E={format:function(e,t,o,i,n,a){t={guiDir:o?"rtl":"ltr",dir:t.dir||(o?"rtl":"ltr"),points:" ,.!?;:"};return a?l.parseStructure(e,t,!!i,n):l.parseAndDisplayStructure(e,t,!!i,n)}},D={format:function(e,t,o,i,n,a){o={guiDir:o?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:s,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return a?l.parseStructure(e,o,!!i,n):l.parseAndDisplayStructure(e,o,!!i,n)}},R={format:function(e,t,o,i,n,a){var r={},s="",d=Array.isArray(t)?t[0]:t;for(s in d)d.hasOwnProperty(s)&&(r[s]=d[s]);return r.guiDir=o?"rtl":"ltr",r.dir=r.dir||r.guiDir,a?l.parseStructure(e,r,!!i,n):l.parseAndDisplayStructure(e,r,!!i,n)}};o=!(t={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""});function x(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function $(e){0===e.msgDir.length&&(e.msgDir=x(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:x(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}var p=null;function _(e){switch(e){case"breadcrumb":return i;case"comma":return c;case"email":return f;case"filepath":return h;case"formula":return g;case"sql":return m;case"underscore":return b;case"url":return w;case"word":return E;case"xpath":return D;default:return R}}function k(t,e,o,i,n){if(!t||1!=t.nodeType)return!1;p||(p=document.createEvent("Event")).initEvent("TF",!0,!0),t.setAttribute("data-tf-type",e);e="undefined"===o?"{}":JSON.stringify(Array.isArray(o)?o[0]:o),t.setAttribute("data-tf-args",e),o="ltr";return"undefined"===i&&(t.dir?o=t.dir:t.style&&t.style.direction&&(o=t.style.direction),i="rtl"===o.toLowerCase()),t.setAttribute("data-tf-dir",i),t.setAttribute("data-tf-locale",v.getLocaleDetails(n).lang),!function(e){var t=window.navigator.userAgent;if(!(0<=t.indexOf("MSIE")||0<=t.indexOf("Trident")||0<=t.indexOf("Edge")))return(t=document.createElement(e.tagName)).contentEditable=!0,(e="oninput"in t)||(t.setAttribute("oninput","return;"),e="function"==typeof t.oninput),t=null,e}(t)?(t.onkeyup=function(e){a(e.target),t.dispatchEvent(p)},t.onmouseup=function(e){a(e.target),t.dispatchEvent(p)}):(t.oninput,t.oninput=function(e){a(e.target)}),a(t),!0}function a(e){var t=e.textContent||"",o=document.getSelection();if(0===t.length||!o||o.rangeCount<=0)e.dispatchEvent(p);else{var i=o.getRangeAt(0),n=i.cloneRange(),c=i.startContainer,a=i.startOffset,r=0,a=(3===c.nodeType&&(r+=a),n.setStart(e,0),n.setEndBefore(c),document.createElement("div")),s=(a.appendChild(n.cloneContents()),r+=a.textContent.length,e.innerHTML=_(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale")),e),d=e,l=0,u=!1;for(o.removeAllRanges(),i.setStart(e,0),i.setEnd(e,0);d;){if(3===d.nodeType){if(l+d.nodeValue.length>=r){i.setStart(d,r-l);break}l+=d.nodeValue.length,d=d.nextSibling}else{if(d.hasChildNodes()){d=(s=d).firstChild;continue}d=d.nextSibling}for(;!d;){if(s===e){u=!0;break}d=s.nextSibling,s=s.parentNode}if(u)break}o.addRange(i),e.dispatchEvent(p)}}return{getHtml:function(e,t,o,i,n){return _(t).format(e,o,i,!0,n)},attach:k}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9,PANNING:10,SELECTING_NODE:11,GROUP_DRAGGING:12,GROUP_RESIZE:13,DETACHED_DRAGGING:14,SLICING:15},RED.plugins=function(){var t={},o={};return{registerPlugin:function(e,i){(t[e]=i).type&&(o[i.type]=o[i.type]||[],o[i.type].push(i)),RED._loadingModule?(i.module=RED._loadingModule,i._=function(){var e=Array.prototype.slice.call(arguments),t=e[0],o=(/:/.test(e[0])||(e[0]=i.module+":"+e[0]),RED._.apply(null,e));return o===e[0]?t:o}):i._=RED._,i.onadd&&"function"==typeof i.onadd&&i.onadd(),RED.events.emit("registry:plugin-added",e)},getPlugin:function(e){return t[e]},getPluginsByType:function(e){return o[e]||[]}}}(),RED.nodes=function(){var de,le,l={},ie={},h=[],c={},ne={},d=[],ae={},t=null,ce={},u={},o=!1;a={},r=[],p={},f={},m={},(g={}).tab={defaults:{label:{value:""},disabled:{value:!1},info:{value:""},env:{value:[]}}};var a,r,p,f,g,m,b,v,s,y,re=b={setModulePendingUpdated:function(e,t){a[e].pending_version=t,RED.events.emit("registry:module-updated",{module:e,version:t})},getModule:function(e){return a[e]},getNodeSetForType:function(e){return b.getNodeSet(f[e])},getModuleList:function(){return a},getNodeList:function(){return r},getNodeTypes:function(){return Object.keys(g)},setNodeList:function(e){r=[];for(var t=0;t<e.length;t++){var o=e[t];b.addNodeSet(o)}},addNodeSet:function(e){if(e.types){e.added=!1,p[e.id]=e;for(var t=0;t<e.types.length;t++)f[e.types[t]]=e.id;r.push(e),a[e.module]=a[e.module]||{name:e.module,version:e.version,local:e.local,sets:{}},e.pending_version&&(a[e.module].pending_version=e.pending_version),a[e.module].sets[e.name]=e,RED.events.emit("registry:node-set-added",e)}},removeNodeSet:function(e){for(var t=p[e],o=0;o<t.types.length;o++)delete f[t.types[o]];delete p[e];for(var i=0;i<r.length;i++)if(r[i].id===e){r.splice(i,1);break}return delete a[t.module].sets[t.name],0===Object.keys(a[t.module].sets).length&&delete a[t.module],RED.events.emit("registry:node-set-removed",t),t},getNodeSet:function(e){return p[e]},enableNodeSet:function(e){e=p[e];e.enabled=!0,RED.events.emit("registry:node-set-enabled",e)},disableNodeSet:function(e){e=p[e];e.enabled=!1,RED.events.emit("registry:node-set-disabled",e)},registerNodeType:function(e,t){if("subflow:"!=e.substring(0,8)){var o,i,n;if(!p[f[e]])return o="",i=e,RED._loadingModule&&(i="["+RED._loadingModule+"] "+e,o=p[RED._loadingModule]?p[RED._loadingModule].err||"":"Unknown error"),void RED.notify(RED._("palette.event.unknownNodeRegistered",{type:i,error:o}),"error");t.set=p[f[e]],p[f[e]].added=!0,p[f[e]].enabled=!0,n="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0],o=(-1===e[0].indexOf(":")&&(e[0]=n+":"+e[0]),RED._.apply(null,e));return o=o===e[0]?t:o}}if(t.type=e,(g[e]=t).defaults)for(var a in t.defaults)if(t.defaults.hasOwnProperty(a)&&t.defaults[a].type)try{t.defaults[a]._type=function(e){e=e.trim();var t,o=0,i=/\[\]$/.test(e);i&&(e=e.substring(0,e.length-2));var n=e.length,a=!1,r=!1,s="",d=[];for(;o<n;){if(t=e[o],r)"|"===t?(d.push(s.trim()),s="",r=!1):")"===t?(d.push(s.trim()),s="",r=a=!1):s+=t;else if("("===t){if(a)throw new Error("Invalid character '"+t+"' at position "+o);a=!0}else" "!==t&&(r=!0,s=t);o++}0<(s=s.trim()).length&&d.push(s);return{types:d,array:i}}(t.defaults[a].type)}catch(e){console.warn(e)}RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete g[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return g[e]},setIconSets:function(e){(m=e)["font-awesome"]=RED.nodes.fontAwesome.getIconList()},getIconSets:function(){return m}},se=(v={},s={},y={addTab:function(e){s[e]=[]},hasTab:function(e){return s.hasOwnProperty(e)},removeTab:function(e){delete s[e]},addNode:function(e){v[e.id]=e,s.hasOwnProperty(e.z)?s[e.z].push(e):(console.warn("Node added to unknown tab/subflow:",e),s._=s._||[],s._.push(e))},removeNode:function(e){var t;delete v[e.id],!s.hasOwnProperty(e.z)||-1<(t=s[e.z].indexOf(e))&&s[e.z].splice(t,1)},hasNode:function(e){return v.hasOwnProperty(e)},getNode:function(e){return v[e]},moveNode:function(e,t){y.removeNode(e),e.z=t,y.addNode(e)},moveNodesForwards:function(e){for(var t=[],o=(Array.isArray(e)||(e=[e]),s[e[0].z]),i=new Set(e.filter(function(e){return"group"!==e.type&&"subflow"!==e.type})),n=new Set,a=o.length-1;0<=a&&0!==i.size;a--){var r=o[a];i.has(r)&&(a<o.length-1&&!n.has(o[a+1])&&(o.splice(a,1),o.splice(a+1,0,r),r._reordered=!0,t.push(r)),i.delete(r),n.add(r))}return 0<t.length&&RED.events.emit("nodes:reorder",{z:e[0].z,nodes:t}),t},moveNodesBackwards:function(e){for(var t=[],o=(Array.isArray(e)||(e=[e]),s[e[0].z]),i=new Set(e.filter(function(e){return"group"!==e.type&&"subflow"!==e.type})),n=new Set,a=0;a<o.length&&0!==i.size;a++){var r=o[a];i.has(r)&&(0<a&&!n.has(o[a-1])&&(o.splice(a,1),o.splice(a-1,0,r),r._reordered=!0,t.push(r)),i.delete(r),n.add(r))}return 0<t.length&&RED.events.emit("nodes:reorder",{z:e[0].z,nodes:t}),t},moveNodesToFront:function(e){for(var t=[],o=(Array.isArray(e)||(e=[e]),s[e[0].z]),i=new Set(e.filter(function(e){return"group"!==e.type&&"subflow"!==e.type})),n=o.length-1,a=o.length-1;0<=a&&0!==i.size;a--){var r=o[a];i.has(r)&&(a<n&&(o.splice(a,1),o.splice(n,0,r),r._reordered=!0,t.push(r)),n--,i.delete(r))}return 0<t.length&&RED.events.emit("nodes:reorder",{z:e[0].z,nodes:t}),t},moveNodesToBack:function(e){for(var t=[],o=(Array.isArray(e)||(e=[e]),s[e[0].z]),i=new Set(e.filter(function(e){return"group"!==e.type&&"subflow"!==e.type})),n=0,a=0;a<o.length&&0!==i.size;a++){var r=o[a];i.has(r)&&(n<a&&(o.splice(a,1),o.splice(n,0,r),r._reordered=!0,t.push(r)),n++,i.delete(r))}return 0<t.length&&RED.events.emit("nodes:reorder",{z:e[0].z,nodes:t}),t},getNodes:function(e){return s[e]},clear:function(){v={},s={}},eachNode:function(e){var t,o,i;for(o in ae)if(ae.hasOwnProperty(o))for(t=s[o],i=0;i<t.length;i++)if(!1===e(t[i]))return;for(o=0;o<d.length;o++)for(t=s[d[o]],i=0;i<t.length;i++)if(!1===e(t[i]))return;if(s._)for(t=s._,i=0;i<t.length;i++)if(!1===e(t[i]))return},filterNodes:function(e){var t=[],o=null,i=!1,n=(e.hasOwnProperty("z")&&(s.hasOwnProperty(e.z)?o=s[e.z]:i=!0),!1);null===o&&(o=Object.keys(v),n=!0);for(var a=0;a<o.length;a++){var r=o[a];n&&(r=v[r]),e.hasOwnProperty("type")&&r.type!==e.type||i&&r.z!==e.z||t.push(r)}return t},getNodeOrder:function(e){return s[e].map(function(e){return e.id})},setNodeOrder:function(e,t){var o={};t.forEach(function(e,t){o[e]=t}),s[e].sort(function(e,t){return e._reordered=!0,t._reordered=!0,o[e.id]-o[t.id]})}});function ue(){for(var e=[],t=0;t<8;t++)e.push(Math.round(255*Math.random()).toString(16).padStart(2,"0"));return e.join("")}function pe(e){var t,o;0!==e.type.indexOf("subflow")?e._=e._def._:(t=e.type.substring(8),(t=RED.nodes.subflow(t))&&t.instances.push(t),e._=RED._),"config"==e._def.category?ie[e.id]=e:(e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.dirty=!0,T(e),"subflows"==e._def.category&&void 0===e.i&&(o=0,RED.nodes.eachNode(function(e){o=Math.max(o,e.i||0)}),e.i=o+1),se.addNode(e),c[e.id]||(c[e.id]={in:[],out:[]})),RED.events.emit("nodes:add",e)}function fe(t){if(c[t.source.id]&&!c[t.source.id].out.every(function(e){return e.sourcePort!==t.sourcePort||e.target.id!==t.target.id}))return;h.push(t),t.source&&(c[t.source.id]||(c[t.source.id]={in:[],out:[]}),c[t.source.id].out.push(t)),t.target&&(c[t.target.id]||(c[t.target.id]={in:[],out:[]}),c[t.target.id].in.push(t)),t.source.z===t.target.z&&l[t.source.z]&&l[t.source.z].push(t),RED.events.emit("links:add",t)}function w(e){return e in ie?ie[e]:se.getNode(e)}function E(e){var t,o=[],i=[];if(e in ie)t=ie[e],delete ie[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(se.hasNode(e)){t=se.getNode(e),se.removeNode(t),delete c[e],(o=h.filter(function(e){return e.source===t||e.target===t})).forEach(D);var a,r,s,d=!1;for(a in t._def.defaults)!t._def.defaults.hasOwnProperty(a)||(r=t._def.defaults[a]).type&&(!(r=re.getNodeType(r.type))||"config"!=r.category||(r=ie[t[a]])&&(d=!0,r._def.exclusive?(E(t[a]),i.push(r)):((s=r.users).splice(s.indexOf(t),1),RED.events.emit("nodes:change",r))));0===t.type.indexOf("subflow:")&&(e=t.type.substring(8),(e=RED.nodes.subflow(e))&&e.instances.splice(e.instances.indexOf(t),1)),d&&RED.workspaces.refresh();try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&(console.log("Deprecated API warning: node type ",t.type," has an onremove function - should be oneditremove - please report"),t._def.onremove.call(n)),{links:o,nodes:i}}function D(e){var t,o=h.indexOf(e);-1!=o&&(h.splice(o,1),e.source&&c[e.source.id]&&(-1!==(t=c[e.source.id].out.indexOf(e))&&c[e.source.id].out.splice(t,1)),e.target&&c[e.target.id]&&(-1!==(t=c[e.target.id].in.indexOf(e))&&c[e.target.id].in.splice(t,1)),e.source.z===e.target.z&&l[e.source.z]&&-1!==(o=l[e.source.z].indexOf(e))&&l[e.source.z].splice(o,1)),RED.events.emit("links:remove",e)}function he(e,t){ne[e.id]=e,se.addTab(e.id),l[e.id]=[],e._def=RED.nodes.getType("tab"),void 0===t?d.push(e.id):d.splice(t,0,e.id),RED.events.emit("flows:add",e),void 0!==t&&RED.events.emit("flows:reorder",d)}function ge(t,e){var o,i;e&&((e=Object.keys(ae).map(function(e){return ae[e].name})).sort(),o=1,i=t.name,e.forEach(function(e){i==e&&(o++,i=t.name+" ("+o+")")}),t.name=i),ae[t.id]=t,se.addTab(t.id),l[t.id]=[],RED.nodes.registerType("subflow:"+t.id,{defaults:{name:{value:""},env:{value:[]}},icon:function(){return t.icon||"subflow.svg"},category:t.category||"subflows",inputs:t.in.length,outputs:t.out.length,color:t.color||"#DDAA99",label:function(){return this.name||RED.nodes.subflow(t.id).name},labelStyle:function(){return this.name?"red-ui-flow-node-label-italic":""},paletteLabel:function(){return RED.nodes.subflow(t.id).name},inputLabels:function(e){return t.inputLabels?t.inputLabels[e]:null},outputLabels:function(e){return t.outputLabels?t.outputLabels[e]:null},oneditprepare:function(){"subflow"!==this.type?RED.subflow.buildEditForm("subflow",this):RED.subflow.buildEditForm("subflow-template",this)},oneditresize:function(e){"subflow"===this.type&&$("#node-input-env-container").editableList("height",e.height-80)},set:{module:"node-red"}}),t.instances=[],t._def=RED.nodes.getType("subflow:"+t.id),RED.events.emit("subflows:add",t)}function me(e){return ae[e]}function be(e,t){for(var o=se.getNodes(e),i=0;i<o.length;i++){var n=o[i],n=/^subflow:(.+)$/.exec(n.type);if(n){if(n[1]===t)return!0;if(be(n[1],t))return!0}}return!1}function e(e,t){RED.view.selection();for(var o=new Set,i=[e],n=!0;0<i.length;){var a=i.shift(),r=(o.add(a),[]);n&&t&&(!n||"up"!==t)||(r=r.concat(c[a.id].in)),n&&t&&(!n||"down"!==t)||(r=r.concat(c[a.id].out)),n=!1,r.forEach(function(e){o.has(e.source)||i.push(e.source),o.has(e.target)||i.push(e.target)})}return Array.from(o)}function R(e,t){var o,i=!0,n=(t&&t.hasOwnProperty("credentials")&&(i=t.credentials),{});for(o in n.id=e.id,n.type=e.type,e._def.defaults)e._def.defaults.hasOwnProperty(o)&&(n[o]=e[o]);if(i){var a={};if(e.credentials){for(var r in e.credentials)e.credentials.hasOwnProperty(r)&&(!e.credentials._||e.credentials["has_"+r]!=e.credentials._["has_"+r]||e.credentials["has_"+r]&&e.credentials[r])&&(a[r]=e.credentials[r]);0<Object.keys(a).length&&(n.credentials=a)}}return n}function x(t,e){var o=!0,c=!1;if(!1===e?o=!1:"object"==typeof e&&(e.hasOwnProperty("credentials")&&(o=e.credentials),e.hasOwnProperty("dimensions")&&(c=e.dimensions)),"tab"===t.type)return R(t,{credentials:o});var i={};if(i.id=t.id,i.type=t.type,i.z=t.z,0!==i.z&&""!==i.z||delete i.z,!0===t.d&&(i.d=!0),t.g&&(i.g=t.g),"unknown"==i.type)for(var n in t._orig)t._orig.hasOwnProperty(n)&&(i[n]=t._orig[n]);else{for(var a in t._def.defaults)t._def.defaults.hasOwnProperty(a)&&(i[a]=t[a]);if(o){var r={};if((/^subflow:/.test(i.type)||"group"===i.type)&&t.credentials)for(var s in t.credentials)t.credentials.hasOwnProperty(s)&&(!t.credentials._||t.credentials["has_"+s]!=t.credentials._["has_"+s]||t.credentials["has_"+s]&&t.credentials[s])&&(r[s]=t.credentials[s]);else if(t.credentials)for(var d in i.credentials={},t._def.credentials)t._def.credentials.hasOwnProperty(d)&&("password"==t._def.credentials[d].type?(!t.credentials._||t.credentials["has_"+d]!=t.credentials._["has_"+d]||t.credentials["has_"+d]&&t.credentials[d])&&(r[d]=t.credentials[d]):null==t.credentials[d]||t.credentials._&&t.credentials[d]==t.credentials._[d]||(r[d]=t.credentials[d]));0<Object.keys(r).length&&(i.credentials=r)}}if("group"===t.type&&(i.x=t.x,i.y=t.y,i.w=t.w,i.h=t.h,i.nodes=i.nodes.filter(function(e){return!!e}).map(function(e){return e.id})),"tab"!==t.type&&"group"!==t.type||i.env&&0===i.env.length&&delete i.env,"config"!=t._def.category){i.x=t.x,i.y=t.y,c&&(t.hasOwnProperty("w")||(e=RED.view.calculateNodeDimensions(t),t.w=e[0],t.h=e[1]),i.w=t.w,i.h=t.h),i.wires=[];for(var u=0;u<t.outputs;u++)i.wires.push([]);for(var p=h.filter(function(e){return e.source===t}),f=0;f<p.length;f++){var l=p[f];"subflow"!=l.target.type&&l.sourcePort<i.wires.length&&i.wires[l.sourcePort].push(l.target.id)}0<t.inputs&&t.inputLabels&&!/^\s*$/.test(t.inputLabels.join(""))&&(i.inputLabels=t.inputLabels.slice()),0<t.outputs&&t.outputLabels&&!/^\s*$/.test(t.outputLabels.join(""))&&(i.outputLabels=t.outputLabels.slice()),t._def.defaults&&t._def.defaults.hasOwnProperty("icon")||!t.icon||(o=RED.utils.getDefaultNodeIcon(t._def,t),t.icon!==o.module+"/"+o.file&&(i.icon=t.icon)),t._def.defaults&&t._def.defaults.hasOwnProperty("l")||!t.hasOwnProperty("l")||(!t._def.hasOwnProperty("showLabel")||t._def.showLabel)!=t.l&&(i.l=t.l)}return t.info&&(i.info=t.info),i}function _(a,e){var t=!0,r=(!1===e?t=!1:"object"==typeof e&&(e.hasOwnProperty("credentials")&&(t=e.credentials),e.hasOwnProperty("dimensions")&&e.dimensions),{});if(r.id=a.id,r.type=a.type,r.name=a.name,r.info=a.info,r.category=a.category,r.in=[],r.out=[],r.env=a.env,r.meta=a.meta,t){var o,n={};for(o in a.credentials)a.credentials.hasOwnProperty(o)&&(!a.credentials._||a.credentials["has_"+o]!=a.credentials._["has_"+o]||a.credentials["has_"+o]&&a.credentials[o])&&(n[o]=a.credentials[o]);0<Object.keys(n).length&&(r.credentials=n)}return r.color=a.color,a.in.forEach(function(t){for(var e={x:t.x,y:t.y,wires:[]},o=h.filter(function(e){return e.source===t}),i=0;i<o.length;i++){var n=o[i];"subflow"!=n.target.type&&e.wires.push({id:n.target.id})}r.in.push(e)}),a.out.forEach(function(t,e){var o={x:t.x,y:t.y,wires:[]},n=h.filter(function(e){return e.target===t});for(i=0;i<n.length;i++)"subflow"!=n[i].source.type?o.wires.push({id:n[i].source.id,port:n[i].sourcePort}):o.wires.push({id:a.id,port:0});r.out.push(o)}),0<r.in.length&&a.inputLabels&&!/^\s*$/.test(a.inputLabels.join(""))&&(r.inputLabels=a.inputLabels.slice()),0<r.out.length&&a.outputLabels&&!/^\s*$/.test(a.outputLabels.join(""))&&(r.outputLabels=a.outputLabels.slice()),a.icon&&"node-red/subflow.svg"!==a.icon&&(r.icon=a.icon),a.status&&(r.status={x:a.status.x,y:a.status.y,wires:[]},h.forEach(function(e){e.target===a.status&&("subflow"!=e.source.type?r.status.wires.push({id:e.source.id,port:e.sourcePort}):r.status.wires.push({id:a.id,port:0}))})),r}function ve(o,t,e,i){var n=[];t=t||{},o=o.filter(function(e){return!t[e.id]&&(t[e.id]=!0)}),i=i||{},e=e||{};for(var a=0;a<o.length;a++){var r,c,s=o[a];if("subflow:"==s.type.substring(0,8)&&(e[r=s.type.substring(8)]||(e[r]=!0,p=me(r),(c=se.getNodes(r).slice()).unshift(p),RED.nodes.eachConfig(function(e){e.z==r&&(c.push(e),i[e.id]=!0)}),n=ve(c,t,e,i).concat(n))),"subflow"!==s.type){var d,l,u=RED.nodes.convertNode(s);for(d in s._def.defaults)s._def.defaults[d].type&&(l=s[d],0===(l=(l=Array.isArray(l)?l:[l]).filter(function(e){var t;return!(e in ie)||!1!==(t=ie[e])._def.exportable&&(e in i||(i[e]=!0,o.push(t)),!0)})).length?u[d]=Array.isArray(s[d])?[]:"":u[d]=Array.isArray(s[d])?l:l[0]);n.push(u),"group"===s.type&&(n=n.concat(ve(s.nodes,t,e,i)))}else{var p=_(s);n.push(p)}}return n}function ye(e){var o={tabs:{},subflows:{},groups:{},configs:{},nodes:{},all:[],conflicted:{},zMap:{}};return e.forEach(function(e){o.all.push(e),"tab"===e.type?o.tabs[e.id]=e:"subflow"===e.type?o.subflows[e.id]=e:"group"===e.type?o.groups[e.id]=e:e.hasOwnProperty("x")&&e.hasOwnProperty("y")?o.nodes[e.id]=e:o.configs[e.id]=e;var t=e.z||"__global__";o.zMap[t]=o.zMap[t]||[],o.zMap[t].push(e),(se.hasNode(e.id)||ie[e.id]||ne[e.id]||ae[e.id]||ce[e.id])&&(o.conflicted[e.id]=e)}),o}function we(e){var a={},r={},o={},s=[],e=(e.forEach(function(e){"subflow"===e.type?r[e.id]=e:e.hasOwnProperty("x")||e.hasOwnProperty("y")||(o[e.id]=e),e.z&&(a[e.z]=a[e.z]||[],a[e.z].push(e))}),Object.keys(o)),t=(e.forEach(function(e){var t=o[e];r[t.z]&&delete o[e]}),e=Object.keys(o),Object.keys(r));return t.forEach(function(e){var t,o,i,n=r[e];s=s.concat((t=me(t=e),(i=se.getNodes(t.id))?(o=i.slice()).unshift(t):o=[t],console.log(o),ve(o))),RED.subflow.removeSubflow(n.id,!0),k([n].concat(a[n.id]));r[e]=me(e)}),RED.nodes.eachNode(function(e){var t;/^subflow:/.test(e.type)&&(t=e.type.substring(8),r[t]&&(r[t].instances.push(e),e._def=RED.nodes.getType(e.type),e.dirty=!0,e.changed=!0,e._colorChanged=!0))}),t.forEach(function(e){e=r[e];RED.events.emit("subflows:change",e)}),RED.utils.clearNodeColorCache(),e.forEach(function(e){s=s.concat(x(w(e))),E(e),k([o[e]])}),{removedNodes:s}}function k(c,o){(o=o||{generateIds:!1,addFlow:!1}).importMap=o.importMap||{};var u,p=o.generateIds,f=o.addFlow,h={};if("string"==typeof c){if(""===c)return;try{e=JSON.parse(c)}catch(j){var g=new Error(RED._("clipboard.invalidFlow",{message:j.message}));throw g.code="NODE_RED",g}}else e=c;$.isArray(e)||(e=[e]);var m,b={},v=[],y=[],e=e.filter(function(e){var t=e.id;if(b[e.id])return!1;if(b[e.id]=!0,!o.generateIds)if(o.importMap[t]){if("replace"===o.importMap[t])return y.push(e),!1}else{t=se.getNode(t)||ie[t]||ne[t]||ae[t]||ce[t];t&&v.push({existing:t,imported:e})}return!0});if(0<v.length){for(var g=RED._("clipboard.importDuplicate",{count:v.length}),w=$("<ul>"),E=Math.min(5,v.length),t=0;t<E;t++){var D=v[t];$("<li>").text(D.existing.id+" [ "+D.existing.type+(D.imported.type!==D.existing.type?" | "+D.imported.type:"")+" ]").appendTo(w)}E!==v.length&&$("<li>").text(RED._("deploy.confirm.plusNMore",{count:v.length-E})).appendTo(w);c=$("<p>").append(w),g=new Error(g+c.html());throw g.code="import_conflict",g.importConfig=ye(e),g}0<y.length&&(m=we(y).removedNodes);var R,x=!1,_=(le||(x=!0,le=JSON.parse(JSON.stringify(e))),[]);for(t=0;t<e.length;t++){var i;(i=e[t]).id;"workspace"==i.type||"tab"==i.type||"subflow"==i.type||"group"==i.type||re.getNodeType(i.type)||"subflow:"==i.type.substring(0,8)||-1!=_.indexOf(i.type)||_.push(i.type),i.z?(h[i.z]=h[i.z]||[],h[i.z].push(i)):x&&i.hasOwnProperty("x")&&i.hasOwnProperty("y")&&!i.z&&(u||(he(u={id:RED.nodes.id(),type:"tab",disabled:!1,label:RED._("clipboard.recoveredNodes"),info:RED._("clipboard.recoveredNodesInfo"),env:[]}),RED.workspaces.add(u),h[u.id]=[]),i.z=u.id,h[u.id].push(i))}!x&&0<_.length&&(R=$("<ul>"),_.forEach(function(e){$("<li>").text(e).appendTo(R)}),R=R[0].outerHTML,RED.notify("<p>"+RED._("clipboard.importUnrecognised",{count:_.length})+"</p>"+R,"error",!1,1e4));var k=RED.workspaces.active(),T=me(k);for(t=0;t<e.length;t++){var C=/^subflow:(.+)$/.exec(e[t].type);if(C){var j,C=C[1],L=me(k);if(L)if(C===L.id&&(j=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),j=be(C,L.id)?new Error(RED._("notification.errors.cannotAddCircularReference")):j)throw j.code="NODE_RED",j}}var S,n,O,a,N,I=[],P={},A=[],r={},M={},s={},z=[],B=[],G=[],F=new Set,d=null;for(u&&I.push(u),t=0;t<e.length;t++)"workspace"===(i=e[t]).type||"tab"===i.type?("workspace"===i.type&&(i.type="tab"),null==de&&(de=i),0===k&&(k=i.id),p||"copy"===o.importMap[i.id]?(S=ue(),P[i.id]=S,i.id=S):P[i.id]=i.id,he(i),RED.workspaces.add(i),I.push(i)):"subflow"===i.type&&((N=o.importMap[i.id]?N:function(a,r){r=r||[];var s,d=null;return RED.nodes.eachSubflow(function(e){if(e.name==a.name&&e.info==a.info&&e.in.length==a.in.length&&e.out.length==a.out.length){var t=RED.nodes.filterNodes({z:e.id});if(t.length==r.length){var o=[a].concat(r),i=[e].concat(t),n=JSON.stringify(o),o=JSON.stringify(ve(i));for(s=0;s<t.length;s++)n=n.replace(new RegExp('"'+r[s].id+'"',"g"),'"'+t[s].id+'"');if((n=n.replace(new RegExp('"'+a.id+'"',"g"),'"'+e.id+'"'))===o)return d=e,!1}}}),d}(i,h[i.id]))?M[i.id]=N:(r[i.id]=i,!p&&"copy"!==o.importMap[i.id]||(S=ue(),i.id=S),i.in.forEach(function(e,t){e.type="subflow",e.direction="in",e.z=i.id,e.i=t,e.id=ue()}),i.out.forEach(function(e,t){e.type="subflow",e.direction="out",e.z=i.id,e.i=t,e.id=ue()}),i.status&&(i.status.type="subflow",i.status.direction="status",i.status.z=i.id,i.status.id=ue()),A.push(i),ge(i,p||"copy"===o.importMap[i.id])));for(null==de&&(he(de={type:"tab",id:ue(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1}),env:[]}),RED.workspaces.add(de),I.push(de),k=RED.workspaces.active()),t=0;t<e.length;t++)if(i=e[t],(n=re.getNodeType(i.type))&&"config"==n.category){var U=null;if(p||"copy"===o.importMap[i.id]){if(i.z){if(M[i.z])continue;r[i.z]?i.z=r[i.z].id:(i.z=P[i.z],ne[i.z]||(f?(null===d&&(d=RED.workspaces.add(null,!0),I.push(d)),i.z=d.id):i.z=k))}if("copy"!==o.importMap[i.id]&&(U=RED.nodes.node(i.id))&&i.z&&U.z!==i.z)for(var J in U=null,ie)if(ie.hasOwnProperty(J)&&ie[J].z===i.z&&function(e,t,o){if((!o||e.id==t.id)&&e.type==t.type){var i,n=e._def;for(i in n.defaults)if(n.defaults.hasOwnProperty(i)){var a=e[i],r=t[i];if(typeof a!=typeof r)return;if(null===a||"string"==typeof a||"number"==typeof a){if(a!==r)return}else if(JSON.stringify(a)!==JSON.stringify(r))return}return 1}}(ie[J],i,!1)){U=ie[J],s[i.id]=ie[J];break}}else!i.z||P[i.z]||r[i.z]||(i.z=k);if(!U||U._def.exclusive){for(a in O={id:i.id,z:i.z,type:i.type,info:i.info,users:[],_config:{}},i.z||delete O.z,i.hasOwnProperty("d")&&(O.d=i.d),n.defaults)n.defaults.hasOwnProperty(a)&&(O[a]=i[a],O._config[a]=JSON.stringify(i[a]));if(n.hasOwnProperty("credentials")&&i.hasOwnProperty("credentials"))for(a in O.credentials={},n.credentials)n.credentials.hasOwnProperty(a)&&i.credentials.hasOwnProperty(a)&&(O.credentials[a]=i.credentials[a]);O.label=n.label,O._def=n,!p&&"copy"!==o.importMap[i.id]||(O.id=ue()),s[i.id]=O,z.push(O)}}for(t=0;t<e.length;t++)if("workspace"!==(i=e[t]).type&&"tab"!==i.type&&"subflow"!==i.type&&(!(n=re.getNodeType(i.type))||"config"!=n.category)){var l={x:parseFloat(i.x||0),y:parseFloat(i.y||0),z:i.z,type:0,info:i.info,changed:!1,_config:{}};if("group"!==i.type&&(l.wires=i.wires||[],l.inputLabels=i.inputLabels,l.outputLabels=i.outputLabels,l.icon=i.icon),i.hasOwnProperty("l")&&(l.l=i.l),i.hasOwnProperty("d")&&(l.d=i.d),i.hasOwnProperty("g")&&(l.g=i.g),p||"copy"===o.importMap[i.id]){if(M[i.z])continue;r[l.z]?l.z=r[l.z].id:(l.z=P[l.z],ne[l.z]||(f?(null===d&&(d=RED.workspaces.add(null,!0),I.push(d)),l.z=d.id):l.z=k)),l.id=ue()}else l.id=i.id,null!=l.z&&(P[l.z]||r[l.z])||(f?(null===d&&(d=RED.workspaces.add(null,!0),I.push(d)),l.z=d.id):l.z=k);if(l.type=i.type,l._def=n,"group"===l.type){for(a in l._def=RED.group.def,l._def.defaults)l._def.defaults.hasOwnProperty(a)&&"inputs"!==a&&"outputs"!==a&&(l[a]=i[a],l._config[a]=JSON.stringify(i[a]));l._config.x=l.x,l._config.y=l.y}else if("subflow"===i.type.substring(0,7)){var V=i.type.split(":")[1],q=M[V]||r[V]||me(V);!p&&"copy"!==o.importMap[i.id]||(V=q.id,l.type="subflow:"+V,l._def=re.getNodeType(l.type),delete l.i),l.name=i.name,l.outputs=q.out.length,l.inputs=q.in.length,l.env=i.env}else{if(!l._def){l.x&&l.y?l._def={color:"#fee",defaults:{},label:"unknown: "+i.type,labelStyle:"red-ui-flow-node-label-italic",outputs:i.outputs||i.wires&&i.wires.length||0,set:re.getNodeSet("node-red/unknown")}:(l._def={category:"config",set:re.getNodeSet("node-red/unknown")},l.users=[],delete l.x,delete l.y,delete l.wires,delete l.inputLabels,delete l.outputLabels,i.z||delete l.z);var W,K={};for(W in i)i.hasOwnProperty(W)&&"x"!=W&&"y"!=W&&"z"!=W&&"id"!=W&&"wires"!=W&&(K[W]=i[W]);l._orig=K,l.name=i.type,l.type="unknown"}if("config"!=l._def.category){for(a in i.hasOwnProperty("inputs")?(l.inputs=i.inputs,l._config.inputs=JSON.stringify(i.inputs)):l.inputs=l._def.inputs,i.hasOwnProperty("outputs")?(l.outputs=i.outputs,l._config.outputs=JSON.stringify(i.outputs)):l.outputs=l._def.outputs,l.hasOwnProperty("wires")&&l.wires.length>l.outputs&&(l._def.defaults.hasOwnProperty("outputs")&&isNaN(parseInt(i.outputs))?l.outputs=l.wires.length:(console.log("Warning: node.wires longer than node.outputs - trimming wires:",l.id," wires:",l.wires.length," outputs:",l.outputs),l.wires=l.wires.slice(0,l.outputs))),l._def.defaults)l._def.defaults.hasOwnProperty(a)&&"inputs"!==a&&"outputs"!==a&&(l[a]=i[a],l._config[a]=JSON.stringify(i[a]));if(l._config.x=l.x,l._config.y=l.y,l._def.hasOwnProperty("credentials")&&i.hasOwnProperty("credentials"))for(a in l.credentials={},l._def.credentials)l._def.credentials.hasOwnProperty(a)&&i.credentials.hasOwnProperty(a)&&(l.credentials[a]=i.credentials[a])}}"unknown"===(s[i.id]=l).type||"config"!==l._def.category?z.push(l):"group"===l.type&&(G.push(l),F.add(l.id))}for(t=0;t<z.length;t++){if((i=z[t]).wires){for(var H=0;H<i.wires.length;H++)for(var X,Y=i.wires[H]instanceof Array?i.wires[H]:[i.wires[H]],Z=0;Z<Y.length;Z++)s.hasOwnProperty(Y[Z])&&(i.z===s[Y[Z]].z?(fe(X={source:i,sourcePort:H,target:s[Y[Z]]}),B.push(X)):console.log("Warning: dropping link that crosses tabs:",i.id,"->",s[Y[Z]].id));delete i.wires}for(var Q in i.g&&s[i.g]?i.g=s[i.g].id:delete i.g,i._def.defaults)i._def.defaults.hasOwnProperty(Q)&&i._def.defaults[Q].type&&(w=i[Q],w=(w=Array.isArray(w)?w:[w]).map(function(e){var t=s[e];return t?("config"===t._def.category&&-1===t.users.indexOf(i)&&t.users.push(i),t.id):e}),i[Q]=Array.isArray(i[Q])?w:w[0]);T&&/^link /.test(i.type)&&i.links&&(i.links=i.links.filter(function(e){e=RED.nodes.node(e);return e&&e.z===k}))}for(t=0;t<A.length;t++)(i=A[t]).in.forEach(function(t){t.wires.forEach(function(e){e={source:t,sourcePort:0,target:s[e.id]};fe(e),B.push(e)}),delete t.wires}),i.out.forEach(function(t){t.wires.forEach(function(e){e=r[e.id]&&r[e.id].id==i.id?{source:i.in[e.port],sourcePort:e.port,target:t}:{source:s[e.id]||r[e.id],sourcePort:e.port,target:t};fe(e),B.push(e)}),delete t.wires}),i.status&&(i.status.wires.forEach(function(e){e=r[e.id]&&r[e.id].id==i.id?{source:i.in[e.port],sourcePort:e.port,target:i.status}:{source:s[e.id]||r[e.id],sourcePort:e.port,target:i.status};fe(e),B.push(e)}),delete i.status.wires);var ee,te,oe={};for(t=0;t<G.length;t++)(i=G[t]).g&&!F.has(i.g)&&delete i.g,i.nodes=i.nodes.map(function(e){return s[e]}),i.nodes=i.nodes.filter(function(e){return e&&e.g!==i.id&&(e.g=i.id),!!e}),i.g||(oe[i.id]=0);do{for(ee=!1,t=0;t<G.length;t++)(i=G[t]).g&&oe[i.id]!==oe[i.g]+1&&(oe[i.id]=oe[i.g]+1,ee=!0)}while(ee);for(G.sort(function(e,t){return oe[e.id]-oe[t.id]}),t=0;t<G.length;t++)Ee(i=G[t]);for(t=0;t<z.length;t++)pe(l=z[t]);for(t=0;t<z.length;t++){l=z[t];RED.editor.validateNode(l)}return RED.workspaces.refresh(),u&&(te=RED.notify(RED._("clipboard.recoveredNodesNotification",{flowName:RED._("clipboard.recoveredNodes")}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){te.close()}}]})),{nodes:z,links:B,groups:G,workspaces:I,subflows:A,missingWorkspace:d,removedNodes:m}}function T(e){for(var t in e._def.defaults){var o;!e._def.defaults.hasOwnProperty(t)||(o=e._def.defaults[t]).type&&(!(o=re.getNodeType(o.type))||"config"!=o.category||(o=ie[e[t]])&&-1===o.users.indexOf(e)&&(o.users.push(e),RED.events.emit("nodes:change",o)))}}function Ee(e){u[e.z]=u[e.z]||[],u[e.z].push(e),ce[e.id]=e,RED.events.emit("groups:add",e)}function C(e){var t=u[e.z].indexOf(e);u[e.z].splice(t,1),0===u[e.z].length&&delete u[e.z],e.g&&ce[e.g]&&(t=ce[e.g].nodes.indexOf(e),ce[e.g].nodes.splice(t,1)),RED.group.markDirty(e),delete ce[e.id],RED.events.emit("groups:remove",e)}return{init:function(){RED.events.on("registry:node-type-added",function(t){re.getNodeType(t);var o,i,n,a={},e=(RED.nodes.eachNode(function(e){"unknown"===e.type&&e.name===t&&(a[e.id]=e)}),RED.nodes.eachConfig(function(e){"unknown"===e.type&&e.name===t&&(a[e.id]=e)}),Object.keys(a));0<e.length&&(o=[],e.forEach(function(e){e=a[e];ie.hasOwnProperty(e.id)?delete ie[e.id]:se.removeNode(e),o.push(x(e)),RED.events.emit("nodes:remove",e)}),i=[],RED.nodes.eachLink(function(e){a.hasOwnProperty(e.source.id)&&a.hasOwnProperty(e.target.id)&&i.push(e)}),i.forEach(D),RED.view.redraw(!0,!0),e=k(o,{generateIds:!1}),n={},e.nodes.forEach(function(e){n[e.id]=e}),RED.nodes.eachLink(function(e){n.hasOwnProperty(e.source.id)&&(e.source=n[e.source.id]),n.hasOwnProperty(e.target.id)&&(e.target=n[e.target.id])}),RED.view.redraw(!0))})},registry:re,setNodeList:re.setNodeList,getNodeSet:re.getNodeSet,addNodeSet:re.addNodeSet,removeNodeSet:re.removeNodeSet,enableNodeSet:re.enableNodeSet,disableNodeSet:re.disableNodeSet,setIconSets:re.setIconSets,getIconSets:re.getIconSets,registerType:re.registerNodeType,getType:re.getNodeType,getNodeHelp:function(e){var t="";return(e=$("script[data-help-name='"+e+"']"))&&(t=e.html(),"text/markdown"===e.attr("type")&&(t=RED.utils.renderMarkdown(t))),t},convertNode:x,add:pe,remove:E,clear:function(){h=[],l={},c={},ie={},d=[],ce={},u={},Object.keys(ae).forEach(function(e){RED.subflow.removeSubflow(e)}),Object.keys(ne).forEach(function(e){RED.workspaces.remove(ne[e])}),le=de=null,ne={},se.clear(),RED.nodes.dirty(!1),RED.view.redraw(!0,!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.sidebar.info.refresh(),RED.events.emit("workspace:clear")},detachNodes:function(e){let o=[];if(e.forEach(e=>{var t;"group"===e.type?(t=RED.group.getNodes(e,!0,!0),o=o.concat(t)):o.push(e)}),0<o.length){const i=RED.nodes.getNodeIslands(o);let t=[],d=[],l=new Set;return i.forEach(e=>{let s=new Set(e),o=[],i=[];e.forEach(e=>{var t=RED.nodes.getNodeLinks(e,1),e=RED.nodes.getNodeLinks(e,0);t.forEach(e=>{s.has(e.source)||o.push(e)}),e.forEach(e=>{s.has(e.target)||i.push(e)})}),o.forEach(o=>{let i=o.source,t=new Set,n=new Set,a=[o.target];for(;0<a.length;){var r=a.pop(a);n.add(r);let e=RED.nodes.getNodeLinks(r,0);e.forEach(e=>{n.has(e.target)||(n.add(e.target),s.has(e.target)?a.push(e.target):t.add(e.target))})}t.forEach(e=>{var t=`${i.id}[${o.sourcePort}] -> `+e.id;l.has(t)||(l.add(t),t={source:i,sourcePort:o.sourcePort,target:e},0===RED.nodes.filterLinks(t).length&&d.push(t))})}),o.forEach(e=>{RED.nodes.removeLink(e),t.push(e)}),i.forEach(e=>{RED.nodes.removeLink(e),t.push(e)})}),d.forEach(e=>RED.nodes.addLink(e)),{newLinks:d,removedLinks:t}}},moveNodesForwards:function(e){return se.moveNodesForwards(e)},moveNodesBackwards:function(e){return se.moveNodesBackwards(e)},moveNodesToFront:function(e){return se.moveNodesToFront(e)},moveNodesToBack:function(e){return se.moveNodesToBack(e)},getNodeOrder:function(e){return se.getNodeOrder(e)},setNodeOrder:function(e,t){se.setNodeOrder(e,t)},moveNodeToTab:function(e,o){if("group"===e.type)return i=o,a=u[(t=e).z].indexOf(t),u[t.z].splice(a,1),u[i]=u[i]||[],u[i].push(t),t.z=i,void RED.events.emit("groups:change",t);var t,i,n=e.z,a=(se.moveNode(e,o),c[e.id]);a&&(a.in.forEach(function(e){var t=l[n].indexOf(e);-1!=t&&l[n].splice(t,1),e.source.z===o&&l[o]&&l[o].push(e)}),a.out.forEach(function(e){var t=l[n].indexOf(e);-1!=t&&l[n].splice(t,1),e.target.z===o&&l[o]&&l[o].push(e)})),RED.events.emit("nodes:change",e)},addLink:fe,removeLink:D,getNodeLinks:function(e,t){return"string"!=typeof e&&(e=e.id),c[e]?[].concat(1===t?c[e].in:c[e].out):[]},addWorkspace:he,removeWorkspace:function(e){var t,o,i=ne[e],n=[],a=[],r=[];if(i){for(t in delete ne[e],delete l[e],d.splice(d.indexOf(e),1),se.hasTab(e)&&(n=se.getNodes(e).slice()),ie)ie.hasOwnProperty(t)&&(o=ie[t]).z==e&&n.push(o);for(t=0;t<n.length;t++)var s=E(n[t].id),a=a.concat(s.links);for(r=(u[e]||[]).filter(function(e){return!e.g}),t=0;t<r.length;t++)r[t].nodes.forEach(function(e){"group"===e.type&&r.push(e)});for(t=r.length-1;0<=t;t--)C(r[t]);se.removeTab(e),RED.events.emit("flows:remove",i)}return{nodes:n,links:a,groups:r}},getWorkspaceOrder:function(){return d},setWorkspaceOrder:function(e){d=e},workspace:function(e){return ne[e]},addSubflow:ge,removeSubflow:function(e){ae[e.id]&&(delete ae[e.id],se.removeTab(e.id),re.removeNodeType("subflow:"+e.id),RED.events.emit("subflows:remove",e))},subflow:me,subflowContains:be,addGroup:Ee,removeGroup:C,group:function(e){return ce[e]},groups:function(e){return u[e]?u[e].slice():[]},eachNode:function(e){se.eachNode(e)},eachLink:function(e){for(var t=0;t<h.length&&!1!==e(h[t]);t++);},eachConfig:function(e){for(var t in ie)if(ie.hasOwnProperty(t)&&!1===e(ie[t]))break},eachSubflow:function(e){for(var t in ae)if(ae.hasOwnProperty(t)&&!1===e(ae[t]))break},eachWorkspace:function(e){for(var t=0;t<d.length&&!1!==e(ne[d[t]]);t++);},node:w,version:function(e){if(void 0===e)return t;t=e},originalFlow:function(e){if(void 0===e)return le;le=e},filterNodes:function(e){return se.filterNodes(e)},filterLinks:function(e){var t,o=[],i=[],n=!1,a=e.source&&e.source.z,r=e.target&&e.target.z;(t=a||r?a!==r&&void 0===a?r:a:t)?(i=l[t]||[],n=!0):e.source&&e.source.hasOwnProperty("id")?c[e.source.id]&&(n=!0,i=i.concat(c[e.source.id].out)):e.target&&e.target.hasOwnProperty("id")&&c[e.target.id]&&(n=!0,i=i.concat(c[e.target.id].in)),n||(i=h);for(var s=0;s<i.length;s++){var d=i[s];if(e.source){if(e.source.hasOwnProperty("id")&&d.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&d.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&d.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&d.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&d.sourcePort!==e.sourcePort||o.push(d)}return o},import:k,identifyImportConflicts:ye,getAllFlowNodes:e,getAllUpstreamNodes:function(t){return e(t,"up").filter(function(e){return e!==t})},getAllDownstreamNodes:function(t){return e(t,"down").filter(function(e){return e!==t})},getNodeIslands:function(e){var o=new Set(e),n=new Map,a=new Map,i=new Set;e.forEach((e,t)=>{n.set(e,t),a.set(t,[e]);t=RED.nodes.getNodeLinks(e,1),e=RED.nodes.getNodeLinks(e,0);t.forEach(e=>{o.has(e.source)&&i.add(e)}),e.forEach(e=>{o.has(e.target)&&i.add(e)})}),i.forEach(o=>{var i=o.source,o=o.target;if(n.get(i)!==n.get(o)){let t=n.get(i);i=n.get(o);let e=a.get(i);e.forEach(e=>{n.set(e,t),a.get(t).push(e)}),a.delete(i)}});const r=[];return a.forEach((e,t)=>{r.push(e)}),r},createExportableNodeSet:ve,createCompleteNodeSet:function(t){for(var o=[],e=0;e<d.length;e++)"tab"==ne[d[e]].type&&o.push(R(ne[d[e]],t));for(e in ae)ae.hasOwnProperty(e)&&o.push(_(ae[e],t));for(e in ce)ce.hasOwnProperty(e)&&o.push(x(ce[e],t));for(e in ie)ie.hasOwnProperty(e)&&o.push(x(ie[e],t));return RED.nodes.eachNode(function(e){o.push(x(e,t))}),o},updateConfigNodeUsers:T,id:ue,dirty:function(e){if(null==e)return o;o=e,RED.events.emit("workspace:dirty",{dirty:o})}}}(),RED.nodes.fontAwesome=function(){var t={"fa-address-book-o":"","fa-address-book":"","fa-address-card-o":"","fa-address-card":"","fa-adjust":"","fa-align-center":"","fa-align-justify":"","fa-align-left":"","fa-align-right":"","fa-ambulance":"","fa-american-sign-language-interpreting":"","fa-anchor":"","fa-angle-double-down":"","fa-angle-double-left":"","fa-angle-double-right":"","fa-angle-double-up":"","fa-angle-down":"","fa-angle-left":"","fa-angle-right":"","fa-angle-up":"","fa-archive":"","fa-area-chart":"","fa-arrow-circle-down":"","fa-arrow-circle-left":"","fa-arrow-circle-o-down":"","fa-arrow-circle-o-left":"","fa-arrow-circle-o-right":"","fa-arrow-circle-o-up":"","fa-arrow-circle-right":"","fa-arrow-circle-up":"","fa-arrow-down":"","fa-arrow-left":"","fa-arrow-right":"","fa-arrow-up":"","fa-arrows-alt":"","fa-arrows-h":"","fa-arrows-v":"","fa-arrows":"","fa-asl-interpreting":"","fa-assistive-listening-systems":"","fa-asterisk":"","fa-at":"","fa-audio-description":"","fa-automobile":"","fa-backward":"","fa-balance-scale":"","fa-ban":"","fa-bank":"","fa-bar-chart-o":"","fa-bar-chart":"","fa-barcode":"","fa-bars":"","fa-bath":"","fa-bathtub":"","fa-battery-0":"","fa-battery-1":"","fa-battery-2":"","fa-battery-3":"","fa-battery-4":"","fa-battery-empty":"","fa-battery-full":"","fa-battery-half":"","fa-battery-quarter":"","fa-battery-three-quarters":"","fa-battery":"","fa-bed":"","fa-beer":"","fa-bell-o":"","fa-bell-slash-o":"","fa-bell-slash":"","fa-bell":"","fa-bicycle":"","fa-binoculars":"","fa-birthday-cake":"","fa-blind":"","fa-bold":"","fa-bolt":"","fa-bomb":"","fa-book":"","fa-bookmark-o":"","fa-bookmark":"","fa-braille":"","fa-briefcase":"","fa-bug":"","fa-building-o":"","fa-building":"","fa-bullhorn":"","fa-bullseye":"","fa-bus":"","fa-cab":"","fa-calculator":"","fa-calendar-check-o":"","fa-calendar-minus-o":"","fa-calendar-o":"","fa-calendar-plus-o":"","fa-calendar-times-o":"","fa-calendar":"","fa-camera-retro":"","fa-camera":"","fa-car":"","fa-caret-down":"","fa-caret-left":"","fa-caret-right":"","fa-caret-square-o-down":"","fa-caret-square-o-left":"","fa-caret-square-o-right":"","fa-caret-square-o-up":"","fa-caret-up":"","fa-cart-arrow-down":"","fa-cart-plus":"","fa-cc":"","fa-certificate":"","fa-chain-broken":"","fa-chain":"","fa-check-circle-o":"","fa-check-circle":"","fa-check-square-o":"","fa-check-square":"","fa-check":"","fa-chevron-circle-down":"","fa-chevron-circle-left":"","fa-chevron-circle-right":"","fa-chevron-circle-up":"","fa-chevron-down":"","fa-chevron-left":"","fa-chevron-right":"","fa-chevron-up":"","fa-child":"","fa-circle-o-notch":"","fa-circle-o":"","fa-circle-thin":"","fa-circle":"","fa-clipboard":"","fa-clock-o":"","fa-clone":"","fa-close":"","fa-cloud-download":"","fa-cloud-upload":"","fa-cloud":"","fa-cny":"","fa-code-fork":"","fa-code":"","fa-coffee":"","fa-cog":"","fa-cogs":"","fa-columns":"","fa-comment-o":"","fa-comment":"","fa-commenting-o":"","fa-commenting":"","fa-comments-o":"","fa-comments":"","fa-compass":"","fa-compress":"","fa-copy":"","fa-copyright":"","fa-creative-commons":"","fa-credit-card-alt":"","fa-credit-card":"","fa-crop":"","fa-crosshairs":"","fa-cube":"","fa-cubes":"","fa-cut":"","fa-cutlery":"","fa-dashboard":"","fa-database":"","fa-deaf":"","fa-deafness":"","fa-dedent":"","fa-desktop":"","fa-diamond":"","fa-dollar":"","fa-dot-circle-o":"","fa-download":"","fa-drivers-license-o":"","fa-drivers-license":"","fa-edit":"","fa-eject":"","fa-ellipsis-h":"","fa-ellipsis-v":"","fa-envelope-o":"","fa-envelope-open-o":"","fa-envelope-open":"","fa-envelope-square":"","fa-envelope":"","fa-eraser":"","fa-eur":"","fa-euro":"","fa-exchange":"","fa-exclamation-circle":"","fa-exclamation-triangle":"","fa-exclamation":"","fa-expand":"","fa-external-link-square":"","fa-external-link":"","fa-eye-slash":"","fa-eye":"","fa-eyedropper":"","fa-fast-backward":"","fa-fast-forward":"","fa-fax":"","fa-feed":"","fa-female":"","fa-fighter-jet":"","fa-file-archive-o":"","fa-file-audio-o":"","fa-file-code-o":"","fa-file-excel-o":"","fa-file-image-o":"","fa-file-movie-o":"","fa-file-o":"","fa-file-pdf-o":"","fa-file-photo-o":"","fa-file-picture-o":"","fa-file-powerpoint-o":"","fa-file-sound-o":"","fa-file-text-o":"","fa-file-text":"","fa-file-video-o":"","fa-file-word-o":"","fa-file-zip-o":"","fa-file":"","fa-files-o":"","fa-film":"","fa-filter":"","fa-fire-extinguisher":"","fa-fire":"","fa-flag-checkered":"","fa-flag-o":"","fa-flag":"","fa-flash":"","fa-flask":"","fa-floppy-o":"","fa-folder-o":"","fa-folder-open-o":"","fa-folder-open":"","fa-folder":"","fa-font":"","fa-forward":"","fa-frown-o":"","fa-futbol-o":"","fa-gamepad":"","fa-gavel":"","fa-gbp":"","fa-gear":"","fa-gears":"","fa-genderless":"","fa-gift":"","fa-glass":"","fa-globe":"","fa-graduation-cap":"","fa-group":"","fa-h-square":"","fa-hand-grab-o":"","fa-hand-lizard-o":"","fa-hand-o-down":"","fa-hand-o-left":"","fa-hand-o-right":"","fa-hand-o-up":"","fa-hand-paper-o":"","fa-hand-peace-o":"","fa-hand-pointer-o":"","fa-hand-rock-o":"","fa-hand-scissors-o":"","fa-hand-spock-o":"","fa-hand-stop-o":"","fa-handshake-o":"","fa-hard-of-hearing":"","fa-hashtag":"","fa-hdd-o":"","fa-header":"","fa-headphones":"","fa-heart-o":"","fa-heart":"","fa-heartbeat":"","fa-history":"","fa-home":"","fa-hospital-o":"","fa-hotel":"","fa-hourglass-1":"","fa-hourglass-2":"","fa-hourglass-3":"","fa-hourglass-end":"","fa-hourglass-half":"","fa-hourglass-o":"","fa-hourglass-start":"","fa-hourglass":"","fa-i-cursor":"","fa-id-badge":"","fa-id-card-o":"","fa-id-card":"","fa-ils":"","fa-image":"","fa-inbox":"","fa-indent":"","fa-industry":"","fa-info-circle":"","fa-info":"","fa-inr":"","fa-institution":"","fa-intersex":"","fa-italic":"","fa-jpy":"","fa-key":"","fa-keyboard-o":"","fa-krw":"","fa-language":"","fa-laptop":"","fa-leaf":"","fa-legal":"","fa-lemon-o":"","fa-level-down":"","fa-level-up":"","fa-life-bouy":"","fa-life-buoy":"","fa-life-ring":"","fa-life-saver":"","fa-lightbulb-o":"","fa-line-chart":"","fa-link":"","fa-list-alt":"","fa-list-ol":"","fa-list-ul":"","fa-list":"","fa-location-arrow":"","fa-lock":"","fa-long-arrow-down":"","fa-long-arrow-left":"","fa-long-arrow-right":"","fa-long-arrow-up":"","fa-low-vision":"","fa-magic":"","fa-magnet":"","fa-mail-forward":"","fa-mail-reply-all":"","fa-mail-reply":"","fa-male":"","fa-map-marker":"","fa-map-o":"","fa-map-pin":"","fa-map-signs":"","fa-map":"","fa-mars-double":"","fa-mars-stroke-h":"","fa-mars-stroke-v":"","fa-mars-stroke":"","fa-mars":"","fa-medkit":"","fa-meh-o":"","fa-mercury":"","fa-microchip":"","fa-microphone-slash":"","fa-microphone":"","fa-minus-circle":"","fa-minus-square-o":"","fa-minus-square":"","fa-minus":"","fa-mobile-phone":"","fa-mobile":"","fa-money":"","fa-moon-o":"","fa-mortar-board":"","fa-motorcycle":"","fa-mouse-pointer":"","fa-music":"","fa-navicon":"","fa-neuter":"","fa-newspaper-o":"","fa-object-group":"","fa-object-ungroup":"","fa-outdent":"","fa-paint-brush":"","fa-paper-plane-o":"","fa-paper-plane":"","fa-paperclip":"","fa-paragraph":"","fa-paste":"","fa-pause-circle-o":"","fa-pause-circle":"","fa-pause":"","fa-paw":"","fa-pencil-square-o":"","fa-pencil-square":"","fa-pencil":"","fa-percent":"","fa-phone-square":"","fa-phone":"","fa-photo":"","fa-picture-o":"","fa-pie-chart":"","fa-plane":"","fa-play-circle-o":"","fa-play-circle":"","fa-play":"","fa-plug":"","fa-plus-circle":"","fa-plus-square-o":"","fa-plus-square":"","fa-plus":"","fa-podcast":"","fa-power-off":"","fa-print":"","fa-puzzle-piece":"","fa-qrcode":"","fa-question-circle-o":"","fa-question-circle":"","fa-question":"","fa-quote-left":"","fa-quote-right":"","fa-random":"","fa-recycle":"","fa-refresh":"","fa-registered":"","fa-remove":"","fa-reorder":"","fa-repeat":"","fa-reply-all":"","fa-reply":"","fa-retweet":"","fa-rmb":"","fa-road":"","fa-rocket":"","fa-rotate-left":"","fa-rotate-right":"","fa-rouble":"","fa-rss-square":"","fa-rss":"","fa-rub":"","fa-ruble":"","fa-rupee":"","fa-s15":"","fa-save":"","fa-scissors":"","fa-search-minus":"","fa-search-plus":"","fa-search":"","fa-send-o":"","fa-send":"","fa-server":"","fa-share-square-o":"","fa-share-square":"","fa-share":"","fa-shekel":"","fa-sheqel":"","fa-shield":"","fa-ship":"","fa-shopping-bag":"","fa-shopping-basket":"","fa-shopping-cart":"","fa-shower":"","fa-sign-in":"","fa-sign-language":"","fa-sign-out":"","fa-signal":"","fa-signing":"","fa-sitemap":"","fa-sliders":"","fa-smile-o":"","fa-snowflake-o":"","fa-soccer-ball-o":"","fa-sort-alpha-asc":"","fa-sort-alpha-desc":"","fa-sort-amount-asc":"","fa-sort-amount-desc":"","fa-sort-asc":"","fa-sort-desc":"","fa-sort-down":"","fa-sort-numeric-asc":"","fa-sort-numeric-desc":"","fa-sort-up":"","fa-sort":"","fa-space-shuttle":"","fa-spinner":"","fa-spoon":"","fa-square-o":"","fa-square":"","fa-star-half-empty":"","fa-star-half-full":"","fa-star-half-o":"","fa-star-half":"","fa-star-o":"","fa-star":"","fa-step-backward":"","fa-step-forward":"","fa-stethoscope":"","fa-sticky-note-o":"","fa-sticky-note":"","fa-stop-circle-o":"","fa-stop-circle":"","fa-stop":"","fa-street-view":"","fa-strikethrough":"","fa-subscript":"","fa-subway":"","fa-suitcase":"","fa-sun-o":"","fa-superscript":"","fa-support":"","fa-table":"","fa-tablet":"","fa-tachometer":"","fa-tag":"","fa-tags":"","fa-tasks":"","fa-taxi":"","fa-television":"","fa-terminal":"","fa-text-height":"","fa-text-width":"","fa-th-large":"","fa-th-list":"","fa-th":"","fa-thermometer-0":"","fa-thermometer-1":"","fa-thermometer-2":"","fa-thermometer-3":"","fa-thermometer-4":"","fa-thermometer-empty":"","fa-thermometer-full":"","fa-thermometer-half":"","fa-thermometer-quarter":"","fa-thermometer-three-quarters":"","fa-thermometer":"","fa-thumb-tack":"","fa-thumbs-down":"","fa-thumbs-o-down":"","fa-thumbs-o-up":"","fa-thumbs-up":"","fa-ticket":"","fa-times-circle-o":"","fa-times-circle":"","fa-times-rectangle-o":"","fa-times-rectangle":"","fa-times":"","fa-tint":"","fa-toggle-down":"","fa-toggle-left":"","fa-toggle-off":"","fa-toggle-on":"","fa-toggle-right":"","fa-toggle-up":"","fa-trademark":"","fa-train":"","fa-transgender-alt":"","fa-transgender":"","fa-trash-o":"","fa-trash":"","fa-tree":"","fa-trophy":"","fa-truck":"","fa-try":"","fa-tty":"","fa-turkish-lira":"","fa-tv":"","fa-umbrella":"","fa-underline":"","fa-undo":"","fa-universal-access":"","fa-university":"","fa-unlink":"","fa-unlock-alt":"","fa-unlock":"","fa-unsorted":"","fa-upload":"","fa-usd":"","fa-user-circle-o":"","fa-user-circle":"","fa-user-md":"","fa-user-o":"","fa-user-plus":"","fa-user-secret":"","fa-user-times":"","fa-user":"","fa-users":"","fa-vcard-o":"","fa-vcard":"","fa-venus-double":"","fa-venus-mars":"","fa-venus":"","fa-video-camera":"","fa-volume-control-phone":"","fa-volume-down":"","fa-volume-off":"","fa-volume-up":"","fa-warning":"","fa-wheelchair-alt":"","fa-wheelchair":"","fa-wifi":"","fa-window-close-o":"","fa-window-close":"","fa-window-maximize":"","fa-window-minimize":"","fa-window-restore":"","fa-won":"","fa-wrench":"","fa-yen":""},o={"fa-500px":"","fa-adn":"","fa-amazon":"","fa-android":"","fa-angellist":"","fa-apple":"","fa-bandcamp":"","fa-behance-square":"","fa-behance":"","fa-bitbucket-square":"","fa-bitbucket":"","fa-bitcoin":"","fa-black-tie":"","fa-bluetooth-b":"","fa-bluetooth":"","fa-btc":"","fa-buysellads":"","fa-cc-amex":"","fa-cc-diners-club":"","fa-cc-discover":"","fa-cc-jcb":"","fa-cc-mastercard":"","fa-cc-paypal":"","fa-cc-stripe":"","fa-cc-visa":"","fa-chrome":"","fa-codepen":"","fa-codiepie":"","fa-connectdevelop":"","fa-contao":"","fa-css3":"","fa-dashcube":"","fa-delicious":"","fa-deviantart":"","fa-digg":"","fa-dribbble":"","fa-dropbox":"","fa-drupal":"","fa-edge":"","fa-eercast":"","fa-empire":"","fa-envira":"","fa-etsy":"","fa-expeditedssl":"","fa-fa":"","fa-facebook-f":"","fa-facebook-official":"","fa-facebook-square":"","fa-facebook":"","fa-firefox":"","fa-first-order":"","fa-flickr":"","fa-font-awesome":"","fa-fonticons":"","fa-fort-awesome":"","fa-forumbee":"","fa-foursquare":"","fa-free-code-camp":"","fa-ge":"","fa-get-pocket":"","fa-gg-circle":"","fa-gg":"","fa-git-square":"","fa-git":"","fa-github-alt":"","fa-github-square":"","fa-github":"","fa-gitlab":"","fa-gittip":"","fa-glide-g":"","fa-glide":"","fa-google-plus-circle":"","fa-google-plus-official":"","fa-google-plus-square":"","fa-google-plus":"","fa-google-wallet":"","fa-google":"","fa-gratipay":"","fa-grav":"","fa-hacker-news":"","fa-houzz":"","fa-html5":"","fa-imdb":"","fa-instagram":"","fa-internet-explorer":"","fa-ioxhost":"","fa-joomla":"","fa-jsfiddle":"","fa-lastfm-square":"","fa-lastfm":"","fa-leanpub":"","fa-linkedin-square":"","fa-linkedin":"","fa-linode":"","fa-linux":"","fa-maxcdn":"","fa-meanpath":"","fa-medium":"","fa-meetup":"","fa-mixcloud":"","fa-modx":"","fa-odnoklassniki-square":"","fa-odnoklassniki":"","fa-opencart":"","fa-openid":"","fa-opera":"","fa-optin-monster":"","fa-pagelines":"","fa-paypal":"","fa-pied-piper-alt":"","fa-pied-piper-pp":"","fa-pied-piper":"","fa-pinterest-p":"","fa-pinterest-square":"","fa-pinterest":"","fa-product-hunt":"","fa-qq":"","fa-quora":"","fa-ra":"","fa-ravelry":"","fa-rebel":"","fa-reddit-alien":"","fa-reddit-square":"","fa-reddit":"","fa-renren":"","fa-resistance":"","fa-safari":"","fa-scribd":"","fa-sellsy":"","fa-share-alt-square":"","fa-share-alt":"","fa-shirtsinbulk":"","fa-simplybuilt":"","fa-skyatlas":"","fa-skype":"","fa-slack":"","fa-slideshare":"","fa-snapchat-ghost":"","fa-snapchat-square":"","fa-snapchat":"","fa-soundcloud":"","fa-spotify":"","fa-stack-exchange":"","fa-stack-overflow":"","fa-steam-square":"","fa-steam":"","fa-stumbleupon-circle":"","fa-stumbleupon":"","fa-superpowers":"","fa-telegram":"","fa-tencent-weibo":"","fa-themeisle":"","fa-trello":"","fa-tripadvisor":"","fa-tumblr-square":"","fa-tumblr":"","fa-twitch":"","fa-twitter-square":"","fa-twitter":"","fa-usb":"","fa-viacoin":"","fa-viadeo-square":"","fa-viadeo":"","fa-vimeo-square":"","fa-vimeo":"","fa-vine":"","fa-vk":"","fa-wechat":"","fa-weibo":"","fa-weixin":"","fa-whatsapp":"","fa-wikipedia-w":"","fa-windows":"","fa-wordpress":"","fa-wpbeginner":"","fa-wpexplorer":"","fa-wpforms":"","fa-xing-square":"","fa-xing":"","fa-y-combinator-square":"","fa-y-combinator":"","fa-yahoo":"","fa-yc-square":"","fa-yc":"","fa-yelp":"","fa-yoast":"","fa-youtube-play":"","fa-youtube-square":"","fa-youtube":""},e=Object.keys(t);return{getIconUnicode:function(e){return t[e]||o[e]},getIconList:function(){return e}}}(),RED.history=function(){var t=[],o=[];function x(t){var e,o,i,c,u,n,p,a,r,s,f,h={};if(t){if("multi"==t.t)for(i={t:"multi",events:[]},e=t.events.length-1;0<=e;e--){var g=x(t.events[e]);i.events.push(g)}else if("replace"==t.t)t.complete?(i={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:{},rev:RED.nodes.version()},RED.nodes.clear(),RED.nodes.import(t.config).nodes.forEach(function(e){t.changed[e.id]&&(e.changed=!0,i.changed[e.id]=!0)}),RED.nodes.version(t.rev)):(c={},t.config.forEach(function(e){c[e.id]="replace"}),u=RED.nodes.import(t.config,{importMap:c}),i={t:"replace",config:u.removedNodes,dirty:RED.nodes.dirty()});else if("add"==t.t){if(i={t:"delete",dirty:RED.nodes.dirty()},t.nodes)for(i.nodes=[],e=0;e<t.nodes.length;e++)(a=RED.nodes.node(t.nodes[e])).z&&(h[a.z]=!0),i.nodes.push(a),RED.nodes.remove(t.nodes[e]),!a.g||-1!==(p=(n=RED.nodes.group(a.g)).nodes.indexOf(a))&&(n.nodes.splice(p,1),RED.group.markDirty(n));if(t.links)for(i.links=[],e=0;e<t.links.length;e++)i.links.push(t.links[e]),RED.nodes.removeLink(t.links[e]);if(t.groups)for(i.groups=[],e=t.groups.length-1;0<=e;e--)h[(n=t.groups[e]).z]=!0,i.groups.unshift(n),RED.nodes.removeGroup(n);if(t.workspaces)for(i.workspaces=[],e=0;e<t.workspaces.length;e++){var m=RED.nodes.getWorkspaceOrder();t.workspaces[e]._index=m.indexOf(t.workspaces[e].id),i.workspaces.push(t.workspaces[e]),RED.nodes.removeWorkspace(t.workspaces[e].id),RED.workspaces.remove(t.workspaces[e])}if(t.subflows)for(i.subflows=[],e=0;e<t.subflows.length;e++)i.subflows.push(t.subflows[e]),RED.nodes.removeSubflow(t.subflows[e]),RED.workspaces.remove(t.subflows[e]);if(t.subflow&&(i.subflow={},t.subflow.instances&&(i.subflow.instances=[],t.subflow.instances.forEach(function(e){i.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)})),t.subflow.hasOwnProperty("changed")&&(o=RED.nodes.subflow(t.subflow.id))&&(o.changed=t.subflow.changed)),t.removedLinks)for(i.createdLinks=[],e=0;e<t.removedLinks.length;e++)i.createdLinks.push(t.removedLinks[e]),RED.nodes.addLink(t.removedLinks[e])}else if("delete"==t.t){if(i={t:"add",dirty:RED.nodes.dirty()},t.workspaces)for(i.workspaces=[],e=0;e<t.workspaces.length;e++)i.workspaces.push(t.workspaces[e]),RED.nodes.addWorkspace(t.workspaces[e],t.workspaces[e]._index),RED.workspaces.add(t.workspaces[e],void 0,t.workspaces[e]._index),delete t.workspaces[e]._index;if(t.subflows)for(i.subflows=[],e=0;e<t.subflows.length;e++)i.subflows.push(t.subflows[e]),RED.nodes.addSubflow(t.subflows[e]);if(t.subflowInputs&&0<t.subflowInputs.length&&((o=RED.nodes.subflow(t.subflowInputs[0].z)).in.push(t.subflowInputs[0]),o.in[0].dirty=!0),t.subflowOutputs&&0<t.subflowOutputs.length)for(o=RED.nodes.subflow(t.subflowOutputs[0].z),t.subflowOutputs.sort(function(e,t){return e.i-t.i}),e=0;e<t.subflowOutputs.length;e++){var b=t.subflowOutputs[e];o.out.splice(b.i,0,b);for(var v=b.i+1;v<o.out.length;v++)o.out[v].i++,o.out[v].dirty=!0;RED.nodes.eachLink(function(e){e.source.type=="subflow:"+o.id&&e.sourcePort>=b.i&&e.sourcePort++})}if(t.subflow&&(i.subflow={},t.subflow.hasOwnProperty("instances")&&(i.subflow.instances=[],t.subflow.instances.forEach(function(e){i.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)})),t.subflow.hasOwnProperty("status")&&((o=RED.nodes.subflow(t.subflow.id)).status=t.subflow.status)),o&&RED.nodes.filterNodes({type:"subflow:"+o.id}).forEach(function(e){e.inputs=o.in.length,e.outputs=o.out.length,e.resize=!0,e.dirty=!0}),t.groups){i.groups=[];var y={};for(t.groups.forEach(function(e){y[e.id]=e}),e=t.groups.length-1;0<=e;e--)RED.nodes.addGroup(t.groups[e]),h[t.groups[e].z]=!0,i.groups.unshift(t.groups[e]),t.groups[e].g&&(-1===(n=y[t.groups[e].g]||RED.nodes.group(t.groups[e].g)).nodes.indexOf(t.groups[e])&&n.nodes.push(t.groups[e]),RED.group.markDirty(t.groups[e]))}if(t.nodes)for(i.nodes=[],e=0;e<t.nodes.length;e++)RED.nodes.add(t.nodes[e]),h[t.nodes[e].z]=!0,i.nodes.push(t.nodes[e].id),t.nodes[e].g&&(-1===(n=RED.nodes.group(t.nodes[e].g)).nodes.indexOf(t.nodes[e])&&n.nodes.push(t.nodes[e]),RED.group.markDirty(n));if(t.links)for(i.links=[],e=0;e<t.links.length;e++)RED.nodes.addLink(t.links[e]),i.links.push(t.links[e]);if(t.createdLinks)for(i.removedLinks=[],e=0;e<t.createdLinks.length;e++)i.removedLinks.push(t.createdLinks[e]),RED.nodes.removeLink(t.createdLinks[e]);if(t.changes)for(e in t.changes)if(t.changes.hasOwnProperty(e)){if(a=RED.nodes.node(e)){for(var w in t.changes[e])t.changes[e].hasOwnProperty(w)&&(a[w]=t.changes[e][w]);a.dirty=!0}RED.events.emit("nodes:change",a)}o&&RED.events.emit("subflows:change",o)}else if("move"==t.t){for(i={t:"move",nodes:[],dirty:RED.nodes.dirty()},e=0;e<t.nodes.length;e++){var d=t.nodes[e],E={n:d.n,ox:d.n.x,oy:d.n.y,dirty:!0,moved:d.n.moved};i.nodes.push(E),d.n.x=d.ox,d.n.y=d.oy,d.n.dirty=!0,d.n.moved=d.moved}if(t.links)for(i.removedLinks=[],e=0;e<t.links.length;e++)i.removedLinks.push(t.links[e]),RED.nodes.removeLink(t.links[e]);if(t.removedLinks)for(i.links=[],e=0;e<t.removedLinks.length;e++)i.links.push(t.removedLinks[e]),RED.nodes.addLink(t.removedLinks[e]);t.addToGroup?(RED.group.removeFromGroup(t.addToGroup,t.nodes.map(function(e){return e.n}),!1),i.removeFromGroup=t.addToGroup):t.removeFromGroup&&(RED.group.addToGroup(t.removeFromGroup,t.nodes.map(function(e){return e.n})),i.addToGroup=t.removeFromGroup)}else if("edit"==t.t){for(e in(i={t:"edit",changes:{},changed:t.node.changed,dirty:RED.nodes.dirty()}).node=t.node,t.changes)t.changes.hasOwnProperty(e)&&(i.changes[e]=t.node[e],t.node._def.defaults&&t.node._def.defaults[e]&&t.node._def.defaults[e].type&&(r=t.node[e],(r=Array.isArray(r)?r:[r]).forEach(function(e){e=RED.nodes.node(e);e&&"config"===e._def.category&&(e.users.splice(e.users.indexOf(t.node),1),RED.events.emit("nodes:change",e))}),r=t.changes[e],(r=Array.isArray(r)?r:[r]).forEach(function(e){e=RED.nodes.node(e);e&&"config"===e._def.category&&(e.users.push(t.node),RED.events.emit("nodes:change",e))})),t.node[e]=t.changes[e]);switch(t.node.type){case"tab":s="flows";break;case"group":s="groups";break;case"subflow":s="subflows";break;default:s="nodes"}if(RED.events.emit(s+=":change",t.node),"tab"===t.node.type&&t.changes.hasOwnProperty("disabled")&&($("#red-ui-tab-"+t.node.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!t.node.disabled),$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!t.node.disabled)),t.subflow)i.subflow={},t.subflow.hasOwnProperty("inputCount")&&(i.subflow.inputCount=t.node.in.length,t.node.in.length>t.subflow.inputCount?(i.subflow.inputs=t.node.in.slice(t.subflow.inputCount),t.node.in.splice(t.subflow.inputCount)):0<t.subflow.inputs.length&&(t.node.in=t.node.in.concat(t.subflow.inputs))),t.subflow.hasOwnProperty("outputCount")&&(i.subflow.outputCount=t.node.out.length,t.node.out.length>t.subflow.outputCount?(i.subflow.outputs=t.node.out.slice(t.subflow.outputCount),t.node.out.splice(t.subflow.outputCount)):0<t.subflow.outputs.length&&(t.node.out=t.node.out.concat(t.subflow.outputs))),t.subflow.hasOwnProperty("instances")&&(i.subflow.instances=[],t.subflow.instances.forEach(function(e){i.subflow.instances.push(e);var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)})),t.subflow.hasOwnProperty("status")&&t.subflow.status&&delete t.node.status,RED.editor.validateNode(t.node),RED.nodes.filterNodes({type:"subflow:"+t.node.id}).forEach(function(e){e.inputs=t.node.in.length,e.outputs=t.node.out.length,RED.editor.updateNodeProperties(e),RED.editor.validateNode(e)});else{if(t.outputMap)for(var l in f={},i.outputMap={},t.outputMap)t.outputMap.hasOwnProperty(l)&&"-1"!==t.outputMap[l]&&(f[t.outputMap[l]]=l,i.outputMap[t.outputMap[l]]=l);t.node.__outputs=i.changes.outputs,RED.editor.updateNodeProperties(t.node,f),RED.editor.validateNode(t.node)}if(t.links)for(i.createdLinks=[],e=0;e<t.links.length;e++)RED.nodes.addLink(t.links[e]),i.createdLinks.push(t.links[e]);if(t.createdLinks)for(i.links=[],e=0;e<t.createdLinks.length;e++)RED.nodes.removeLink(t.createdLinks[e]),i.links.push(t.createdLinks[e]);t.node.dirty=!0,t.node.changed=t.changed}else if("createSubflow"==t.t){if(i={t:"deleteSubflow",activeWorkspace:t.activeWorkspace,dirty:RED.nodes.dirty()},t.nodes){i.movedNodes=[];var D=t.activeWorkspace;for(RED.nodes.filterNodes({z:t.subflow.subflow.id}).concat(RED.nodes.groups(t.subflow.subflow.id)).forEach(function(e){e.x+=t.subflow.offsetX,e.y+=t.subflow.offsetY,e.dirty=!0,i.movedNodes.push(e.id),RED.nodes.moveNodeToTab(e,D)}),i.subflows=[],e=0;e<t.nodes.length;e++)i.subflows.push(RED.nodes.node(t.nodes[e])),RED.nodes.remove(t.nodes[e])}if(t.links)for(i.links=[],e=0;e<t.links.length;e++)i.links.push(t.links[e]),RED.nodes.removeLink(t.links[e]);if(i.subflow=t.subflow,RED.nodes.removeSubflow(t.subflow.subflow),RED.workspaces.remove(t.subflow.subflow),t.removedLinks)for(i.createdLinks=[],e=0;e<t.removedLinks.length;e++)i.createdLinks.push(t.removedLinks[e]),RED.nodes.addLink(t.removedLinks[e])}else if("deleteSubflow"==t.t){if(i={t:"createSubflow",activeWorkspace:t.activeWorkspace,dirty:RED.nodes.dirty()},t.subflow&&(RED.nodes.addSubflow(t.subflow.subflow),i.subflow=t.subflow,t.subflow.subflow.g&&RED.group.addToGroup(RED.nodes.group(t.subflow.subflow.g),t.subflow.subflow)),t.subflows)for(i.nodes=[],e=0;e<t.subflows.length;e++)RED.nodes.add(t.subflows[e]),i.nodes.push(t.subflows[e].id);if(t.movedNodes&&t.movedNodes.forEach(function(e){(nn=(nn=RED.nodes.node(e))||RED.nodes.group(e)).x-=t.subflow.offsetX,nn.y-=t.subflow.offsetY,nn.dirty=!0,RED.nodes.moveNodeToTab(nn,t.subflow.subflow.id)}),t.links)for(i.links=[],e=0;e<t.links.length;e++)i.links.push(t.links[e]),RED.nodes.addLink(t.links[e]);if(t.createdLinks)for(i.removedLinks=[],e=0;e<t.createdLinks.length;e++)i.removedLinks.push(t.createdLinks[e]),RED.nodes.removeLink(t.createdLinks[e])}else if("reorder"==t.t)i={t:"reorder",dirty:RED.nodes.dirty()},t.workspaces&&(i.workspaces={from:t.workspaces.to,to:t.workspaces.from},RED.workspaces.order(t.workspaces.from)),t.nodes&&(i.nodes={z:t.nodes.z,from:t.nodes.to,to:t.nodes.from},RED.nodes.setNodeOrder(t.nodes.z,t.nodes.from));else if("createGroup"==t.t){if(i={t:"ungroup",dirty:RED.nodes.dirty(),groups:[]},t.groups)for(e=0;e<t.groups.length;e++)i.groups.push(t.groups[e]),RED.group.ungroup(t.groups[e])}else if("ungroup"==t.t){if(i={t:"createGroup",dirty:RED.nodes.dirty(),groups:[]},t.groups)for(e=0;e<t.groups.length;e++){i.groups.push(t.groups[e]);var R=t.groups[e].nodes.slice();t.groups[e].nodes=[],RED.nodes.addGroup(t.groups[e]),RED.group.addToGroup(t.groups[e],R)}}else"addToGroup"==t.t?(i={t:"removeFromGroup",dirty:RED.nodes.dirty(),group:t.group,nodes:t.nodes,reparent:t.reparent},t.nodes&&RED.group.removeFromGroup(t.group,t.nodes,!t.hasOwnProperty("reparent")||void 0===t.hasOwnProperty("reparent")||t.reparent)):"removeFromGroup"==t.t&&(i={t:"addToGroup",dirty:RED.nodes.dirty(),group:t.group,nodes:t.nodes,reparent:t.reparent},t.nodes&&RED.group.addToGroup(t.group,t.nodes));return t.callback&&"function"==typeof t.callback&&(i.callback=t.callback,t.callback(t)),Object.keys(h).forEach(function(e){e=RED.nodes.subflow(e);e&&RED.editor.validateNode(e)}),RED.nodes.dirty(t.dirty),RED.view.updateActive(),RED.view.select(null),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.subflow.refresh(),i}}return{markAllDirty:function(){for(var e=0;e<t.length;e++)t[e].dirty=!0},list:function(){return t},listRedo:function(){return o},depth:function(){return t.length},push:function(e){t.push(e),o=[],RED.menu.setDisabled("menu-item-edit-undo",!1),RED.menu.setDisabled("menu-item-edit-redo",!0)},pop:function(){var e=x(t.pop());e&&o.push(e),RED.menu.setDisabled("menu-item-edit-undo",0===t.length),RED.menu.setDisabled("menu-item-edit-redo",0===o.length)},peek:function(){return t[t.length-1]},replace:function(e){0===t.length?RED.history.push(e):t[t.length-1]=e},clear:function(){t=[],o=[],RED.menu.setDisabled("menu-item-edit-undo",!0),RED.menu.setDisabled("menu-item-edit-redo",!0)},redo:function(){var e=o.pop();!e||(e=x(e))&&t.push(e),RED.menu.setDisabled("menu-item-edit-undo",0===t.length),RED.menu.setDisabled("menu-item-edit-redo",0===o.length)}}}(),RED.validators={number:function(t){return function(e){return t&&(""===e||void 0===e)||""!==e&&!isNaN(e)}},regex:function(t){return function(e){return t.test(e)}},typedInput:function(o,i){return function(e){var t=$("#node-"+(i?"config-":"")+"input-"+o).val()||this[o];if("json"===t)try{return JSON.parse(e),!0}catch(e){return!1}else{if("msg"===t||"flow"===t||"global"===t)return RED.utils.validatePropertyExpression(e);if("num"===t)return/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(e)}return!0}}},RED.utils=function(){window._marked=window.marked,window.marked=function(e){return console.warn("Use of 'marked()' is deprecated. Use RED.utils.renderMarkdown() instead"),t(e)};const e=new window._marked.Renderer;function t(e){e=_marked.parse(e);return DOMPurify.sanitize(e,{SAFE_FOR_JQUERY:!0})}function V(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function B(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function q(e){var t;return Array.isArray(e)?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("array["+e.length+"]"):null===e?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-null">null</span>'):"object"==typeof e?e.hasOwnProperty("type")&&"undefined"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-null">undefined</span>'):e.hasOwnProperty("type")&&"Buffer"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("buffer["+e.length+"]"):e.hasOwnProperty("type")&&"array"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("array["+e.length+"]"):e.hasOwnProperty("type")&&"set"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("set["+e.length+"]"):e.hasOwnProperty("type")&&"map"===e.type&&e.hasOwnProperty("data")?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("map"):e.hasOwnProperty("type")&&"function"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta"></span>').text("function"):!e.hasOwnProperty("type")||"number"!==e.type&&"bigint"!==e.type?e.hasOwnProperty("type")&&"regexp"===e.type?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-string"></span>').text(e.data):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-meta">object</span>'):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-number"></span>').text(e.data):"string"==typeof e?(t=30<e.length?B(e.substring(0,30))+"&hellip;":B(e),$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-string"></span>').html('"'+V(t)+'"')):("number"==typeof e?$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-number"></span>'):$('<span class="red-ui-debug-msg-object-value red-ui-debug-msg-type-other"></span>')).text(""+e)}function G(o,i,n,e){o.addClass("red-ui-debug-msg-expandable"),o.prop("toggle",function(){return function(e){var t=o.parent();if(t.hasClass("collapsed")){if(e)return i&&!t.hasClass("built")&&(i(),t.addClass("built")),t.removeClass("collapsed"),!0}else if(!e)return t.addClass("collapsed"),!0;return!1}}),o.on("click",function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&n&&n(!t),e.preventDefault()}),e&&o.trigger("click")}e.list=function(e,t,o){return/dl.*?class.*?message-properties.*/.test(e)&&t?'<ol class="node-ports">'+e+"</ol>":t?"<ol>"+e+"</ol>":"<ul>"+e+"</ul>"},window._marked.setOptions({renderer:e,gfm:!0,tables:!0,breaks:!1,pedantic:!1,smartLists:!0,smartypants:!1}),window._marked.use({extensions:[{name:"descriptionList",level:"block",start(e){if(!e)return null;e=e.match(/:[^:\n]/g);return e&&e.index},tokenizer(e,t){if(!e)return null;const o=/^(?::[^:\n]+:[^:\n]*(?:\n|$))+/.exec(e);return o?{type:"descriptionList",raw:o[0],text:o[0].trim(),tokens:this.lexer.inlineTokens(o[0].trim())}:void 0},renderer(e){return`<dl class="message-properties">${this.parser.parseInline(e.tokens)}
</dl>`}},{name:"description",level:"inline",start(e){if(!e)return null;e=e.match(/:/g);return e&&e.index},tokenizer(e,t){if(!e)return null;const o=/^:([^:\n]+)\(([^:\n]+)\).*?:([^:\n]*)(?:\n|$)/.exec(e);return o?{type:"description",raw:o[0],dt:this.lexer.inlineTokens(o[1].trim()),types:this.lexer.inlineTokens(o[2].trim()),dd:this.lexer.inlineTokens(o[3].trim())}:void 0},renderer(e){return`
<dt>${this.parser.parseInline(e.dt)}<span class="property-type">${this.parser.parseInline(e.types)}</span></dt><dd>${this.parser.parseInline(e.dd)}</dd>`},childTokens:["dt","dd"],walkTokens(e){"strong"===e.type&&(e.text+=" walked")}}]});var F={},s={};function U(e,t,o,i){if(t&&0<t.length){if(""===e&&void 0===o)return!0;for(var n=0;n<t.length;n++){var a=t[n];if(0===a.indexOf(e)&&("."===a[e.length]||"["===a[e.length])){if(void 0===o||"["!==a[e.length])return!0;var a=a.substring(e.length),a=/\[(\d+)\]/.exec(a);if(a)return o<=(a=parseInt(a[1]))&&a<=i}}}return!1}function W(e,t,o,i,n,a){var r=s[o]&&s[o][i]&&s[o][i].number||a||"dec";n?(r="dec"===r?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===r||"dateS"==r?13===t.toString().length&&t<=2147483647e3?"dateML":10===t.toString().length&&t<=2147483647?"dateL":"hex":"dateML"===r||"dateL"==r?"hex":"dec",s[o]=s[o]||{},s[o][i]=s[o][i]||{},s[o][i].number=r):void 0!==a&&(s[o]=s[o]||{},s[o][i]=s[o][i]||{},s[o][i].number=r),"dec"===r?e.text(""+t):"dateMS"===r?e.text(new Date(t).toISOString()):"dateS"===r?e.text(new Date(1e3*t).toISOString()):"dateML"===r?(n=new Date(t),e.text(n.toLocaleString()+"  [UTC"+(n.getTimezoneOffset()/-60<=0?"":"+")+n.getTimezoneOffset()/-60+"]")):"dateL"===r?(a=new Date(1e3*t),e.text(a.toLocaleString()+"  [UTC"+(a.getTimezoneOffset()/-60<=0?"":"+")+a.getTimezoneOffset()/-60+"]")):"hex"===r&&e.text("0x"+t.toString(16))}function K(e,t,o,i,n){var a=s[o]&&s[o][i]&&s[o][i].buffer||"raw";n&&(a="raw"===a?"string":"raw",s[o]=s[o]||{},s[o][i]=s[o][i]||{},s[o][i].buffer=a),"raw"===a?(t.text("raw"),e.removeClass("red-ui-debug-msg-buffer-string").addClass("red-ui-debug-msg-buffer-raw")):"string"===a&&(t.text("string"),e.addClass("red-ui-debug-msg-buffer-string").removeClass("red-ui-debug-msg-buffer-raw"))}function g(e,t){t=new Error(t);return t.code=e,t}function J(e,c){var t=e.length;if(0===t)throw g("INVALID_EXPR","Invalid property expression: zero-length");for(var u,o,i=[],n=0,a=!1,r=!1,s=0;s<t;s++){var d=e[s];if(a){if(d===u){if(s-n==0)throw g("INVALID_EXPR","Invalid property expression: zero-length string at position "+n);if(i.push(e.substring(n,s)),r&&!/\]/.test(e[s+1]))throw g("INVALID_EXPR","Invalid property expression: unexpected array expression at position "+n);if(!r&&s+1!==t&&!/[\[\.]/.test(e[s+1]))throw g("INVALID_EXPR","Invalid property expression: unexpected "+e[s+1]+" expression at position "+(s+1));n=s+1,a=!1}}else if("'"===d||'"'===d){if(s!=n)throw g("INVALID_EXPR","Invalid property expression: unexpected "+d+" at position "+s);a=!0,u=d,n=s+1}else if("."===d){if(0===s)throw g("INVALID_EXPR","Invalid property expression: unexpected . at position 0");if(n!=s&&(o=e.substring(n,s),/^\d+$/.test(o)?i.push(parseInt(o)):i.push(o)),s===t-1)throw g("INVALID_EXPR","Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[s+1]))throw g("INVALID_EXPR","Invalid property expression: unexpected "+e[s+1]+" at position "+(s+1));n=s+1}else if("["===d){if(0===s)throw g("INVALID_EXPR","Invalid property expression: unexpected "+d+" at position "+s);if(n!=s&&i.push(e.substring(n,s)),s===t-1)throw g("INVALID_EXPR","Invalid property expression: unterminated expression");if(/^msg[.\[]/.test(e.substring(s+1))){for(var p,f=1,h=!1,l=s+1;l<t;l++)if(/["']/.test(e[l])&&(h?e[l]===p&&(h=!1):(h=!0,p=e[l])),"["===e[l]?f++:"]"===e[l]&&f--,0===f)try{c?i.push(H(c,e.substring(s+1,l))):i.push(J(e.substring(s+1,l),c)),r=!1,n=(s=l)+1;break}catch(e){throw g("INVALID_EXPR","Invalid expression started at position "+(s+1))}if(0<f)throw g("INVALID_EXPR","Invalid property expression: unmatched '[' at position "+s)}else{if(!/["'\d]/.test(e[s+1]))throw g("INVALID_EXPR","Invalid property expression: unexpected "+e[s+1]+" at position "+(s+1));n=s+1,r=!0}}else if("]"===d){if(!r)throw g("INVALID_EXPR","Invalid property expression: unexpected "+d+" at position "+s);if(n!=s){if(o=e.substring(n,s),!/^\d+$/.test(o))throw g("INVALID_EXPR","Invalid property expression: unexpected array expression at position "+n);i.push(parseInt(o))}n=s+1,r=!1}else if(" "===d)throw g("INVALID_EXPR","Invalid property expression: unexpected ' ' at position "+s)}if(r||a)throw new g("INVALID_EXPR","Invalid property expression: unterminated expression");return n<t&&i.push(e.substring(n)),i}function H(e,t){var o=null,t="string"==typeof t?J(t=0===t.indexOf("msg.")?t.substring(4):t):t;return t.reduce(function(e,t){return o=void 0===(o=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")?void 0!==e.data[t]?e.data[t]:void 0:o},e),o}function r(e){var t,o={module:"",file:""};return e&&(0===e.indexOf(RED.settings.apiRootUrl+"icons/")&&(e=e.substring((RED.settings.apiRootUrl+"icons/").length)),(t=/^((?:@[^/]+\/)?[^/]+)\/(.*)$/.exec(e))?(o.module=t[1],o.file=t[2]):o.file=e),o}function n(t,e){var o;if(t=t||{},e&&"subflow"===e.type)o="node-red/subflow.svg";else if("function"==typeof t.icon)try{o=t.icon.call(e)}catch(e){console.log("Definition error: "+t.type+".icon",e),o="arrow-in.svg"}else o=t.icon;e=r(o);return e.module||(t.set?e.module=t.set.module:e.module="node-red"),e}function i(e){var t=RED.nodes.getIconSets()[e.module];return!(!t||-1===t.indexOf(e.file))}var d={};function l(e){if(/^#[a-f0-9]{6}$/i.test(e))t=parseInt(e.substring(1,3),16),o=parseInt(e.substring(3,5),16),i=parseInt(e.substring(5,7),16);else{if(!/^#[a-f0-9]{3}$/i.test(e))return e;t=parseInt(e.substring(1,2)+e.substring(1,2),16),o=parseInt(e.substring(2,3)+e.substring(2,3),16),i=parseInt(e.substring(3,4)+e.substring(3,4),16)}var t,o,i,e=(((t=Math.max(0,t-50))<<16)+((o=Math.max(0,o-50))<<8)+(i=Math.max(0,i-50))).toString(16);return"#"+"000000".slice(0,6-e.length)+e}function a(e,t,o){for(var i=0;i<o.length;i++){var n=o[i];if(n.module.test(e))return n}}return{createObjectElement:function c(t,e){var u,i,o,p,f,h,g,m,b,v,y,w=(e=e||{}).key,E=e.typeHint,D=e.hideKey,s=e.path,R=e.sourceId,x=e.rootPath,_=e.expandPaths,k=e.ontoggle,T=e.exposeApi,e=e.tools,C={},n=(void 0!==s&&void 0!==x&&(p=s.substring(x.length+("."===s[x.length]?1:0))),$('<span class="red-ui-debug-msg-element"></span>'));if(n.collapse=function(){n.find(".red-ui-debug-msg-expandable").parent().addClass("collapsed")},i=$('<span class="red-ui-debug-msg-row"></span>').appendTo(n),R&&(f=i,h=R,g=s,m=t,b=p,F.hasOwnProperty(h)||(F[h]={}),S=$('<span class="red-ui-debug-msg-tools"></span>').appendTo(f),r=$('<span class="red-ui-debug-msg-tools-copy button-group"></span>').appendTo(S),g&&(v=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-terminal"></i></button>').appendTo(r).on("click",function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(g,v,"clipboard.copyMessagePath")}),RED.popover.tooltip(v,RED._("node-red:debug.sidebar.copyPath"))),y=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(r).on("click",function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(m,y,"clipboard.copyMessageValue")}),RED.popover.tooltip(y,RED._("node-red:debug.sidebar.copyPayload")),void 0!==b&&""!==b&&(r=F[h].hasOwnProperty(b),a=$('<button class="red-ui-button red-ui-button-small red-ui-debug-msg-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(S).on("click",function(e){e.preventDefault(),e.stopPropagation(),F[h].hasOwnProperty(b)?(delete F[h][b],$(this).removeClass("selected"),f.removeClass("red-ui-debug-msg-row-pinned")):(e="$"+("["===b[0]?"":".")+b,F[h][b]=J(e),$(this).addClass("selected"),f.addClass("red-ui-debug-msg-row-pinned"))}).toggleClass("selected",r),f.toggleClass("red-ui-debug-msg-row-pinned",r),RED.popover.tooltip(a,RED._("node-red:debug.sidebar.pinPath"))),!e||(r="function"==typeof(r=e)?r(g,m):r)&&(r.addClass("red-ui-debug-msg-tools-other"),r.appendTo(S))),w)D||($('<span class="red-ui-debug-msg-object-key"></span>').text(w).appendTo(i),$("<span>: </span>").appendTo(i));else if(n.addClass("red-ui-debug-msg-top-level"),R){var j=F[R],_=[];if(j){for(var L in j)if(j.hasOwnProperty(L))try{void 0!==H({$:t},j[L])&&_.push(L)}catch(e){}_.sort()}n.clearPinned=function(){n.find(".red-ui-debug-msg-row-pinned").removeClass("red-ui-debug-msg-row-pinned"),F[R]={}}}var a=$('<span class="red-ui-debug-msg-object-value"></span>').appendTo(i),e=Array.isArray(t),r=!1;if(t&&"object"==typeof t&&t.hasOwnProperty("type")&&t.hasOwnProperty("data")&&(t.__enc__&&"set"===t.type||t.__enc__&&"array"===t.type||"Buffer"===t.type)&&(r=e=!0),null==t)$('<span class="red-ui-debug-msg-type-null">'+t+"</span>").appendTo(a);else if(t.__enc__&&"undefined"===t.type)$('<span class="red-ui-debug-msg-type-null">undefined</span>').appendTo(a);else if(!t.__enc__||"number"!==t.type&&"bigint"!==t.type)if("regexp"===E||t.__enc__&&"regexp"===t.type)u=$('<span class="red-ui-debug-msg-type-string red-ui-debug-msg-object-header"></span>').text("string"==typeof t?t:t.data).appendTo(a);else if("function"===E||t.__enc__&&"function"===t.type)u=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-header"></span>').text("function").appendTo(a);else if("internal"===E||t.__enc__&&"internal"===t.type)u=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-header"></span>').text("[internal]").appendTo(a);else if("string"==typeof t)/[\t\n\r]/.test(t)&&(n.addClass("collapsed"),$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(i),G(i,function(){$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(E||"string").appendTo(i);var e=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(n);$('<pre class="red-ui-debug-msg-type-string"></pre>').text(t).appendTo(e)},function(e){k&&k(s,e)},U(p,_))),u=$('<span class="red-ui-debug-msg-type-string red-ui-debug-msg-object-header"></span>').html('"'+V(B(t))+'"').appendTo(a),/^#[0-9a-f]{6}$/i.test(t)&&$('<span class="red-ui-debug-msg-type-string-swatch"></span>').css("backgroundColor",t).appendTo(u);else if("number"==typeof t)u=$('<span class="red-ui-debug-msg-type-number"></span>').appendTo(a),Number.isInteger(t)&&0<=t&&(u.addClass("red-ui-debug-msg-type-number-toggle"),u.on("click",function(e){e.preventDefault(),W($(this),t,R,s,!0)})),W(u,t,R,s,!1,"hex"===E?"hex":void 0);else if(e){n.addClass("collapsed");var S,O,N=t.length,d=(!E||(S=/\[(\d+)\]/.exec(E))&&(N=parseInt(S[1])),t),I="array",P=(r?(d=t.data,void 0===N&&(N=d.length),d.__enc__&&(d=d.data),I=t.type.toLowerCase()):/buffer/.test(E)&&(I="buffer"),d.length);if(0<N&&($('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(i),O=$('<div class="red-ui-debug-msg-array-rows"></div>').appendTo(n),n.addClass("red-ui-debug-msg-buffer-raw")),w)o=$('<span class="red-ui-debug-msg-type-meta"></span>').text(E||I+"["+N+"]").appendTo(a);else{o=$('<span class="red-ui-debug-msg-object-header"></span>').appendTo(a),$("<span>[ </span>").appendTo(o);for(var A=Math.min(N,10),l=0;l<A;l++)q(d[l]).appendTo(o),l<A-1&&$("<span>, </span>").appendTo(o);A<N&&$("<span> &hellip;</span>").appendTo(o),0===A&&$('<span class="red-ui-debug-msg-type-meta">empty</span>').appendTo(o),$("<span> ]</span>").appendTo(o)}0<N&&G(i,function(){if(w||(o=$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(E||I+"["+N+"]").appendTo(i)),"buffer"===I){var e=$('<div class="red-ui-debug-msg-string-rows"></div>').appendTo(n),e=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(e),t="";try{t=String.fromCharCode.apply(null,new Uint16Array(d))}catch(e){console.log(e)}$('<pre class="red-ui-debug-msg-type-string"></pre>').text(t).appendTo(e),t=$('<span class="red-ui-debug-msg-buffer-opts"></span>').appendTo(o),e=$('<a class="red-ui-button red-ui-button-small" href="#"></a>').text("raw").appendTo(t).on("click",function(e){e.preventDefault(),e.stopPropagation(),K(n,$(this),R,s,!0)}),K(n,e,R,s,!1)}if(P<=10)for(l=0;l<P;l++)r=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(O),C[s+"["+l+"]"]=c(d[l],{key:""+l,typeHint:"buffer"===I&&"hex",hideKey:!1,path:s+"["+l+"]",sourceId:R,rootPath:x,expandPaths:_,ontoggle:k,exposeApi:T}).appendTo(r);else{for(l=0;l<P;l+=10){var a=l,r=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(O);i=$("<span></span>").appendTo(r),$('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').appendTo(i),G(i,function(){var o=a,i=Math.min(P-1,a+9),n=r;return function(){for(var e=o;e<=i;e++){var t=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(n);C[s+"["+e+"]"]=c(d[e],{key:""+e,typeHint:"buffer"===I&&"hex",hideKey:!1,path:s+"["+e+"]",sourceId:R,rootPath:x,expandPaths:_,ontoggle:k,exposeApi:T}).appendTo(t)}}}(),function(){var t=void 0+"["+l+"]";return function(e){k&&k(t,e)}}(),U(p,_,a,Math.min(P-1,a+9))),$('<span class="red-ui-debug-msg-object-key"></span>').html("["+a+" &hellip; "+Math.min(P-1,a+9)+"]").appendTo(i)}P<N&&$('<div class="red-ui-debug-msg-object-entry collapsed"><span class="red-ui-debug-msg-object-key">['+P+" &hellip; "+N+"]</span></div>").appendTo(O)}},function(e){k&&k(s,e)},U(p,_))}else if("object"==typeof t){n.addClass("collapsed");var I="object",M=((d=t).__enc__&&(d=d.data,I=t.type.toLowerCase()),Object.keys(d));if((w||0<M.length)&&($('<i class="fa fa-caret-right red-ui-debug-msg-object-handle"></i> ').prependTo(i),G(i,function(){for(w||$('<span class="red-ui-debug-msg-type-meta red-ui-debug-msg-object-type-header"></span>').text(I).appendTo(i),l=0;l<M.length;l++){var e=$('<div class="red-ui-debug-msg-object-entry collapsed"></div>').appendTo(n),t=s;void 0!==t&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(M[l])?t+=(0<t.length?".":"")+M[l]:t+='["'+M[l].replace(/"/,'\\"')+'"]'),C[t]=c(d[M[l]],{key:M[l],typeHint:!1,hideKey:!1,path:t,sourceId:R,rootPath:x,expandPaths:_,ontoggle:k,exposeApi:T}).appendTo(e)}0===M.length&&$('<div class="red-ui-debug-msg-object-entry red-ui-debug-msg-type-meta collapsed"></div>').text("empty").appendTo(n)},function(e){k&&k(s,e)},U(p,_))),w)$('<span class="red-ui-debug-msg-type-meta"></span>').text(I).appendTo(a);else{o=$('<span class="red-ui-debug-msg-object-header"></span>').appendTo(a),$("<span>{ </span>").appendTo(o);var z=Math.min(M.length,5);for(l=0;l<z;l++)$('<span class="red-ui-debug-msg-object-key"></span>').text(M[l]).appendTo(o),$("<span>: </span>").appendTo(o),q(d[M[l]]).appendTo(o),l<z-1&&$("<span>, </span>").appendTo(o);M.length>z&&$("<span> &hellip;</span>").appendTo(o),0===z&&$('<span class="red-ui-debug-msg-type-meta">empty</span>').appendTo(o),$("<span> }</span>").appendTo(o)}}else $('<span class="red-ui-debug-msg-type-other"></span>').text(""+t).appendTo(a);else u=$('<span class="red-ui-debug-msg-type-number red-ui-debug-msg-object-header"></span>').text(t.data).appendTo(a);return T&&n.prop("expand",function(){return function(e,t){if(s===e)i.prop("toggle")&&i.prop("toggle")(t);else if(C[e]&&C[e].prop("expand"))C[e].prop("expand")(e,t);else for(var o in C)if(C.hasOwnProperty(o)&&0===e.indexOf(o)){C[o].prop("expand")&&C[o].prop("expand")(e,t);break}}}),n},getMessageProperty:H,setMessageProperty:function(e,t,o,i){void 0===i&&(i=void 0!==o);for(var n,a=J(t=0===t.indexOf("msg.")?t.substring(4):t),r=a.length,s=e,d=0;d<r-1;d++)if("string"==typeof(n=a[d])||"number"==typeof n&&!Array.isArray(s))if(s.hasOwnProperty(n))s=s[n];else{if(!i)return null;"string"==typeof a[d+1]?s[n]={}:s[n]=[],s=s[n]}else if("number"==typeof n)if(void 0===s[n]){if(!i)return null;"string"==typeof a[d+1]?s[n]={}:s[n]=[],s=s[n]}else s=s[n];n=a[r-1],void 0===o?"number"==typeof n&&Array.isArray(s)?s.splice(n,1):delete s[n]:s[n]=o},normalisePropertyExpression:J,validatePropertyExpression:function(e){try{J(e);return!0}catch(e){return!1}},separateIconPath:r,getDefaultNodeIcon:n,getNodeIcon:function(e,t){if(t&&"_selection_"===t.type)return"font-awesome/fa-object-ungroup";if(t&&"group"===t.type)return"font-awesome/fa-object-group";if("config"===(e=e||{}).category)return RED.settings.apiRootUrl+"icons/node-red/cog.svg";if(t&&"tab"===t.type)return"red-ui-icons/red-ui-icons-flow";if(t&&"unknown"===t.type)return RED.settings.apiRootUrl+"icons/node-red/alert.svg";if(t&&t.icon){if(i(o=r(t.icon)))return"font-awesome"===o.module?t.icon:RED.settings.apiRootUrl+"icons/"+t.icon;if("font-awesome"!==o.module&&/.png$/i.test(o.file)&&(o.file=o.file.replace(/.png$/,".svg"),i(o)))return RED.settings.apiRootUrl+"icons/"+t.icon.replace(/.png$/,".svg")}var o;if(i(o=n(e,t)))return"font-awesome"===o.module?o.module+"/"+o.file:RED.settings.apiRootUrl+"icons/"+o.module+"/"+o.file;if(/.png$/i.test(o.file)){t=o.file;if(o.file=o.file.replace(/.png$/,".svg"),i(o))return RED.settings.apiRootUrl+"icons/"+o.module+"/"+o.file;o.file=t}return o.module="node-red",i(o)||/.png$/i.test(o.file)&&(o.file=o.file.replace(/.png$/,".svg"),i(o))?RED.settings.apiRootUrl+"icons/"+o.module+"/"+o.file:"subflows"===e.category?RED.settings.apiRootUrl+"icons/node-red/subflow.svg":RED.settings.apiRootUrl+"icons/node-red/arrow-in.svg"},getNodeLabel:function(t,o){var i;if(o=o||"","tab"===t.type)i=t.label||o;else if("group"===t.type)i=t.name||o;else{i=t._def.label;try{i=("function"==typeof i?i.call(t):i)||o}catch(e){console.log("Definition error: "+t.type+".label",e),i=o}}return RED.text.bidi.enforceTextDirectionWithUCC(i)},getNodeColor:function(e,t){var o=(t=t||{}).color,i=RED.settings.theme("palette.theme")||[];if(0<i.length){if(!d.hasOwnProperty(e)){d[e]=t.color;for(var n=i.length,a=0;a<n;a++){var r=i[a];if((!r.hasOwnProperty("category")||(r.hasOwnProperty("_category")||(r._category=new RegExp(r.category)),r._category.test(t.category)))&&(!r.hasOwnProperty("type")||(r.hasOwnProperty("_type")||(r._type=new RegExp(r.type)),r._type.test(e)))){d[e]=r.color||t.color;break}}}o=d[e]}return o||"#ddd"},clearNodeColorCache:function(){d={}},addSpinnerOverlay:function(e,t){return e=$('<div class="red-ui-component-spinner "><img src="red/images/spin.svg"/></div>').appendTo(e),t&&e.addClass("red-ui-component-spinner-contain"),e},decodeObject:function(e,t){if("number"===t&&"NaN"===e)e=Number.NaN;else if("number"===t&&"Infinity"===e)e=1/0;else if("number"===t&&"-Infinity"===e)e=-1/0;else if("Object"===t||/^(array|set|map)/.test(t)||"boolean"===t||"number"===t)e=JSON.parse(e);else if(/error/i.test(t))e=((e=JSON.parse(e)).name?e.name+": ":"")+e.message;else if("null"===t)e=null;else if("undefined"===t)e=void 0;else if(/^buffer/.test(t)){var o=e;e=[];for(var i=0;i<o.length;i+=2)e.push(parseInt(o.substr(i,2),16))}return e},parseContextKey:function(e,t){var o={},i=/^#:\((\S+?)\)::(.*)$/.exec(e);return i?(o.store=i[1],o.key=i[2]):(o.key=e,t?o.store=t:RED.settings.context&&(o.store=RED.settings.context.default)),o},createIconElement:function(e,t,o){var i=t.find(".red-ui-palette-icon"),n=(0!==i.length&&i.remove(),0!==(i=t.find("i")).length&&i.remove(),r(e));if("font-awesome"===n.module){var a=RED.nodes.fontAwesome.getIconUnicode(n.file);if(a)return void(i=$("<i/>").appendTo(t)).addClass("red-ui-palette-icon-fa fa fa-fw "+(o?"fa-lg ":"")+n.file);e=RED.settings.apiRootUrl+"icons/node-red/arrow-in.svg"}else if("red-ui-icons"===n.module)return void $("<i/>").appendTo(t).addClass("red-ui-palette-icon red-ui-icons "+n.file);$("<div/>",{class:"red-ui-palette-icon"}).appendTo(t).css("backgroundImage","url("+e+")")},sanitize:B,renderMarkdown:t,createNodeIcon:function(e,t){var o,i=$('<span class="red-ui-node-icon-container">'),n=e._def,a=$("<div>",{class:"red-ui-node-icon"}),r=("_selection_"===e.type?a.addClass("red-ui-palette-icon-selection"):"group"===e.type?a.addClass("red-ui-palette-icon-group"):"tab"===e.type?a.addClass("red-ui-palette-icon-flow"):(r=RED.utils.getNodeColor(e.type,n),a.css("backgroundColor",r),(o=l(r))!==r&&a.css("border-color",o)),RED.utils.getNodeIcon(n,e));return RED.utils.createIconElement(r,a,!0),a.appendTo(i),t&&(o=RED.utils.getNodeLabel(e,e.name||e.type+": "+e.id),n=$("<div>",{class:"red-ui-node-label"}).appendTo(i),o?n.text(o):n.html("&nbsp;")),i},getDarkerColor:l,parseModuleList:function(e){return(e=e||["*"]).map(function(e){var e=/^(.+?)(?:@(.*))?$/.exec(e),t=-1===(t=e[1].indexOf("*"))?1/0:t;return{module:new RegExp("^"+e[1].replace(/\*/g,".*")+"$"),version:e[2],wildcardPos:t}})},checkModuleAllowed:function(e,t,o,i){return!o&&!i||(0===o.length&&0===i.length||(o=a(e,0,o),e=a(e,0,i),!(!o||e)||!(!o&&e)&&(!o&&!e||(o.wildcardPos!==e.wildcardPos?o.wildcardPos>e.wildcardPos:o.module.toString().length>e.module.toString().length))))},getBrowserInfo:function(){var e={};try{var t=navigator.userAgent;e.ua=t,e.browser=/Edge\/\d+/.test(t)?"ed":/MSIE 9/.test(t)?"ie9":/MSIE 10/.test(t)?"ie10":/MSIE 11/.test(t)?"ie11":/MSIE\s\d/.test(t)?"ie?":/rv\:11/.test(t)?"ie11":/Firefox\W\d/.test(t)?"ff":/Chrom(e|ium)\W\d|CriOS\W\d/.test(t)?"gc":/\bSafari\W\d/.test(t)?"sa":/\bOpera\W\d/.test(t)||/\bOPR\W\d/i.test(t)?"op":"undefined"!=typeof MSPointerEvent?"ie?":"",e.os=/Windows NT 10/.test(t)?"win10":/Windows NT 6\.0/.test(t)?"winvista":/Windows NT 6\.1/.test(t)?"win7":/Windows NT 6\.\d/.test(t)?"win8":/Windows NT 5\.1/.test(t)?"winxp":/Windows NT [1-5]\./.test(t)?"winnt":/Mac/.test(t)?"mac":/Linux/.test(t)?"linux":/X11/.test(t)?"nix":"",e.touch="ontouchstart"in document.documentElement,e.mobile=/IEMobile|Windows Phone|Lumia/i.test(t)?"w":/iPhone|iP[oa]d/.test(t)?"i":/Android/.test(t)?"a":/BlackBerry|PlayBook|BB10/.test(t)?"b":/Mobile Safari/.test(t)?"s":/webOS|Mobile|Tablet|Opera Mini|\bCrMo\/|Opera Mobi/i.test(t)?1:0,e.tablet=/Tablet|iPad/i.test(t),e.ie=/MSIE \d|Trident.*rv:/.test(navigator.userAgent),e.android=/android/i.test(navigator.userAgent)}catch(e){}return e}}}(),function(s){s.widget("nodered.editableList",{_create:function(){var o=this,e=(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),this.options.buttons||[]),t=(!1!==this.options.addButton&&("string"==typeof this.options.addButton?t=this.options.addButton:i=RED&&RED._?(t=RED._("editableList.add"),RED._("editableList.addTitle")):(t="add","add new item"),e.unshift({label:t,icon:"fa fa-plus",click:function(e){o.addItem({})},title:i})),e.forEach(function(t){var e=s('<button type="button" class="red-ui-button red-ui-button-small red-ui-editableList-addButton" style="margin-top: 4px; margin-right: 5px;"></button>').appendTo(o.topContainer).on("click",function(e){e.preventDefault(),void 0!==t.click&&t.click(e)});t.id&&e.attr("id",t.id),t.title&&e.attr("title",t.title),t.icon&&e.append(s("<i></i>").attr("class",t.icon)),t.label&&e.append(s("<span></span>").text(" "+t.label))}),"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(e){var t=o.element.css(e);"auto"!==t&&""!==t&&(o.topContainer.css(e,t),o.uiContainer.css(e,"0"),"top"===e&&o.options.header&&o.uiContainer.css(e,"20px"),o.element.css(e,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),(this.options.header?this.borderContainer:this.uiContainer).addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0),this.element.css("minHeight")),i=("0px"!==t&&(this.uiContainer.css("minHeight",t),this.element.css("minHeight",0)),this.element.css("maxHeight")),e=("0px"!==i&&(this.uiContainer.css("maxHeight",i),this.element.css("maxHeight",null)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto"),this.element.attr("style"));null!==(t=/width\s*:\s*(\d+%)/i.exec(e))&&(this.element.width("100%"),this.uiContainer.width(t[1])),this.options.sortable&&(i={axis:"y",update:function(e,t){o.options.sortItems&&o.options.sortItems(o.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}},this.options.connectWith&&(i.connectWith=this.options.connectWith),this.element.sortable(i)),this._resize()},_resize:function(){var t,e=this.topContainer.height(),o=this.uiContainer.height();0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-(e-o)),this.options.resize&&this.options.resize(),this.options.resizeItem&&(t=this).element.children().each(function(e){t.options.resizeItem(s(this).children(".red-ui-editableList-item-content"),e)})},_destroy:function(){var e;this.topContainer&&(e=this.topContainer,delete this.topContainer,e.remove())},_refreshFilter:function(){var i=this,n=0;return this.activeFilter?(this.items().each(function(e,t){var o=t.data("data");try{i.activeFilter(o)?(t.parent().show(),n++):t.parent().hide()}catch(e){console.log(e),t.parent().show(),n++}}),n):this.element.children().show()},_refreshSort:function(){var e,o;this.activeSort&&(e=this.element.children(),o=this,e.sort(function(e,t){return o.activeSort(s(e).children(".red-ui-editableList-item-content").data("data"),s(t).children(".red-ui-editableList-item-content").data("data"))}),s.each(e,function(e,t){o.element.append(t)}))},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},getItemAt:function(e){var t=this.items();if(0<=e&&e<t.length)return s(t[e]).data("data")},indexOf:function(e){for(var t=this.items(),o=0;o<t.length;o++)if(s(t[o]).data("data")===e)return o;return-1},insertItemAt:function(i,e){var t,n=this,a=(i=i||{},s("<li>")),o=s("<div/>").addClass("red-ui-editableList-item-content").appendTo(a),r=(o.data("data",i),!0===this.options.sortable&&(s('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(a),a.addClass("red-ui-editableList-item-sortable")),this.options.removable&&(t=s("<a/>",{href:"#",class:"red-ui-editableList-item-remove red-ui-button red-ui-button-small"}).appendTo(a),s("<i/>",{class:"fa fa-remove"}).appendTo(t),a.addClass("red-ui-editableList-item-removable"),t.on("click",function(e){e.preventDefault();var t=o.data("data");a.addClass("red-ui-editableList-item-deleting"),a.fadeOut(300,function(){s(this).remove(),n.options.removeItem&&n.options.removeItem(t)})})),!1);if(this.activeSort&&this.items().each(function(e,t){var o;r||(o=t.data("data"),n.activeSort(i,o)<0&&(a.insertBefore(t.closest("li")),r=!0))}),r||(e<=0?a.prependTo(this.element):e>n.element.children().length-1?a.appendTo(this.element):a.insertBefore(this.element.children().eq(e))),this.options.addItem){e=n.element.children().length-1;if(n.options.addItem(o,e,i),n.activeFilter)try{n.activeFilter(i)||a.hide()}catch(e){}!n.activeSort&&n.scrollOnAdd&&setTimeout(function(){n.uiContainer.scrollTop(n.element.height())},0)}},addItem:function(e){this.insertItemAt(e,this.element.children().length)},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t,e){var o=this.element.children().filter(function(e){return t===s(this).children(".red-ui-editableList-item-content").data("data")});e?o.detach():o.remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map(function(e){return s(this).children(".red-ui-editableList-item-content")})},empty:function(){this.element.empty(),this.uiContainer.scrollTop(0)},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length},show:function(t){var e=this.element.children().filter(function(e){return t===s(this).children(".red-ui-editableList-item-content").data("data")});0<e.length&&this.uiContainer.scrollTop(this.uiContainer.scrollTop()+e.position().top)},getItem:function(e){e=e.children(".red-ui-editableList-item-content");return e.length?e.data("data"):null}})}(jQuery),function(u){u.widget("nodered.treeList",{_create:function(){var i=this,n=!0,e=(!1===i.options.autoSelect&&(n=!1),this.element.addClass("red-ui-treeList"),this.element.attr("tabIndex",0),u("<div>",{class:"red-ui-treeList-container"}).appendTo(this.element)),e=(this.element.on("keydown",function(e){var t,o=i._topList.find(".focus").parent().data("data");if(o||40!==e.keyCode&&38!==e.keyCode){switch(e.keyCode){case 32:case 13:if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;e.preventDefault(),e.stopPropagation(),o.checkbox?o.treeList.checkbox.trigger("click"):o.radio?o.treeList.radio.trigger("click"):o.children?o.treeList.container.hasClass("expanded")?o.treeList.collapse():o.treeList.expand():i._trigger("confirm",null,o);break;case 37:e.preventDefault(),e.stopPropagation(),o.children&&o.treeList.container.hasClass("expanded")?o.treeList.collapse():o.parent&&(t=o.parent);break;case 38:e.preventDefault(),e.stopPropagation(),!(t=(t=i._getPreviousSibling(o))&&i._getLastDescendant(t))&&o.parent&&(t=o.parent);break;case 39:e.preventDefault(),e.stopPropagation(),o.children&&(o.treeList.container.hasClass("expanded")||o.treeList.expand());break;case 40:if(e.preventDefault(),e.stopPropagation(),o.children&&Array.isArray(o.children)&&0<o.children.length&&o.treeList.container.hasClass("expanded"))t=o.children[0];else for(t=i._getNextSibling(o);!t&&o.parent;)o=o.parent,t=i._getNextSibling(o)}t&&(n?i.select(t):i._topList.find(".focus").removeClass("focus"),t.treeList.label.addClass("focus"))}else i._data[0]&&(n?i.select(i._data[0]):i._topList.find(".focus").removeClass("focus"),i._data[0].treeList.label.addClass("focus"))}),this._data=[],this._items={},this._selected=new Set,this._topList=u('<ol class="red-ui-treeList-list">').css({position:"absolute",top:0,left:0,right:0,bottom:0}).appendTo(e),{addButton:!1,scrollOnAdd:!1,height:"100%",addItem:function(e,t,o){i._addSubtree(i._topList,e,o,0)}});this.options.header&&(e.header=this.options.header),!1!==this.options.rootSortable&&this.options.sortable&&(e.sortable=this.options.sortable,e.connectWith=".red-ui-treeList-sortable",this._topList.addClass("red-ui-treeList-sortable")),this._topList.editableList(e),this.options.data&&this.data(this.options.data)},_getLastDescendant:function(e){return e.children&&e.treeList.container.hasClass("expanded")&&0!==e.children.length?this._getLastDescendant(e.children[e.children.length-1]):e},_getPreviousSibling:function(e){var t=e.parent?e.parent.children:this._data,e=t.indexOf(e);return 0===e?null:t[e-1]},_getNextSibling:function(e){var t=e.parent?e.parent.children:this._data,e=t.indexOf(e);return e===t.length-1?null:t[e+1]},_addChildren:function(e,i,o,n,a){var r=this,s=u('<ol class="red-ui-treeList-list">').appendTo(e).editableList({connectWith:".red-ui-treeList-sortable",sortable:r.options.sortable,addButton:!1,scrollOnAdd:!1,height:"auto",addItem:function(e,t,o){r._addSubtree(s,e,o,n+1)},sortItems:function(e){var t=[],o=[];e.each(function(){var e=u(this).data("data"),e=(t.push(e),r._fixDepths(i,e));e&&o.push(e)}),Array.isArray(i.children)&&(i.children=t),o.forEach(function(e){r._trigger("changeparent",null,e)}),r._trigger("sort",null,i)},filter:i.treeList.childFilter}),d=(r.options.sortable&&s.addClass("red-ui-treeList-sortable"),30),l=0,c=function(){for(var e=l,t=0;t<d;t++){if((l=e+t)===o.length)return void setTimeout(function(){a&&a()},10);o[l].parent=i,s.editableList("addItem",o[l])}++l<o.length&&setTimeout(function(){c()},10)};return c(),s.hide(),s},_fixDepths:function(e,t){var o,i=this,n=null;return t.parent!==e&&(reparented=!0,o=t.parent,t.parent=e,n={item:t,old:o}),t.depth!==e.depth+1&&(t.depth=e.depth+1,o=(t.gutter&&!t.gutter.hasClass("red-ui-treeList-gutter-float")?t.gutter.width()+2:0)+20*t.depth,t.treeList.labelPadding.width(o+"px"),t.element&&u(t.element).css({width:"calc(100% - "+(o+20+(t.icon?20:0))+"px)"}),t.children&&Array.isArray(t.children)&&t.children.forEach(function(e){i._fixDepths(t,e)})),n},_initItem:function(r,s){var d;r.treeList||(((d=this)._items[r.id]=r).treeList={},r.depth=s,r.treeList.remove=function(e){var t;if(r.treeList.parentList&&r.treeList.parentList.editableList("removeItem",r,e),r.parent&&(e=r.parent.children.indexOf(r),r.parent.children.splice(e,1),d._trigger("sort",null,r.parent)),d._selected.delete(r),delete r.treeList,delete d._items[r.id],0===r.depth){for(var o in d._items)!d._items.hasOwnProperty(o)||(t=d._items[o]).parent&&t.parent.id===r.id&&(delete d._items[o].treeList,delete d._items[o]);d._data=d._data.filter(function(e){return e.id!==r.id})}},r.treeList.insertChildAt=function(e,t,o){(e.parent=r).children.splice(t,0,e);function i(t,o){d._initItem(o,t.depth+1),o.parent=t,o.children&&"function"!=typeof o.children&&o.children.forEach(function(e){i(o,e,t.depth)})}i(r,e),!r.deferBuild&&r.treeList.childList&&(r.treeList.childList.editableList("insertItemAt",e,t),o&&setTimeout(function(){d.select(e)},100),d._trigger("sort",null,r),d.activeFilter&&d.filter(d.activeFilter))},r.treeList.addChild=function(e,t){r.treeList.insertChildAt(e,r.children.length,t)},r.treeList.expand=function(t){if(r.children){if(!r.treeList.container)return r.expanded=!0,void(t&&t(!1));var o,i,n,e,a=r.treeList.container;a.hasClass("expanded")?t&&t(!1):(a.hasClass("built")||!r.deferBuild&&"function"!=typeof r.children?(d._loadingData||20<r.children.length?r.treeList.childList.show():r.treeList.childList.slideDown("fast"),r.expanded=!0,t&&t(!d._loadingData)):(a.addClass("built"),o=!1,n=0,Date.now(),e=function(e){o=!0,r.treeList.childList=d._addChildren(a,r,e,s,function(){t&&t(!0),d._trigger("childrenloaded",null,r)});e=Date.now()-n;e<400?setTimeout(function(){r.treeList.childList.slideDown("fast"),i&&i.remove()},400-e):(r.treeList.childList.slideDown("fast"),i&&i.remove()),r.expanded=!0},"function"==typeof r.children?r.children(e,r):(delete r.deferBuild,e(r.children)),o||(n=Date.now(),i=u('<div class="red-ui-treeList-spinner">').css({"background-position":35+20*s+"px 50%"}).appendTo(a))),a.addClass("expanded"))}else t&&t(!1)},r.treeList.collapse=function(){!1!==r.collapsible&&r.children&&(r.expanded=!1,r.treeList.container&&(r.children.length<20?r.treeList.childList.slideUp("fast"):r.treeList.childList.hide(),r.treeList.container.removeClass("expanded")))},r.treeList.sortChildren=function(e){r.children&&(r.children.sort(e),r.treeList.childList&&(r.treeList.childList.editableList("sort",e),r.treeList.childList.editableList("sort",null)))},r.treeList.replaceElement=function(e){var t;r.element&&(r.treeList.container&&(u(r.element).remove(),u(e).appendTo(r.treeList.label),t=(r.gutter?r.gutter[0].offsetWidth+2:0)+20*r.depth,u(e).css({width:"calc(100% - "+(t+20+(r.icon?20:0))+"px)"})),r.element=e)},r.children&&"function"!=typeof r.children&&r.children.forEach(function(e){d._initItem(e,s+1)}))},_addSubtree:function(e,o,i,t){var n,a,r=this,s=(this._initItem(i,t),i.treeList.container=o,i.treeList.parentList=e,u("<div>",{class:"red-ui-treeList-label"})),e=(s.appendTo(o),i.treeList.label=s,i.class&&s.addClass(i.class),i.gutter&&i.gutter.css({position:"absolute"}).appendTo(s),(i.gutter&&!i.gutter.hasClass("red-ui-treeList-gutter-float")?i.gutter.width()+2:0)+20*t),d=(i.treeList.labelPadding=u("<span>").css({display:"inline-block","flex-shrink":0,width:e+"px"}).appendTo(s),s.on("mouseover",function(e){r._trigger("itemmouseover",e,i)}),s.on("mouseout",function(e){r._trigger("itemmouseout",e,i)}),s.on("mouseenter",function(e){r._trigger("itemmouseenter",e,i)}),s.on("mouseleave",function(e){r._trigger("itemmouseleave",e,i)}),i.treeList.makeLeaf=function(e){var t;d.children().length&&(e&&i.children&&(t=function(e){e.children&&e.children.forEach(function(e){e.element&&e.element.detach(),e.gutter&&e.gutter.detach(),t(e)})})(i),d.empty(),i.deferBuild||(i.treeList.childList.remove(),delete i.treeList.childList),s.off("click.red-ui-treeList-expand"),d.off("click.red-ui-treeList-expand"),delete i.children,o.removeClass("expanded"),delete i.expanded)},i.treeList.makeParent=function(e){d.children().length||(u('<i class="fa fa-angle-right" />').toggleClass("hide",!1===i.collapsible).appendTo(d),d.on("click.red-ui-treeList-expand",function(e){e.stopPropagation(),e.preventDefault(),o.hasClass("expanded")?i.treeList.collapse():i.treeList.expand()}),s.on("click.red-ui-treeList-expand",function(e){o.hasClass("expanded")?(i.hasOwnProperty("selected")||s.hasClass("selected"))&&i.treeList.collapse():i.treeList.expand()}),i.children||(i.children=e||[],i.treeList.childList=r._addChildren(o,i,i.children,t)))},u('<span class="red-ui-treeList-icon"></span>').appendTo(s));i.children&&i.treeList.makeParent(),i.checkbox?(n=u('<span class="red-ui-treeList-icon"></span>'),(a=u('<input class="red-ui-treeList-checkbox" type="checkbox">').prop("checked",i.selected).appendTo(n)).on("click",function(e){e.stopPropagation()}),a.on("change",function(e){i.selected=this.checked,i.selected?r._selected.add(i):r._selected.delete(i),s.toggleClass("selected",this.checked),r._trigger("select",e,i)}),i.children||s.on("click",function(e){e.stopPropagation(),a.trigger("click"),r._topList.find(".focus").removeClass("focus"),s.addClass("focus")}),i.treeList.select=function(e){e!==i.selected&&a.trigger("click")},i.treeList.checkbox=a,n.appendTo(s)):i.radio?(n=u('<span class="red-ui-treeList-icon"></span>'),(a=u('<input class="red-ui-treeList-radio" type="radio">').prop("name",i.radio).prop("checked",i.selected).appendTo(n)).on("click",function(e){e.stopPropagation()}),a.on("change",function(e){i.selected=this.checked,r._selected.forEach(function(e){e.radio===i.radio&&(e.treeList.label.removeClass("selected"),e.selected=!1,r._selected.delete(e))}),i.selected?r._selected.add(i):r._selected.delete(i),s.toggleClass("selected",this.checked),r._trigger("select",e,i)}),i.children||s.on("click",function(e){e.stopPropagation(),a.trigger("click"),r._topList.find(".focus").removeClass("focus"),s.addClass("focus")}),i.treeList.select=function(e){e!==i.selected&&a.trigger("click")},n.appendTo(s),i.treeList.radio=a):(s.on("click",function(e){r.options.multi||r.clearSelection(),s.addClass("selected"),r._selected.add(i),r._topList.find(".focus").removeClass("focus"),s.addClass("focus"),r._trigger("select",e,i)}),s.on("dblclick",function(e){r._topList.find(".focus").removeClass("focus"),s.addClass("focus"),i.children||r._trigger("confirm",e,i)}),i.treeList.select=function(e){r.options.multi||r.clearSelection(),s.toggleClass("selected",e),e?(r._selected.add(i),r._trigger("select",null,i)):r._selected.delete(i),r.reveal(i)}),s.toggleClass("selected",!!i.selected),i.selected&&r._selected.add(i),i.icon&&("string"==typeof i.icon?u('<span class="red-ui-treeList-icon"><i class="'+i.icon+'" /></span>').appendTo(s):u('<span class="red-ui-treeList-icon">').appendTo(s).append(i.icon)),i.hasOwnProperty("label")||i.hasOwnProperty("sublabel")?(i.hasOwnProperty("label")&&u('<span class="red-ui-treeList-label-text"></span>').text(i.label).appendTo(s),i.hasOwnProperty("sublabel")&&u('<span class="red-ui-treeList-sublabel-text"></span>').text(i.sublabel).appendTo(s)):i.element&&(u(i.element).appendTo(s),u(i.element).css({width:"calc(100% - "+(e+20+(i.icon?20:0))+"px)"})),i.children&&(Array.isArray(i.children)&&!i.deferBuild&&(i.treeList.childList=r._addChildren(o,i,i.children,t)),i.expanded&&i.treeList.expand())},empty:function(){this._topList.editableList("empty")},data:function(e){var t=this;if(void 0===e)return this._data;this._data=e,this._items={},this._topList.editableList("empty"),this._loadingData=!0;for(var o=0;o<e.length;o++)this._topList.editableList("addItem",e[o]);setTimeout(function(){delete t._loadingData},200),this._trigger("select")},show:function(e,o){if(e="string"==typeof e?this._items[e]:e){for(var i=this,n=[],t=e;t;)n.unshift(t),t=t.parent;var a=!1,r=function(e){a=a||e;var t=n.shift();0===n.length?setTimeout(function(){i.reveal(t),o&&o()},a?200:0):t.treeList.expand(r)};r()}},reveal:function(e){var t,o,i;(e="string"==typeof e?this._items[e]:e)&&(o=this._topList.offset().top,t=e.treeList.label.offset().top,t-=o+(o=this._topList.parent().scrollTop()),i=this._topList.parent().height(),t<(e=e.treeList.label.outerHeight())/2?this._topList.parent().scrollTop(o+t-e/2-e):i<t+e&&this._topList.parent().scrollTop(o+(t+2.5*e-i)))},select:function(e,t,o){var i=this;this.options.multi||!1===o||this.clearSelection(),Array.isArray(e)?e.forEach(function(e){i.select(e,t,!1)}):(e="string"==typeof e?this._items[e]:e)&&(e.selected=!0,this._selected.add(e),e.treeList.label&&e.treeList.label.addClass("selected"),i._topList.find(".focus").removeClass("focus"),!1!==t&&this._trigger("select",null,e))},clearSelection:function(){this._selected.forEach(function(e){e.selected=!1,e.treeList.checkbox&&e.treeList.checkbox.prop("checked",!1),e.treeList.label&&e.treeList.label.removeClass("selected")}),this._selected.clear()},selected:function(){var t=[];return this._selected.forEach(function(e){t.push(e)}),this.options.multi?t:t.length?t[0]:void 0},filter:function(i){this.activeFilter=i;function n(e){var t=0,o=(i&&i(e)&&(t++,a++),0);return e.children&&"function"!=typeof e.children&&(e.treeList.childList?o=e.treeList.childList.editableList("filter",n):(e.treeList.childFilter=n,i&&e.children.forEach(function(e){n(e)&&o++})),t+=o,i&&0<o&&setTimeout(function(){e.treeList.expand()},10)),i?0<t:(a++,!0)}var a=0;return this._topList.editableList("filter",n),a},get:function(e){return this._items[e]||null}})}(jQuery),function(t){t.widget("nodered.checkboxSet",{_create:function(){var o=this,e=(this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0,this.element.prop("checked"));this.states=[t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),t('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],(e?this.states[1]:this.states[0]).show(),this.element.on("change",function(){this.checked?(o.states[0].hide(),o.states[1].show()):(o.states[1].hide(),o.states[0].show()),o.states[2].hide();var t=this.checked;o.children.forEach(function(e){e.checkboxSet("state",t,!1,!0)})}),this.uiElement.on("click",function(e){e.stopPropagation(),o.state(!1===o.state())}),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){e=this.children.indexOf(e);-1<e&&this.children.splice(e,1)},updateChild:function(e){var o=0;this.children.forEach(function(e,t){!0===e.checkboxSet("state")&&o++}),0===o?this.state(!1,!0):o===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,o){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var i=this.partialFlag||e;this.element.prop("checked",i),!0===e?(this.states[0].hide(),this.states[1].show(),this.states[2].hide()):!1===e?(this.states[2].hide(),this.states[1].hide(),this.states[0].show()):null===e&&(this.states[0].hide(),this.states[1].hide(),this.states[2].show()),t||this.element.trigger("change",null),!o&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){var s={};function d(t){var e;if(null!==t&&t.id&&!1===RED.settings.theme("menu."+t.id))return null;if(null===t)e=$('<li class="red-ui-menu-divider"></li>');else{e=$("<li></li>"),t.group&&e.addClass("red-ui-menu-group-"+t.group);var o,i="<a "+(t.id?'id="'+t.id+'" ':"")+'tabindex="-1" href="#">',i=(t.toggle&&(i+='<i class="fa fa-square pull-left"></i><i class="fa fa-check-square pull-left"></i>'),void 0!==t.icon&&(/\.(png|svg)/.test(t.icon)?i+='<img src="'+t.icon+'"/> ':i+='<i class="'+(t.icon||'" style="display: inline-block;"')+'"></i> '),t.sublabel?i+='<span class="red-ui-menu-label-container"><span class="red-ui-menu-label">'+t.label+'</span><span class="red-ui-menu-sublabel">'+t.sublabel+"</span></span>":i+='<span class="red-ui-menu-label"><span>'+t.label+"</span></span>",i+="</a>",$(i).appendTo(e));if(t.link=i,"string"!=typeof t.onselect||(o=RED.keyboard.getShortcut(t.onselect))&&o.key&&(t.shortcutSpan=$('<span class="red-ui-popover-key">'+RED.keyboard.formatKey(o.key,!0)+"</span>").appendTo(i.find(".red-ui-menu-label"))),(s[t.id]=t).onselect?(i.on("click",function(e){e.preventDefault(),$(this).parent().hasClass("disabled")||(t.toggle?!0===t.toggle?u(t.id,!c(t.id)):u(t.id,!0):l(t.id))}),t.toggle&&(o=RED.settings.get("menu-"+t.id),t.setting&&(null!==o?(RED.settings.set(t.setting,o),RED.settings.remove("menu-"+t.id)):o=RED.settings.get(t.setting)),o?(i.addClass("active"),l(t.id,!0)):!1===o?(i.removeClass("active"),l(t.id,!1)):t.hasOwnProperty("selected")&&(t.selected?i.addClass("active"):i.removeClass("active"),l(t.id,t.selected)))):t.href?i.attr("target","_blank").attr("href",t.href):t.options||(e.addClass("disabled"),i.on("click",function(e){e.preventDefault()})),t.options){e.addClass("red-ui-menu-dropdown-submenu pull-left");for(var n=$('<ul id="'+t.id+'-submenu" class="red-ui-menu-dropdown"></ul>').appendTo(e),a=0;a<t.options.length;a++){var r=d(t.options[a]);r&&r.appendTo(n)}}t.disabled&&e.addClass("disabled")}return e}function l(e,t){var o=s[e],i=o.onselect;(i="string"==typeof o.onselect?RED.actions.get(o.onselect):i)?i.call(o,t):console.log("No callback for",e,o.onselect)}function c(e){return $("#"+e).hasClass("active")}function u(e,t){var o=!1,i=(c(e)==t&&(o=!0),s[e]);if(t?$("#"+e).addClass("active"):$("#"+e).removeClass("active"),i){if(i.toggle&&"string"==typeof i.toggle&&t)for(var n in s)!s.hasOwnProperty(n)||(n=s[n]).id!=i.id&&i.toggle==n.toggle&&u(n.id,!1);!o&&i.onselect&&l(i.id,t),i.local||o||RED.settings.set(i.setting||"menu-"+i.id,t)}}return{init:function(e){for(var t,o=$("<ul/>",{class:"red-ui-menu red-ui-menu-dropdown pull-right"}),i=(e.id&&(o.attr({id:e.id+"-submenu"}),1===(t=$("#"+e.id)).length&&(o.insertAfter(t),t.on("click",function(e){e.stopPropagation(),e.preventDefault(),o.is(":visible")?($(document).off("click.red-ui-menu"),o.hide()):($(document).on("click.red-ui-menu",function(e){$(document).off("click.red-ui-menu"),activeMenu=null,o.hide()}),$(".red-ui-menu.red-ui-menu-dropdown").hide(),o.show())}))),!1),n=0;n<e.options.length;n++){var a,r=e.options[n];null===r&&i||(a=d(r))&&(a.appendTo(o),i=null===r)}return o},setSelected:u,isSelected:c,toggleSelected:function(e){u(e,!c(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(e,t){var o=d(t);if(null!==t&&t.group){var i=$("#"+e+"-submenu").children(".red-ui-menu-group-"+t.group);if(0===i.length)o.appendTo("#"+e+"-submenu");else{for(var n=0;n<i.length;n++){var a=i[n],r=$(a).find(".red-ui-menu-label").html();if(t.label<r){$(a).before(o);break}}n===i.length&&o.appendTo("#"+e+"-submenu")}}else o.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(e,t){(e=s[e])&&(e.onselect=t)},refreshShortcuts:function(){for(var e in s){var t;!s.hasOwnProperty(e)||"string"==typeof(e=s[e]).onselect&&e.shortcutSpan&&(e.shortcutSpan.remove(),delete e.shortcutSpan,(t=RED.keyboard.getShortcut(e.onselect))&&t.key&&(e.shortcutSpan=$('<span class="red-ui-popover-key">'+RED.keyboard.formatKey(t.key,!0)+"</span>").appendTo(e.link.find(".red-ui-menu-label"))))}}}}(),RED.panels={create:function(a){var r=a.container||$("#"+a.id),s=r.children();if(2!==s.length)throw console.log(a.id),new Error("Container must have exactly two children");var d,l=!a.dir||"vertical"===a.dir,t=(r.addClass("red-ui-panels"),l||r.addClass("red-ui-panels-horizontal"),$(s[0]).addClass("red-ui-panel"),$(s[1]).addClass("red-ui-panel"),$('<div class="red-ui-panels-separator"></div>').insertAfter(s[0])),c=[],i=!1,u=.5,o=(t.draggable({axis:l?"y":"x",containment:r,scroll:!1,start:function(e,t){d=l?t.position.top:t.position.left,c=[l?$(s[0]).height():$(s[0]).width(),l?$(s[1]).height():$(s[1]).width()]},drag:function(e,t){var o=l?r.height():r.width(),i=(l?t.position.top:t.position.left)-d,n=[c[0]+i,c[1]-i];l?($(s[0]).height(n[0]),t.position.top-=i):($(s[0]).width(n[0]),t.position.left-=i),a.resize&&a.resize(n[0],n[1]),u=n[0]/(o-8)},stop:function(e,t){i=!0}}),{ratio:function(e){if(void 0===e)return u;i=!0,0===(u=e)||1===e?t.hide():t.show(),l?o.resize(r.height()):o.resize(r.width())},resize:function(e){var t,o;l?(o=[$(s[0]).outerHeight(),$(s[1]).outerHeight()],r.height(e)):(o=[$(s[0]).outerWidth(),$(s[1]).outerWidth()],r.width(e)),i&&(o=[t=u*(e-8),e-t-8],l?$(s[0]).outerHeight(o[0]):$(s[0]).outerWidth(o[0])),a.resize&&(o=l?[$(s[0]).height(),$(s[1]).height()]:[$(s[0]).width(),$(s[1]).width()],a.resize(o[0],o[1]))}});return o}},RED.popover=function(){var E={default:{x:12,y:12},small:{x:8,y:8}};return{create:function(i){var c=i.target,u=i.direction||"right",d=i.trigger,l=i.content,g=i.delay||{show:750,hide:50},t=i.autoClose,m=i.width||"auto",b=i.maxWidth,p=i.size||"default",f=i.offset||0;if(!E[p])throw new Error("Invalid RED.popover size value:",p);function o(e){if(a){var t=c.data("red-ui-popover");if(i.tooltip&&t)a=!1;else{if(h=$('<div class="red-ui-popover"></div>'),i.class&&h.addClass(i.class),y=$('<div class="red-ui-popover-content">').appendTo(h),"default"!==p&&h.addClass("red-ui-popover-size-"+p),"function"==typeof l){var o=l.call(s);if(null===o)return;"string"==typeof o?y.text(o):y.append(o)}else y.html(l);h.appendTo("body"),v({target:c,direction:u,width:m,maxWidth:b}),t&&t.close(!0),"manual"!==i.trigger&&c.data("red-ui-popover",s),i.tooltip&&h.on("mousedown",function(e){n(!0)}),"hover"===d&&i.interactive&&(h.on("mouseenter",function(e){clearTimeout(r),a=!0}),h.on("mouseleave",function(e){r&&clearTimeout(r),a&&(r=setTimeout(function(){a=!1,n()},g.hide))})),e?h.show():h.fadeIn("fast")}}}function v(e){c=e.target||c,u=e.direction||u||"right",f=e.offset||f;var t=e.transition,o=e.width||"auto";h.width(o),e.maxWidth?h.css("max-width",e.maxWidth):h.css("max-width","auto");var e=(o=c[0].getBoundingClientRect()).height,i=o.width,n=h.outerHeight(),a=h.outerWidth(),r=$(window).scrollTop(),s=$(window).scrollLeft(),r=r+$(window).height(),s=s+$(window).width(),d=0,l=0;"right"===u?(d=o.top+e/2-n/2,l=o.left+i+E[p].x+f):"left"===u?(d=o.top+e/2-n/2,l=o.left-E[p].x-a-f):"bottom"===u?(d=o.top+e+E[p].y+f,(l=o.left+i/2-a/2)<0?(u="right",d=o.top+e/2-n/2,l=o.left+i+E[p].x+f):s<l+a+10?(u="left",d=o.top+e/2-n/2,l=o.left-E[p].x-a-f,r<d+n+e/2+5&&(d-=d+n+e/2-r+5)):r<d+n&&(u="top",d=o.top-E[p].y-n-f,l=o.left+i/2-a/2)):"top"===u?(d=o.top-E[p].y-n-f,l=o.left+i/2-a/2,d<0&&(u="bottom",d=o.top+e+E[p].y+f,l=o.left+i/2-a/2)):/inset/.test(u)&&(d=o.top+e/2-n/2,l=o.left+i/2-a/2,/bottom/.test(u)&&(d=o.top+e-n-f),/top/.test(u)&&(d=o.top+f),/left/.test(u)&&(l=o.left+f),/right/.test(u)&&(l=o.left+i-a-f)),w&&h.removeClass(w),t&&h.css({transition:"0.6s ease","transition-property":"top,left,right,bottom"}),w="red-ui-popover-"+u,h.addClass(w).css({top:d,left:l}),t&&setTimeout(function(){h.css({transition:"none"})},600)}function n(e){$(document).off("mousedown.red-ui-popover"),a||h&&(e?h.remove():h.fadeOut("fast",function(){$(this).remove()}),h=null,c.removeData("red-ui-popover",s))}var a,h,y,w,r=null,s=(c.on("remove",function(e){r&&clearTimeout(r),a&&(a=!1,setTimeout(n,g.hide))}),"hover"===d?(c.on("mouseenter",function(e){clearTimeout(r),a||(a=!0,r=setTimeout(o,g.show))}),c.on("mouseleave disabled",function(e){r&&clearTimeout(r),a&&(a=!1,setTimeout(n,g.hide))})):"click"===d?(c.on("click",function(e){e.preventDefault(),e.stopPropagation(),((a=!a)?o:n)()}),t&&c.on("mouseleave disabled",function(e){r&&clearTimeout(r),a&&(a=!1,setTimeout(n,t))})):"modal"===d?$(document).on("mousedown.red-ui-popover",function(e){for(var t=e.target;"BODY"!==t.nodeName&&t!==h[0];)t=t.parentElement;"BODY"===t.nodeName&&(a=!1,n())}):t&&setTimeout(function(){a=!1,n()},t),{get element(){return h},setContent:function(e){return l=e,s},open:function(e){return a=!0,o(e),s},close:function(e){return a=!1,n(e),s},move:function(e){v(e)}});return s},tooltip:function(e,o,i){e=RED.popover.create({tooltip:!0,target:e,trigger:"hover",size:"small",direction:"bottom",content:function(){var e,t=o;return!i||(e=RED.keyboard.getShortcut(i))&&e.key&&(t=$("<span>"+o+' <span class="red-ui-popover-key">'+RED.keyboard.formatKey(e.key,!0)+"</span></span>")),t},delay:{show:750,hide:50}});return e.setContent=function(e){o=e},e.setAction=function(e){i=e},e},menu:function(o){var i=$('<ul class="red-ui-menu"></ul>'),n=("compact"===o.style&&i.addClass("red-ui-menu-compact"),o.options||[]),t=RED.popover.panel(i),a=(o.width&&t.container.width(o.width),o.class&&t.container.addClass(o.class),o.maxHeight&&t.container.css({"max-height":o.maxHeight,"overflow-y":"auto"}),{options:function(e){if(void 0===e)return n;n=e||[],i.empty(),n.forEach(function(t){var e=$("<li>").appendTo(i),e=$('<a href="#"></a>').appendTo(e);"string"==typeof t.label?e.text(t.label):t.label&&t.label.appendTo(e),e.on("click",function(e){e.preventDefault(),t.onselect?t.onselect():o.onselect&&o.onselect(t),a.hide()}),0})},show:function(e){$(document).on("keydown.red-ui-menu",function(e){var t=i.find(":focus").parent();40===e.keyCode?(e.preventDefault(),(!(0<t.length)||t.index()===n.length-1?i.children().first():t.next()).children().first().focus()):38===e.keyCode?(e.preventDefault(),(!(0<t.length)||0===t.index()?i.children().last():t.prev()).children().first().focus()):27===e.keyCode?(e.preventDefault(),a.hide(!0)):9===e.keyCode&&o.tabSelect&&(e.preventDefault(),t.find("a").trigger("click")),e.stopPropagation()}),e.onclose=function(){$(document).off("keydown.red-ui-menu"),o.onclose&&o.onclose(!0)},t.show(e)},hide:function(e){$(document).off("keydown.red-ui-menu"),t.hide(o.disposeOnClose),o.onclose&&o.onclose(e)}});return a.options(n),a},panel:function(e){var l=$('<div class="red-ui-editor-dialog red-ui-popover-panel"></div>');function c(e){$(document).off("mousedown.red-ui-popover-panel-close"),$(document).off("keydown.red-ui-popover-panel-close"),l.hide(),l.css({height:"auto"}),!1!==e&&l.remove()}return l.css({display:"none"}),l.appendTo(document.body),e.appendTo(l),{container:l,show:function(t){var o=t.onclose,i=t.closeButton,e=t.target,n=t.align||"right",a=t.offset||[0,0],r=e.offset(),e=(e.width(),e.outerHeight()),s=l.height(),d=l.width();(e=e+r.top+a[1])+s-$(document).scrollTop()>$(window).height()&&(e-=e+s-$(window).height()+5),e<0&&(l.height(s+e),e=0),"right"===n?l.css({top:e+"px",left:r.left+a[0]+"px"}):"left"===n&&l.css({top:e+"px",left:r.left-d+a[0]+"px"}),l.slideDown(100),$(document).on("keydown.red-ui-popover-panel-close",function(e){27===e.keyCode&&(o&&o(),c(t.dispose))}),$(document).on("mousedown.red-ui-popover-panel-close",function(e){i&&$(e.target).closest(i).length||$(e.target).closest(l).length||$(e.target).closest(".red-ui-editor-dialog").length||(o&&o(),c(t.dispose))})},hide:c}}}}(),function(n){n.widget("nodered.searchBox",{_create:function(){var t,o,i=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.element.addClass("red-ui-searchBox-input"),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),"compact"===this.options.style&&this.uiContainer.addClass("red-ui-searchBox-compact"),0===this.element.parents("form").length&&this.element.wrap("<form>").parent().addClass("red-ui-searchBox-form"),n('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=n('<a class="red-ui-searchBox-clear" href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(e){e.preventDefault(),i.element.val(""),i._change("",!0),i.element.trigger("focus")}),this.options.options&&(this.uiContainer.addClass("red-ui-searchBox-has-options"),this.optsButton=n('<a class="red-ui-searchBox-opts" href="#"><i class="fa fa-caret-down"></i></a>').appendTo(this.uiContainer),t=!1,this.optsMenu=RED.popover.menu({style:this.options.style,options:this.options.options.map(function(e){return{label:e.label,onselect:function(){i.element.val(e.value+" "),i._change(e.value,!0)}}}),onclose:function(e){t=!1,i.element.trigger("focus")},disposeOnClose:!1}),o=function(){t=!0,i.optsMenu.show({target:i.optsButton,align:"left",offset:[i.optsButton.width()-2,-1],dispose:!1})},this.optsButton.on("click",function(e){e.preventDefault(),t?i.optsMenu.hide(!0):o()}),this.optsButton.on("keydown",function(e){t||40!==e.keyCode||o()}),this.element.on("keydown",function(e){t||40!==e.keyCode||o()})),this.resultCount=n("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(e){27===e.keyCode&&i.element.val(""),13===e.keyCode&&e.preventDefault()}),this.element.on("keyup",function(e){i._change(n(this).val())}),this.element.on("focus",function(){n(document).one("mousedown",function(){i.element.blur()})})},_change:function(e,t){var o,i=!1,i=""===e?(this.clearButton.hide(),!0):(this.clearButton.show(),e.length>=(this.options.minimumLength||0)),e=this.element.val();(i=i&&e!==this.lastSent)&&(!t&&0<this.options.delay?(clearTimeout(this.currentTimeout),(o=this).currentTimeout=setTimeout(function(){o.lastSent=o.element.val(),o._trigger("change")},this.options.delay)):(this.lastSent=this.element.val(),this._trigger("change")))},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){null==e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){var O,N="fa fa-lemon-o",I=!1,P=!1;return{create:function(f){var l,h,E,e,o,i,n,t,a,r,g,s,m={},D=0,c=0,R=f.order,b=f.element||$("#"+f.id),d=b.wrap("<div>").parent(),v=b.wrap("<div>").parent();function u(e,t){var o,i;e.preventDefault(),$(this).hasClass("disabled")||(o=v.scrollLeft(),v.animate({scrollLeft:t},100),i=setInterval(function(){var e=v.scrollLeft();e!==o?(o=e,v.animate({scrollLeft:t},100)):clearInterval(i)},100),$(this).one("mouseup",function(){clearInterval(i)}))}function p(){var e=b.find("li.red-ui-tab.selected"),t=[];return e.each(function(){t.push(m[$(this).find("a").attr("href").slice(1)])}),t}function x(){f.onselect(p())}function _(e){if(!I)if(e.currentTarget===E){if(E=null,O&&Date.now()-O<400)return P=!(O=0),function(e){if(e.preventDefault(),!e.metaKey&&!e.shiftKey)return f.ondblclick&&f.ondblclick(m[$(this).attr("href").slice(1)]),!1}.call(this,e);O=Date.now();var t,o,i=b.find("li.red-ui-tab.active"),n=$(this).parent(),a=!1;if(f.onselect)if(e.metaKey||e.ctrlKey){if(n.hasClass("selected")){if(n.removeClass("selected"),n[0]!==i[0])return void x();if(0===(o=b.find("li.red-ui-tab.selected")).length)return void x();n=o.first()}else i.hasClass("selected")||(m[i.find("a").attr("href").slice(1)],i.addClass("selected")),n.addClass("selected");a=!0}else e.shiftKey?(i[0]!==n[0]&&(e=i.index()<n.index()?(t=i,n):(t=n,i),b.find("li.red-ui-tab").removeClass("selected"),t.addClass("selected"),e.addClass("selected"),t.nextUntil(e).addClass("selected")),a=!0):0<(o=b.find("li.red-ui-tab.selected")).length&&(o.removeClass("selected"),a=!0);i=n.find("a");f.onclick&&f.onclick(m[i.attr("href").slice(1)]),y(i),a&&x()}else E=null}function k(){var e,t,o;0!==b.children().length&&(e=v.scrollLeft(),t=v.width(),o=b.width(),0===e?a.hide():a.show(),e===o-t?r.hide():r.show())}function y(e){var t;0!==(e="string"==typeof e?b.find("a[href='#"+e+"']"):e).length&&(e.parent().hasClass("hide-tab")&&(e.parent().removeClass("hide-tab").removeClass("hide"),f.onshow&&f.onshow(m[e.attr("href").slice(1)])),e.parent().hasClass("active")||(b.children().removeClass("active"),b.children().css({transition:"width 100ms"}),e.parent().addClass("active"),t=e.parent().attr("id"),d.find(".red-ui-tab-link-button").removeClass("active selected"),$("#"+t+"-link-button").addClass("active selected"),f.scrollable&&((t=e.parent().position().left)-21<0?v.animate({scrollLeft:"+="+(t-50)},300):t+120>v.width()&&v.animate({scrollLeft:"+="+(t+140-v.width())},300)),f.onchange&&f.onchange(m[e.attr("href").slice(1)]),w(),setTimeout(function(){b.children().css({transition:""})},100)))}function w(){if(!f.vertical){var e,t=b.find("li.red-ui-tab"),o=t.filter(":not(.hide-tab)"),t=t.filter(".hide-tab"),i=d.width(),n=o.length;if(f.collapsible){var a=g.children().length,r=g.children(":visible").length;if((e=i-g.width()-10)<=120||e<198&&5<r){var s=g.find("a:last").prev();for(g.children().length;s.is(":not(:visible)");)s=s.prev(),0;(e<=120||6<r)&&s.hide(),e=Math.max(120,i-g.width()-10)}else 40<i-(e=r!==a?r<6?120:198:e)-g.width()&&g.find("a:not(:visible):first").show(),e=i-g.width()-10;o.css({width:e})}else c=(l=100*(e=(i-12-6*n)/n)/i+"%")+"%",f.scrollable?(e=Math.max(e,140),l=e+"px",c=0,a=Math.max(d.width(),12+(e+6)*n),b.width(a),k()):f.hasOwnProperty("minimumActiveTabWidth")&&(c=e<f.minimumActiveTabWidth?(e=(i-12-f.minimumActiveTabWidth-6*--n)/n,l=100*e/i+"%",f.minimumActiveTabWidth+"px"):0),o.css({width:l}),t.css({width:"0px"}),e<50?(b.find(".red-ui-tab-icon").hide(),b.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,e-38))+"px"})):(b.find(".red-ui-tab-icon").show(),b.find(".red-ui-tab-label").css({paddingLeft:""})),0!==c&&(b.find("li.red-ui-tab.active").css({width:f.minimumActiveTabWidth}),b.find("li.red-ui-tab.active .red-ui-tab-icon").show(),b.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}function T(e){!f.onselect||0<(o=b.find("li.red-ui-tab.selected")).length&&(o.removeClass("selected"),x());var t,o=b.find("a[href='#"+e+"']").parent();o.hasClass("active")&&(0<(t=0===(t=C(o)).length?j(o):t).length?y(t.find("a")):f.onchange&&f.onchange(null)),o.remove(),m[e].pinned&&D--,f.onremove&&f.onremove(m[e]),delete m[e],w(),h&&(h.remove(),h=null)}function C(e){for(var t=(e=e||b.find("li.active")).prev();0<t.length&&t.hasClass("hide-tab");)t=t.prev();return t}function j(e){for(var t=(e=e||b.find("li.active")).next();0<t.length&&t.hasClass("hide-tab");)t=t.next();return t}function L(t){var o,e;m[t]&&((o=b.find("a[href='#"+t+"']").parent()).hasClass("hide-tab")||(o.hasClass("active")&&(0<(e=0===(e=C(o)).length?j(o):e).length?y(e.find("a")):f.onchange&&f.onchange(null)),o.removeClass("active"),o.one("transitionend",function(e){o.addClass("hide"),w(),f.onhide&&f.onhide(m[t]),setTimeout(function(){k()},200)}),o.addClass("hide-tab"),o.css({width:0})))}d.addClass("red-ui-tabs"),f.vertical&&d.addClass("red-ui-tabs-vertical"),f.addButton&&(d.addClass("red-ui-tabs-add"),(i=$('<div class="red-ui-tab-button red-ui-tabs-add"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(d)).find("a").on("click",function(e){e.preventDefault(),"function"==typeof f.addButton?f.addButton():"string"==typeof f.addButton&&RED.actions.invoke(f.addButton)}),"string"==typeof f.addButton&&(e=f.addButton,f.addButtonCaption&&(e=f.addButtonCaption),RED.popover.tooltip(i,e,f.addButton)),b.on("dblclick",function(e){var t=b.children(),o=e.clientX,i=0;t.each(function(e){if($(this).offset().left>o)return!1;i=e+1}),"function"==typeof f.addButton?f.addButton({index:i}):"string"==typeof f.addButton&&RED.actions.invoke(f.addButton,{index:i})})),f.searchButton&&(d.addClass("red-ui-tabs-search"),(i=$('<div class="red-ui-tab-button red-ui-tabs-search"><a href="#"><i class="fa fa-list-ul"></i></a></div>').appendTo(d)).find("a").on("click",function(e){e.preventDefault(),"function"==typeof f.searchButton?f.searchButton():"string"==typeof f.searchButton&&RED.actions.invoke(f.searchButton)}),"string"==typeof f.searchButton&&(e=f.searchButton,f.searchButtonCaption&&(e=f.searchButtonCaption),RED.popover.tooltip(i,e,f.searchButton))),f.menu&&(d.addClass("red-ui-tabs-menu"),i=(o=$('<div class="red-ui-tab-button red-ui-tabs-menu"><a href="#"><i class="fa fa-caret-down"></i></a></div>').appendTo(d)).find("a"),n=!1,i.on("click",function(e){if(e.stopPropagation(),e.preventDefault(),n)return t.remove(),void(n=!1);n=!0;e=[],"function"==typeof f.searchButton?e=f.menu():Array.isArray(f.menu)?e=f.menu:"function"==typeof f.menu&&(e=f.menu()),(t=RED.menu.init({options:e})).attr("id",f.id+"-menu"),t.css({position:"absolute"}),t.appendTo("body"),e=o.offset();t.css({top:e.top+o.height()-2+"px",left:e.left-t.width()+o.width()+"px"}),$(".red-ui-menu.red-ui-menu-dropdown").hide(),$(document).on("click.red-ui-tabmenu",function(e){$(document).off("click.red-ui-tabmenu"),n=!1,t.remove()}),t.show()})),f.scrollable&&(d.addClass("red-ui-tabs-scrollable"),v.addClass("red-ui-tabs-scroll-container"),v.on("scroll",function(e){k()}),v.on("wheel",function(e){var t;0===e.originalEvent.deltaX&&(e.preventDefault(),t=v.scrollLeft(),t-=e.originalEvent.deltaY,v.scrollLeft(t))}),(a=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(d).find("a")).on("mousedown",function(e){u(e,e.shiftKey?"-="+v.scrollLeft():"-=150")}).on("click",function(e){e.preventDefault()}),(r=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(d).find("a")).on("mousedown",function(e){u(e,e.shiftKey?"+="+(v[0].scrollWidth-v.width()-v.scrollLeft()):"+=150")}).on("click",function(e){e.preventDefault()})),f.collapsible&&(d.addClass("red-ui-tabs-collapsible"),g=$('<div class="red-ui-tab-link-buttons"></div>').appendTo(d),!1!==f.menu&&((s=$('<a href="#"><i class="fa fa-caret-down"></i></a>').appendTo(g)).addClass("red-ui-tab-link-button-menu"),s.on("click",function(e){e.stopPropagation(),e.preventDefault(),h||(i=[],b.children().each(function(e,t){var o=$(t).data("tabId"),t={id:"red-ui-tabs-menu-option-"+o,icon:m[o].iconClass||N,label:m[o].name,onselect:function(){y(o)}};i.push(t)}),i=[].concat(i),(h=RED.menu.init({options:i})).css({position:"absolute"}),h.appendTo("body"));var i,e=s.offset();h.css({top:e.top+s.height()-2+"px",left:e.left-h.width()+s.width()+"px"}),h.is(":visible")?$(document).off("click.red-ui-tabmenu"):($(".red-ui-menu.red-ui-menu-dropdown").hide(),$(document).on("click.red-ui-tabmenu",function(e){$(document).off("click.red-ui-tabmenu"),h.hide()})),h.toggle()}))),b.children().first().addClass("active"),b.children().addClass("red-ui-tab"),b.find("li.red-ui-tab a").on("mousedown",function(e){E=e.currentTarget}).on("mouseup",_).on("click",function(e){e.preventDefault()}).on("dblclick",function(e){e.stopPropagation(),e.preventDefault()}),setTimeout(function(){w()},0);var S={addTab:function(t,e){!f.onselect||0<(i=b.find("li.red-ui-tab.selected")).length&&(i.removeClass("selected"),x()),m[t.id]=t;var o=$("<li/>",{class:"red-ui-tab"}),i=(0===(e=0===b.children().length?void 0:e)?o.prependTo(b):0<e?o.insertAfter(b.find("li:nth-child("+e+")")):o.appendTo(b),o.attr("id","red-ui-tab-"+t.id.replace(".","-")),o.data("tabId",t.id),(f.maximumTabWidth||t.maximumTabWidth)&&o.css("maxWidth",(f.maximumTabWidth||t.maximumTabWidth)+"px"),$("<a/>",{href:"#"+t.id,class:"red-ui-tab-label"}).appendTo(o));t.icon?$('<img src="'+t.icon+'" class="red-ui-tab-icon"/>').appendTo(i):t.iconClass&&$("<i>",{class:"red-ui-tab-icon "+t.iconClass}).appendTo(i);$("<span/>",{class:"red-ui-text-bidi-aware"}).text(t.label).appendTo(i).attr("dir",RED.text.bidi.resolveBaseTextDir(t.label)),f.collapsible&&(o.addClass("red-ui-tab-pinned"),n=$('<a href="#'+t.id+'" class="red-ui-tab-link-button"></a>'),t.pinned?0===D?n.prependTo(g):n.insertAfter(g.find("a.red-ui-tab-link-button-pinned:last")):!1!==f.menu?n.insertBefore(g.find("a:last")):n.appendTo(g),n.attr("id",o.attr("id")+"-link-button"),(t.iconClass?$("<i>",{class:t.iconClass}):$("<i>",{class:N})).appendTo(n),n.on("click",function(e){e.preventDefault(),y(t.id)}),n.data("tabId",t.id),t.pinned&&(n.addClass("red-ui-tab-link-button-pinned"),D++),RED.popover.tooltip($(n),t.name,t.action),f.onreorder&&(r=[],n.draggable({distance:10,axis:"x",containment:".red-ui-tab-link-buttons",start:function(e,t){if(I=!0,$(".red-ui-tab-link-buttons").width($(".red-ui-tab-link-buttons").width()),P)return P=!1;g.children().each(function(e){r[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width(),menu:$(this).hasClass("red-ui-tab-link-button-menu")},$(this).is(n)&&(c=a=e)}),g.children().each(function(e){e!==a&&$(this).css({position:"absolute",left:r[e].left+"px",width:r[e].width+2,transition:"left 0.3s"})}),n.hasClass("active")||n.css({zIndex:1})},drag:function(e,t){t.position.left+=r[a].left;for(var o=t.position.left+r[a].width/2,i=0;i<r.length;i++)if(i!==a&&!r[i].menu&&!r[i].el.is(":not(:visible)")&&o>r[i].left&&o<r[i].left+r[i].width){i<a?(r[i].left+=r[a].width+8,r[a].el.detach().insertBefore(r[i].el)):(r[i].left-=r[a].width+8,r[a].el.detach().insertAfter(r[i].el)),r[i].el.css({left:r[i].left+"px"}),r.splice(i,0,r.splice(a,1)[0]),a=i;break}},stop:function(e,t){var o;I=!1,g.children().css({position:"relative",left:"",transition:""}),$(".red-ui-tab-link-buttons").width("auto"),n.css({zIndex:""}),w(),c!==a&&(h&&(h.remove(),h=null),o=$.makeArray(g.children().map(function(){return $(this).data("tabId")})),S.order(o),f.onreorder(o))}}))),i.on("mousedown",function(e){E=e.currentTarget}),i.on("mouseup",_),i.on("click",function(e){e.preventDefault()}),i.on("dblclick",function(e){e.stopPropagation(),e.preventDefault()}),$('<span class="red-ui-tabs-fade"></span>').appendTo(o),t.closeable&&(o.addClass("red-ui-tabs-closeable"),(s=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(o)).append('<i class="fa fa-times" />'),s.on("click",function(e){e.preventDefault(),T(t.id)}),RED.popover.tooltip(s,RED._("workspace.hideFlow"))),t.hideable&&(o.addClass("red-ui-tabs-closeable"),(s=$("<a/>",{href:"#",class:"red-ui-tab-close red-ui-tab-hide"}).appendTo(o)).append('<i class="fa fa-eye" />'),s.append('<i class="fa fa-eye-slash" />'),s.on("click",function(e){e.preventDefault(),L(t.id)}),RED.popover.tooltip(s,RED._("workspace.hideFlow")));var n,a,r,c,s,u,d,l,p,e=$('<span class="red-ui-tabs-badges"></span>').appendTo(o);f.onselect&&($('<i class="red-ui-tabs-badge-changed fa fa-circle"></i>').appendTo(e),$('<i class="red-ui-tabs-badge-selected fa fa-check-circle"></i>').appendTo(e)),RED.popover.tooltip(i,function(){return t.label}),f.onadd&&f.onadd(t),1==b.find("li.red-ui-tab").length&&y(i),f.onreorder&&!f.collapsible&&(l=[],o.draggable({axis:"x",distance:20,start:function(e,t){if(P)return P=!1;I=!0,u=[],l=[],b.children().each(function(e){l[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(o)&&(p=d=e),u.push($(this).data("tabId"))}),b.children().each(function(e){e!==d&&$(this).css({position:"absolute",left:l[e].left+"px",width:l[e].width+2,transition:"left 0.3s"})}),o.hasClass("active")||o.css({zIndex:1})},drag:function(e,t){t.position.left+=l[d].left+v.scrollLeft();for(var o=t.position.left+l[d].width/2-v.scrollLeft(),i=0;i<l.length;i++)if(i!==d&&o>l[i].left&&o<l[i].left+l[i].width){i<d?(l[i].left+=l[d].width+8,l[d].el.detach().insertBefore(l[i].el)):(l[i].left-=l[d].width+8,l[d].el.detach().insertAfter(l[i].el)),l[i].el.css({left:l[i].left+"px"}),l.splice(i,0,l.splice(d,1)[0]),d=i;break}},stop:function(e,t){I=!1,b.children().css({position:"relative",left:"",transition:""}),o.hasClass("active")||o.css({zIndex:""}),w(),p!==d&&f.onreorder(u,$.makeArray(b.children().map(function(){return $(this).data("tabId")}))),y(l[d].el.data("tabId"))}})),setTimeout(function(){w()},10),h&&(h.remove(),h=null),R&&S.order(R)},removeTab:T,activateTab:y,nextTab:function(){var e=j();0<e.length&&y(e.find("a"))},previousTab:function(){var e=C();0<e.length&&y(e.find("a"))},resize:w,count:function(){return b.find("li.red-ui-tab:not(.hide)").length},activeIndex:function(){return b.find("li.active").index()},contains:function(e){return 0<b.find("a[href='#"+e+"']").length},showTab:function(e){var t;!m[e]||(t=b.find("a[href='#"+e+"']").parent()).hasClass("hide-tab")&&(t.removeClass("hide-tab").removeClass("hide"),1===b.find("li.red-ui-tab:not(.hide-tab)").length&&y(t.find("a")),w(),f.onshow&&f.onshow(m[e]))},hideTab:L,renameTab:function(e,t){m[e].label=t,b.find("a[href='#"+e+"']").find("span.red-ui-text-bidi-aware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),w()},listTabs:function(){return $.makeArray(b.children().map(function(){return $(this).data("tabId")}))},selection:p,clearSelection:function(){var e;!f.onselect||0<(e=b.find("li.red-ui-tab.selected")).length&&(e.removeClass("selected"),x())},order:function(e){R=e;for(var t=$.makeArray(b.children().map(function(){return $(this).data("tabId")})),o=!0,i=0;i<e.length;i++)if(e[i]!==t[i]){o=!1;break}if(!o){var n={},a=(b.children().detach().each(function(){n[$(this).data("tabId")]=$(this)}),{});for(f.collapsible&&g.children().detach().each(function(){var e=$(this).data("tabId");a[e=e||"__menu__"]=$(this)}),i=0;i<e.length;i++)n[e[i]]&&(n[e[i]].appendTo(b),f.collapsible&&a[e[i]].appendTo(g),delete n[e[i]]);for(i in n)n.hasOwnProperty(i)&&(n[i].appendTo(b),f.collapsible&&a[i].appendTo(g));f.collapsible&&(a.__menu__.appendTo(g),w())}}};return S}}}(),RED.stack={create:function(i){function n(){var t,e;0<s.length&&(t=0,s.forEach(function(e){t+=e.header.outerHeight()}),e=a.innerHeight(),r=e-t-(s.length-1),s.forEach(function(e){e.contentWrap.height(r)}))}var a=i.container,r=(a.addClass("red-ui-stack"),0),s=[],d=!0;return i.fill&&i.singleExpanded&&($(window).on("resize",n),$(window).on("focus",n)),{add:function(t){s.push(t),t.container=$('<div class="red-ui-palette-category">').appendTo(a),d||t.container.hide();var e,o=$('<div class="red-ui-palette-header"></div>').appendTo(t.container);return t.header=o,t.contentWrap=$("<div></div>",{style:"position:relative"}).appendTo(t.container),i.fill&&t.contentWrap.css("height",r),t.content=$("<div></div>").appendTo(t.contentWrap),!1!==t.collapsible?(o.on("click",function(){if(i.singleExpanded)if(t.isExpanded())2===s.length&&(s[0]===t?(s[0].collapse(),s[1].expand()):(s[1].collapse(),s[0].expand()));else{for(var e=0;e<s.length;e++)s[e].isExpanded()&&s[e].collapse();t.expand()}else t.toggle()}),e=$('<i class="fa fa-angle-down"></i>').appendTo(o),t.expanded?(t.container.addClass("expanded"),e.addClass("expanded")):t.contentWrap.hide()):($('<i style="opacity: 0.5;" class="fa fa-angle-down expanded"></i>').appendTo(o),o.css("cursor","default")),t.title=$("<span></span>").html(t.title).appendTo(o),t.toggle=function(){return t.isExpanded()?(t.collapse(),!1):(t.expand(),!0)},t.expand=function(){if(!t.isExpanded())return t.onexpand&&t.onexpand.call(t),i.singleExpanded&&s.forEach(function(e){e!==t&&e.collapse()}),e.addClass("expanded"),t.container.addClass("expanded"),t.contentWrap.slideDown(200),!0},t.collapse=function(){if(t.isExpanded())return e.removeClass("expanded"),t.container.removeClass("expanded"),t.contentWrap.slideUp(200),!0},t.isExpanded=function(){return t.container.hasClass("expanded")},i.fill&&i.singleExpanded&&n(),t},hide:function(){return d=!1,s.forEach(function(e){e.container.hide()}),this},show:function(){return d=!0,s.forEach(function(e){e.container.show()}),this},resize:function(){n()}}}},function(l){function e(e,t){return{option:(e=RED.utils.parseContextKey(e,t&&t.value)).store,value:e.key}}function t(e,t){return t&&(t="string"==typeof t?t:t.value)!==RED.settings.context.default?"#:("+t+")::"+e:e}function o(e,t){e.css("pointer-events","none"),e.css("flex-grow",0),e.css("position","relative"),e.css("overflow","visible"),l("<div></div>").text(t).css({position:"absolute",bottom:"-2px",right:"5px","font-size":"0.7em",opacity:.3}).appendTo(e),this.elementDiv.show()}function s(e){return e=/^red\/images\/typedInput\/.+\.png$/.test(e)?e.replace(/.png$/,".svg"):e}var i,r={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression,autoComplete:(i=[{value:"payload"},{value:"req",source:["http in"]},{value:"req.body",source:["http in"]},{value:"req.headers",source:["http in"]},{value:"req.query",source:["http in"]},{value:"req.params",source:["http in"]},{value:"req.cookies",source:["http in"]},{value:"req.files",source:["http in"]},{value:"complete",source:["join"]},{value:"contentType",source:["mqtt"]},{value:"cookies",source:["http in","http request"]},{value:"correlationData",source:["mqtt"]},{value:"delay",source:["delay","trigger"]},{value:"encoding",source:["file"]},{value:"error",source:["catch"]},{value:"filename",source:["file","file in"]},{value:"flush",source:["delay"]},{value:"followRedirects",source:["http request"]},{value:"headers",source:["http in"," http request"]},{value:"kill",source:["exec"]},{value:"messageExpiryInterval",source:["mqtt"]},{value:"method",source:["http-request"]},{value:"options",source:["xml"]},{value:"parts",source:["split","join"]},{value:"pid",source:["exec"]},{value:"qos",source:["mqtt"]},{value:"rate",source:["delay"]},{value:"rejectUnauthorized",source:["http request"]},{value:"requestTimeout",source:["http request"]},{value:"reset",source:["delay","trigger","join","rbe"]},{value:"responseTopic",source:["mqtt"]},{value:"restartTimeout",source:["join"]},{value:"retain",source:["mqtt"]},{value:"select",source:["html"]},{value:"statusCode",source:["http in"]},{value:"template",source:["template"]},{value:"toFront",source:["delay"]},{value:"topic",source:["inject","mqtt","rbe"]},{value:"url",source:["http request"]},{value:"userProperties",source:["mqtt"]}],function(s){var d=[];return i.forEach(e=>{let t=e.value;var o,i,n,a,r=t.toLowerCase().indexOf(s.toLowerCase());-1<r&&(a=t.substring(0,r),o=t.substring(r,r+s.length),i=t.substring(r+s.length),n=l("<div/>",{style:"white-space:nowrap; overflow: hidden; flex-grow:1"}),l("<span/>").text(a).appendTo(n),l("<span/>",{style:"font-weight: bold"}).text(o).appendTo(n),l("<span/>").text(i).appendTo(n),a=l("<div>",{style:"display: flex"}),n.appendTo(a),e.source&&l("<div>").css({"font-size":"0.8em"}).text(e.source.join(",")).appendTo(a),d.push({value:t,label:a,i:r}))}),d.sort(function(e,t){return e.i-t.i}),d})},flow:{value:"flow",label:"flow.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:e,export:t,valueLabel:o},global:{value:"global",label:"global.",hasValue:!0,options:[],validate:RED.utils.validatePropertyExpression,parse:e,export:t,valueLabel:o},str:{value:"str",label:"string",icon:"red/images/typedInput/az.svg"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.svg",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.svg",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.svg",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var o=this,e=this.value();try{e=JSON.stringify(JSON.parse(e),null,4)}catch(e){}RED.editor.editJSON({value:e,complete:function(e){var t=e;try{t=JSON.stringify(JSON.parse(e))}catch(e){}o.value(t)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.svg"},date:{value:"date",label:"timestamp",icon:"fa fa-clock-o",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.svg",validate:function(e){try{return jsonata(e),!0}catch(e){return!1}},expand:function(){var t=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),complete:function(e){t.value(e.replace(/\n/g,"\t"))}})}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.svg",expand:function(){var t=this;RED.editor.editBuffer({value:this.value(),complete:function(e){t.value(e)}})}},env:{value:"env",label:"env variable",icon:"red/images/typedInput/env.svg"},node:{value:"node",label:"node",icon:"red/images/typedInput/target.svg",valueLabel:function(e,t){var o,i,t=RED.nodes.node(t),n=l("<div>",{class:"red-ui-search-result-node"}).css({"margin-top":"2px","margin-left":"3px"}).appendTo(e),e=l("<span>").css({"line-height":"32px","margin-left":"6px"}).appendTo(e);t?(o=RED.utils.getNodeColor(t.type,t._def),i=RED.utils.getNodeIcon(t._def,t),"tab"===t.type&&(o="#C0DEED"),n.css("backgroundColor",o),o=l("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(n),RED.utils.createIconElement(i,o,!0),i=RED.utils.getNodeLabel(t,t.id),e.text(i)):n.css({backgroundColor:"#eee","border-style":"dashed"})},expand:function(){var t=this;RED.tray.hide(),RED.view.selectNodes({single:!0,selected:[t.value()],onselect:function(e){t.value(e.id),RED.tray.show()},oncancel:function(){RED.tray.show()}})}},cred:{value:"cred",label:"credential",icon:"fa fa-lock",inputType:"password",valueLabel:function(t,e){var o,i,n,a=this,r=(t.css("pointer-events","none"),t.css("flex-grow",0),this.elementDiv.hide(),l("<div>").css({position:"absolute",right:"6px",top:"6px","pointer-events":"all"}).appendTo(t)),s=l('<button type="button" class="red-ui-button red-ui-button-small"></button>').css({width:"20px"}).appendTo(r).on("click",function(e){e.preventDefault();var t=a.input[0].selectionStart;"text"===a.input.attr("type")?(a.input.attr("type","password"),d.removeClass("fa-eye-slash").addClass("fa-eye")):(a.input.attr("type","text"),d.removeClass("fa-eye").addClass("fa-eye-slash")),setTimeout(function(){a.input.focus(),a.input[0].setSelectionRange(t,t)},50)}).hide(),d=l('<i class="fa fa-eye"></i>').css("margin-left","-2px").appendTo(s);"__PWRD__"===e?(o=l('<div><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i><i class="fa fa-asterisk"></i></div>').css({padding:"6px 6px",borderRadius:"4px"}).addClass("red-ui-typedInput-value-label-inactive").appendTo(t),i=l('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-pencil"></i></button>').appendTo(r).on("click",function(e){e.preventDefault(),o.hide(),t.css("background","none"),t.css("pointer-events","none"),a.input.val(""),a.element.val(""),a.elementDiv.show(),i.hide(),n.show(),s.show(),setTimeout(function(){a.input.focus()},50)}),n=l('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-times"></i></button>').css("margin-left","3px").appendTo(r).on("click",function(e){e.preventDefault(),o.show(),t.css("background",""),a.input.val("__PWRD__"),a.element.val("__PWRD__"),a.elementDiv.hide(),i.show(),n.hide(),s.hide(),a.input.attr("type","password"),d.removeClass("fa-eye-slash").addClass("fa-eye")}).hide()):(t.css("background","none"),t.css("pointer-events","none"),this.elementDiv.show(),s.show())}}};function d(e,t){if(e.multiple){var o={},i=[];t.split(",").forEach(function(e){e&&(o[e]=!0)});for(a=0;a<e.options.length;a++){var n="string"==typeof(op=e.options[a])?op:op.value;o.hasOwnProperty(n)&&(delete o[n],i.push("string"==typeof op?{value:op}:op.value))}return l.isEmptyObject(o)?i:null}for(var a=0;a<e.options.length;a++){if("string"==typeof(op=e.options[a])&&op===t)return{value:t};if(op.value===t)return op}}var c=!1;l.widget("nodered.typedInput",{_create:function(){try{if(!c&&RED&&RED._){for(var e in r)r.hasOwnProperty(e)&&(r[e].label=RED._("typedInput.type."+e,{defaultValue:r[e].label}));var t=RED.settings.context.stores.map(function(e){return{value:e,label:e,icon:'<i class="red-ui-typedInput-icon fa fa-database"></i>'}}).sort(function(e,t){return e.value===RED.settings.context.default?-1:t.value===RED.settings.context.default?1:e.value.localeCompare(t.value)});t.length<2?(r.flow.options=[],r.global.options=[]):(r.flow.options=t,r.global.options=t)}c=!0;var o,i,n=this,a=(this.identifier=this.element.attr("id")||"TypedInput-"+Math.floor(100*Math.random()),this.options.debug&&console.log(this.identifier,"Create",{defaultType:this.options.default,value:this.element.val()}),this.disarmClick=!1,this.input=l('<input class="red-ui-typedInput-input" type="text"></input>'),this.input.insertAfter(this.element),this.input.val(this.element.val()),this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.input.wrap("<div>").parent().addClass("red-ui-typedInput-input-wrap"),this.uiSelect=this.elementDiv.wrap("<div>").parent(),this.element.attr("style"));null!==(o=/width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(a))?(this.input.css("width","100%"),this.uiSelect.width(o[1]),this.uiWidth=null):0!==this.uiWidth&&this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(e){var t=n.element.css("margin"+e);n.uiSelect.css("margin"+e,t),n.input.css("margin"+e,0)}),["type","placeholder","autocomplete","data-i18n"].forEach(function(e){var t=n.element.attr(e);n.input.attr(e,t)}),this.defaultInputType=this.input.attr("type"),this.oldValues={},this.uiSelect.addClass("red-ui-typedInput-container"),this.element.attr("type","hidden"),!this.options.types&&this.options.type?this.options.types=[this.options.type]:this.options.types=this.options.types||Object.keys(r),this.selectTrigger=l('<button class="red-ui-typedInput-type-select" tabindex="0"></button>').prependTo(this.uiSelect),l('<i class="red-ui-typedInput-icon fa fa-caret-down"></i>').toggle(1<this.options.types.length).appendTo(this.selectTrigger),this.selectLabel=l('<span class="red-ui-typedInput-type-label"></span>').appendTo(this.selectTrigger),this.valueLabelContainer=l('<div class="red-ui-typedInput-value-label">').appendTo(this.uiSelect),this.types(this.options.types),this.options.typeField?(this.typeField=l(this.options.typeField).hide(),(i=this.typeField.val())&&this.typeMap[i]&&(this.options.default=i)):this.typeField=l("<input>",{type:"hidden"}).appendTo(this.uiSelect),this.input.on("focus",function(){n.uiSelect.addClass("red-ui-typedInput-focus")}),this.input.on("blur",function(){n.uiSelect.removeClass("red-ui-typedInput-focus")}),this.input.on("change",function(){n.validate(),n.element.val(n.value()),n.element.trigger("change",[n.propertyType,n.value()])}),this.input.on("keyup",function(e){n.validate(),n.element.val(n.value()),n.element.trigger("keyup",e)}),this.input.on("paste",function(e){n.validate(),n.element.val(n.value()),n.element.trigger("paste",e)}),this.input.on("keydown",function(e){n.typeMap[n.propertyType].autoComplete||37<=e.keyCode&&e.keyCode<=40&&e.stopPropagation()}),this.selectTrigger.on("click",function(e){e.preventDefault(),e.stopPropagation(),n._showTypeMenu()}),this.selectTrigger.on("keydown",function(e){40===e.keyCode&&n._showTypeMenu(),e.stopPropagation()}).on("focus",function(){n.uiSelect.addClass("red-ui-typedInput-focus")}).on("blur",function(){!1===n.typeMap[n.propertyType].hasValue&&n.uiSelect.removeClass("red-ui-typedInput-focus")}),this.optionSelectTrigger=l('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="red-ui-typedInput-icon fa fa-caret-down"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=l('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),this.optionSelectTrigger.on("click",function(e){e.preventDefault(),e.stopPropagation(),n._showOptionSelectMenu()}).on("keydown",function(e){40===e.keyCode&&n._showOptionSelectMenu(),e.stopPropagation()}).on("blur",function(){n.uiSelect.removeClass("red-ui-typedInput-focus")}).on("focus",function(){n.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionExpandButton=l('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"></button>').appendTo(this.uiSelect),this.optionExpandButtonIcon=l('<i class="red-ui-typedInput-icon fa fa-ellipsis-h"></i>').appendTo(this.optionExpandButton),this.type(this.typeField.val()||this.options.default||this.typeList[0].value),this.typeChanged=!!this.options.default}catch(e){console.log(e.stack)}},_showTypeMenu:function(){var e;1<this.typeList.length?(this._showMenu(this.menu,this.selectTrigger),e=this.menu.find("[value='"+this.propertyType+"']"),setTimeout(function(){e.trigger("focus")},120)):this.input.trigger("focus")},_showOptionSelectMenu:function(){var e;this.optionMenu&&(this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectTrigger),e=this.optionValue,null!==this.optionValue&&void 0!==this.optionValue||(e=this.value()),(e=0===(e=this.optionMenu.find("[value='"+e+"']")).length?this.optionMenu.children(":first"):e).trigger("focus"))},_hideMenu:function(e){var t;l(document).off("mousedown.red-ui-typedInput-close-property-select"),e.hide(),e.css({height:"auto"}),e.opts.multiple&&(t=[],e.find('input[type="checkbox"]').each(function(){l(this).prop("checked")&&t.push(l(this).data("value"))}),e.callback(t)),(this.elementDiv.is(":visible")?this.input:this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger:this.selectTrigger).trigger("focus")},_createMenu:function(e,i,n){var a=this,r=l("<div>").addClass("red-ui-typedInput-options red-ui-editor-dialog");return r.opts=i,r.callback=n,e.forEach(function(t){"string"==typeof t&&(t={value:t,label:t});var o,e=l('<a href="#"></a>').attr("value",t.value).appendTo(r);t.label&&e.text(t.label),t.title&&e.prop("title",t.title),t.icon?(0===t.icon.indexOf("<")?l(t.icon):-1!==t.icon.indexOf("/")?l("<img>",{src:s(t.icon),style:"margin-right: 4px; height: 18px;"}):l("<i>",{class:"red-ui-typedInput-icon "+t.icon})).prependTo(e):e.css({paddingLeft:"18px"}),t.icon||t.label||e.text(t.value),i.multiple&&(o=l('<input type="checkbox">').css("pointer-events","none").data("value",t.value).prependTo(e).on("mousedown",function(e){e.preventDefault()})),e.on("click",function(e){e.preventDefault(),e.stopPropagation(),i.multiple?o.prop("checked",!o.prop("checked")):(n(t.value),a._hideMenu(r))})}),r.css({display:"none"}),r.appendTo(document.body),r.on("keydown",function(e){40===e.keyCode?(e.preventDefault(),l(this).children(":focus").next().trigger("focus")):38===e.keyCode?(e.preventDefault(),l(this).children(":focus").prev().trigger("focus")):27===e.keyCode&&(e.preventDefault(),a._hideMenu(r)),e.stopPropagation()}),r},_showMenu:function(t,o){var i,n,e,a,r;this.disarmClick?this.disarmClick=!1:(t.opts.multiple&&(i={},this.value().split(",").forEach(function(e){i[e]=!0}),t.find('input[type="checkbox"]').each(function(){l(this).prop("checked",i[l(this).data("value")])})),n=this,e=o.offset(),r=o.height(),a=t.height(),(r=r+e.top)+a-l(document).scrollTop()>l(window).height()&&(r-=r+a-l(window).height()+5),r<0&&(t.height(a+r),r=0),t.css({top:r+"px",left:e.left+"px"}),t.slideDown(100),this._delay(function(){n.uiSelect.addClass("red-ui-typedInput-focus"),l(document).on("mousedown.red-ui-typedInput-close-property-select",function(e){l(e.target).closest(t).length||n._hideMenu(t),l(e.target).closest(o).length&&(n.disarmClick=!0,e.preventDefault())})}))},_getLabelWidth:function(e,t){var o,i,n,a=e.outerWidth();0===a?(o=l('<div class="red-ui-editor"></div>').css({position:"absolute","white-space":"nowrap",top:-2e3}).appendTo(document.body),i=l('<div class="red-ui-typedInput-container"></div>').appendTo(o),n=e.clone().appendTo(i),setTimeout(function(){a=n.outerWidth(),o.remove(),t(a)},50)):t(a)},_updateOptionSelectLabel:function(e){var t=this.typeMap[this.propertyType];this.optionSelectLabel.empty(),t.hasValue?(this.valueLabelContainer.empty(),this.valueLabelContainer.show()):this.valueLabelContainer.hide(),this.typeMap[this.propertyType].valueLabel&&(t.multiple?this.typeMap[this.propertyType].valueLabel.call(this,t.hasValue?this.valueLabelContainer:this.optionSelectLabel,e):this.typeMap[this.propertyType].valueLabel.call(this,t.hasValue?this.valueLabelContainer:this.optionSelectLabel,e.value)),this.typeMap[this.propertyType].valueLabel&&!t.hasValue||(t.multiple?this.optionSelectLabel.text(e.length+" selected"):(e.icon?(0===e.icon.indexOf("<")?l(e.icon):-1!==e.icon.indexOf("/")?l("<img>",{src:s(e.icon),style:"height: 18px;"}):l("<i>",{class:"red-ui-typedInput-icon "+e.icon})).prependTo(this.optionSelectLabel):e.label?this.optionSelectLabel.text(e.label):this.optionSelectLabel.text(e.value),t.hasValue&&(this.optionValue=e.value,this.input.trigger("change",[this.propertyType,this.value()]))))},_destroy:function(){this.optionMenu&&this.optionMenu.remove(),this.menu.remove(),this.uiSelect.remove()},types:function(e){var t=this,o=this.type(),i=(this.typeMap={},void 0===this.typeList);this.typeList=e.map(function(e){e="string"==typeof e?r[e]:e;return t.typeMap[e.value]=e}),this.typeList.length<2?(this.selectTrigger.attr("tabindex",-1),this.selectTrigger.on("mousedown.red-ui-typedInput-focus-block",function(e){e.preventDefault()})):(this.selectTrigger.attr("tabindex",0),this.selectTrigger.off("mousedown.red-ui-typedInput-focus-block")),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.selectTrigger.find(".fa-caret-down").toggle(1<this.typeList.length),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,{},function(e){t.type(e)}),o&&!this.typeMap.hasOwnProperty(o)?i||this.type(this.typeList[0].value):(this.propertyType=null,i||this.type(o)),1!==this.typeList.length||this.typeList[0].icon||this.typeList[0].label&&!1!==this.typeList[0].showLabel?this.selectTrigger.show():this.selectTrigger.hide()},width:function(e){this.uiWidth=e,null!==this.uiWidth&&this.uiSelect.width(this.uiWidth)},value:function(e){var i,t,o,n=this,a=this.typeMap[this.propertyType]||{};if(!arguments.length)return o=this.input.val(),a.export?a.export(o,this.optionValue):o;this.options.debug&&console.log(this.identifier,"----- SET VALUE ------",e),i=[],o=e,a.options?(a.hasValue&&a.parse&&(t=a.parse(e),this.options.debug&&console.log(this.identifier,"new parse",t),e=t.value,o=t.option||t.value),t=[o],a.multiple&&(i=[],t=o.split(",")),t.forEach(function(e){for(var t=0;t<a.options.length;t++){var o=a.options[t];if("string"==typeof o){if(o===e||o===""+e){i.push(n.activeOptions[o]);break}}else if(o.value===e){i.push(o);break}}}),this.options.debug&&console.log(this.identifier,"set value to",e),this.input.val(e),a.multiple?this._updateOptionSelectLabel(i):(0===i.length&&(i=[{value:""}]),this._updateOptionSelectLabel(i[0]))):(this.input.val(e),a.valueLabel&&(this.valueLabelContainer.empty(),a.valueLabel.call(this,this.valueLabelContainer,e))),this.input.trigger("change",[this.type(),e])},type:function(e){if(!arguments.length)return this.propertyType;var t,o,i=this,n=(this.options.debug&&console.log(this.identifier,"----- SET TYPE -----",e),null),a=this.typeMap[e];a&&this.propertyType!==e&&(o=this.typeMap[this.propertyType],n=this.input.val(),o&&this.typeChanged&&(this.options.debug&&console.log(this.identifier,"typeChanged",{previousType:o,previousValue:n}),o.options&&!0!==a.hasValue||!1===o.hasValue?this.oldValues[o.value]=n:this.oldValues._=n,a.options&&!0!==a.hasValue||!1===a.hasValue?this.oldValues.hasOwnProperty(a.value)?(this.options.debug&&console.log(this.identifier,"restored previous (1)",this.oldValues[a.value]),this.input.val(this.oldValues[a.value])):a.options?(t=d(a,n),this.options.debug&&console.log(this.identifier,{previousValue:n,opt:a,validOptions:t}),(n||""===n)&&t?(this.options.debug&&console.log(this.identifier,"restored previous (2)"),this.input.val(n)):"string"==typeof a.default?(this.options.debug&&console.log(this.identifier,"restored previous (3)",a.default),this.input.val(a.default)):Array.isArray(a.default)?(this.options.debug&&console.log(this.identifier,"restored previous (4)",a.default.join(",")),this.input.val(a.default.join(","))):(this.options.debug&&console.log(this.identifier,"restored previous (5)"),this.input.val(""))):(this.options.debug&&console.log(this.identifier,"restored default/blank",a.default||""),this.input.val(a.default||"")):(this.options.debug&&console.log(this.identifier,"restored old/default/blank"),this.input.val(this.oldValues.hasOwnProperty("_")?this.oldValues._:a.default||"")),o.autoComplete&&this.input.autoComplete("destroy")),this.propertyType=e,this.typeChanged=!0,this.typeField&&this.typeField.val(e),this.selectLabel.empty(),a.icon&&!1!==a.showLabel&&(0===a.icon.indexOf("<")?l(a.icon).prependTo(this.selectLabel):-1!==a.icon.indexOf("/")?((t=new Image).name=a.icon,t.src=s(a.icon),l("<img>",{src:s(a.icon),style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):l("<i>",{class:"red-ui-typedInput-icon "+a.icon,style:"min-width: 13px; margin-right: 4px;"}).prependTo(this.selectLabel)),!1!==a.hasValue&&(!1===a.showLabel||a.icon)||this.selectLabel.text(a.label),a.label?this.selectTrigger.attr("title",a.label):this.selectTrigger.attr("title",""),!1===a.hasValue?this.selectTrigger.addClass("red-ui-typedInput-full-width"):this.selectTrigger.removeClass("red-ui-typedInput-full-width"),this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),a.options?(this.optionExpandButton&&(this.optionExpandButton.hide(),this.optionExpandButton.shown=!1),this.optionSelectTrigger&&(this.optionSelectTrigger.css({display:"inline-flex"}),a.hasValue?(this.optionSelectTrigger.css({"flex-grow":0}),this.elementDiv.show()):(this.optionSelectTrigger.css({"flex-grow":1}),this.elementDiv.hide()),this.valueLabelContainer.hide(),this.activeOptions={},a.options.forEach(function(e){"string"==typeof e?i.activeOptions[e]={label:e,value:e}:i.activeOptions[e.value]=e}),i.activeOptions.hasOwnProperty(i.optionValue)||(i.optionValue=null),a.hasValue?(n=this.optionValue||a.options[0],a.parse&&(o="string"==typeof n?{value:n}:n,(t=a.parse(this.input.val(),o)).option&&(n=t.option,this.activeOptions.hasOwnProperty(n)||(t.option=Object.keys(this.activeOptions)[0],n=t.option)),this.input.val(t.value),a.export&&this.element.val(a.export(t.value,t.option||n))),"string"==typeof n?(this.optionValue=n,(n=this.activeOptions.hasOwnProperty(n)?n:Object.keys(this.activeOptions)[0])?this._updateOptionSelectLabel(this.activeOptions[n]):this.optionSelectTrigger.hide()):n?(this.options.debug&&console.log(this.identifier,"HERE",{optionValue:n.value}),this.optionValue=n.value,this._updateOptionSelectLabel(n)):this.optionSelectTrigger.hide()):(o=d(a,this.input.val()),a.multiple?(o||(o=(a.default||[]).map(function(e){return"string"==typeof e?e:e.value}),this.value(o.join(","))),i._updateOptionSelectLabel(o)):o?i._updateOptionSelectLabel(o):"string"==typeof(t=a.options[0])?(this.value(t),i._updateOptionSelectLabel({value:t})):(this.value(t.value),i._updateOptionSelectLabel(t))),this.optionMenu=this._createMenu(a.options,a,function(e){a.multiple?(i._updateOptionSelectLabel(e),a.hasValue||i.value(e.join(","))):(i._updateOptionSelectLabel(i.activeOptions[e]),a.hasValue||i.value(i.activeOptions[e].value))}))):(this.optionSelectTrigger&&this.optionSelectTrigger.hide(),a.inputType?this.input.attr("type",a.inputType):this.input.attr("type",this.defaultInputType),!1===a.hasValue?(this.elementDiv.hide(),this.valueLabelContainer.hide()):a.valueLabel?(this.valueLabelContainer.css("pointer-events",""),this.valueLabelContainer.css("flex-grow",1),this.valueLabelContainer.css("overflow","hidden"),this.valueLabelContainer.show(),this.valueLabelContainer.empty(),this.elementDiv.hide(),a.valueLabel.call(this,this.valueLabelContainer,this.input.val())):(this.valueLabelContainer.hide(),this.elementDiv.show(),a.autoComplete&&this.input.autoComplete({search:a.autoComplete})),this.optionExpandButton&&(a.expand?(a.expand.icon?this.optionExpandButtonIcon.removeClass().addClass("red-ui-typedInput-icon fa "+a.expand.icon):this.optionExpandButtonIcon.removeClass().addClass("red-ui-typedInput-icon fa fa-ellipsis-h"),this.optionExpandButton.shown=!0,this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",function(e){var t;e.preventDefault(),"function"==typeof a.expand?a.expand.call(i):(e=l("<div>"),t=a.expand.content.call(i,e),(e=RED.popover.panel(e)).container.css({width:i.valueLabelContainer.width()}),a.expand.minWidth&&e.container.css({minWidth:a.expand.minWidth+"px"}),e.show({target:i.optionExpandButton,onclose:t.onclose,align:"left"}))})):(this.optionExpandButton.shown=!1,this.optionExpandButton.hide()))),this._trigger("typechange",null,this.propertyType),this.input.trigger("change",[this.propertyType,this.value()]))},validate:function(){var e=this.value(),t=this.type();return(t=!this.typeMap[t]||!this.typeMap[t].validate||("function"==typeof(t=this.typeMap[t].validate)?t(e):t.test(e)))?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),t},show:function(){this.uiSelect.show()},hide:function(){this.uiSelect.hide()},disable:function(e){void 0===e||e?this.uiSelect.attr("disabled","disabled"):this.uiSelect.attr("disabled",null)},enable:function(){this.uiSelect.attr("disabled",null)},disabled:function(){return"disabled"===this.uiSelect.attr("disabled")},focus:function(){this.input.focus()}})}(jQuery),function(s){s.widget("nodered.toggleButton",{_create:function(){var t=this,o=!1,e=(this.options.hasOwnProperty("invertState")&&(o=this.options.invertState),this.options.baseClass||"red-ui-button"),i=this.options.hasOwnProperty("enabledIcon")?this.options.enabledIcon:"fa-check-square-o",n=this.options.hasOwnProperty("disabledIcon")?this.options.disabledIcon:"fa-square-o",a=this.options.hasOwnProperty("enabledLabel")?this.options.enabledLabel:RED._("editor:workspace.enabled"),r=this.options.hasOwnProperty("disabledLabel")?this.options.disabledLabel:RED._("editor:workspace.disabled"),e=(this.element.css("display","none"),this.element.on("focus",function(){t.button.focus()}),this.button=s('<button type="button" class="red-ui-toggleButton '+e+' toggle single"></button>'),(a||r)&&(this.buttonLabel=s("<span>").appendTo(this.button).css("margin-left","5px")),this.options.class&&this.button.addClass(this.options.class),this.element.after(this.button),i&&n&&(this.buttonIcon=s('<i class="fa"></i>').prependTo(this.button)),this.button.addClass("selected"),this.buttonIcon&&this.buttonIcon.addClass(i),this.buttonLabel&&this.buttonLabel.text(a),this.button.width());this.button.removeClass("selected"),this.buttonIcon&&(this.buttonIcon.removeClass(i),t.buttonIcon.addClass(n)),this.buttonLabel&&t.buttonLabel.text(r),e=Math.max(e,this.button.width()),this.buttonIcon&&this.buttonIcon.removeClass(n),0<e&&this.button.width(Math.ceil(e)),this.button.on("click",function(e){e.stopPropagation(),t.state?t.element.prop("checked",o):t.element.prop("checked",!o),t.element.trigger("change")}),this.element.on("change",function(e){s(this).prop("checked")!==o?(t.button.addClass("selected"),t.state=!0,t.buttonIcon&&(t.buttonIcon.addClass(i),t.buttonIcon.removeClass(n)),t.buttonLabel&&t.buttonLabel.text(a)):(t.button.removeClass("selected"),t.state=!1,t.buttonIcon&&(t.buttonIcon.addClass(n),t.buttonIcon.removeClass(i)),t.buttonLabel&&t.buttonLabel.text(r))}),this.element.trigger("change")}})}(jQuery),jQuery.widget("nodered.autoComplete",{_create:function(){var o=this;this.completionMenuShown=!1,this.options.search=this.options.search||function(){return[]},this.element.addClass("red-ui-autoComplete"),this.element.on("keydown.red-ui-autoComplete",function(e){var t;13!==e.keyCode&&9!==e.keyCode||!o.completionMenuShown||(t=o.menu.options(),o.element.val(t[0].value),o.menu.hide(),e.preventDefault())}),this.element.on("keyup.red-ui-autoComplete",function(e){13!==e.keyCode&&9!==e.keyCode&&27!==e.keyCode&&(8!==e.keyCode&&46!==e.keyCode||o.completionMenuShown)&&o._updateCompletions(this.value)})},_showCompletionMenu:function(e){this.completionMenuShown||(this.menu=RED.popover.menu({tabSelect:!0,width:300,maxHeight:200,class:"red-ui-autoComplete-container",options:e,onselect:e=>{this.element.val(e.value),this.element.focus(),this.element.trigger("change")},onclose:()=>{this.completionMenuShown=!1,delete this.menu,this.element.focus()}}),this.menu.show({target:this.element}),this.completionMenuShown=!0)},_updateCompletions:function(e){var t,o=this;function i(e,t){t&&t!==o.pendingRequest||(e&&0!==e.length?o.completionMenuShown?o.menu.options(e):o._showCompletionMenu(e):o.completionMenuShown&&o.menu.hide())}""!==e.trim()?2===this.options.search.length?(t=1+Math.floor(1e4*Math.random()),this.pendingRequest=t,this.options.search(e,function(e){i(e,t)})):i(this.options.search(e)):this.completionMenuShown&&this.menu.hide()},_destroy:function(){this.element.removeClass("red-ui-autoComplete"),this.element.off("keydown.red-ui-autoComplete"),this.element.off("keyup.red-ui-autoComplete"),this.completionMenuShown&&this.menu.hide()}}),RED.actions=function(){var l={};return{add:function(e,t,o){if("function"!=typeof t)throw new Error("Action handler not a function");if(l[e])throw new Error("Cannot override existing action");l[e]={handler:t,options:o}},remove:function(e){delete l[e]},get:function(e){return l[e].handler},invoke:function(){var e=Array.prototype.slice.call(arguments),t=e.shift();l.hasOwnProperty(t)&&l[t].handler.apply(null,e)},list:function(){var s=[],d=[];return Object.keys(l).forEach(function(e){var t,o,i,n=l[e],a=RED.keyboard.getShortcut(e),r=!1,r=a?a.user:!!RED.keyboard.getUserShortcut(e);n.label||(t=e,o=(o=(o=n.options)?o.label:void 0)||"action-list."+t.replace(/^.*:/,""),(i=RED._(o))===o&&(i=t.replace(/(^.+:([a-z]))|(-([a-z]))/g,function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}),d.push(o)),n.label=i),s.push({id:e,scope:a?a.scope:void 0,key:a?a.key:void 0,user:r,label:n.label,options:n.options})}),s}}}(),RED.deploy=function(){var t={full:{img:"red/images/deploy-full-o.svg"},nodes:{img:"red/images/deploy-nodes-o.svg"},flows:{img:"red/images/deploy-flows-o.svg"}},f={unknown:!1,unusedConfig:!1,invalid:!1},h="full",g=!1,l=null;function a(e){h=e,$("#red-ui-header-button-deploy-icon").attr("src",t[e].img)}function m(e){var t="",o=(e.z&&(t=(o=RED.nodes.workspace(e.z))?o.label:(o=RED.nodes.subflow(e.z)).name),RED.utils.getNodeLabel(e,e.id));return{tab:t,type:e.type,label:o}}function E(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function b(e,t){var o=$("<div>"),i=($('<p data-i18n="deploy.confirm.conflict"></p>').appendTo(o),$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><img src="red/images/spin.svg"/><div data-i18n="deploy.confirm.conflictChecking"></div></div>').appendTo(o)),n=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><i class="fa fa-check"></i><div data-i18n="deploy.confirm.conflictAutoMerge"></div></div>').hide().appendTo(o),a=$('<div class="red-ui-deploy-dialog-confirm-conflict-row"><i class="fa fa-exclamation"></i><div data-i18n="deploy.confirm.conflictManualMerge"></div></div>').hide().appendTo(o),r=(o.i18n(),l=null,[{text:RED._("common.label.cancel"),click:function(){s.close()}},{id:"red-ui-deploy-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#red-ui-deploy-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),s.close())}},{id:"red-ui-deploy-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#red-ui-deploy-dialog-confirm-deploy-merge").hasClass("disabled")||(RED.diff.mergeDiff(l),s.close())}}]),s=(t&&r.push({id:"red-ui-deploy-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){w(!0,t),s.close()}}),RED.notify(o,{modal:!0,fixed:!0,width:600,buttons:r})),d=Date.now();RED.diff.getRemoteDiff(function(e){var t=Math.max(1e3-(Date.now()-d),0);l=e,setTimeout(function(){i.hide(),0===Object.keys(e.conflicts).length?(n.show(),$("#red-ui-deploy-dialog-confirm-deploy-merge").removeClass("disabled")):a.show(),$("#red-ui-deploy-dialog-confirm-deploy-review").removeClass("disabled")},t)})}function v(e){var t;return 5<e.length&&(t=e.length-5,(e=e.slice(0,5)).push(RED._("deploy.confirm.plusNMore",{count:t}))),e}function y(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function r(){var t=Date.now(),i=($(".red-ui-deploy-button-content").css("opacity",0),$(".red-ui-deploy-button-spinner").show(),!$("#red-ui-header-button-deploy").hasClass("disabled"));$("#red-ui-header-button-deploy").addClass("disabled"),g=!0,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$.ajax({url:"flows",type:"POST",headers:{"Node-RED-Deployment-Type":"reload"}}).done(function(e,t,o){i&&$("#red-ui-header-button-deploy").removeClass("disabled"),RED.notify("<p>"+RED._("deploy.successfulRestart")+"</p>","success")}).fail(function(e,t,o){i&&$("#red-ui-header-button-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?b(nns,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){g=!1;var e=Math.max(0,300-(Date.now()-t));setTimeout(function(){$(".red-ui-deploy-button-content").css("opacity",1),$(".red-ui-deploy-button-spinner").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide()},e)})}function w(e,c){if(!$("#red-ui-header-button-deploy").hasClass("disabled"))if(RED.user.hasPermission("flows.write")){if(!e){var t,o,i,n=!1,a=[],r=[],u=(RED.nodes.eachConfig(function(e){void 0===e.valid&&RED.editor.validateNode(e),e.valid||e.d||r.push(m(e)),"unknown"===e.type&&-1==a.indexOf(e.name)&&a.push(e.name)}),RED.nodes.eachNode(function(e){e.valid||e.d||r.push(m(e)),"unknown"===e.type&&-1==a.indexOf(e.name)&&a.push(e.name)}),e=0<a.length,t=0<r.length,[]),s=(RED.nodes.eachConfig(function(e){!1!==e._def.hasUsers&&0===e.users.length&&(u.push(m(e)),n=!0)}),!1),d=[];if(e&&!f.unknown?(s=!0,o="<p>"+RED._("deploy.confirm.unknown")+'</p><ul class="red-ui-deploy-dialog-confirm-list"><li>'+v(a).map(y).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",d=[{id:"red-ui-deploy-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){w(!0),i.close()}}]):t&&!f.invalid&&(s=!0,r.sort(E),o="<p>"+RED._("deploy.confirm.improperlyConfigured")+'</p><ul class="red-ui-deploy-dialog-confirm-list"><li>'+v(r.map(function(e){return y((e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")")})).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",d=[{id:"red-ui-deploy-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){w(!0),i.close()}}]),s)return d.unshift({text:RED._("common.label.cancel"),click:function(){i.close()}}),void(i=RED.notify(o,{modal:!0,fixed:!0,buttons:d}))}var l=RED.nodes.createCompleteNodeSet(),p=Date.now(),e=($(".red-ui-deploy-button-content").css("opacity",0),$(".red-ui-deploy-button-spinner").show(),$("#red-ui-header-button-deploy").addClass("disabled"),{flows:l});c||(e.rev=RED.nodes.version()),g=!0,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":h}}).done(function(e,t,o){RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(l),n?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p>","success"),RED.nodes.eachNode(function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials}),RED.nodes.eachConfig(function(e){e.changed=!1,e.credentials&&delete e.credentials}),RED.nodes.eachSubflow(function(e){e.changed=!1}),RED.nodes.eachWorkspace(function(e){e.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(e,t,o){RED.nodes.dirty(!0),$("#red-ui-header-button-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?b(0,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){g=!1;var e=Math.max(0,300-(Date.now()-p));setTimeout(function(){$(".red-ui-deploy-button-content").css("opacity",1),$(".red-ui-deploy-button-spinner").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide()},e)})}else RED.notify(RED._("user.errors.deploy"),"error")}return{init:function(e){var t,o,i,n=(e=e||{}).type||"default";"default"==n?($('<li><span class="red-ui-deploy-button-group button-group"><a id="red-ui-header-button-deploy" class="red-ui-deploy-button disabled" href="#"><span class="red-ui-deploy-button-content"><img id="red-ui-header-button-deploy-icon" src="red/images/deploy-full-o.svg"> <span>'+RED._("deploy.deploy")+'</span></span><span class="red-ui-deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="red-ui-header-button-deploy-options" class="red-ui-deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".red-ui-header-toolbar"),RED.menu.init({id:"red-ui-header-button-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.svg",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&a("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.svg",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&a("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.svg",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&a("nodes")}},null,{id:"deploymenu-item-reload",icon:"red/images/deploy-reload.svg",label:RED._("deploy.restartFlows"),sublabel:RED._("deploy.restartFlowsDesc"),onselect:"core:restart-flows"}]})):"simple"==n&&(t=e.label||RED._("deploy.deploy"),o="red/images/deploy-full-o.svg",e.hasOwnProperty("icon")&&(o=e.icon),$('<li><span class="red-ui-deploy-button-group button-group"><a id="red-ui-header-button-deploy" class="red-ui-deploy-button disabled" href="#"><span class="red-ui-deploy-button-content">'+(o?'<img id="red-ui-header-button-deploy-icon" src="'+o+'"> ':"")+"<span>"+t+'</span></span><span class="red-ui-deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".red-ui-header-toolbar")),$("#red-ui-header-button-deploy").on("click",function(e){e.preventDefault(),w()}),RED.actions.add("core:deploy-flows",w),"default"===n&&(RED.actions.add("core:restart-flows",r),RED.actions.add("core:set-deploy-type-to-full",function(){RED.menu.setSelected("deploymenu-item-full",!0)}),RED.actions.add("core:set-deploy-type-to-modified-flows",function(){RED.menu.setSelected("deploymenu-item-flow",!0)}),RED.actions.add("core:set-deploy-type-to-modified-nodes",function(){RED.menu.setSelected("deploymenu-item-node",!0)})),RED.events.on("workspace:dirty",function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#red-ui-header-button-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#red-ui-header-button-deploy").addClass("disabled"))}),RED.comms.subscribe("notification/runtime-deploy",function(e,t){var o;i||(null===(o=RED.nodes.version())||g||o===t.revision||(o=$("<p>").text(RED._("deploy.confirm.backgroundUpdate")),i=RED.notify(o,{modal:!0,fixed:!0,buttons:[{text:RED._("deploy.confirm.button.ignore"),click:function(){i.close(),i=null}},{text:RED._("deploy.confirm.button.review"),class:"primary",click:function(){i.close(),b(RED.nodes.createCompleteNodeSet(),!1),i=null}}]})))})},setDeployInflight:function(e){g=e}}}(),RED.diff=function(){var r=!1;function p(e,t,o){var D,i,e=$('<div class="red-ui-diff-panel"></div>').appendTo(e),l=$('<div class="red-ui-diff-panel-headers"></div>').appendTo(e),n=("merge"===o.mode&&e.addClass("red-ui-diff-panel-merge"),i=e,D=t,(i=$('<ol class="red-ui-diff-list"></ol>').appendTo(i)).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(c,u,e){var p,f,t,o,i,n=e.diff,a=e.remoteDiff,r=e.tab.n,h=e.def,g=D.conflicts,m=$("<div>",{class:"red-ui-diff-list-flow"}).appendTo(c),b=(m.addClass("collapsed"),$("<div>",{class:"red-ui-diff-list-flow-title"}).appendTo(m)),v=$("<div>").appendTo(m),s=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(b),y=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(b),d=(a&&(p=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(b)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(s),_(r,h).appendTo(s),(e.newTab||e.tab).n),s=$("<span>",{class:"red-ui-diff-list-flow-title-meta"}).appendTo(s),l=("tab"===d.type?s.text(d.label||d.id):"subflow"===r.type?s.text(d.name||d.id):s.text(RED._("diff.globalNodes")),{local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0}),w=((e.newTab||e.remoteTab)&&(d={node:n.newConfig.all[r.id],all:n.newConfig.all,diff:n},a&&(i={node:a.newConfig.all[r.id]||null,all:a.newConfig.all,diff:a}),void 0!==r.type&&(s=$("<div>",{class:"red-ui-diff-list-node red-ui-diff-list-node-props collapsed"}).appendTo(v),w=$("<div>",{class:"red-ui-diff-list-node-header"}).appendTo(s),f=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(w),t=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(w),0,n.newConfig.all[r.id]?n.added[r.id]?(t.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(t)):n.changed[r.id]?(t.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(t)):(t.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(t)):t.addClass("red-ui-diff-empty"),a&&(o=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(w),a.newConfig.all[r.id]?a.added[r.id]?(o.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(o)):a.changed[r.id]?(o.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(o)):(o.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(o)):(o.addClass("red-ui-diff-empty"),a.deleted[r.id]&&0)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(f),$("<span>").text(RED._("diff.flowProperties")).appendTo(f),w.on("click",function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")}),k(h,r,d,i).appendTo(s),f="",g[r.id]?(l.conflicts++,t.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(t),o.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(o),s.addClass("red-ui-diff-list-node-conflict")):f=D.resolutions[r.id],x(r,s,t,o,!0,!g[r.id],f,D))),0),h=0,E={};e.tab.nodes.forEach(function(e){E[e.id]=!0,R(e,l,D).appendTo(v)}),e.newTab&&(w=e.newTab.nodes.length,e.newTab.nodes.forEach(function(e){E[e.id]||(E[e.id]=!0,R(e,l,D).appendTo(v))})),e.remoteTab&&(h=e.remoteTab.nodes.length,e.remoteTab.nodes.forEach(function(e){E[e.id]||R(e,l,D).appendTo(v)})),b.on("click",function(e){b.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".red-ui-diff-list-node").addClass("collapsed"),$(this).parent().find(".red-ui-debug-msg-element").addClass("collapsed"))}),n.deleted[r.id]?$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(y):e.newTab?n.added[r.id]?$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(y):(r.id&&(n.changed[r.id]?l.local.changedCount++:l.local.unchangedCount++),d=$("<span>",{class:"red-ui-diff-list-flow-stats"}).appendTo(y),$('<span class="red-ui-diff-status"></span>').text(RED._("diff.nodeCount",{count:w})).appendTo(d),0<l.conflicts+l.local.addedCount+l.local.changedCount+l.local.deletedCount&&($('<span class="red-ui-diff-status"> [ </span>').appendTo(d),0<l.conflicts&&$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i> '+l.conflicts+"</span></span>").appendTo(d),0<l.local.addedCount&&$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> '+l.local.addedCount+"</span></span>").appendTo(d),0<l.local.changedCount&&$('<span class="red-ui-diff-status-changed"><span class="red-ui-diff-status"><i class="fa fa-square"></i> '+l.local.changedCount+"</span></span>").appendTo(d),0<l.local.deletedCount&&$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> '+l.local.deletedCount+"</span></span>").appendTo(d),$('<span class="red-ui-diff-status"> ] </span>').appendTo(d))):y.addClass("red-ui-diff-empty"),a&&(a.deleted[r.id]?$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(p):e.remoteTab?a.added[r.id]?$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(p):(r.id&&(a.changed[r.id]?l.remote.changedCount++:l.remote.unchangedCount++),i=$("<span>",{class:"red-ui-diff-list-flow-stats"}).appendTo(p),$('<span class="red-ui-diff-status"></span>').text(RED._("diff.nodeCount",{count:h})).appendTo(i),0<l.conflicts+l.remote.addedCount+l.remote.changedCount+l.remote.deletedCount&&($('<span class="red-ui-diff-status"> [ </span>').appendTo(i),0<l.conflicts&&$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i> '+l.conflicts+"</span></span>").appendTo(i),0<l.remote.addedCount&&$('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> '+l.remote.addedCount+"</span></span>").appendTo(i),0<l.remote.changedCount&&$('<span class="red-ui-diff-status-changed"><span class="red-ui-diff-status"><i class="fa fa-square"></i> '+l.remote.changedCount+"</span></span>").appendTo(i),0<l.remote.deletedCount&&$('<span class="red-ui-diff-status-deleted"><span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> '+l.remote.deletedCount+"</span></span>").appendTo(i),$('<span class="red-ui-diff-status"> ] </span>').appendTo(i))):p.addClass("red-ui-diff-empty"),f="",0<l.conflicts?b.addClass("red-ui-diff-list-node-conflict"):f=D.resolutions[r.id],r.id&&(s=!(0<l.conflicts&&(n.deleted[r.id]||a.deleted[r.id])),x(r,b,y,p,!1,s,f,D))),0===m.find(".red-ui-diff-list-node").length&&m.addClass("red-ui-diff-list-flow-empty"),c.i18n()}}),i),a=t.localDiff,r=t.remoteDiff,s=(t.conflicts,a.currentConfig),d=a.newConfig;return void 0!==r?(e.addClass("red-ui-diff-three-way"),i=o.oldRevTitle||RED._("diff.local"),t=o.newRevTitle||RED._("diff.remote"),$("<div></div>").text(i).appendTo(l),$("<div></div>").text(t).appendTo(l)):e.removeClass("red-ui-diff-three-way"),{list:n,finish:function(){var e,t={diff:a,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:s.globals},newTab:{n:{},nodes:d.globals}},o=(void 0!==r&&(t.remoteTab={n:{},nodes:r.newConfig.globals},t.remoteDiff=r),n.editableList("addItem",t),{});for(e in s.tabOrder.forEach(function(e){var t=s.tabs[e],t={diff:a,def:RED.nodes.getType("tab"),tab:t};d.tabs.hasOwnProperty(e)&&(t.newTab=d.tabs[e]),void 0!==r&&(t.remoteTab=r.newConfig.tabs[e],t.remoteDiff=r),o[e]=!0,n.editableList("addItem",t)}),d.tabOrder.forEach(function(e){o[e]||(o[e]=!0,e=d.tabs[e],e={diff:a,def:RED.nodes.getType("tab"),tab:e,newTab:e},void 0!==r&&(e.remoteDiff=r),n.editableList("addItem",e))}),void 0!==r&&r.newConfig.tabOrder.forEach(function(e){o[e]||(e=r.newConfig.tabs[e],e={diff:a,remoteDiff:r,def:RED.nodes.getType("tab"),tab:e,remoteTab:e},n.editableList("addItem",e))}),s.subflows)s.subflows.hasOwnProperty(e)&&(o[e]=!0,t={diff:a,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:s.subflows[e]},d.subflows.hasOwnProperty(e)&&(t.newTab=d.subflows[e]),void 0!==r&&(t.remoteTab=r.newConfig.subflows[e],t.remoteDiff=r),n.editableList("addItem",t));for(e in d.subflows)d.subflows.hasOwnProperty(e)&&!o[e]&&(o[e]=!0,t={diff:a,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:d.subflows[e],newTab:d.subflows[e]},void 0!==r&&(t.remoteDiff=r),n.editableList("addItem",t));if(void 0!==r)for(e in r.newConfig.subflows)r.newConfig.subflows.hasOwnProperty(e)&&!o[e]&&(t={diff:a,remoteDiff:r,def:{defaults:{},icon:"subflow.svg",category:"subflows",color:"#DDAA99"},tab:r.newConfig.subflows[e],remoteTab:r.newConfig.subflows[e]},n.editableList("addItem",t))}}}function E(e,n){var t=$("<div>",{class:"red-ui-diff-list-wires"}),a=$("<ol></ol>"),r=0;return e.forEach(function(e,t){var i,o=$("<li>").appendTo(a);e&&0<e.length?($("<span>").text(t+1).appendTo(o),i=$("<ul>").appendTo(o),e.forEach(function(e){r++;var t=$("<li>").appendTo(i),o=n[e];o?g(o,RED.nodes.getType(o.type)||{}).appendTo(t):t.text(e)})):o.text("none")}),0===r?t.text("none"):a.appendTo(t),t}function _(e,t){var o=$("<div>",{class:"red-ui-diff-list-node-icon"}),i=RED.utils.getNodeColor(e.type,t),t=RED.utils.getNodeIcon(t,e),e=("tab"===e.type&&(i="#C0DEED"),o.css("backgroundColor",i),$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(o));return RED.utils.createIconElement(t,e,!1),o}function g(e,t){var o=$("<div>",{class:"red-ui-diff-list-node-title"}),t=(_(e,t).appendTo(o),e.label||e.name||e.id);return $("<div>",{class:"red-ui-diff-list-node-description"}).text(t).appendTo(o),o}function R(t,e,c){var o,u,i=c.localDiff,n=c.remoteDiff,p=c.conflicts[t.id],a=!0,r=(i.added[t.id]&&(e.local.addedCount++,a=!1),n&&n.added[t.id]&&(e.remote.addedCount++,a=!1),i.deleted[t.id]&&(e.local.deletedCount++,a=!1),n&&n.deleted[t.id]&&(e.remote.deletedCount++,a=!1),i.changed[t.id]&&(e.local.changedCount++,a=!!0),n&&n.changed[t.id]&&(e.remote.changedCount++,a=!!0),RED.nodes.getType(t.type)),s=(void 0===r&&(r=/^subflow:/.test(t.type)?{icon:"subflow.svg",category:"subflows",color:"#DDAA99",defaults:{name:{value:""}}}:"group"===t.type?RED.group.def:{}),$("<div>",{class:"red-ui-diff-list-node collapsed"})),f=$("<div>",{class:"red-ui-diff-list-node-header"}).appendTo(s),d=$("<div>",{class:"red-ui-diff-list-node-cell"}).appendTo(f),l=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-local"}).appendTo(f),h=(n&&(o=$("<div>",{class:"red-ui-diff-list-node-cell red-ui-diff-list-node-remote"}).appendTo(f)),$('<span class="red-ui-diff-list-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(d),a?(e.local.unchangedCount++,g(t,r).appendTo(d),l.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(l),n&&(e.remote.unchangedCount++,o.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(o)),s.addClass("red-ui-diff-status-unchanged")):i.added[t.id]?(l.addClass("red-ui-diff-status-added"),o&&o.addClass("red-ui-diff-empty"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(l),g(t,r).appendTo(d)):n&&n.added[t.id]?(l.addClass("red-ui-diff-empty"),o.addClass("red-ui-diff-status-added"),$('<span class="red-ui-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(o),g(t,r).appendTo(d)):(g(t,r).appendTo(d),i.moved[t.id]?(a=i.newConfig.all[t.id],i.deleted[t.z]||t.z===a.z||""===t.z||i.newConfig.all[t.z]?(l.addClass("red-ui-diff-status-moved"),d="",d=t.z===a.z?RED._("diff.type.movedFrom",{id:i.currentConfig.all[t.id].z||"global"}):RED._("diff.type.movedTo",{id:a.z||"global"}),$('<span class="red-ui-diff-status"><i class="fa fa-caret-square-o-right"></i> '+d+"</span>").appendTo(l)):l.addClass("red-ui-diff-empty"),0):i.deleted[t.z]?(l.addClass("red-ui-diff-empty"),0):i.deleted[t.id]?(l.addClass("red-ui-diff-status-deleted"),$('<span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(l),0):i.changed[t.id]?i.newConfig.all[t.id].z!==t.z?l.addClass("red-ui-diff-empty"):(l.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(l),0):i.newConfig.all[t.id].z!==t.z?l.addClass("red-ui-diff-empty"):(e.local.unchangedCount++,l.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(l)),n&&(n.moved[t.id]?(a=n.newConfig.all[t.id],n.deleted[t.z]||t.z===a.z||""===t.z||n.newConfig.all[t.z]?(o.addClass("red-ui-diff-status-moved"),d="",d=t.z===a.z?RED._("diff.type.movedFrom",{id:n.currentConfig.all[t.id].z||"global"}):RED._("diff.type.movedTo",{id:a.z||"global"}),$('<span class="red-ui-diff-status"><i class="fa fa-caret-square-o-right"></i> '+d+"</span>").appendTo(o)):o.addClass("red-ui-diff-empty")):n.deleted[t.z]?o.addClass("red-ui-diff-empty"):n.deleted[t.id]?(o.addClass("red-ui-diff-status-deleted"),$('<span class="red-ui-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(o)):n.changed[t.id]?n.newConfig.all[t.id].z!==t.z?o.addClass("red-ui-diff-empty"):(o.addClass("red-ui-diff-status-changed"),$('<span class="red-ui-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(o)):n.newConfig.all[t.id].z!==t.z?o.addClass("red-ui-diff-empty"):(e.remote.unchangedCount++,o.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(o)))),{node:i.newConfig.all[t.id],all:i.newConfig.all,diff:i}),a=(n&&(u={node:n.newConfig.all[t.id]||null,all:n.newConfig.all,diff:n}),"");return p?(e.conflicts++,l.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(l),o.hasClass("red-ui-diff-empty")||$('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(o),s.addClass("red-ui-diff-list-node-conflict")):a=c.resolutions[t.id],x(t,s,l,o,!1,!p,a,c),f.on("click",function(e){$(this).parent().toggleClass("collapsed"),0===$(this).siblings(".red-ui-diff-list-node-properties").length&&k(r,t,h,u).appendTo(s)}),s}function k(o,t,p,f){var i,n,h,g,m,a,r,s={},d=p.node,e=(f&&(i=f.node),$("<div>",{class:"red-ui-diff-list-node-properties"})),b=$("<table>").appendTo(e),v=$("<colgroup><col/><col/></colgroup>").appendTo(b),y=(void 0!==i&&$("<col/>").appendTo(v),$("<tbody>").appendTo(b)),l=!1,c=!1,w=!1,u=$("<tr>").appendTo(y),v=($("<td>",{class:"red-ui-diff-list-cell-label"}).text("id").appendTo(u),n=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(u),d?(n.addClass("red-ui-diff-status-unchanged"),$('<span class="red-ui-diff-status"></span>').appendTo(n),a=$('<span class="red-ui-diff-list-element"></span>').appendTo(n),s["local.id"]=RED.utils.createObjectElement(d.id).appendTo(a)):n.addClass("red-ui-diff-empty"),void 0!==i&&((r=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(u)).addClass("red-ui-diff-status-unchanged"),i?($('<span class="red-ui-diff-status"></span>').appendTo(r),a=$('<span class="red-ui-diff-list-element"></span>').appendTo(r),s["remote.id"]=RED.utils.createObjectElement(i.id).appendTo(a)):r.addClass("red-ui-diff-empty")),t.hasOwnProperty("x")&&(d&&(d.x===t.x&&d.y===t.y&&d.w===t.w&&d.h===t.h||(l=!0,0)),i&&(i.x===t.x&&i.y===t.y&&i.w===t.w&&i.h===t.h||(c=!0,0)),(c&&l&&(d.x!==i.x||d.y!==i.y)||!l&&c&&p.diff.deleted[t.id]||l&&!c&&f.diff.deleted[t.id])&&(w=!0),u=$("<tr>").appendTo(y),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("position").appendTo(u),n=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(u),d?(n.addClass("red-ui-diff-status-"+(l?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(l?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(n),a=$('<span class="red-ui-diff-list-element"></span>').appendTo(n),v={x:d.x,y:d.y},d.hasOwnProperty("w")&&(v.w=d.w,v.h=d.h),s["local.position"]=RED.utils.createObjectElement(v,{path:"position",exposeApi:!0,ontoggle:function(e,t){s["remote."+e]&&s["remote."+e].prop("expand")(e,t)}}).appendTo(a)):n.addClass("red-ui-diff-empty"),void 0!==i&&((r=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(u)).addClass("red-ui-diff-status-"+(c?"changed":"unchanged")),i?($('<span class="red-ui-diff-status">'+(c?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(r),a=$('<span class="red-ui-diff-list-element"></span>').appendTo(r),b={x:i.x,y:i.y},i.hasOwnProperty("w")&&(b.w=i.w,b.h=i.h),s["remote.position"]=RED.utils.createObjectElement(b,{path:"position",exposeApi:!0,ontoggle:function(e,t){s["local."+e]&&s["local."+e].prop("expand")(e,t)}}).appendTo(a)):r.addClass("red-ui-diff-empty"))),l=c=w=!1,t.hasOwnProperty("wires")&&(h=JSON.stringify(t.wires),d&&(g=JSON.stringify(d.wires),h!==g&&(l=!0,0)),i&&(m=JSON.stringify(i.wires),h!==m&&(c=!0,0)),(c&&l&&g!==m||!l&&c&&p.diff.deleted[t.id]||l&&!c&&f.diff.deleted[t.id])&&(w=!0),u=$("<tr>").appendTo(y),$("<td>",{class:"red-ui-diff-list-cell-label"}).text("wires").appendTo(u),n=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(u),d?(w?(n.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(n)):(n.addClass("red-ui-diff-status-"+(l?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(l?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(n)),E(d.wires,p.all).appendTo(n)):n.addClass("red-ui-diff-empty"),void 0!==i&&(r=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(u),i?(w?(r.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(r)):(r.addClass("red-ui-diff-status-"+(c?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(c?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(r)),E(i.wires,f.all).appendTo(r)):r.addClass("red-ui-diff-empty"))),Object.keys(t).filter(function(e){return!("inputLabels"==e||"outputLabels"==e||"z"==e||"wires"==e||"x"===e||"y"===e||"w"===e||"h"===e||"id"===e||"type"===e||o.defaults&&o.defaults.hasOwnProperty(e))}));return o.defaults&&(v=v.concat(Object.keys(o.defaults))),"tab"!==t.type&&"group"!==t.type&&(v=v.concat(["inputLabels","outputLabels"])),(d&&d.hasOwnProperty("icon")||i&&i.hasOwnProperty("icon"))&&-1===v.indexOf("icon")&&v.unshift("icon"),v.forEach(function(o){w=c=l=!1,h=JSON.stringify(t[o]),d&&(g=JSON.stringify(d[o]),h!==g&&(l=!0,0)),i&&(m=JSON.stringify(i[o]),h!==m&&(c=!0,0)),(c&&l&&g!==m||!l&&c&&p.diff.deleted[t.id]||l&&!c&&f.diff.deleted[t.id])&&(w=!0),u=$("<tr>").appendTo(y);var e=$("<td>",{class:"red-ui-diff-list-cell-label"}).text(o).appendTo(u);n=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-local"}).appendTo(u),d?(w?(n.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(n)):(n.addClass("red-ui-diff-status-"+(l?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(l?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(n)),a=$('<span class="red-ui-diff-list-element"></span>').appendTo(n),s["local."+o]=RED.utils.createObjectElement(d[o],{path:o,exposeApi:!0,ontoggle:function(e,t){s["remote."+o]&&s["remote."+o].prop("expand")(e,t)}}).appendTo(a)):n.addClass("red-ui-diff-empty"),void 0!==i&&(r=$("<td>",{class:"red-ui-diff-list-cell red-ui-diff-list-node-remote"}).appendTo(u),i?(w?(r.addClass("red-ui-diff-status-conflict"),$('<span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(r)):(r.addClass("red-ui-diff-status-"+(c?"changed":"unchanged")),$('<span class="red-ui-diff-status">'+(c?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(r)),a=$('<span class="red-ui-diff-list-element"></span>').appendTo(r),s["remote."+o]=RED.utils.createObjectElement(i[o],{path:o,exposeApi:!0,ontoggle:function(e,t){s["local."+o]&&s["local."+o].prop("expand")(e,t)}}).appendTo(a)):r.addClass("red-ui-diff-empty")),d&&i&&"string"==typeof d[o]&&(/\n/.test(d[o])||/\n/.test(i[o]))&&$('<button class="red-ui-button red-ui-button-small red-ui-diff-text-diff-button"><i class="fa fa-file-o"> <i class="fa fa-caret-left"></i> <i class="fa fa-caret-right"></i> <i class="fa fa-file-o"></i></button>').on("click",function(){C(d[o],i[o])}).appendTo(e)}),e}function x(o,i,e,t,n,c,a,u){function r(e){var t;void 0===o.type||(p?(t="red-ui-diff-selectbox-tab-"+o.id.replace(/\./g,"-"),$("."+t+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+t+"-"+this.value).closest(".red-ui-diff-list-node").addClass("red-ui-diff-select-local"),$("."+t+"-"+this.value).closest(".red-ui-diff-list-node").removeClass("red-ui-diff-select-remote")):($("."+t+"-"+this.value).closest(".red-ui-diff-list-node").removeClass("red-ui-diff-select-local"),$("."+t+"-"+this.value).closest(".red-ui-diff-list-node").addClass("red-ui-diff-select-remote"))):(t="red-ui-diff-selectbox-"+(n?o.id:o.z).replace(/\./g,"-"),$("#"+t+"-local").prop("checked",!1),$("#"+t+"-remote").prop("checked",!1),(t=$("#"+t+"-local").closest(".red-ui-diff-list-flow").find(".red-ui-diff-list-flow-title")).removeClass("red-ui-diff-select-local"),t.removeClass("red-ui-diff-select-remote"))),"local"===this.value?(i.removeClass("red-ui-diff-select-remote"),i.addClass("red-ui-diff-select-local")):"remote"===this.value&&(i.addClass("red-ui-diff-select-remote"),i.removeClass("red-ui-diff-select-local")),w(u)}var s="red-ui-diff-selectbox-"+o.id.replace(/\./g,"-")+(n?"-props":""),d="",p=((o.z||n)&&(d="red-ui-diff-selectbox-tab-"+(n?o.id:o.z).replace(/\./g,"-")),!n&&("tab"===o.type||"subflow"===o.type)),l=$("<label>",{class:"red-ui-diff-selectbox",for:s+"-local"}).on("click",function(e){e.stopPropagation()}).appendTo(e),f=$("<input>",{class:"red-ui-diff-selectbox-input "+d+"-local",id:s+"-local",type:"radio",value:"local",name:s}).data("node-id",o.id).on("change",r).appendTo(l),h=$("<label>",{class:"red-ui-diff-selectbox",for:s+"-remote"}).on("click",function(e){e.stopPropagation()}).appendTo(t),d=$("<input>",{class:"red-ui-diff-selectbox-input "+d+"-remote",id:s+"-remote",type:"radio",value:"remote",name:s}).data("node-id",o.id).on("change",r).appendTo(h);"local"===a?f.prop("checked",!0):"remote"===a&&d.prop("checked",!0),(c||e.hasClass("red-ui-diff-empty")||t.hasClass("red-ui-diff-empty"))&&(l.hide(),h.hide())}function w(e){var t=0,o=($(".red-ui-diff-selectbox>input:checked").each(function(){e.conflicts[$(this).data("node-id")]&&t++,e.resolutions[$(this).data("node-id")]=$(this).val()}),Object.keys(e.conflicts).length);o-t==0?$("#red-ui-diff-dialog-toolbar-resolved-conflicts").html('<span class="red-ui-diff-status-added"><span class="red-ui-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:o-t})):$("#red-ui-diff-dialog-toolbar-resolved-conflicts").html('<span class="red-ui-diff-status-conflict"><span class="red-ui-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:o-t})),o===t&&($("#red-ui-diff-view-diff-merge").removeClass("disabled"),$("#red-ui-diff-view-resolve-diff").removeClass("disabled"))}function s(n){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(e){var t=RED.nodes.createCompleteNodeSet(),o=RED.nodes.originalFlow(),i=e.flows,t=D(o,t),o=D(o,i);o.rev=e.rev,n(T(t,o))}})}function t(e){var o,i,n,a;void 0===e?s(t):(o=e,i={mode:"merge"},r||(i=i||{},o.localDiff,n=o.remoteDiff,a=o.conflicts,e={title:i.title||RED._("diff.reviewChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("merge"===i.mode?"common.label.cancel":"common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var e=e.find(".red-ui-tray-body"),t=($('<div class="red-ui-diff-dialog-toolbar"><span><span id="red-ui-diff-dialog-toolbar-resolved-conflicts"></span></span> </div>').prependTo(e),p($('<div class="red-ui-diff-container"></div>').appendTo(e),o,i));t.list.hide(),n?($("#red-ui-diff-view-diff-merge").show(),0===Object.keys(a).length?$("#red-ui-diff-view-diff-merge").removeClass("disabled"):$("#red-ui-diff-view-diff-merge").addClass("disabled")):$("#red-ui-diff-view-diff-merge").hide(),w(o),setTimeout(function(){t.finish(),t.list.show()},300),$("#red-ui-sidebar-shade").show()},close:function(){r=!1,$("#red-ui-sidebar-shade").hide()},show:function(){}},"merge"===i.mode&&e.buttons.push({id:"red-ui-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#red-ui-diff-view-diff-merge").hasClass("disabled")||(w(o),c(o),RED.tray.close())}}),RED.tray.show(e)))}function d(e){var t=[],o={},i={},n=[],a={};return e.forEach(function(e){"tab"===(a[e.id]=e).type?(t.push(e.id),o[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(i[e.id]={n:e,nodes:[]})}),e.forEach(function(e){"tab"!==e.type&&"subflow"!==e.type&&(o[e.z]?o[e.z].nodes:i[e.z]?i[e.z].nodes:n).push(e)}),{all:a,tabOrder:t,tabs:o,subflows:i,globals:n}}function D(e,t){var o=d(e),i=d(t),n={},a={},r={},s={};return Object.keys(o.all).forEach(function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);i.all.hasOwnProperty(e)?JSON.stringify(o.all[e])!==JSON.stringify(i.all[e])&&(r[e]=!0,o.all[e].z!==i.all[e].z&&(s[e]=!0)):a[e]=!0}),Object.keys(i.all).forEach(function(e){o.all.hasOwnProperty(e)||(n[e]=!0)}),{currentConfig:o,newConfig:i,added:n,deleted:a,changed:r,moved:s}}function T(e,t){var o,i,n,a,r={},s={},d={localDiff:e,remoteDiff:t,conflicts:r,resolutions:s},l={};for(o in e.currentConfig.all)e.currentConfig.all.hasOwnProperty(o)&&(l[o]=!0,n=e.newConfig.all[o],e.changed[o]&&t.deleted[o]||e.deleted[o]&&t.changed[o]?r[o]=!0:e.changed[o]&&t.changed[o]&&(a=t.newConfig.all[o],JSON.stringify(n)!==JSON.stringify(a)&&(r[o]=!0)),r[o]||(t.added[o]||t.changed[o]||t.deleted[o]?s[o]="remote":s[o]="local"));for(o in e.added)e.added.hasOwnProperty(o)&&(i=e.newConfig.all[o],t.deleted[i.z]?r[o]=!0:s[o]="local");for(o in t.added)t.added.hasOwnProperty(o)&&(i=t.newConfig.all[o],e.deleted[i.z]?r[o]=!0:s[o]="remote");return d}function l(e){e.localDiff.currentConfig;var t,o=e.localDiff,i=e.remoteDiff,n=e.conflicts,a=e.resolutions;for(t in n)if(n.hasOwnProperty(t)&&!a.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var r,s=[],d={},l={};for(t in o.newConfig.all)o.newConfig.all.hasOwnProperty(t)&&(r=RED.nodes.node(t),"local"===a[t]?(r&&(d[t]=r.changed),s.push(o.newConfig.all[t])):"remote"===a[t]?!i.deleted[t]&&i.newConfig.all.hasOwnProperty(t)&&(r&&(d[t]=r.changed),l[t]=1,s.push(i.newConfig.all[t])):console.log("Unresolved",t));for(t in i.added)i.added.hasOwnProperty(t)&&((r=RED.nodes.node(t))&&(d[t]=r.changed),o.added.hasOwnProperty(t)||(l[t]=2,s.push(i.newConfig.all[t])));return{config:s,nodeChangedStates:d,localChangedStates:l}}function c(e){var t,o=RED.workspaces.active(),i=l(e),n=i.config,a=i.nodeChangedStates,r=i.localChangedStates,i=RED.nodes.dirty(),s={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:a,dirty:i,rev:RED.nodes.version()},d=(RED.history.push(s),RED.nodes.originalFlow());for(t in e.remoteDiff.added)e.remoteDiff.added.hasOwnProperty(t)&&e.remoteDiff.newConfig.all.hasOwnProperty(t)&&d.push(JSON.parse(JSON.stringify(e.remoteDiff.newConfig.all[t])));RED.nodes.clear();s=RED.nodes.import(n);RED.nodes.originalFlow(d),s.nodes.forEach(function(e){(a[e.id]||r[e.id])&&(e.changed=!0)}),RED.nodes.version(e.remoteDiff.rev),i&&RED.nodes.dirty(!0),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.workspaces.show(o,!0),RED.sidebar.config.refresh()}function C(m,b){var e={title:RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){for(var t,e=e.find(".red-ui-tray-body"),e=$('<div class="red-ui-diff-text"></div>').appendTo(e),e=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(e),c=($('<colgroup><col width="50"><col width="50%"><col width="50"><col width="50%"></colgroup>').appendTo(e),$("<tbody>").appendTo(e)),o=function(c,u,p){var e,t,o=c.split(/\r?\n/),i=u.split(/\r?\n/),n=o.length,a=i.length,r={a:[],b:[]},s=[];for(e=0;e<n+1;e++)for(s[e]=[],t=0;t<a+1;t++)s[e][t]=0;for(e=n-1;0<=e;e--)for(t=a-1;0<=t;t--)1!==y(o[e],i[t],p)?s[e][t]=s[e+1][t+1]+1:s[e][t]=Math.max(s[e+1][t],s[e][t+1]);t=e=0;for(;e<n&&t<a;){var d,l=y(o[e],i[t],p);1!==l?((d=0)===l?d=0:2==l&&(d=3),r.a.push({i:e+1,j:t+1,line:o[e],type:d}),r.b.push({i:t+1,j:e+1,line:i[t],type:d}),e++,t++):s[e+1][t]>=s[e][t+1]?(r.a.push({i:e+1,line:o[e],type:1}),e++):(r.b.push({i:t+1,line:i[t],type:4}),t++)}for(;e<n||t<a;)e==n?(r.b.push({i:t+1,line:i[t],type:4}),t++):t==a&&(r.a.push({i:e+1,line:o[e],type:1}),e++);return r}(m||"",b||""),i=0,u=0,p=Math.max(o.a.length,o.b.length),f=[],n=[],a=0,r=0,s=0;s<p;s++){o[s];var d=i<o.a.length?o.a[i]:{type:2,line:""},l=u<o.b.length?o.b[u]:{type:2,line:""};0===d.type&&0!==l.type?(d={type:2,line:""},u++):0===l.type&&0!==d.type?(l={type:2,line:""},i++):(i++,u++),f.push({a:d,b:l}),void 0===t?(t={start:s,end:s},r=(a=0)===d.type&&0===l.type?0:1):0===d.type&&0===l.type?0===r?(t.end=s,a++):1===r?(t.end=s,r=2,a=0):2===r&&(t.end=s,8===++a&&(t.end-=5,n.push(t),t={start:s-5,end:s-5},a=r=0)):(t.end=s,a++,0===r?(3<t.end&&(t.end-=3,t.empty=!0,n.push(t),t={start:s-3,end:s-3}),r=1):2===r&&(r=1))}0===r&&(t.empty=!0),t.end=p,n.push(t),console.table(n);for(var h=0;h<n.length;h++)if((t=n[h]).empty)(function(i,n,a){diffRow=$('<tr class="red-ui-diff-text-header red-ui-diff-text-expand">');var e=$('<td colspan="4"> <i class="fa fa-arrows-v"></i> </td>').appendTo(diffRow),r=$("<span></span>").appendTo(e);n<a.length-1&&r.text("@@ -"+(a[n-1].a.i+1)+" +"+(a[n-1].b.i+1));return diffRow.on("click",function(e){if(20<n-i){var t=$(this).offset();if(0<i){for(var o=i;o<i+10;o++)v(a[o]).addClass("unchanged").insertBefore($(this));i+=10}if(n<a.length-1){for(o=n-1;n-11<o;o--)v(a[o]).addClass("unchanged").insertAfter($(this));n-=10}n<a.length-1&&r.text("@@ -"+(a[n-1].a.i+1)+" +"+(a[n-1].b.i+1));t=$(this).offset().top-t.top;$(".red-ui-diff-text").scrollTop($(".red-ui-diff-text").scrollTop()+t)}else{for(o=i;o<n;o++)v(a[o]).addClass("unchanged").insertBefore($(this));$(this).remove()}}),diffRow})(t.start,t.end,f).appendTo(c);else for(s=t.start;s<t.end;s++){var g=v(f[s]).appendTo(c);s===t.start?g.addClass("start-block"):s===t.end-1&&g.addClass("end-block")}},close:function(){r=!1},show:function(){}};RED.tray.show(e)}function v(e){var t=$("<tr>"),o=e.a,e=e.b,i=$('<td class="lineno">').text(2===o.type?"":o.i).appendTo(t),n=$('<td class="linetext">').text(o.line).appendTo(t);return 2===o.type?(i.addClass("blank"),n.addClass("blank")):4===o.type?(i.addClass("added"),n.addClass("added")):1===o.type&&(i.addClass("removed"),n.addClass("removed")),i=$('<td class="lineno">').text(2===e.type?"":e.i).appendTo(t),n=$('<td class="linetext">').text(e.line).appendTo(t),2===e.type?(i.addClass("blank"),n.addClass("blank")):4===e.type?(i.addClass("added"),n.addClass("added")):1===e.type&&(i.addClass("removed"),n.addClass("removed")),t}function y(e,t,o){return o?e===t?0:e.trim()===t.trime()?2:1:e===t?0:1}function a(e,y){var u=$("<div></div>");return e.forEach(function(f){var m,l,s,c,t,d,e,o,a=f.hunks,r=f.binary,i=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(u),h=($('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(i),$("<tbody>").appendTo(i)),n=$('<tr class="red-ui-diff-text-file-header">').appendTo(h),i=$('<td colspan="3"></td>').appendTo(n),g=($('<i class="red-ui-diff-list-chevron fa fa-angle-down"></i>').appendTo(i),n.on("click",function(e){n.toggleClass("collapsed");var t=n.hasClass("collapsed");n.nextUntil(".red-ui-diff-text-file-header").toggle(!t)}),$('<span class="filename"></span>').text(f.file).appendTo(i),0),b=0,v={};y.project.files&&y.project.files.flow===f.file?(y.unmerged&&$('<span style="float: right;"><span id="red-ui-diff-dialog-toolbar-resolved-conflicts"></span></span>').appendTo(i),e=$('<tr class="red-ui-diff-text-header">').appendTo(h),l=$('<td class="red-ui-diff-flow-diff" colspan="3"></td>').appendTo(e),e=y.project.name,s=y.project.files.flow,d="projects/"+e+"/files/"+y.commonRev+"/"+s,c="projects/"+e+"/files/"+y.oldRev+"/"+s,o="projects/"+e+"/files/"+y.newRev+"/"+s,t=[$.Deferred(),$.Deferred(),$.Deferred()],y.commonRev?(d="projects/"+e+"/files/"+y.commonRev+"/"+s,$.ajax({dataType:"json",url:d}).then(function(e){t[0].resolve(e)}).fail(function(){t[0].resolve(null)})):t[0].resolve(null),$.ajax({dataType:"json",url:c}).then(function(e){t[1].resolve(e)}).fail(function(){t[1].resolve({content:"[]"})}),$.ajax({dataType:"json",url:o}).then(function(e){t[2].resolve(e)}).fail(function(){t[2].resolve({content:"[]"})}),$.when.apply($,t).always(function(e,t,o){var i,n,a;if(e)try{i=JSON.parse(e.content||"[]")}catch(e){return console.log(RED._("diff.commonVersionError"),d),void console.log(e)}try{n=JSON.parse(t.content||"[]")}catch(e){return console.log(RED._("diff.oldVersionError"),c),void console.log(e)}i=i||n;try{a=JSON.parse(o.content||"[]")}catch(e){return console.log(RED._("diff.newVersionError"),a),void console.log(e)}var e=D(i,n),t=D(i,a),r=(y.currentDiff=T(e,t),p(l,y.currentDiff,{title:s,mode:y.commonRev?"merge":"view",oldRevTitle:y.oldRevTitle,newRevTitle:y.newRevTitle}));r.list.hide(),w(y.currentDiff),setTimeout(function(){r.finish(),r.list.show()},300)})):r?(e=$('<tr class="red-ui-diff-text-header">').appendTo(h),o=$('<td colspan="3"></td>').appendTo(e),$("<span></span>").text(RED._("diff.noBinaryFileShowed")).appendTo(o)):(y.unmerged&&(m=$('<span style="float: right;">'+RED._("diff.conflictHeader",{resolved:b,unresolved:g})+"</span>").appendTo(i)),a.forEach(function(l){var e=$('<tr class="red-ui-diff-text-header">').appendTo(h),e=$('<td colspan="3"></td>').appendTo(e),c=($("<span></span>").text(l.header).appendTo(e),l.conflict),u=l.localStartLine,p=l.remoteStartLine;c&&g++,l.lines.forEach(function(e,t){var o,i,t=l.diffStart+t,n=c&&/^\+\+(<<<<<<<|=======$|>>>>>>>)/.test(e),a=$("<tr>").appendTo(h),r=$('<td class="lineno">').appendTo(a),s=(n?r.attr("colspan",2):o=$('<td class="lineno">').appendTo(a),$('<td class="linetext">').appendTo(a)),d=c?2:1;n?(a.addClass("mergeHeader"),/^\+\+=======$/.test(e)?(l.changeSeparator=t,a.addClass("mergeHeader-separator")):((i=/^..<<<<<<</.test(e))?($("<span>").text("<<<<<<< Local Changes").appendTo(s),l.localChangeStart=t):(l.remoteChangeEnd=t,$("<span>").text(">>>>>>> Remote Changes").appendTo(s)),a.addClass("mergeHeader-"+(i?"ours":"theirs")),$('<button class="red-ui-button red-ui-button-small" style="float: right; margin-right: 20px;"><i class="fa fa-angle-double-'+(i?"down":"up")+'"></i> use '+(i?"local":"remote")+" changes</button>").appendTo(s).on("click",function(e){var t,o;e.preventDefault(),b++,i?((o=(t=a.nextUntil(".mergeHeader-separator")).last().next()).nextUntil(".mergeHeader").remove(),o.next().remove()):((o=(t=a.prevUntil(".mergeHeader-separator")).last().prev()).prevUntil(".mergeHeader").remove(),o.prev().remove()),o.remove(),a.remove(),t.find(".linetext").addClass("added"),m.empty(),$("<span>"+RED._("diff.conflictHeader",{resolved:b,unresolved:g})+"</span>").appendTo(m),v[f.file]=v[f.file]||{},v[f.file][l.localChangeStart]={changeStart:l.localChangeStart,separator:l.changeSeparator,changeEnd:l.remoteChangeEnd,selection:i?"A":"B"},y.resolveConflict&&y.resolveConflict({conflicts:g,resolved:b,resolutions:v})}))):(n=e[0],c&&!y.unmerged&&" "===n&&(n=e[1]),$('<span class="prefix">').text(n).appendTo(s),t=!1,c&&y.unmerged?($('<span class="prefix">').text(e[1]).appendTo(s),"+"===e[0]&&(r.text(u++),t=!0),"+"===e[1]&&(o.text(p++),t=!0)):"+"===e[0]||c&&"+"===e[1]?(r.addClass("added"),o.addClass("added"),s.addClass("added"),o.text(p++),t=!0):("-"===e[0]||c&&"-"===e[1])&&(r.addClass("removed"),o.addClass("removed"),s.addClass("removed"),r.text(u++),t=!0),t||(s.addClass("unchanged"),0<u&&"\\"!==e[0]&&""!==e&&r.text(u++),0<p&&"\\"!==e[0]&&""!==e&&o.text(p++)),$("<span>").text(e.substring(d)).appendTo(s))})}))}),u}function u(e){for(var t,o,i=Array.isArray(e)?e:e.split("\n"),n=/^diff (?:(?:--git a\/(.*) b\/(.*))|(?:--cc (.*)))$/,a=/^\+\+\+ b\/(.*)\t?/,c=/^Binary files /,u=/^@@ -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @@ ?(.*)$/,p=/^@+ -((\d+)(,(\d+))?) -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @+/,r=[],s=0;s<i.length;s++){var d=i[s],l=n.exec(d);l?(o&&(t.hunks.push(o),r.push(t)),o=null,t={file:l[1]||l[3],hunks:[]}):c.test(d)?t&&(t.binary=!0):(l=a.exec(d))?t.file=l[1]:(l=u.exec(d))?(o&&t.hunks.push(o),o={header:d,localStartLine:l[2],localLength:l[4]||1,remoteStartLine:l[6],remoteLength:l[8]||1,lines:[],conflict:!1}):(l=p.exec(d))?(o&&t.hunks.push(o),o={header:d,localStartLine:l[2],localLength:l[4]||1,remoteStartLine:l[6],remoteLength:l[8]||1,diffStart:parseInt(l[10]),lines:[],conflict:!0}):o&&o.lines.push(d)}return o&&t.hunks.push(o),r.push(t),r}return{init:function(){RED.actions.add("core:show-remote-diff",t)},getRemoteDiff:s,showRemoteDiff:t,showUnifiedDiff:function(t){var o,e=t.diff,i=t.title,n=u(e),e=(t.unmerged&&(t.resolveConflict=function(e){(o=e).conflicts===e.resolved&&$("#red-ui-diff-view-resolve-diff").removeClass("disabled")}),{title:i||RED._("diff.compareChanges"),width:1/0,overlay:!0,buttons:[{text:RED._(t.unmerged?"common.label.cancel":"common.label.close"),click:function(){t.oncancel&&t.oncancel(),RED.tray.close()}}],resize:function(e){},open:function(e){e=e.find(".red-ui-tray-body"),e=$('<div class="red-ui-diff-text"></div>').appendTo(e);a(n,t).appendTo(e)},close:function(){r=!1},show:function(){}});t.unmerged&&e.buttons.push({id:"red-ui-diff-view-resolve-diff",text:RED._("diff.saveConflict"),class:"primary disabled",click:function(){var e;$("#red-ui-diff-view-resolve-diff").hasClass("disabled")||(t.currentDiff&&(e=l(t.currentDiff),(o={resolutions:{}}).resolutions[t.project.files.flow]=JSON.stringify(e.config,"",4)),t.onresolve&&t.onresolve(o),RED.tray.close())}}),RED.tray.show(e)},showCommitDiff:function(o){var i=function(e){for(var t={},o=e.split("\n"),i=[],n=0;n<o.length;n++)if(/^commit /.test(o[n]))t.sha=o[n].substring(7);else if(/^Author: /.test(o[n])){t.author=o[n].substring(8);var a=/^(.*) <(.*)>$/.exec(t.author);a&&(t.authorName=a[1],t.authorEmail=a[2])}else if(/^Date: /.test(o[n]))t.date=o[n].substring(8);else if(/^    /.test(o[n]))t.title?(4!==o[n].length||0<i.length)&&i.push(o[n].substring(4)):t.title=o[n].substring(4);else if(/^diff /.test(o[n])){t.files=u(o.slice(n));break}return t.comment=i.join("\n"),t}(o.commit),e={title:RED._("diff.viewCommitDiff"),width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var e=e.find(".red-ui-tray-body"),e=$('<div class="red-ui-diff-text"></div>').appendTo(e),t=$("<table>",{class:"red-ui-diff-text-content"}).appendTo(e),t=($('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(t),$("<tbody>").appendTo(t)),t=$('<tr class="red-ui-diff-text-commit-header">').appendTo(t),t=$('<td colspan="3"></td>').appendTo(t),t=($("<h3>").text(i.title).appendTo(t),$('<div class="commit-body"></div>').text(i.comment).appendTo(t),$('<div class="commit-summary"></div>').appendTo(t));$('<div style="float: right">').text("Commit "+i.sha).appendTo(t),$("<div>").text((i.authorName||i.author)+" - "+o.date).appendTo(t),i.files&&a(i.files,o).appendTo(e)},close:function(){r=!1},show:function(){}};RED.tray.show(e)},mergeDiff:c}}(),RED.keyboard=function(){var d,l,n=/Mac/i.test(window.navigator.platform),t=!0,u={},a={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,"+":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191,"[":219,"]":221,"{":219,"}":221},o={16:!0,17:!0,18:!0,91:!0,93:!0},p={},f={},g={59:186,61:187,173:189};function m(e){return RED.settings.get("editor.keymap",{})[e]}function h(e){for(var t,o=e.toLowerCase().split("-"),i={},n=0;n<o.length;n++)switch(o[n]){case"ctrl":case"cmd":i.ctrl=!0,i.meta=!0;break;case"alt":i.alt=!0;break;case"shift":i.shift=!0;break;case"":t=a["-"];break;default:if(a.hasOwnProperty(o[n]))t=a[o[n]];else{if(1<o[n].length)return null;t=o[n].toUpperCase().charCodeAt(0)}}return[t,i]}function b(e){var t=l||u,o=((t=(t=(e.ctrlKey||e.metaKey)&&e.ctrlKey!==e.metaKey?t.ctrl:t)&&e.shiftKey?t.shift:t)&&e.altKey&&(t=t.alt),g[e.keyCode]||e.keyCode);if(t&&t[o]){var i=t[o];if(!i.handlers)return l?(l=null,b(e)):(0<Object.keys(i).length&&(l=i,e.preventDefault()),null);for(var n,a=1/0,r=0,s=i.handlers.length,r=0;r<s;r++){var d=function(e,t){for(var o=e.target,i=0;"BODY"!==o.nodeName&&o.id!==t.scope;)o=o.parentElement,i++;return i="BODY"===o.nodeName&&"*"!==t.scope?-1:i}(e,i.handlers[r]);-1<d&&d<a&&(a=d,n=i.handlers[r])}return l=null,i=n}if(l)return l=null,b(e)}function s(e,t,o,i){var n=o,a=i,r=("function"!=typeof o&&"string"!=typeof o||(n={},a=o),[]),s=0;if("string"==typeof t){if("string"==typeof a){if(i||f.hasOwnProperty(a)||(f[a]={scope:e,key:t,user:!1}),!i)if(m(a))return;p[a]={scope:e,key:t},"boolean"==typeof i&&(p[a].user=i)}for(var d=t.split(" "),s=0;s<d.length;s++){var c=h(d[s]);if(!c)return;r.push(c)}}else r.push([t,n]);var l=u;for(s=0;s<r.length;s++)t=r[s][0],(n=r[s][1]).ctrl&&(l.ctrl=l.ctrl||{},l=l.ctrl),n.shift&&(l.shift=l.shift||{},l=l.shift),n.alt&&(l.alt=l.alt||{},l=l.alt),l[t]=l[t]||{},l=l[t];l.handlers=l.handlers||[],l.handlers.push({scope:e,ondown:a}),l.scope=e,l.ondown=a}function r(e,t){var o=t||{},i=[],n=0;if("string"==typeof e)for(var a=e.split(" "),n=0;n<a.length;n++){var r=h(a[n]);if(!r)return void console.log("Unrecognised key specifier:",e);i.push(r)}else i.push([e,o]);var s=u;for(n=0;n<i.length;n++){if(e=i[n][0],!(s=(s=(s=(o=i[n][1]).ctrl?s.ctrl:s)&&o.shift?s.shift:s)&&o.alt?s.alt:s)[e])return;s=s[e]}"string"==typeof s.ondown&&("boolean"==typeof t&&t?p[s.ondown]={user:t}:delete p[s.ondown]),delete s.scope,delete s.ondown,delete s.handlers}d3.select(window).on("keydown",function(){var e;t&&(o[d3.event.keyCode]||(e=b(d3.event))&&e.ondown&&("string"==typeof e.ondown?RED.actions.invoke(e.ondown):e.ondown(),d3.event.preventDefault()))});function v(e){e.preventDefault();var t,o,i,n,a=$(this),r=a.data("data");a.hasClass("keyboard-shortcut-entry-expanded")||(c(),e=a.find(".keyboard-shortcut-entry-key"),n=a.find(".keyboard-shortcut-entry-scope"),a.addClass("keyboard-shortcut-entry-expanded"),(t=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(r.key||"").appendTo(e)).on("change paste keyup",function(e){if(13===e.keyCode&&!$(this).hasClass("input-error"))return c();if(27===e.keyCode)return c(!0);var e=$(this).val(),t=""===(e=e.trim())||RED.keyboard.validateKey(e);t&&""!==e&&(t=!d.has(o.val()+":"+e.toLowerCase())),$(this).toggleClass("input-error",!t),i.attr("disabled",!t)}),(o=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="red-ui-workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(n)).i18n(),"workspace"===r.scope&&(r.scope="red-ui-workspace"),o.val(r.scope||"*"),o.on("change",function(){t.trigger("change")}),e=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(n),i=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-check"></i></button>').appendTo(e),n=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-reply"></i></button>').appendTo(e),i.on("click",function(e){e.stopPropagation(),c()}),n.on("click",function(e){e.stopPropagation(),a.empty(),a.removeClass("keyboard-shortcut-entry-expanded");e=RED.settings.get("editor.keymap",{}),e[r.id]=null,RED.settings.set("editor.keymap",e),RED.keyboard.revertToDefault(r.id),e=RED.keyboard.getShortcut(r.id),e={id:r.id,scope:e?e.scope:void 0,key:e?e.key:void 0,user:e?e.user:void 0,label:r.label,options:r.options};y(a,e)}),t.trigger("focus"))}function c(e){var t,o,i,n,a,r,s=$(".keyboard-shortcut-entry-expanded");1===s.length&&(t=s.data("data"),o=s.find(".keyboard-shortcut-entry-key input"),i=s.find(".keyboard-shortcut-entry-scope select"),e||(e=o.val().trim(),n=i.val(),!(""===e||RED.keyboard.validateKey(e))||(!(a=RED.keyboard.getShortcut(t.id))&&e||a&&(a.scope!==n||a.key!==e))&&(a=s.find(".keyboard-shortcut-entry-key"),r=s.find(".keyboard-shortcut-entry-scope"),a.empty(),r.empty(),t.key&&(d.delete(t.scope+":"+t.key),RED.keyboard.remove(t.key,!0)),s.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===e?(a.parent().addClass("keyboard-shortcut-entry-unassigned"),a.append($("<span>").text(RED._("keyboard.unassigned"))),delete t.key,delete t.scope):(a.parent().removeClass("keyboard-shortcut-entry-unassigned"),a.append(RED.keyboard.formatKey(e)),$("<span>").text(n).appendTo(r),t.key=e,t.scope=n,d.add(t.scope+":"+t.key),RED.keyboard.add(t.scope,t.key,t.id,!0)),a=RED.settings.get("editor.keymap",{}),r=RED.keyboard.getShortcut(t.id),a[t.id]={scope:r.scope,key:r.key},RED.settings.set("editor.keymap",a))),o.remove(),i.remove(),$(".keyboard-shortcut-edit").remove(),s.removeClass("keyboard-shortcut-entry-expanded"))}function y(e,t){var o=$('<div class="keyboard-shortcut-entry">').appendTo(e),i=(e.data("data",t),t.label),i=$("<div>").addClass("keyboard-shortcut-entry-text").text(i).appendTo(o),i=$('<i class="fa fa-user"></i>').prependTo(i),i=(t.user||i.css("opacity",0),$('<div class="keyboard-shortcut-entry-key">').appendTo(o)),i=(t.key?i.append(RED.keyboard.formatKey(t.key)):(o.addClass("keyboard-shortcut-entry-unassigned"),i.append($("<span>").text(RED._("keyboard.unassigned")))),$('<div class="keyboard-shortcut-entry-scope">').appendTo(o));$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(i),e.on("click",v)}function w(){var e=$('<div id="red-ui-settings-tab-keyboard"></div>'),o=($('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input autocomplete="off" name="keyboard-filter" id="red-ui-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(e),e.find("#red-ui-settings-tab-keyboard-filter").searchBox({delay:100,change:function(){var t=$(this).val().trim().toLowerCase();""===t?o.editableList("filter",null):(t=t.replace(/\s/g,""),o.editableList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)}))}}),$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){y(e,o)}})),t=RED.actions.list();return t.sort(function(e,t){e=e.label,t=t.label;return e.localeCompare(t)}),d=new Set,t.forEach(function(e){e.key&&d.add(e.scope+":"+e.key),o.editableList("addItem",e)}),e}return{init:function(a){"localStorage"in window&&null!==window.localStorage&&(null!==(e=localStorage.getItem("keymap"))&&(localStorage.removeItem("keymap"),RED.settings.set("editor.keymap",JSON.parse(e))));var e,r=RED.settings.get("editor.keymap",{});$.getJSON("red/keymap.json",function(e){var t,o,i,n=function(e,t){var o,i,n={};for(o in e)if(e.hasOwnProperty(o)){var a,r=e[o];for(a in r)r.hasOwnProperty(a)&&(n[r[a]]?n[r[a]].push({scope:o,key:a,user:!1}):n[r[a]]=[{scope:o,key:a,user:!1}])}for(i in t)t.hasOwnProperty(i)&&(t[i].key?(n[i]=[{scope:t[i].scope||"*",key:t[i].key,user:!1}],"workspace"===n[i][0].scope&&(n[i][0].scope="red-ui-workspace")):delete n[i]);return n}(e,RED.settings.theme("keymap",{}));for(t in n)n.hasOwnProperty(t)&&(r.hasOwnProperty(t)||n[t].forEach(function(e){s(e.scope,e.key,t,!1)}),f[t]=n[t][0]);for(t in r)r.hasOwnProperty(t)&&r[t]&&((o=r[t]).hasOwnProperty("key")&&s(i="workspace"===(i=o.scope)?"red-ui-workspace":i,o.key,t,!0));a()}),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:w,focus:function(){setTimeout(function(){$("#red-ui-settings-tab-keyboard-filter").trigger("focus")},200)},close:function(){RED.menu.refreshShortcuts()}})},add:s,remove:r,getShortcut:function(e){return p[e]},getUserShortcut:m,revertToDefault:function(e){var t=p[e];t&&r(t.key),f.hasOwnProperty(e)&&s((t=f[e]).scope,t.key,e,!1)},formatKey:function(e,t){var o=n?e.replace(/ctrl-?/,"&#8984;"):e;return o=(o=(o=(o=(o=(o=n?o.replace(/alt-?/,"&#8997;"):e).replace(/shift-?/,"&#8679;")).replace(/left/,"&#x2190;")).replace(/up/,"&#x2191;")).replace(/right/,"&#x2192;")).replace(/down/,"&#x2193;"),t?o:'<span class="help-key-block"><span class="help-key">'+o.split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var t=(e=e.trim()).split(" ");for(i=0;i<t.length;i++)if(!h(t[i]))return!1;return!0},disable:function(){t=!1},enable:function(){t=!0}}}(),RED.workspaces=function(){var n,a=0,r=0,t=[],i=[],o=0;function s(e){o!==t.length&&t.splice(o),t.push(e),o=t.length}function u(o){i=i.filter(function(e){return e!==o&&(!Array.isArray(e)||(-1<(t=e.indexOf(o))&&e.splice(t,1),0!==e.length));var t})}function d(e,t,o){if(e)e.closeable||(e.hideable=!0),n.addTab(e,o),JSON.parse(RED.settings.getLocal("hiddenTabs")||"{}")[e.id]&&n.hideTab(e.id),n.resize();else{for(var i=RED.nodes.id();r+=1,0!==$("#red-ui-workspace-tabs li[flowname='"+RED._("workspace.defaultName",{number:r})+"']").size(););e={type:"tab",id:i,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:r}),env:[],hideable:!0},RED.nodes.addWorkspace(e,o),n.addTab(e,o),n.activateTab(i),t||(RED.history.push({t:"add",workspaces:[e],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return $("#red-ui-tab-"+e.id.replace(".","-")).attr("flowname",e.label),RED.view.focus(),e}function l(e){var t;1!==c&&(t=RED.nodes.getWorkspaceOrder(),e._index=t.indexOf(e.id),v(e),(t=RED.nodes.removeWorkspace(e.id)).t="delete",t.dirty=RED.nodes.dirty(),t.workspaces=[e],RED.history.push(t),RED.nodes.dirty(!0),RED.sidebar.config.refresh())}function p(e){var t=RED.nodes.workspace(e);t?RED.editor.editFlow(t):(t=RED.nodes.subflow(e))&&RED.editor.editSubflow(t)}var c=0;function e(){n=RED.tabs.create({id:"red-ui-workspace-tabs",onchange:function(e){var t={old:a};e?($("#red-ui-workspace-chart").show(),a=e.id,window.location.hash="flow/"+e.id,$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!e.disabled)):($("#red-ui-workspace-chart").hide(),a=0,window.location.hash=""),t.workspace=a,RED.events.emit("workspace:change",t),RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(e){e.id!==a&&s(a),RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?p(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(e){"tab"===e.type&&c++,$('<span class="red-ui-workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+e.id.replace(".","-")+" .red-ui-tab-label"),e.disabled&&$("#red-ui-tab-"+e.id.replace(".","-")).addClass("red-ui-workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",0===a||c<=1),1===c&&($("#red-ui-workspace .red-ui-tabs").show(),$("#red-ui-workspace-chart").show(),$("#red-ui-workspace-footer").children().show())},onremove:function(e){"tab"===e.type?c--:i.push(e.id),RED.menu.setDisabled("menu-item-workspace-delete",0===a||c<=1),0===c&&f()},onreorder:function(e,t){RED.history.push({t:"reorder",workspaces:{from:e,to:t},dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),y(t)},onselect:function(e){RED.view.select(!1),0===e.length?($("#red-ui-workspace-chart svg").css({"pointer-events":"auto",filter:"none"}),$("#red-ui-workspace-toolbar").css({"pointer-events":"auto",filter:"none"}),$("#red-ui-palette-container").css({"pointer-events":"auto",filter:"none"}),$(".red-ui-sidebar-shade").hide()):(RED.view.select(!1),$("#red-ui-workspace-chart svg").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#red-ui-workspace-toolbar").css({"pointer-events":"none",filter:"opacity(60%)"}),$("#red-ui-palette-container").css({"pointer-events":"none",filter:"opacity(60%)"}),$(".red-ui-sidebar-shade").show())},onhide:function(e){i.push(e.id);var t=JSON.parse(RED.settings.getLocal("hiddenTabs")||"{}");t[e.id]=!0,RED.settings.setLocal("hiddenTabs",JSON.stringify(t)),RED.events.emit("workspace:hide",{workspace:e.id})},onshow:function(e){u(e.id);var t=JSON.parse(RED.settings.getLocal("hiddenTabs")||"{}");delete t[e.id],RED.settings.setLocal("hiddenTabs",JSON.stringify(t)),RED.events.emit("workspace:show",{workspace:e.id})},minimumActiveTabWidth:150,scrollable:!0,addButton:"core:add-flow",addButtonCaption:RED._("workspace.addFlow"),menu:function(){var e=[{id:"red-ui-tabs-menu-option-search-flows",label:RED._("workspace.listFlows"),onselect:"core:list-flows"},{id:"red-ui-tabs-menu-option-search-subflows",label:RED._("workspace.listSubflows"),onselect:"core:list-subflows"},null,{id:"red-ui-tabs-menu-option-add-flow",label:RED._("workspace.addFlow"),onselect:"core:add-flow"},{id:"red-ui-tabs-menu-option-add-flow-right",label:RED._("workspace.addFlowToRight"),onselect:"core:add-flow-to-right"},null,{id:"red-ui-tabs-menu-option-add-hide-flows",label:RED._("workspace.hideFlow"),onselect:"core:hide-flow"},{id:"red-ui-tabs-menu-option-add-hide-other-flows",label:RED._("workspace.hideOtherFlows"),onselect:"core:hide-other-flows"},{id:"red-ui-tabs-menu-option-add-show-all-flows",label:RED._("workspace.showAllFlows"),onselect:"core:show-all-flows"},{id:"red-ui-tabs-menu-option-add-hide-all-flows",label:RED._("workspace.hideAllFlows"),onselect:"core:hide-all-flows"},{id:"red-ui-tabs-menu-option-add-show-last-flow",label:RED._("workspace.showLastHiddenFlow"),onselect:"core:show-last-hidden-flow"}];return 0<i.length&&e.unshift({label:RED._("workspace.hiddenFlows",{count:i.length}),onselect:"core:list-hidden-flows"}),e}}),c=0}function f(){$("#red-ui-workspace .red-ui-tabs").hide(),$("#red-ui-workspace-chart").hide(),$("#red-ui-workspace-footer").children().hide()}function h(e){p(e||a)}function g(e){b(e,!1)}function m(e){b(e,!0)}function b(e,t){var o,i=RED.nodes.workspace(e||a);i&&i.disabled!==t&&(o={disabled:i.disabled},i.disabled=t,$("#red-ui-tab-"+i.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!i.disabled),e&&e!==a||$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!i.disabled),t={t:"edit",changes:o,node:i,dirty:RED.nodes.dirty()},i.changed=!0,RED.history.push(t),RED.events.emit("flows:change",i),RED.nodes.dirty(!0),RED.sidebar.config.refresh(),(e=RED.view.selection()).nodes||e.links||i.id!==a||RED.sidebar.info.refresh(i),o.hasOwnProperty("disabled")&&(RED.nodes.eachNode(function(e){e.z===i.id&&(e.dirty=!0)}),RED.view.redraw()))}function v(e){e?(n.contains(e.id)&&n.removeTab(e.id),e.id===a&&(a=0)):l(RED.nodes.workspace(a))}function y(e){var t=e.filter(function(e){return void 0!==RED.nodes.workspace(e)}),o=RED.nodes.getWorkspaceOrder();JSON.stringify(t)!==JSON.stringify(o)&&(RED.nodes.setWorkspaceOrder(t),RED.events.emit("flows:reorder",t)),n.order(e)}return{init:function(){$('<ul id="red-ui-workspace-tabs"></ul>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-tabs-shade" class="hide"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-chart" tabindex="1"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-toolbar"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-workspace-footer" class="red-ui-component-footer"></div>').appendTo("#red-ui-workspace"),$('<div id="red-ui-editor-shade" class="hide"></div>').appendTo("#red-ui-workspace"),e(),RED.events.on("sidebar:resize",n.resize),RED.actions.add("core:show-next-tab",function(){var e=a;n.nextTab(),e!==a&&s(e)}),RED.actions.add("core:show-previous-tab",function(){var e=a;n.previousTab(),e!==a&&s(e)}),RED.menu.setAction("menu-item-workspace-delete",function(){l(RED.nodes.workspace(a))}),$(window).on("resize",function(){n.resize()}),RED.actions.add("core:add-flow",function(e){d(void 0,void 0,e?e.index:void 0)}),RED.actions.add("core:add-flow-to-right",function(e){d(void 0,void 0,n.activeIndex()+1)}),RED.actions.add("core:edit-flow",h),RED.actions.add("core:remove-flow",v),RED.actions.add("core:enable-flow",g),RED.actions.add("core:disable-flow",m),RED.actions.add("core:hide-flow",function(){var e=n.selection(),t=(0===e.length&&(e=[{id:a}]),[]);e.forEach(function(e){RED.workspaces.hide(e.id),i.pop(),t.push(e.id)}),0<t.length&&i.push(t),n.clearSelection()}),RED.actions.add("core:hide-other-flows",function(){var e=n.selection(),t=(0===e.length&&(e=[{id:a}]),new Set(e.map(function(e){return e.id}))),e=n.listTabs(),o=[];e.forEach(function(e){t.has(e)||(RED.workspaces.hide(e),i.pop(),o.push(e))}),0<o.length&&i.push(o)}),RED.actions.add("core:hide-all-flows",function(){var e=n.listTabs();e.forEach(function(e){RED.workspaces.hide(e),i.pop()}),0<e.length&&i.push(e),n.clearSelection()}),RED.actions.add("core:show-all-flows",function(){n.listTabs().forEach(function(e){RED.workspaces.show(e,null,!0)})}),RED.actions.add("core:show-last-hidden-flow",function(){var e,t=i.pop();t&&("string"==typeof t?RED.workspaces.show(t):(e=t.pop(),t.forEach(function(e){RED.workspaces.show(e,null,!0)}),setTimeout(function(){RED.workspaces.show(e)},150)))}),RED.actions.add("core:list-hidden-flows",function(){RED.actions.invoke("core:search","is:hidden ")}),RED.actions.add("core:list-flows",function(){RED.actions.invoke("core:search","type:tab ")}),RED.actions.add("core:list-subflows",function(){RED.actions.invoke("core:search","type:subflow ")}),RED.actions.add("core:go-to-previous-location",function(){0<o&&(o===t.length&&t.push(a),RED.workspaces.show(t[--o],!0))}),RED.actions.add("core:go-to-next-location",function(){o<t.length-1&&RED.workspaces.show(t[++o],!0)}),f()},add:d,remove:v,delete:l,order:y,edit:h,contains:function(e){return n.contains(e)},count:function(){return c},active:function(){return a},selection:function(){return n.selection()},hide:function(e){e=e||a,n.contains(e)&&n.hideTab(e)},isHidden:function(e){return i.includes(e)},show:function(e,t,o){if(!n.contains(e)){var i=RED.nodes.subflow(e);if(!i)return;d({type:"subflow",id:e,icon:"red/images/subflow_tab.svg",label:i.name,closeable:!0},null,n.activeIndex()+1),u(e)}o?n.showTab(e):(t||a===e||s(a),n.activateTab(e))},refresh:function(){RED.nodes.eachWorkspace(function(e){n.renameTab(e.id,e.label),$("#red-ui-tab-"+e.id.replace(".","-")).attr("flowname",e.label)}),RED.nodes.eachSubflow(function(e){n.contains(e.id)&&n.renameTab(e.id,e.name)}),RED.sidebar.config.refresh()},resize:function(){n.resize()},enable:g,disable:m}}(),RED.statusBar=function(){var o,i,n={};return{init:function(){o=$('<span class="red-ui-statusbar-bucket red-ui-statusbar-bucket-left">').appendTo("#red-ui-workspace-footer"),i=$('<span class="red-ui-statusbar-bucket red-ui-statusbar-bucket-right">').appendTo("#red-ui-workspace-footer")},add:function(e){n[e.id]=e;var t=$('<span class="red-ui-statusbar-widget"></span>');e.element.appendTo(t),"left"===e.align?o.append(t):"right"===e.align&&i.prepend(t)}}}(),RED.view=function(){var R,T,C,u,w,j,m,n,a,r,s,d,l,x,c,p,f,t,L=5e3,S=5e3,h=.75,D=1,P=100,A=30,b=650,v=1e3,y=0,M=[],z=0,B={},G=20,F=!1,U=!1,O=null,J=[],V=[],q=[],W={},g=null,K=null,H=[],X={},Y=null,E=null,Z=null,Q=null,ee=0,te=null,oe=[0,0],ie=null,N=0,ne=null,ae=null,re=null,se=null,de=!1,le=null,ce=null,ue=0,pe=0,fe=[],he=null,ge=-1,me=!1,be=[],ve="",ye={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3",gray:"#d3d3d3"},_=1,k=0,I=(c=new Set,p=[],f={add:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)f.add(e[t]);else if(!c.has(e.id)){p.push({n:e}),c.add(e.id);for(var o=RED.nodes.getNodeLinks(e.id,_).concat(RED.nodes.getNodeLinks(e.id,k)),t=0,i=o.length;t<i;t++){var n=o[t];(n.source===e&&c.has(n.target.id)||n.target===e&&c.has(n.source.id))&&we.add(n)}}},remove:function(e,t){if(c.has(e.id)){if(c.delete(e.id),void 0!==t&&p[t].n===e)p.splice(t,1);else for(var o=0;o<p.length;o++)if(p[o].n===e){p.splice(o,1);break}for(var i=RED.nodes.getNodeLinks(e.id,_).concat(RED.nodes.getNodeLinks(e.id,k)),o=0,n=i.length;o<n;o++)we.remove(i[o])}},clear:function(){c.clear(),p=[]},length:function(){return p.length},get:function(e){return p[e]},forEach:function(e){p.forEach(e)},nodes:function(){return p.map(function(e){return e.n})}}),we=(t=new Set,{add:function(e){t.add(e),e.selected=!0},remove:function(e){t.delete(e),e.selected=!1},clear:function(){t.forEach(function(e){e.selected=!1}),t.clear()},length:function(){return t.size},forEach:function(e){t.forEach(e)},has:function(e){return t.has(e)},toArray:function(){return Array.from(t)}});function Ee(){for(var e=[],t=0;t<L;t+=+G)e.push(t);n.selectAll("line.red-ui-workspace-chart-grid-h").remove(),n.selectAll("line.red-ui-workspace-chart-grid-h").data(e).enter().append("line").attr({class:"red-ui-workspace-chart-grid-h",x1:0,x2:L,y1:function(e){return e},y2:function(e){return e}}),n.selectAll("line.red-ui-workspace-chart-grid-v").remove(),n.selectAll("line.red-ui-workspace-chart-grid-v").data(e).enter().append("line").attr({class:"red-ui-workspace-chart-grid-v",y1:0,y2:L,x1:function(e){return e},x2:function(e){return e}})}function De(e){ge=-1;for(var t=0;t<e.length;t++){var o=e[t];o.el=r.append("svg:path").attr("class","red-ui-flow-drag-line"),("link out"===o.node.type&&o.portType===k||"link in"===o.node.type&&o.portType===_)&&(o.el.attr("class","red-ui-flow-link-link red-ui-flow-drag-line"),o.virtualLink=!0,ge=o.portType===k?_:k),x.push(o)}-1!==ge&&J.forEach(function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)})}function Re(){for(-1!==ge&&J.forEach(function(e){"link in"!==e.type&&"link out"!==e.type||(e.dirty=!0)}),ge=-1;x.length;){var e=x.pop();e.el&&e.el.remove()}}function xe(){for(var e=RED.workspaces.active(),i=(0!==e?((J=RED.nodes.filterNodes({z:e})).forEach(function(e,t){e._index=t}),V=RED.nodes.filterLinks({source:{z:e},target:{z:e}}),(H=RED.nodes.groups(e)||[]).forEach(function(e,t){e._index=t,e.g?(e._root=e.g,e._depth=1):(e._root=e.id,e._depth=0)})):(J=[],V=[],H=[]),!1);i=!1,H.forEach(function(e){var t,o;!e.g||(t=RED.nodes.group(e.g))&&(o=t._depth,e._depth!==o+1&&(e._depth=o+1,i=!0),e._root!==t._root&&(e._root=t._root,i=!0))}),i;);H.sort(function(e,t){return e._root===t._root?e._depth-t._depth:e._index-t._index}),l.selectAll(".red-ui-flow-group").data(H,function(e){return e.id}).sort(function(e,t){return e._root===t._root?e._depth-t._depth:e._index-t._index})}function $e(c,e,u,t,o){var i,p,n,a,r,s=t-e,d=u-c,f=Math.sqrt(s*s+d*d),l=h;return 0<d*o?f<P&&(l=.75-(P-f)/P*.75):l=.4-.2*Math.max(0,(P-Math.min(Math.abs(d),Math.abs(s)))/P),0<d*o?"M "+c+" "+e+" C "+(c+o*(P*l))+" "+(e+0*A)+" "+(u-o*l*P)+" "+(t-0*A)+" "+u+" "+t:(f=Math.floor(u-d/2),d=Math.floor(t-s/2),i=A/2,a=(t+(d=0==s?t+A:d))/2,p=c+o*P*l,n=0<s?Math.min(a-s/2,e+i):Math.max(a-s/2,e-i),o=u-o*P*l,l=0<s?Math.max(a,t-i):Math.min(a,t+i),a=0<s?1:-1,(r=[[r=(c+p)/2,e],[p,0<s?Math.max(e,n-i):Math.min(e,n+i)],[r,0<s?Math.min(d,n+i):Math.max(d,n-i)],[o,0<s?Math.max(d,l-i):Math.min(d,l+i)],[(u+o)/2,t]])[2][1]===n+a*i&&(Math.abs(s)<10*i&&(r[1][1]=n-a*i/2,r[3][1]=l-a*i/2),r[2][0]=p),"M "+c+" "+e+" C "+r[0][0]+" "+r[0][1]+" "+r[1][0]+" "+r[1][1]+" "+p+" "+n+" S "+r[2][0]+" "+r[2][1]+" "+f+" "+d+" S "+r[3][0]+" "+r[3][1]+" "+o+" "+l+" S "+r[4][0]+" "+r[4][1]+" "+u+" "+t)}function _e(e){var t=/^subflow:(.+)$/.exec(e);if(O&&t){if(t[1]===O.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(t[1],O.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var o={id:RED.nodes.id(),z:RED.workspaces.active()};if(o.type=e,o._def=RED.nodes.getType(o.type),t){e=RED.nodes.subflow(t[1]);o.name="",o.inputs=e.in.length,o.outputs=e.out.length}else{for(var i in o.inputs=o._def.inputs||0,o.outputs=o._def.outputs,o._def.defaults)o._def.defaults.hasOwnProperty(i)&&void 0!==o._def.defaults[i].value&&(o[i]=JSON.parse(JSON.stringify(o._def.defaults[i].value)));if(o._def.onadd)try{o._def.onadd.call(o)}catch(e){console.log("Definition error: "+o.type+".onadd:",e)}}o.changed=!0,o.moved=!0,o.w=P,o.h=Math.max(A,15*(o.outputs||0)),o.resize=!0;t={t:"add",nodes:[o.id],dirty:RED.nodes.dirty()};return!O||(e=RED.subflow.refresh(!0))&&(t.subflow={id:O.id,changed:O.changed,instances:e.instances}),{node:o,historyEvent:t}}function ke(){var e,t;if(RED.view.DEBUG&&console.warn("canvasMouseDown",N),N!==RED.state.SELECTING_NODE){if(1===d3.event.button)return N=RED.state.PANNING,ie=[d3.event.pageX,d3.event.pageY],void(fe=[w.scrollLeft(),w.scrollTop()]);E||Y||Z||(we.clear(),Me()),0===N&&ne&&(ne.remove(),ne=null),0!==N&&N!==RED.state.QUICK_JOINING||!d3.event.touches&&0!==d3.event.button||!d3.event.metaKey&&!d3.event.ctrlKey?0!==N||!d3.event.touches&&0!==d3.event.button||d3.event.metaKey||d3.event.ctrlKey?0===N&&2===d3.event.button&&(d3.event.metaKey||d3.event.ctrlKey)&&(Pe(),N=RED.state.SLICING,e=d3.mouse(this),ae=m.append("path").attr("class","nr-ui-view-slice").attr("d",`M${e[0]} `+e[1]),re=e,RED.view.redraw()):z||(e=d3.mouse(this),ne=m.append("rect").attr("ox",e[0]).attr("oy",e[1]).attr("rx",1).attr("ry",1).attr("x",e[0]).attr("y",e[1]).attr("width",0).attr("height",0).attr("class","nr-ui-view-lasso"),d3.event.preventDefault()):(d3.event.stopPropagation(),Pe(),t=$t((e=d3.mouse(this))[0],e[1]),Te({position:e,group:t=0<x.length?t||RED.nodes.group(x[0].node.g):t}))}else d3.event.stopPropagation()}function Te(e){function l(){var e,t,o;he&&(he.el||(he.el=r.append("svg:path").attr("class","red-ui-flow-drag-line")),e=he.portType===k&&he.node.outputs||1,t=he.port,o=he.portType===k?1:-1,he.el.attr("d",$e(he.node.x+o*he.node.w/2,he.node.y+(-(e-1)/2*13+13*t),p[0]-o*P/2,p[1],o)))}var t,c,u,p=(e=e||{}).position||be,f=e.splice,h=e.group,g=e.touchTrigger,e=(h&&!h.active&&(Et(h,!1),Dt(h),RED.view.redraw()),p[0]),i=p[1],o=(RED.settings.get("editor").view["view-snap-grid"]&&(p[0]=Math.round(p[0]/G)*G,p[1]=Math.round(p[1]/G)*G),$("#red-ui-main-container").position());N!==RED.state.QUICK_JOINING&&(N=RED.state.QUICK_JOINING,$(window).on("keyup",Ke)),se&&se.remove(),(se=m.append("g").attr("transform","translate("+(p[0]-P/2)+","+(p[1]-A/2)+")")).append("rect").attr("class","red-ui-flow-node-placeholder").attr("rx",5).attr("ry",5).attr("width",P).attr("height",A).attr("fill","none"),0<x.length&&(t=x[0].virtualLink?{type:"link in"===x[0].node.type?"link out":"link in"}:x[0].portType===k?{input:!0}:{output:!0},he={node:x[0].node,port:x[0].port,portType:x[0].portType},x[0].virtualLink&&(he.virtualLink=!0),Re()),f&&(t={input:!0,output:!0});he&&l(),RED.typeSearch.show({x:d3.event.clientX-o.left-P/2-(e-p[0]),y:d3.event.clientY-o.top+A/2+5-(i-p[1]),disableFocus:g,filter:t,move:function(e,t){var o;se&&(o=d3.transform(se.attr("transform")).translate,se.attr("transform","translate("+(o[0]+e)+","+(o[1]+t)+")"),p[0]+=e,p[1]+=t,l())},cancel:function(){he&&(he.el&&he.el.remove(),he=null),se&&se.remove(),We(),Me(),Re(),Lt()},add:function(e,t){g&&(t=!1,We());var o,i,n,a,r,s,d,e=_e(e);e&&(t&&(N=RED.state.QUICK_JOINING),o=e.node,e=e.historyEvent,o.x=p[0],o.y=p[1],void 0===(r=RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label"))||o._def.hasOwnProperty("showLabel")&&!o._def.showLabel||o._def.defaults.hasOwnProperty("l")||(o.l=r),he?(r=null,(i=he).portType===k&&(0<o.inputs||i.virtualLink)?(r=i.node,s=i.port,d=o):i.portType===_&&(0<o.outputs||i.virtualLink)&&(r=o,d=i.node,s=0),null!==r?(i.virtualLink?(e={t:"multi",events:[e]},n=$.extend(!0,{},{v:r.links}).v,a=$.extend(!0,{},{v:d.links}).v,r.links.push(d.id),d.links.push(r.id),r.dirty=!0,d.dirty=!0,e.events.push({t:"edit",node:r,dirty:RED.nodes.dirty(),changed:r.changed,changes:{links:n}}),e.events.push({t:"edit",node:d,dirty:RED.nodes.dirty(),changed:d.changed,changes:{links:a}}),r.changed=!0,d.changed=!0):(RED.nodes.addLink(n={source:r,sourcePort:s,target:d}),e.links=[n]),t?(he.node=o,he.port=0):(he.el.remove(),he=null,N===RED.state.QUICK_JOINING&&(i.portType===k&&0<o.outputs?De([{node:o,port:0,portType:k}]):!he&&i.portType===_&&0<o.inputs?De([{node:o,port:0,portType:_}]):We()))):(Re(),We())):t?0<o.outputs?he={node:o,port:0,portType:k}:0<o.inputs?he={node:o,port:0,portType:_}:We():N===RED.state.QUICK_JOINING&&(0<o.outputs?De([{node:o,port:0,portType:k}]):0<o.inputs?De([{node:o,port:0,portType:_}]):We()),RED.nodes.add(o),RED.editor.validateNode(o),h&&(RED.group.addToGroup(h,o),(e="multi"!==e.t?{t:"multi",events:[e]}:e).events.push({t:"addToGroup",group:h,nodes:o})),f&&(We(),RED.nodes.removeLink(f),a={source:f.source,sourcePort:f.sourcePort,target:o},r={source:o,sourcePort:0,target:f.target},RED.nodes.addLink(a),RED.nodes.addLink(r),e.links=(e.links||[]).concat([a,r]),e.removedLinks=[f]),RED.history.push(e),RED.nodes.dirty(!0),Pe(),o.selected=!0,h&&(Et(h,!1),Dt(h)),I.add(o),xe(),Me(),Lt(),void 0!==c&&(s=c+u/2,(d=o.x-o.w/2-s)!=2*G&&(o.x=o.x+2*G-d,o.dirty=!0,o.x=Math.ceil(o.x/G)*G,Lt())),t?(void 0===c&&setTimeout(function(){RED.typeSearch.refresh({filter:{input:!0}})},100),c=o.x,u=o.w,p[0]=o.x+o.w/2+P/2+2*G,se.attr("transform","translate("+(p[0]-P/2)+","+(p[1]-A/2)+")"),l()):se.remove())}}),xe(),Me(),Lt()}function Ce(){var c;if(N===RED.state.PANNING)return r=[d3.event.pageX,d3.event.pageY],d3.event.touches&&(r=[(s=d3.event.touches.item(0)).pageX,s.pageY]),s=[ie[0]-r[0],ie[1]-r[1]],w.scrollLeft(fe[0]+s[0]),void w.scrollTop(fe[1]+s[1]);if(ie=d3.touches(this)[0]||d3.mouse(this),ne)return r=parseInt(ne.attr("ox")),s=parseInt(ne.attr("oy")),e=parseInt(ne.attr("x")),o=parseInt(ne.attr("y")),r=ie[0]<r?r-(e=ie[0]):ie[0]-e,s=ie[1]<s?s-(o=ie[1]):ie[1]-o,void ne.attr("x",e).attr("y",o).attr("width",r).attr("height",s);if(N!==RED.state.SLICING)if(N!==RED.state.SELECTING_NODE){if(N==RED.state.QUICK_JOINING||N==RED.state.IMPORT_DRAGGING||N==RED.state.DETACHED_DRAGGING||E||Z||0!==we.length()){if(N==RED.state.JOINING||N===RED.state.QUICK_JOINING){if(0===x.length&&null!==Q){if(d3.event.shiftKey){var e,l=[],u=[];for(0<we.length()?we.forEach(function(e){(Q===k&&e.source===E&&e.sourcePort===ee||Q===_&&e.target===E)&&u.push(e)}):(e=Q===k?{source:E,sourcePort:ee}:{target:E},u=RED.nodes.filterLinks(e)),d=0;d<u.length;d++){var p=u[d];RED.nodes.removeLink(p),l.push({link:p,node:Q===k?p.target:p.source,port:Q===k?0:p.sourcePort,portType:Q===k?_:k})}0===l.length?(We(),Lt()):(De(l),N=0,xe(),Lt(),N=RED.state.JOINING)}else E&&!he&&De([{node:E,port:ee,portType:Q}]);we.clear()}for(i=ie,d=0;d<x.length;d++){var t=x[d],f=t.portType===k&&t.node.outputs||1,h=t.port,g=t.portType===k?1:-1;t.el.attr("d",$e(t.node.x+g*t.node.w/2,t.node.y+(-(f-1)/2*13+13*h),i[0],i[1],g))}d3.event.preventDefault()}else if(N==RED.state.MOVING){i=d3.mouse(document.body),isNaN(i[0])&&(i=d3.touches(document.body)[0]);var o=(oe[0]-i[0])*(oe[0]-i[0])+(oe[1]-i[1])*(oe[1]-i[1]);(3<o&&!ce||ce&&10<o)&&(N=RED.state.MOVING_ACTIVE,pe=0,U=!1,1===I.length()&&(c=I.get(0),U=c.n.hasOwnProperty("_def")&&(c.n.hasOwnProperty("inputs")&&0<c.n.inputs||!c.n.hasOwnProperty("inputs")&&0<c.n._def.inputs)&&(c.n.hasOwnProperty("outputs")&&0<c.n.outputs||!c.n.hasOwnProperty("outputs")&&0<c.n._def.outputs)&&0===RED.nodes.filterLinks({source:c.n}).length&&0===RED.nodes.filterLinks({target:c.n}).length))}else if(N==RED.state.MOVING_ACTIVE||N==RED.state.IMPORT_DRAGGING||N==RED.state.DETACHED_DRAGGING){for(var i=ie,n=0,m=0,b=L,v=S,y=0;y<I.length();y++)c=I.get(y),d3.event.shiftKey&&(c.n.ox=c.n.x,c.n.oy=c.n.y),c.n.x=i[0]+c.dx,c.n.y=i[1]+c.dy,c.n.dirty=!0,v="group"===c.n.type?(!1!==c.n.groupMoved&&(c.n.groupMoved=!0),RED.group.markDirty(c.n),n=Math.min(c.n.x-5,n),m=Math.min(c.n.y-5,m),b=Math.max(c.n.x+c.n.w+5,b),Math.max(c.n.y+c.n.h+5,v)):(n=Math.min(c.n.x-c.n.w/2-5,n),m=Math.min(c.n.y-c.n.h/2-5,m),b=Math.max(c.n.x+c.n.w/2+5,b),Math.max(c.n.y+c.n.h/2+5,v));if(0!==n||0!==m)for(d=0;d<I.length();d++)(c=I.get(d)).n.x-=n,c.n.y-=m;if(b!==L||v!==S)for(d=0;d<I.length();d++)(c=I.get(d)).n.x-=b-L,c.n.y-=v-S;var a=[0,0];if(F!=d3.event.shiftKey&&0<I.length()){for(var r,s,d=0;c=I.get(d++),d<I.length()&&"group"===c.n.type;);if("group"===c.n.type?(a[0]=c.n.x-G*Math.floor(c.n.x/G)-G/2,a[1]=c.n.y-G*Math.floor(c.n.y/G)-G/2):(r=c.n.x-(G*Math.round((c.n.x-c.n.w/2)/G)+c.n.w/2),s=c.n.x-(G*Math.round((c.n.x+c.n.w/2)/G)-c.n.w/2),Math.abs(r)<Math.abs(s)?a[0]=r:a[0]=s,a[1]=c.n.y-G*Math.round(c.n.y/G)),0!==a[0]||0!==a[1])for(d=0;d<I.length();d++)(c=I.get(d)).n.x-=a[0],c.n.y-=a[1],c.n.x==c.n.ox&&c.n.y==c.n.oy&&(c.dirty=!1)}1===I.length()&&"group"!==I.get(0).n.type&&(c=I.get(0),U&&(T=T||setTimeout(function(){for(var e,t=[],o=1/0,i=null,n=c.n.x,a=c.n.y,t=j[0][0].getIntersectionList?((e=j[0][0].createSVGRect()).x=n*D,e.y=a*D,e.width=1,e.height=1,j[0][0].getIntersectionList(e,j[0][0])):RED.view.getLinksAtPoint(n*D,a*D),r=0;r<t.length;r++)if(d3.select(t[r]).classed("red-ui-flow-link-background"))for(var s=t[r].getTotalLength(),d=0;d<s;d+=10){var l=t[r].getPointAtLength(d),l=(l.x-n)*(l.x-n)+(l.y-a)*(l.y-a);l<200&&l<o&&(o=l,i=t[r])}R&&R!==i&&d3.select(R.parentNode).classed("red-ui-flow-link-splice",!1),i?d3.select(i.parentNode).classed("red-ui-flow-link-splice",!0):d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),R=i,T=null},100)),"subflow"!==c.n.type&&!c.n.g&&H&&(C=C||setTimeout(function(){K=$t(c.n.x,c.n.y);for(var e=0;e<H.length;e++){var t=H[e];t===K?(t.hovered=!0,t.dirty=!0):t.hovered&&(t.hovered=!1,t.dirty=!0)}C=null},50)))}0!==N&&Lt()}}else d3.event.stopPropagation();else ae&&20<Math.max(1,Math.abs(re[0]-ie[0]))*Math.max(1,Math.abs(re[1]-ie[1]))&&(e=ae.attr("d"),e+=" L"+ie[0]+" "+ie[1],ae.attr("d",e),re=ie)}function je(){var o,i,n,a;if(be=[d3.event.offsetX/D,d3.event.offsetY/D],RED.view.DEBUG&&console.warn("canvasMouseUp",N),N!==RED.state.PANNING)if(N!==RED.state.SELECTING_NODE){if(N!==RED.state.QUICK_JOINING){if(E&&N==RED.state.JOINING){for(var c=[],e=0;e<x.length;e++)x[e].link&&c.push(x[e].link);0<c.length&&(l={t:"delete",links:c,dirty:RED.nodes.dirty()},RED.history.push(l),RED.nodes.dirty(!0)),Re()}if(ne?(o=parseInt(ne.attr("x")),i=parseInt(ne.attr("y")),n=o+parseInt(ne.attr("width")),a=i+parseInt(ne.attr("height")),t=g,d3.event.shiftKey||(Pe(),t&&o<t.x+t.w&&n>t.x&&i<t.y+t.h&&a>t.y&&(Dt(t),g.selected=!0)),H.forEach(function(e){if(!e.selected&&e.x>o&&e.x+e.w<n&&e.y>i&&e.y+e.h<a&&(!g||RED.group.contains(g,e))){for(;e.g&&(!g||e.g!==g.id);)e=RED.nodes.group(e.g);e.selected||Et(e,!0)}}),J.forEach(function(e){if(!e.selected&&e.x>o&&e.x<n&&e.y>i&&e.y<a&&(!g||RED.group.contains(g,e)))if(!e.g||g&&e.g===g.id)e.selected=!0,e.dirty=!0,I.add(e);else{for(var t=RED.nodes.group(e.g);t.g&&(!g||t.g!==g.id);)t=RED.nodes.group(t.g);t.selected||Et(t,!0)}}),O&&(O.in.forEach(function(e){e.selected=e.x>o&&e.x<n&&e.y>i&&e.y<a,e.selected&&(e.dirty=!0,I.add(e))}),O.out.forEach(function(e){e.selected=e.x>o&&e.x<n&&e.y>i&&e.y<a,e.selected&&(e.dirty=!0,I.add(e))}),O.status&&(O.status.selected=O.status.x>o&&O.status.x<n&&O.status.y>i&&O.status.y<a,O.status.selected&&(O.status.dirty=!0,I.add(O.status)))),Me(),ne.remove(),ne=null):N!=RED.state.DEFAULT||null!=Y||d3.event.ctrlKey||d3.event.metaKey?ae&&(Be(),ae.remove(),ae=null,RED.view.redraw(!0)):(Pe(),Me()),N==RED.state.MOVING_ACTIVE&&0<I.length()){var t=null;if(K){for(var r=0;r<I.length();r++){var s=I.get(r);RED.group.addToGroup(K,s.n)}(t=K).hovered=!1,Dt(K),g.selected=!0,K=null}for(var d,u,p=[],r=0;r<I.length();r++)(s=I.get(r)).ox===s.n.x&&s.oy===s.n.y||(p.push({n:s.n,ox:s.ox,oy:s.oy,moved:s.n.moved}),s.n.dirty=!0,s.n.moved=!0);0<p.length&&N==RED.state.MOVING_ACTIVE&&(l={t:"move",nodes:p,dirty:RED.nodes.dirty()},R&&(d=d3.select(R).data()[0],RED.nodes.removeLink(d),f={source:d.source,sourcePort:d.sourcePort,target:I.get(0).n},u={source:I.get(0).n,sourcePort:0,target:d.target},RED.nodes.addLink(f),RED.nodes.addLink(u),l.links=[f,u],l.removedLinks=[d],xe()),t&&(l.addToGroup=t),RED.nodes.dirty(!0),RED.history.push(l))}if(N==RED.state.MOVING||N==RED.state.MOVING_ACTIVE||N==RED.state.DETACHED_DRAGGING){if(N===RED.state.DETACHED_DRAGGING){for(p=[],r=0;r<I.length();r++)(s=I.get(r)).ox===s.n.x&&s.oy===s.n.y||(p.push({n:s.n,ox:s.ox,oy:s.oy,moved:s.n.moved}),s.n.dirty=!0,s.n.moved=!0);var f=RED.history.peek(),l={t:"move",nodes:p,dirty:RED.nodes.dirty()};("multi"===f.t?f.events:RED.history).push(l)}for(e=0;e<I.length();e++){var h=I.get(e);delete h.ox,delete h.oy}}N==RED.state.IMPORT_DRAGGING&&(xe(),RED.nodes.dirty(!0)),We(),Lt()}}else d3.event.stopPropagation();else We()}function Le(){D<2&&e(D+.1)}function Se(){.3<D&&e(D-.1)}function Oe(){e(1)}function e(e){var t=[w.width(),w.height()],o=[w.scrollLeft(),w.scrollTop()],i=[(o[0]+t[0]/2)/D,(o[1]+t[1]/2)/D],t=(D=e,[(o[0]+t[0]/2)/D,(o[1]+t[1]/2)/D]),t=[(t[0]-i[0])*D,(t[1]-i[1])*D];w.scrollLeft(o[0]-t[0]),w.scrollTop(o[1]-t[1]),RED.view.navigator.resize(),Lt(),RED.settings.get("editor.view.view-store-zoom")&&RED.settings.setLocal("zoom-level",e.toFixed(1))}function Ne(){if(N!==RED.state.MOVING&&N!==RED.state.MOVING_ACTIVE){if(N===RED.state.DETACHED_DRAGGING){for(var e=0;e<I.length();e++){var t=I.get(e);t.n.x=t.ox,t.n.y=t.oy}Pe(),RED.history.pop(),N=0}else N===RED.state.IMPORT_DRAGGING?(Pe(),RED.history.pop(),N=0):N===RED.state.SLICING?(ae&&(ae.remove(),ae=null,We()),Pe()):ne?(ne.remove(),ne=null):(g?Rt:Pe)();Lt()}}function Ie(){var e;N===RED.state.SELECTING_NODE&&u.single||(we.clear(),g?(e=g,Pe(),Dt(e),RED.group.getNodes(e,!1).forEach(function(e){"group"===e.type?Et(e,!0,!0):(I.add(e),e.selected=!0,e.dirty=!0)}),g.selected=!0):(Pe(),Rt(),H.forEach(function(e){e.g?(e.selected=!1,e.dirty=!0):(Et(e,!0),e.selected||(e.selected=!0,e.dirty=!0))}),J.forEach(function(e){N===RED.state.SELECTING_NODE&&u.filter&&!u.filter(e)||e.g||e.selected||(e.selected=!0,e.dirty=!0,I.add(e))}),N!==RED.state.SELECTING_NODE&&O&&(O.in.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,I.add(e))}),O.out.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,I.add(e))}),O.status&&(O.status.selected||(O.status.selected=!0,O.status.dirty=!0,I.add(O.status))))),N!==RED.state.SELECTING_NODE&&Me(),Lt())}function Pe(){RED.view.DEBUG&&console.warn("clearSelection",N,"movingSet.length():",I.length());for(var e=0;e<I.length();e++){var t=I.get(e);t.n.dirty=!0,t.n.selected=!1}I.clear(),we.clear(),g&&(g.active=!1,g.dirty=!0,g=null),H.forEach(function(e){e.selected=!1,e.dirty=!0})}var Ae=null;function Me(){var e={},t=RED.workspaces.active(),o=RED.workspaces.selection();if(0!==t)if(0===o.length){e=Pt(),V=RED.nodes.filterLinks({source:{z:t},target:{z:t}});RED.nodes.getWorkspaceOrder();var i={};q=[],Object.keys(W).forEach(function(e){W[e].dirty=!0}),W={};for(var n=0;n<I.length();n++){var a,r,s=I.get(n);("link out"===s.n.type&&"return"!==s.n.mode||"link in"===s.n.type)&&s.n.z===t&&(a=s.n,W[a.id]=a,r={},a.links.forEach(function(e){e=RED.nodes.node(e);e&&("link out"===a.type?e.z===a.z?i[a.id+":"+e.id]||(V.push({source:a,sourcePort:0,target:e,link:!0}),i[a.id+":"+e.id]=!0,(W[e.id]=e).dirty=!0):(r[e.z]=r[e.z]||[],r[e.z].push(e)):e.z===a.z?i[e.id+":"+a.id]||(V.push({source:e,sourcePort:0,target:a,link:!0}),i[e.id+":"+a.id]=!0,(W[e.id]=e).dirty=!0):(r[e.z]=r[e.z]||[],r[e.z].push(e)))}),0<Object.keys(r).length&&q.push({refresh:Math.floor(1e4*Math.random()),node:a,links:r}))}0===q.length&&0<we.length()&&we.forEach(function(e){e.link&&(V.push(e),W[e.source.id]=e.source,e.source.dirty=!0,W[e.target.id]=e.target,e.target.dirty=!0)})}else e.flows=o;o=t+":"+JSON.stringify(e,function(e,t){return"nodes"===e||"flows"===e?t.map(function(e){return e.id}):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:"links"===e?t.map(function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id}):t});o!==Ae&&(Ae=o,RED.events.emit("view:selection-changed",e))}function ze(){var e;0<I.length()&&("subflow"===(e=I.get(0).n).type?RED.editor.editSubflow(O):"group"===e.type?RED.editor.editGroup(e):RED.editor.edit(e))}function Be(e){if(N!==RED.state.SELECTING_NODE){Ze&&(Ze.remove(),Ze=null);var c=RED.workspaces.selection();if(0<c.length){var u=0;if(c.forEach(function(e){"tab"===e.type&&u++}),u!==RED.workspaces.count()){for(var t={t:"delete",dirty:RED.nodes.dirty(),nodes:[],links:[],groups:[],workspaces:[],subflows:[]},p=RED.nodes.getWorkspaceOrder().slice(0),o=0;o<c.length;o++){var i,n=c[o];n._index=p.indexOf(n.id),RED.workspaces.remove(n),"tab"===n.type?(t.workspaces.push(n),i=RED.nodes.removeWorkspace(n.id)):(i=RED.subflow.removeSubflow(n.id),t.subflows=t.subflows.concat(i.subflows)),t.nodes=t.nodes.concat(i.nodes),t.links=t.links.concat(i.links),t.groups=t.groups.concat(i.groups)}RED.history.push(t),RED.nodes.dirty(!0),xe(),Me(),Lt()}}else if(0<I.length()||0<we.length()){function f(e){e&&(Array.isArray(e)?e:[e]).forEach(function(e){m.push(e),we.remove(e)})}var a,h,g=[],m=[],b=[],v=[],y=[],w=[],r=[],E=(e&&(0<(E=(e=RED.nodes.detachNodes(I.nodes())).newLinks).length&&r.push({t:"add",links:E}),f(e.removedLinks)),RED.nodes.dirty()),s=[];if(0<I.length()){for(o=0;o<I.length();o++)"group"===(l=I.get(o).n).type&&s.push(l);for(o=0;o<s.length;o++)s[o].nodes.forEach(function(e){"group"===e.type&&-1===s.indexOf(e)&&s.push(e)});for(var d,D,l,o=0;o<I.length();o++)(l=I.get(o).n).selected=!1,"group"!==l.type&&"subflow"!==l.type?(l.x<0&&(l.x=25),d=RED.nodes.remove(l.id),g.push(l),f((g=g.concat(d.nodes)).removedLinks),l.g&&(d=RED.nodes.group(l.g),-1===s.indexOf(d)&&(D=d.nodes.indexOf(l),d.nodes.splice(D,1),RED.group.markDirty(d)))):("out"===l.direction?v.push(l):"in"===l.direction?y.push(l):"status"===l.direction&&(h=l),l.dirty=!0);for(o=s.length-1;0<=o;o--){var R=s[o];b.push(R),RED.nodes.removeGroup(R)}0<v.length&&(a=RED.subflow.removeOutput(v))&&f(a.links),1==y.length&&(a=RED.subflow.removeInput())&&f(a.links),h&&(a=RED.subflow.removeStatus())&&f(a.links);e=RED.subflow.refresh(!0);e&&(w=e.instances),I.clear(),(0<g.length||0<v.length||0<y.length||h||0<b.length)&&RED.nodes.dirty(!0)}0<we.length()&&we.forEach(function(e){var t,o;e.link?(t=e.source.id,o=e.target.id,t=e.target.links.indexOf(t),o=e.source.links.indexOf(o),r.push({t:"edit",node:e.source,changed:e.source.changed,changes:{links:$.extend(!0,{},{v:e.source.links}).v}}),r.push({t:"edit",node:e.target,changed:e.target.changed,changes:{links:$.extend(!0,{},{v:e.target.links}).v}}),e.source.changed=!0,e.target.changed=!0,e.target.links.splice(t,1),e.source.links.splice(o,1),e.source.dirty=!0,e.target.dirty=!0):(RED.nodes.removeLink(e),m.push(e))}),RED.nodes.dirty(!0);t={t:"delete",nodes:g,links:m,groups:b,subflowOutputs:v,subflowInputs:y,subflow:{id:O?O.id:void 0,instances:w},dirty:E};h&&(t.subflow.status=h),0<r.length?(r.unshift(t),RED.history.push({t:"multi",events:r})):RED.history.push(t),we.clear(),xe(),Me(),Lt()}}}function Ge(){if(N!==RED.state.SELECTING_NODE){var t=[],e=RED.workspaces.selection();if(0<e.length?(t=[],e.forEach(function(e){"tab"===e.type&&(t.push(e),t=(t=t.concat(RED.nodes.groups(e.id))).concat(RED.nodes.filterNodes({z:e.id})))})):(e=RED.view.selection()).nodes&&e.nodes.forEach(function(e){t.push(e),"group"===e.type&&(t=t.concat(RED.group.getNodes(e,!0)))}),0<t.length){for(var o=[],i=0,n=0,a={},r=0;r<t.length;r++){var s=t[r];if(!a[s.id]&&(a[s.id]=!0,"subflow"!=s.type)){for(var d in"group"===s.type?n++:i++,s._def.defaults)s._def.defaults.hasOwnProperty(d)&&(!s._def.defaults[d].type||(d=RED.nodes.node(s[d]))&&d._def.exclusive&&o.push(RED.nodes.convertNode(d)));o.push(RED.nodes.convertNode(s))}}ve=JSON.stringify(o),RED.menu.setDisabled("menu-item-edit-paste",!1),0<i?RED.notify(RED._("clipboard.nodeCopied",{count:i}),{id:"clipboard"}):0<n&&RED.notify(RED._("clipboard.groupCopied",{count:n}),{id:"clipboard"})}}}function Fe(e,t){for(var o=qe(e),i=0,n=0;n<o.length;n++){var a=Ve(o[n],t)[0];i<a&&(i=a)}return{lines:o,width:i}}var Ue={},Je={};function Ve(e,t){var o="!"+e;if(Ue[t]){if(Je[t][o])return Je[t][o]}else Ue[t]=document.createElement("span"),Ue[t].className=t,Ue[t].style.position="absolute",Ue[t].style.top="-1000px",document.getElementById("red-ui-editor").appendChild(Ue[t]),Je[t]={};Ue[t].textContent=e||"";var e=Ue[t].offsetWidth,i=Ue[t].offsetHeight;return Je[t][o]=[e,i],Je[t][o]}function qe(e){var t=[],o=e.split(/\\n /);if(1<o.length){for(var i=0,i=0;i<o.length-1;i++)/\\$/.test(o[i])?(t.push(o[i]+"\\n "+o[i+1]),i++):t.push(o[i]);i===o.length-1&&t.push(o[o.length-1])}else t=o;return t=t.map(function(e){return e.replace(/\\\\n /g,"\\n ").trim()})}function We(){N=0,R=Q=Y=te=Z=E=null,U=!1,K&&(K.hovered=!1,K=null),d3.selectAll(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),T&&(clearTimeout(T),T=null),C&&(clearTimeout(C),C=null)}function Ke(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(We(),Re(),Lt(),$(window).off("keyup",Ke))}function He(e,t,o,i){RED.view.DEBUG&&console.warn("portMouseDown",N,e,t,o),1!==(i=i||d3.event)&&(N!==RED.state.SELECTING_NODE?(E=e,Q=t,ee=o||0,N!==RED.state.QUICK_JOINING&&(N=RED.state.JOINING,document.body.style.cursor="crosshair",(i.ctrlKey||i.metaKey)&&(N=RED.state.QUICK_JOINING,De([{node:E,port:ee,portType:Q}]),$(window).on("keyup",Ke))),i.stopPropagation(),i.preventDefault()):i.stopPropagation())}function Xe(e,i,c,u){if(RED.view.DEBUG&&console.warn("portMouseUp",N,e,i,c),u=u||d3.event,N!==RED.state.SELECTING_NODE){if(N===RED.state.QUICK_JOINING&&0<x.length){if(x[0].node===e)return;if(x[0].virtualLink&&("link in"===x[0].node.type&&"link out"!==e.type||"link out"===x[0].node.type&&"link in"!==e.type))return}if(document.body.style.cursor="",N==RED.state.JOINING||N==RED.state.QUICK_JOINING){if("undefined"!=typeof TouchEvent&&u instanceof TouchEvent){var p=!1;if(RED.nodes.eachNode(function(e){var t,o;e.z==RED.workspaces.active()&&(t=e.w/2,o=e.h/2,e.x-t<ie[0]&&e.x+t>ie[0]&&e.y-o<ie[1]&&e.y+o>ie[1]&&(p=!0,i=0<(te=e).inputs?_:k,c=0))}),!p&&O){var t=[];O.status&&t.push(O.status),O.in&&(t=t.concat(O.in)),O.out&&(t=t.concat(O.out));for(var o=0;o<t.length;o++){var n=t[o],f=n.w/2,h=n.h/2;if(n.x-f<ie[0]&&n.x+f>ie[0]&&n.y-h<ie[1]&&n.y+h>ie[1]){p=!0,i="in"===(te=n).direction?k:_,c=0;break}}}}else te=e;var g=[],m=[],b=[],a=null;for(o=0;o<x.length;o++)x[o].link&&m.push(x[o].link);var r,s,d,v,l,y,w,E,D,R=[];for(o=0;o<x.length;o++)i!=x[o].portType&&te!==x[o].node&&((r=x[o]).portType===k?(s=r.node,v=r.port,d=te):r.portType===_&&(s=te,d=r.node,v=c),l={source:s,sourcePort:v,target:d},r.virtualLink?/^link (in|out)$/.test(s.type)&&/^link (in|out)$/.test(d.type)&&s.type!==d.type&&-1===s.links.indexOf(d.id)&&-1===d.links.indexOf(s.id)&&(y=$.extend(!0,{},{v:s.links}).v,w=$.extend(!0,{},{v:d.links}).v,s.links.push(d.id),d.links.push(s.id),s.dirty=!0,d.dirty=!0,b.push(s),b.push(d),l.link=!0,V.push(l),W[s.id]=s,W[d.id]=d,a=l,R.push({t:"edit",node:s,dirty:RED.nodes.dirty(),changed:s.changed,changes:{links:y}}),R.push({t:"edit",node:d,dirty:RED.nodes.dirty(),changed:d.changed,changes:{links:w}}),s.changed=!0,d.changed=!0):"link out"===e.type&&i===k||"link in"===e.type&&i===_||i===k&&"subflow"!==te.type&&0===te.outputs||i===_&&"subflow"!==te.type&&0===te.inputs||r.portType===_&&"subflow"===te.type&&("status"===te.direction||"out"===te.direction)||r.portType===k&&"subflow"===te.type&&"in"===te.direction||0!==RED.nodes.filterLinks({source:s,target:d,sourcePort:v}).length||(RED.nodes.addLink(l),g.push(l)));if((0<g.length||0<m.length||0<b.length)&&(D=0<b.length?{t:"multi",events:R,dirty:RED.nodes.dirty()}:{t:"add",links:g,removedLinks:m,dirty:RED.nodes.dirty()},!O||(E=RED.subflow.refresh(!0))&&(D.subflow={id:O.id,changed:O.changed,instances:E.instances}),RED.history.push(D),xe(),RED.nodes.dirty(!0)),N===RED.state.QUICK_JOINING)return(0<g.length||0<b.length)&&(Re(),i===_&&0<e.outputs?De([{node:e,port:0,portType:k}]):i===k&&0<e.inputs?De([{node:e,port:0,portType:_}]):We(),(Y=a)?(we.clear(),we.add(a),Me()):we.clear()),void Lt();We(),Re(),a&&(we.clear(),we.add(a)),(Y=a)&&Me(),Lt()}}else u.stopPropagation()}var o,Ye=null,Ze=null;function Qe(e){var t=d3.select(e);if("red-ui-workspace-chart-event-layer"===t.attr("class"))return[0,0];var o=[0,0],i=("g"===e.nodeName.toLowerCase()?(i=t.attr("transform"))&&(o=d3.transform(i).translate):o=[t.attr("x")||0,t.attr("y")||0],Qe(e.parentNode));return[o[0]+i[0],o[1]+i[1]]}function et(t,o,e){var i,n=o===_?t.inputLabels:t.outputLabels;if(n&&n[e])return n[e];n=o===_?t._def.inputLabels:t._def.outputLabels;if("string"==typeof n)i=n;else if("function"==typeof n)try{i=n.call(t,e)}catch(e){console.log("Definition error: "+t.type+"."+(o===_?"inputLabels":"outputLabels"),e),i=null}else $.isArray(n)&&(i=n[e]);return i}function tt(e,t,o,i){var n,a,r,s=m.append("g").attr("transform","translate("+e+","+t+")").attr("class","red-ui-flow-port-tooltip"),e=o.indexOf("\\n "),t=(o=-1<e&&"\\"!==o[e-1]?o.substring(0,e)+"...":o).split("\n"),d=6,l=12,c=[],u=0,e=(t.forEach(function(e,t){e=Ve(e||"&nbsp;","red-ui-flow-port-tooltip-label");d=Math.max(d,e[0]+14),c.push(e[1]),0===t&&(u=e[1]),l+=e[1]}),d/2-5-2),o=l/2-5-2,p=l-4,f=-l/2;return"left"===i?(n="M0 0 l -5 -5 v -"+o+" q 0 -2 -2 -2 h -"+d+" q -2 0 -2 2 v "+p+" q 0 2 2 2 h "+d+" q 2 0 2 -2 v -"+o+" l 5 -5",a=-14,r="end"):"right"===i?(n="M0 0 l 5 -5 v -"+o+" q 0 -2 2 -2 h "+d+" q 2 0 2 2 v "+p+" q 0 2 -2 2 h -"+d+" q -2 0 -2 -2 v -"+o+" l -5 -5",a=14,r="start"):"top"===i&&(n="M0 0 l 5 -5 h "+e+" q 2 0 2 -2 v -"+l+" q 0 -2 -2 -2 h -"+(d-4)+" q -2 0 -2 2 v "+l+" q 0 2 2 2 h "+e+" l 5 5",a=-d/2+6,f=-l-u+12,r="start"),s.append("path").attr("d",n),t.forEach(function(e,t){f+=c[t],s.append("svg:text").attr("class","red-ui-flow-port-tooltip-label").attr("x",a).attr("y",f).attr("text-anchor",r).text(e||" ")}),s}function ot(o,i,n,a){var e;N!==RED.state.SELECTING_NODE?(clearTimeout(Ye),(e=N!=RED.state.JOINING&&N!=RED.state.QUICK_JOINING||0<x.length&&x[0].portType!==n&&(!x[0].virtualLink||"link in"===x[0].node.type&&"link out"===i.type||"link out"===x[0].node.type&&"link in"===i.type))&&(n===_&&(i._def&&i._def.inputLabels||i.inputLabels)||n===k&&(i._def&&i._def.outputLabels||i.outputLabels))&&(Ye=setTimeout(function(){var e,t=et(i,n,a);t&&(e=Qe(o.node()),Ye=null,Ze=tt(e[0]+(n===_?-2:12),e[1]+5,t,n===_?"left":"right"))},500)),o.classed("red-ui-flow-port-hovered",e)):d3.event.stopPropagation()}function it(e){N!==RED.state.SELECTING_NODE?(clearTimeout(Ye),Ze&&(Ze.remove(),Ze=null),e.classed("red-ui-flow-port-hovered",!1)):d3.event.stopPropagation()}function nt(e){for(N=RED.state.MOVING,i=0;i<I.length();i++){var t=I.get(i);t.ox=t.n.x,t.oy=t.n.y,t.dx=t.n.x-e[0],t.dy=t.n.y-e[1]}try{oe=d3.mouse(document.body),isNaN(oe[0])&&(oe=d3.touches(document.body)[0])}catch(e){oe=[0,0]}}function at(e){if(RED.view.DEBUG&&console.warn("nodeMouseUp",N,e),N!==RED.state.SELECTING_NODE){if(ce&&E==e&&0<pe&&pe<b)return N=RED.state.DEFAULT,"subflow"!=e.type?/^subflow:/.test(e.type)&&(d3.event.ctrlKey||d3.event.metaKey)?RED.workspaces.show(e.type.substring(8)):RED.editor.edit(e):RED.editor.editSubflow(O),pe=0,void d3.event.stopPropagation();if(N===RED.state.MOVING)if(!me&&!e.selected&&e.g&&RED.nodes.group(e.g).selected)return Pe(),Et(RED.nodes.group(e.g),!1),Dt(RED.nodes.group(e.g)),E.selected=!0,I.add(E),(t=d3.touches(this)[0]||d3.mouse(this))[0]+=e.x-e.w/2,t[1]+=e.y-e.h/2,nt(t),void Me();me=!1;var t=e._def?0<e.inputs?1:0:"in"==e.direction?0:1,o=!1;N!==RED.state.JOINING&&N!==RED.state.QUICK_JOINING||(o=!0,0<x.length&&(x[0].virtualLink?"link in"===e.type?t=1:"link out"===e.type&&(t=0):t=1===x[0].portType?k:_)),Xe(e,t,0),o&&d3.selectAll(".red-ui-flow-port-hovered").classed("red-ui-flow-port-hovered",!1)}else d3.event.stopPropagation()}function rt(e){if(RED.view.DEBUG&&console.warn("nodeMouseDown",N,e),Ot(),1!==d3.event.button){if(N==RED.state.IMPORT_DRAGGING||N==RED.state.DETACHED_DRAGGING){var t=RED.history.peek();if(R&&(l=d3.select(R).data()[0],RED.nodes.removeLink(l),n={source:l.source,sourcePort:l.sourcePort,target:I.get(0).n},r={source:I.get(0).n,sourcePort:0,target:l.target},RED.nodes.addLink(n),RED.nodes.addLink(r),t.links=[n,r],t.removedLinks=[l],xe()),K){for(var o=0;o<I.length();o++){var i=I.get(o);RED.group.addToGroup(K,i.n)}(t.addedToGroup=K).hovered=!1,Dt(K),g.selected=!0,K=null}if(N==RED.state.DETACHED_DRAGGING){for(var c=[],o=0;o<I.length();o++)(i=I.get(o)).ox===i.n.x&&i.oy===i.n.y||(c.push({n:i.n,ox:i.ox,oy:i.oy,moved:i.n.moved}),i.n.dirty=!0,i.n.moved=!0);RED.history.replace({t:"multi",events:[t,{t:"move",nodes:c}],dirty:t.dirty})}return Me(),RED.nodes.dirty(!0),Lt(),We(),void d3.event.stopPropagation()}if(N!=RED.state.QUICK_JOINING){if(N===RED.state.SELECTING_NODE)return d3.event.stopPropagation(),u.single?void u.done(e):(e.selected?(e.selected=!1,I.remove(e)):u.filter&&!u.filter(e)||(e.selected=!0,I.add(e)),e.dirty=!0,void Lt());E=e;var n=Date.now();if(pe=n-ue,ue=n,ce=le==E&&(d3.event.touches||0===d3.event.button)&&!d3.event.shiftKey&&!d3.event.altKey&&pe<b,le=E,!e.selected&&e.g){var a,r=RED.nodes.group(e.g);if(r!==g&&(d3.event.ctrlKey||d3.event.metaKey))me=(g&&r.g===g.id||Rt(),!0),r.selected?xt(r):Et(r,!0);else if(r===g)if(d3.event.shiftKey){d3.event.ctrlKey||d3.event.metaKey||(d=g,Pe(),Dt(d),g.selected=!0),console.log(d3.event);for(var s=RED.nodes.getAllFlowNodes(E),i=0;i<s.length;i++)s[i].selected||(s[i].selected=!0,s[i].dirty=!0,I.add(s[i]))}else d3.event.ctrlKey||d3.event.metaKey||(d=g,Pe(),xt(r),Et(r,!1,!1),d&&(Dt(d),g.selected=!0)),E.selected=!0,I.add(E);else{me=!r.selected;var d=g;r.selected||Pe(),d?d!==r&&d.id!==r.g?(d.active=!1,d.dirty=!0):(g=d).active=!0:ce=!1,Et(r,!(g&&g===r),!!me),g&&g===r&&(E.selected=!0,I.add(E))}2!=d3.event.button&&((a=d3.touches(this)[0]||d3.mouse(this))[0]+=e.x-e.w/2,a[1]+=e.y-e.h/2,nt(a))}else if(e.selected&&(d3.event.ctrlKey||d3.event.metaKey))E.selected=!1,I.remove(E);else{if(d3.event.shiftKey){d3.event.ctrlKey||d3.event.metaKey||Pe();var l=d3.event.offsetX/D-E.x;s=E.w/2-Math.abs(l)<(30<E.w?25:8)?[E].concat(l<0?RED.nodes.getAllUpstreamNodes(E):RED.nodes.getAllDownstreamNodes(E)):RED.nodes.getAllFlowNodes(E);for(i=0;i<s.length;i++)s[i].selected=!0,s[i].dirty=!0,I.add(s[i])}else e.selected||((d3.event.ctrlKey||d3.event.metaKey?Rt:Pe)(),E.selected=!0,I.add(E));2!=d3.event.button&&(N=RED.state.MOVING,(a=d3.touches(this)[0]||d3.mouse(this))[0]+=e.x-e.w/2,a[1]+=e.y-e.h/2,nt(a))}e.dirty=!0,Me(),Lt(),d3.event.stopPropagation()}else d3.event.stopPropagation()}}function st(e){RED.view.DEBUG&&console.warn("nodeTouchStart",N,e);var t=d3.select(this),o=d3.event.touches.item(0),i=[o.pageX,o.pageY];M=[o.pageX,o.pageY],y=0,z=setTimeout(function(){Tt(t,i)},v),rt.call(this,e),d3.event.preventDefault()}function dt(e){RED.view.DEBUG&&console.warn("nodeTouchEnd",N,e),d3.event.preventDefault(),clearTimeout(z),z=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():at.call(this,e)}function lt(o){var i,e,t;RED.view.DEBUG&&console.warn("nodeMouseOver",N,o),0===N||N===RED.state.SELECTING_NODE?(N===RED.state.SELECTING_NODE&&u&&u.filter&&!u.filter(o)||this.parentNode.classList.add("red-ui-flow-node-hovered"),clearTimeout(Ye),(o.hasOwnProperty("l")?o.l:"link in"!==o.type&&"link out"!==o.type)||(i=this.parentNode,Ye=setTimeout(function(){var t,e;if(o._def.label){t=o._def.label;try{t=("function"==typeof t?t.call(o):t)||""}catch(e){console.log("Definition error: "+o.type+".label",e),t=o.type}}""!==t&&(e=Qe(i),Ye=null,Ze=tt(e[0]+o.w/2,e[1]-1,t,"top"))},500))):N!==RED.state.JOINING&&N!==RED.state.QUICK_JOINING||0<x.length&&(t=x[0].virtualLink&&x[0].portType===_||x[0].portType===k?(e=".red-ui-flow-port-input .red-ui-flow-port",_):(e=".red-ui-flow-port-output .red-ui-flow-port",k),ot(d3.select(this.parentNode).selectAll(e),o,t,0))}function ct(e){var t;RED.view.DEBUG&&console.warn("nodeMouseOut",N,e),this.parentNode.classList.remove("red-ui-flow-node-hovered"),clearTimeout(Ye),Ze&&(Ze.remove(),Ze=null),N!==RED.state.JOINING&&N!==RED.state.QUICK_JOINING||0<x.length&&(x[0].virtualLink&&x[0].portType===_||x[0].portType===k?t=".red-ui-flow-port-input .red-ui-flow-port":t=".red-ui-flow-port-output .red-ui-flow-port",it(d3.select(this.parentNode).selectAll(t)))}function ut(e){He(this.__data__,this.__portType__,this.__portIndex__,e)}function pt(e){He(this.__data__,this.__portType__,this.__portIndex__,e),e.preventDefault()}function ft(e){Xe(this.__data__,this.__portType__,this.__portIndex__,e)}function ht(e){Xe(this.__data__,this.__portType__,this.__portIndex__,e),e.preventDefault()}function gt(e){ot(d3.select(this),this.__data__,this.__portType__,this.__portIndex__)}function mt(e){it(d3.select(this),this.__data__,this.__portType__,this.__portIndex__)}function bt(e){var t;N!==RED.state.SELECTING_NODE?2!==d3.event.button&&(Y=e,d3.event.metaKey||d3.event.ctrlKey||Pe(),(d3.event.metaKey||d3.event.ctrlKey)&&we.has(Y)?1!==we.length()&&we.remove(Y):we.add(Y),Me(),Lt(),Ot(),d3.event.stopPropagation(),Y.link||0!==I.length()||!d3.event.touches&&0!==d3.event.button||1!==we.length()||!we.has(Y)||!d3.event.metaKey&&!d3.event.ctrlKey||(d3.select(this).classed("red-ui-flow-link-splice",!0),t=$t((e=d3.mouse(this))[0],e[1]),Te({position:e,splice:Y,group:t}))):d3.event.stopPropagation()}function vt(e){var t,o;N!==RED.state.SELECTING_NODE?(Y=e,Pe(),we.clear(),we.add(Y),Me(),Lt(),Ot(),d3.event.stopPropagation(),t=d3.select(document.body),e=d3.event.touches.item(0),o=[e.pageX,e.pageY],z=setTimeout(function(){z=null,Tt(t,o)},v),d3.event.preventDefault()):d3.event.stopPropagation()}function yt(e){ce&&Z==e&&0<pe&&pe<b&&(N=RED.state.DEFAULT,RED.editor.editGroup(e),d3.event.stopPropagation())}function wt(e){var t,o=d3.touches(this.parentNode)[0]||d3.mouse(this.parentNode);Ot(),1!==d3.event.button&&(N!=RED.state.QUICK_JOINING&&N!==RED.state.SELECTING_NODE&&(Z=e,t=Date.now(),pe=t-ue,ue=t,ce=le==e&&(d3.event.touches||0===d3.event.button)&&!d3.event.shiftKey&&!d3.event.metaKey&&!d3.event.altKey&&!d3.event.ctrlKey&&pe<b,(le=e).selected&&(d3.event.ctrlKey||d3.event.metaKey)?(e===g&&Rt(),xt(e),d3.event.stopPropagation()):(e.selected?g&&e.g!==g.id&&Rt():(d3.event.ctrlKey||d3.event.metaKey||(t=g,Pe(),t&&e.g===t.id&&(Dt(t),g.selected=!0)),g&&(RED.group.contains(g,e)||Rt()),Et(e,!0)),2!=d3.event.button&&(e.nodes[0],nt(o),Z.dx=Z.x-o[0],Z.dy=Z.y-o[1])),Me(),Lt()),d3.event.stopPropagation())}function Et(e,t,o){var i;e.selected||(e.selected=!0,e.dirty=!0),!1!==o&&I.add(e),t&&(i=new Set(I.nodes()),RED.group.getNodes(e,!0).forEach(function(e){i.has(e)||I.add(e),e.dirty=!0}))}function Dt(e){g&&Rt(),e.active=!0,e.dirty=!0,g=e,I.remove(e)}function Rt(){g&&(g.active=!1,g.dirty=!0,xt(g),Et(g,!0),g=null)}function xt(e){e.selected&&(e.selected=!1,e.dirty=!0);var t=new Set(e.nodes);t.add(e);for(var o=I.length()-1;0<=o;--o){var i=I.get(o);!t.has(i.n)&&i.n!==e||(i.n.selected=!1,i.n.dirty=!0,I.remove(i.n,o))}}function $t(e,t){for(var o={},i=0;i<H.length;i++){var n=H[i];e>=n.x&&e<=n.x+n.w&&t>=n.y&&t<=n.y+n.h&&(o[n.id]=n)}var a=Object.keys(o);return 1<a.length&&(a.forEach(function(e){o[e]&&o[e].g&&delete o[o[e].g]}),a=Object.keys(o)),0===a.length?null:o[a[a.length-1]]}function _t(e){var t=!0,o=RED.nodes.workspace(RED.workspaces.active());return!o||o.disabled||e.d?t=!1:e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled),t}function kt(t){if(N!==RED.state.SELECTING_NODE){var e=RED.workspaces.active(),e=RED.nodes.workspace(e);if(!e||e.disabled||t.d)O?RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabledSubflow")}),"warning"):RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(t._def.button.toggle&&(t[t._def.button.toggle]=!t[t._def.button.toggle],t.dirty=!0),t._def.button.onclick)try{t._def.button.onclick.call(t)}catch(e){console.log("Definition error: "+t.type+".onclick",e)}t.dirty&&Lt()}d3.event&&d3.event.preventDefault()}else d3.event&&d3.event.stopPropagation()}function Tt(e,t){var o=E,i=[];i.push({name:"delete",disabled:0===I.length()&&0===we.length(),onselect:function(){Be()}}),i.push({name:"cut",disabled:0===I.length(),onselect:function(){Ge(),Be()}}),i.push({name:"copy",disabled:0===I.length(),onselect:function(){Ge()}}),i.push({name:"paste",disabled:0===ve.length,onselect:function(){Nt(ve,{generateIds:!0,touchImport:!0})}}),i.push({name:"edit",disabled:1!=I.length(),onselect:function(){RED.editor.edit(o)}}),i.push({name:"select",onselect:function(){Ie()}}),i.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),i.push({name:"add",onselect:function(){chartPos=w.offset(),Te({position:[t[0]-chartPos.left+w.scrollLeft(),t[1]-chartPos.top+w.scrollTop()],touchTrigger:!0})}}),RED.touch.radialMenu.show(e,t,i),We()}function Ct(o,e,t){var i,n,a,r=null;0===o.indexOf("font-awesome/")&&(i=o.substr(13),(r=RED.nodes.fontAwesome.getIconUnicode(i))||(i=RED.utils.getDefaultNodeIcon(t._def,t),o=RED.settings.apiRootUrl+"icons/"+i.module+"/"+i.file)),r?e.append("text").attr("xlink:href",o).attr("class","fa-lg").attr("x",15).text(r):(n=e.append("image").style("display","none").attr("xlink:href",o).attr("class","red-ui-flow-node-icon").attr("x",0).attr("width","30").attr("height","30"),(a=new Image).src=o,a.onload=function(){var e,t;o.match(/\.svg$/)||(e=Math.max(a.width,a.height),t=1,e=a.width*(t=30<e?30/e:t),t=a.height*t,n.attr("width",e),n.attr("height",t),n.attr("x",15-e/2)),n.attr("xlink:href",o),n.style("display",null)})}function jt(e,t){var o;e.z===RED.workspaces.active()&&(t=t||document.getElementById(e.id))&&(de&&e.status&&!0!==e.d?(t.__statusGroup__.style.display="inline",o=ye[e.status.fill],null==e.status.shape&&null==o?(t.__statusShape__.style.display="none",t.__statusGroup__.setAttribute("transform","translate(-14,"+(e.h+3)+")")):(t.__statusGroup__.setAttribute("transform","translate(3,"+(e.h+3)+")"),o="red-ui-flow-node-status-"+(e.status.shape||"dot")+"-"+e.status.fill,t.__statusShape__.style.display="inline",t.__statusShape__.setAttribute("class","red-ui-flow-node-status "+o)),e.status.hasOwnProperty("text")?t.__statusLabel__.textContent=e.status.text:t.__statusLabel__.textContent=""):t.__statusGroup__.style.display="none",delete e.dirtyStatus)}function Lt(){RED.view.DEBUG_SYNC_REDRAW?St():(o&&cancelAnimationFrame(o),o=requestAnimationFrame(St))}function St(){var w,E,e,t,o,i,n;m.attr("transform","scale("+D+")"),j.attr("width",L*D).attr("height",S*D),-1!==ge||N!=RED.state.JOINING?(w={},O?((e=d.selectAll(".red-ui-flow-subflow-port-output").data(O.out,function(e,t){return e.id})).exit().remove(),e.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-output").each(function(e,t){var o=d3.select(this),i=document.createDocumentFragment(),n=(e.h=40,e.resize=!0,e.dirty=!0,document.createElementNS("http://www.w3.org/2000/svg","rect")),n=(n.__data__=e,n.setAttribute("class","red-ui-flow-subflow-port"),n.setAttribute("rx",8),n.setAttribute("ry",8),n.setAttribute("width",40),n.setAttribute("height",40),o[0][0].__mainRect__=n,d3.select(n).on("mouseup",at).on("mousedown",rt).on("touchstart",st).on("touchend",dt),i.appendChild(n),document.createElementNS("http://www.w3.org/2000/svg","g")),a=(n.setAttribute("x",0),n.setAttribute("y",0),o[0][0].__outputLabelGroup__=n,document.createElementNS("http://www.w3.org/2000/svg","text")),a=(a.setAttribute("class","red-ui-flow-port-label"),a.style["font-size"]="10px",a.textContent="output",n.appendChild(a),o[0][0].__outputOutput__=a,document.createElementNS("http://www.w3.org/2000/svg","text")),a=(a.setAttribute("class","red-ui-flow-port-label red-ui-flow-port-index"),a.setAttribute("x",0),a.setAttribute("y",0),a.textContent=e.i+1,n.appendChild(a),o[0][0].__outputNumber__=a,document.createElementNS("http://www.w3.org/2000/svg","path")),a=(a.setAttribute("d","M 40 1 l 0 38"),a.setAttribute("class","red-ui-flow-node-icon-shade-border"),n.appendChild(a),o[0][0].__outputBorder__=a,i.appendChild(n),document.createElementNS("http://www.w3.org/2000/svg","g")),n=(a.setAttribute("class","red-ui-flow-port-label"),a.setAttribute("transform","translate(38,0)"),a.setAttribute("style","fill : #888"),o[0][0].__textGroup__=a,i.append(a),document.createElementNS("http://www.w3.org/2000/svg","g")),a=(n.setAttribute("transform","translate(-5,15)"),document.createElementNS("http://www.w3.org/2000/svg","rect"));a.setAttribute("class","red-ui-flow-port"),a.setAttribute("rx",3),a.setAttribute("ry",3),a.setAttribute("width",10),a.setAttribute("height",10),n.appendChild(a),a.__data__=e,d3.select(a).on("mousedown",function(e,t){He(e,_,0)}).on("touchstart",function(e,t){He(e,_,0),d3.event.preventDefault()}).on("mouseup",function(e,t){Xe(e,_,0)}).on("touchend",function(e,t){Xe(e,_,0),d3.event.preventDefault()}).on("mouseover",function(e){ot(d3.select(this),e,_,0)}).on("mouseout",function(e){it(d3.select(this))}),o[0][0].__port__=n,i.appendChild(n),o[0][0].appendChild(i)}),(t=d.selectAll(".red-ui-flow-subflow-port-input").data(O.in,function(e,t){return e.id})).exit().remove(),(o=t.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-input").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"})).each(function(e,t){e.w=40,e.h=40}),o.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",at).on("mousedown",rt).on("touchstart",st).on("touchend",dt),o.append("g").attr("transform","translate(35,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){He(e,k,t)}).on("touchstart",function(e,t){He(e,k,t),d3.event.preventDefault()}).on("mouseup",function(e,t){Xe(e,k,t)}).on("touchend",function(e,t){Xe(e,k,t),d3.event.preventDefault()}).on("mouseover",function(e){ot(d3.select(this),e,k,0)}).on("mouseout",function(e){it(d3.select(this))}),o.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",18).attr("y",20).style("font-size","10px").text("input"),(o=d.selectAll(".red-ui-flow-subflow-port-status").data(O.status?[O.status]:[],function(e,t){return e.id})).exit().remove(),(i=o.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-subflow-port-status").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"})).each(function(e,t){e.w=40,e.h=40}),i.append("rect").attr("class","red-ui-flow-subflow-port").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",at).on("mousedown",rt).on("touchstart",st).on("touchend",dt),i.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){He(e,_,0)}).on("touchstart",function(e,t){He(e,_,0),d3.event.preventDefault()}).on("mouseup",function(e,t){Xe(e,_,0)}).on("touchend",function(e,t){Xe(e,_,0),d3.event.preventDefault()}).on("mouseover",function(e){ot(d3.select(this),e,_,0)}).on("mouseout",function(e){it(d3.select(this))}),i.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",22).attr("y",20).style("font-size","10px").text("status"),e.each(function(e,t){if(e.dirty){d3.select(this);w[e.id]=e;var o,i=et(O,k,e.i)||"",n=i.length<1;if(!e.resize&&this.__hideLabel__===n&&this.__label__===i||((o=Fe(i,"red-ui-flow-node-label")).lines.length===this.__labelLineCount__&&this.__label__===i||(e.resize=!0),this.__label__=i,this.__labelLineCount__=o.lines.length,e.h=n?Math.max(40,15*(e.outputs||0)):Math.max(6+24*o.lines.length,15*(e.outputs||0),40),this.__hideLabel__=n),e.resize&&(i=e.w,e.w=n?40:Math.max(40,20*Math.ceil((o.width+50+7)/20)),void 0!==i&&(e.x+=(e.w-i)/2),e.resize=!1),this.setAttribute("transform","translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"),this.classList.toggle("red-ui-flow-node-selected",!!e.selected),N!=RED.state.MOVING_ACTIVE){if(this.classList.toggle("red-ui-flow-node-disabled",!0===e.d),this.__mainRect__.setAttribute("width",e.w),this.__mainRect__.setAttribute("height",e.h),this.__mainRect__.classList.toggle("red-ui-flow-node-highlighted",!!e.highlighted),o){for(var a=o.lines,r=o.lines.length,s=this.__textGroup__.childNodes;s.length>r;)s[s.length-1].remove();for(var d,t=0;t<r;t++)t===s.length&&((d=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("class","red-ui-flow-node-label-text"),d.setAttribute("x",0),d.setAttribute("y",24*t),this.__textGroup__.appendChild(d)),s[t].textContent=a[t]}this.__textGroup__.setAttribute("class","red-ui-flow-node-label"+(n?" hide":""));i=e.h/2-this.__labelLineCount__/2*24+13;this.__textGroup__.setAttribute("transform","translate(48,"+i+")"),this.__outputBorder__.setAttribute("d","M 40 1 l 0 "+(n?0:e.h-2)),this.__port__.setAttribute("transform","translate(-5,"+(e.h/2-5)+")"),this.__outputOutput__.setAttribute("transform","translate(20,"+(e.h/2-8)+")"),this.__outputNumber__.setAttribute("transform","translate(20,"+(e.h/2+7)+")")}e.dirty=!1}}),t.each(function(e,t){var o;e.dirty&&((o=d3.select(this)).classed("red-ui-flow-node-selected",function(e){return e.selected}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),(w[e.id]=e).dirty=!1)}),o.each(function(e,t){var o;e.dirty&&((o=d3.select(this)).classed("red-ui-flow-node-selected",function(e){return e.selected}),o.selectAll(".red-ui-flow-port-index").text(function(e){return e.i+1}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),(w[e.id]=e).dirty=!1)})):(d.selectAll(".red-ui-flow-subflow-port-output").remove(),d.selectAll(".red-ui-flow-subflow-port-input").remove(),d.selectAll(".red-ui-flow-subflow-port-status").remove()),(i=d.selectAll(".red-ui-flow-node-group").data(J,function(e){return e.id})).exit().each(function(e,t){RED.hooks.trigger("viewRemoveNode",{node:e,el:this})}).remove(),i.enter().insert("svg:g").attr("class","red-ui-flow-node red-ui-flow-node-group").classed("red-ui-flow-subflow",null!=O).each(function(e,t){this.__outputs__=[],this.__inputs__=[];var o=d3.select(this),i=document.createDocumentFragment(),n="link in"===e.type||"link out"===e.type,n=e.hasOwnProperty("l")?!e.l:n,a=(o.attr("id",e.id),e.h=A,e.resize=!0,e._def.button&&((r=document.createElementNS("http://www.w3.org/2000/svg","g")).__data__=e,r.setAttribute("transform","translate("+("right"==e._def.align?94:-25)+",2)"),r.setAttribute("class","red-ui-flow-node-button"),o[0][0].__buttonGroup__=r,(a=document.createElementNS("http://www.w3.org/2000/svg","rect")).__data__=e,a.setAttribute("class","red-ui-flow-node-button-background"),a.setAttribute("rx",5),a.setAttribute("ry",5),a.setAttribute("width",32),a.setAttribute("height",A-4),r.appendChild(a),o[0][0].__buttonGroupBackground__=a,(a=document.createElementNS("http://www.w3.org/2000/svg","rect")).__data__=e,a.setAttribute("class","red-ui-flow-node-button-button"),a.setAttribute("x","right"==e._def.align?11:5),a.setAttribute("y",4),a.setAttribute("rx",4),a.setAttribute("ry",4),a.setAttribute("width",16),a.setAttribute("height",A-12),a.setAttribute("fill",RED.utils.getNodeColor(e.type,e._def)),d3.select(a).on("mousedown",function(e){!ne&&_t(e)&&(Ot(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(e){!ne&&_t(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(e){!ne&&_t(e)&&d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(e){var t;!ne&&_t(e)&&(t=1,e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t))}).on("click",kt).on("touchstart",function(e){kt.call(this,e),d3.event.preventDefault()}),r.appendChild(a),o[0][0].__buttonGroupButton__=a,i.appendChild(r)),document.createElementNS("http://www.w3.org/2000/svg","rect")),r=(a.__data__=e,a.setAttribute("class","red-ui-flow-node "+("unknown"==e.type?"red-ui-flow-node-unknown":"")),a.setAttribute("rx",5),a.setAttribute("ry",5),a.setAttribute("fill",RED.utils.getNodeColor(e.type,e._def)),o[0][0].__mainRect__=a,d3.select(a).on("mouseup",at).on("mousedown",rt).on("touchstart",st).on("touchend",dt).on("mouseover",lt).on("mouseout",ct),i.appendChild(a),e._def.icon&&(r=RED.utils.getNodeIcon(e._def,e),(a=document.createElementNS("http://www.w3.org/2000/svg","g")).__data__=e,a.setAttribute("class","red-ui-flow-node-icon-group"+("right"==e._def.align?" red-ui-flow-node-icon-group-right":"")),a.setAttribute("x",0),a.setAttribute("y",0),a.style["pointer-events"]="none",o[0][0].__iconGroup__=a,(s=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("x",0),s.setAttribute("y",0),s.setAttribute("class","red-ui-flow-node-icon-shade"),s.setAttribute("width",30),s.setAttribute("height",Math.min(50,e.h-4)),a.appendChild(s),o[0][0].__iconShade__=s,Ct(r,d3.select(a),e),(s=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d","right"!=e._def.align?"M 30 1 l 0 "+(e.h-2):"M 0 1 l 0 "+(e.h-2)),s.setAttribute("class","red-ui-flow-node-icon-shade-border"),a.appendChild(s),o[0][0].__iconShadeBorder__=s,i.appendChild(a)),document.createElementNS("http://www.w3.org/2000/svg","g")),s=(r.setAttribute("class","red-ui-flow-node-label"+(n?" hide":"")+(e._def.align?" red-ui-flow-node-label-"+e._def.align:"")),r.setAttribute("transform","translate(38,0)"),i.appendChild(r),o[0][0].__textGroup__=r,document.createElementNS("http://www.w3.org/2000/svg","g")),a=(s.setAttribute("class","red-ui-flow-node-status-group"),s.style.display="none",o[0][0].__statusGroup__=s,document.createElementNS("http://www.w3.org/2000/svg","rect")),n=(a.setAttribute("class","red-ui-flow-node-status"),a.setAttribute("x",6),a.setAttribute("y",1),a.setAttribute("width",9),a.setAttribute("height",9),a.setAttribute("rx",2),a.setAttribute("ry",2),a.setAttribute("stroke-width","3"),s.appendChild(a),o[0][0].__statusShape__=a,document.createElementNS("http://www.w3.org/2000/svg","text"));n.setAttribute("class","red-ui-flow-node-status-label"),n.setAttribute("x",20),n.setAttribute("y",10),s.appendChild(n),o[0][0].__statusLabel__=n,i.appendChild(s),o[0][0].appendChild(i),RED.hooks.trigger("viewAddNode",{node:e,el:this})}),E=!1,i.each(function(t,e){if(t._reordered&&(E=!0,delete t._reordered),t.dirty){var c=this,o=d3.select(this),i="link in"===t.type||"link out"===t.type,n=t.hasOwnProperty("l")?!t.l:i,a=(w[t.id]=t,RED.utils.getNodeLabel(t,t.type));if(!t.resize&&this.__hideLabel__===n&&this.__label__===a&&this.__outputs__.length===t.outputs||((r=Fe(a,"red-ui-flow-node-label")).lines.length===this.__labelLineCount__&&this.__label__===a||(t.resize=!0),this.__label__=a,this.__labelLineCount__=r.lines.length,t.h=n?Math.max(A,15*(t.outputs||0)):Math.max(6+24*r.lines.length,15*(t.outputs||0),30),this.__hideLabel__=n),t.resize&&(a=t.w,t.w=n?A:Math.max(P,20*Math.ceil((r.width+50+(0<t._def.inputs?7:0))/20)),void 0!==a&&(t.x+=(t.w-a)/2),t.resize=!1),t._colorChanged&&(a=RED.utils.getNodeColor(t.type,t._def),this.__mainRect__.setAttribute("fill",a),this.__buttonGroupButton__&&this.__buttonGroupButton__.settAttribute("fill",a),delete t._colorChanged),this.setAttribute("transform","translate("+(t.x-t.w/2)+","+(t.y-t.h/2)+")"),this.classList.toggle("red-ui-flow-node-selected",!!t.selected),N!=RED.state.MOVING_ACTIVE){if(this.classList.toggle("red-ui-flow-node-disabled",!0===t.d),this.__mainRect__.setAttribute("width",t.w),this.__mainRect__.setAttribute("height",t.h),this.__mainRect__.classList.toggle("red-ui-flow-node-highlighted",!!t.highlighted),r){for(var u=r.lines,p=r.lines.length,f=this.__textGroup__.childNodes;f.length>p;)f[f.length-1].remove();for(var h,e=0;e<p;e++)e===f.length&&((h=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("class","red-ui-flow-node-label-text"),h.setAttribute("x",0),h.setAttribute("y",24*e),this.__textGroup__.appendChild(h)),f[e].textContent=u[e]}a="";if(t._def.labelStyle){a=t._def.labelStyle;try{a=("function"==typeof a?a.call(t):a)||""}catch(e){console.log("Definition error: "+t.type+".labelStyle",e),a=""}a=" "+a}a="red-ui-flow-node-label"+(t._def.align?" red-ui-flow-node-label-"+t._def.align:"")+a+(n?" hide":""),this.__textGroup__.setAttribute("class",a);var r=t.h/2-this.__labelLineCount__/2*24+13,n=(!t._def.align&&0!==t.inputs&&0===t.outputs||"right"===t._def.align?(this.__iconGroup__&&(this.__iconGroup__.classList.add("red-ui-flow-node-icon-group-right"),this.__iconGroup__.setAttribute("transform","translate("+(t.w-30)+",0)")),this.__textGroup__.classList.add("red-ui-flow-node-label-right"),this.__textGroup__.setAttribute("transform","translate("+(t.w-38)+","+r+")")):(this.__iconGroup__&&(this.__iconGroup__.classList.remove("red-ui-flow-node-icon-group-right"),this.__iconGroup__.setAttribute("transform","")),this.__textGroup__.classList.remove("red-ui-flow-node-label-right"),this.__textGroup__.setAttribute("transform","translate(38,"+r+")")),o.selectAll(".red-ui-flow-port-input")),g=(i&&(-1!==ge||W[t.id])||0!==t.inputs||n.empty()?(i&&(ge===_||W[t.id])||1===t.inputs)&&n.empty()&&(a=o.append("g").attr("class","red-ui-flow-port-input"),r="link in"===t.type?a.append("circle").attr("cx",-1).attr("cy",5).attr("r",5).attr("class","red-ui-flow-port red-ui-flow-link-port"):a.append("rect").attr("class","red-ui-flow-port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10),a[0][0].__port__=r[0][0],r[0][0].__data__=this.__data__,r[0][0].__portType__=_,r[0][0].__portIndex__=0,r.on("mousedown",function(e){He(e,_,0)}).on("touchstart",function(e){He(e,_,0),d3.event.preventDefault()}).on("mouseup",function(e){Xe(e,_,0)}).on("touchend",function(e){Xe(e,_,0),d3.event.preventDefault()}).on("mouseover",function(e){ot(d3.select(this),e,_,0)}).on("mouseout",function(e){it(d3.select(this))}),RED.hooks.trigger("viewAddPort",{node:t,el:this,port:a[0][0],portType:"input",portIndex:0})):n.each(function(e,t){RED.hooks.trigger("viewRemovePort",{node:e,el:c,port:d3.select(this)[0][0],portType:"input",portIndex:0})}).remove(),t.outputs);for(i&&"link out"===t.type&&(g="return"===t.mode||ge!==k&&!W[t.id]?0:1),t.h;this.__outputs__.length>g;){var m=this.__outputs__.pop();RED.hooks.trigger("viewRemovePort",{node:t,el:this,port:m,portType:"output",portIndex:this.__outputs__.length}),m.remove()}for(var s=0;s<g;s++){s===this.__outputs__.length?((l=document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("class","red-ui-flow-port-output"),"link out"===t.type?((d=document.createElementNS("http://www.w3.org/2000/svg","circle")).setAttribute("cx",11),d.setAttribute("cy",5),d.setAttribute("r",5),d.setAttribute("class","red-ui-flow-port red-ui-flow-link-port")):((d=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("rx",3),d.setAttribute("ry",3),d.setAttribute("width",10),d.setAttribute("height",10),d.setAttribute("class","red-ui-flow-port")),l.appendChild(d),(l.__port__=d).__data__=this.__data__,d.__portType__=k,d.__portIndex__=s,d.addEventListener("mousedown",ut),d.addEventListener("touchstart",pt),d.addEventListener("mouseup",ft),d.addEventListener("touchend",ht),d.addEventListener("mouseover",gt),d.addEventListener("mouseout",mt),this.appendChild(l),this.__outputs__.push(l),RED.hooks.trigger("viewAddPort",{node:t,el:this,port:l,portType:"output",portIndex:s})):l=this.__outputs__[s];var d,l,b=t.w-5,v=t.h/2-(g-1)/2*13;l.setAttribute("transform","translate("+b+","+(v+13*s-5)+")")}t._def.icon&&(r=o.select(".red-ui-flow-node-icon"),a=o.select(".fa-lg"),n=(r.empty()?a:r).attr("xlink:href"),(i=RED.utils.getNodeIcon(t._def,t))!==n&&((r.empty()?a:r).remove(),Ct(i,o.select(".red-ui-flow-node-icon-group"),t),r=o.select(".red-ui-flow-node-icon"),a=o.select(".fa-lg")),r.attr("y",function(){return(t.h-d3.select(this).attr("height"))/2}),this.__iconShade__.setAttribute("height",t.h),this.__iconShadeBorder__.setAttribute("d","M "+(!t._def.align&&0!==t.inputs&&0===t.outputs||"right"===t._def.align?0:30)+" 1 l 0 "+(t.h-2)),a.attr("y",(t.h+13)/2)),o.selectAll(".red-ui-flow-port-input").each(function(e,t){d3.select(this).attr("transform",function(e){return"translate(-5,"+(e.h/2-5)+")"})}),t._def.button&&(n=_t(t),this.__buttonGroup__.classList.toggle("red-ui-flow-node-button-disabled",!n),b="right"==t._def.align?t.w-6:-25,t._def.button.toggle&&!t[t._def.button.toggle]&&(b-="right"==t._def.align?8:-8),this.__buttonGroup__.setAttribute("transform","translate("+b+",2)"),t._def.button.toggle&&(this.__buttonGroupButton__.setAttribute("fill-opacity",t[t._def.button.toggle]?1:.2),this.__buttonGroupBackground__.setAttribute("fill-opacity",t[t._def.button.toggle]?1:.2)),"function"==typeof t._def.button.visible&&(!1===t._def.button.visible.call(t)?this.__buttonGroup__.style.display="none":this.__buttonGroup__.style.display="inherit"))}if(t.dirtyStatus&&jt(t,this),t.dirty=!1,t.g&&!X[t.g])for(var y=t.g;y&&!X[y];)X[y]=RED.nodes.group(y),y=X[y].g}RED.hooks.trigger("viewRedrawNode",{node:t,el:this})}),E&&i.sort(function(e,t){return e._index-t._index}),(e=a.selectAll(".red-ui-flow-link").data(V,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i})).enter().insert("g",".red-ui-flow-node").attr("class","red-ui-flow-link").each(function(e,t){var o=d3.select(this),i=document.createDocumentFragment(),n=(e.added=!0,document.createElementNS("http://www.w3.org/2000/svg","path")),n=(n.__data__=e,n.setAttribute("class","red-ui-flow-link-background red-ui-flow-link-path"+(e.link?" red-ui-flow-link-link":"")),this.__pathBack__=n,i.appendChild(n),d3.select(n).on("mousedown",bt).on("touchstart",vt).on("mousemove",function(e){N===RED.state.SLICING&&(we.add(e),o.classed("red-ui-flow-link-splice",!0),Lt())}),document.createElementNS("http://www.w3.org/2000/svg","path")),n=(n.__data__=e,n.setAttribute("class","red-ui-flow-link-outline red-ui-flow-link-path"),this.__pathOutline__=n,i.appendChild(n),document.createElementNS("http://www.w3.org/2000/svg","path"));n.__data__=e,n.setAttribute("class","red-ui-flow-link-line red-ui-flow-link-path"+(e.link?" red-ui-flow-link-link":O?" red-ui-flow-subflow-link":"")),this.__pathLine__=n,i.appendChild(n),o[0][0].appendChild(i)}),e.exit().remove(),e.each(function(e){var t;d3.select(this),(e.added||e.selected||w[e.source.id]||w[e.target.id])&&(t=-((e.source.outputs||1)-1)/2*13+13*(e.sourcePort||0),e.x1=e.source.x+e.source.w/2,e.y1=e.source.y+t,e.x2=e.target.x-e.target.w/2,e.y2=e.target.y,t=$e(e.x1,e.y1,e.x2,e.y2,1),/NaN/.test(t)&&(t=""),this.__pathBack__.setAttribute("d",t),this.__pathOutline__.setAttribute("d",t),this.__pathLine__.setAttribute("d",t),this.__pathLine__.classList.toggle("red-ui-flow-node-disabled",!(!e.source.d&&!e.target.d)),this.__pathLine__.classList.toggle("red-ui-flow-subflow-link",!e.link&&O)),this.classList.toggle("red-ui-flow-link-selected",!!e.selected),"unknown"!=e.target.type&&e.source.type;this.classList.toggle("red-ui-flow-link-unknown",!("unknown"!=e.target.type&&"unknown"!=e.source.type)),delete e.added}),(t=a.selectAll(".red-ui-flow-link-off-flow").data(q,function(e){return e.node.id+":"+e.refresh})).enter().insert("g",".red-ui-flow-node").attr("class","red-ui-flow-link-off-flow").each(function(o,c){var e=d3.select(this),i=1,n="start",a=("link in"===o.node.type&&(i=-1,n="end"),30*i),r=20*i,t=(e.append("svg:path").attr("class","red-ui-flow-link-link").attr("d","M 0 0 h "+a),o.links),t=Object.keys(t),s=RED.nodes.getWorkspaceOrder(),d=(t.sort(function(e,t){return s.indexOf(e)-s.indexOf(t)}),A),l=-(t.length-1)*d/2,e=e.selectAll(".red-ui-flow-link-group").data(t);e.enter().append("g").attr("class","red-ui-flow-link-group").on("mouseover",function(){0===N&&d3.select(this).classed("red-ui-flow-link-group-active",!0)}).on("mouseout",function(){0===N&&d3.select(this).classed("red-ui-flow-link-group-active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(e){var t;0===N&&(d3.event.stopPropagation(),t=o.links[e],RED.workspaces.show(e),t.forEach(function(e){e.selected=!0,e.dirty=!0,I.add(e),1===t.length&&RED.view.reveal(e.id)}),Me(),Lt())}).each(function(e){var t,o=d3.select(this),e=(o.append("svg:path").attr("class","red-ui-flow-link-link").attr("d","M "+a+" 0 C "+(a+1.7*r)+" 0 "+(a+.1*r)+" "+l+" "+(a+1.5*r)+" "+l+" "),o.append("svg:path").attr("class","red-ui-flow-link-port").attr("d","M "+(a+1.5*r+17*i)+" "+(l-12)+" h "+10*-i+" a 3 3 45 0 "+(1===i?"0":"1")+" "+-3*i+" 3 v 18 a 3 3 45 0 "+(1===i?"0":"1")+" "+3*i+" 3 h "+10*i),o.append("svg:path").attr("class","red-ui-flow-link-port").attr("d","M "+(a+1.5*r+20*i)+" "+(l-12)+" h "+30*i+" M "+(a+1.5*r+20*i)+" "+(l+12)+" h "+30*i).style("stroke-dasharray","12 3 8 4 3"),o.append("rect").attr("class","red-ui-flow-port red-ui-flow-link-port").attr("x",a+1.5*r-4+4*i).attr("y",l-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),o.append("rect").attr("x",a+1.5*r-(-1===i?P:0)).attr("y",l-12).attr("width",P).attr("height",24).style("stroke","none").style("fill","transparent"),RED.nodes.workspace(e));e&&(t=e.label||e.id),o.append("svg:text").attr("class","red-ui-flow-port-label").attr("x",a+1.5*r+15*i).attr("y",l+1).style("font-size","10px").style("text-anchor",n).text(t),l+=d}),e.exit().remove()}),t.exit().remove(),(t=a.selectAll(".red-ui-flow-link-off-flow")).each(function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"})}),(o=l.selectAll(".red-ui-flow-group").data(H,function(e){return e.id})).exit().each(function(e,t){document.getElementById("group_select_"+e.id).remove()}).remove(),i=o.enter().insert("svg:g").attr("class","red-ui-flow-group"),n=!1,i.each(function(e,t){n=!0;var o=d3.select(this),i=(o.attr("id",e.id),s.append("g").attr("class","red-ui-flow-group").attr("id","group_select_"+e.id));i.append("rect").classed("red-ui-flow-group-outline-select",!0).classed("red-ui-flow-group-outline-select-background",!0).attr("rx",4).attr("ry",4).attr("x",-4).attr("y",-4),i.append("rect").classed("red-ui-flow-group-outline-select",!0).attr("rx",4).attr("ry",4).attr("x",-4).attr("y",-4),i.on("mousedown",function(){wt.call(o[0][0],e)}),i.on("mouseup",function(){yt.call(o[0][0],e)}),i.on("touchstart",function(){wt.call(o[0][0],e),d3.event.preventDefault()}),i.on("touchend",function(){yt.call(o[0][0],e),d3.event.preventDefault()}),o.append("rect").classed("red-ui-flow-group-outline",!0).attr("rx",.5).attr("ry",.5),o.append("rect").classed("red-ui-flow-group-body",!0).attr("rx",4).attr("ry",4).style({fill:e.fill||"none",stroke:e.stroke||"none"}),o.on("mousedown",wt).on("mouseup",yt),o.on("touchstart",function(){wt.call(o[0][0],e),d3.event.preventDefault()}),o.on("touchend",function(){yt.call(o[0][0],e),d3.event.preventDefault()}),o.append("svg:text").attr("class","red-ui-flow-group-label"),e.dirty=!0}),n&&o.sort(function(e,t){return e._root===t._root?e._depth-t._depth:e._index-t._index}),o[0].reverse(),o.each(function(e,c){var t,o,i,n,a,r,s,d,u,l;e.resize&&(e.minWidth=0,delete e.resize),(e.dirty||X[e.id])&&(t=d3.select(this),l=!1,0<e.nodes.length?e.groupMoved?delete e.groupMoved:(o=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=n=0,e.nodes.forEach(function(e){a="group"!==e.type?(o=Math.min(o,e.x-e.w/2-26-(e._def.button&&"right"!==e._def.align?20:0)),i=Math.min(i,e.y-e.h/2-26),n=Math.max(n,e.x+e.w/2+26+(e._def.button&&"right"==e._def.align?20:0)),Math.max(a,e.y+e.h/2+26)):(o=Math.min(o,e.x-26),i=Math.min(i,e.y-26),n=Math.max(n,e.x+e.w+26),Math.max(a,e.y+e.h+26))}),e.x=o,e.y=i,e.w=n-o,e.h=a-i,!(l=!0)===e.groupMoved&&delete e.groupMoved):(e.w=40,e.h=40,l=!0),l&&(e.minWidth||(e.style.label&&e.name?(l=Fe(e.name||"","red-ui-flow-group-label"),e.minWidth=l.width+8,e.labels=l.lines):(e.minWidth=40,e.labels=[])),e.w=Math.max(e.minWidth,e.w),e.style.label&&0<e.labels.length&&(s=e.style["label-position"]||"nw",l=16*(e.labels.length-1),"s"===s[0]&&(l+=8),e.h+=l,"n"===s[0]&&0<e.nodes.length&&(e.y-=l))),t.attr("transform","translate("+e.x+","+e.y+")"),t.selectAll(".red-ui-flow-group-outline").attr("width",e.w).attr("height",e.h),(l=document.getElementById("group_select_"+e.id)).setAttribute("transform","translate("+e.x+","+e.y+")"),e.hovered?l.classList.add("red-ui-flow-group-hovered"):l.classList.remove("red-ui-flow-group-hovered"),(d=l.children[0]).setAttribute("width",e.w+8),d.setAttribute("height",e.h+8),d.style.strokeOpacity=e.active||e.selected||e.highlighted?.8:0,d.style.strokeDasharray=e.active?"10 4":"",(d=l.children[1]).setAttribute("width",e.w+8),d.setAttribute("height",e.h+8),d.style.strokeOpacity=e.active||e.selected||e.highlighted?.8:0,d.style.strokeDasharray=e.active?"10 4":"",e.highlighted?l.classList.add("red-ui-flow-node-highlighted"):l.classList.remove("red-ui-flow-node-highlighted"),t.selectAll(".red-ui-flow-group-body").attr("width",e.w).attr("height",e.h).style("stroke",e.style.stroke||"").style("stroke-opacity",e.style.hasOwnProperty("stroke-opacity")?e.style["stroke-opacity"]:"").style("fill",e.style.fill||"").style("fill-opacity",e.style.hasOwnProperty("fill-opacity")?e.style["fill-opacity"]:""),(r=t.selectAll(".red-ui-flow-group-label")).classed("hide",!e.style.label),e.style.label&&(l="n"===(s=e.style["label-position"]||"nw")[l=d=0]?15:e.h-5-16*(e.labels.length-1),labelAnchor="w"===s[1]?(d=5,"start"):"e"===s[1]?(d=e.w-5,"end"):(d=e.w/2,"middle"),e.style.hasOwnProperty("color")?r.style("fill",e.style.color):r.style("fill",null),r.attr("transform","translate("+d+","+l+")").attr("text-anchor",labelAnchor),e.labels?(u=0,t.selectAll(".red-ui-flow-group-label-text").remove(),e.labels.forEach(function(e){r.append("tspan").classed("red-ui-flow-group-label-text",!0).text(e).attr("x",0).attr("y",u),u+=16})):t.selectAll(".red-ui-flow-group-label-text").remove()),delete X[e.id],delete e.dirty)})):a.selectAll(".red-ui-flow-link-selected").data(V,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}).classed("red-ui-flow-link-selected",!1),RED.view.navigator.refresh(),d3.event&&d3.event.preventDefault()}function Ot(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;w.trigger("focus"),window.parent.window.scrollTo(e,t)}catch(e){w.trigger("focus")}}function Nt(e,t){var o,c=(t=t||{addFlow:!1,touchImport:!1,generateIds:!1}).addFlow,u=t.touchImport;if(N!==RED.state.SELECTING_NODE){if("string"==typeof e){if(""===e)return;try{o=JSON.parse(e)}catch(e){var p=new Error(RED._("clipboard.invalidFlow",{message:e.message}));throw p.code="NODE_RED",p}}else o=e;$.isArray(o)||(o=[o]);try{O&&(f=O.changed);var f,i=RED.nodes.import(o,{generateIds:t.generateIds,addFlow:c,importMap:t.importMap});if(i){var h=i.nodes,g=i.links,m=i.groups,b=i.workspaces,v=i.subflows,n=i.removedNodes,y=i.missingWorkspace;c&&y&&RED.workspaces.show(y.id);var w=(w=h.filter(function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()})).concat(m.filter(function(e){return e.z===RED.workspaces.active()})),E=h.map(function(e){return e.changed=!0,e.id});if(Pe(),I.clear(),I.add(w),0<I.length()){for(var D,a,R=(ie=null==ie?[0,0]:ie)[0],x=ie[1],r=(0<I.length()&&(R=(D=I.get(0).n).x,x=D.y),0),s=0,_=I.length(),d=0;d<_;d++)(a=I.get(d)).n.selected=!0,a.n.changed=!0,a.n.moved=!0,a.n.x-=R-ie[0],a.n.y-=x-ie[1],a.n.w=P,a.n.h=A,a.n.resize=!0,a.dx=a.n.x-ie[0],a.dy=a.n.y-ie[1],s="group"===a.n.type?(a.n.groupMoved=!1,r=Math.min(a.n.x-5,r),Math.min(a.n.y-5,s)):(r=Math.min(a.n.x-P/2-5,r),Math.min(a.n.y-A/2-5,s));for(d=0;d<_;d++)if((a=I.get(d)).n.x-=r,a.n.y-=s,a.dx-=r,a.dy-=s,a.n._def.onadd)try{a.n._def.onadd.call(a.n)}catch(e){console.log("Definition error: "+a.n.type+".onadd:",e)}u||(N=RED.state.IMPORT_DRAGGING,U=!1,1===I.length()&&(a=I.get(0),U=a.n.hasOwnProperty("_def")&&(a.n.hasOwnProperty("inputs")&&0<a.n.inputs||!a.n.hasOwnProperty("inputs")&&0<a.n._def.inputs)&&(a.n.hasOwnProperty("outputs")&&0<a.n.outputs||!a.n.hasOwnProperty("outputs")&&0<a.n._def.outputs)))}var k,T,C={t:"add",nodes:E,links:g,groups:m,workspaces:b,subflows:v,dirty:RED.nodes.dirty()},l=(0===I.length()&&RED.nodes.dirty(!0),!O||(k=RED.subflow.refresh(!0))&&(C.subflow={id:O.id,changed:f,instances:k.instances}),n&&(C={t:"multi",events:[{t:"replace",config:n},C]}),RED.history.push(C),xe(),Lt(),[]),j=0,L=0,S=(h.forEach(function(e){e.hasOwnProperty("x")&&e.hasOwnProperty("y")?j++:L++}),m.length);0<b.length&&l.push(RED._("clipboard.flow",{count:b.length})),0<j&&l.push(RED._("clipboard.node",{count:j})),0<S&&l.push(RED._("clipboard.group",{count:S})),0<L&&l.push(RED._("clipboard.configNode",{count:L})),0<v.length&&l.push(RED._("clipboard.subflow",{count:v.length})),n&&0<n.length&&l.push(RED._("clipboard.replacedNodes",{count:n.length})),0<l.length&&(T="<ul><li>"+l.join("</li><li>")+"</li></ul>",RED.notify("<p>"+RED._("clipboard.nodesImported")+"</p>"+T,{id:"clipboard"}))}}catch(e){if("import_conflict"===e.code)throw e;"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}}function It(e){if(N!==RED.state.SELECTING_NODE){var t=RED.workspaces.selection();if(!(0<t.length)&&0<I.length()){for(var o=[],i=0;i<I.length();i++){var n=I.get(i).n;"group"!==n.type&&"subflow"!==n.type&&e!=n.d&&(o.push({t:"edit",node:n,changed:n.changed,changes:{d:n.d}}),e?n.d=!0:delete n.d,n.dirty=!0,n.dirtyStatus=!0,n.changed=!0,RED.events.emit("nodes:change",n))}0<o.length&&(RED.history.push({t:"multi",events:o,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}RED.view.redraw()}}function Pt(){var e={},t=new Set,o=(0<I.length()&&I.forEach(function(e){"group"!==e.n.type&&t.add(e.n)}),H.filter(function(e){return e.selected&&!e.active}));return 0<o.length&&(1===o.length&&o[0].active||o.forEach(function(e){RED.group.getNodes(e,!0).forEach(function(e){t.delete(e)}),t.add(e)})),0<t.size&&(e.nodes=Array.from(t)),0<we.length()&&(e.links=we.toArray(),e.link=e.links[0]),e}return{init:function(){w=$("#red-ui-workspace-chart"),j=d3.select("#red-ui-workspace-chart").append("svg:svg").attr("width",L).attr("height",S).attr("pointer-events","all").style("cursor","crosshair").style("touch-action","none").on("mousedown",function(){Ot()}).on("contextmenu",function(){d3.event.preventDefault()}),(m=j.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","red-ui-workspace-chart-event-layer").on("mousemove",Ce).on("mousedown",ke).on("mouseup",je).on("mouseenter",function(){ne?1!==d3.event.buttons&&(ne.remove(),ne=null):N===RED.state.PANNING&&4!==d3.event.buttons?We():ae&&2!==d3.event.buttons&&(ae.remove(),ae=null,We())}).on("touchend",function(){d3.event.preventDefault(),clearTimeout(z),z=null,RED.touch.radialMenu.active()||je.call(this)}).on("touchcancel",function(){RED.view.DEBUG&&console.warn("eventLayer.touchcancel",N),d3.event.preventDefault(),je.call(this)}).on("touchstart",function(){var e,t,o,i,n,a,r,s;RED.view.DEBUG&&console.warn("eventLayer.touchstart",N),1<d3.event.touches.length?(clearTimeout(z),z=null,d3.event.preventDefault(),e=d3.event.touches.item(0),t=d3.event.touches.item(1),o=e.pageY-t.pageY,i=e.pageX-t.pageX,n=w.offset(),a=[w.scrollLeft(),w.scrollTop()],M=[(t.pageX+i/2-n.left+a[0])/D,(t.pageY+o/2-n.top+a[1])/D],t.pageX,t.pageY,y=Math.sqrt(o*o+i*i)):(r=d3.select(document.body),s=[(e=d3.event.touches.item(0)).pageX,e.pageY],M=[e.pageX,e.pageY],y=0,d3.touches(this)[0],z=setTimeout(function(){z=null,Tt(r,s)},v)),d3.event.preventDefault()}).on("touchmove",function(){var e,t,o,i,n;RED.touch.radialMenu.active()||(RED.view.DEBUG&&console.warn("eventLayer.touchmove",N,E),d3.event.touches.length<2?(z?(n=(i=d3.event.touches.item(0)).pageX-M[0],e=i.pageY-M[1],64<Math.abs(n*n+e*e)&&(clearTimeout(z),z=null,E||Z||(N=RED.state.PANNING,ie=[i.pageX,i.pageY],fe=[w.scrollLeft(),w.scrollTop()]))):ne&&d3.event.preventDefault(),Ce.call(this)):(i=d3.event.touches.item(0),n=d3.event.touches.item(1),e=i.pageY-n.pageY,i=i.pageX-n.pageX,w.offset(),t=[w.scrollLeft(),w.scrollTop()],o=Math.sqrt(e*e+i*i),i=[n.pageX+i/2,n.pageY+e/2],isNaN(o)||(oldScaleFactor=D,D=Math.min(2,Math.max(.3,D+Math.floor(100*o-100*y)/1e4)),n=[M[0]*(D-oldScaleFactor),M[1]*(D-oldScaleFactor)],y=o,w.scrollLeft(t[0]+n[0]),w.scrollTop(t[1]+n[1]),Lt()))),d3.event.preventDefault()})).append("svg:rect").attr("class","red-ui-workspace-chart-background").attr("width",L).attr("height",S),n=m.append("g").attr("class","red-ui-workspace-chart-grid"),Ee(),l=m.append("g"),s=m.append("g"),a=m.append("g"),r=m.append("g"),d=m.append("g"),x=[],RED.events.on("workspace:change",function(e){0!==e.old&&(B[e.old]={left:w.scrollLeft(),top:w.scrollTop()});var t=w.scrollLeft(),o=w.scrollTop(),e=(O=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",O||0===e.workspace),RED.menu.setDisabled("menu-item-workspace-delete",0===e.workspace||1==RED.workspaces.count()||O),B[e.workspace]?(w.scrollLeft(B[e.workspace].left),w.scrollTop(B[e.workspace].top)):(w.scrollLeft(0),w.scrollTop(0)),w.scrollLeft()-t),t=w.scrollTop()-o;null!=ie&&(ie[0]+=e,ie[1]+=t),0===RED.workspaces.selection().length&&Pe(),RED.nodes.eachNode(function(e){e.dirty=!0,e.dirtyStatus=!0}),Me(),xe(),Lt()}),RED.statusBar.add({id:"view-zoom-controls",align:"right",element:$('<span class="button-group"><button class="red-ui-footer-button" id="red-ui-view-zoom-out"><i class="fa fa-minus"></i></button><button class="red-ui-footer-button" id="red-ui-view-zoom-zero"><i class="fa fa-circle-o"></i></button><button class="red-ui-footer-button" id="red-ui-view-zoom-in"><i class="fa fa-plus"></i></button></span>')}),$("#red-ui-view-zoom-out").on("click",Se),RED.popover.tooltip($("#red-ui-view-zoom-out"),RED._("actions.zoom-out"),"core:zoom-out"),$("#red-ui-view-zoom-zero").on("click",Oe),RED.popover.tooltip($("#red-ui-view-zoom-zero"),RED._("actions.zoom-reset"),"core:zoom-reset"),$("#red-ui-view-zoom-in").on("click",Le),RED.popover.tooltip($("#red-ui-view-zoom-in"),RED._("actions.zoom-in"),"core:zoom-in"),w.on("DOMMouseScroll mousewheel",function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),((-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?Se:Le)())}),w.droppable({accept:".red-ui-palette-node",drop:function(e,t){d3.event=e;e=_e($(t.draggable[0]).attr("data-palette-type"));if(e){var o=e.historyEvent,e=e.node,i=(RED.nodes.add(e),RED.utils.getMessageProperty(RED.settings.get("editor"),"view.view-node-show-label")),i=(void 0===i||e._def.hasOwnProperty("showLabel")&&!e._def.showLabel||e._def.defaults.hasOwnProperty("l")||(e.l=i),d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0))),n=t.helper.width(),a=t.helper.height(),r=d3.touches(this)[0]||d3.mouse(this);try{var s="link in"===e.type||"link out"===e.type,d=e.hasOwnProperty("l")?!e.l:s,l=Fe(RED.utils.getNodeLabel(e,e.type),"red-ui-flow-node-label");d?(e.w=A,e.h=Math.max(A,15*(e.outputs||0))):(e.w=Math.max(P,20*Math.ceil((l.width+50+(0<e._def.inputs?7:0))/20)),e.h=Math.max(6+24*l.lines.length,15*(e.outputs||0),30))}catch(e){}r[1]+=this.scrollTop+(a/2-i[1]),r[0]+=this.scrollLeft+(n/2-i[0]),r[1]/=D,r[0]/=D,e.x=r[0],e.y=r[1],F&&(s=[0,0],d=e.x-(G*Math.round((e.x-e.w/2)/G)+e.w/2),l=e.x-(G*Math.round((e.x+e.w/2)/G)-e.w/2),Math.abs(d)<Math.abs(l)?s[0]=d:s[0]=l,s[1]=e.y-G*Math.round(e.y/G),e.x-=s[0],e.y-=s[1]);a=$(t.helper).data("splice"),r=(a&&(RED.nodes.removeLink(a),n={source:a.source,sourcePort:a.sourcePort,target:e},i={source:e,sourcePort:0,target:a.target},RED.nodes.addLink(n),RED.nodes.addLink(i),o.links=[n,i],o.removedLinks=[a]),$(t.helper).data("group"));r&&(RED.group.addToGroup(r,e),(o={t:"multi",events:[o]}).events.push({t:"addToGroup",group:r,nodes:e})),RED.history.push(o),RED.editor.validateNode(e),RED.nodes.dirty(!0),Rt(),Pe(),e.selected=!0,I.add(e),r&&(Et(r,!1),Dt(r),g=r),xe(),Me(),Lt(),e._def.autoedit&&RED.editor.edit(e)}}}),w.on("focus",function(){$("#red-ui-workspace-tabs").addClass("red-ui-workspace-focussed")}),w.on("blur",function(){$("#red-ui-workspace-tabs").removeClass("red-ui-workspace-focussed")}),RED.actions.add("core:copy-selection-to-internal-clipboard",Ge),RED.actions.add("core:cut-selection-to-internal-clipboard",function(){Ge(),Be()}),RED.actions.add("core:paste-from-internal-clipboard",function(){Nt(ve,{generateIds:!0})}),RED.actions.add("core:detach-selected-nodes",function(){var e,t,o=RED.view.selection();o.nodes&&({newLinks:e,removedLinks:t}=RED.nodes.detachNodes(o.nodes),(t.length||e.length)&&(RED.history.push({t:"multi",events:[{t:"delete",links:t},{t:"add",links:e}],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)),nt([o.nodes[0].x,o.nodes[0].y]),N=RED.state.DETACHED_DRAGGING,RED.view.redraw(!0))}),RED.events.on("view:selection-changed",function(e){var t=e.nodes&&0<e.nodes.length,e=t&&1<e.nodes.length;RED.menu.setDisabled("menu-item-edit-cut",!t),RED.menu.setDisabled("menu-item-edit-copy",!t),RED.menu.setDisabled("menu-item-edit-select-connected",!t),RED.menu.setDisabled("menu-item-view-tools-move-to-back",!t),RED.menu.setDisabled("menu-item-view-tools-move-to-front",!t),RED.menu.setDisabled("menu-item-view-tools-move-backwards",!t),RED.menu.setDisabled("menu-item-view-tools-move-forwards",!t),RED.menu.setDisabled("menu-item-view-tools-align-left",!e),RED.menu.setDisabled("menu-item-view-tools-align-center",!e),RED.menu.setDisabled("menu-item-view-tools-align-right",!e),RED.menu.setDisabled("menu-item-view-tools-align-top",!e),RED.menu.setDisabled("menu-item-view-tools-align-middle",!e),RED.menu.setDisabled("menu-item-view-tools-align-bottom",!e),RED.menu.setDisabled("menu-item-view-tools-distribute-horizontally",!e),RED.menu.setDisabled("menu-item-view-tools-distribute-veritcally",!e)}),RED.actions.add("core:delete-selection",Be),RED.actions.add("core:delete-selection-and-reconnect",function(){Be(!0)}),RED.actions.add("core:edit-selected-node",ze),RED.actions.add("core:go-to-selection",function(){var e;0<I.length()&&(e=I.get(0).n,/^subflow:/.test(e.type)?RED.workspaces.show(e.type.substring(8)):"group"===e.type&&(Dt(e),Lt()))}),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:redo",RED.history.redo),RED.actions.add("core:select-all-nodes",Ie),RED.actions.add("core:select-none",Ne),RED.actions.add("core:zoom-in",Le),RED.actions.add("core:zoom-out",Se),RED.actions.add("core:zoom-reset",Oe),RED.actions.add("core:enable-selected-nodes",function(){It(!1)}),RED.actions.add("core:disable-selected-nodes",function(){It(!0)}),RED.actions.add("core:toggle-show-grid",function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):e?n.style("visibility","visible"):n.style("visibility","hidden")}),RED.actions.add("core:toggle-snap-grid",function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):(F=e,Lt())}),RED.actions.add("core:toggle-status",function(e){void 0===e?RED.userSettings.toggle("view-node-status"):(de=e,RED.nodes.eachNode(function(e){e.dirtyStatus=!0,e.dirty=!0}),Lt())}),RED.view.annotations.init(),RED.view.navigator.init(),RED.view.tools.init(),RED.view.annotations.register("red-ui-flow-node-changed",{type:"badge",class:"red-ui-flow-node-changed",element:function(){var e=document.createElementNS("http://www.w3.org/2000/svg","circle");return e.setAttribute("cx",5),e.setAttribute("cy",5),e.setAttribute("r",5),e},show:function(e){return e.changed||e.moved}}),RED.view.annotations.register("red-ui-flow-node-error",{type:"badge",class:"red-ui-flow-node-error",element:function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("d","M 0,9 l 10,0 -5,-8 z"),t},tooltip:function(e){if(e.validationErrors&&0<e.validationErrors.length)return RED._("editor.errors.invalidProperties")+"\n  - "+e.validationErrors.join("\n  - ")},show:function(e){return!e.valid}}),RED.settings.get("editor.view.view-store-zoom")&&(o=parseFloat(RED.settings.getLocal("zoom-level")),isNaN(o)||(D=o));var e=null;function t(){B[RED.workspaces.active()]={left:w.scrollLeft(),top:w.scrollTop()},RED.settings.setLocal("scroll-positions",JSON.stringify(B))}if(w.on("scroll",function(){RED.settings.get("editor.view.view-store-position")&&(e&&clearTimeout(e),e=setTimeout(t,200))}),RED.settings.get("editor.view.view-store-position")){var o=RED.settings.getLocal("scroll-positions");if(o)try{B=JSON.parse(o)}catch(e){}}},state:function(e){if(null==e)return N;N=e},updateActive:xe,redraw:function(e,t){e&&(xe(),Me()),(t?St:Lt)()},focus:Ot,importNodes:Nt,calculateTextWidth:function(e,t){for(var o=qe(e),i=0,n=0;n<o.length;n++){var a=Ve(o[n],t)[0];i<a&&(i=a)}return i},select:function(e){var t;void 0!==e&&(Pe(),"string"==typeof e?(t=RED.nodes.node(e))&&(t.selected=!0,t.dirty=!0,I.clear(),I.add(t)):e&&e.nodes&&(xe(),I.clear(),e.nodes.forEach(function(e){"group"!==e.type?(e.selected=!0,e.dirty=!0,I.add(e)):Et(e,!0)}))),Me(),Lt()},selection:Pt,scale:function(){return D},getLinksAtPoint:function(e,t){for(var o=[],i=j.selectAll(".red-ui-flow-link-background")[0],n=0;n<i.length;n++){var a=i[n].getBBox();e>=a.x&&t>=a.y&&e<=a.x+a.width&&t<=a.y+a.height&&o.push(i[n])}return o},getGroupAtPoint:$t,getActiveGroup:function(){return g},reveal:function(e,t){var o,i,n,a,r,s;RED.nodes.workspace(e)||RED.nodes.subflow(e)?RED.workspaces.show(e):(o=RED.nodes.node(e)||RED.nodes.group(e))&&(!o.z||"group"!==o.type&&"config"===o._def.category?"config"===o._def.category&&RED.sidebar.config.show(e):(o.dirty=!0,RED.workspaces.show(o.z),e=[w.width()/D,w.height()/D],a=[w.scrollLeft()/D,w.scrollTop()/D],n=o.x,i=o.y,"group"===o.type&&(n+=o.w/2,i+=o.h/2),(n<a[0]||i<a[1]||e[0]+a[0]<n||e[1]+a[1]<i)&&(n="-="+(a[0]-n+e[0]/2)*D,a="-="+(a[1]-i+e[1]/2)*D,w.animate({scrollLeft:n,scrollTop:a},200)),!1!==t&&(o.highlighted=!0,o._flashing||(o._flashing=!0,r=22,(s=function(){r--,o.dirty=!0,0<=r?(o.highlighted=!o.highlighted,setTimeout(s,100)):(o.highlighted=!1,delete o._flashing),RED.view.redraw()})()))))},gridSize:function(e){if(void 0===e)return G;G=Math.max(5,e),Ee()},getActiveNodes:function(){return J},getSubflowPorts:function(){var o=[];return O&&(d.selectAll(".red-ui-flow-subflow-port-output").data(O.out,function(e,t){return e.id}).each(function(e,t){o.push(e)}),d.selectAll(".red-ui-flow-subflow-port-input").data(O.in,function(e,t){return e.id}).each(function(e,t){o.push(e)}),d.selectAll(".red-ui-flow-subflow-port-status").data(O.status?[O.status]:[],function(e,t){return e.id}).each(function(e,t){o.push(e)})),o},selectNodes:function(e){$("#red-ui-workspace-tabs-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-header-shade").show(),$("#red-ui-workspace").addClass("red-ui-workspace-select-mode"),N=RED.state.SELECTING_NODE,Pe(),e.selected&&e.selected.forEach(function(e){e=RED.nodes.node(e);e&&(e.selected=!0,e.dirty=!0,I.add(e))}),Lt();function t(){Pe(),$("#red-ui-workspace-tabs-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-header-shade").hide(),$("#red-ui-workspace").removeClass("red-ui-workspace-select-mode"),We(),o.close()}(u=e||{}).done=function(e){t(),u.onselect&&u.onselect(e)};var e=[{text:RED._("common.label.cancel"),click:function(e){t(),u.oncancel&&u.oncancel()}}],o=(u.single||e.push({text:RED._("common.label.done"),class:"primary",click:function(e){var t=I.nodes();u.done(t)}}),RED.notify(u.prompt||RED._("workspace.selectNodes"),{modal:!1,fixed:!0,type:"compact",buttons:e}))},scroll:function(e,t){w.scrollLeft(w.scrollLeft()+e),w.scrollTop(w.scrollTop()+t)},clickNodeButton:function(e){e._def.button&&kt(e)},clipboard:function(){return ve},redrawStatus:jt,showQuickAddDialog:Te,calculateNodeDimensions:function(t){var e=[P,A];try{var o="link in"===t.type||"link out"===t.type,i=t.hasOwnProperty("l")?!t.l:o,n=Fe(RED.utils.getNodeLabel(t,t.type),"red-ui-flow-node-label");e[1]=i?Math.max(A,15*(t.outputs||0)):Math.max(6+24*n.lines.length,15*(t.outputs||0),30),e[0]=i?A:Math.max(P,20*Math.ceil((n.width+50+(0<t._def.inputs?7:0))/20))}catch(e){console.log("Error",t)}return e},getElementPosition:Qe,showTooltip:tt}}(),RED.view.annotations=function(){var s,d,c={};function u(e,t){var i,n,a,o=c[e],r=(t.el.__annotations__=t.el.__annotations__||[],document.createElementNS("http://www.w3.org/2000/svg","g")),e=(r.setAttribute("class",o.class||""),t.el.__annotations__.push({id:e,element:r}),o.element(t.node));o.tooltip&&(e.addEventListener("mouseenter",(i=e,n=t.node,a=o.tooltip,function(){var o="function"==typeof a?a(n):a;o&&(clearTimeout(s),s=setTimeout(function(){var e=RED.view.getElementPosition(i),t=i.getBoundingClientRect();s=null,d=RED.view.showTooltip(e[0]+t.width/2,e[1],o,"top")},500))})),e.addEventListener("mouseleave",l)),r.appendChild(e),t.el.appendChild(r)}function l(){clearTimeout(s),d&&(d.remove(),d=null)}return{init:function(){RED.hooks.add("viewRedrawNode.annotations",function(e){try{e.node.__pendingAnnotation__&&(u(e.node.__pendingAnnotation__,e),delete e.node.__pendingAnnotation__);for(var t=0,o=0,i=0,n=e.el.__annotations__.length;i<n;i++){var a,r,s,d,l=e.el.__annotations__[i];c.hasOwnProperty(l.id)?(a=c[l.id],r=!0,s="badge"===a.type,void 0!==a.show&&(r="string"==typeof a.show?!!e.node[a.show]:"function"==typeof a.show?a.show(e.node):!!a.show,l.element.classList.toggle("hide",!r)),s?r&&(t+=(d=l.element.getBoundingClientRect()).width,l.element.setAttribute("transform","translate("+(e.node.w-3-t)+", -8)"),t+=4):r&&(d=l.element.getBoundingClientRect(),l.element.setAttribute("transform","translate("+(3+o)+", -12)"),o+=d.width+4)):(l.element.parentNode.removeChild(l.element),e.el.__annotations__.splice(i,1),i--,n--)}}catch(e){console.log(e)}})},register:function(t,o){if("badge"!==o.type)throw new Error("Unsupported annotation type: "+o.type);c[t]=o,RED.hooks.add("viewAddNode.annotation-"+t,function(e){o.filter&&!o.filter(e.node)||u(t,e)}),RED.view.getActiveNodes().forEach(function(e){e.__pendingAnnotation__=t}),RED.view.redraw()},unregister:function(e){delete c[e],RED.hooks.remove("*.annotation-"+e),RED.view.redraw()}}}(),RED.view.navigator=function(){var e,c,o,u,p,i,n,a,r,s=25,d=5e3/s,l=5e3/s,f=!1;function h(){var e;f&&((e=u.selectAll(".red-ui-navigator-node").data(RED.view.getActiveNodes(),function(e){return e.id})).exit().remove(),e.enter().insert("rect").attr("class","red-ui-navigator-node").attr("pointer-events","none"),e.each(function(e){d3.select(this).attr("x",function(e){return(e.x-e.w/2)/s}).attr("y",function(e){return(e.y-e.h/2)/s}).attr("width",function(e){return Math.max(9,e.w/s)}).attr("height",function(e){return Math.max(3,e.h/s)}).attr("fill",function(e){return RED.utils.getNodeColor(e.type,e._def)})}))}function g(){r||t()}function t(){o&&(i=RED.view.scale(),n=[$("#red-ui-workspace-chart").width(),$("#red-ui-workspace-chart").height()],p=[$("#red-ui-workspace-chart").scrollLeft(),$("#red-ui-workspace-chart").scrollTop()],o.attr("x",p[0]/s).attr("y",p[1]/s).attr("width",n[0]/s/i).attr("height",n[1]/s/i))}function m(){f?(f=!1,e.fadeOut(100),$("#red-ui-workspace-chart").off("scroll",g),$("#red-ui-view-navigate").removeClass("selected")):(f=!0,$("#red-ui-view-navigate").addClass("selected"),t(),h(),$("#red-ui-workspace-chart").on("scroll",g),e.fadeIn(200))}return{init:function(){$(window).on("resize",t),RED.events.on("sidebar:resize",t),RED.actions.add("core:toggle-navigator",m),e=$("<div>").css({position:"absolute",bottom:$("#red-ui-workspace-footer").height(),right:0,zIndex:1}).appendTo("#red-ui-workspace").hide(),(c=d3.select(e[0]).append("svg:svg").attr("width",d).attr("height",l).attr("pointer-events","all").attr("id","red-ui-navigator-canvas")).append("rect").attr("x",0).attr("y",0).attr("width",d).attr("height",l).style({fill:"none",stroke:"none",pointerEvents:"all"}).on("mousedown",function(){i=RED.view.scale(),n=[$("#red-ui-workspace-chart").width(),$("#red-ui-workspace-chart").height()],a=[n[0]/s/i,n[1]/s/i];var e=Math.max(0,Math.min(d3.event.offsetX+a[0]/2,d)-a[0]),t=Math.max(0,Math.min(d3.event.offsetY+a[1]/2,l)-a[1]);o.attr("x",e).attr("y",t),r=!0,$("#red-ui-workspace-chart").scrollLeft(e*s*i),$("#red-ui-workspace-chart").scrollTop(t*s*i)}).on("mousemove",function(){var e,t;r&&(0!==d3.event.buttons?(e=Math.max(0,Math.min(d3.event.offsetX+a[0]/2,d)-a[0]),t=Math.max(0,Math.min(d3.event.offsetY+a[1]/2,l)-a[1]),o.attr("x",e).attr("y",t),$("#red-ui-workspace-chart").scrollLeft(e*s*i),$("#red-ui-workspace-chart").scrollTop(t*s*i)):r=!1)}).on("mouseup",function(){r=!1}),o=c.append("rect").attr("class","red-ui-navigator-border"),u=c.append("svg:g"),RED.statusBar.add({id:"view-navigator",align:"right",element:$('<button class="red-ui-footer-button-toggle single" id="red-ui-view-navigate"><i class="fa fa-map-o"></i></button>')}),$("#red-ui-view-navigate").on("click",function(e){e.preventDefault(),m()}),RED.popover.tooltip($("#red-ui-view-navigate"),RED._("actions.toggle-navigator"),"core:toggle-navigator")},refresh:h,resize:t,toggle:m}}(),RED.view.tools=function(){function e(o){var e=RED.view.selection(),i=new Set;e.nodes&&0<e.nodes.length&&(e.nodes.forEach(function(e){var t;i.has(e)||("all"===o?t=RED.nodes.getAllFlowNodes(e):"up"===o?t=[e].concat(RED.nodes.getAllUpstreamNodes(e)):"down"===o&&(t=[e].concat(RED.nodes.getAllDownstreamNodes(e))),t.forEach(function(e){i.add(e)}))}),RED.view.select({nodes:Array.from(i)}))}function t(){var i,e=RED.view.selection();e.nodes&&(i=[],e.nodes.forEach(function(e){var t=e.w/2+Math.round((e.x-e.w/2)/RED.view.gridSize())*RED.view.gridSize(),o=Math.round(e.y/RED.view.gridSize())*RED.view.gridSize();e.x===t&&e.y===o||(i.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=t,e.y=o,e.dirty=!0,e.moved=!0)}),0<i.length&&(RED.history.push({t:"move",nodes:i,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0)))}var d=null,l=!1;function c(){if(l=!1,0<d.length){for(var e=[],t=0;t<d.length;t++)e.push({n:d[t].n,ox:d[t].ox,oy:d[t].oy,moved:d[t].moved}),d[t].n.moved=!0,d[t].n.dirty=!0,delete d[t].ox,delete d[t].oy;RED.view.redraw(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),d=null}}function o(e,t){if(null===d){d=[];var o=RED.view.selection();if(o.nodes)for(;0<o.nodes.length;){var i=o.nodes.shift();d.push({n:i}),"group"===i.type&&(o.nodes=o.nodes.concat(i.nodes))}}if(d&&0<d.length){l||($(document).one("keyup",c),l=!0);for(var n,a=0,r=0,s=0;s<d.length;s++)null==(n=d[s]).ox&&null==n.oy&&(n.ox=n.n.x,n.oy=n.n.y,n.moved=n.n.moved),n.n.moved=!0,n.n.dirty=!0,n.n.x+=e,n.n.y+=t,n.n.dirty=!0,r="group"===n.n.type?(RED.group.markDirty(n.n),a=Math.min(n.n.x-5,a),Math.min(n.n.y-5,r)):(a=Math.min(n.n.x-n.n.w/2-5,a),Math.min(n.n.y-n.n.h/2-5,r));if(0!==a||0!==r)for(i=0;i<d.length;i++)(n=d[i]).n.x-=a,n.n.y-=r;RED.view.redraw()}else RED.view.scroll(10*e,10*t)}function i(n){var e=RED.view.selection(),a=[],t=[];e.nodes&&e.nodes.forEach(function(e){"subflow"!==e.type&&"group"!==e.type?t.push(e):"group"===e.type&&(t=t.concat(RED.group.getNodes(e,!0)))}),t.forEach(function(e){var t=!1,o=void 0===e.l||e.l,i=!e._def.hasOwnProperty("showLabel")||e._def.showLabel;n?!1!==e.l&&(i||e.hasOwnProperty("l"))||(t=e.l=!0):(!i||e.hasOwnProperty("l")&&!0!==e.l)&&(i||!0!==e.l)||(t=!(e.l=!1)),t&&(a.push({t:"edit",node:e,changed:e.changed,changes:{l:o}}),e.changed=!0,e.dirty=!0,e.resize=!0)}),0<a.length&&(RED.history.push({t:"multi",events:a,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)),RED.view.redraw()}function n(){var i={x:0,y:0},e=RED.view.getActiveGroup(),n=(e?(candidates=RED.group.getNodes(e,!1),i=e):candidates=RED.view.getActiveNodes(),[]);candidates.forEach(function(e){var t=e.x-i.x,o=e.y-i.x;n.push({node:e,delta:o*o+t*t})}),0<n.length&&(n.sort(function(e,t){return e.delta-t.delta}),(e=n[0].node)&&(RED.view.select({nodes:[e]}),RED.view.reveal(e.id,!1)))}function u(e){return RED.nodes.filterLinks({source:e}).map(function(e){return e.target})}function p(e){return RED.nodes.filterLinks({target:e}).map(function(e){return e.source})}function f(e){var t=new Set;return p(e).forEach(function(e){u(e).forEach(function(e){t.add(e)})}),u(e).forEach(function(e){p(e).forEach(function(e){t.add(e)})}),t.delete(e),Array.from(t)}function a(r){var s,e,d,t,o=RED.view.selection();o.nodes&&1===o.nodes.length?(s=o.nodes[0],d=[],(e=(e=RED.nodes.filterNodes({z:s.z})).concat(RED.view.getSubflowPorts())).forEach(function(e){if(e!==s){var t,o=e.x-s.x,i=e.y-s.y,n=i*i+o*o,a=180/Math.PI*Math.atan2(i,o);switch(a<0&&(a+=360),360<a&&(a-=360),r){case"up":if(a<210||330<a)return;t=Math.max(Math.abs(270-a)/60,.2);break;case"down":if(a<30||150<a)return;t=Math.max(Math.abs(90-a)/60,.2);break;case"left":if(a<140||220<a)return;t=Math.max(Math.abs(180-a)/40,.1);break;case"right":if(40<a&&a<320)return;t=Math.max(Math.abs(a)/40,.1)}t=Math.max(t,.1),d.push({node:e,d:n,w:t,delta:n*t})}}),0<d.length&&(d.sort(function(e,t){return e.delta-t.delta}),(t=d[0].node)&&(RED.view.select({nodes:[t]}),RED.view.reveal(t.id,!1)))):0===RED.workspaces.selection().length&&(e=RED.view.getActiveNodes(),d=[],e.forEach(function(e){var t=e.x,o=e.y;d.push({node:e,delta:o*o+t*t})}),0<d.length&&(d.sort(function(e,t){return e.delta-t.delta}),(t=d[0].node)&&(RED.view.select({nodes:[t]}),RED.view.reveal(t.id,!1))))}function r(s){var d,l,e=RED.view.selection();e.nodes&&1<e.nodes.length&&(d=[],l={minX:Number.MAX_SAFE_INTEGER,minY:Number.MAX_SAFE_INTEGER,maxX:Number.MIN_SAFE_INTEGER,maxY:Number.MIN_SAFE_INTEGER},e.nodes.forEach(function(e){"group"===e.type?(l.minX=Math.min(l.minX,e.x),l.minY=Math.min(l.minY,e.y),l.maxX=Math.max(l.maxX,e.x+e.w),l.maxY=Math.max(l.maxY,e.y+e.h)):(l.minX=Math.min(l.minX,e.x-e.w/2),l.minY=Math.min(l.minY,e.y-e.h/2),l.maxX=Math.max(l.maxX,e.x+e.w/2),l.maxY=Math.max(l.maxY,e.y+e.h/2))}),l.midX=l.minX+(l.maxX-l.minX)/2,l.midY=l.minY+(l.maxY-l.minY)/2,e.nodes.forEach(function(e){var t,o,i,n,a,r="group"===e.type;switch(s){case"top":t=e.x,o=l.minY+(r?0:e.h/2);break;case"bottom":t=e.x,o=l.maxY-(r?e.h:e.h/2);break;case"left":t=l.minX+(r?0:e.w/2),o=e.y;break;case"right":t=l.maxX-(r?e.w:e.w/2),o=e.y;break;case"middle":t=e.x,o=l.midY-(r?e.h/2:0);break;case"center":t=l.midX-(r?e.w/2:0),o=e.y}e.x===t&&e.y===o||(r?(i=RED.group.getNodes(e,!0),n=e.x-t,a=e.y-o,i.forEach(function(e){"group"!==e.type&&(d.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=e.x-n,e.y=e.y-a,e.dirty=!0,e.moved=!0)})):(d.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=t,e.y=o,e.dirty=!0,e.moved=!0))}),0<d.length&&(RED.history.push({t:"move",nodes:d,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0)))}function h(i){var e=RED.view.selection();if(e.nodes&&2<e.nodes.length){var c=[],n={minX:Number.MAX_SAFE_INTEGER,minY:Number.MAX_SAFE_INTEGER,maxX:Number.MIN_SAFE_INTEGER,maxY:Number.MIN_SAFE_INTEGER},a=[],r=[],t=(e.nodes.forEach(function(e){var t,o="group"===e.type?(t=e.x+e.w/2,e.y+e.h/2):(t=e.x,e.y);"h"===i?(t<n.minX&&(a=[],n.minX=t),t===n.minX&&a.push(e),t>n.maxX&&(r=[],n.maxX=t),t===n.maxX&&r.push(e)):(o<n.minY&&(a=[],n.minY=o),o===n.minY&&a.push(e),o>n.maxY&&(r=[],n.maxY=o),o===n.maxY&&r.push(e))}),a[0]),o=r[0],u=0,p=e.nodes.filter(function(e){return e.id!==t.id&&e.id!==o.id&&(u+="h"===i?e.w:e.h,!0)}).sort(function(e,t){return"h"===i?e.x-t.x:e.y-t.y}),e=t.x+t.w/2,f=t.y+t.h/2,h=("group"===t.type&&(e=t.x+t.w,f=t.y+t.h),o.x),g=o.y;"group"!==o.type&&(h-=o.w/2,g-=o.h/2);for(var m=("h"===i?h-e-u:g-f-u)/(p.length+1),s=e,d=f;0<p.length;){"h"===i?s+=m:d+=m;var b,v,y,l=p.shift(),w="group"===l.type,E=l.x,D=l.y;w||(s+=l.w/2,d+=l.h/2),("h"===i&&E!==s||"v"===i&&D!==d)&&(w?(b=RED.group.getNodes(l,!0),v="h"===i?E-s:0,y="v"===i?D-d:0,b.forEach(function(e){"group"!==e.type&&(c.push({n:e,ox:e.x,oy:e.y,moved:e.moved}),e.x=e.x-v,e.y=e.y-y,e.dirty=!0,e.moved=!0)})):(c.push({n:l,ox:l.x,oy:l.y,moved:l.moved}),"h"===i?l.x=s:l.y=d,l.dirty=!0,l.moved=!0)),w?(s+=l.w,d+=l.h):(s+=l.w/2,d+=l.h/2)}0<c.length&&(RED.history.push({t:"move",nodes:c,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}function s(e){var t,o,i,n=RED.view.selection();n.nodes&&(t=[],n.nodes.forEach(function(e){"group"===e.type?t=t.concat(RED.group.getNodes(e,!0).filter(function(e){return"group"!==e.type})):"subflow"!==e.type&&t.push(e)}),0<t.length&&(n=t[0].z,o=RED.nodes.getNodeOrder(n),"forwards"===e?i=RED.nodes.moveNodesForwards(t):"backwards"===e?i=RED.nodes.moveNodesBackwards(t):"front"===e?i=RED.nodes.moveNodesToFront(t):"back"===e&&(i=RED.nodes.moveNodesToBack(t)),0<i.length&&(e=RED.nodes.getNodeOrder(n),RED.history.push({t:"reorder",nodes:{z:n,from:o,to:e},dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))))}return{init:function(){RED.actions.add("core:show-selected-node-labels",function(){i(!0)}),RED.actions.add("core:hide-selected-node-labels",function(){i(!1)}),RED.actions.add("core:scroll-view-up",function(){RED.view.scroll(0,-RED.view.gridSize())}),RED.actions.add("core:scroll-view-right",function(){RED.view.scroll(RED.view.gridSize(),0)}),RED.actions.add("core:scroll-view-down",function(){RED.view.scroll(0,RED.view.gridSize())}),RED.actions.add("core:scroll-view-left",function(){RED.view.scroll(-RED.view.gridSize(),0)}),RED.actions.add("core:step-view-up",function(){RED.view.scroll(0,-5*RED.view.gridSize())}),RED.actions.add("core:step-view-right",function(){RED.view.scroll(5*RED.view.gridSize(),0)}),RED.actions.add("core:step-view-down",function(){RED.view.scroll(0,5*RED.view.gridSize())}),RED.actions.add("core:step-view-left",function(){RED.view.scroll(-5*RED.view.gridSize(),0)}),RED.actions.add("core:move-selection-up",function(){o(0,-1)}),RED.actions.add("core:move-selection-right",function(){o(1,0)}),RED.actions.add("core:move-selection-down",function(){o(0,1)}),RED.actions.add("core:move-selection-left",function(){o(-1,0)}),RED.actions.add("core:move-selection-forwards",function(){s("forwards")}),RED.actions.add("core:move-selection-backwards",function(){s("backwards")}),RED.actions.add("core:move-selection-to-front",function(){s("front")}),RED.actions.add("core:move-selection-to-back",function(){s("back")}),RED.actions.add("core:step-selection-up",function(){o(0,-RED.view.gridSize())}),RED.actions.add("core:step-selection-right",function(){o(RED.view.gridSize(),0)}),RED.actions.add("core:step-selection-down",function(){o(0,RED.view.gridSize())}),RED.actions.add("core:step-selection-left",function(){o(-RED.view.gridSize(),0)}),RED.actions.add("core:select-connected-nodes",function(){e("all")}),RED.actions.add("core:select-downstream-nodes",function(){e("down")}),RED.actions.add("core:select-upstream-nodes",function(){e("up")}),RED.actions.add("core:go-to-next-node",function(){var o,e;(e=RED.view.selection()).nodes&&1===e.nodes.length?(o=e.nodes[0],0<(e=RED.nodes.filterLinks({source:o})).length&&(e.sort(function(e,t){return Math.abs(e.target.y-o.y)-Math.abs(t.target.y-o.y)}),(e=e[0].target)&&(RED.view.select({nodes:[e]}),RED.view.reveal(e.id,!1)))):0===RED.workspaces.selection().length&&n()}),RED.actions.add("core:go-to-previous-node",function(){var o,e;(e=RED.view.selection()).nodes&&1===e.nodes.length?(o=e.nodes[0],0<(e=RED.nodes.filterLinks({target:o})).length&&(e.sort(function(e,t){return Math.abs(e.source.y-o.y)-Math.abs(t.source.y-o.y)}),(e=e[0].source)&&(RED.view.select({nodes:[e]}),RED.view.reveal(e.id,!1)))):0===RED.workspaces.selection().length&&n()}),RED.actions.add("core:go-to-next-sibling",function(){var o,e;(e=RED.view.selection()).nodes&&1===e.nodes.length?0<(e=f(o=e.nodes[0])).length&&((e=e.filter(function(e){return e.y>o.y})).sort(function(e,t){return Math.abs(e.y-o.y)-Math.abs(t.y-o.y)}),(e=e[0])&&(RED.view.select({nodes:[e]}),RED.view.reveal(e.id,!1))):0===RED.workspaces.selection().length&&n()}),RED.actions.add("core:go-to-previous-sibling",function(){var o,e;(e=RED.view.selection()).nodes&&1===e.nodes.length?0<(e=f(o=e.nodes[0])).length&&((e=e.filter(function(e){return e.y<o.y})).sort(function(e,t){return Math.abs(e.y-o.y)-Math.abs(t.y-o.y)}),(e=e[0])&&(RED.view.select({nodes:[e]}),RED.view.reveal(e.id,!1))):0===RED.workspaces.selection().length&&n()}),RED.actions.add("core:go-to-nearest-node-on-left",function(){a("left")}),RED.actions.add("core:go-to-nearest-node-on-right",function(){a("right")}),RED.actions.add("core:go-to-nearest-node-above",function(){a("up")}),RED.actions.add("core:go-to-nearest-node-below",function(){a("down")}),RED.actions.add("core:align-selection-to-grid",t),RED.actions.add("core:align-selection-to-left",function(){r("left")}),RED.actions.add("core:align-selection-to-right",function(){r("right")}),RED.actions.add("core:align-selection-to-top",function(){r("top")}),RED.actions.add("core:align-selection-to-bottom",function(){r("bottom")}),RED.actions.add("core:align-selection-to-middle",function(){r("middle")}),RED.actions.add("core:align-selection-to-center",function(){r("center")}),RED.actions.add("core:distribute-selection-horizontally",function(){h("h")}),RED.actions.add("core:distribute-selection-vertically",function(){h("v")}),RED.actions.add("core:wire-series-of-nodes",function(){var e=RED.view.selection();if(e.nodes&&1<e.nodes.length){for(var t=0,o=[];t<e.nodes.length-1;){var i=e.nodes[t],n=e.nodes[t+1];0<i.outputs&&0<n.inputs&&0===RED.nodes.filterLinks({source:i,target:n,sourcePort:0}).length&&(RED.nodes.addLink(i={source:i,target:n,sourcePort:0}),o.push(i)),t++}0<o.length&&(RED.history.push({t:"add",links:o,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}),RED.actions.add("core:wire-node-to-multiple",function(){var e=RED.view.selection();if(e.nodes&&1<e.nodes.length){var t=e.nodes[0];if(0!==t.outputs){for(var o=1,i=[];o<e.nodes.length;){var n=e.nodes[o];0<n.inputs&&0===RED.nodes.filterLinks({source:t,target:n,sourcePort:Math.min(t.outputs-1,o-1)}).length&&(n={source:t,target:n,sourcePort:Math.min(t.outputs-1,o-1)},RED.nodes.addLink(n),i.push(n)),o++}0<i.length&&(RED.history.push({t:"add",links:i,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),RED.view.redraw(!0))}}})},alignSelectionToGrid:t,moveSelection:o}}(),RED.sidebar=function(){var a,r={},o=null;var n={};function t(e){e?($("#red-ui-main-container").removeClass("red-ui-sidebar-closed"),a.resize()):$("#red-ui-main-container").addClass("red-ui-sidebar-closed"),RED.events.emit("sidebar:resize")}function s(e,t){(e=":first"===e?o||RED.settings.get("editor.sidebar.order",["info","help","version-control","debug"])[0]:e)&&(!i(e)&&r[e]&&a.addTab(r[e]),a.activateTab(e),t||RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function i(e){return a.contains(e)}return n.dragging=!1,{init:function(){var e;$("#red-ui-sidebar-separator").draggable({axis:"x",start:function(e,t){n.closing=!1,n.opening=!1;var o=$("#red-ui-editor").width();n.start=t.position.left,n.chartWidth=$("#red-ui-workspace").width(),n.chartRight=o-$("#red-ui-workspace").width()-$("#red-ui-workspace").offset().left-2,n.dragging=!0,RED.menu.isSelected("menu-item-sidebar")||(n.opening=!0,$("#red-ui-sidebar").addClass("closing"),$("#red-ui-workspace").css("right",7),$("#red-ui-editor-stack").css("right",8),$("#red-ui-sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")),n.width=$("#red-ui-sidebar").width()},drag:function(e,t){var o=t.position.left-n.start,i=n.width-o,t=(n.opening&&(i-=3),150<i&&n.chartWidth+o<200&&(t.position.left=200+n.start-n.chartWidth,o=t.position.left-n.start,i=n.width-o),i<150?(n.closing||($("#red-ui-sidebar").addClass("closing"),n.closing=!0),n.opening||(t.position.left=n.width-((i=150)-n.start),o=t.position.left-n.start)):150<i&&(n.closing||n.opening)&&(n.closing=!1,$("#red-ui-sidebar").removeClass("closing")),n.chartRight-o);$("#red-ui-workspace").css("right",t),$("#red-ui-editor-stack").css("right",1+t),$("#red-ui-sidebar").width(i),a.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){n.dragging=!1,n.closing&&($("#red-ui-sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#red-ui-sidebar").width()<180&&($("#red-ui-sidebar").width(180),$("#red-ui-workspace").css("right",187),$("#red-ui-editor-stack").css("right",188))),$("#red-ui-sidebar-separator").css("left","auto"),$("#red-ui-sidebar-separator").css("right",$("#red-ui-sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}}),(e=$('<div class="red-ui-sidebar-control-right"><i class="fa fa-chevron-right"</div>').appendTo($("#red-ui-sidebar-separator"))).on("click",function(){e.hide(),RED.menu.toggleSelected("menu-item-sidebar")}),$("#red-ui-sidebar-separator").on("mouseenter",function(){n.dragging||(RED.menu.isSelected("menu-item-sidebar")?e.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left"):e.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left"),e.toggle("slide",{direction:"right"},200))}),$("#red-ui-sidebar-separator").on("mouseleave",function(){n.dragging||(e.stop(!1,!0),e.hide())}),a=RED.tabs.create({element:$('<ul id="red-ui-sidebar-tabs"></ul>').appendTo("#red-ui-sidebar"),onchange:function(e){$("#red-ui-sidebar-content").children().hide(),$("#red-ui-sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show(),RED.settings.setLocal("last-sidebar-tab",e.id)},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},collapsible:!0,onreorder:function(e){RED.settings.set("editor.sidebar.order",e)},order:RED.settings.get("editor.sidebar.order",["info","help","version-control","debug"])}),$('<div id="red-ui-sidebar-content"></div>').appendTo("#red-ui-sidebar"),$('<div id="red-ui-sidebar-footer" class="red-ui-component-footer"></div>').appendTo("#red-ui-sidebar"),$('<div id="red-ui-sidebar-shade" class="hide"></div>').appendTo("#red-ui-sidebar"),RED.actions.add("core:toggle-sidebar",function(e){void 0===e?RED.menu.toggleSelected("menu-item-sidebar"):t(e)}),RED.popover.tooltip($("#red-ui-sidebar-separator").find(".red-ui-sidebar-control-right"),RED._("keyboard.toggleSidebar"),"core:toggle-sidebar"),o=RED.settings.getLocal("last-sidebar-tab"),RED.sidebar.info.init(),RED.sidebar.help.init(),RED.sidebar.config.init(),RED.sidebar.context.init(),$("#red-ui-editor").width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(e,t,o,i){var n;"string"==typeof e?n={id:t.id,label:e,name:e,content:t,closeable:o,visible:i}:"object"==typeof e&&(n=e),delete n.closeable,n.wrapper=$("<div>",{style:"height:100%"}).appendTo("#red-ui-sidebar-content"),n.wrapper.append(n.content),n.wrapper.hide(),n.enableOnEdit||(n.shade=$("<div>",{class:"red-ui-sidebar-shade hide"}).appendTo(n.wrapper)),n.toolbar&&($("#red-ui-sidebar-footer").append(n.toolbar),$(n.toolbar).hide()),n.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+n.id,label:n.name,onselect:function(){s(n.id)},group:"sidebar-tabs"}),n.iconClass=n.iconClass||"fa fa-square-o",!1!==(r[n.id]=n).visible&&a.addTab(r[n.id])},removeTab:function(e){a.removeTab(e),$(r[e].wrapper).remove(),r[e].footer&&r[e].footer.remove(),delete r[e],RED.menu.removeItem("menu-item-view-menu-"+e)},show:s,containsTab:i,toggleSidebar:t}}(),RED.palette=function(){var i,k=["config","unknown","deprecated"],w=["subflows","common","function","network","input","output","sequence","parser","storage","analysis","social","advanced"],E={};function D(e,t,o,i){0===$("#red-ui-palette-base-category-"+t).length&&n(e,t,i+":palette.label."+t),$("#red-ui-palette-container-"+t).show(),0===$("#red-ui-palette-"+o).length&&$("#red-ui-palette-base-category-"+t).append('<div id="red-ui-palette-'+o+'"></div>')}function n(e,t,o){var o=((o=RED._(o,{defaultValue:t}))||t).replace(/_/g," "),i=$('<div id="red-ui-palette-container-'+t+'" class="red-ui-palette-category hide"><div id="red-ui-palette-header-'+t+'" class="red-ui-palette-header"><i class="expanded fa fa-angle-down"></i><span>'+o+'</span></div><div class="red-ui-palette-content" id="red-ui-palette-base-category-'+t+'"><div id="red-ui-palette-'+t+'"></div><div id="red-ui-palette-'+t+'-input"></div><div id="red-ui-palette-'+t+'-output"></div><div id="red-ui-palette-'+t+'-function"></div></div></div>').appendTo("#red-ui-palette-container");i.data("category",e),i.data("label",o),E[t]={container:i,close:function(){i.removeClass("red-ui-palette-open"),i.addClass("red-ui-palette-closed"),$("#red-ui-palette-base-category-"+t).slideUp(),$("#red-ui-palette-header-"+t+" i").removeClass("expanded")},open:function(){i.addClass("red-ui-palette-open"),i.removeClass("red-ui-palette-closed"),$("#red-ui-palette-base-category-"+t).slideDown(),$("#red-ui-palette-header-"+t+" i").addClass("expanded")},toggle:function(){i.hasClass("red-ui-palette-open")?E[t].close():E[t].open()}},$("#red-ui-palette-header-"+t).on("click",function(e){E[t].toggle()})}function R(t,e,o,c){e.attr("data-palette-label",o);for(var u=(o=RED.utils.sanitize(o)).split(/([ -]|\\n )/),i=[],n="",a=0;a<u.length;a++){var r=u[a];if("\\n "!==r){var p=0==a?"":" ";if(RED.view.calculateTextWidth(n+p+r,"red-ui-palette-label")<82)n+=p+r;else for(0<a&&i.push(n);;){if(!(82<=RED.view.calculateTextWidth(r,"red-ui-palette-label"))){n=r;break}for(var s=r.length;0<s;s--){var f=r.substring(0,s);if(RED.view.calculateTextWidth(f,"red-ui-palette-label")<82){i.push(f),r=r.substring(s);break}}}}else i.push(n),n=""}i.push(n);var h=i.join("<br/>"),g=8+20*i.length;e.css({height:g+"px"}),e.find(".red-ui-palette-label").html(h).attr("dir",RED.text.bidi.resolveBaseTextDir(h)),e.find(".red-ui-palette-port").css({top:g/2-5+"px"});try{var d,l,m,b="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(o)+"</b></p>",v=((d=$("<div></div>").append($(b+(c||RED.nodes.getNodeHelp(t)||"<p>"+RED._("palette.noInfo")+"</p>").trim()).filter(function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&0<this.textContent.trim().length}).slice(0,2))).find("a").each(function(){var e=$(this).text();$(this).before(e),$(this).remove()}),RED.nodes.getType(t));v&&(l="",v&&!/^subflow:/.test(t)&&(l=v.set.module+" : "),l+=t,/^subflow:/.test(t)&&$('<button type="button" onclick="RED.workspaces.show(\''+t.substring(8).replace(/'/g,"\\'")+'\'); return false;" class="red-ui-button red-ui-button-small" style="float: right; margin-left: 5px;"><i class="fa fa-pencil"></i></button>').appendTo(d),m=t.replace(/'/g,"\\'"),$('<button type="button" onclick="RED.search.show(\'type:'+m+'\'); return false;" class="red-ui-button red-ui-button-small" style="float: right; margin-left: 5px;"><i class="fa fa-search"></i></button>').appendTo(d),$('<button type="button" onclick="RED.sidebar.help.show(\''+m+'\'); return false;" class="red-ui-button red-ui-button-small" style="float: right; margin-left: 5px;"><i class="fa fa-book"></i></button>').appendTo(d),$("<p>",{style:"font-size: 0.8em"}).text(l).appendTo(d))}catch(e){console.log("Error generating pop-over label for ",t),console.log(e.toString()),d="<p><b>"+o+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}e.data("popover").setContent(d)}function x(e){return $(".red-ui-palette-node[data-palette-type='"+e+"']")}function _(e){return e.replace(/[ /.]/g,"_")}function a(o,i){if(!x(o).length){var e=i.category;if(-1===k.indexOf(e)){var l=_(e),t=l.split("-")[0],n=$("<div>",{class:"red-ui-palette-node"}).attr("data-palette-type",o).data("category",t),c=o;if(void 0!==i.paletteLabel)try{c=("function"==typeof i.paletteLabel?i.paletteLabel.call(i):i.paletteLabel)||""}catch(e){console.log("Definition error: "+o+".paletteLabel",e)}$("<div/>",{class:"red-ui-palette-label"+(!i.align&&0!==i.inputs&&0===i.outputs||"right"===i.align?" red-ui-palette-label-right":"")}).appendTo(n),i.icon&&(s=RED.utils.getNodeIcon(i),(d=$("<div/>",{class:"red-ui-palette-icon-container"+(!i.align&&0!==i.inputs&&0===i.outputs||"right"===i.align?" red-ui-palette-icon-container-right":"")}).appendTo(n)).attr("data-palette-icon",s),RED.utils.createIconElement(s,d,!0)),n.css("backgroundColor",RED.utils.getNodeColor(o,i)),0<i.outputs&&((s=document.createElement("div")).className="red-ui-palette-port red-ui-palette-port-output",n.append(s)),0<i.inputs&&((d=document.createElement("div")).className="red-ui-palette-port red-ui-palette-port-input",n.append(d)),D(e,t,l,-1!==w.indexOf(t)?"node-red":i.set.id),$("#red-ui-palette-"+l).append(n),n.on("mousedown",function(e){e.preventDefault()});var f,h,g,p,a,u,r,m,b,s=RED.popover.create({target:n,trigger:"hover",interactive:!0,width:"300px",content:"hi",delay:{show:750,hide:50}}),v=(n.data("popover",s),$("#red-ui-workspace-chart")),y=$("#red-ui-workspace-chart>svg").get(0),d=($(n).draggable({helper:"clone",appendTo:"#red-ui-editor",revert:"invalid",revertDuration:200,containment:"#red-ui-main-container",start:function(){m=$("#red-ui-palette").width(),b=$("#red-ui-palette").parent().position().top+$("#red-ui-palette-container").position().top,r=null,(u=RED.view.getActiveGroup())&&document.getElementById("group_select_"+u.id).classList.add("red-ui-flow-group-active-hovered"),RED.view.focus()},stop:function(){d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),r&&document.getElementById("group_select_"+r.id).classList.remove("red-ui-flow-group-hovered"),u&&document.getElementById("group_select_"+u.id).classList.remove("red-ui-flow-group-active-hovered"),p&&(clearTimeout(p),p=null),a&&(clearTimeout(a),a=null)},drag:function(e,u){var t=x(o);u.originalPosition.left=t.offset().left,h=u.position.left-m+u.helper.width()/2+v.scrollLeft(),g=u.position.top-b+u.helper.height()/2+v.scrollTop()+10,a=a||setTimeout(function(){var e=h/RED.view.scale(),t=g/RED.view.scale(),e=RED.view.getGroupAtPoint(e,t);e!==r&&(r&&document.getElementById("group_select_"+r.id).classList.remove("red-ui-flow-group-hovered"),e&&document.getElementById("group_select_"+e.id).classList.add("red-ui-flow-group-hovered"),(r=e)?$(u.helper).data("group",r):$(u.helper).removeData("group")),a=null},200),0<i.inputs&&0<i.outputs&&(p=p||setTimeout(function(){for(var e,t=[],o=1/0,i=null,t=y.getIntersectionList?((e=y.createSVGRect()).x=h,e.y=g,e.width=1,e.height=1,y.getIntersectionList(e,y)):RED.view.getLinksAtPoint(h,g),n=h/RED.view.scale(),a=g/RED.view.scale(),r=0;r<t.length;r++){var s=d3.select(t[r]);if(s.classed("red-ui-flow-link-background")&&!s.classed("red-ui-flow-link-link"))for(var c=t[r].getTotalLength(),d=0;d<c;d+=10){var l=t[r].getPointAtLength(d),l=(l.x-n)*(l.x-n)+(l.y-a)*(l.y-a);l<200&&l<o&&(o=l,i=t[r])}}f&&f!==i&&d3.select(f.parentNode).classed("red-ui-flow-link-splice",!1),i?d3.select(i.parentNode).classed("red-ui-flow-link-splice",!0):d3.select(".red-ui-flow-link-splice").classed("red-ui-flow-link-splice",!1),f!==i&&(i?$(u.helper).data("splice",d3.select(i).data()[0]):$(u.helper).removeData("splice")),f=i,p=null},200))}}),null);0===o.indexOf("subflow:")&&(n.on("dblclick",function(e){RED.workspaces.show(o.substring(8)),e.preventDefault()}),e=RED.nodes.subflow(o.substring(8)),d=RED.utils.renderMarkdown(e.info||"")),R(o,n,c,d),1===$("#red-ui-palette-container-"+t).find(".red-ui-palette-node").length&&E[t].open()}}}function r(e){var e=x(e),t=e.closest(".red-ui-palette-category");e.remove(),0===t.find(".red-ui-palette-node").length&&t.find("i").hasClass("expanded")&&(t.find(".red-ui-palette-content").slideToggle(),t.find("i").toggleClass("expanded"))}function s(e){for(var e=x(e),e=(e.hide(),e.closest(".red-ui-palette-category")),t=e.find(".red-ui-palette-node"),o=0,i=0;i<t.length;i++)"none"===$(t[i]).css("display")&&(o+=1);o===t.length&&e.hide()}function d(e){e=x(e);e.closest(".red-ui-palette-category").show(),e.show()}function l(e){var t=x("subflow:"+e.id),o=t.find(".red-ui-palette-port-input"),i=t.find(".red-ui-palette-port-output");t.find(".red-ui-palette-label").attr("class","red-ui-palette-label"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" red-ui-palette-label-right":""));t.find(".red-ui-palette-icon-container").attr("class","red-ui-palette-icon-container"+(!e._def.align&&0!==e.in.length&&0===e.out.length||"right"===e._def.align?" red-ui-palette-icon-container-right":"")),0===o.length&&0<e.in.length?((a=document.createElement("div")).className="red-ui-palette-port red-ui-palette-port-input",t.append(a)):0!==o.length&&0===e.in.length&&o.remove(),0===i.length&&0<e.out.length?((a=document.createElement("div")).className="red-ui-palette-port red-ui-palette-port-output",t.append(a)):0!==i.length&&0===e.out.length&&i.remove();var n,o=t.attr("data-palette-label"),a=t.attr("data-palette-info"),a=(o===e.name&&a===e.info||(t.attr("data-palette-info",e.info),R(e.type+":"+e.id,t,e.name,RED.utils.renderMarkdown(e.info||""))),i=t,o=e,o=RED.utils.getNodeIcon(o._def),(i=i.find(".red-ui-palette-icon-container")).attr("data-palette-icon")!==o&&(i.attr("data-palette-icon",o),RED.utils.createIconElement(o,i,!0)),t.data("category")),o=e.category||"subflows";a!==o&&(D(o,i=_(o),i,"node-red"),a=t.closest(".red-ui-palette-category"),(n=$("#red-ui-palette-"+i)).append(t),1===n.find(".red-ui-palette-node").length&&E[i].open(),t.data("category",o),0===a.find(".red-ui-palette-node").length&&a.find("i").hasClass("expanded")&&(a.find(".red-ui-palette-content").slideToggle(),a.find("i").toggleClass("expanded"))),t.css("backgroundColor",e.color)}return{init:function(){$('<img src="red/images/spin.svg" class="red-ui-palette-spinner hide"/>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-search" class="red-ui-palette-search hide"><input type="text" data-i18n="[placeholder]palette.filter"></input></div>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-container" class="red-ui-palette-scroll hide"></div>').appendTo("#red-ui-palette"),$('<div class="red-ui-component-footer"></div>').appendTo("#red-ui-palette"),$('<div id="red-ui-palette-shade" class="hide"></div>').appendTo("#red-ui-palette"),$("#red-ui-palette > .red-ui-palette-spinner").show(),RED.events.on("registry:node-type-added",function(e){var t=RED.nodes.getType(e);a(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)}),RED.events.on("registry:node-type-removed",function(e){r(e)}),RED.events.on("registry:node-set-enabled",function(e){for(var t=0;t<e.types.length;t++){d(e.types[t]);var o=RED.nodes.getType(e.types[t]);o&&o.onpaletteadd&&"function"==typeof o.onpaletteadd&&o.onpaletteadd.call(o)}}),RED.events.on("registry:node-set-disabled",function(e){for(var t=0;t<e.types.length;t++){s(e.types[t]);var o=RED.nodes.getType(e.types[t]);o&&o.onpaletteremove&&"function"==typeof o.onpaletteremove&&o.onpaletteremove.call(o)}}),RED.events.on("registry:node-set-removed",function(e){if(e.added)for(var t=0;t<e.types.length;t++){r(e.types[t]);var o=RED.nodes.getType(e.types[t]);o&&o.onpaletteremove&&"function"==typeof o.onpaletteremove&&o.onpaletteremove.call(o)}}),RED.events.on("subflows:change",l),$("#red-ui-palette-search input").searchBox({delay:100,change:function(){var e,i=$(this).val(),n=new RegExp(i.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");for(e in $("#red-ui-palette-container .red-ui-palette-node").each(function(e,t){var o=$(t).attr("data-palette-label"),t=$(t).attr("data-palette-type");""===i||n.test(t)||n.test(o)?$(this).show():$(this).hide()}),E)E.hasOwnProperty(e)&&(0===E[e].container.find(".red-ui-palette-node").filter(function(){return"none"!==$(this).css("display")}).length?(E[e].close(),E[e].container.slideUp()):(E[e].open(),E[e].container.show()))}}),i=$('<div class="red-ui-sidebar-control-left"><i class="fa fa-chevron-left"></i></div>').appendTo($("#red-ui-palette")),RED.popover.tooltip(i,RED._("keyboard.togglePalette"),"core:toggle-palette"),i.on("click",function(){RED.menu.toggleSelected("menu-item-palette")}),$("#red-ui-palette").on("mouseenter",function(){i.toggle("slide",{direction:"left"},200)}),$("#red-ui-palette").on("mouseleave",function(){i.stop(!1,!0),i.hide()});var e=[],t=(RED.settings.paletteCategories?e=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(e=RED.settings.theme("palette.categories")),Array.isArray(e)||(e=[]),{}),e=(e.forEach(function(e){t[e]=!0,n(e,_(e),"palette.label."+_(e))}),w.forEach(function(e){t[e]||n(e,_(e),"palette.label."+_(e))}),$('<span class="button-group"></span>').appendTo("#red-ui-palette .red-ui-component-footer")),o=$('<button type="button" class="red-ui-footer-button"><i class="fa fa-angle-double-up"></i></button>').appendTo(e);o.on("click",function(e){for(var t in e.preventDefault(),E)E.hasOwnProperty(t)&&E[t].close()}),RED.popover.tooltip(o,RED._("palette.actions.collapse-all")),(o=$('<button type="button" class="red-ui-footer-button"><i class="fa fa-angle-double-down"></i></button>').appendTo(e)).on("click",function(e){for(var t in e.preventDefault(),E)E.hasOwnProperty(t)&&E[t].open()}),RED.popover.tooltip(o,RED._("palette.actions.expand-all")),RED.actions.add("core:toggle-palette",function(e){void 0===e?RED.menu.toggleSelected("menu-item-palette"):(e?($("#red-ui-main-container").removeClass("red-ui-palette-closed"),i.find("i").removeClass("fa-chevron-right").addClass("fa-chevron-left")):($("#red-ui-main-container").addClass("red-ui-palette-closed"),i.hide(),i.find("i").addClass("fa-chevron-right").removeClass("fa-chevron-left")),setTimeout(function(){$(window).trigger("resize")},200))})},add:a,remove:r,hide:s,show:d,refresh:function(){RED.nodes.eachSubflow(l)},getCategories:function(){var o=[];return $("#red-ui-palette-container .red-ui-palette-category").each(function(e,t){o.push({id:$(t).data("category"),label:$(t).data("label")})}),o}}}(),RED.sidebar.info=function(){var i,s,_,n,w,k,E,D,R,d,l,x={property:!1};function c(){var e;s&&(e=$(i).parent().height()-d.outerHeight(),s.resize(e))}function u(){RED.sidebar.show("info")}function o(e){if(void 0!==e){$(_).empty();var t=$('<table class="red-ui-info-table"></table>').appendTo(_),o=$("<tbody>").appendTo(t);if(null===e)RED.sidebar.info.outliner.select(null),w.empty(),k.text(""),E.hide(),D.hide();else if(Array.isArray(e)){RED.sidebar.info.outliner.select(e),w.empty(),RED.utils.createNodeIcon({type:"_selection_"}).appendTo(w),k.text("Selection"),E.hide(),D.hide(),R=null;var i={nodes:0,flows:0,subflows:0,groups:0},n=(e.forEach(function(e){"tab"===e.type?(i.flows++,i.nodes+=RED.nodes.filterNodes({z:e.id}).length):"subflow"===e.type?i.subflows++:"group"===e.type?i.groups++:i.nodes++}),s=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.selection")+"</td><td></td></tr>").appendTo(o),$("<div>").appendTo($(s.children()[1])));0<i.flows&&$("<div>").text(RED._("clipboard.flow",{count:i.flows})).appendTo(n),0<i.subflows&&$("<div>").text(RED._("clipboard.subflow",{count:i.subflows})).appendTo(n),0<i.nodes&&$("<div>").text(RED._("clipboard.node",{count:i.nodes})).appendTo(n),0<i.groups&&$("<div>").text(RED._("clipboard.group",{count:i.groups})).appendTo(n)}else{RED.sidebar.info.outliner.select(e);var t=/^subflow(:(.+))?$/.exec(e.type),a=(t&&((l=t[2]?RED.nodes.subflow(t[2]):e).id,y=l.instances.length),w.empty(),RED.utils.createNodeIcon(e).appendTo(w),RED.utils.getNodeLabel(e,e.type+": "+e.id)),r=a.indexOf("\\n"),r=(-1<r&&(a=a.substring(0,r)+"..."),k.text(a),E.show(),R=e,s=$('<tr class="red-ui-help-info-row"><td></td><td></td></tr>').appendTo(o),"node");if("subflow"===e.type||t?r="subflow":"tab"===e.type?r="flow":"group"===e.type&&(r="group"),$(s.children()[0]).text(RED._("sidebar.info."+r)),RED.utils.createObjectElement(e.id).appendTo(s.children()[1]),"tab"===e.type||"subflow"===e.type)D.hide();else if("group"===e.type){D.hide();var s=$('<tr class="red-ui-help-info-row"><td>&nbsp;</td><td></td></tr>').appendTo(o),c={nodes:0,groups:0},n=(RED.group.getNodes(e,!0).forEach(function(e){"group"===e.type?c.groups++:c.nodes++}),$("<div>").appendTo($(s.children()[1])));0<c.nodes&&$("<div>").text(RED._("clipboard.node",{count:c.nodes})).appendTo(n),0<c.groups&&$("<div>").text(RED._("clipboard.group",{count:c.groups})).appendTo(n)}else{D.show(),t||(s=$('<tr class="red-ui-help-info-row"><td>'+RED._("sidebar.info.type")+"</td><td></td></tr>").appendTo(o),$(s.children()[1]).text(("unknown"===e.type?e._orig:e).type),"unknown"===e.type&&$('<span style="float: right; font-size: 0.8em"><i class="fa fa-warning"></i></span>').prependTo($(s.children()[1])));var u=0;if(!t&&"subflow"!=e.type&&"group"!=e.type){var p,f,h,g,m,b,v,a=$('<tr class="red-ui-help-property-expand blank"><td colspan="2"></td></tr>').appendTo(o);if("unknown"===e.type?(p={},Object.keys(e._orig).forEach(function(e){"type"!==e&&(p[e]={})})):e._def&&(p=e._def.defaults,s=$('<tr class="red-ui-help-info-property-row'+(x.property?"":" hide")+'"><td>'+RED._("sidebar.info.module")+"</td><td></td></tr>").appendTo(o),$(s.children()[1]).text(RED.nodes.getType(e.type).set.module),u++),p)for(var d in p)"name"!=d&&"info"!=d&&p.hasOwnProperty(d)&&(f=e[d],u++,s=$('<tr class="red-ui-help-info-property-row'+(x.property?"":" hide")+'"><td></td><td></td></tr>').appendTo(o),$(s.children()[0]).text(d),p[d].type&&!p[d]._type.array?(h=RED.nodes.node(f))?(d=RED.utils.getNodeLabel(h,f),g=s.children()[1],m=$("<span>",{class:""}).appendTo(g),m=$("<div>",{class:"red-ui-palette-node red-ui-palette-node-small"}).appendTo(m),v=RED.utils.getNodeColor(h.type,h._def),b=RED.utils.getNodeIcon(h._def),m.css({backgroundColor:v,cursor:"pointer"}),v=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(m),$("<div/>",{class:"red-ui-palette-icon",style:"background-image: url("+b+")"}).appendTo(v),$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).text(d).appendTo(g),m.on("dblclick",function(){RED.editor.editConfig("",h.type,h.id)})):RED.utils.createObjectElement(void 0).appendTo(s.children()[1]):RED.utils.createObjectElement(f).appendTo(s.children()[1]));0<u&&$('<a href="#" class="node-info-property-header'+(x.property?" expanded":"")+'"><span class="red-ui-help-property-more">'+RED._("sidebar.info.showMore")+'</span><span class="red-ui-help-property-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a>').appendTo(a.children()[0])}"tab"!==e.type&&t&&($('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(o),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(l.name)+'">'+RED.utils.sanitize(l.name)+"</span></td></tr>").appendTo(o))}t&&(s=$('<tr class="red-ui-help-info-row"><td>'+RED._("subflow.category")+"</td><td></td></tr>").appendTo(o),r=l.category||"subflows",$(s.children()[1]).text(RED._("palette.label."+r,{defaultValue:r})),$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+y+"</td></tr>").appendTo(o),l.meta&&(s=$('<tr class="red-ui-help-info-row"><td>'+RED._("subflow.module")+"</td><td></td></tr>").appendTo(o),$(s.children()[1]).text(l.meta.module||""),s=$('<tr class="red-ui-help-info-row"><td>'+RED._("subflow.version")+"</td><td></td></tr>").appendTo(o),$(s.children()[1]).text(l.meta.version||"")));var n="",r=(e._def&&e._def.info&&(t="function"==typeof(a=e._def.info)?a.call(e):a,n+=RED.utils.renderMarkdown(t)),e.info&&(n+=RED.utils.renderMarkdown(e.info||"")),$("<div>").css("padding","0 6px 6px").appendTo(_)),y=n,l=r;(y=function(e){return $(e).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),e}($('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(y)+'">'+y+"</span></div>")).appendTo(l)).find(".red-ui-text-bidi-aware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>"),y.find("H3").wrapInner('<a class="red-ui-help-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').on("click",function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),o=$(this).parent().next();1===o.length&&"H3"!==o[0].nodeName;)o.toggle(!t),o=o.next();$(this).toggleClass("expanded",!t)}),$(".red-ui-sidebar-info-stack").scrollTop(0),$(".node-info-property-header").on("click",function(e){e.preventDefault(),x.property=!x.property,$(this).toggleClass("expanded",x.property),$(".red-ui-help-info-property-row").toggle(x.property)})}}else T()}t=!0,f=15e3,r=-1,RED.actions.add("core:toggle-show-tips",function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):((t=e)?m:b)()});var a,p,t,f,r,h={start:m,stop:b,next:function(){clearInterval(p),a=!0,e()},enabled:function(){return t}};function e(){for(var e,t=Math.floor(Math.random()*r),o=RED._("infotips:info.tip"+t);e=/({{(.*?)}})/.exec(o);){var i=RED.keyboard.getShortcut(e[2]);if(!i)return;o=o.replace(e[1],RED.keyboard.formatKey(i.key))}for(;e=/(\[([a-z]*?)\])/.exec(o);)o=o.replace(e[1],RED.keyboard.formatKey(e[2]));l.html(o).fadeIn(200),a&&(a=null,p=setInterval(g,f))}function g(){l.fadeOut(300,function(){e()})}function m(){if($(".red-ui-sidebar-info").addClass("show-tips"),c(),t&&!a&&!p){if(-1===r)for(;r++,RED._("infotips:info.tip"+r)!=="info.tip"+r;);a=setTimeout(e,1e3)}}function b(){$(".red-ui-sidebar-info").removeClass("show-tips"),c(),clearInterval(p),clearTimeout(a),a=p=null}function T(e){var t;(e=void 0===e?RED.view.selection():e).nodes?1==e.nodes.length?"subflow"===(t=e.nodes[0]).type&&t.direction?o(RED.nodes.subflow(t.z)):o(t):o(e.nodes):e.flows||e.subflows?o(e.flows):(t=RED.workspaces.active(),(e=RED.nodes.workspace(t)||RED.nodes.subflow(t))?o(e):(t=RED.nodes.workspace(RED.workspaces.active()))&&t.info?o(t):o(null))}return RED.events.on("view:selection-changed",T),{init:function(){(i=document.createElement("div")).className="red-ui-sidebar-info",RED.actions.add("core:show-info-tab",u);var e=$("<div>",{class:"red-ui-sidebar-info-stack"}).appendTo(i),t=$("<div>").css({overflow:"hidden",height:"calc(70%)"}).appendTo(e),o=$("<div>").css({overflow:"hidden",height:"100%",display:"flex","flex-direction":"column"}).appendTo(e),o=(n=$("<div>",{class:"red-ui-palette-header red-ui-info-header"}).css({flex:"0 0 auto"}).appendTo(o),w=$("<span>").appendTo(n),k=$("<span>").appendTo(n),D=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-book"></button>').css({position:"absolute",top:"12px",right:"32px"}).on("click",function(e){e.preventDefault(),e.stopPropagation(),R&&RED.sidebar.help.show(R.type)}).appendTo(n),RED.popover.tooltip(D,RED._("sidebar.help.showHelp")),E=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-search"></button>').css({position:"absolute",top:"12px",right:"8px"}).on("click",function(e){e.preventDefault(),e.stopPropagation(),R&&(RED.sidebar.info.outliner.reveal(R),RED.view.reveal(R.id))}).appendTo(n),RED.popover.tooltip(E,RED._("sidebar.help.showInOutline")),_=$("<div>").css({flex:"1 1 auto","overflow-y":"scroll"}).appendTo(o),(s=RED.panels.create({container:e})).ratio(.6),RED.sidebar.info.outliner.build().appendTo(t),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),iconClass:"fa fa-info",action:"core:show-info-tab",content:i,pinned:!0,enableOnEdit:!0}),RED.events.on("sidebar:resize",c),$(window).on("resize",c),$(window).on("focus",c),d=$('<div class="red-ui-help-tips"></div>').appendTo(i),l=$('<div class="red-ui-help-tip"></div>').appendTo(d),$('<div class="red-ui-help-tips-buttons"></div>').appendTo(d));$('<a href="#" class="red-ui-footer-button"><i class="fa fa-refresh"></a>').appendTo(o).on("click",function(e){e.preventDefault(),h.next()}),$('<a href="#" class="red-ui-footer-button"><i class="fa fa-times"></a>').appendTo(o).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))}),h.enabled()?h.start():h.stop()},show:u,refresh:o,clear:function(){o(null)},set:function(e,t){console.warn("Deprecated use of RED.sidebar.info.set - use RED.sidebar.help.set instead"),RED.sidebar.help.set(e,t)}}}(),RED.sidebar.info.outliner=function(){var a,o,p,f,h,g,t,n,r={},s={};function m(){var e=[{label:RED._("menu.label.flows"),expanded:!0,children:[]},{id:"__subflow__",label:RED._("menu.label.subflows"),children:[l("__subflow__")]},{id:"__global__",flow:"__global__",label:RED._("sidebar.info.globalConfig"),types:{},children:[l("__global__")]}];return g=e[0],t=e[1],n={__global__:e[2]},e}var e,d={};function l(e){var t={empty:!0,element:$('<div class="red-ui-info-outline-item red-ui-info-outline-item-empty">').text(RED._("sidebar.info.empty"))};return d[e]=t}function i(e){var t=$("<div>",{class:"red-ui-node-list-item red-ui-info-outline-item"});return RED.utils.createNodeIcon(e,!0).appendTo(t),t.find(".red-ui-node-label").addClass("red-ui-info-outline-item-label"),b(e,t),t}function b(t,o){var e,i=$("<div>",{class:"red-ui-info-outline-item-controls red-ui-info-outline-item-hover-controls"}).appendTo(o);"subflow"===t.type&&$('<button type="button" class="red-ui-info-outline-item-control-users red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').text(t.instances.length).appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation(),RED.search.show("type:subflow:"+t.id)}),"config"===t._def.category&&"group"!==t.type&&(e=$('<button type="button" class="red-ui-info-outline-item-control-users red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').text(t.users.length).appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation(),RED.search.show("uses:"+t.id)}),RED.popover.tooltip(e,function(){return RED._("editor.nodesUse",{count:t.users.length})})),t._def.button&&(e=$('<button type="button" class="red-ui-info-outline-item-control-action red-ui-button red-ui-button-small"><i class="fa fa-toggle-right"></i></button>').appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation(),RED.view.clickNodeButton(t)}),RED.popover.tooltip(e,RED._("sidebar.info.triggerAction"))),"tab"===t.type&&$('<button type="button" class="red-ui-info-outline-item-control-hide red-ui-button red-ui-button-small"><i class="fa fa-eye"></i><i class="fa fa-eye-slash"></i></button>').appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation();e=!o.hasClass("red-ui-info-outline-item-hidden");o.toggleClass("red-ui-info-outline-item-hidden",e),e?RED.workspaces.hide(t.id):RED.workspaces.show(t.id,null,!0)}),"subflow"!==t.type?(e=$('<button type="button" class="red-ui-info-outline-item-control-disable red-ui-button red-ui-button-small"><i class="fa fa-circle-thin"></i><i class="fa fa-ban"></i></button>').appendTo(i).on("click",function(e){var o,i;e.preventDefault(),e.stopPropagation(),"tab"===t.type?t.disabled?RED.workspaces.enable(t.id):RED.workspaces.disable(t.id):"group"===t.type?(e=RED.group.getNodes(t,!0),o={t:"multi",events:[],dirty:RED.nodes.dirty()},e.forEach(function(e){var t;"group"!==e.type&&(void 0===i&&(i=!e.d),!!e.d!==i&&(t={t:"edit",node:e,changed:e.changed,changes:{d:e.d}},e.d?delete e.d:e.d=!0,e.dirty=!0,e.dirtyStatus=!0,e.changed=!0,RED.events.emit("nodes:change",e),o.events.push(t))),0<o.events.length&&(RED.history.push(o),RED.nodes.dirty(!0),RED.view.redraw())})):(e={t:"edit",node:t,changed:t.changed,changes:{d:t.d},dirty:RED.nodes.dirty()},t.d?delete t.d:t.d=!0,t.dirty=!0,t.dirtyStatus=!0,t.changed=!0,RED.events.emit("nodes:change",t),RED.history.push(e),RED.nodes.dirty(!0),RED.view.redraw())}),RED.popover.tooltip(e,function(){return"group"===t.type?RED._("common.label.enable")+" / "+RED._("common.label.disable"):RED._("common.label."+("tab"===t.type&&t.disabled||"tab"!==t.type&&t.d?"enable":"disable"))})):$('<div class="red-ui-info-outline-item-control-spacer">').appendTo(i),i.find("button").on("dblclick",function(e){e.preventDefault(),e.stopPropagation()})}function v(e){r={};var t,o=m();h.empty(),e=e,(t=$("<div>",{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"})).css("width","calc(100% - 40px)"),$("<div>",{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(t).text(e.name),e=$("<div>",{class:"red-ui-info-outline-item-controls"}).appendTo(t),e=$('<button class="red-ui-button red-ui-button-small" style="position:absolute;right:5px;top: 3px;"><i class="fa fa-ellipsis-h"></i></button>').appendTo(e).on("click",function(e){e.preventDefault(),RED.projects.editProject()}),RED.popover.tooltip(e,RED._("sidebar.project.showProjectSettings")),t.appendTo(h),f.show(),a.treeList("data",o)}function y(){a.treeList("data",m())}function w(e){e=r[e.workspace];e&&e.element.removeClass("red-ui-info-outline-item-hidden")}function E(e){e=r[e.workspace];e&&e.element.addClass("red-ui-info-outline-item-hidden")}function D(e){var t,o,i,n,a;r[e.id]={id:e.id,element:(t=e,o=$("<div>",{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"}),i=$("<div>",{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(o),n="string"==typeof t?t:t.label,-1<(a=n.indexOf("\\n"))&&(n=n.substring(0,a)+"..."),i.text(n),b(t,o),o),children:[],deferBuild:!0,icon:"red-ui-icons red-ui-icons-flow",gutter:C(e)},s[e.id]?(r[e.id].children=s[e.id],delete s[e.id]):r[e.id].children.push(l(e.id)),g.treeList.addChild(r[e.id]),r[e.id].element.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),r[e.id].treeList.container.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),u()}function R(e){var t=r[e.id],o=e.label||e.id,i=o.indexOf("\\n");-1<i&&(o=o.substring(0,i)+"..."),t.element.find(".red-ui-info-outline-item-label").text(o),t.element.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),t.treeList.container.toggleClass("red-ui-info-outline-item-disabled",!!e.disabled),u()}function x(e){var o={};e.forEach(function(e,t){o[e]=t}),g.treeList.sortChildren(function(e,t){return"__global__"===e.id?-1:"__global__"===t.id?1:o[e.id]-o[t.id]})}function _(e){r[e.id]={id:e.id,element:i(e),children:[],deferBuild:!0,gutter:C(e)},s[e.id]?(r[e.id].children=s[e.id],delete s[e.id]):r[e.id].children.push(l(e.id)),d.__subflow__&&(d.__subflow__.treeList.remove(),delete d.__subflow__),t.treeList.addChild(r[e.id]),u()}function k(t){r[t.id].treeList.replaceElement(i(t)),RED.nodes.eachNode(function(e){e.type=="subflow:"+t.id&&r[e.id].treeList.replaceElement(i(e))}),u()}function T(e){var t=r[e.id],o=e.g||e.z||"__global__",i=RED.utils.getNodeLabel(e,e.name||e.type+": "+e.id);i?t.element.find(".red-ui-info-outline-item-label").text(i):t.element.find(".red-ui-info-outline-item-label").html("&nbsp;"),o!==(t.parent.id||t.parent.parent.flow)&&(i=t.parent,t.treeList.remove(!0),0===i.children.length&&(i.config?(i.treeList.remove(),delete n[i.parent.id||i.parent.parent.id].types[e.type],0===i.parent.children.length&&("__global__"===i.parent.id?i.parent.treeList.addChild(l(i.parent.id)):(delete n[i.parent.parent.id],i.parent.treeList.remove(),0===i.parent.parent.children.length&&i.parent.parent.treeList.addChild(l(i.parent.parent.id))))):i.treeList.addChild(l(i.id))),"config"===e._def.category&&"group"!==e.type?(j(o,e.type),n[o].types[e.type].treeList.addChild(r[e.id])):(d[o]&&(d[o].treeList.remove(),delete d[o]),r[o].treeList.addChild(t))),t.element.toggleClass("red-ui-info-outline-item-disabled",!!e.d),"config"===e._def.category&&"group"!==e.type&&t.element.find(".red-ui-info-outline-item-control-users").text(e.users.length),u()}function c(e){var t=r[e.id],o=(t.treeList.remove(),delete r[e.id],/^subflow:/.test(e.type)&&(o=e.type.substring(8),r[o]&&r[o].element.find(".red-ui-info-outline-item-control-users").text(RED.nodes.subflow(o).instances.length)),d[e.id]&&delete d[e.id],t.parent);0===o.children.length&&(o.config?(o.treeList.remove(),delete n[o.parent.id||e.z].types[e.type],0===o.parent.children.length&&("__global__"===o.parent.id?o.parent.treeList.addChild(l(o.parent.id)):(delete n[e.z],o.parent.treeList.remove(),0===o.parent.parent.children.length&&o.parent.parent.treeList.addChild(l(o.parent.parent.id))))):o.treeList.addChild(l(o.id)))}function C(t){var e=$("<span>",{class:"red-ui-info-outline-gutter red-ui-treeList-gutter-float"}),o=$('<button type="button" class="red-ui-info-outline-item-control-reveal red-ui-button red-ui-button-small"><i class="fa fa-search"></i></button>').appendTo(e).on("click",function(e){e.preventDefault(),e.stopPropagation(),RED.view.reveal(t.id)});return RED.popover.tooltip(o,RED._("sidebar.info.find")),e}function j(e,t){d[e]&&(d[e].treeList.remove(),delete d[e]),n[e]||(n[e]={config:!0,flow:e,types:{},label:RED._("menu.label.displayConfig"),children:[]},r[e].treeList.insertChildAt(n[e],0)),n[e].types[t]||(n[e].types[t]={config:!0,label:t,children:[]},n[e].treeList.addChild(n[e].types[t]))}function L(e){r[e.id]={id:e.id,element:i(e),gutter:C(e)},"group"===e.type&&(r[e.id].children=[],r[e.id].deferBuild=!0,s[e.id]&&(r[e.id].children=s[e.id],delete s[e.id]));var t=e.g||e.z||"__global__";"config"!==e._def.category||"group"===e.type?r[t]?(d[t]&&(d[t].treeList.remove(),delete d[t]),r[t].treeList?r[t].treeList.addChild(r[e.id]):r[t].children.push(r[e.id])):(s[t]=s[t]||[],s[t].push(r[e.id])):(j(t,e.type),n[t].types[e.type].treeList.addChild(r[e.id])),r[e.id].element.toggleClass("red-ui-info-outline-item-disabled",!!e.d),/^subflow:/.test(e.type)&&(t=e.type.substring(8),r[t]&&r[t].element.find(".red-ui-info-outline-item-control-users").text(RED.nodes.subflow(t).instances.length)),u()}function u(){e&&clearTimeout(e),p&&(e=setTimeout(function(){o.searchBox("change")},100))}return{build:function(){var e=$("<div>",{class:"red-ui-info-outline"}).css({height:"100%"}),t=$("<div>",{class:"red-ui-sidebar-header red-ui-info-toolbar"}).appendTo(e);return o=$('<input type="text" data-i18n="[placeholder]menu.label.search">').appendTo(t).searchBox({style:"compact",delay:500,change:function(){var e=$(this).val(),t=RED.search.search(e);if(e){p=e;for(var o={},i=0,n=t.length;i<n;i++)o[t[i].node.id]=!0;a.treeList("filter",function(e){return 0===e.depth||e.id&&r[e.id]&&o[e.id]},!0)}else{p=null,a.treeList("filter",null);e=a.treeList("selected");e.id&&a.treeList("show",e.id)}},options:[{label:RED._("sidebar.info.search.configNodes"),value:"is:config"},{label:RED._("sidebar.info.search.unusedConfigNodes"),value:"is:config is:unused"},{label:RED._("sidebar.info.search.invalidNodes"),value:"is:invalid"},{label:RED._("sidebar.info.search.uknownNodes"),value:"type:unknown"},{label:RED._("sidebar.info.search.unusedSubflows"),value:"is:subflow is:unused"},{label:RED._("sidebar.info.search.hiddenFlows"),value:"is:hidden"}]}),f=$('<div class="red-ui-treeList-label red-ui-info-outline-project"><span class="red-ui-treeList-icon"><i class="fa fa-archive"></i></span></div>').hide().appendTo(e),h=$("<span>").appendTo(f),(a=$("<div>").css({width:"100%"}).appendTo(e).treeList({data:m()})).on("treelistselect",function(e,t){t=RED.nodes.node(t.id)||RED.nodes.group(t.id);t&&("group"===t.type||"config"!==t._def.category||"config"===t._def.category&&RED.sidebar.info.refresh(t))}),a.on("treelistconfirm",function(e,t){t=RED.nodes.node(t.id);t&&("config"===t._def.category?RED.editor.editConfig("",t.type,t.id):RED.editor.edit(t))}),RED.events.on("projects:load",v),RED.events.on("flows:add",D),RED.events.on("flows:remove",c),RED.events.on("flows:change",R),RED.events.on("flows:reorder",x),RED.events.on("subflows:add",_),RED.events.on("subflows:remove",c),RED.events.on("subflows:change",k),RED.events.on("nodes:add",L),RED.events.on("nodes:remove",c),RED.events.on("nodes:change",T),RED.events.on("groups:add",L),RED.events.on("groups:remove",c),RED.events.on("groups:change",T),RED.events.on("workspace:show",w),RED.events.on("workspace:hide",E),RED.events.on("workspace:clear",y),e},search:function(e){o.searchBox("value",e)},select:function(e){e?Array.isArray(e)?a.treeList("select",e.map(function(e){return r[e.id]}),!1):a.treeList("select",r[e.id],!1):a.treeList("clearSelection")},reveal:function(e){a.treeList("show",r[e.id])}}}(),RED.sidebar.help=function(){var i,n,a,r,t,s,d,l;function c(){var e=$(i).parent().height()-n.outerHeight();r.resize(e)}function f(){l=l||setTimeout(function(){l=null,0;var a=RED.nodes.registry.getModuleList(),e=Object.keys(a),r=(e.sort(),{label:RED._("sidebar.help.nodeHelp"),children:[],expanded:!0}),t=[{id:"changelog",label:"Node-RED v"+RED.settings.version,content:w},r],o=RED.nodes.registry.getNodeTypes().filter(function(e){return/subflow/.test(e)});0<o.length&&(r.children.push({label:RED._("menu.label.subflows"),children:[]}),o.forEach(function(e){var t=RED.nodes.getType(e);r.children[0].children.push({id:"node-type:"+e,nodeType:e,subflowLabel:t.label().toLowerCase(),element:v({_def:t,type:t.label()})})})),e.forEach(function(e){var t=a[e];const o=[],i=t.sets,n=Object.keys(i);n.forEach(function(e){const t=i[e];t.types.forEach(function(e){if($("script[data-help-name='"+e+"']").length){const t={_def:RED.nodes.getType(e),type:e};t.name=b(t),o.push({id:"node-type:"+e,nodeType:e,palleteLabel:t.name,element:v(t)})}})}),0<o.length&&(o.sort(function(e,t){return e.nodeType.localeCompare(t.nodeType)}),r.children.push({id:e,icon:"fa fa-cube",label:e,children:o}))}),s.treeList("data",t)},500)}function h(e){var t=s.treeList("get","node-type:subflow:"+e.id);t.subflowLabel=e._def.label().toLowerCase(),t.treeList.replaceElement(v({_def:e._def,type:e._def.label()}))}function g(){var e=$("#red-ui-sidebar-help-show-toc");e.hasClass("selected")&&(e.removeClass("selected"),t=r.ratio(),d.css({transition:"height 0.2s"}),r.ratio(0),setTimeout(function(){d.css({transition:""})},250))}function m(){var e=$("#red-ui-sidebar-help-show-toc");e.hasClass("selected")||(e.addClass("selected"),d.css({transition:"height 0.2s"}),r.ratio(Math.max(.3,Math.min(t,.7))),setTimeout(function(){d.css({transition:""});var e=s.treeList("selected");e.id&&s.treeList("show",e)},250))}function b(e){let t=e.name;if(!t&&e._def&&e._def.paletteLabel)try{t=("function"==typeof e._def.paletteLabel?e._def.paletteLabel.call(e._def):e._def.paletteLabel)||""}catch(e){}return t||e.type}function v(e){var t=$("<div>",{class:"red-ui-node-list-item"}),o=RED.utils.createNodeIcon(e).appendTo(t);return $("<div>",{class:"red-ui-node-label"}).text(b(e)).appendTo(o),t}function y(t){a.empty();var e=/^subflow(:(.+))?$/.exec(t);if(e&&e[2])var e=RED.nodes.subflow(e[2]),o=RED.utils.renderMarkdown(e.info||"")||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>",i=e.name||t;else{o=RED.nodes.getNodeHelp(t)||'<span class="red-ui-help-info-none">'+RED._("sidebar.info.none")+"</span>";e=RED.nodes.registry.getNodeType(t);if("function"==typeof(i=e&&e.paletteLabel?e.paletteLabel:t))try{i=e.paletteLabel.call(e)}catch(e){i=t}}p(i,o),.7<r.ratio()&&r.ratio(.7),s.treeList("show","node-type:"+t),s.treeList("select","node-type:"+t,!1)}function u(e,t){!1!==t&&RED.sidebar.show("help"),e&&y(e),c()}function p(e,t){a.empty(),e&&$("<h1>",{class:"red-ui-help-title"}).text(e).appendTo(a);e=$('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(t)+'">'+t+"</span></div>"),$(e).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")});t=e.appendTo(a);t.find(".red-ui-text-bidi-aware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");t.find("H3").wrapInner('<a class="red-ui-help-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').on("click",function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),o=$(this).parent().next();1===o.length&&"H3"!==o[0].nodeName;)o.toggle(!t),o=o.next();$(this).toggleClass("expanded",!t)}),a.parent().scrollTop(0)}function w(a){$.get("red/about",function(n){n=RED.utils.sanitize(n),RED.tourGuide.load("./tours/welcome.js",function(e,t){var o,i='<div><img width="50px" src="red/images/node-red-icon.svg" /></div>';t&&(o=RED.settings.version.split("."),(t=t.version.split("."))[0]===o[0]&&t[1]===o[1]&&(i='<div><button type="button" onclick="RED.actions.invoke(\'core:show-welcome-tour\')" class="red-ui-button">'+RED._("tourGuide.takeATour")+"</button></div>")),a('<div style="text-align:center;">'+i+"</div>"+RED.utils.renderMarkdown(n))})})}return RED.events.on("view:selection-changed",function(e){(e=void 0===e?RED.view.selection():e).nodes&&1==e.nodes.length&&("subflow"===(e=e.nodes[0]).type&&e.direction||"group"!==e.type&&y(e.type))}),RED.actions.add("core:show-about",function(){s.treeList("show","changelog"),s.treeList("select","changelog"),u()}),RED.actions.add("core:show-welcome-tour",function(o,i){i=i||function(){},RED.tourGuide.load("./tours/welcome.js",function(e,t){if(e)return console.warn("Failed to load welcome tour",e),void i();e=RED.settings.version.split("."),t=t.version.split(".");if(t[0]===e[0]&&t[1]===e[1]){if(o){if(o===RED.settings.version)return void i();t=o.split(".");if(e[0]<t[0]||e[0]===t[0]&&e[1]<t[1])return void i();if(e[0]===t[0]&&e[1]===t[1]){if(3===t.length&&3===e.length)return void i();if(4===e.length&&(3===t.length||e[3]<t[3]))return void i()}}RED.tourGuide.run("./tours/welcome.js",function(e){RED.settings.set("editor.tours.welcome",RED.settings.version),i()})}else i()})}),{init:function(){(i=document.createElement("div")).className="red-ui-sidebar-info",n=$("<div>",{class:"red-ui-sidebar-header red-ui-info-toolbar"}).appendTo(i),$('<span class="button-group"><a id="red-ui-sidebar-help-show-toc" class="red-ui-button red-ui-button-small selected" href="#"><i class="fa fa-list-ul"></i></a></span>').appendTo(n);var o,e=n.find("#red-ui-sidebar-help-show-toc"),e=(RED.popover.tooltip(e,RED._("sidebar.help.showTopics")),e.on("click",function(e){e.preventDefault(),($(this).hasClass("selected")?g:m)()}),$("<div>",{class:"red-ui-sidebar-help-stack"}).appendTo(i)),t=(d=$("<div>",{class:"red-ui-sidebar-help-toc"}).appendTo(e),$("<div>").css({"overflow-y":"scroll"}).appendTo(e));(r=RED.panels.create({container:e})).ratio(.3),helpSearch=$('<input type="text" data-i18n="[placeholder]sidebar.help.search">').appendTo(n).searchBox({style:"compact",delay:100,change:function(){const t=$(this).val().toLowerCase();var e;t?(m(),s.treeList("filter",function(e){return 0===e.depth||(e.nodeType&&-1<e.nodeType.toLowerCase().indexOf(t)||e.subflowLabel&&-1<e.subflowLabel.toLowerCase().indexOf(t)||e.palleteLabel&&-1<e.palleteLabel.toLowerCase().indexOf(t))},!0)):(s.treeList("filter",null),(e=s.treeList("selected")).id&&s.treeList("show",e.id))}}),a=$("<div>",{class:"red-ui-help"}).css({padding:"6px"}).appendTo(t),$('<span class="red-ui-help-info-none">'+RED._("sidebar.help.noHelp")+"</span>").appendTo(a),(s=$("<div>").css({width:"100%"}).appendTo(d).treeList({data:[]})).on("treelistselect",function(e,t){(o=t).nodeType?y(t.nodeType):t.content&&(a.empty(),"string"==typeof t.content?p(t.label,t.content):"function"==typeof t.content&&(0===t.content.length?p(t.label,t.content()):(p(t.label,'<div class="red-ui-component-spinner red-ui-component-spinner-contain"><img src="red/images/spin.svg" /></div>'),t.content(function(e){o===t&&(a.empty(),p(t.label,e))}))))}),RED.sidebar.addTab({id:"help",label:RED._("sidebar.help.label"),name:RED._("sidebar.help.name"),iconClass:"fa fa-book",action:"core:show-help-tab",content:i,pinned:!0,enableOnEdit:!0,onchange:function(){c()}}),$(window).on("resize",c),$(window).on("focus",c),RED.events.on("registry:node-type-added",f),RED.events.on("registry:node-type-removed",f),RED.events.on("subflows:change",h),RED.actions.add("core:show-help-tab",u)},show:u,set:function(e,t){$(a).empty(),p(t,e),g(),u()}}}(),RED.sidebar.config=function(){var s=document.createElement("div"),e=(s.className="red-ui-sidebar-node-config",s.id="red-ui-sidebar-node-config",s.tabIndex=0,$('<div class="red-ui-sidebar-header"><span class="button-group"><a class="red-ui-sidebar-header-button-toggle selected" id="red-ui-sidebar-config-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="red-ui-sidebar-header-button-toggle" id="red-ui-sidebar-config-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </span></div>').appendTo(s),$('<div><a class="red-ui-footer-button" id="red-ui-sidebar-config-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="red-ui-footer-button" id="red-ui-sidebar-config-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>')),n=$("<div>").appendTo(s),a=$("<div>").appendTo(s),r=$("<div>").appendTo(s),i=!1,d={};function l(e,t,o){var i,n,a;return e=e.replace(/\./i,"-"),d[e]?d[e].label!==o&&(d[e].list.parent().find(".red-ui-palette-node-config-label").text(o),d[e].label=o):(t=$('<div class="red-ui-palette-category red-ui-sidebar-config-category" id="red-ui-sidebar-config-category-'+e+'"></div>').appendTo(t),i=$('<div class="red-ui-sidebar-config-tray-header red-ui-palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(t),(o?$('<span class="red-ui-palette-node-config-label"/>').text(o):$('<span class="red-ui-palette-node-config-label" data-i18n="sidebar.config.'+e+'">')).appendTo(i),$('<span class="red-ui-sidebar-node-config-filter-info"></span>').appendTo(i),(category=$('<ul class="red-ui-palette-content red-ui-sidebar-node-config-list"></ul>').appendTo(t)).on("click",function(e){$(s).find(".red-ui-palette-node").removeClass("selected")}),t.i18n(),n=i.find("i"),a={label:o,list:category,size:function(){return a.list.find("li:not(.red-ui-palette-node-config-none)").length},open:function(e){n.hasClass("expanded")||(n.addClass("expanded"),e?a.list.show():a.list.slideDown())},close:function(e){n.hasClass("expanded")&&(n.removeClass("expanded"),e?a.list.hide():a.list.slideUp())},isOpen:function(){return n.hasClass("expanded")}},i.on("click",function(e){a.isOpen()?a.close():a.open()}),d[e]=a),d[e]}function c(e,t){var o,a,e=l(e.replace(/\./i,"-")),r=e.list;t.sort(function(e,t){return e.type<t.type?-1:e.type>t.type?1:0}),i?(o=t.length,0<(o-=(t=t.filter(function(e){return!1!==e._def.hasUsers&&0===e.users.length})).length)?r.parent().find(".red-ui-sidebar-node-config-filter-info").text(RED._("sidebar.config.filtered",{count:o})).show():r.parent().find(".red-ui-sidebar-node-config-filter-info").hide()):r.parent().find(".red-ui-sidebar-node-config-filter-info").hide(),r.empty(),0===t.length?($('<li class="red-ui-palette-node-config-none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(r),e.close(!0)):(a="",t.forEach(function(t){var e=RED.utils.getNodeLabel(t,t.id),o=(t.type!=a&&($('<li class="red-ui-palette-node-config-type">'+t.type+"</li>").appendTo(r),a=t.type),$('<li class="red-ui-palette-node_id_'+t.id.replace(/\./g,"-")+'"></li>').appendTo(r)),i=$('<div class="red-ui-palette-node-config red-ui-palette-node"></div>').appendTo(o),e=(o.data("node",t.id),$('<div class="red-ui-palette-label"></div>').text(e).appendTo(i)),n=(t.d&&(i.addClass("red-ui-palette-node-config-disabled"),$('<i class="fa fa-ban"></i>').prependTo(e)),!1!==t._def.hasUsers&&(o=$("<div/>",{class:"red-ui-palette-icon-container red-ui-palette-icon-container-right"}).appendTo(i),0===t.users.length?o.text(0):$('<a href="#"/>').on("click",function(e){e.stopPropagation(),e.preventDefault(),RED.search.show(t.id)}).text(t.users.length).appendTo(o),RED.popover.tooltip(o,RED._("editor.nodesUse",{count:t.users.length})),0===t.users.length&&i.addClass("red-ui-palette-node-config-unused")),i.on("click",function(e){e.stopPropagation(),RED.view.select(!1),e.metaKey?$(this).toggleClass("selected"):($(s).find(".red-ui-palette-node").removeClass("selected"),$(this).addClass("selected")),RED.sidebar.info.refresh(t)}),i.on("dblclick",function(e){e.stopPropagation(),RED.editor.editConfig("",t.type,t.id)}),t.users.map(function(e){return e.id}));i.on("mouseover",function(e){RED.nodes.eachNode(function(e){-1!=n.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)}),RED.view.redraw()}),i.on("mouseout",function(e){RED.nodes.eachNode(function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)}),RED.view.redraw()})}),e.open(!0))}function t(){var e,t={global:!0},o=(l("global",n),RED.nodes.eachWorkspace(function(e){t[e.id.replace(/\./g,"-")]=!0,l(e.id,a,e.label)}),RED.nodes.eachSubflow(function(e){t[e.id.replace(/\./g,"-")]=!0,l(e.id,r,e.name)}),$(".red-ui-sidebar-config-category").each(function(){var e=$(this).attr("id").substring("red-ui-sidebar-config-category-".length);t[e]||($(this).remove(),delete d[e])}),[]),i={};for(e in RED.nodes.eachConfig(function(e){e.z?(i[e.z.replace(/\./g,"-")]=i[e.z.replace(/\./g,"-")]||[],i[e.z.replace(/\./g,"-")].push(e)):e.z||o.push(e)}),t)t.hasOwnProperty(e)&&c(e,i[e]||[]);c("global",o)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:s,toolbar:e,iconClass:"fa fa-cog",action:"core:show-config-tab",onchange:function(){t()}}),RED.actions.add("core:show-config-tab",function(){RED.sidebar.show("config")}),RED.actions.add("core:select-all-config-nodes",function(){$(s).find(".red-ui-palette-node").addClass("selected")}),RED.actions.add("core:delete-config-selection",function(){var a,e=[];$(s).find(".red-ui-palette-node.selected").each(function(){e.push($(this).parent().data("node"))}),0<e.length&&(a={t:"delete",nodes:[],changes:{},dirty:RED.nodes.dirty()},e.forEach(function(e){var t=RED.nodes.node(e);try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}a.nodes.push(t);for(var o=0;o<t.users.length;o++){var i,n=t.users[o];for(i in a.changes[n.id]={changed:n.changed,valid:n.valid},n._def.defaults)n._def.defaults.hasOwnProperty(i)&&n[i]==e&&(a.changes[n.id][i]=e,n[i]="",n.changed=!0,n.dirty=!0);RED.editor.validateNode(n)}RED.nodes.remove(e)}),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(a))}),RED.events.on("view:selection-changed",function(){$(s).find(".red-ui-palette-node").removeClass("selected")}),$("#red-ui-sidebar-config-collapse-all").on("click",function(e){for(var t in e.preventDefault(),d)d.hasOwnProperty(t)&&d[t].close()}),$("#red-ui-sidebar-config-expand-all").on("click",function(e){for(var t in e.preventDefault(),d)d.hasOwnProperty(t)&&0<d[t].size()&&d[t].open()}),$("#red-ui-sidebar-config-filter-all").on("click",function(e){e.preventDefault(),i&&($(this).addClass("selected"),$("#red-ui-sidebar-config-filter-unused").removeClass("selected"),i=!i,t())}),$("#red-ui-sidebar-config-filter-unused").on("click",function(e){e.preventDefault(),i||($(this).addClass("selected"),$("#red-ui-sidebar-config-filter-all").removeClass("selected"),i=!i,t())}),RED.popover.tooltip($("#red-ui-sidebar-config-filter-all"),RED._("sidebar.config.showAllUnusedConfigNodes")),RED.popover.tooltip($("#red-ui-sidebar-config-filter-unused"),RED._("sidebar.config.showAllUnusedConfigNodes"))},show:function(s){"boolean"==typeof s&&(s?$("#red-ui-sidebar-config-filter-unused"):$("#red-ui-sidebar-config-filter-all")).trigger("click"),t(),"string"==typeof s&&($("#red-ui-sidebar-config-filter-all").trigger("click"),s=s.replace(/\./g,"-"),setTimeout(function(){var e=$(".red-ui-palette-node_id_"+s),t=e.position().top,o=e.height(),i=$(".red-ui-sidebar-node-config"),n=i.height(),a=(n<t+o?i.animate({scrollTop:"-="+(n-(t+o)-30)},150):t<0&&i.animate({scrollTop:"+="+(t-10)},150),21),r=function(){a%2==0?e.removeClass("node_highlighted"):e.addClass("node_highlighted"),0<=--a&&setTimeout(r,100)};r()},100)),RED.sidebar.show("config")},refresh:t}}(),RED.sidebar.context=function(){var n,a,r,s,d,l,c,u,p;function h(e,t){u=e,t||s.prop("checked")?e?f(d,"context/node/"+e.id,e.id):f(d):($(d.table).empty(),(e?$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>'):$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>')).appendTo(d.table).i18n(),d.timestamp.html("&nbsp;"))}function g(e,t){p=e,t||r.prop("checked")?e?f(l,"context/flow/"+e.id,e.id):f(l):($(l.table).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(l.table).i18n(),l.timestamp.html("&nbsp;"))}function f(e,t,o){var a,p,f,h,g,i=e.table;o?(a=e,p=t,f=o,h=RED.settings.context.stores,g=a.table,$.getJSON(p,function(e){$(g).empty();var t,o={};for(t in e)if(e.hasOwnProperty(t))for(var i in e[t])e[t].hasOwnProperty(i)&&(o.hasOwnProperty(i)||(o[i]=[]),e[t][i].store=t,o[i].push(e[t][i]));for(var c=Object.keys(o),n=(c.sort(),c.length),u=0;u<n;u++)o[c[u]].forEach(function(n){var a=c[u],r=(o[a].length,$('<tr class="red-ui-help-info-row"><td class="red-ui-sidebar-context-property"></td><td></td></tr>').appendTo(g)),s=($(r.children()[0]).text(a),$('<span class="button-group"></span>')),e=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(s).on("click",function(e){e.preventDefault(),e.stopPropagation(),$.getJSON(p+"/"+a+"?store="+n.store,function(e){e.msg===d&&e.format===l||(d=e.msg,l=e.format,s.detach(),$(r.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(d,l),{typeHint:e.format,sourceId:f+"."+a,tools:s,path:""}).appendTo(r.children()[1]))})}),e=(RED.popover.tooltip(e,RED._("sidebar.context.refrsh")),$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(s).on("click",function(e){e.preventDefault(),e.stopPropagation();var i=RED.popover.create({trigger:"modal",target:r,direction:"left",content:function(){var e=$("<div>"),t=($('<p data-i18n="sidebar.context.deleteConfirm"></p>').appendTo(e),$("<p>").appendTo(e)),o=$('<span class="button-group"></span>').appendTo(t);return $('<button class="red-ui-button" data-i18n="common.label.cancel"></button>').appendTo(o).on("click",function(e){e.preventDefault(),i.close()}),o=$('<span class="button-group"></span>').appendTo(t),$('<button class="red-ui-button primary" data-i18n="common.label.delete"></button>').appendTo(o).on("click",function(e){e.preventDefault(),i.close(),$.ajax({url:p+"/"+a+"?store="+n.store,type:"DELETE"}).done(function(e,t,o){$.getJSON(p+"/"+a+"?store="+n.store,function(e){"undefined"===e.format?(r.remove(),0===g.children().length&&$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(g).i18n()):(d=e.msg,l=e.format,s.detach(),$(r.children()[1]).empty(),RED.utils.createObjectElement(RED.utils.decodeObject(d,l),{typeHint:e.format,sourceId:f+"."+a,tools:s,path:""}).appendTo(r.children()[1]))})}).fail(function(e,t,o){})}),e.i18n()}});i.open()})),d=(RED.popover.tooltip(e,RED._("sidebar.context.delete")),n.msg),l=n.format;RED.utils.createObjectElement(RED.utils.decodeObject(d,l),{typeHint:n.format,sourceId:f+"."+a,tools:s,path:""}).appendTo(r.children()[1]),1<h.length&&$("<span>",{class:"red-ui-sidebar-context-property-storename"}).text(n.store).appendTo($(r.children()[0]))});0===n&&$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.empty"></td></tr>').appendTo(g).i18n(),$(a.timestamp).text((new Date).toLocaleString())})):($(i).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.none"></td></tr>').appendTo(i).i18n())}function m(){RED.sidebar.show("context")}return{init:function(){(n=$("<div>").css({position:"relative",height:"100%"})).className="red-ui-sidebar-context";var e=$("<div></div>"),t=$("<div>",{class:"red-ui-sidebar-context-stack"}).appendTo(n),t=(a=RED.stack.create({container:t}),(d=a.add({title:RED._("sidebar.context.node"),collapsible:!0})).expand(),d.content.css({height:"100%"}),d.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(d.content),$('<table class="red-ui-info-table"></table>').appendTo(d.content)),o=(d.table=$("<tbody>").appendTo(t),$('<div style="float: right"></div>').appendTo(d.header)),i=RED.settings.get("editor.context.nodeRefresh",!1),i=(s=$('<input type="checkbox">').prop("checked",i).appendTo(o).toggleButton({baseClass:"red-ui-sidebar-header-button red-ui-button-small",enabledLabel:"",disabledLabel:""}).on("change",function(){var e=$(this).prop("checked");RED.settings.set("editor.context.flowRefresh",e)}),RED.popover.tooltip(s.next(),RED._("sidebar.context.autoRefresh")),$('<button class="red-ui-button red-ui-button-small" style="margin-left: 5px"><i class="fa fa-refresh"></i></button>').appendTo(o).on("click",function(e){e.stopPropagation(),e.preventDefault(),h(u,!0)})),t=(RED.popover.tooltip(i,RED._("sidebar.context.refrsh")),(l=a.add({title:RED._("sidebar.context.flow"),collapsible:!0})).expand(),l.content.css({height:"100%"}),l.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(l.content),$('<table class="red-ui-info-table"></table>').appendTo(l.content)),i=(l.table=$("<tbody>").appendTo(t),o=$('<div style="float: right"></div>').appendTo(l.header),RED.settings.get("editor.context.flowRefresh",!1)),i=(r=$('<input type="checkbox">').prop("checked",i).appendTo(o).toggleButton({baseClass:"red-ui-sidebar-header-button red-ui-button-small",enabledLabel:"",disabledLabel:""}).on("change",function(){var e=$(this).prop("checked");RED.settings.set("editor.context.flowRefresh",e)}),RED.popover.tooltip(r.next(),RED._("sidebar.context.autoRefresh")),$('<button class="red-ui-button red-ui-button-small" style="margin-left: 5px"><i class="fa fa-refresh"></i></button>').appendTo(o).on("click",function(e){e.stopPropagation(),e.preventDefault(),g(p,!0)})),t=(RED.popover.tooltip(i,RED._("sidebar.context.refrsh")),(c=a.add({title:RED._("sidebar.context.global"),collapsible:!0})).expand(),c.content.css({height:"100%"}),c.timestamp=$('<div class="red-ui-sidebar-context-updated">&nbsp;</div>').appendTo(c.content),$('<table class="red-ui-info-table"></table>').appendTo(c.content));c.table=$("<tbody>").appendTo(t),o=$('<div style="float: right"></div>').appendTo(c.header),$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(o).on("click",function(e){e.stopPropagation(),e.preventDefault(),f(c,"context/global","global")}),RED.popover.tooltip(o,RED._("sidebar.context.refrsh")),RED.actions.add("core:show-context-tab",m),RED.sidebar.addTab({id:"context",label:RED._("sidebar.context.label"),name:RED._("sidebar.context.name"),iconClass:"fa fa-database",content:n,toolbar:e,enableOnEdit:!0,action:"core:show-context-tab"}),RED.events.on("view:selection-changed",function(e){h(e.nodes&&1===e.nodes.length&&e.nodes[0])}),RED.events.on("workspace:change",function(e){g(RED.nodes.workspace(e.workspace))}),$(c.table).empty(),$('<tr class="red-ui-help-info-row red-ui-search-empty blank" colspan="2"><td data-i18n="sidebar.context.refresh"></td></tr>').appendTo(c.table).i18n(),c.timestamp.html("&nbsp;")}}}(),RED.palette.editor=function(){var g,l,c,D,u,n,p=[],f=[],y={},w={},E={},o={},m="",i=/^(\d+)(\.(\d+))?(\.(\d+))?(-([0-9A-Za-z-]+))?(\.([0-9A-Za-z-.]+))?$/,a=/^\d+$/;function t(e){this.number=0,this.text=e,a.test(e)?(this.number=parseInt(e),this.type="N"):this.type=null==e||e.length<1?"E":"T"}function R(e){e=e.match(i);this.parts=[new t(e[1]),new t(e[3]),new t(e[5]),new t(e[7]),new t(e[9])]}function r(e,t){e=(e=Date.now()-e)<300?300:0;setTimeout(function(){t()},e)}function b(e,t,i,n){i.show();var a=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done(function(e,t,o){r(a,function(){i.hide(),n()})}).fail(function(e,t,o){r(a,function(){i.hide(),n(e)})})}function v(e,t,o,i){e={module:e};t&&(e.version=t),o&&(e.url=o),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(e),contentType:"application/json; charset=utf-8"}).done(function(e,t,o){i()}).fail(function(e,t,o){i(e)})}function h(e){o.hasOwnProperty(e)||(o[e]=setTimeout(function(){delete o[e],s(e)},100))}function s(e){if(E.hasOwnProperty(e)){var t=E[e].info,o=E[e].elements;if(o){var i,n=0,a=0,c=0;for(i in o.errorList.empty(),E[e].totalUseCount=0,E[e].setUseCount={},t.sets)if(t.sets.hasOwnProperty(i)){var r,s=0,d=t.sets[i],l=o.sets[i];d.err&&(c++,r=d.err,d.err.message?r=d.err.message:d.err.code&&(r=d.err.code),$("<li>").text(r).appendTo(o.errorList)),d.enabled&&(n+=d.types.length),a+=d.types.length;for(var u=0;u<t.sets[i].types.length;u++){var p,f=t.sets[i].types[u],h=(s+=w[f]||0,l.swatches[f]);!d.enabled||(p=RED.nodes.getType(f))&&p.color&&(h.css({background:RED.utils.getNodeColor(f,p)}),h.css({border:"1px solid "+function(e){if(i=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e)){var t=parseInt(i[1]),o=parseInt(i[2]),i=parseInt(i[3]);if(160<(299*t+587*o+114*i)/1e3)return"rgb("+Math.floor(.8*t)+","+Math.floor(.8*o)+","+Math.floor(.8*i)+")"}return e}(h.css("backgroundColor"))}))}E[e].setUseCount[i]=s,E[e].totalUseCount+=s,0<s?(l.enableButton.text(RED._("palette.editor.inuse")),l.enableButton.addClass("disabled")):(l.enableButton.removeClass("disabled"),d.enabled?l.enableButton.text(RED._("palette.editor.disable")):l.enableButton.text(RED._("palette.editor.enable"))),l.setRow.toggleClass("red-ui-palette-module-set-disabled",!d.enabled)}0===c?o.errorRow.hide():o.errorRow.show(),o.setCount.text(RED._("palette.editor.nodeCount",{count:a,label:n===a?a:n+" / "+a})),0<E[e].totalUseCount?(o.enableButton.text(RED._("palette.editor.inuse")),o.enableButton.addClass("disabled"),o.removeButton.hide()):(o.enableButton.removeClass("disabled"),t.local&&o.removeButton.css("display","inline-block"),0===n?o.enableButton.text(RED._("palette.editor.enableall")):o.enableButton.text(RED._("palette.editor.disableall")),o.container.toggleClass("disabled",0===n))}t.pending_version?(o.versionSpan.html(t.version+' <i class="fa fa-long-arrow-right"></i> '+t.pending_version).appendTo(o.metaRow),o.updateButton.text(RED._("palette.editor.updated")).addClass("disabled").css("display","inline-block")):y.hasOwnProperty(e)&&A&&(b=y[e].version,v=t.version,b=new R(b),v=new R(v),0<b.compare(v))&&RED.utils.checkModuleAllowed(e,null,M,z)?(o.updateButton.show(),o.updateButton.text(RED._("palette.editor.update",{version:y[e].version}))):o.updateButton.hide()}else{E[e]={info:RED.nodes.registry.getModule(e)};var g,m=[e];for(g in E[e].info.sets)E[e].info.sets.hasOwnProperty(g)&&(m.push(g),m=m.concat(E[e].info.sets[g].types));E[e].index=m.join(",").toLowerCase(),D.editableList("addItem",E[e])}var b,v}t.prototype.compare=function(e){switch(this.type+e.type){case"EE":return 0;case"NT":case"TE":case"EN":return-1;case"NN":return this.number-e.number;case"TT":return this.text.localeCompare(e.text);case"ET":case"TN":case"NE":return 1}};var d,x=[],_=!(R.prototype.compare=function(e){for(var t=0,o=0,i=this.parts.length;0==t&&o<i;o++)t=this.parts[o].compare(e.parts[o]);return t}),k=L;function T(e,t,o,i){x.push(e||i),e?_=!0:(i.modules&&(i.modules=i.modules.filter(function(e){return!!RED.utils.checkModuleAllowed(e.id,e.version,I,P)&&((y[e.id]=e).index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.types&&(e.index=e.index.concat(e.types)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase(),!0)}),p=p.concat(i.modules)),c.searchBox("count",p.length)),1<n&&$(".red-ui-palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+x.length+"/"+n),x.length===n&&(_&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3),e=250-(Date.now()-d),setTimeout(function(){$("#red-ui-palette-module-install-shade").hide()},Math.max(e,0)))}function C(){var e,t;0===p.length&&(p=[],y={},u.editableList("empty"),$(".red-ui-palette-module-shade-status").text(RED._("palette.editor.loading")),e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"],_=!(x=[]),n=e.length,1<e.length&&$(".red-ui-palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#red-ui-palette-module-install-shade").show(),d=Date.now(),t=0,e.forEach(function(i,e){$.getJSON(i,{_:(new Date).getTime()},function(e){for(var t in T(null,i,0,e),E)E.hasOwnProperty(t)&&s(t)}).fail(function(e,t,o){console.warn("Error loading catalog",i,":",o),T(e,i)}).always(function(){++t===n&&c.searchBox("change")})}))}function j(){if(u.editableList("empty"),""!==c.searchBox("value").trim()){f.sort(k);for(var e=0;e<Math.min(10,f.length);e++)u.editableList("addItem",f[e]);0===f.length&&u.editableList("addItem",{}),10<f.length&&u.editableList("addItem",{start:10,more:f.length-10})}else u.editableList("addItem",{count:p.length})}function L(e,t){var o=c.searchBox("value").trim();if(""===o)return S(e,t);o=e.info.index.indexOf(o)-t.info.index.indexOf(o);return 0==o?S(e,t):o}function S(e,t){return e.info.id.localeCompare(t.info.id)}function O(e,t){return-1*(e.info.timestamp-t.info.timestamp)}var N,I=["*"],P=[],A=!0,M=["*"],z=[];function B(){return C(),g.activateTab("nodes"),N}function G(i,t,n){var e,a;!1!==RED.settings.get("externalModules.palette.allowInstall",!0)?(e=[{text:RED._("common.label.cancel"),click:function(){a.close()}}],i.url&&e.push({text:RED._("palette.editor.confirm.button.review"),class:"primary red-ui-palette-module-install-confirm-button-install",click:function(){var e=i.url||"";window.open(e)}}),e.push({text:RED._("palette.editor.confirm.button.install"),class:"primary red-ui-palette-module-install-confirm-button-install",click:function(){var o=RED.utils.addSpinnerOverlay(t,!0),e=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(o);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(e).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+i.id+" "+i.version),v(i.id,i.version,i.pkg_url,function(e){var t;o.remove(),e&&e.responseJSON&&(t=RED.notify(RED._("palette.editor.errors.installFailed",{module:i.id,message:e.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){t.close()}},{text:RED._("eventLog.view"),click:function(){t.close(),RED.actions.invoke("core:show-event-log")}}]})),n(e)}),a.close()}}),a=RED.notify(RED._("palette.editor.confirm.install.body",{module:i.id}),{modal:!0,fixed:!0,buttons:e})):n(new Error("Palette not editable"))}return{init:function(){var a,r,t,o,e,i,n,s,d;!1!==RED.settings.get("externalModules.palette.allowInstall",!0)&&(i=RED.settings.get("externalModules.palette.allowList"),e=RED.settings.get("externalModules.palette.denyList"),(i||e)&&(I=i,P=e),I=RED.utils.parseModuleList(I),P=RED.utils.parseModuleList(P),i=RED.settings.get("externalModules.palette.allowUpdateList"),e=RED.settings.get("externalModules.palette.denyUpdateList"),(i||e)&&(M=i,z=e),M=RED.utils.parseModuleList(M),z=RED.utils.parseModuleList(z),A=RED.settings.get("externalModules.palette.allowUpdate",!0),N=$('<div id="red-ui-settings-tab-palette"></div>'),o=$('<div id="red-ui-palette-editor"><ul id="red-ui-palette-editor-tabs"></ul></div>').appendTo(N),g=RED.tabs.create({element:N.find("#red-ui-palette-editor-tabs"),onchange:function(e){o.find(".red-ui-palette-editor-tab").hide(),e.content.show(),l&&l.searchBox("value",""),c&&c.searchBox("value",""),"install"===e.id?c&&c.trigger("focus"):l&&l.trigger("focus")},minimumActiveTabWidth:110}),i=o,i=$("<div>",{class:"red-ui-palette-editor-tab"}).appendTo(i),g.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:i}),e=$("<div>",{class:"red-ui-palette-search"}).appendTo(i),l=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(e).searchBox({delay:200,change:function(){var e,t,o;e=$(this).val(),m=e.toLowerCase(),t=D.editableList("filter"),o=D.editableList("length"),""===e?l.searchBox("count"):l.searchBox("count",t+" / "+o)}}),D=$("<ol>",{id:"red-ui-palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(i).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===m||(""===m||-1<e.index.indexOf(m))},addItem:function(o,c,r){var e,t,u,p,f,i,n,s,d,a,l=r.info;l?(n=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(o),e=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(n),$("<span>").text(l.name).appendTo(e),e=$('<div class="red-ui-palette-module-meta red-ui-palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(n),e=$("<span>").text(l.version).appendTo(e),t=$('<div class="red-ui-palette-module-meta red-ui-palette-module-errors"><i class="fa fa-warning"></i></div>').hide().appendTo(n),u=$('<ul class="red-ui-palette-module-error-list"></ul>').appendTo(t),n=$("<div>",{class:"red-ui-palette-module-meta"}).appendTo(n),p=$('<a href="#" class="red-ui-button red-ui-button-small red-ui-palette-module-set-button"><i class="fa fa-angle-right red-ui-palette-module-node-chevron"></i> </a>').appendTo(n),f=$("<span>").appendTo(p),n=$("<div>",{class:"red-ui-palette-module-button-group"}).appendTo(n),(a=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.update")).appendTo(n)).attr("id","up_"+Math.floor(1e9*Math.random())),a.on("click",function(e){var i,t,n,a,r,s;e.preventDefault(),$(this).hasClass("disabled")||(t=y[(i=l).name].version,n=y[l.name].pkg_url,a=o,!(r=function(e){})!==RED.settings.get("externalModules.palette.allowInstall",!0)?s=RED.notify(RED._("palette.editor.confirm.update.body",{module:i.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){s.close()}},{text:RED._("palette.editor.confirm.button.update"),class:"primary red-ui-palette-module-install-confirm-button-update",click:function(){var o=RED.utils.addSpinnerOverlay(a,!0),e=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(o);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(e).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+i.name+" "+t),v(i.name,t,n,function(e){var t;o.remove(),e&&e.responseJSON&&(t=RED.notify(RED._("palette.editor.errors.updateFailed",{module:i.name,message:e.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){t.close()}},{text:RED._("eventLog.view"),click:function(){t.close(),RED.actions.invoke("core:show-event-log")}}]})),r(e)}),s.close()}}]}):r(new Error("Palette not editable")))}),(i=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.remove")).appendTo(n)).attr("id","up_"+Math.floor(1e9*Math.random())),i.on("click",function(e){var n,t,a;e.preventDefault(),n=l,t=o,!(e=function(e){})!==RED.settings.get("externalModules.palette.allowInstall",!0)?a=RED.notify(RED._("palette.editor.confirm.remove.body",{module:n.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.close()}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary red-ui-palette-module-install-confirm-button-remove",click:function(){var i,o=RED.utils.addSpinnerOverlay(t,!0),e=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(o);$('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(e).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.remove")+" : "+n.name),e=n.name,i=function(e){var t;o.remove(),e&&e.responseJSON&&(t=RED.notify(RED._("palette.editor.errors.removeFailed",{module:n.name,message:e.responseJSON.message}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){t.close()}},{text:RED._("eventLog.view"),click:function(){t.close(),RED.actions.invoke("core:show-event-log")}}]}))},$.ajax({url:"nodes/"+e,type:"DELETE"}).done(function(e,t,o){i()}).fail(function(e,t,o){i(e)}),a.close()}}]}):e(new Error("Palette not editable"))}),l.local||i.hide(),n=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.disableall")).appendTo(n),s=$("<div>",{class:"red-ui-palette-module-content"}).appendTo(o),d=$('<div class="red-ui-palette-module-shade hide"><img src="red/images/spin.svg" class="red-ui-palette-spinner"/></div>').appendTo(o),r.elements={updateButton:a,removeButton:i,enableButton:n,errorRow:t,errorList:u,setCount:f,container:o,shade:d,versionSpan:e,sets:{}},p.on("click",function(e){e.preventDefault(),o.hasClass("expanded")?(o.removeClass("expanded"),s.slideUp()):(o.addClass("expanded"),s.slideDown())}),(a=Object.keys(l.sets)).sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),a.forEach(function(o){var i=l.sets[o],n=$("<div>",{class:"red-ui-palette-module-set"}).appendTo(s),e=$("<div>",{class:"red-ui-palette-module-set-button-group"}).appendTo(n),a={},e=(i.types.forEach(function(e){var t=$("<div>",{class:"red-ui-palette-module-type"}).appendTo(n);a[e]=$("<span>",{class:"red-ui-palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"red-ui-palette-module-type-node"}).text(e).appendTo(t)}),$('<a href="#" class="red-ui-button red-ui-button-small"></a>').appendTo(e));e.on("click",function(e){var t;e.preventDefault(),0===r.setUseCount[o]&&(e=RED.nodes.registry.getNodeSet(i.id),d.show(),t=!e.enabled,b(i.id,t,d,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors."+(t?"enable":"disable")+"Failed",{module:id,message:e.responseJSON.message}))}))}),r.elements.sets[i.name]={setRow:n,enableButton:e,swatches:a}}),n.on("click",function(e){e.preventDefault(),0===r.totalUseCount&&b(l.name,o.hasClass("disabled"),d,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:e.responseJSON.message}))})}),h(l.name)):$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(o)}}),e=o,e=$("<div>",{class:"red-ui-palette-editor-tab hide"}).appendTo(e),g.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:e}),i=$("<div>",{class:"red-ui-palette-editor-toolbar"}).appendTo(e),n=$("<div>",{class:"red-ui-palette-search"}).appendTo(e),c=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(n).searchBox({delay:300,change:function(){var t=$(this).val().trim().toLowerCase();0<t.length?(f=p.filter(function(e){return-1<e.index.indexOf(t)}).map(function(e){return{info:e}}),j(),c.searchBox("count",f.length+" / "+p.length)):(c.searchBox("count",p.length),u.editableList("empty"),u.editableList("addItem",{count:p.length}))}}),$("<span>").text(RED._("palette.editor.sort")+" ").appendTo(i),n=$('<span class="button-group"></span>').appendTo(i),s=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle selected"><i class="fa fa-sort-amount-desc"></i></a>').appendTo(n),d=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle" data-i18n="palette.editor.sortAZ"></a>').appendTo(n),n=$('<a href="#" class="red-ui-palette-editor-install-sort-option red-ui-sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(n),[{button:s,func:L},{button:d,func:S},{button:n,func:O}].forEach(function(t){t.button.on("click",function(e){e.preventDefault(),$(this).hasClass("selected")||($(".red-ui-palette-editor-install-sort-option").removeClass("selected"),$(this).addClass("selected"),k=t.func,j())})}),s=$("<span>").appendTo(i),(d=$('<a href="#" class="red-ui-sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(s)).on("click",function(e){e.preventDefault(),p=[],y={},C()}),RED.popover.tooltip(d,RED._("palette.editor.refresh")),u=$("<ol>",{style:"position: absolute;top: 79px;bottom: 0;left: 0;right: 0px;"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,e,o){if(o.count)$("<div>",{class:"red-ui-search-empty"}).text(RED._("palette.editor.moduleCount",{count:o.count})).appendTo(t);else{if(o.more)return t.addClass("red-ui-palette-module-more"),n=$("<div>",{class:"red-ui-palette-module-header palette-module"}).appendTo(t),void $('<a href="#"></a>').text(RED._("palette.editor.more",{count:o.more})).appendTo(n).on("click",function(e){e.preventDefault(),u.editableList("removeItem",o);for(var t=o.start;t<Math.min(o.start+10,o.start+o.more);t++)u.editableList("addItem",f[t]);10<o.more&&u.editableList("addItem",{start:o.start+10,more:o.more-10})});if(o.info){var i=o.info,n=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(t),a=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(n),a=($("<span>").text(i.name||i.id).appendTo(a),$('<a target="_blank" class="red-ui-palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",i.url).appendTo(a),$('<div class="red-ui-palette-module-meta"></div>').appendTo(n)),a=($("<div>",{class:"red-ui-palette-module-description"}).text(i.description).appendTo(a),$('<div class="red-ui-palette-module-meta"></div>').appendTo(n)),r=($('<span class="red-ui-palette-module-version"><i class="fa fa-tag"></i> '+i.version+"</span>").appendTo(a),$('<span class="red-ui-palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){if(new Date,new Date(e),(e=(Date.now()-new Date(e).getTime())/1e3)<60)return RED._("palette.editor.times.seconds");if((e=Math.floor(e/60))<10)return RED._("palette.editor.times.minutes");if(e<60)return RED._("palette.editor.times.minutesV",{count:e});if((e=Math.floor(e/60))<24)return RED._("palette.editor.times.hoursV",{count:e});if((e=Math.floor(e/24))<7)return RED._("palette.editor.times.daysV",{count:e});if((e=Math.floor(e/7))<4)return RED._("palette.editor.times.weeksV",{count:e});var t=Math.floor(e/4);return e%=4,t<12?RED._("palette.editor.times.monthsV",{count:t}):(e=Math.floor(t/12),0===(t%=12)?RED._("palette.editor.times.yearsV",{count:e}):RED._("palette.editor.times.year"+(1<e?"s":"")+"MonthsV",{y:e,count:t}))}(i.updated_at)+"</span>").appendTo(a),!1);if(i.types&&0<i.types.length)for(e=0;e<i.types.length;e++){var s=RED.nodes.registry.getNodeSetForType(i.types[e]);if(s){r=s.module;break}}a=$("<div>",{class:"red-ui-palette-module-meta"}).appendTo(n),n=$("<div>",{class:"red-ui-palette-module-button-group"}).appendTo(a),a=$('<a href="#" class="red-ui-button red-ui-button-small"></a>').text(RED._("palette.editor.install")).appendTo(n);a.on("click",function(e){e.preventDefault(),$(this).hasClass("disabled")||G(i,t,function(e){})}),E.hasOwnProperty(i.id)?(a.addClass("disabled"),a.text(RED._("palette.editor.installed"))):r&&(a.addClass("disabled"),a.text(RED._("palette.editor.conflict")),RED.popover.create({target:a,content:RED._("palette.editor.conflictTip",{module:r}),trigger:"hover",direction:"bottom",delay:{show:750,hide:50}})),o.elements={installButton:a}}else $("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(t)}}}),!1!==RED.settings.get("externalModules.palette.allowUpload",!0)&&(n=$('<span class="button-group">').prependTo(i),s=$('<button type="button" class="red-ui-sidebar-header-button red-ui-palette-editor-upload-button"><label><i class="fa fa-upload"></i><form id="red-ui-palette-editor-upload-form" enctype="multipart/form-data"><input name="tarball" type="file" accept=".tgz"></label></button>').appendTo(n),(a=s.find('input[type="file"]')).on("change",function(e){0<this.files.length&&(t.text(this.files[0].name),r.slideDown(200))}),r=$('<div class="red-ui-palette-editor-upload"></div>').appendTo(e),d=$("<div>").appendTo(r),i=$('<div class="placeholder-input"><i class="fa fa-upload"></i> </div>').appendTo(d),t=$("<span></span>").appendTo(i),n=$('<div class="red-ui-palette-editor-upload-buttons"></div>').appendTo(d),$('<button class="editor-button"></button>').text(RED._("common.label.cancel")).appendTo(n).on("click",function(e){e.preventDefault(),r.slideUp(200),a.val("")}),$('<button class="editor-button primary"></button>').text(RED._("common.label.upload")).appendTo(n).on("click",function(e){e.preventDefault();var i=RED.utils.addSpinnerOverlay(r,!0),e=$('<div style="position: relative;bottom: calc(50% + 17px); padding-right: 10px;text-align: right;"></div>').appendTo(i),e=($('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(e).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.eventLog.startEvent(RED._("palette.editor.confirm.button.install")+" : "+a[0].files[0].name),new FormData),n=(e.append("tarball",a[0].files[0]),a[0].files[0].name);$.ajax({url:"nodes",data:e,cache:!1,contentType:!1,processData:!1,method:"POST"}).always(function(e,t,o){i.remove(),a.val(""),r.slideUp(200)}).fail(function(e,t,o){e.responseJSON&&(t=e.responseJSON.message);var i=RED.notify(RED._("palette.editor.errors.installFailed",{module:n,message:t}),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.close"),click:function(){i.close()}},{text:RED._("eventLog.view"),click:function(){i.close(),RED.actions.invoke("core:show-event-log")}}]});a.val(""),r.slideUp(200)})}),RED.popover.tooltip(s,RED._("palette.editor.upload"))),$('<div id="red-ui-palette-module-install-shade" class="red-ui-palette-module-shade hide"><div class="red-ui-palette-module-shade-status"></div><img src="red/images/spin.svg" class="red-ui-palette-spinner"/></div>').appendTo(e),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:B,close:function(){N.detach()},focus:function(){g.resize(),setTimeout(function(){l.trigger("focus")},200)}}),RED.actions.add("core:manage-palette",function(){RED.userSettings.show("palette")}),RED.events.on("registry:module-updated",function(e){h(e.module)}),RED.events.on("registry:node-set-enabled",function(e){h(e.module)}),RED.events.on("registry:node-set-disabled",function(e){h(e.module)}),RED.events.on("registry:node-type-added",function(e){/^subflow:/.test(e)||h(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-type-removed",function(e){/^subflow:/.test(e)||h(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-set-added",function(e){h(e.module);for(var t=0;t<f.length;t++)if(f[t].info.id===e.module){var o=f[t].elements.installButton;o.addClass("disabled"),o.text(RED._("palette.editor.installed"));break}}),RED.events.on("registry:node-set-removed",function(e){if(!RED.nodes.registry.getModule(e.module)){var t=E[e.module];if(t){D.editableList("removeItem",t),delete E[e.module];for(var o=0;o<f.length;o++)if(f[o].info.id===e.module){var i=f[o].elements.installButton;i.removeClass("disabled"),i.text(RED._("palette.editor.install"));break}}}}),RED.events.on("nodes:add",function(e){/^subflow:/.test(e.type)||(w[e.type]=(w[e.type]||0)+1,1===w[e.type]&&h(RED.nodes.registry.getNodeSetForType(e.type).module))}),RED.events.on("nodes:remove",function(e){w.hasOwnProperty(e.type)&&(w[e.type]--,0===w[e.type]&&(delete w[e.type],h(RED.nodes.registry.getNodeSetForType(e.type).module)))}))},install:G}}(),RED.editor=function(){var l=[],c=!1,o={},b={},m={},u={};function w(e){var t,o,i,n,a=e.valid,c=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))o=(t=RED.nodes.subflow(e.type.substring(8))).valid,n=t.changed,void 0===o&&(o=w(t),n=t.changed),i=f(e,e._def.defaults,e),e.valid=o&&0===i.length,e.changed=e.changed||n,e.validationErrors=i;else if(e._def)i=f(e,e._def.defaults,e),e._def._creds&&(i=i.concat(f(e,e._def.credentials,e._def._creds))),e.valid=0===i.length,e.validationErrors=i;else if("subflow"==e.type){for(var r=RED.nodes.filterNodes({z:e.id}),s=0;s<r.length;s++)o=r[s].valid,n=r[s].changed,void 0===o&&(o=w(r[s]),n=r[s].changed),e.valid=e.valid&&o,e.changed=e.changed||n;for(var d=RED.nodes.filterNodes({type:"subflow:"+e.id}),l={},s=0;s<d.length;s++)d[s].valid=e.valid,d[s].changed=d[s].changed||e.changed,d[s].dirty=!0,l[d[s].z]=!0;Object.keys(l).forEach(function(e){e=RED.nodes.subflow(e);e&&w(e)})}return a===e.valid&&c===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&w(t)),e.valid}function f(e,t,o){var i,n=[];for(i in t)t.hasOwnProperty(i)&&(a(e,t,i,o[i])||n.push(i));return n}function a(t,e,o,i){var n=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(i))return 1;if(/^\$\{[a-zA-Z_][a-zA-Z0-9_]*\}$/.test(i))return 1;if((n="required"in e[o]&&e[o].required?""!==i:n)&&"validate"in e[o])try{n=e[o].validate.call(t,i)}catch(e){console.log("Validation error:",t.type,t.id,"property: "+o,"value:",i,e)}return n=n&&e[o].type&&RED.nodes.getType(e[o].type)&&!("validate"in e[o])?i&&"_ADD_"!=i?(t=RED.nodes.node(i))&&(null==t.valid||t.valid):e[o].hasOwnProperty("required")&&!e[o].required:n}function v(e,t){for(var o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&i(e,e._def.defaults,o,t);if(e._def.credentials)for(o in e._def.credentials)e._def.credentials.hasOwnProperty(o)&&i(e,e._def.credentials,o,t)}function i(e,t,o,i){var n,i=$("#"+i+"-"+o);0<i.length&&(n=i.val(),t[o].hasOwnProperty("format")&&""!==t[o].format&&"DIV"===i[0].nodeName&&(n=i.text()),a(e,t,o,n)?i.removeClass("input-error"):i.addClass("input-error"))}function p(t,o){t.resize=!0,t.dirty=!0,t.dirtyStatus=!0;var i=[];o&&RED.nodes.eachLink(function(e){e.source===t&&o.hasOwnProperty(e.sourcePort)&&("-1"===o[e.sourcePort]?i.push(e):e.sourcePort=o[e.sourcePort])}),t.hasOwnProperty("__outputs")&&(t.outputs<t.__outputs&&RED.nodes.eachLink(function(e){e.source===t&&e.sourcePort>=t.outputs&&-1===i.indexOf(e)&&i.push(e)}),delete t.__outputs),t.inputs=Math.min(1,Math.max(0,parseInt(t.inputs))),isNaN(t.inputs)&&(t.inputs=0),0===t.inputs&&(i=i.concat(RED.nodes.filterLinks({target:t})));for(var e=0;e<i.length;e++)RED.nodes.removeLink(i[e]);return i}function y(e,t,o,i){o=$("#"+o+"-"+t);0!==o.length&&("checkbox"===o.attr("type")?o.prop("checked",e[t]):(null==(e=e[t])&&(e=""),void 0!==i&&i[t].hasOwnProperty("format")&&""!==i[t].format&&"DIV"===o[0].nodeName?(o.html(RED.text.format.getHtml(e,i[t].format,{},!1,"en")),RED.text.format.attach(o[0],i[t].format,{},!1,"en")):(o.val(e),"INPUT"!==o[0].nodeName&&"TEXTAREA"!==o[0].nodeName||RED.text.bidi.prepareInput(o))))}function R(t,e,o,i){var n=$("#"+i+"-"+o);void 0!==e&&"format"in e[o]&&""!==e[o].format&&"DIV"===n[0].nodeName?$("#"+i+"-"+o).on("change keyup",function(e){$(this).attr("skipValidation")||v(t,i)}):$("#"+i+"-"+o).on("change",function(e){$(this).attr("skipValidation")||v(t,i)})}function x(e,t,o,i){for(var n in t)t.hasOwnProperty(n)&&("password"==t[n].type?o[n]?$("#"+i+"-"+n).val(o[n]):o["has_"+n]?$("#"+i+"-"+n).val("__PWRD__"):$("#"+i+"-"+n).val(""):y(o,n,i,t),R(e,t,n,i))}function E(d,l,c,u,p,f,h){function t(){var e,t,o,i,n=$("<ul></ul>").appendTo(d),a=$("<div></div>").appendTo(d),r=RED.tabs.create({element:n,onchange:function(e){a.children().hide(),e.content.show(),e.onchange&&e.onchange.call(e),g&&RED.tray.resize()},collapsible:!0,menu:!1}),s=[];for(e in l=l.slice(),m)m.hasOwnProperty(e)&&m[e](c)&&l.push(e);for(o in l.forEach(function(t){try{var e,o,i=b[t];i?("function"==typeof i&&(i=i.call(i,c)),e=$("<div>",{class:"red-ui-tray-content"}).appendTo(a).hide(),i.create.call(i,e),o={id:t,label:i.label,name:i.name,iconClass:i.iconClass,content:e,onchange:function(){i.show&&i.show.call(i)}},r.addTab(o),s.push(i)):console.warn("Unregisted edit pane:",t)}catch(e){console.log(t,e)}}),u.defaults)u.defaults.hasOwnProperty(o)&&(u.defaults[o].type?u.defaults[o]._type.array||((t=RED.nodes.getType(u.defaults[o].type))&&"config"===t.category?t.exclusive?function(t,o,i,n){var a=$("#"+n+"-"+o),e=(a.val(t[o]),a.attr("type","hidden"),$("<a>",{id:n+"-edit-"+o,class:"red-ui-button"}));a.after(e),t[o]?e.text(RED._("editor.configEdit")):e.text(RED._("editor.configAdd")),e.on("click",function(e){k(o,i,a.val()||"_ADD_",n,t),e.preventDefault()})}(c,o,u.defaults[o].type,p):function(t,o,i,n,e){var a,r,s,d=$("#"+n+"-"+o);0!==d.length&&(s=d.width(),a=d.attr("style"),s=null!==(a=/(^|\s|;)width\s*:\s*([^;]+)/i.exec(a))?a[2].trim():"70%",a=$("<div></div>").css({width:s,display:"inline-flex"}),r=$('<select id="'+n+"-"+o+'"></select>').appendTo(a),d.replaceWith(a),r.css({"flex-grow":1}),_(o,i,t[o],n,e),$('<a id="'+n+"-lookup-"+o+'" class="red-ui-button"><i class="fa fa-pencil"></i></a>').css({"margin-left":"10px"}).appendTo(a),$("#"+n+"-lookup-"+o).on("click",function(e){k(o,i,r.find(":selected").val(),n,t),e.preventDefault()}),s="",e=RED.nodes.node(t[o]),RED.nodes.getType(i),e&&(s=RED.utils.getNodeLabel(e,e.id)),d.val(s))}(c,o,u.defaults[o].type,p,u.defaults[o].filter):(console.log("Unknown type:",u.defaults[o].type),y(c,o,p,u.defaults))):y(c,o,p,u.defaults),R(c,u.defaults,o,p));if(/^subflow:/.test(u.type)||x(c,u.credentials,c.credentials,p),u.oneditprepare)try{u.oneditprepare.call(c)}catch(e){console.log("oneditprepare",c.id,c.type,e.toString()),console.log(e.stack)}for(o in u.defaults)u.defaults.hasOwnProperty(o)&&((i=$("#"+p+"-"+o)).attr("skipValidation",!0),void 0!==i.data("noderedTypedInput")?i.trigger("change",[i.typedInput("type"),i.typedInput("value")]):i.trigger("change"),i.removeAttr("skipValidation"));if(u.credentials)for(o in u.credentials)u.credentials.hasOwnProperty(o)&&((i=$("#"+p+"-"+o)).attr("skipValidation",!0),void 0!==i.data("noderedTypedInput")?i.trigger("change",[i.typedInput("type"),i.typedInput("value")]):i.trigger("change"),i.removeAttr("skipValidation"));v(c,p),g=!0,f&&r.activateTab(f),h&&h(s)}var e,o,i,n,a,g=!1;u.credentials||/^subflow:/.test(u.type)||"group"===c.type||"tab"===c.type?c.credentials?(x(c,u.credentials,c.credentials,p),t()):(e=c.type,/^subflow:/.test(e)&&(e="subflow"),e=e,o=c.id,i=function(e){e&&(c.credentials=e,c.credentials._=$.extend(!0,{},e)),t()},a=setTimeout(function(){n=RED.notify($('<p data-i18n="[prepend]editor.loadCredentials">  <img src="red/images/spin.svg"/></p>').i18n(),{fixed:!0})},800),e="credentials/"+e.replace(/\s+/g,"-")+"/"+o,$.ajax({url:e,dataType:"json",success:function(e){n&&(n.close(),n=null),clearTimeout(a),i(e)},error:function(e,t,o){n&&(n.close(),n=null),clearTimeout(a),RED.notify(RED._("editor.errors.credentialLoadFailed"),"error"),i(null)},timeout:3e4})):t()}function D(){for(var e=l.length-1;e<l.length;e++){var t=l[e];if(i=t.type,"group"===t.type)i=RED._("group.editGroup",{name:RED.utils.sanitize(t.name||t.id)});else if("_expression"===t.type)i=RED._("expressionEditor.title");else if("_js"===t.type)i=RED._("jsEditor.title");else if("_text"===t.type)i=RED._("textEditor.title");else if("_json"===t.type)i=RED._("jsonEditor.title");else if("_markdown"===t.type)i=RED._("markdownEditor.title");else if("_buffer"===t.type)i=RED._("bufferEditor.title");else if("subflow"===t.type)i=RED._("subflow.editSubflow",{name:RED.utils.sanitize(t.name)});else if(0===t.type.indexOf("subflow:"))var o=RED.nodes.subflow(t.type.substring(8)),i=RED._("subflow.editSubflowInstance",{name:RED.utils.sanitize(o.name)});else if(void 0!==t._def){if(void 0!==t._def.paletteLabel)try{i=RED.utils.sanitize(("function"==typeof t._def.paletteLabel?t._def.paletteLabel.call(t._def):t._def.paletteLabel)||"")}catch(e){console.log("Definition error: "+t.type+".paletteLabel",e)}e===l.length-1&&(i=RED.nodes.node(t.id)?RED._("editor.editNode",{type:RED.utils.sanitize(i)}):RED._("editor.addNewConfig",{type:RED.utils.sanitize(i)}))}}return i}function h(t,e){if(t._def.oneditsave){var o={};for(var i in t._def.defaults)t._def.defaults.hasOwnProperty(i)&&("string"==typeof t[i]||"number"==typeof t[i]?o[i]=t[i]:o[i]=$.extend(!0,{},{v:t[i]}).v);try{!0===t._def.oneditsave.call(t)&&(e.changed=!0)}catch(e){console.warn("oneditsave",t.id,t.type,e.toString())}for(i in t._def.defaults)t._def.defaults.hasOwnProperty(i)&&(null===o[i]||"string"==typeof o[i]||"number"==typeof o[i]?o[i]!==t[i]&&(e.changes[i]=o[i],e.changed=!0):"group"===t.type&&"nodes"===i||JSON.stringify(o[i])!==JSON.stringify(t[i])&&(e.changes[i]=o[i],e.changed=!0))}}function g(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function _(e,o,t,i,n){if(i){var a=$("#"+i+"-edit-"+e);if(a.length)t?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),$("#"+i+"-"+e).val(t);else{var r=$("#"+i+"-"+e),a=RED.nodes.getType(o);r.children().remove();var s=(s=RED.nodes.workspace(RED.workspaces.active()))||RED.nodes.subflow(RED.workspaces.active()),d=[],i=("function"!=typeof n&&(n=null),RED.nodes.eachConfig(function(e){var t;e.type!=o||e.z&&e.z!==s.id||n&&!n.call(null,e)||(t=RED.utils.getNodeLabel(e,e.id),e.__label__=t+(e.d?" ["+RED._("workspace.disabled")+"]":""),d.push(e))}),g);"function"==typeof a.sort&&(i=a.sort);try{d.sort(i)}catch(e){console.log("Definition error: "+a.type+".sort",e)}d.forEach(function(e){$('<option value="'+e.id+'"'+(t==e.id?" selected":"")+"></option>").text(RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)).appendTo(r),delete e.__label__});e=o;if(void 0!==a.paletteLabel)try{e=RED.utils.sanitize(("function"==typeof a.paletteLabel?a.paletteLabel.call(a):a.paletteLabel)||o)}catch(e){console.log("Definition error: "+o+".paletteLabel",e)}r.append('<option value="_ADD_"'+(""===t?" selected":"")+">"+RED._("editor.addNewType",{type:e})+"</option>"),window.setTimeout(function(){r.trigger("change")},50)}}}function k(f,h,e,y,g){if(!c){c=!0;var m="_ADD_"==e,s=RED.nodes.getType(h),b=RED.nodes.node(e),v=[],e="",t=RED.nodes.subflow(RED.workspaces.active());if(t&&(e=t.id),null==b){for(var o in b={id:RED.nodes.id(),_def:s,type:h,z:e,users:[]},s.defaults)s.defaults[o].value&&(b[o]=JSON.parse(JSON.stringify(s.defaults[o].value)));b._=s._}l.push(b),RED.view.state(RED.state.EDITING);t={title:D(),resize:function(e){$(".red-ui-tray-content").height(e.height-50);var e=$("#node-config-dialog-edit-form"),t={width:e.width(),height:e.height()};v.forEach(function(e){e.resize&&e.resize.call(e,t)})},open:function(e,n){e.find(".red-ui-tray-header");var a=e.find(".red-ui-tray-body"),r=e.find(".red-ui-tray-footer"),e=$('<div class="red-ui-tray-footer-left"></div>').appendTo(r),e=($('<input id="node-config-input-node-disabled" type="checkbox">').prop("checked",!!b.d).appendTo(e).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0}),!1!==s.hasUsers&&$('<span><i class="fa fa-info-circle"></i> <span id="red-ui-editor-config-user-count"></span></span>').css("margin-left","10px").appendTo(e),r.append('<span class="red-ui-tray-footer-right"><span id="red-ui-editor-config-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="red-ui-editor-config-scope"></select></span>'),["editor-tab-properties"]);b._def.defaults&&b._def.defaults.hasOwnProperty("info")||e.push("editor-tab-description"),E(a,e,b,s,"node-config-input",null,function(e){v=e,b._def.exclusive?$("#red-ui-editor-config-scope").hide():$("#red-ui-editor-config-scope").show(),$("#red-ui-editor-config-scope-warning").hide();var o={},t=(b.users.forEach(function(e){o[e.z]=!0}),Object.keys(o).length),i=$("#red-ui-editor-config-scope").empty();i.off("change"),i.append('<option value=""'+(b.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),i.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(e){var t=e.label;o[e.id]&&(t="* "+t),$('<option value="'+e.id+'"'+(e.id==b.z?" selected":"")+"></option>").text(t).appendTo(i)}),i.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(e){var t=e.name;o[e.id]&&(t="* "+t),$('<option value="'+e.id+'"'+(e.id==b.z?" selected":"")+"></option>").text(t).appendTo(i)}),0<t&&i.on("change",function(){var e=$(this).val();""!==e&&(!o[e]||1<t)?$("#red-ui-editor-config-scope-warning").show():$("#red-ui-editor-config-scope-warning").hide()}),!1!==s.hasUsers&&$("#red-ui-editor-config-user-count").text(RED._("editor.nodesUse",{count:b.users.length})).parent().show(),a.i18n(),r.i18n(),c=!1,n()})},close:function(){RED.workspaces.refresh(),v.forEach(function(e){e.close&&e.close.call(e)}),l.pop()},show:function(){b&&(RED.sidebar.info.refresh(b),RED.sidebar.help.show(h,!1))}};t.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var t=h,o=b.id,e=RED.nodes.getType(t);if(e.oneditcancel&&e.oneditcancel){var i=RED.nodes.node(o);if(i)try{e.oneditcancel.call(i,!1)}catch(e){console.log("oneditcancel",i.id,i.type,e.toString())}else try{e.oneditcancel.call({id:o},!0)}catch(e){console.log("oneditcancel",o,t,e.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:m?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,t,o,i,c={changes:{},changed:!1,outputMap:null},n=f,u=(b.id,h),p=m,a=RED.nodes.getType(u);if(a.oneditsave)try{a.oneditsave.call(b)}catch(e){console.warn("oneditsave",b.id,b.type,e.toString())}for(e in a.defaults)!a.defaults.hasOwnProperty(e)||null!=(i="checkbox"===(i=$("#node-config-input-"+e)).attr("type")?i.prop("checked"):"format"in a.defaults[e]&&""!==a.defaults[e].format&&"DIV"===i[0].nodeName?i.text():i.val())&&i!==b[e]&&(b._def.defaults[e].type&&("_ADD_"==i&&(i=""),(t=RED.nodes.node(b[e]))&&((o=t.users).splice(o.indexOf(b),1),RED.events.emit("nodes:change",t)),(t=RED.nodes.node(i))&&(t.users.push(b),RED.events.emit("nodes:change",t))),b[e]=i);v.forEach(function(e){e.apply&&e.apply.call(e,c)}),b.label=a.label;for(var r=$("#red-ui-editor-config-scope").val(),s=(b.z=r,$("#node-config-input-node-disabled").prop("checked")?!0!==b.d&&(b.d=!0):!0===b.d&&delete b.d,r&&(b.users=b.users.filter(function(e){var t,o=!0;for(t in e._def.defaults)e._def.defaults.hasOwnProperty(t)&&e._def.defaults[t].type===b.type&&e[t]===b.id&&e.z!==r&&(o=!1,e[t]=null,e.dirty=!0,e.changed=!0,w(e));return o})),p&&RED.nodes.add(b),w(b),{}),d=(s[b.id]=!0,b.users.slice());0<d.length;){var l=d.pop();s[l.id]||(s[l.id]=!0,l.users&&(d=d.concat(l.users)),w(l))}RED.nodes.dirty(!0),RED.view.redraw(!0),p||(RED.events.emit("editor:save",b),RED.events.emit("nodes:change",b)),RED.tray.close(function(){var e=null;g&&"function"==typeof g._def.defaults[n].filter&&(e=function(e){return g._def.defaults[n].filter.call(g,e)}),_(n,u,b.id,y,e)})}}],m||t.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var t=f,e=b.id,o=h,i=RED.nodes.getType(o);try{i.ondelete&&(console.log("Deprecated API warning: config node type ",o," has an ondelete function - should be oneditdelete"),i.ondelete.call(b)),i.oneditdelete&&i.oneditdelete.call(b)}catch(e){console.log("oneditdelete",b.id,b.type,e.toString())}for(var n={t:"delete",nodes:[b],changes:{},dirty:RED.nodes.dirty()},a=0;a<b.users.length;a++){var r,s=b.users[a];for(r in n.changes[s.id]={changed:s.changed,valid:s.valid},s._def.defaults)s._def.defaults.hasOwnProperty(r)&&s[r]==e&&(n.changes[s.id][r]=e,s[r]="",s.changed=!0,s.dirty=!0);w(s)}RED.nodes.remove(e),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(n),RED.tray.close(function(){var e=null;g&&"function"==typeof g._def.defaults[t].filter&&(e=function(e){return g._def.defaults[t].filter.call(g,e)}),_(t,o,"",y,e)})}}),RED.tray.show(t)}}function t(e,t){o.hasOwnProperty(e)?(0<l.length&&(t.parent=l[l.length-1].id),l.push({type:e}),t.title=t.title||D(),t.onclose=function(){l.pop()},o[e].show(t)):console.log("Unknown type editor:",e)}return{init:function(){window.ace&&window.ace.config.set("basePath","vendor/ace"),RED.tray.init(),RED.actions.add("core:confirm-edit-tray",function(){$(document.activeElement).blur(),$("#node-dialog-ok").trigger("click"),$("#node-config-dialog-ok").trigger("click")}),RED.actions.add("core:cancel-edit-tray",function(){$(document.activeElement).blur(),$("#node-dialog-cancel").trigger("click"),$("#node-config-dialog-cancel").trigger("click")}),RED.editor.codeEditor.init()},edit:function(r,n){var s,e,d,o,t,i;c||(s=r,e=!(c=!0),d=[],l.push(r),RED.view.state(RED.state.EDITING),o=r.type,"subflow:"==r.type.substring(0,8)&&(o="subflow"),t={title:D(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],o=[],i=RED.nodes.remove(s.id),t=(t.push(s),{t:"delete",nodes:t=t.concat(i.nodes),links:o=o.concat(i.links),changes:{},dirty:e});RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(t),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(s._def){if(s._def.oneditcancel)try{s._def.oneditcancel.call(s)}catch(e){console.log("oneditcancel",s.id,s.type,e.toString())}for(var e in s._def.defaults){var t;s._def.defaults.hasOwnProperty(e)&&(!(t=s._def.defaults[e]).type||(t=RED.nodes.getType(t.type))&&t.exclusive&&(""===(t=$("#node-input-"+e).val()||"")||s[e]||RED.nodes.remove(t)))}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,t,o,i={changes:{},changed:!1,outputMap:null},n=RED.nodes.dirty(),a=(h(s,i),d.forEach(function(e){e.apply&&e.apply.call(e,i)}),p(s,i.outputMap));$("#node-input-node-disabled").prop("checked")?!0!==r.d&&(i.changes.d=r.d,i.changed=!0,r.d=!0):!0===r.d&&(i.changes.d=r.d,i.changed=!0,delete r.d),r.resize=!0,i.changed&&(e=s.changed,s.changed=!0,RED.nodes.dirty(!0),o=RED.nodes.subflow(RED.workspaces.active()),t=null,o&&(t=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+RED.workspaces.active()&&(t.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,p(e))})),o={t:"edit",node:s,changes:i.changes,links:a,dirty:n,changed:e},i.outputMap&&(o.outputMap=i.outputMap),t&&(o.subflow={instances:t}),RED.history.push(o)),s.dirty=!0,w(s),RED.events.emit("editor:save",s),RED.events.emit("nodes:change",s),RED.tray.close()}}],resize:function(e){u[o]=e.width,$(".red-ui-tray-content").height(e.height-50);var e=$(".red-ui-tray-content form").height(e.height-50-40),t={width:e.width(),height:e.height()};d.forEach(function(e){e.resize&&e.resize.call(e,t)})},open:function(e,t){s.hasOwnProperty("outputs")&&(s.__outputs=s.outputs);var o=e.find(".red-ui-tray-footer"),i=e.find(".red-ui-tray-body"),e=(i.parent().css("overflow","hidden"),$('<div class="red-ui-tray-footer-left"></div>').appendTo(o)),e=($('<input id="node-input-node-disabled" type="checkbox">').prop("checked",!!r.d).appendTo(e).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0}),["editor-tab-properties"]);/^subflow:/.test(r.type)&&e.push("editor-tab-envProperties"),r._def.defaults&&r._def.defaults.hasOwnProperty("info")||e.push("editor-tab-description"),e.push("editor-tab-appearance"),E(i,e,r,r._def,"node-input",n,function(e){d=e,i.i18n(),o.i18n(),c=!1,t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),s&&!e&&RED.sidebar.info.refresh(s),RED.workspaces.refresh(),d.forEach(function(e){e.close&&e.close.call(e)}),RED.view.redraw(!0),l.pop()},show:function(){s&&(RED.sidebar.info.refresh(s),RED.sidebar.help.show(s.type,!1))}},u.hasOwnProperty(o)&&(t.width=u[o]),"subflow"===o&&(i=s.type.substring(8),t.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(i),e=!0,$("#node-dialog-ok").trigger("click")}})),RED.tray.show(t))},editConfig:k,editFlow:function(n,a){var r,e;c||(c=!0,r=[],RED.view.state(RED.state.EDITING),e={title:RED._("workspace.editFlow",{name:RED.utils.sanitize(n.label)}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1===RED.workspaces.count()?" disabled":""),text:RED._("common.label.delete"),click:function(){RED.workspaces.delete(n),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var t={changes:{},changed:!1,outputMap:null},e=RED.nodes.dirty(),o=(r.forEach(function(e){e.apply&&e.apply.call(e,t)}),$("#node-input-disabled").prop("checked"));n.disabled!==o&&(t.changes.disabled=n.disabled,t.changed=!0,n.disabled=o,$("#red-ui-tab-"+n.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!n.disabled),n.id===RED.workspaces.active()&&$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!n.disabled)),t.changed&&(o={t:"edit",changes:t.changes,node:n,dirty:e},n.changed=!0,RED.history.push(o),RED.nodes.dirty(!0),t.changes.hasOwnProperty("disabled")&&(RED.nodes.eachNode(function(e){e.z===n.id&&(e.dirty=!0)}),RED.view.redraw()),RED.workspaces.refresh(),RED.events.emit("flows:change",n)),RED.tray.close()}}],resize:function(e){$(".red-ui-tray-content").height(e.height-50);var e=$(".red-ui-tray-content form").height(e.height-50-40),t={width:e.width(),height:e.height()};r.forEach(function(e){e.resize&&e.resize.call(e,t)})},open:function(e,t){var o=e.find(".red-ui-tray-footer"),i=e.find(".red-ui-tray-body"),e=(i.parent().css("overflow","hidden"),$('<div class="red-ui-tray-footer-left"></div>').appendTo(o));n.hasOwnProperty("disabled")||(n.disabled=!1),$('<input id="node-input-disabled" type="checkbox">').prop("checked",n.disabled).appendTo(e).toggleButton({enabledIcon:"fa-circle-thin",disabledIcon:"fa-ban",invertState:!0}),E(i,["editor-tab-flow-properties","editor-tab-envProperties"],n,{},"node-input",a,function(e){r=e,i.i18n(),o.i18n(),c=!1,t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),r.forEach(function(e){e.close&&e.close.call(e)});var e=RED.view.selection();e.nodes||e.links||n.id!==RED.workspaces.active()||RED.sidebar.info.refresh(n)}},RED.tray.show(e))},editSubflow:function(a,r){var s,d,e;c||(c=!0,s=a,d=[],l.push(a),RED.view.state(RED.state.EDITING),e={title:D(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var t,e,o={changes:{},changed:!1,outputMap:null},i=RED.nodes.dirty(),n=(d.forEach(function(e){e.apply&&e.apply.call(e,o)}),$("#subflow-input-name").val()),n=(n!=s.name&&(o.changes.name=s.name,s.name=n,o.changed=!0),s.env),a=RED.subflow.exportSubflowTemplateEnv($("#node-input-env-container").editableList("items"));a&&0<a.length&&a.forEach(function(e){"cred"===e.type&&(s.credentials=s.credentials||{_:{}},s.credentials[e.name]=e.value,s.credentials["has_"+e.name]=""!==e.value,"__PWRD__"!==e.value&&(o.changed=!0),delete e.value)}),e=a,JSON.stringify(n)!==JSON.stringify(e)&&(s.env=a,o.changes.env=s.env,o.changed=!0),o.changed&&(n=s.changed,s.changed=!0,w(s),t=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+s.id&&(t.push({id:e.id,changed:e.changed}),e._def.color=s.color,e.changed=!0,e.dirty=!0,p(e),w(e))}),RED.events.emit("subflows:change",s),RED.nodes.dirty(!0),e={t:"edit",node:s,changes:o.changes,dirty:i,changed:n,subflow:{instances:t}},RED.history.push(e)),s.dirty=!0,RED.tray.close()}}],resize:function(e){$(".red-ui-tray-content").height(e.height-50);var e=$(".red-ui-tray-content form").height(e.height-50-40),t={width:e.width(),height:e.height()};d.forEach(function(e){e.resize&&e.resize.call(e,t)})},open:function(e,t){var o=e.find(".red-ui-tray-footer"),i=$("<div/>",{class:"red-ui-tray-footer-left"}).appendTo(o),n=e.find(".red-ui-tray-body");n.parent().css("overflow","hidden"),$('<span style="margin-left: 10px"><i class="fa fa-info-circle"></i> <i id="red-ui-editor-subflow-user-count"></i></span>').appendTo(i),s&&RED.sidebar.info.refresh(s);E(n,["editor-tab-properties","editor-tab-subflow-module","editor-tab-description","editor-tab-appearance"],a,a._def,"node-input",r,function(e){d=e,$("#subflow-input-name").val(a.name),RED.text.bidi.prepareInput($("#subflow-input-name")),n.i18n(),o.i18n(),c=!1,t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(s),RED.workspaces.refresh(),d.forEach(function(e){e.close&&e.close.call(e)}),l.pop(),s=null},show:function(){}},RED.tray.show(e))},editGroup:function(n,a){var i,r,e;c||(c=!0,i=n,l.push(n),RED.view.state(RED.state.EDITING),r=[],e={title:D(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e,t={changes:{},changed:!1,outputMap:null},o=RED.nodes.dirty();h(i,t),r.forEach(function(e){e.apply&&e.apply.call(e,t)}),t.changed&&(e=i.changed,i.changed=!0,RED.nodes.dirty(!0),o={t:"edit",node:i,changes:t.changes,dirty:o,changed:e},RED.history.push(o),RED.events.emit("groups:change",i)),i.dirty=!0,RED.tray.close(),RED.view.redraw(!0)}}],resize:function(e){u.group=e.width,$(".red-ui-tray-content").height(e.height-50);var e=$(".red-ui-tray-content form").height(e.height-50-40),t={width:e.width(),height:e.height()};r.forEach(function(e){e.resize&&e.resize.call(e,t)})},open:function(e,t){var o=e.find(".red-ui-tray-footer"),i=($("<div/>",{class:"red-ui-tray-footer-left"}).appendTo(o),e.find(".red-ui-tray-body"));i.parent().css("overflow","hidden");E(i,["editor-tab-properties","editor-tab-envProperties","editor-tab-description"],n,n._def,"node-input",a,function(e){r=e,i.i18n(),c=!1,t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(i),r.forEach(function(e){e.close&&e.close.call(e)}),l.pop(),i=null},show:function(){}},u.hasOwnProperty("group")&&(e.width=u.group),RED.tray.show(e))},editJavaScript:function(e){t("_js",e)},editExpression:function(e){t("_expression",e)},editJSON:function(e){t("_json",e)},editMarkdown:function(e){t("_markdown",e)},editText:function(e){"markdown"==e.mode?t("_markdown",e):t("_text",e)},editBuffer:function(e){t("_buffer",e)},buildEditForm:function(e,t,o,a,i){return(t=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e)).html($("script[data-template-name='"+o+"']").html()),a=a||"node-red",t.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var o,i,n=e[t];-1===n.indexOf(":")&&(i="",0===n.indexOf("[")&&(i=(o=n.split("]"))[0]+"]",n=o[1]),e[t]=i+a+":"+n)}$(this).attr("data-i18n",e.join(";"))}),$('<span style="position: absolute; top: -2000px;"><input id="red-ui-trap-password" type="password"/></span>').prependTo(t),$('<span style="position: absolute; top: -2000px;"><input id="red-ui-trap-username"  type="text"/></span>').prependTo(t),$('<span style="position: absolute; top: -2000px;"><input id="red-ui-trap-user"  type="text"/></span>').prependTo(t),t.on("submit",function(e){e.preventDefault()}),t.find("input").attr("autocomplete","off"),t},validateNode:w,updateNodeProperties:p,showIconPicker:function(){RED.editor.iconPicker.show.apply(null,arguments)},showTypeEditor:t,registerTypeEditor:function(e,t){o[e]=t},createEditor:function(e){return RED.editor.codeEditor.create(e)},get customEditTypes(){return o},registerEditPane:function(e,t,o){o&&(m[e]=o),b[e]=t}}}(),function(){function w(e,t,o,i){var n,a=$("<div>",{class:"red-ui-editor-node-label-form-row"});return void 0===e?($("<span>").text(RED._("editor.noDefaultLabel")).appendTo(a),a.addClass("red-ui-editor-node-label-form-none")):(a.addClass(""),e="red-ui-editor-node-label-form-"+e+"-"+t,$("<label>",{for:e}).text(t+1+".").appendTo(a),n=$("<input>",{type:"text",id:e,placeholder:i}).val(o).appendTo(a),$('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-times"></i></button>').appendTo(a).on("click",function(e){e.preventDefault(),n.val("")})),a}RED.editor.registerEditPane("editor-tab-appearance",function(y){return{label:RED._("editor-tab.appearance"),name:RED._("editor-tab.appearance"),iconClass:"fa fa-object-group",create:function(e){this.content=e;var t,o,i,n,a,c,u,r,e=this.content,s=y,e=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),d=("subflow"===s.type&&(i=$("<div/>",{class:"form-row"}).appendTo(e),$("<label/>",{for:"subflow-appearance-input-category","data-i18n":"editor:subflow.category"}).appendTo(i),o=$("<select/>",{id:"subflow-appearance-input-category"}).css({width:"250px"}).appendTo(i),$("<input/>",{type:"text",id:"subflow-appearance-input-custom-category"}).css({display:"none","margin-left":"10px",width:"calc(100% - 250px)"}).appendTo(i),(i=RED.palette.getCategories()).sort(function(e,t){return e.label.localeCompare(t.label)}),i.forEach(function(e){o.append($("<option/>").val(e.id).text(e.label))}),o.append($("<option/>").attr("disabled",!0).text("---")),o.append($("<option/>").val("_custom_").text(RED._("palette.addCategory"))),$("#subflow-appearance-input-category").on("change",function(){"_custom_"===$(this).val()?($("#subflow-appearance-input-category").width(120),$("#subflow-appearance-input-custom-category").show()):($("#subflow-appearance-input-category").width(250),$("#subflow-appearance-input-custom-category").hide())}),$("#subflow-appearance-input-category").val(s.category||"subflows"),s.id,$("#red-ui-editor-subflow-user-count").text(RED._("subflow.subflowInstances",{count:s.instances.length})).show()),$('<div class="form-row"><label for="node-input-show-label-btn" data-i18n="editor.label"></label><span style="margin-right: 2px;"/><input type="checkbox" id="node-input-show-label"/></div>').appendTo(e),$("#node-input-show-label").toggleButton({enabledLabel:RED._("editor.show"),disabledLabel:RED._("editor.hide")}),s.hasOwnProperty("l")||(s.l=!s._def.hasOwnProperty("showLabel")||s._def.showLabel),$("#node-input-show-label").prop("checked",s.l).trigger("change"),"subflow"===s.type&&(i=s.color||"#DDAA99",l=$("<div/>",{class:"form-row"}).appendTo(e),$("<label/>").text(RED._("editor.color")).appendTo(l),RED.editor.colorPicker.create({id:"red-ui-editor-node-color",value:i,palette:["#DDAA99","#3FADB5","#87A980","#A6BBCF","#AAAA66","#C0C0C0","#C0DEED","#C7E9C0","#D7D7A0","#D8BFD8","#DAC4B4","#DEB887","#DEBD5C","#E2D96E","#E6E0F8","#E7E7AE","#E9967A","#F3B567","#FDD0A2","#FDF0C2","#FFAAAA","#FFCC66","#FFF0F0","#FFFFFF"],sortPalette:function(e,t){return e.l-t.l}}).appendTo(l),$("#red-ui-editor-node-color").on("change",function(e){var t=$(this).val(),o=(a.css("backgroundColor",t),RED.utils.getDarkerColor(t));o!==t&&a.css("border-color",o)})),s._def.defaults&&s._def.defaults.hasOwnProperty("icon")||(i=$('<div class="form-row"></div>').appendTo(e),$('<label data-i18n="editor.settingIcon">').appendTo(i),n=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(i),$('<i class="fa fa-caret-down"></i>').appendTo(n),a=$("<div>",{class:"red-ui-search-result-node"}).appendTo(n),l=RED.utils.getNodeColor(s.type,s._def),c=RED.utils.getNodeIcon(s._def,s),a.css("backgroundColor",l),(u=RED.utils.getDarkerColor(l))!==l&&a.css("border-color",u),r=$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(a),RED.utils.createIconElement(c,r,!0),n.on("click",function(e){e.preventDefault();var e=$("#red-ui-editor-node-icon").val()||"",e=e?RED.utils.separateIconPath(e):RED.utils.getDefaultNodeIcon(s._def,s),t=RED.utils.getNodeColor(s.type,s._def);"subflow"===s.type&&(t=$("#red-ui-editor-node-color").val()),RED.editor.iconPicker.show(n,t,e,!1,function(e){$("#red-ui-editor-node-icon").val(e||"");e=RED.utils.getNodeIcon(s._def,{type:s.type,icon:e});RED.utils.createIconElement(e,r,!0)})}),RED.popover.tooltip(n,function(){return $("#red-ui-editor-node-icon").val()||RED._("editor.default")}),$('<input type="hidden" id="red-ui-editor-node-icon">').val(s.icon).appendTo(i)),$('<div class="form-row"><span data-i18n="editor.portLabels"></span></div>').appendTo(e),s.inputs||s._def.inputs||0),p=s.outputs||s._def.outputs||0,f=("subflow"===s.type&&(d=s.in.length,p=s.out.length),s.inputLabels||[]),h=s.outputLabels||[],g=s._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),m=s._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),b=($('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelInputs"></span><div id="red-ui-editor-node-label-form-inputs"></div></div>').appendTo(e),$("#red-ui-editor-node-label-form-inputs"));if(0<d)for(t=0;t<d;t++)w("input",t,f[t],g).appendTo(b);else w().appendTo(b);$('<div class="form-row"><span style="margin-left: 50px;" data-i18n="editor.labelOutputs"></span><div id="red-ui-editor-node-label-form-outputs"></div></div>').appendTo(e);var l,v=$("#red-ui-editor-node-label-form-outputs");if(0<p)for(t=0;t<p;t++)w("output",t,h[t],m).appendTo(v);else w().appendTo(v);"subflow"===y.type?this.defaultIcon="node-red/subflow.svg":(l=RED.utils.getDefaultNodeIcon(y._def,y),this.defaultIcon=l.module+"/"+l.file,y.icon&&y.icon!==this.defaultIcon?this.isDefaultIcon=!1:this.isDefaultIcon=!0)},resize:function(e){},close:function(){},show:function(){this.content;var e,t=y,c=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),u=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),p=$("#red-ui-editor-node-label-form-inputs"),o=$("#red-ui-editor-node-label-form-outputs"),i=$("#node-input-inputs").val();void 0===i?e="subflow"===t.type?t.in.length:t.inputs||t._def.inputs||0:(e=Math.min(1,Math.max(0,parseInt(i))),isNaN(e)&&(e=0));var n,a,r,s,d=p.children(),l=d.length;if(1===l&&$(d[0]).hasClass("red-ui-editor-node-label-form-none")&&l--,l<e)for(0===l&&$(d[0]).remove(),a=l;a<e;a++)w("input",a,"",c).appendTo(p);else if(e<l){for(a=e;a<l;a++)$(d[a]).remove();0===e&&w().appendTo(p)}if(void 0===(i=$("#node-input-outputs").val())?"subflow"===t.type?n=t.out.length:e=t.outputs||t._def.outputs||0:isNaN(i)?(r=JSON.parse(i),t=Object.keys(r),d=o.children(),1===(l=d.length)&&$(d[0]).hasClass("red-ui-editor-node-label-form-none")&&l--,n=0,s=[],t.forEach(function(e){var t=$("#red-ui-editor-node-label-form-output-"+e).parent();0===t.length&&-1!==r[e]?(0===l&&($(d[0]).remove(),l=-1),t=w("output",e,"",u)):t.detach(),-1!==r[e]&&(n++,s.push({i:parseInt(r[e]),r:t}))}),s.sort(function(e,t){return e.i-t.i}),s.forEach(function(e,t){e.r.find("label").text(t+1+"."),e.r.appendTo(o)}),0===s.length&&w("output",a,"").appendTo(o)):n=Math.max(0,parseInt(i)),d=o.children(),1===(l=d.length)&&$(d[0]).hasClass("red-ui-editor-node-label-form-none")&&l--,l<n)for(0===l&&$(d[0]).remove(),a=l;a<n;a++)w("output",a,"").appendTo(o);else if(n<l){for(a=n;a<l;a++)$(d[a]).remove();0===n&&w().appendTo(o)}},apply:function(e){!function(o,e,i){var t=$("#red-ui-editor-node-label-form-inputs").children().find("input"),n=$("#red-ui-editor-node-label-form-outputs").children().find("input"),a=!1,r=!1,s=t.map(function(){var e=$(this).val();return a=a||""!==e,e}).toArray().slice(0,o.inputs);(void 0===o.inputLabels&&a||void 0!==o.inputLabels&&JSON.stringify(s)!==JSON.stringify(o.inputLabels))&&(e.inputLabels=o.inputLabels,o.inputLabels=s,r=!0);a=!1,s=new Array(o.outputs),n.each(function(){var e,t=$(this).attr("id").substring("red-ui-editor-node-label-form-output-".length);i&&i.hasOwnProperty(t)&&-1===(t=parseInt(i[t]))||(e=$(this).val(),a=a||""!==e,"subflow"!==o.type||o.outputLabels&&o.outputLabels[t]===e||(o.out[t].dirty=!0),s[t]=e)}),(void 0===o.outputLabels&&a||void 0!==o.outputLabels&&JSON.stringify(s)!==JSON.stringify(o.outputLabels))&&(e.outputLabels=o.outputLabels,o.outputLabels=s,r=!0,"subflow"===o.type&&RED.view.redraw());return r}(y,e.changes,e.outputMap)||(e.changed=!0),y._def.defaults&&y._def.defaults.hasOwnProperty("icon")||(t=$("#red-ui-editor-node-icon").val()||"",this.isDefaultIcon?""!==t&&t!==this.defaultIcon?(e.changes.icon=y.icon,y.icon=t,e.changed=!0):(o=(o=RED.utils.getDefaultNodeIcon(y._def,y)).module+"/"+o.file,this.defaultIcon!==o&&(e.changes.icon=y.icon,y.icon=o,e.changed=!0)):t!==y.icon&&""!==t&&(e.changes.icon=y.icon,y.icon=t,e.changed=!0)),"subflow"===y.type&&((o="subflows"===(o="_custom_"===(o=$("#subflow-appearance-input-category").val().trim())&&""===(o=$("#subflow-appearance-input-custom-category").val().trim())?y.category:o)?"":o)!=y.category&&(e.changes.category=y.category,y.category=o,e.changed=!0),y.color!==(t=$("#red-ui-editor-node-color").val())&&(e.changes.color=y.color,y.color=t,e.changed=!0,RED.utils.clearNodeColorCache(),"subflow"===y.type&&(RED.nodes.getType("subflow:"+y.id).color=t)));var t,o=!y._def.hasOwnProperty("showLabel")||y._def.showLabel;$("#node-input-show-label").prop("checked")?o?(y.hasOwnProperty("l")&&!y.l&&(e.changes.l=y.l,e.changed=!0),delete y.l):(y.l||(e.changes.l=y.l,e.changed=!0),y.l=!0):o?(!1!==y.l&&(e.changes.l=y.l,e.changed=!0),y.l=!1):(y.hasOwnProperty("l")&&y.l&&(e.changes.l=y.l,e.changed=!0),delete y.l)}}})}(),RED.editor.registerEditPane("editor-tab-description",function(i){return{label:RED._("editor-tab.description"),name:RED._("editor-tab.description"),iconClass:"fa fa-file-text-o",create:function(e){this.editor=function(e,t){var e=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),e=($("<div></div>").appendTo(e),$('<div class="form-row node-text-editor-row" style="position:relative; padding-top: 4px; height: 100%"></div>').appendTo(e)),o="node-info-input-info-editor-"+Math.floor(1e3*Math.random()),e=($('<div style="height: 100%" class="node-text-editor" id="'+o+'" ></div>').appendTo(e),RED.editor.createEditor({id:o,mode:"ace/mode/markdown",value:""}));t.info&&e.getSession().setValue(t.info,-1);return t.infoEditor=e}(e,i),RED.e=this.editor},resize:function(e){this.editor.resize()},close:function(){this.editor.destroy(),this.editor=null},show:function(){this.editor.focus()},apply:function(e){var t=i.info,o=this.editor.getValue();t?""===o.trim()?(e.changed=!0,e.changes.info=t,delete i.info):o!==t&&(e.changed=!0,e.changes.info=t,i.info=o):""!==o.trim()&&(e.changed=!0,e.changes.info=void 0,i.info=o)}}}),RED.editor.registerEditPane("editor-tab-envProperties",function(n){return{label:RED._("editor-tab.envProperties"),name:RED._("editor-tab.envProperties"),iconClass:"fa fa-list",create:function(e){e=$('<form class="dialog-form form-horizontal"></form>').appendTo(e),e=$('<div class="form-row node-input-env-container-row"></div>').appendTo(e);this.list=$("<ol></ol>").appendTo(e),RED.editor.envVarList.create(this.list,n)},resize:function(e){this.list.editableList("height",e.height)},close:function(){},apply:function(t){var e,o=n.env,i=[];/^subflow:/.test(n.type)&&(i=RED.subflow.exportSubflowInstanceEnv(n)),this.list.editableList("items").each(function(e,t){var o,t=t.data("data");t.nameField&&t.valueField&&""!==(o={name:t.nameField.val(),value:t.valueField.typedInput("value"),type:t.valueField.typedInput("type")}).name.trim()&&i.push(o)}),i&&0<i.length&&i.forEach(function(e){"cred"===e.type&&(n.credentials=n.credentials||{_:{}},n.credentials[e.name]=e.value,n.credentials["has_"+e.name]=""!==e.value,"__PWRD__"!==e.value&&(t.changed=!0),delete e.value)}),o||0!==i.length?(e=i,JSON.stringify(o)!==JSON.stringify(e)&&(t.changes.env=n.env,0===i.length?delete n.env:n.env=i,t.changed=!0)):delete n.env}}}),RED.editor.registerEditPane("editor-tab-flow-properties",function(o){return{label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),iconClass:"fa fa-cog",create:function(e){e=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(e);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>').appendTo(e),$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="min-height:150px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(e);this.tabflowEditor=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$('<input type="text" style="display: none;" />').prependTo(e),e.on("submit",function(e){e.preventDefault()}),$("#node-input-name").val(o.label),RED.text.bidi.prepareInput($("#node-input-name")),this.tabflowEditor.getSession().setValue(o.info||"",-1)},resize:function(e){$("#node-input-info").css("height",e.height-70+"px"),this.tabflowEditor.resize()},close:function(){this.tabflowEditor.destroy()},apply:function(e){var t=$("#node-input-name").val(),t=(o.label!=t&&(e.changes.label=o.label,e.changed=!0,o.label=t),this.tabflowEditor.getValue());o.info!==t&&(e.changes.info=o.info,e.changed=!0,o.info=t),$("#red-ui-tab-"+o.id.replace(".","-")).toggleClass("red-ui-workspace-disabled",!!o.disabled),$("#red-ui-workspace").toggleClass("red-ui-workspace-disabled",!!o.disabled)}}}),RED.editor.registerEditPane("editor-tab-properties",function(d){return{label:RED._("editor-tab.properties"),name:RED._("editor-tab.properties"),iconClass:"fa fa-cog",create:function(e){var t,o=d.type,i=("subflow"===d.type?o="subflow-template":"subflow:"==d.type.substring(0,8)&&(o="subflow"),t="node-red"===d._def.set.module?"node-red":d._def.set.id,"dialog-form");this.inputClass="node-input","config"===d._def.category&&"group"!==o&&(this.inputClass="node-config-input",i="node-config-dialog-edit-form"),RED.editor.buildEditForm(e,i,o,t,d)},resize:function(e){if(d&&d._def.oneditresize)try{d._def.oneditresize.call(d,e)}catch(e){console.log("oneditresize",d.id,d.type,e.toString())}},close:function(){},apply:function(t){var e,o,i;if(d._def.defaults)for(o in d._def.defaults)if(d._def.defaults.hasOwnProperty(o)){var n,a,r,s=$("#"+this.inputClass+"-"+o);if("checkbox"===s.attr("type")?e=s.prop("checked"):"select"===s.prop("nodeName")&&"multiple"===s.attr("multiple")?null==(e=s.val())&&(e=[]):e="format"in d._def.defaults[o]&&""!==d._def.defaults[o].format&&"DIV"===s[0].nodeName?s.text():s.val(),null!=e){if("outputs"===o){if(""===e.trim())continue;isNaN(e)?(t.outputMap=JSON.parse(e),n=0,a=!1,Object.keys(t.outputMap).forEach(function(e){isNaN(e)?(n++,delete t.outputMap[e]):(t.outputMap[e]=t.outputMap[e]+"","-1"!==t.outputMap[e]?(n++,t.outputMap[e]!==e?a=!0:delete t.outputMap[e]):a=!0)}),e=n,a&&(t.changed=!0)):e=parseInt(e)}d._def.defaults[o].type&&"_ADD_"==e&&(e=""),d[o]!=e&&(d._def.defaults[o].type&&((s=RED.nodes.node(d[o]))&&((r=s.users).splice(r.indexOf(d),1),RED.events.emit("nodes:change",s)),(s=RED.nodes.node(e))&&(s.users.push(d),RED.events.emit("nodes:change",s))),t.changes[o]=d[o],d[o]=e,t.changed=!0)}}d._def.credentials&&(i=d._def.credentials,i=function(e,t,o){var i,n=!1;e.credentials?e.credentials._||(e.credentials._={}):e.credentials={_:{}};for(i in t)if(t.hasOwnProperty(i)){var a=$("#"+o+"-"+i);if(0<a.length){a=a.val();if("password"==t[i].type){if(e.credentials["has_"+i]=""!==a,"__PWRD__"==a)continue;n=!0}(e.credentials[i]=a)!=e.credentials._[i]&&(n=!0)}}return n}(d,i,this.inputClass),t.changed=t.changed||i)}}}),function(){function i(t,o){var i;t.on("change keyup paste",function(){i=i||setTimeout(function(){var e=o(t.val());t.toggleClass("input-error",!!e),i=null})})}RED.editor.registerEditPane("editor-tab-subflow-module",function(n){return{label:RED._("editor-tab.module"),name:RED._("editor-tab.module"),iconClass:"fa fa-cube",create:function(e){var t=n,o=($('<form class="dialog-form form-horizontal" autocomplete="off"><div class="form-row"><label for="subflow-input-module-module" data-i18n="[append]editor:subflow.module"><i class="fa fa-cube"></i> </label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-module" data-i18n="[placeholder]common.label.name"></div><div class="form-row"><label for="subflow-input-module-type" data-i18n="[append]editor:subflow.type"> </label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-type"></div><div class="form-row"><label for="subflow-input-module-version" data-i18n="[append]editor:subflow.version"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-version" data-i18n="[placeholder]editor:subflow.versionPlaceholder"></div><div class="form-row"><label for="subflow-input-module-desc" data-i18n="[append]editor:subflow.desc"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-desc"></div><div class="form-row"><label for="subflow-input-module-license" data-i18n="[append]editor:subflow.license"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-license"></div><div class="form-row"><label for="subflow-input-module-author" data-i18n="[append]editor:subflow.author"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-author" data-i18n="[placeholder]editor:subflow.authorPlaceholder"></div><div class="form-row"><label for="subflow-input-module-keywords" data-i18n="[append]editor:subflow.keys"></label><input style="width: calc(100% - 110px)" type="text" id="subflow-input-module-keywords" data-i18n="[placeholder]editor:subflow.keysPlaceholder"></div></form>').appendTo(e),t.meta||{});["module","type","version","author","desc","keywords","license"].forEach(function(e){$("#subflow-input-module-"+e).val(o[e]||"")}),$("#subflow-input-module-type").attr("placeholder",t.id),i($("#subflow-input-module-module"),function(e){var t=(e=e.trim()).length<215;return t=(t=t&&!/^[._]/.test(e))&&!/[A-Z]/.test(e),(t=e!==encodeURIComponent(e)?!!(e=/^@([^\/]+)\/([^\/]+)$/.exec(e))&&(t&&e[1]===encodeURIComponent(e[1])&&e[2]===encodeURIComponent(e[2])):t)?"":"Invalid module name"}),i($("#subflow-input-module-version"),function(e){return""===(e=e.trim())||/^(\d|[1-9]\d*)\.(\d|[1-9]\d*)\.(\d|[1-9]\d*)(-(0|[1-9A-Za-z-][0-9A-Za-z-]*|[0-9]*[A-Za-z-][0-9A-Za-z-]*)(\.(0|[1-9A-Za-z-][0-9A-Za-z-]*|[0-9]*[A-Za-z-][0-9A-Za-z-]*))*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$/.test(e)?"":"Invalid version number"}),(t={types:(e=["none","Apache-2.0","BSD-3-Clause","BSD-2-Clause","GPL-2.0","GPL-3.0","MIT","MPL-2.0","CDDL-1.0","EPL-2.0"]).map(function(e){return{value:e,label:"none"===e?RED._("editor:subflow.licenseNone"):e,hasValue:!1}})}).types.push({value:"_custom_",label:RED._("editor:subflow.licenseOther"),icon:"red/images/typedInput/az.svg"}),o.license?-1<e.indexOf(o.license)?t.default=o.license:t.default="_custom_":t.default="none",$("#subflow-input-module-license").typedInput(t)},resize:function(e){},close:function(){},apply:function(e){var t,o,i=function(){var t,o={},e=(["module","type","version","author","desc","keywords"].forEach(function(e){(t=$("#subflow-input-module-"+e).val().trim())&&(o[e]=t)}),$("#subflow-input-module-license").typedInput("type"));"_custom_"===e?(t=$("#subflow-input-module-license").val())&&(o.license=t):"none"!==e&&(o.license=e);return o}();t=n.meta,o=i,JSON.stringify(t)!==JSON.stringify(o)&&(e.changes.meta=n.meta,n.meta=i,e.changed=!0)}}})}(),RED.editor.registerTypeEditor("_buffer",{show:function(e){var s,n,a=e.value,t=e.complete,r=(0===$("script[data-template-name='_buffer']").length&&$('<script type="text/x-red" data-template-name="_buffer"><div id="red-ui-editor-type-buffer-panels"><div id="red-ui-editor-type-buffer-panel-str" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button class="red-ui-editor-type-buffer-type red-ui-button red-ui-button-small"><i class="fa fa-exclamation-circle"></i> <span id="red-ui-editor-type-buffer-type-string" data-i18n="bufferEditor.modeString"></span><span id="red-ui-editor-type-buffer-type-array" data-i18n="bufferEditor.modeArray"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="red-ui-editor-type-buffer-str"></div></div></div><div id="red-ui-editor-type-buffer-panel-bin" class="red-ui-panel"><div class="form-row node-text-editor-row" style="margin-top: 10px; margin-bottom:0;"><div class="node-text-editor" id="red-ui-editor-type-buffer-bin"></div></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING),[]),o={title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){t(JSON.stringify(s)),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();n&&n.resize(t)},open:function(e){e.find(".red-ui-tray-body");function i(e){for(var t=!0,o="string"==typeof e,i=[],n=0,a=(s=o?function(e){for(var t=[],o=0,i=e.length,o=0;o<i;o++){var n=e.charCodeAt(o);n<128?t.push(n):(n<2048?t.push(192|n>>6):(n<55296||57344<=n?t.push(224|n>>12):(o++,n=65536+((1023&n)<<10|1023&e.charAt(o)),t.push(240|n>>18),t.push(128|n>>12&63)),t.push(128|n>>6&63)),t.push(128|63&n))}return t}(e):e).length,n=0;n<a;n++){var r=parseInt(s[n]);if(!o&&(isNaN(r)||r<0||255<r)){t=!1;break}0<n&&(n%8==0?n%16==0?i.push("\n"):i.push("  "):i.push(" ")),i.push((r<16?"0":"")+r.toString(16).toUpperCase())}return t&&($("#red-ui-editor-type-buffer-type-string").toggle(o),$("#red-ui-editor-type-buffer-type-array").toggle(!o),bufferBinEditor.setValue(i.join(""),1)),t}function t(){var e=r.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var o=JSON.parse(e),t=i(o)}catch(e){t=!1}}t||i(e)}var o,e=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_buffer","editor");(r=RED.editor.createEditor({id:"red-ui-editor-type-buffer-str",value:"",mode:"ace/mode/text"})).getSession().setValue(a||"",-1),bufferBinEditor=RED.editor.createEditor({id:"red-ui-editor-type-buffer-bin",value:"",mode:"ace/mode/text",readOnly:!0});r.getSession().on("change",function(){clearTimeout(o),o=setTimeout(t,200)}),t(),e.i18n(),n=RED.panels.create({id:"red-ui-editor-type-buffer-panels",resize:function(e,t){var o=$("#red-ui-editor-type-buffer-panel-str"),o=(e-=$(o.children()[0]).outerHeight(!0),$(o.children()[1])),e=(e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#red-ui-editor-type-buffer-str").css("height",e-5+"px"),r.resize(),$("#red-ui-editor-type-buffer-panel-bin")),o=$(e.children()[0]);t-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#red-ui-editor-type-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".red-ui-editor-type-buffer-type").on("click",function(e){e.preventDefault(),RED.sidebar.help.set(RED._("bufferEditor.modeDesc"))})},close:function(){e.onclose&&e.onclose(),r.destroy(),bufferBinEditor.destroy()},show:function(){}};RED.tray.show(o)}}),RED.editor.codeEditor=function(){const o="monaco",e={lib:"ace",options:{}};var i=null,n=!1;return{init:function(){var t=RED.editor.codeEditor.settings.lib===o?o:"ace";try{var e=RED.utils.getBrowserInfo();(i=RED.editor.codeEditor[t])&&(t!=o||!e.ie&&window.monaco)||(i=RED.editor.codeEditor.ace),n=i.init()}catch(e){i=null,console.warn("Problem initialising '"+t+"' code editor",e)}n||(i=RED.editor.codeEditor.ace,n=i.init())},get settings(){return RED.settings.get("codeEditor")||e},get editor(){return i},create:function(e){return e||(console.warn("createEditor() options are missing"),e={}),this.editor.type===o&&(e.element||e.id||(e.id="node-backwards-compatability-dummy-editor"),e.element=e.element||$("#"+e.id)[0],e.element||(console.warn("createEditor() options.element or options.id is not valid",e),$("#dialog-form").append('<div id="'+e.id+'" style="display: none;" />'))),this.editor.create(e)}}}(),RED.editor.colorPicker=RED.colorPicker={create:function(c){function u(e){var t,o;"none"===e?(n.addClass("red-ui-color-picker-cell-none").css({"background-color":"",opacity:1}),i.css({"border-color":""})):(t=parseFloat(m.val()),n.removeClass("red-ui-color-picker-cell-none").css({"background-color":e,opacity:t}),"#"===(o=RED.utils.getDarkerColor(e))[0]?o+=Math.round(255*Math.floor(100*t)/100).toString(16):o="",i.css({"border-color":o})),c.hasOwnProperty("opacity")&&$(".red-ui-color-picker-opacity-slider-overlay").css({"background-image":"linear-gradient(90deg, transparent 0%, "+e+" 100%)"})}var t=c.value,o=c.id,v=c.palette||[],p=c.cellWidth||30,f=c.cellHeight||30,h=c.cellMargin||2,y=c.cellPerRow||6,e=$("<div>",{style:"display:inline-block"}),g=$("<input/>",{id:o,type:"hidden",value:t}).appendTo(e),m=$("<input/>",{id:o+"-opacity",type:"hidden",value:c.hasOwnProperty("opacity")?c.opacity:"1"}).appendTo(e),b=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(e),i=($('<i class="fa fa-caret-down"></i>').appendTo(b),$("<div>",{class:"red-ui-search-result-node"}).appendTo(b)),n=($("<div>",{class:"red-ui-color-picker-cell-none"}).appendTo(i),$("<div>",{class:"red-ui-color-picker-swatch"}).appendTo(i));return b.on("click",function(l){var t,o,i,e=v.length,n=$("<div/>",{class:"red-ui-color-picker"}).css({width:(p+h+h)*y+"px",height:Math.ceil(e/y)*(f+h+h)+"+px"}),a=0,r=null,s=(r=$("<div/>").appendTo(n),$("<input>",{type:"text",value:g.val()}).appendTo(r)),e=s,d=(s.on("change",function(e){var t=s.val();g.val(t).trigger("change"),u(t)}),c.none&&(r=$("<div/>").appendTo(n),$("<button/>",{class:"red-ui-color-picker-cell red-ui-color-picker-cell-none"}).css({width:p+"px",height:f+"px",margin:h+"px"}).appendTo(r).on("click",function(e){e.preventDefault(),s.val("none"),s.trigger("change")})),v.forEach(function(t){a%y==0&&(r=$("<div/>").appendTo(n)),$("<button/>",{class:"red-ui-color-picker-cell"}).css({width:p+"px",height:f+"px",margin:h+"px",backgroundColor:t,"border-color":RED.utils.getDarkerColor(t)}).appendTo(r).on("click",function(e){e.preventDefault(),s.val(t),s.trigger("change")}),a++}),(c.none||c.hasOwnProperty("opacity"))&&(r=$("<div/>").appendTo(n),c.hasOwnProperty("opacity")&&((t=$("<div>",{class:"red-ui-color-picker-opacity-slider"}).appendTo(r)).on("mousedown",function(e){e.target!==o[0]&&(e=e.offsetX/t.width(),o.css({left:e*(t.width()-o.outerWidth())+"px"}),e=Math.floor(100*e),m.val(e/100),i.text(e+"%"),u(g.val()))}),$("<div>",{class:"red-ui-color-picker-opacity-slider-overlay"}).appendTo(t),o=$("<div>",{class:"red-ui-color-picker-opacity-slider-handle red-ui-button red-ui-button-small"}).appendTo(t).draggable({containment:"parent",axis:"x",drag:function(e,t){t=Math.max(0,t.position.left/($(this).parent().width()-$(this).outerWidth())),t=Math.floor(100*t);m.val((t=99===t?100:t)/100),i.text(t+"%"),u(g.val())}}),i=$("<small></small>").appendTo(r),setTimeout(function(){o.css({left:parseFloat(m.val())*(t.width()-o.outerWidth())+"px"}),i.text(Math.floor(100*m.val())+"%")},50))),RED.popover.panel(n));setTimeout(function(){u(g.val())},50),d.show({target:b,onclose:function(){b.focus()}}),e&&e.focus()}),setTimeout(function(){u(g.val())},50),e}},RED.editor.envVarList=function(){var E="en-US",D=["str","num","bool","json","bin","env"],R=["str","num","bool","json","bin","env","cred"];function x(e,t,o){if(e){if(e[o])return e[o];if(o){o=o.substring(0,2);if(e[o])return e[o]}}return t}return{create:function(v,y){var e,w="subflow"===y.type,o=(v.css({"min-height":"150px","min-width":"450px"}).editableList({header:w?$('<div><div><div></div><div data-i18n="common.label.name"></div><div data-i18n="editor-tab.defaultValue"></div><div></div></div></div>'):void 0,addItem:function(t,c,o){w&&t.addClass("red-ui-editor-subflow-env-editable");var u,r,i,p,n,a,f,h,g,s,e=$("<div/>").appendTo(t),m=null,d=null,m=$("<input/>",{class:"node-input-env-name",type:"text",placeholder:RED._("common.label.name")}).attr("autocomplete","disable").appendTo(e).val(o.name),l=((d=$("<input/>",{style:"width:100%",class:"node-input-env-value",type:"text"}).attr("autocomplete","disable").appendTo(e)).typedInput({default:"str",types:w?D:R}),d.typedInput("type",o.type),"cred"!==o.type||o.value?d.typedInput("value",o.value):y.credentials&&y.credentials[o.name]?d.typedInput("value",y.credentials[o.name]):y.credentials&&y.credentials["has_"+o.name]?d.typedInput("value","__PWRD__"):d.typedInput("value",""),o.nameField=m,o.valueField=d,$("<a/>",{href:"#",class:"red-ui-editableList-item-remove red-ui-button red-ui-button-small"}).appendTo(e)),b=($("<i/>",{class:"fa "+(o.parent?"fa-reply":"fa-remove")}).appendTo(l),RED.popover.tooltip(l,RED._("subflow.env.remove")));l.on("click",function(e){e.preventDefault(),b.close(),t.parent().addClass("red-ui-editableList-item-deleting"),t.fadeOut(300,function(){v.editableList("removeItem",o)})}),w&&("cred"===o.type?(o.ui=o.ui||{icon:"",type:"cred"},o.ui.type="cred"):o.ui=o.ui||{icon:"",type:"input",opts:{types:D}},o.ui.label=o.ui.label||{},o.ui.type=o.ui.type||"input",u=$("<div/>").appendTo(t).hide(),$('<a href="#"><i class="fa fa-angle-right"></a>').prependTo(e).on("click",function(e){e.preventDefault(),$(this).hasClass("expanded")?(u.slideUp(),$(this).removeClass("expanded")):(u.slideDown(),$(this).addClass("expanded"))}),l=u,r=o.ui,e=m,i=d,l.addClass("red-ui-editor-subflow-env-ui-row"),d=$("<div></div>").appendTo(l),$("<div></div>").appendTo(d),$("<div>").text(RED._("editor.icon")).appendTo(d),$("<div>").text(RED._("editor.label")).appendTo(d),$("<div>").text(RED._("editor.inputType")).appendTo(d),d=$("<div></div>").appendTo(l),$('<div><i class="red-ui-editableList-item-handle fa fa-bars"></i></div>').appendTo(d),p={input:{types:D},select:{opts:[]},spinner:{},cred:{}},r.opts?p[r.type]=r.opts:r.opts=p[r.type],l=$("<div></div>").appendTo(d),(n=$('<a href="#"></a>').appendTo(l)).on("click",function(e){e.preventDefault();e=r.icon||"",e=e?RED.utils.separateIconPath(e):{};RED.editor.iconPicker.show(n,null,e,!0,function(e){n.empty();var e=e||"",t=RED.utils.separateIconPath(e);t&&$('<i class="fa"></i>').addClass(t.file).appendTo(n),r.icon=e})}),r.icon&&(l=RED.utils.separateIconPath(r.icon),$('<i class="fa '+l.file+'"></i>').appendTo(n)),l=$("<div></div>").appendTo(d),g=r.label&&r.label[E]||"",h=$('<input type="text">').val(g).appendTo(l),(r.labelField=h).on("change",function(e){r.label=r.label||{};var t=$(this).val().trim();""===t?delete r.label[E]:r.label[E]=t}),g=$('<span class="red-ui-editor-subflow-env-lang-icon"><i class="fa fa-language"></i></span>').appendTo(l),RED.popover.tooltip(g,function(){var e=Object.keys(r.label),o=$("<div>");return-1===e.indexOf(E)&&(e.push(E),e.sort()),e.forEach(function(e){var t=$("<div>").appendTo(o);$("<span>").css({display:"inline-block",width:"120px"}).text(RED._("languages."+e)+(e===E?"*":"")).appendTo(t),$("<span>").text(r.label[e]||"").appendTo(t)}),o}),e.on("change",function(e){h.attr("placeholder",$(this).val())}),l=$("<div></div>").appendTo(d),s=$('<input type="text">').css("width","100%").appendTo(l),"input"===r.type&&s.val(r.opts.types.join(",")),s.typedInput({types:[{value:"input",label:RED._("editor.inputs.input"),icon:"fa fa-i-cursor",showLabel:!1,multiple:!0,options:[{value:"str",label:RED._("editor.types.str"),icon:"red/images/typedInput/az.svg"},{value:"num",label:RED._("editor.types.num"),icon:"red/images/typedInput/09.svg"},{value:"bool",label:RED._("editor.types.bool"),icon:"red/images/typedInput/bool.svg"},{value:"json",label:RED._("editor.types.json"),icon:"red/images/typedInput/json.svg"},{value:"bin",label:RED._("editor.types.bin"),icon:"red/images/typedInput/bin.svg"},{value:"env",label:RED._("editor.types.env"),icon:"red/images/typedInput/env.svg"},{value:"cred",label:RED._("editor.types.cred"),icon:"fa fa-lock"}],default:D,valueLabel:function(e,t){e.css("padding",0);var e=$('<div class="red-ui-editor-subflow-env-input-type"></div>').appendTo(e),o=$('<div class="placeholder-input">').appendTo(e);$('<span><i class="fa fa-i-cursor"></i></span>').appendTo(o),t.length?t.forEach(function(e){var t;/^fa /.test(e.icon)?(t=$("<span>",{style:"max-width:14px; padding: 0 3px; margin-top:-4px; margin-left: 1px"}).appendTo(o),$("<i>",{class:e.icon}).appendTo(t)):$("<img>",{src:e.icon,style:"max-width:14px; padding: 0 3px; margin-top:-4px; margin-left: 1px"}).appendTo(o)}):$('<span class="red-ui-editor-subflow-env-input-type-placeholder"></span>').text(RED._("editor.selectType")).appendTo(o)}},{value:"cred",label:RED._("typedInput.type.cred"),icon:"fa fa-lock",showLabel:!1,valueLabel:function(e,t){e.css("padding",0);e=$('<div class="red-ui-editor-subflow-env-input-type">').css({"border-top-right-radius":"4px","border-bottom-right-radius":"4px"}).appendTo(e);$('<div class="placeholder-input">').html("&bull;&bull;&bull;&bull;&bull;&bull;&bull;&bull;").appendTo(e)}},{value:"select",label:RED._("editor.inputs.select"),icon:"fa fa-tasks",showLabel:!1,valueLabel:function(e,t){e.css("padding","0"),f=$("<select></select>").appendTo(e),r.opts&&Array.isArray(r.opts.opts)&&r.opts.opts.forEach(function(e){var t=x(e.l,e.l["en-US"]||e.v,E);$("<option>").val(e.v).text(t).appendTo(f)}),f.on("change",function(e){var t=f.val();i.typedInput("value",t)}),f.val(i.typedInput("value"))},expand:{icon:"fa-caret-down",minWidth:400,content:function(e){var e=$('<div class="red-ui-editor-subflow-ui-edit-panel">').appendTo(e),a=$("<ol>").appendTo(e).editableList({header:$("<div><div>"+RED._("editor.select.label")+"</div><div>"+RED._("editor.select.value")+"</div></div>"),addItem:function(e,t,i){var o=$("<div>").appendTo(e),n=x(i.l,"",E),n=(i.label=$('<input type="text">').val(n).appendTo(o),i.label.on("keydown",function(e){13===e.keyCode&&(i.input.focus(),e.preventDefault())}),$('<span class="red-ui-editor-subflow-env-lang-icon"><i class="fa fa-language"></i></span>').appendTo(o));RED.popover.tooltip(n,function(){return E}),i.input=$('<input type="text">').val(i.v).appendTo(e),i.input.on("keydown",function(e){var t,o;13===e.keyCode&&((o=a.editableList("indexOf",i))+1===a.editableList("length")?(t={},a.editableList("addItem",t),setTimeout(function(){t.label&&t.label.focus()},100)):(o=a.editableList("getItemAt",o+1)).label&&o.label.focus(),e.preventDefault())})},sortable:!0,removable:!0,height:160});return 0<r.opts.opts.length?r.opts.opts.forEach(function(e){a.editableList("addItem",$.extend(!0,{},e))}):a.editableList("addItem",{}),{onclose:function(){var e=a.editableList("items"),n=[];e.each(function(e,t){var t=t.data("data"),o=t.label.val().trim(),i=t.input.val();0<o.length&&(t.l=t.l||{},t.l[E]=o),t.v=i,(0<o.length||0<i.length)&&(o={l:t.l,v:t.v},n.push(o))}),r.opts.opts=n,s.typedInput("value",Date.now())}}}}},{value:"checkbox",label:RED._("editor.inputs.checkbox"),icon:"fa fa-check-square-o",showLabel:!1,valueLabel:function(e,t){e.css("padding",0),(a=$('<input type="checkbox">').appendTo(e)).on("change",function(e){i.typedInput("value",$(this).prop("checked")?"true":"false")}),a.prop("checked","true"===i.typedInput("value"))}},{value:"spinner",label:RED._("editor.inputs.spinner"),icon:"fa fa-sort-numeric-asc",showLabel:!1,valueLabel:function(e,t){e.css("padding",0);var e=$('<div class="red-ui-editor-subflow-env-input-type"></div>').appendTo(e),e=$('<div class="placeholder-input">').appendTo(e),o=($('<span><i class="fa fa-sort-numeric-asc"></i></span>').appendTo(e),r.opts&&r.opts.min),i=r.opts&&r.opts.max,n="";void 0!==o&&void 0!==i?n=Math.min(o,i)+" - "+Math.max(o,i):void 0!==o?n="> "+o:void 0!==i&&(n="< "+i),$("<span>").css("margin-left","15px").text(n).appendTo(e)},expand:{icon:"fa-caret-down",content:function(e){var e=$('<div class="red-ui-editor-subflow-ui-edit-panel">').appendTo(e),t=(e.css("padding","8px 5px"),r.opts.min),o=r.opts.max,i=$('<input type="number" style="margin-bottom:0; width:60px">'),n=(i.val(t),$('<input type="number" style="margin-bottom:0; width:60px">'));return n.val(o),$('<div class="form-row" style="margin-bottom:3px"><label>'+RED._("editor.spinner.min")+"</label></div>").append(i).appendTo(e),$('<div class="form-row" style="margin-bottom:0"><label>'+RED._("editor.spinner.max")+"</label></div>").append(n).appendTo(e),{onclose:function(){var e=i.val().trim(),t=n.val().trim();""!==e?r.opts.min=parseInt(e):delete r.opts.min,""!==t?r.opts.max=parseInt(t):delete r.opts.max,s.typedInput("value",Date.now())}}}}},{value:"none",label:RED._("editor.inputs.none"),icon:"fa fa-times",hasValue:!1},{value:"hide",label:RED._("editor.inputs.hidden"),icon:"fa fa-ban",hasValue:!1}],default:"none"}).on("typedinputtypechange",function(e,t){switch(r.type=$(this).typedInput("type"),r.opts=p[r.type],"input"===r.type?s.typedInput("value",r.opts.types.join(",")):s.typedInput("value",Date.now()),r.type){case"input":i.typedInput("types",r.opts.types);break;case"select":i.typedInput("types",["str"]);break;case"checkbox":i.typedInput("types",["bool"]);break;case"spinner":i.typedInput("types",["num"]);break;case"cred":i.typedInput("types",["cred"]);break;default:i.typedInput("types",D)}"checkbox"===r.type?i.typedInput("type","bool"):"spinner"===r.type&&i.typedInput("type","num"),"checkbox"!==r.type&&(a=null)}).on("change",function(e,t){var o;"input"===r.type&&(o=s.typedInput("value"),r.opts.types=""===o?["str"]:o.split(","),i.typedInput("types",r.opts.types))}),i.on("change",function(e){a&&a.prop("checked","true"===$(this).typedInput("value"))}),s.typedInput("type",r.type),m.trigger("change"))},sortable:".red-ui-editableList-item-handle",removable:!1}),{}),i=[];if(!/^subflow:/.test(y.type)||(e=RED.nodes.subflow(y.type.substring(8))).env&&e.env.forEach(function(e){var t={name:e.name,parent:{type:e.type,value:e.value,ui:e.ui}};i.push(t),o[e.name]=t}),y.env)for(var t=0;t<y.env.length;t++){var n=y.env[t];o.hasOwnProperty(n.name)?(o[n.name].type=n.type,o[n.name].value=n.value):i.push({name:n.name,type:n.type,value:n.value,ui:n.ui})}i.forEach(function(e){e.parent&&e.parent.ui&&"hide"===e.parent.ui.type||!w&&e.parent||v.editableList("addItem",JSON.parse(JSON.stringify(e)))})},setLocale:function(e,t){E=e,t&&t.editableList("items").each(function(e,t){var o=$(this).data("data"),i=o.ui.labelField;i.val(x(o.ui.label,"",E)),i.timeout&&(clearTimeout(i.timeout),delete i.timeout),i.addClass("input-updated"),i.timeout=setTimeout(function(){delete i.timeout,i.removeClass("input-updated")},3e3)})},lookupLabel:x,DEFAULT_ENV_TYPE_LIST:D,DEFAULT_ENV_TYPE_LIST_INC_CRED:R}}(),function(){var s={};RED.editor.registerTypeEditor("_expression",{show:function(e){var p,d,f,i,n=e.parent||"_",a=e.value,t=e.complete,r=(0===$("script[data-template-name='_expression']").length&&$('<script type="text/x-red" data-template-name="_expression"><div id="red-ui-editor-type-expression-panels"><div id="red-ui-editor-type-expression-panel-expr" class="red-ui-panel"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button class="red-ui-editor-type-expression-legacy red-ui-button red-ui-button-small"><i class="fa fa-exclamation-circle"></i> <span data-i18n="expressionEditor.compatMode"></span></button><button id="red-ui-editor-type-expression-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="expressionEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div class="node-text-editor" id="red-ui-editor-type-expression"></div></div></div><div id="red-ui-editor-type-expression-panel-info" class="red-ui-panel"><div class="form-row"><ul id="red-ui-editor-type-expression-tabs"></ul><div id="red-ui-editor-type-expression-tab-help" class="red-ui-editor-type-expression-tab-content hide"><div><select id="red-ui-editor-type-expression-func"></select><button id="red-ui-editor-type-expression-func-insert" class="red-ui-button" data-i18n="expressionEditor.insert"></button></div><div id="red-ui-editor-type-expression-help"></div></div><div id="red-ui-editor-type-expression-tab-test" class="red-ui-editor-type-expression-tab-content hide"><div><span style="display: inline-block; width: calc(50% - 5px);"><span data-i18n="expressionEditor.data"></span><button style="float: right; margin-right: 5px;" id="node-input-example-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="jsonEditor.format"></span></button></span><span style="display: inline-block; margin-left: 10px; width: calc(50% - 5px);" data-i18n="expressionEditor.result"></span></div><div style="display: inline-block; width: calc(50% - 5px);" class="node-text-editor" id="red-ui-editor-type-expression-test-data"></div><div style="display: inline-block; margin-left: 10px;  width:calc(50% - 5px);" class="node-text-editor" id="red-ui-editor-type-expression-test-result"></div></div></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING),{title:e.title,width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#red-ui-editor-type-expression-help").text(""),t(p.getValue()),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").height();i&&i.resize(t)},open:function(e){function t(){var e,t,o=d.getValue(),i=p.getValue(),n=!1,a=/(^|[^a-zA-Z0-9_'".])msg([^a-zA-Z0-9_'"]|$)/.test(i);$(".red-ui-editor-type-expression-legacy").toggle(a);try{(t=jsonata(i)).assign("flowContext",function(e){return n=!0,null}),t.assign("globalContext",function(e){return n=!0,null})}catch(e){return void f.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(o)}catch(e){return void f.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var r,s=t.evaluate(a?{msg:e}:e);if(n)return void f.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);r=void 0!==s?JSON.stringify(s,null,4):RED._("expressionEditor.noMatch"),f.setValue(r,-1)}catch(e){f.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}}e.find(".red-ui-tray-body").addClass("red-ui-editor-type-expression");var o,e=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_expression","editor"),l=$("#red-ui-editor-type-expression-func"),c=(Object.keys(jsonata.functions).forEach(function(e){l.append($("<option></option>").val(e).text(e))}),l.on("change",function(e){var t=$(this).val(),o="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",t=RED.utils.renderMarkdown(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#red-ui-editor-type-expression-help").html(o+"<p>"+t+"</p>")}),p=RED.editor.createEditor({id:"red-ui-editor-type-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}}),null),u=-1,e=(p.getSession().setValue(a||"",-1),"ace"==p.type&&p.on("changeSelection",function(){var e=p.getCursorPosition(),t=p.getSession().getTokenAt(e.row,e.column);if(t!==c||t&&/paren/.test(t.type)&&e.column!==u){var o,i=null;if((c=t)&&"keyword"===t.type)o=e.row,i=t;else for(var n=0,a=!1,r=t?("paren.rparen"===t.type&&(u=e.column,n=e.column-(t.start+t.value.length)),o=e.row,t.index):(o=e.row-1,-1);null===i&&-1<o;){var s=p.getSession().getTokens(o);for(-1===r&&(r=s.length-1);-1<r;){var d=s[r].type;if(a){if("keyword"===d){i=s[r];break}a=!1}"paren.lparen"===d?n-=s[r].value.length:"paren.rparen"===d&&(n+=s[r].value.length),n<0&&(a=!0,n=0),r--}i||o--}p.session.removeMarker(null),i&&l.val(i.value).trigger("change")}}),e.i18n(),$("#red-ui-editor-type-expression-func-insert").on("click",function(e){e.preventDefault();p.getCursorPosition();e=l.val(),e=jsonata.getFunctionSnippet(e);p.insertSnippet(e),p.focus()}),$("#red-ui-editor-type-expression-reformat").on("click",function(e){e.preventDefault();e=p.getValue()||"";try{e=jsonata.format(e)}catch(e){}p.getSession().setValue(e||"",-1)}),l.change(),RED.tabs.create({element:$("#red-ui-editor-type-expression-tabs"),onchange:function(e){$(".red-ui-editor-type-expression-tab-content").hide(),e.content.show(),r.resize()}}));e.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#red-ui-editor-type-expression-tab-help")}),e.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#red-ui-editor-type-expression-tab-test")}),d=RED.editor.createEditor({id:"red-ui-editor-type-expression-test-data",value:s[n]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1}),$(".red-ui-editor-type-expression-legacy").on("click",function(e){e.preventDefault(),RED.sidebar.help.set(RED._("expressionEditor.compatModeDesc"))});d.getSession().on("change",function(){clearTimeout(o),o=setTimeout(t,200),s[n]=d.getValue()}),p.getSession().on("change",function(){clearTimeout(o),o=setTimeout(t,200)}),f=RED.editor.createEditor({id:"red-ui-editor-type-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),i=RED.panels.create({id:"red-ui-editor-type-expression-panels",resize:function(e,t){var o=$("#red-ui-editor-type-expression-panel-expr"),o=(e-=$(o.children()[0]).outerHeight(!0),$(o.children()[1]));e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#red-ui-editor-type-expression").css("height",e-5+"px"),p.resize(),t-=$("#red-ui-editor-type-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".red-ui-editor-type-expression-tab-content").height(t),$("#red-ui-editor-type-expression-test-data").css("height",t-25+"px"),d.resize(),$("#red-ui-editor-type-expression-test-result").css("height",t-25+"px"),f.resize()}}),$("#node-input-example-reformat").on("click",function(e){e.preventDefault();e=d.getValue()||"";try{e=JSON.stringify(JSON.parse(e),null,4)}catch(e){}d.getSession().setValue(e||"",-1)}),t()},close:function(){e.onclose&&e.onclose(),p.destroy(),d.destroy(),f.destroy()},show:function(){}});RED.tray.show(r)}})}(),RED.editor.iconPicker={show:function(e,r,s,i,d){var t=$('<div class="red-ui-icon-picker">'),o=$("<div>",{class:"red-ui-search-container"}).appendTo(t),l=(searchInput=$('<input type="text">').attr("placeholder",RED._("editor.searchIcons")).appendTo(o).searchBox({delay:50,change:function(){var o=$(this).val().trim();""===o?(l.find(".red-ui-icon-list-module").show(),l.find(".red-ui-icon-list-icon").show()):(l.find(".red-ui-icon-list-module").hide(),l.find(".red-ui-icon-list-icon").each(function(e,t){-1===$(t).data("icon").indexOf(o)?$(t).hide():$(t).show()}))}}),$("<div>").appendTo(t),$('<div class="red-ui-icon-list">').appendTo(t)),o=$('<div class="red-ui-icon-meta"></div>').appendTo(t),c=$("<span>").appendTo(o),n=($('<button type="button" class="red-ui-button red-ui-button-small">'+RED._("editor.useDefault")+"</button>").appendTo(o).on("click",function(e){e.preventDefault(),u.hide(),d(null)}),!r&&i&&l.addClass("red-ui-icon-list-dark"),setTimeout(function(){var o=RED.nodes.getIconSets();Object.keys(o).forEach(function(a){var e,t;i&&"font-awesome"!==a||0<(e=o[a]).length&&(t=$('<div class="red-ui-icon-list-module"></div>').text(a).appendTo(l),$('<i class="fa fa-cube"></i>').prependTo(t),e.forEach(function(e){var t=$("<div>",{class:"red-ui-icon-list-icon"}).appendTo(l),o=$("<div>",{class:"red-ui-search-result-node"}).appendTo(t),i=RED.settings.apiRootUrl+"icons/"+a+"/"+e,n=(t.data("icon",i),r&&(o.css({backgroundColor:r}),(n=RED.utils.getDarkerColor(r))!==r&&o.css("border-color",n)),$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(o));RED.utils.createIconElement(i,n,!0),s.module===a&&s.file===e&&t.addClass("selected"),t.on("mouseover",function(){c.text(e)}),t.on("mouseout",function(){c.html("&nbsp;")}),t.on("click",function(){u.hide(),d(a+"/"+e)})}))}),setTimeout(function(){n.remove()},50)},300),RED.utils.addSpinnerOverlay(l,!0)),u=RED.popover.panel(t);u.show({target:e}),t.slideDown(100),searchInput.trigger("focus")}},RED.editor.registerTypeEditor("_js",{show:function(t){var n,o=t.value,e=t.complete,i=(0===$("script[data-template-name='_js']").length&&$('<script type="text/x-red" data-template-name="_js"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-js"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING),{title:t.title,width:t.width||"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e(n.getValue(),n.getCursorPosition()),RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<t.size();i++)o-=$(t[i]).outerHeight(!0);$(".node-text-editor").css("height",o+"px"),n.resize()},open:function(e){e.find(".red-ui-tray-body");e=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_js","editor");n=RED.editor.createEditor({id:"node-input-js",mode:t.mode||"ace/mode/javascript",value:o,globals:{msg:!0,context:!0,RED:!0,util:!0,flow:!0,global:!0,console:!0,Buffer:!0,setTimeout:!0,clearTimeout:!0,setInterval:!0,clearInterval:!0},extraLibs:t.extraLibs}),t.cursor&&n.gotoLine(t.cursor.row+1,t.cursor.column,!1),e.i18n(),setTimeout(function(){n.focus()},300)},close:function(){n.destroy(),t.onclose&&t.onclose()},show:function(){}});RED.tray.show(i)}}),function(){var u;function f(e,t,o){var i="";if(0<e.children.length)switch(e.children[Math.max(0,Math.min(e.children.length-1,o))].type){case"string":i="";break;case"number":i=0;break;case"boolean":i=!0;break;case"null":i=null;break;case"object":i={};break;case"array":i=[]}if("array"===e.type)r=e.children.length;else for(var n={},a=(e.children.forEach(function(e){n[e.key]=!0}),2),r="item";n[r];)r="item-"+a++;o=h(r,i,e.depth+1,e);e.treeList.insertChildAt(o,t,!0),e.treeList.expand()}function h(e,t,o,c){var u,n,a,i,r,s={depth:o,type:typeof t},p=$('<span class="red-ui-editor-type-json-editor-label">'),d=(null!=e&&(u="string"==typeof(s.key=e)?'"'+e+'"':e,(n=$('<span class="red-ui-debug-msg-object-key red-ui-editor-type-json-editor-label-key">').text(u).appendTo(p)).addClass("red-ui-debug-msg-type-"+typeof e),c&&"array"===c.type&&n.addClass("red-ui-editor-type-json-editor-label-array-key"),n.on("click",function(e){var i;"array"!==s.parent.type&&(e.preventDefault(),e.stopPropagation(),e=Math.max(150,n.width()),i=$('<input type="text" class="red-ui-editor-type-json-editor-key">').css({width:e+"px"}).val(""+s.key).insertAfter(n).typedInput({types:["str"]}),$(document).on("mousedown.nr-ui-json-editor",function(e){for(var t=i.next(".red-ui-typedInput-container")[0],o=e.target;"BODY"!==o.nodeName&&o!==t&&!$(o).hasClass("red-ui-typedInput-options");)o=o.parentElement;"BODY"===o.nodeName&&(e=i.typedInput("value"),s.key=e,n.text("string"==typeof e?'"'+e+'"':e),i.remove(),n.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor"))}),$(document).on("keydown.nr-ui-json-editor",function(e){27===e.keyCode&&(i.remove(),n.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor"))}),n.hide())}),$("<span>").text(" : ").appendTo(p)),Array.isArray(t)?(s.expanded=o<2,s.type="array",s.deferBuild=2<=o,s.children=function(e,t,o){for(var i=[],n=e.length,a=0;a<n;a++)i.push(h(a,e[a],t,o));return i}(t,o+1,s)):null!==t&&"object"===s.type?(s.expanded=o<2,s.children=function(e,t,o){var i,n=[];for(i in e)e.hasOwnProperty(i)&&n.push(h(i,e[i],t,o));return n}(t,o+1,s),s.deferBuild=2<=o):null===(s.value=t)&&(s.type="null"),"");switch(s.type){case"string":a="str",d='"'+s.value+'"',i="red-ui-debug-msg-type-string";break;case"number":a="num",d=s.value,i="red-ui-debug-msg-type-number";break;case"boolean":a="bool",d=s.value,i="red-ui-debug-msg-type-other";break;case"null":a=s.type,d=s.type,i="red-ui-debug-msg-type-null";break;case"object":a=s.type,d=s.type,i="red-ui-debug-msg-type-meta";break;case"array":a=s.type,d=s.type+"["+s.children.length+"]",i="red-ui-debug-msg-type-meta"}var l=$('<span class="red-ui-editor-type-json-editor-label-value">').addClass(i).text(d).appendTo(p);return l.on("click",function(e){e.preventDefault(),e.stopPropagation(),"str"===a?d=d.substring(1,d.length-1):"array"!==a&&"object"!==a||(d="");var e=Math.max(150,l.width()),n=$('<input type="text" class="red-ui-editor-type-json-editor-value">').css({width:e+"px"}).val(""+d).insertAfter(l).typedInput({types:["str","num","bool",{value:"null",label:RED._("common.type.null"),hasValue:!1},{value:"array",label:RED._("common.type.array"),hasValue:!1,icon:"red/images/typedInput/json.png"},{value:"object",label:RED._("common.type.object"),hasValue:!1,icon:"red/images/typedInput/json.png"}],default:a});$(document).on("mousedown.nr-ui-json-editor",function(e){for(var t,o=n.next(".red-ui-typedInput-container")[0],i=e.target;"BODY"!==i.nodeName&&i!==o&&!$(i).hasClass("red-ui-typedInput-options");)i=i.parentElement;if("BODY"===i.nodeName){switch(a=n.typedInput("type"),d=n.typedInput("value"),"num"===a&&(d=d.trim(),isNaN(d)?a="str":""===d&&(d=0)),s.value=d,a){case"str":s.children&&(r=s.children),s.treeList.makeLeaf(!0),s.type="string",t="red-ui-debug-msg-type-string",d='"'+d+'"';break;case"num":s.children&&(r=s.children),s.treeList.makeLeaf(!0),s.type="number",t="red-ui-debug-msg-type-number";break;case"bool":s.children&&(r=s.children),s.treeList.makeLeaf(!0),s.type="boolean",t="red-ui-debug-msg-type-other",s.value="true"===d;break;case"null":s.children&&(r=s.children),s.treeList.makeLeaf(!0),s.type="null",t="red-ui-debug-msg-type-null",s.value=d="null";break;case"object":s.treeList.makeParent(r),s.type="object",t="red-ui-debug-msg-type-meta",s.value=d="object",s.children.forEach(function(e,t){var o,i;e.hasOwnProperty("_key")&&(e.key=e._key,delete e._key,(i=e.element.find(".red-ui-editor-type-json-editor-label-key")).removeClass("red-ui-editor-type-json-editor-label-array-key"),"string"==typeof e.key?(o='"'+e.key+'"',i.addClass("red-ui-debug-msg-type-string"),i.removeClass("red-ui-debug-msg-type-number")):(o=e.key,i.removeClass("red-ui-debug-msg-type-string"),i.addClass("red-ui-debug-msg-type-number")),i.text(o))});break;case"array":s.treeList.makeParent(r),s.type="array",t="red-ui-debug-msg-type-meta",s.value=d="array["+s.children.length+"]",s.children.forEach(function(e,t){e._key=e.key,e.key=t,e.element.find(".red-ui-editor-type-json-editor-label-key").addClass("red-ui-editor-type-json-editor-label-array-key").text(""+e.key).removeClass("red-ui-debug-msg-type-string").addClass("red-ui-debug-msg-type-number")})}l.text(d).removeClass().addClass("red-ui-editor-type-json-editor-label-value "+t),n.remove(),l.show(),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor")}}),$(document).on("keydown.nr-ui-json-editor",function(e){27===e.keyCode&&(n.remove(),l.show(),"str"===a&&(d='"'+d+'"'),$(document).off("mousedown.nr-ui-json-editor"),$(document).off("keydown.nr-ui-json-editor"))}),l.hide()}),s.gutter=$('<span class="red-ui-editor-type-json-editor-item-gutter"></span>'),(c?$('<span class="red-ui-editor-type-json-editor-item-handle"><i class="fa fa-bars"></span>'):$("<span></span>")).appendTo(s.gutter),$('<button type="button" class="editor-button editor-button-small"><i class="fa fa-caret-down"></button>').appendTo(s.gutter).on("click",function(e){e.preventDefault(),e.stopPropagation();var e=$(this),r=s,e=e.offset(),t=[],o=(r.parent&&(t.push({id:"red-ui-editor-type-json-menu-insert-above",icon:"fa fa-toggle-up",label:RED._("jsonEditor.insertAbove"),onselect:function(){var e=r.parent.children.indexOf(r);f(r.parent,e,e)}}),t.push({id:"red-ui-editor-type-json-menu-insert-below",icon:"fa fa-toggle-down",label:RED._("jsonEditor.insertBelow"),onselect:function(){var e=r.parent.children.indexOf(r)+1;f(r.parent,e,e-1)}})),"array"!==r.type&&"object"!==r.type||t.push({id:"red-ui-editor-type-json-menu-add-child",icon:"fa fa-plus",label:RED._("jsonEditor.addItem"),onselect:function(){f(r,r.children.length,r.children.length-1)}}),r.parent&&(t.push({id:"red-ui-editor-type-json-menu-copy-path",icon:"fa fa-terminal",label:RED._("jsonEditor.copyPath"),onselect:function(){for(var e=r,t="";e.parent;)t=("array"===e.parent.type?"["+e.key+"]":/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(e.key)?e.key:'["'+e.key.replace(/"/,'\\"')+'"]')+(0<t.length&&"["!==t[0]?".":"")+t,e=e.parent;RED.clipboard.copyText(t,r.element,"clipboard.copyMessagePath")}}),t.push({id:"red-ui-editor-type-json-menu-duplicate",icon:"fa fa-copy",label:RED._("jsonEditor.duplicate"),onselect:function(){var e=r.key;if("array"===r.parent.type)e=r.parent.children.length;else{var t=/^(.*?)(-(\d+))?$/.exec(e),o={},i=(r.parent.children.forEach(function(e){o[e.key]=!0}),t[1]),n=2;for(void 0!==t[3]&&(n=parseInt(t[3])),e=i;o[e];)e=i+"-"+n++}var t=h(e,g(r),r.parent.depth+1,r.parent),a=r.parent.children.indexOf(r)+1;r.parent.treeList.insertChildAt(t,a,!0),r.parent.treeList.expand()}}),t.push({id:"red-ui-editor-type-json-menu-delete",icon:"fa fa-times",label:RED._("common.label.delete"),onselect:function(){r.treeList.remove()}})),"array"!==r.type&&"object"!==r.type||(t.push(null),t.push({id:"red-ui-editor-type-json-menu-expand-children",icon:"fa fa-angle-double-down",label:RED._("jsonEditor.expandItems"),onselect:function(){r.treeList.expand(),r.children.forEach(function(e){e.treeList.expand()})}}),t.push({id:"red-ui-editor-type-json-menu-collapse-children",icon:"fa fa-angle-double-up",label:RED._("jsonEditor.collapseItems"),onselect:function(){r.treeList.collapse(),r.children.forEach(function(e){e.treeList.collapse()})}})),(t=RED.menu.init({id:"red-ui-editor-type-json-menu",options:t})).css({position:"absolute"}),t.on("mouseleave",function(){$(this).hide()}),t.on("mouseup",function(){$(this).hide()}),t.appendTo("body"),e.top),i=t.height(),n=$(window).height();n<o+i&&(o-=o+i-n+20),t.css({top:o+"px",left:e.left+"px"}),t.show()}),s.element=p,s}function g(e){var t;switch(e.type){case"string":t=e.value;break;case"number":t=Number(e.value);break;case"boolean":t=e.value;break;case"null":t=null;break;case"object":t={},e.children.forEach(function(e){t[e.key]=g(e)});break;case"array":t=e.children.map(g)}return t}RED.editor.registerTypeEditor("_json",{show:function(o){function a(){var e=r.getValue();try{return JSON.parse(e),$("#node-dialog-ok").removeClass("disabled"),!0}catch(e){return $("#node-dialog-ok").addClass("disabled"),!1}}var r,s,d,l=o.value,t=o.complete,c=(0===$("script[data-template-name='_json']").length&&$('<script type="text/x-red" data-template-name="_json"><ul id="red-ui-editor-type-json-tabs"></ul><div id="red-ui-editor-type-json-tab-raw" class="red-ui-editor-type-json-tab-content hide"><div class="form-row" style="margin-bottom: 3px; text-align: right;"><button id="node-input-json-reformat" class="red-ui-button red-ui-button-small"><span data-i18n="jsonEditor.format"></span></button></div><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-json"></div></div></div><div id="red-ui-editor-type-json-tab-ui" class="red-ui-editor-type-json-tab-content hide"><div id="red-ui-editor-type-json-tab-ui-container"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING),{title:o.title,width:o.width||700,buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e;o.requireValid&&!a()||("json-ui"===u?e=d?JSON.stringify(g(d),null,4):r.getValue():"json-raw"===u&&(e=r.getValue()),t&&t(e),RED.tray.close())}}],resize:function(e){var t=$(".red-ui-editor-type-json-tab-content").height();$(".node-text-editor").css("height",t-45+"px"),r.resize()},open:function(e){e.find(".red-ui-tray-body");var e=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_json","editor"),t=$("#red-ui-editor-type-json-tab-ui-container").css({height:"100%"}),i=$('<div class="red-ui-debug-msg-payload red-ui-editor-type-json-editor">').appendTo(t).treeList({rootSortable:!1,sortable:".red-ui-editor-type-json-editor-item-handle"}).on("treelistchangeparent",function(e,t){"array"===t.old.type&&t.old.element.find(".red-ui-editor-type-json-editor-label-type").text("array["+t.old.children.length+"]"),"array"===t.item.parent.type&&t.item.parent.element.find(".red-ui-editor-type-json-editor-label-type").text("array["+t.item.parent.children.length+"]")}).on("treelistsort",function(e,o){o.children.forEach(function(e,t){"array"===o.type?(e.key=t,e.element.find(".red-ui-editor-type-json-editor-label-key").text(e.key).removeClass("red-ui-debug-msg-type-string").addClass("red-ui-debug-msg-type-number")):e.element.find(".red-ui-editor-type-json-editor-label-key").text('"'+e.key+'"').removeClass("red-ui-debug-msg-type-number").addClass("red-ui-debug-msg-type-string")})}),n=((r=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"})).getSession().setValue(l||"",-1),o.requireValid&&(r.getSession().on("change",function(){clearTimeout(s),s=setTimeout(a,200)}),a()),$("#node-input-json-reformat").on("click",function(e){e.preventDefault();e=r.getValue()||"";try{e=JSON.stringify(JSON.parse(e),null,4)}catch(e){}r.getSession().setValue(e||"",-1)}),e.i18n(),!1),t=RED.tabs.create({element:$("#red-ui-editor-type-json-tabs"),onchange:function(e){if(u=e.id,$(".red-ui-editor-type-json-tab-content").hide(),n)if("json-raw"===e.id)d&&(t=JSON.stringify(g(d),null,4),r.getSession().setValue(t||"",-1));else if("json-ui"===e.id){var t=r.getValue().trim()||"{}";try{var o=JSON.parse(t);(d=h(null,o,0,null)).class="red-ui-editor-type-json-root-node",i.treeList("data",[d])}catch(e){d=null,i.treeList("data",[{label:RED._("jsonEditor.error.invalidJSON")+e.toString()}])}}e.content.show(),c.resize()}});t.addTab({id:"json-raw",label:RED._("jsonEditor.rawMode"),content:$("#red-ui-editor-type-json-tab-raw")}),t.addTab({id:"json-ui",label:RED._("jsonEditor.uiMode"),content:$("#red-ui-editor-type-json-tab-ui")}),n=!0},close:function(){o.onclose&&o.onclose(),r.destroy()},show:function(){}});RED.tray.show(c)}})}(),function(){var r;RED.editor.registerTypeEditor("_markdown",{show:function(i){var n,a=i.value,e=i.complete,t=(0===$("script[data-template-name='_markdown']").length&&$('<script type="text/x-red" data-template-name="_markdown"><div id="red-ui-editor-type-markdown-panels"><div id="red-ui-editor-type-markdown-panel-editor" class="red-ui-panel"><div style="height: 100%; margin: auto;"><div id="red-ui-editor-type-markdown-toolbar"></div><div class="node-text-editor" style="height: 100%" id="red-ui-editor-type-markdown"></div></div></div><div class="red-ui-panel"><div class="red-ui-editor-type-markdown-panel-preview red-ui-help"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING),{title:i.title,width:i.width||1/0,buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e(n.getValue(),n.getCursorPosition()),RED.tray.close()}}],resize:function(e){var t=$("#dialog-form").width();r&&r.resize(t)},open:function(e){e.find(".red-ui-tray-body").addClass("red-ui-editor-type-markdown-editor");var t,o=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_markdown","editor");(n=RED.editor.createEditor({id:"red-ui-editor-type-markdown",value:a,mode:"ace/mode/markdown",expandable:!1})).getSession().on("change",function(){clearTimeout(t),t=setTimeout(function(){var e=$(".red-ui-editor-type-markdown-panel-preview").scrollTop();$(".red-ui-editor-type-markdown-panel-preview").html(RED.utils.renderMarkdown(n.getValue())),$(".red-ui-editor-type-markdown-panel-preview").scrollTop(e)},200)}),i.header&&i.header.appendTo(e.find("#red-ui-editor-type-markdown-title")),a&&$(".red-ui-editor-type-markdown-panel-preview").html(RED.utils.renderMarkdown(n.getValue())),(r=RED.panels.create({id:"red-ui-editor-type-markdown-panels",dir:"horizontal",resize:function(e,t){n.resize()}})).ratio(1),$('<span class="button-group" style="float:right"><button type="button" id="node-btn-markdown-preview" class="red-ui-button toggle single"><i class="fa fa-eye"></i></button></span>').appendTo(n.toolbar),$("#node-btn-markdown-preview").on("click",function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),r.ratio(1)):($(this).addClass("selected"),r.ratio(.5))}),RED.popover.tooltip($("#node-btn-markdown-preview"),RED._("markdownEditor.toggle-preview")),i.cursor&&n.gotoLine(i.cursor.row+1,i.cursor.column,!1),o.i18n()},close:function(){n.destroy(),i.onclose&&i.onclose()},show:function(){}});RED.tray.show(t)},buildToolbar:function(e,s){var t={h1:{newline:!0,before:"# ",tooltip:RED._("markdownEditor.heading1")},h2:{newline:!0,before:"## ",tooltip:RED._("markdownEditor.heading2")},h3:{newline:!0,before:"### ",tooltip:RED._("markdownEditor.heading3")},b:{before:"**",after:"**",tooltip:RED._("markdownEditor.bold")},i:{before:"_",after:"_",tooltip:RED._("markdownEditor.italic")},code:{before:"`",after:"`",tooltip:RED._("markdownEditor.code")},ol:{before:" * ",newline:!0,tooltip:RED._("markdownEditor.ordered-list")},ul:{before:" - ",newline:!0,tooltip:RED._("markdownEditor.unordered-list")},bq:{before:"> ",newline:!0,tooltip:RED._("markdownEditor.quote")},link:{before:"[",after:"]()",tooltip:RED._("markdownEditor.link")},hr:{before:"\n---\n\n",tooltip:RED._("markdownEditor.horizontal-rule")}},e=$('<div style="margin-bottom: 5px"><span class="button-group"><button type="button" class="red-ui-button" data-style="h1" style="font-size:1.1em; font-weight: bold">h1</button><button type="button" class="red-ui-button" data-style="h2" style="font-size:1.0em; font-weight: bold">h2</button><button type="button" class="red-ui-button" data-style="h3" style="font-size:0.9em; font-weight: bold">h3</button></span><span class="button-group"><button type="button" class="red-ui-button" data-style="b"><i class="fa fa-bold"></i></button><button type="button" class="red-ui-button" data-style="i"><i class="fa fa-italic"></i></button><button type="button" class="red-ui-button" data-style="code"><i class="fa fa-code"></i></button></span><span class="button-group"><button type="button" class="red-ui-button" data-style="ol"><i class="fa fa-list-ol"></i></button><button type="button" class="red-ui-button" data-style="ul"><i class="fa fa-list-ul"></i></button><button type="button" class="red-ui-button" data-style="bq"><i class="fa fa-quote-left"></i></button><button type="button" class="red-ui-button" data-style="hr"><i class="fa fa-minus"></i></button><button type="button" class="red-ui-button" data-style="link"><i class="fa fa-link"></i></button></span></div>').appendTo(e);return e.find("button[data-style]").each(function(e){var r=t[$(this).data("style")];$(this).on("click",function(e){e.preventDefault();var e=s.getSelectedText(),t=s.selection.getRange();if(r.newline)for(var o=0,i=((r.before||"").match(/\n/g)||[]).length,n=((r.after||"").match(/\n/g)||[]).length,a=t.start.row;a<=t.end.row+o;a++)r.before&&(s.session.insert({row:a,column:0},r.before),o+=i,a+=i),r.after&&(s.session.insert({row:a,column:1/0},r.after),o+=n,a+=n);else s.session.replace(s.selection.getRange(),(r.before||"")+e+(r.after||"")),""===e&&s.gotoLine(t.start.row+1,t.start.column+(r.before||"").length,!1);s.focus()}),r.tooltip&&RED.popover.tooltip($(this),r.tooltip)}),e}})}(),RED.editor.registerTypeEditor("_text",{show:function(t){var o,i=t.value,e=t.complete,n=(0===$("script[data-template-name='_text']").length&&$('<script type="text/x-red" data-template-name="_text"><div class="form-row node-text-editor-row"><div style="height: 200px;min-height: 150px;" class="node-text-editor" id="node-input-text"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.view.state(RED.state.EDITING),{title:t.title,width:t.width||"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){e(o.getValue(),o.getCursorPosition()),RED.tray.close()}}],resize:function(e){$("#dialog-form>div:not(.node-text-editor-row)"),$("#dialog-form>div.node-text-editor-row");var t=$("#dialog-form").height();$(".node-text-editor").css("height",t+"px"),o.resize()},open:function(e){e.find(".red-ui-tray-body"),RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_text","editor");(o=RED.editor.createEditor({id:"node-input-text",value:"",mode:"ace/mode/"+(t.mode||"text")})).getSession().setValue(i||"",-1),t.cursor&&o.gotoLine(t.cursor.row+1,t.cursor.column,!1)},close:function(){o.destroy(),t.onclose&&t.onclose()},show:function(){}});RED.tray.show(n)}}),RED.editor.codeEditor.ace=function(){var t=!1,r={};return{get type(){return"ace"},get initialised(){return t},init:function(e){return r=e||{},t=!0},create:function(e){var t=RED.editor.codeEditor.settings||{},o=e.element||$("#"+e.id)[0],i=$("<div>").appendTo(o),o=$("<div>").appendTo(o).addClass("red-ui-editor-text-container")[0],n=window.ace.edit(o),a=(n.setTheme(t.theme||r.theme||"ace/theme/tomorrow"),n.getSession());return a.on("changeAnnotation",function(){for(var e=a.getAnnotations()||[],t=e.length,o=e.length;t--;)(/doctype first\. Expected/.test(e[t].text)||/Unexpected End of file\. Expected/.test(e[t].text))&&e.splice(t,1);o>e.length&&a.setAnnotations(e)}),e.mode&&a.setMode(e.mode),e.foldStyle?a.setFoldStyle(e.foldStyle):a.setFoldStyle("markbeginend"),e.options?n.setOptions(e.options):n.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,tooltipFollowsMouse:!1}),e.readOnly&&(n.setOption("readOnly",e.readOnly),n.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&n.renderer.setOption("showGutter",e.lineNumbers),n.$blockScrolling=1/0,e.value&&a.setValue(e.value,-1),e.globals&&setTimeout(function(){a.$worker&&a.$worker.send("setOptions",[{globals:e.globals,maxerr:1e3}])},100),"ace/mode/markdown"===e.mode&&($(o).addClass("red-ui-editor-text-container-toolbar"),n.toolbar=RED.editor.customEditTypes._markdown.buildToolbar(i,n),!1!==e.expandable&&(t=$('<button type="button" class="red-ui-button" style="float: right;"><i class="fa fa-expand"></i></button>').appendTo(n.toolbar),RED.popover.tooltip(t,RED._("markdownEditor.expand")),t.on("click",function(e){e.preventDefault();e=n.getValue();RED.editor.editMarkdown({value:e,width:"Infinity",cursor:n.getCursorPosition(),complete:function(e,t){n.setValue(e,-1),n.gotoLine(t.row+1,t.column,!1),setTimeout(function(){n.focus()},300)}})})),t=$('<button type="button" class="red-ui-editor-text-help red-ui-button red-ui-button-small"><i class="fa fa-question"></i></button>').appendTo($(o).parent()),RED.popover.create({target:t,trigger:"click",size:"small",direction:"left",content:RED._("markdownEditor.format"),autoClose:50}),a.setUseWrapMode(!0)),n._destroy=n.destroy,n.destroy=function(){try{this._destroy()}catch(e){}$(o).remove(),$(i).remove()},n.type="ace",n}}}(),RED.editor.codeEditor.monaco=function(){var y=!1;const w=["vs","vs-dark","hc-black"];let E;const v={assert:{package:"node",module:"assert",path:"node/assert.d.ts"},async_hooks:{package:"node",module:"async_hooks",path:"node/async_hooks.d.ts"},buffer:{package:"node",module:"buffer",path:"node/buffer.d.ts"},child_process:{package:"node",module:"child_process",path:"node/child_process.d.ts"},cluster:{package:"node",module:"cluster",path:"node/cluster.d.ts"},console:{package:"node",module:"console",path:"node/console.d.ts"},constants:{package:"node",module:"constants",path:"node/constants.d.ts"},crypto:{package:"node",module:"crypto",path:"node/crypto.d.ts"},dgram:{package:"node",module:"dgram",path:"node/dgram.d.ts"},dns:{package:"node",module:"dns",path:"node/dns.d.ts"},domain:{package:"node",module:"domain",path:"node/domain.d.ts"},events:{package:"node",module:"events",path:"node/events.d.ts"},fs:{package:"node",module:"fs",path:"node/fs.d.ts"},globals:{package:"node",module:"globals",path:"node/globals.d.ts"},http:{package:"node",module:"http",path:"node/http.d.ts"},http2:{package:"node",module:"http2",path:"node/http2.d.ts"},https:{package:"node",module:"https",path:"node/https.d.ts"},module:{package:"node",module:"module",path:"node/module.d.ts"},net:{package:"node",module:"net",path:"node/net.d.ts"},os:{package:"node",module:"os",path:"node/os.d.ts"},path:{package:"node",module:"path",path:"node/path.d.ts"},perf_hooks:{package:"node",module:"perf_hooks",path:"node/perf_hooks.d.ts"},process:{package:"node",module:"process",path:"node/process.d.ts"},querystring:{package:"node",module:"querystring",path:"node/querystring.d.ts"},readline:{package:"node",module:"readline",path:"node/readline.d.ts"},stream:{package:"node",module:"stream",path:"node/stream.d.ts"},string_decoder:{package:"node",module:"string_decoder",path:"node/string_decoder.d.ts"},timers:{package:"node",module:"timers",path:"node/timers.d.ts"},tls:{package:"node",module:"tls",path:"node/tls.d.ts"},trace_events:{package:"node",module:"trace_events",path:"node/trace_events.d.ts"},tty:{package:"node",module:"tty",path:"node/tty.d.ts"},url:{package:"node",module:"url",path:"node/url.d.ts"},util:{package:"node",module:"util",path:"node/util.d.ts"},v8:{package:"node",module:"v8",path:"node/v8.d.ts"},vm:{package:"node",module:"vm",path:"node/vm.d.ts"},wasi:{package:"node",module:"wasi",path:"node/wasi.d.ts"},worker_threads:{package:"node",module:"worker_threads",path:"node/worker_threads.d.ts"},zlib:{package:"node",module:"zlib",path:"node/zlib.d.ts"},"node-red":{package:"node-red",module:"node-red",path:"node-red/index.d.ts"},"node-red-util":{package:"node-red",module:"util",path:"node-red/util.d.ts"},"node-red-func":{package:"node-red",module:"func",path:"node-red/func.d.ts"}},D=[v["node-red-util"],v["node-red-func"],v.globals,v.console,v.buffer],l={};function R(e,t,o,i){var n="object"==typeof e?e:v[e];if(n){const r=n.package,s=n.module,d=n.path;var a,e=l[d];e?(t||(o.JS[s]=monaco.languages.typescript.javascriptDefaults.addExtraLib(e,"file://types/"+r+"/"+s+"/index.d.ts")),i&&setTimeout(function(){i(null,n)},5)):(a="types/"+d,$.get(a).done(function(e){l[d]=e,t||(o.JS[s]=monaco.languages.typescript.javascriptDefaults.addExtraLib(e,"file://types/"+r+"/"+s+"/index.d.ts")),i&&i(null,n)}).fail(function(e){var t="Failed to load '"+a+"'";l[d]="/* "+t+" */\n",i&&i(e,n),console.warn(t)}))}}function x(e){return!(!e.offsetHeight&&!e.offsetWidth)&&"hidden"!==getComputedStyle(e).visibility}return{get type(){return"monaco"},get initialised(){return y},init:function(c){RED.events.on("editor:close",function(){var t=window.monaco?monaco.editor.getModels():null;if(t&&t.length){console.warn("Cleaning up monaco models left behind. Any node that calls createEditor() should call .destroy().");for(let e=0;e<t.length;e++){const o=t[e];o.isDisposed()||o.dispose()}}}),window.MonacoEnvironment=window.MonacoEnvironment||{},window.MonacoEnvironment.getWorkerUrl=function(e,t){return"json"===t?"./vendor/monaco/dist/json.worker.js":"css"===t||"scss"===t?"./vendor/monaco/dist/css.worker.js":"html"===t||"handlebars"===t?"./vendor/monaco/dist/html.worker.js":"typescript"===t||"javascript"===t?"./vendor/monaco/dist/ts.worker.js":"./vendor/monaco/dist/editor.worker.js"};var e=(RED.editor.codeEditor.settings||{}).options||{};try{const l=function(e,t){(t.rules&&Array.isArray(t.rules)||t.colors)&&(w.push(e),monaco.editor.defineTheme(e,t),monaco.editor.setTheme(e),E=e)};if(e.theme)if("object"==typeof e.theme&&RED.settings.editorTheme.theme){var t=e.theme.name||RED.settings.editorTheme.theme;l(t,e.theme)}else if("string"==typeof e.theme){let t=e.theme;w.includes(t)||$.get("vendor/monaco/dist/theme/"+t+".json",function(e){l(t,e)})}}catch(e){console.warn(e)}function n(e,t,o,i,n){return Array.isArray(o)&&(o=o.join("\n")),{label:e,kind:null==n?monaco.languages.CompletionItemKind.Snippet:n,documentation:{value:o},insertText:t,insertTextRules:monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,range:i}}(t=monaco).languages.registerCompletionItemProvider("javascript",{provideCompletionItems:function(e,t){var e=e.getWordUntilPosition(t),t={startLineNumber:t.lineNumber,endLineNumber:t.lineNumber,startColumn:e.startColumn,endColumn:e.endColumn};return{suggestions:[n("dowhile","do {\n\t${2}\n} while (${1:condition});","Do-While Statement (JavaScript Language Basics)",e=t),n("while","while (${1:condition}) {\n\t${2}\n}","While Statement (JavaScript Language Basics)",e),n("switch",'switch (${1:msg.topic}) {\n\tcase ${2:"value"}:\n\t\t${3}\n\t\tbreak;\n\tdefault:\n\t\t\n}',"Switch Statement (JavaScript Language Basics)",e),n("trycatch","try {\n\t${2}\n} catch (${1:error}) {\n\t\n};","Try-Catch Statement (JavaScript Language Basics)",e),n("for (for loop)","for (let ${1:index} = 0; ${1:index} < ${2:array}.length; ${1:index}++) {\n\tconst element = ${2:array}[${1:index}];\n\t${3}\n}","for loop",e),n("foreach","${1:array}.forEach(function(${2:element}) {\n\t${3}\n});","forEach(callbackfn: (value: T, index: number, array: readonly T[]) => void, thisArg?: any): void\n\nA function that accepts up to three arguments. forEach calls the callbackfn function one time for each element in the array.",e),n("forin","for (${1:prop} in ${2:obj}) {\n\tif (${2:obj}.hasOwnProperty(${1:prop})) {\n\t\t${3}\n\t}\n}","for in",e),n("forof","for (const ${1:iterator} of ${2:object}) {\n\t${3}\n}","for of",e),n("function","function ${1:methodName}(${2:arguments}) {\n\t${3}\n}","Function Declaration",e),n("func (anonymous function)","var ${1:fn} = function(${2:arguments}) {\n\t${3}\n}","Function Expression",e),n("pt (prototype)","${1:ClassName}.prototype.${2:methodName} = function(${3:arguments}) {\n\t${4}\n}","prototype",e),n("iife","(function(${1:arg}) {\n\t${1}\n})(${1:arg});","immediately-invoked function expression",e),n("call (function call)","${1:methodName}.call(${2:context}, ${3:arguments})","function call",e),n("apply (function apply)","${1:methodName}.apply(${2:context}, [${3:arguments}])","function apply",e),n("jsonparse","JSON.parse(${1:json});","JSON.parse",e),n("jsonstringify","JSON.stringify(${1:obj});","JSON.stringify",e),n("setinterval","setInterval(function() {\n\t${2}\n}, ${1:delay});","setInterval",e),n("settimeout","setTimeout(function() {\n\t${2}\n}, ${1:delay});","setTimeout",e),n("node.log",'node.log(${1:"info"});',"Write an info message to the console (not sent to sidebar)",e),n("node.warn",'node.warn(${1:"my warning"});',"Write a warning to the console and debug sidebar",e),n("node.error",'node.error(${1:"my error message"}, ${2:msg});',"Send an error to the console and debug sidebar. To trigger a Catch node on the same tab, the function should call `node.error` with the original message as a second argument",e),n("node.send","node.send(${1:msg});","async send a msg to the next node",e),n("node.send (multiple)","var ${1:msg1} = {payload:${2:1}};\nvar ${3:msg2} = {payload:${4:2}};\nnode.send([[${1:msg1}, ${3:msg2}]]);","send 1 or more messages out of 1 output",e),n("node.send (multiple outputs)","var ${1:msg1} = {payload:${2:1}};\nvar ${3:msg2} = {payload:${4:2}};\nnode.send([${1:msg1}, ${3:msg2}]);","send more than 1 message out of multiple outputs",e),n("node.status",'node.status({fill:"${1|red,green,yellow,blue,grey|}",shape:"${2|ring,dot|}",text:"${3:message}"});',"Set the status icon and text underneath the function node",e),n("get (node context)",'context.get("${1:name}");',"Get a value from node context",e),n("set (node context)",'context.set("${1:name}", ${1:value});',"Set a value in node context",e),n("get (flow context)",'flow.get("${1:name}");',"Get a value from flow context",e),n("set (flow context)",'flow.set("${1:name}", ${1:value});',"Set a value in flow context",e),n("get (global context)",'global.get("${1:name}");',"Get a value from global context",e),n("set (global context)",'global.set("${1:name}", ${1:value});',"Set a value in global context",e),n("get (env)",'env.get("${1|NR_NODE_ID,NR_NODE_NAME,NR_NODE_PATH,NR_GROUP_ID,NR_GROUP_NAME,NR_FLOW_ID,NR_FLOW_NAME|}");',"Get env variable value",e),n("cloneMessage (RED.util)","RED.util.cloneMessage(${1:msg});",["```typescript","RED.util.cloneMessage<T extends registry.NodeMessage>(msg: T): T","```","Safely clones a message object. This handles msg.req/msg.res objects that must not be cloned\n","*@param* `msg` — the msg object\n"],e),n("getObjectProperty (RED.util)","RED.util.getObjectProperty(${1:msg},${2:prop});",["```typescript","RED.util.getObjectProperty(msg: object, expr: string): any;","```","Gets a property of an object\n","*@param* `msg` — the msg object\n","*@param* `prop` — the msg object"],e),n("setObjectProperty (RED.util)","RED.util.setObjectProperty(${1:msg},${2:prop},${3:value},${4:createMissing});",["```typescript","RED.util.setObjectProperty(msg: object, prop: string, value: any, createMissing?: boolean): boolean","```","Sets a property of an object\n","`msg` — the object\n","`prop` — the property expression\n","`value` — the value to set\n","`createMissing` — whether to create missing parent properties"],e),n("getMessageProperty (RED.util)","RED.util.getMessageProperty(${1:msg},${2:prop});",["```typescript","RED.util.getMessageProperty(msg: object, expr: string): any;","```","Gets a property of an object\n","*@param* `msg` — the msg object\n","*@param* `prop` — the msg object"],e),n("setMessageProperty (RED.util)","RED.util.setMessageProperty(${1:msg},${2:prop},${3:value},${4:createMissing});",["```typescript","RED.util.setMessageProperty(msg: object, prop: string, value: any, createMissing?: boolean): boolean","```","Sets a property of an object\n","`msg` — the object\n","`prop` — the property expression\n","`value` — the value to set\n","`createMissing` — whether to create missing parent properties"],e)]}}});try{var o={allowJs:!0,checkJs:!0,allowNonTsExtensions:!0,target:monaco.languages.typescript.ScriptTarget.ESNext,strictNullChecks:!1,strictPropertyInitialization:!0,strictFunctionTypes:!0,strictBindCallApply:!0,useDefineForClassFields:!0,moduleResolution:monaco.languages.typescript.ModuleResolutionKind.NodeJs,module:monaco.languages.typescript.ModuleKind.CommonJS,typeRoots:["types"],lib:["esnext"]},i=RED.settings.get("codeEditor.monaco.languages.typescript.javascriptDefaults.compilerOptions")||{},o=Object.assign({},o,i),a=(t.languages.typescript.javascriptDefaults.setCompilerOptions(o),{noSemanticValidation:!1,noSyntaxValidation:!1,diagnosticCodesToIgnore:[1108,1375,1378,2307,2322,2339,2345,7043,80001,80004]}),r=RED.settings.get("codeEditor.monaco.languages.typescript.javascriptDefaults.diagnosticsOptions")||{},a=Object.assign({},a,r);t.languages.typescript.javascriptDefaults.setDiagnosticsOptions(a)}catch(e){console.warn("monaco - Error setting javascriptDefaults",e)}(e=monaco).languages.register({id:"jsonata"}),e.languages.setMonarchTokensProvider("jsonata",{defaultToken:"invalid",tokenPostfix:".js",keywords:["function","true","true","null","Infinity","NaN","undefined"].concat(Object.keys(jsonata.functions)),operatorsKeywords:["and","or","in"],operators:["<=",">=","!=","==","!=","=>","+","-","*","/","%",":=","~>","?",":","..","@","#","|","^","*","**"],symbols:/[=><!~?:&|+\-*\/\^%@#]+/,escapes:/\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,digits:/\d+(_+\d+)*/,octaldigits:/[0-7]+(_+[0-7]+)*/,binarydigits:/[0-1]+(_+[0-1]+)*/,hexdigits:/[[0-9a-fA-F]+(_+[0-9a-fA-F]+)*/,regexpctl:/[(){}\[\]\$\^|\-*+?\.]/,regexpesc:/\\(?:[bBdDfnrstvwWn0\\\/]|@regexpctl|c[A-Z]|x[0-9a-fA-F]{2}|u[0-9a-fA-F]{4})/,tokenizer:{root:[[/[{}]/,"delimiter.bracket"],{include:"common"}],common:[[/([a-zA-Z][\w$]*)|([$][\w$]*)/,{cases:{"@keywords":"keyword","@operatorsKeywords":"keyword",$2:"variable","@default":"identifier"}}],[/[$][\w\$]*/,"variable"],{include:"@whitespace"},[/\/(?=([^\\\/]|\\.)+\/([gimsuy]*)(\s*)(\.|;|\/|,|\)|\]|\}|$))/,{token:"regexp",bracket:"@open",next:"@regexp"}],[/[()\[\]]/,"@brackets"],[/[<>](?!@symbols)/,"@brackets"],[/(@symbols)|(\.\.)/,{cases:{"@operators":"operator","@default":""}}],[/(@digits)[eE]([\-+]?(@digits))?/,"number.float"],[/(@digits)\.(@digits)([eE][\-+]?(@digits))?/,"number.float"],[/0[xX](@hexdigits)/,"number.hex"],[/0[oO]?(@octaldigits)/,"number.octal"],[/0[bB](@binarydigits)/,"number.binary"],[/(@digits)/,"number"],[/[?:;,.]/,"delimiter"],[/"([^"\\]|\\.)*$/,"string.invalid"],[/'([^'\\]|\\.)*$/,"string.invalid"],[/"/,"string","@string_double"],[/'/,"string","@string_single"],[/`/,"string","@string_backtick"]],whitespace:[[/[ \t\r\n]+/,""],[/\/\*\*(?!\/)/,"comment.doc","@jsdoc"],[/\/\*/,"comment","@comment"],[/\/\/.*$/,"comment"]],comment:[[/[^\/*]+/,"comment"],[/\*\//,"comment","@pop"],[/[\/*]/,"comment"]],jsdoc:[[/[^\/*]+/,"comment.doc"],[/\*\//,"comment.doc","@pop"],[/[\/*]/,"comment.doc"]],regexp:[[/(\{)(\d+(?:,\d*)?)(\})/,["regexp.escape.control","regexp.escape.control","regexp.escape.control"]],[/(\[)(\^?)(?=(?:[^\]\\\/]|\\.)+)/,["regexp.escape.control",{token:"regexp.escape.control",next:"@regexrange"}]],[/(\()(\?:|\?=|\?!)/,["regexp.escape.control","regexp.escape.control"]],[/[()]/,"regexp.escape.control"],[/@regexpctl/,"regexp.escape.control"],[/[^\\\/]/,"regexp"],[/@regexpesc/,"regexp.escape"],[/\\\./,"regexp.invalid"],[/(\/)([gimsuy]*)/,[{token:"regexp",bracket:"@close",next:"@pop"},"keyword.other"]]],regexrange:[[/-/,"regexp.escape.control"],[/\^/,"regexp.invalid"],[/@regexpesc/,"regexp.escape"],[/[^\]]/,"regexp"],[/\]/,{token:"regexp.escape.control",next:"@pop",bracket:"@close"}]],string_double:[[/[^\\"]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/"/,"string","@pop"]],string_single:[[/[^\\']+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/'/,"string","@pop"]],string_backtick:[[/\$\{/,{token:"delimiter.bracket",next:"@bracketCounting"}],[/[^\\`$]+/,"string"],[/@escapes/,"string.escape"],[/\\./,"string.escape.invalid"],[/`/,"string","@pop"]],bracketCounting:[[/\{/,"delimiter.bracket","@bracketCounting"],[/\}/,"delimiter.bracket","@pop"],{include:"common"}]}}),e.languages.setLanguageConfiguration("jsonata",{comments:{lineComment:"//",blockComment:["/*","*/"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:"'",close:"'",notIn:["string","comment"]},{open:'"',close:'"',notIn:["string"]}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"},{open:"<",close:">"}],folding:{markers:{start:new RegExp("^\\s*//\\s*(?:(?:#?region\\b)|(?:<editor-fold\\b))"),end:new RegExp("^\\s*//\\s*(?:(?:#?endregion\\b)|(?:</editor-fold>))")}}}),e.languages.registerCompletionItemProvider("jsonata",{provideCompletionItems:function(e,t){var i,o,e=e.getWordUntilPosition(t);if(e)return o=e.startColumn,"$"!==e.word[0]&&1<t.column&&o--,i={startLineNumber:t.lineNumber,endLineNumber:t.lineNumber,startColumn:o,endColumn:e.endColumn},t=Object.keys(jsonata.functions),o=t.map(function(e){var t=e+"("+RED._("jsonata:"+e+".args",{defaultValue:""})+")",o=RED._("jsonata:"+e+".desc",{defaultValue:""});return n(e,(jsonata.getFunctionSnippet(e)+"").trim(),{value:"`"+t+"`\n\n"+o},i,monaco.languages.CompletionItemKind.Function)}),t.sort(function(e,t){return t.length-e.length}),o.unshift(n("randominteger","(\n\t\\$minimum := ${1:1};\n\t\\$maximum := ${2:10};\n\t\\$round((\\$random() * (\\$maximum-\\$minimum)) + \\$minimum, 0)\n)","Random integer between 2 numbers",i)),{suggestions:o}}}),e.languages.registerHoverProvider("jsonata",{provideHover:function(e,t){var e=e.getWordAtPosition(t),o=e&&e.word;if(o&&"$"!==o[0]&&1<t.column){var o="$"+o,i=RED._("jsonata:"+o+".args",{defaultValue:""});if(i)return i=o+"("+i+")",o=RED._("jsonata:"+o+".desc",{defaultValue:""}),{range:new monaco.Range(t.lineNumber,t.column,t.lineNumber,t.column+e.word.length),contents:[{value:"**`"+i+"`**"},{value:o}]}}}}),i=monaco;try{var s=RED.settings.get("codeEditor.monaco.languages.json.jsonDefaults.diagnosticOptions"),d=RED.settings.get("codeEditor.monaco.languages.json.jsonDefaults.modeConfiguration"),s=Object.assign({},{validate:!0},s||{});i.languages.json.jsonDefaults.setDiagnosticsOptions(s),d&&i.languages.json.jsonDefaults.setModeConfiguration(d)}catch(e){console.warn("monaco - Error setting up json options",err)}o=monaco;try{var u=RED.settings.get("codeEditor.monaco.languages.css.cssDefaults.diagnosticsOptions"),p=RED.settings.get("codeEditor.monaco.languages.css.lessDefaults.diagnosticsOption"),f=RED.settings.get("codeEditor.monaco.languages.css.scssDefaults.diagnosticsOption"),h=RED.settings.get("codeEditor.monaco.languages.css.cssDefaults.modeConfiguration"),g=RED.settings.get("codeEditor.monaco.languages.css.lessDefaults.modeConfiguration"),m=RED.settings.get("codeEditor.monaco.languages.css.scssDefaults.modeConfiguration");u&&o.languages.css.cssDefaults.setDiagnosticsOptions(u),p&&o.languages.css.cssDefaults.setDiagnosticsOptions(p),f&&o.languages.css.cssDefaults.setDiagnosticsOptions(f),h&&o.languages.css.cssDefaults.setDiagnosticsOptions(h),g&&o.languages.css.cssDefaults.setDiagnosticsOptions(g),m&&o.languages.css.cssDefaults.setDiagnosticsOptions(m)}catch(e){console.warn("monaco - Error setting up CSS/SCSS/LESS options",err)}r=monaco;try{var b=RED.settings.get("codeEditor.monaco.languages.html.htmlDefaults.options"),v=RED.settings.get("codeEditor.monaco.languages.html.handlebarDefaults.options");b&&r.languages.html.htmlDefaults.setOptions(b),v&&r.languages.html.handlebarDefaults.setOptions(v)}catch(e){console.warn("monaco - Error setting up html options",err)}return D.forEach(function(e){R(e,!0)}),y=!0},create:function(e){function c(e){switch(e=(e="object"==typeof e&&e.path?e.path:e)?e.replace("ace/mode/",""):"text"){case"nrjavascript":case"mjs":e="javascript";break;case"vue":e="html";break;case"appcache":e="shell"}return e}var a,t=RED.editor.codeEditor.settings||{},u={JS:{},TS:{}},r=e.element||$("#"+e.id)[0],s=$("<div>").appendTo(r),r=$("<div>").appendTo(r).addClass("red-ui-editor-text-container")[0];(t=$.extend({},t.options,e)).language=c(e.mode),E&&(t.theme=E),"javascript"==t.language&&(t._language=t.language,t.language="text"),t.minimap||(t.minimap={enabled:!0,maxColumn:50,scale:1,showSlider:"mouseover",renderCharacters:!0}),!1===e.enableBasicAutocompletion&&(t.showSnippets=!1,t.quickSuggestions=!1,t.parameterHints={enabled:!1},t.suggestOnTriggerCharacters=!1,t.acceptSuggestionOnEnter="off",t.tabCompletion="off",t.wordBasedSuggestions=!1),!1===e.enableSnippets&&(t.showSnippets=!1),null==t.mouseWheelZoom&&(t.mouseWheelZoom=!0),null==t.suggestFontSize&&(t.suggestFontSize=12),null==t.formatOnPaste&&(t.formatOnPaste=!0),null==t.foldingHighlight&&(t.foldingHighlight=!0),null==t.foldStyle&&(t.foldStyle=!0),null!=t.readOnly&&(t.readOnly=t.readOnly),!1===t.lineNumbers&&(t.lineNumbers=!1),null==t.theme&&(t.theme=w[0]),null==t.mode&&(t.mode=c(e.mode)),null==t.automaticLayout&&(t.automaticLayout=!0),e.foldStyle&&"none"===e.foldStyle?(t.foldStyle=!1,t.foldingHighlight=!1):(t.foldStyle=!0,t.foldingHighlight=!0),t.roundedSelection=!1!==t.roundedSelection,t.contextmenu=!1!==t.contextmenu,t.snippetSuggestions=!1!==t.enableSnippets,t.value=e.value||"",t.wordSeparators||"jsonata"!=t.language&&"json"!=t.language&&"javascript"!=t.language||(t.wordSeparators="`~!@#%^&*()-=+[{]}|;:'\",.<>/?"),t.fixedOverflowWidgets=!1!==t.fixedOverflowWidgets;((o=RED.utils.getBrowserInfo()).mobile||o.tablet)&&(t.minimap={enabled:!1},t.formatOnType=!1,t.formatOnPaste=!1,t.disableMonospaceOptimizations=!0,t.columnSelection=!1,t.matchBrackets="never",t.maxTokenizationLineLength=1e4,t.stopRenderingLineAfter=2e3,t.roundedSelection=!1,t.trimAutoWhitespace=!1,t.parameterHints={enabled:!1},t.suggestOnTriggerCharacters=!1,t.wordBasedSuggestions=!1,t.suggest={maxVisibleSuggestions:6},!t.accessibilitySupport&&o.android&&(t.accessibilitySupport="off"));var o=!1,i=(null==e.clientSideSuggestions&&(0<=(e.mode+"").indexOf("nrjavascript")||e.globals&&(e.globals.RED||e.globals.Buffer))&&(o=!0),monaco.languages.typescript.javascriptDefaults.getCompilerOptions());function d(t){var i=[],n=[];const a="extraModuleLibs/index.d.ts",r="file://types/extraModuleLibs/index.d.ts";if(t&&0!=t.length){var s=[],o=(Array.prototype.push.apply(s,t),{});for(let e=0;e<t.length;e++){var d=t[e],l=d.var,d=d.module,l=(l&&d&&(n.push("import "+l+"_import = require('"+d+"');\n"),i.push("var "+l+": typeof "+l+"_import;\n")),v[d]);o[d]=l||{package:"other",module:d,path:"other/"+d+".d.ts"}}Object.values(o).forEach(function(e){R(e,!1,u,function(e,t){var o;0==(s=s.filter(function(e){return e.module!=t.module})).length&&(o=n.join("")+("\ndeclare global {\n"+i.join("")+"\n}"),setTimeout(function(){u.JS[a]=monaco.languages.typescript.javascriptDefaults.addExtraLib(o,r)},500))})})}else u.JS[a]=monaco.languages.typescript.javascriptDefaults.addExtraLib(" ",r)}o?(i.lib=["esnext"],D.forEach(function(e){R(e,!1,u)})):i.lib=["esnext","dom"],monaco.languages.typescript.javascriptDefaults.setCompilerOptions(i),d(t.extraLibs);var p=monaco.editor.create(r,t);try{p._standaloneKeybindingService.addDynamicKeybinding("-editor.action.insertLineAfter",null,()=>{})}catch(e){}p.nodered={refreshModuleLibs:d};for(var n=0;n<w.length;n++){var l=w[n];p.addAction(function(t,e){return{id:"set-theme-"+t,label:RED._("monaco.setTheme")+" "+t,precondition:null,keybindingContext:e||null,run:function(e){return e.setTheme(t),null}}}(l))}function f(e,t,o){e.getOption(monaco.editor.EditorOptions.readOnly.id)?e.getModel().pushEditOperations(e.getSelections(),t,function(){return o||null}):e.executeEdits("editor",t)}function h(e,t,o){e?"javascript"==p._mode&&"text"==p._tempMode&&(p._tempMode="",setTimeout(function(){o.parentElement&&p.setMode("javascript",void 0,!1)},t||50)):"javascript"==p._mode&&"text"!=p._tempMode&&o.parentElement&&(p.setMode("text",void 0,!1),p._tempMode="text")}p.selection={},(p.session=p).renderer={},p.setMode=function(e,t,o){null==o&&(o=!0),e=c(e);var i,n=p.getModel(),a=p.getValue();if(n){var r=p.getScrollTop(),s=p.getScrollLeft(),d=p.getSelections(),l=p.getPosition(),a=n.getValue()||"";try{n.isDisposed()||n.dispose()}catch(e){}p.setModel(null),i=monaco.editor.createModel(a||"",e),p.setModel(i),p.setScrollTop(r,1),p.setScrollLeft(s,1),p.setPosition(l),p.setSelections(d)}else i=monaco.editor.createModel(a||"",e),p.setModel(i);t&&"function"==typeof t&&t(),o&&this.resize()},p.getRange=function(){var e=p.getSelection();return e.start={row:e.selectionStartLineNumber-1,column:e.selectionStartColumn-1},e.end={row:e.endLineNumber-1,column:e.endColumn-1},e},p.selection.getRange=p.getRange,p.session.insert=function(e,t){f(this,[{range:new monaco.Range(e.row+1,e.column+1,e.row+1,e.column+1),text:t,forceMoveMarkers:!0}])},p.setReadOnly=function(e){p.updateOptions({readOnly:e})},p.session.replace=function(e,t){f(this,[{range:e,text:t,forceMoveMarkers:!0}])},p.selectAll=function(){var e=p.getModel().getFullModelRange();p.setSelection(e)},p.clearSelection=function(){p.setPosition({column:1,lineNumber:1})},p.getSelectedText=function(){return p.getModel().getValueInRange(p.getSelection())},p.insertSnippet=function(e){let t=p.getContribution("snippetController2");t.insert(e)},p.destroy=function(){a&&clearInterval(a);try{if(Object.keys(u.JS).length){var t=Object.entries(u.JS);for(let e=0;e<t.length;e++)try{var o=t[e][0];u.JS[o].dispose(),u.JS[o]=null,delete u.JS[o]}catch(e){}}if(Object.keys(u.TS).length){var i=Object.entries(u.TS);for(let e=0;e<i.length;e++)try{var n=i[e][0];u.TS[n].dispose(),u.TS[n]=null,delete u.TS[n]}catch(e){}}}catch(e){}try{var e=this.getModel();e&&!e.isDisposed()&&e.dispose(),this.setModel(null)}catch(e){}$(r).remove(),$(s).remove()},p.resize=function(){p.layout()},p.renderer.updateFull=p.resize.bind(p),p.getSession=function(){return p},p.getLength=function(){var e=p.getModel();return null!==e?e.getLineCount():0},p.scrollToLine=function(e,t){p.revealLine(e,t)},p.moveCursorTo=function(e,t){p.setPosition({lineNumber:e,column:t})},p.getAnnotations=function(){var e=[];try{var n,a,r,s,t=p.getModel();null!==t&&(n=t.getModeId(),a=t._associatedResource.authority,r=t._associatedResource.path,s=t._associatedResource.scheme,e=(monaco.editor.getModelMarkers(t)||[]).filter(function(e){var t=e.resource.authority,o=e.resource.path,i=e.resource.scheme;return e.owner==n&&t===a&&o===r&&i===s}).map(function(e){return{row:e.startLineNumber,column:e.startColumn,endColumn:e.endColumn,endRow:e.endLineNumber,text:e.message,type:monaco.MarkerSeverity[e.severity]?monaco.MarkerSeverity[e.severity].toLowerCase():e.severity}}))}catch(e){console.log("Failed to get editor Annotations",e)}return e||[]},p.gotoLine=function(e,t){p.setPosition({lineNumber:e+1,column:t+1})},p.getCursorPosition=function(){var e=p.getPosition();return{row:e.lineNumber-1,column:e.column-1}},p.setTheme=function(e){monaco.editor.setTheme(e),E=e},p.on=function(e,t){switch(e){case"change":case"input":e="onDidChangeModelContent";break;case"focus":e="onDidFocusEditorWidget";break;case"blur":e="onDidBlurEditorWidget";break;case"paste":e="onDidPaste"}var o;if(p[e])o=p[e];else{if(!monaco.editor[e])return void console.warn("monaco - unknown event: "+e);o=monaco.editor[e]}o(t)},p.getUndoManager=function(){var e={};return e.isClean=function(){try{return!1===p.getModel().canUndo()}catch(e){return!1}}.bind(p),e},p.setFontSize=function(e){p.updateOptions({fontSize:e})},e.cursor&&(o=e.cursor.row||e.cursor.lineNumber,i=e.cursor.column||e.cursor.col,p.gotoLine(o,i)),e.focus&&p.focus(),p._mode=t.language,t._language&&(p._mode=t._language,p._tempMode=t.language),p.onDidBlurEditorWidget(function(){0==x(r)&&h(!1,0,r)}),p.onDidFocusEditorWidget(function(){h(!0,10,r)});var g=r,m=h;try{var b={root:$(g).closest("div.red-ui-tray-content")[0]||document,attributes:!0,childList:!0};new IntersectionObserver(function(e,t){e.forEach(function(e){m(0<e.intersectionRatio,5,e.target)})},b).observe(g)}catch(e){try{let t=x(r);a=setInterval(function(){var e=x(r);e!=t&&m(e,5,g),t=e},100)}catch(e){}}return"markdown"===t.language&&($(r).addClass("red-ui-editor-text-container-toolbar"),p.toolbar=RED.editor.customEditTypes._markdown.buildToolbar(s,p),!1!==e.expandable&&(o=$('<button type="button" class="red-ui-button" style="float: right;"><i class="fa fa-expand"></i></button>').appendTo(p.toolbar),RED.popover.tooltip(o,RED._("markdownEditor.expand")),o.on("click",function(e){e.preventDefault();e=p.getValue();RED.editor.editMarkdown({value:e,width:"Infinity",cursor:p.getCursorPosition(),complete:function(e,t){p.setValue(e,-1),p.gotoLine(t.row+1,t.column,!1),setTimeout(function(){p.focus()},300)}})})),i=$('<button type="button" class="red-ui-editor-text-help red-ui-button red-ui-button-small"><i class="fa fa-question"></i></button>').appendTo($(r).parent()),RED.popover.create({target:i,trigger:"click",size:"small",direction:"left",content:RED._("markdownEditor.format"),autoClose:50})),p.type="monaco",p}}}(),RED.eventLog=function(){var n,i=[],t=!1;return{init:function(){$('<script type="text/x-red" data-template-name="_eventLog"><div class="form-row node-text-editor-row"><div style="height: 100%;min-height: 150px;" class="node-text-editor" id="red-ui-event-log-editor"></div></div><\/script>').appendTo("#red-ui-editor-node-configs"),RED.actions.add("core:show-event-log",RED.eventLog.show)},show:function(){var e;t||(t=!0,e={title:RED._("eventLog.title"),width:1/0,buttons:[{id:"node-dialog-close",text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<t.size();i++)o-=$(t[i]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",o+"px"),n.resize()},open:function(e){e.find(".red-ui-tray-body");e=RED.editor.buildEditForm(e.find(".red-ui-tray-body"),"dialog-form","_eventLog","editor");n=RED.editor.createEditor({mode:"ace/mode/shell",id:"red-ui-event-log-editor",value:i.join("\n"),lineNumbers:!1,readOnly:!0,options:{showPrintMargin:!1}}),setTimeout(function(){n.scrollToLine(n.getSession().getLength())},200),e.i18n()},close:function(){n.destroy(),n=null,t=!1},show:function(){}},RED.tray.show(e))},log:function(e,t){var o=new Date(t.ts).toISOString()+" ";t.type&&(o+="["+t.type+"] "),t.data&&(t=(t=t.data).endsWith("\n")?t.substring(0,t.length-1):t).split(/\n/).forEach(function(e){e=o+e,i.push(e),500<i.length&&(i=i.slice(-500)),n&&(n.getSession().insert({row:n.getSession().getLength(),column:0},"\n"+e),n.scrollToLine(n.getSession().getLength()))})},startEvent:function(e){i.push(""),i.push("-----------------------------------------------------------"),i.push((new Date).toISOString()+" "+e),i.push("")}}}(),RED.tray=function(){var h,g=[],m=!1,o=!1;function i(e){var t,c,o=$('<div class="red-ui-tray"></div>'),i=$('<div class="red-ui-tray-header editor-tray-header"></div>').appendTo(o),u=$('<div class="red-ui-tray-body-wrapper"></div>').appendTo(o),n=$('<div class="red-ui-tray-body editor-tray-body"></div>').appendTo(u),u=$('<div class="red-ui-tray-footer"></div>').appendTo(o),p=$('<div class="red-ui-tray-resize-handle"></div>').appendTo(o),f=(e.title&&((t=g.map(function(e){return e.options.title})).push(e.title),t='<ul class="red-ui-tray-breadcrumbs"><li>'+t.join("</li><li>")+"</li></ul>",$('<div class="red-ui-tray-titlebar">'+t+"</div>").appendTo(i)),e.width===1/0&&(e.maximized=!0,p.addClass("red-ui-tray-resize-maximised")),$('<div class="red-ui-tray-toolbar"></div>').appendTo(i));if(e.buttons)for(var a=0;a<e.buttons.length;a++){var r=e.buttons[a],s=$("<button>").button().appendTo(f);r.id&&s.attr("id",r.id),r.text&&s.text(r.text),r.click&&s.on("click",function(t){return function(e){$(this).hasClass("disabled")||t(e)}}(r.click)),r.class&&(s.addClass(r.class),"primary"===r.class&&(c=r))}o.appendTo(h);var d={tray:o,header:i,body:n,footer:u,options:e,primaryButton:c};function l(){$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$(".red-ui-sidebar-shade").show(),d.preferredWidth=Math.max(o.width(),500),e.maximized||n.css({minWidth:d.preferredWidth-40}),e.width?(e.width>$("#red-ui-editor-stack").position().left-8&&(e.width=$("#red-ui-editor-stack").position().left-8),o.width(e.width)):o.width(d.preferredWidth),d.width=o.width(),d.width>$("#red-ui-editor-stack").position().left-8&&(d.width=Math.max(0,$("#red-ui-editor-stack").position().left-8),o.width(d.width)),$("#red-ui-main-container").scrollLeft(0),o.css({right:-(o.width()+10)+"px",transition:"right 0.25s ease"}),b(),m=!0,setTimeout(function(){setTimeout(function(){e.width||o.width(Math.min(d.preferredWidth,$("#red-ui-editor-stack").position().left-8)),e.resize&&e.resize({width:o.width()}),e.show&&e.show(),setTimeout(function(){m=!1,v(),b()},200),n.find(":focusable:first").trigger("focus")},150),o.css({right:0})},0)}g.push(d),e.maximized||o.draggable({handle:p,axis:"x",start:function(e,t){o.width("auto")},drag:function(e,t){var o=h.position().left+t.position.left;o<7?t.position.left+=7-o:t.position.left>-d.preferredWidth-1&&(t.position.left=-Math.min(h.position().left-7,d.preferredWidth-1)),d.options.resize&&setTimeout(function(){d.options.resize({width:-t.position.left})},0),d.width=-t.position.left},stop:function(e,t){o.width(-t.position.left),o.css({left:""}),d.options.resize&&d.options.resize({width:-t.position.left}),d.width=-t.position.left}}),e.open?1===e.open.length?(e.open(o),l()):e.open(o,l):l()}function b(){var e,t;0<g.length&&((e=g[g.length-1]).options.maximized||e.width>$("#red-ui-editor-stack").position().left-8?(e.width=$("#red-ui-editor-stack").position().left-8,e.tray.width(e.width)):e.width<e.preferredWidth&&(e.width=Math.min($("#red-ui-editor-stack").position().left-8,e.preferredWidth),e.tray.width(e.width)),t=e.tray.height()-e.header.outerHeight()-e.footer.outerHeight(),e.body.height(t),e.options.resize&&e.options.resize({width:e.width,height:t}))}function v(){setTimeout(function(){$("#red-ui-editor-stack").css("zIndex","13")},300)}function n(){$("#red-ui-editor-stack").css("zIndex","9")}return{init:function(){h=$("#red-ui-editor-stack"),$(window).on("resize",b),RED.events.on("sidebar:resize",b),$("#red-ui-editor-shade").on("click",function(){var e;m||(e=g[g.length-1])&&e.primaryButton&&e.primaryButton.click()})},show:function(e){if(n(),e){if(o)throw new Error("Cannot add to stack whilst hidden");var t;0<g.length&&!e.overlay?(t=g[g.length-1],"inherit"===e.width&&(e.width=t.tray.width()),t.tray.css({right:-(t.tray.width()+10)+"px"}),setTimeout(function(){t.tray.detach(),i(e)},250)):(0<g.length&&g[g.length-1].tray.css("z-index",0),RED.events.emit("editor:open"),i(e))}else 0<g.length&&(g[g.length-1].tray.css({right:0}),$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$(".red-ui-sidebar-shade").show(),o=!1)},hide:function(){var e;n(),0<g.length&&((e=g[g.length-1]).tray.css({right:-(e.tray.width()+10)+"px"}),$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$(".red-ui-sidebar-shade").hide(),o=!0)},resize:b,close:function(t){var o;n(),0<g.length&&((o=g.pop()).tray.css({right:-(o.tray.width()+10)+"px"}),setTimeout(function(){try{o.options.close&&o.options.close()}catch(e){}var e;o.tray.remove(),0<g.length&&((e=g[g.length-1]).options.overlay?(b(),e.options.show&&e.options.show()):(e.tray.appendTo("#red-ui-editor-stack"),setTimeout(function(){b(),e.tray.css({right:0}),e.options.show&&(v(),b(),e.options.show())},0))),t&&t(),0===g.length?($("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$(".red-ui-sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus()):g[g.length-1].tray.css("z-index","auto")},250))}}}(),RED.clipboard=function(){var m,b,r,n,c,u,s,v,e,t,o=!1,d={};function i(){m=$('<div id="red-ui-clipboard-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("#red-ui-editor").dialog({modal:!0,autoOpen:!1,width:700,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{id:"red-ui-clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close"),RED.view.focus()}},{id:"red-ui-clipboard-dialog-download",class:"primary",text:RED._("clipboard.download"),click:function(){var e,t,o=$("#red-ui-clipboard-dialog-export-text").val();e="flows.json",o=o,window.navigator.msSaveBlob?(t=new Blob([o],{type:"data:text/plain;charset=utf-8"}),navigator.msSaveBlob(t,e)):((t=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(o)),t.setAttribute("download",e),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)),$(this).dialog("close"),RED.view.focus()}},{id:"red-ui-clipboard-dialog-export",class:"primary",text:RED._("clipboard.export.copy"),click:function(){var e,t,o,i,n,a,r;"red-ui-clipboard-dialog-export-tab-clipboard"===s?(e=$("#red-ui-clipboard-dialog-export-text").val(),$(this).dialog("close"),E(e),RED.notify(RED._("clipboard.nodesExported"),{id:"clipboard"}),RED.view.focus()):(t=$("#red-ui-clipboard-dialog-export-text").val(),(o=d[s].getSelected()).children||(o=o.parent),i=$("#red-ui-clipboard-dialog-tab-library-name").val().trim(),n=function(){$.ajax({url:"library/"+o.library+"/"+o.type+"/"+o.path+i,type:"POST",data:t,contentType:"application/json; charset=utf-8"}).done(function(){$(m).dialog("close"),RED.view.focus(),RED.notify(RED._("library.exportedToLibrary"),"success")}).fail(function(e,t,o){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})},o.children?(a=!1,o.children.forEach(function(e){e.label===i&&(a=!0)}),a?(m.dialog("close"),r=RED.notify(RED._("clipboard.export.exists",{file:RED.utils.sanitize(i)}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){r.hideNotification(),m.dialog("open")}},{text:RED._("clipboard.export.overwrite"),click:function(){r.hideNotification(),n()}}]})):n()):n())}},{id:"red-ui-clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){var e,t="red-ui-clipboard-dialog-import-opt-new"===$("#red-ui-clipboard-dialog-import-opt > a.selected").attr("id");"red-ui-clipboard-dialog-import-tab-clipboard"===s?D($("#red-ui-clipboard-dialog-import-text").val(),t):(e=d[s].getSelected()).path&&$.get("library/"+e.library+"/"+e.type+"/"+e.path,function(e){D(e,t)}),$(this).dialog("close"),RED.view.focus()}},{id:"red-ui-clipboard-dialog-import-conflict",class:"primary",text:RED._("clipboard.import.importSelected"),click:function(){var t={},e=($('#red-ui-clipboard-dialog-import-conflicts-list input[type="checkbox"]').each(function(){t[$(this).attr("data-node-id")]=this.checked?"import":"skip"}),$('.red-ui-clipboard-dialog-import-conflicts-controls input[type="checkbox"]').each(function(){$(this).attr("disabled")||(t[$(this).attr("data-node-id")]=this.checked?"replace":"copy")}),v.importOptions.importMap=t,v.importNodes.filter(function(e){return t[e.id]&&!t[e.z]||(t[e.id]=t[e.z]),"skip"!==t[e.id]}));RED.view.importNodes(e,v.importOptions),$(this).dialog("close"),RED.view.focus()}}],open:function(e,t){RED.keyboard.disable()},close:function(e){RED.keyboard.enable(),c&&(c.close(!0),u=null)}}),b=m.children(".dialog-form"),r='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="common.label.export"></label><span id="red-ui-clipboard-dialog-export-rng-group" class="button-group"><a id="red-ui-clipboard-dialog-export-rng-selected" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="red-ui-clipboard-dialog-export-rng-flow" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="red-ui-clipboard-dialog-export-rng-full" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="red-ui-clipboard-dialog-box"><div class="red-ui-clipboard-dialog-tabs"><ul id="red-ui-clipboard-dialog-export-tabs"></ul></div><div id="red-ui-clipboard-dialog-export-tabs-content" class="red-ui-clipboard-dialog-tabs-content"><div id="red-ui-clipboard-dialog-export-tab-clipboard" class="red-ui-clipboard-dialog-tab-clipboard"><div id="red-ui-clipboard-dialog-export-tab-clipboard-tab-bar"><ul id="red-ui-clipboard-dialog-export-tab-clipboard-tabs"></ul></div><div class="red-ui-clipboard-dialog-export-tab-clipboard-tab" id="red-ui-clipboard-dialog-export-tab-clipboard-preview"><div id="red-ui-clipboard-dialog-export-tab-clipboard-preview-list"></div></div><div class="red-ui-clipboard-dialog-export-tab-clipboard-tab" id="red-ui-clipboard-dialog-export-tab-clipboard-json"><div class="form-row" style="height:calc(100% - 40px)"><textarea readonly id="red-ui-clipboard-dialog-export-text"></textarea></div><div class="form-row" style="text-align: right;"><span id="red-ui-clipboard-dialog-export-fmt-group" class="button-group"><a id="red-ui-clipboard-dialog-export-fmt-mini" class="red-ui-button red-ui-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="red-ui-clipboard-dialog-export-fmt-full" class="red-ui-button red-ui-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div></div></div><div class="form-row" id="red-ui-clipboard-dialog-export-tab-library-filename"><label data-i18n="clipboard.export.exportAs"></label><input id="red-ui-clipboard-dialog-tab-library-name" type="text"></div></div></div>',n='<div class="red-ui-clipboard-dialog-box" style="margin-bottom: 12px"><div class="red-ui-clipboard-dialog-tabs"><ul id="red-ui-clipboard-dialog-import-tabs"></ul></div><div id="red-ui-clipboard-dialog-import-tabs-content" class="red-ui-clipboard-dialog-tabs-content"><div id="red-ui-clipboard-dialog-import-tab-clipboard" class="red-ui-clipboard-dialog-tab-clipboard"><div class="form-row"><span data-i18n="clipboard.pasteNodes"></span> <a class="red-ui-button" id="red-ui-clipboard-dialog-import-file-upload-btn"><i class="fa fa-upload"></i> <span data-i18n="clipboard.selectFile"></span></a><input type="file" id="red-ui-clipboard-dialog-import-file-upload" accept=".json" style="display:none"></div><div class="form-row" style="height:calc(100% - 47px)"><textarea id="red-ui-clipboard-dialog-import-text"></textarea></div></div></div></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="red-ui-clipboard-dialog-import-opt" class="button-group"><a id="red-ui-clipboard-dialog-import-opt-current" class="red-ui-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="red-ui-clipboard-dialog-import-opt-new" class="red-ui-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',importConflictsDialog='<div class="form-row"><div class="form-row"><p data-i18n="clipboard.import.conflictNotification1"></p><p data-i18n="clipboard.import.conflictNotification2"></p></div><div class="red-ui-clipboard-dialog-import-conflicts-list-container"><div id="red-ui-clipboard-dialog-import-conflicts-list"></div></div></div>'}function a(){e&&clearTimeout(e),e=setTimeout(function(){var e=$("#red-ui-clipboard-dialog-tab-library-name"),t=e.val().trim();0<t.length&&!/[\/\\]/.test(t)?(e.removeClass("input-error"),$("#red-ui-clipboard-dialog-export").button("enable")):(e.addClass("input-error"),$("#red-ui-clipboard-dialog-export").button("disable"))},100)}function l(){var e;"red-ui-clipboard-dialog-import-tab-clipboard"===s?(t&&clearTimeout(t),t=setTimeout(function(){var t=$("#red-ui-clipboard-dialog-import-text");if(""===(i=t.val().trim()))return c.close(!0),u=null,t.removeClass("input-error"),void $("#red-ui-clipboard-dialog-ok").button("disable");try{if(!/^\[[\s\S]*\]$/m.test(i))throw new Error(RED._("clipboard.import.errors.notArray"));for(var e=JSON.parse(i),o=0;o<e.length;o++){if("object"!=typeof e[o])throw new Error(RED._("clipboard.import.errors.itemNotObject",{index:o}));if(!e[o].hasOwnProperty("id"))throw new Error(RED._("clipboard.import.errors.missingId",{index:o}));if(!e[o].hasOwnProperty("type"))throw new Error(RED._("clipboard.import.errors.missingType",{index:o}))}u=null,c.close(!0),t.removeClass("input-error"),t.val(i),$("#red-ui-clipboard-dialog-ok").button("enable")}catch(e){if(""!==i){t.addClass("input-error");t=e.toString();if(t!==u){var i,n=$('<div class="red-ui-clipboard-import-error"></div>').text(t),a=/at position (\d+)/i.exec(t);if(a)l=parseInt(a[1]);else if(a=/at line (\d+) column (\d+)/i.exec(t)){for(var r=parseInt(a[1])-1,s=parseInt(a[2])-1,d=i.split("\n"),l=0,o=0;o<r;o++)l+=d[o].length+1;l+=s}void 0!==l&&(i=i.replace(/\n/g,"↵"),parseInt(a[1]),s=$("<div>").appendTo(n),a=$("<pre>").appendTo(s),$("<span>").text(i.substring(l-12,l)).appendTo(a),$('<span class="error">').text(i.charAt(l)).appendTo(a),$("<span>").text(i.substring(l+1,l+12)).appendTo(a)),c.close(!0).setContent(n).open(),u=t}}else u=null;$("#red-ui-clipboard-dialog-ok").button("disable")}},100)):(e=d[s].getSelected())&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")}function p(e){var i,t;o||(e=e||"clipboard",b.empty(),b.append($(n)),(i=RED.tabs.create({id:"red-ui-clipboard-dialog-import-tabs",vertical:!0,onchange:function(e){$("#red-ui-clipboard-dialog-import-tabs-content").children().hide(),$("#"+e.id).show(),s=e.id,c&&(c.close(!0),u=null),"red-ui-clipboard-dialog-import-tab-clipboard"===e.id?$("#red-ui-clipboard-dialog-import-text").trigger("focus"):d[e.id].focus(),l()}})).addTab({id:"red-ui-clipboard-dialog-import-tab-clipboard",label:RED._("clipboard.clipboard")}),(RED.settings.libraries||[]).forEach(function(e){var t="red-ui-clipboard-dialog-import-tab-"+e.id,o=(i.addTab({id:t,label:RED._(e.label||e.id)}),$('<div id="red-ui-clipboard-dialog-import-tab-library" class="red-ui-clipboard-dialog-tab-library"></div>').attr("id",t).hide().appendTo("#red-ui-clipboard-dialog-import-tabs-content")),o=RED.library.createBrowser({container:o,onselect:function(e){e&&e.label&&!e.children?$("#red-ui-clipboard-dialog-ok").button("enable"):$("#red-ui-clipboard-dialog-ok").button("disable")},onconfirm:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-ok").trigger("click")}});g(o,e),d[t]=o}),$("#red-ui-clipboard-dialog-tab-library-name").on("keyup",a),$("#red-ui-clipboard-dialog-tab-library-name").on("paste",function(){setTimeout(a,10)}),$("#red-ui-clipboard-dialog-export").button("enable"),b.i18n(),$("#red-ui-clipboard-dialog-ok").show(),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-download").hide(),$("#red-ui-clipboard-dialog-import-conflict").hide(),$("#red-ui-clipboard-dialog-ok").button("disable"),$("#red-ui-clipboard-dialog-import-text").on("keyup",l),$("#red-ui-clipboard-dialog-import-text").on("paste",function(){setTimeout(l,10)}),0===RED.workspaces.active()?($("#red-ui-clipboard-dialog-import-opt-current").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-import-opt-new").addClass("selected")):($("#red-ui-clipboard-dialog-import-opt-current").removeClass("disabled").addClass("selected"),$("#red-ui-clipboard-dialog-import-opt-new").removeClass("selected")),$("#red-ui-clipboard-dialog-import-opt > a").on("click",function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),$("#red-ui-clipboard-dialog-import-file-upload").on("change",function(){var e=new FileReader;e.onload=function(){$("#red-ui-clipboard-dialog-import-text").val(e.result),l()},e.readAsText($(this).prop("files")[0])}),$("#red-ui-clipboard-dialog-import-file-upload-btn").on("click",function(e){e.preventDefault(),$("#red-ui-clipboard-dialog-import-file-upload").trigger("click")}),i.activateTab("red-ui-clipboard-dialog-import-tab-"+e),"clipboard"===e&&setTimeout(function(){$("#red-ui-clipboard-dialog-import-text").trigger("focus")},100),e=400,(t=$(window).height())<600&&(e=400-(600-t)),$(".red-ui-clipboard-dialog-box").height(e),m.dialog("option","title",RED._("clipboard.importNodes")).dialog("option","width",700).dialog("open"),c=RED.popover.create({target:$("#red-ui-clipboard-dialog-import-text"),trigger:"manual",direction:"bottom",content:""}))}function f(e){var i,n,t;o||(e=e||"clipboard",b.empty(),b.append($(r)),(i=RED.tabs.create({id:"red-ui-clipboard-dialog-export-tabs",vertical:!0,onchange:function(e){$("#red-ui-clipboard-dialog-export-tabs-content").children().hide(),$("#"+e.id).show(),s=e.id,"red-ui-clipboard-dialog-export-tab-clipboard"===e.id?($("#red-ui-clipboard-dialog-export").button("option","label",RED._("clipboard.export.copy")),$("#red-ui-clipboard-dialog-download").show(),$("#red-ui-clipboard-dialog-export-tab-library-filename").hide()):($("#red-ui-clipboard-dialog-export").button("option","label",RED._("clipboard.export.export")),$("#red-ui-clipboard-dialog-download").hide(),$("#red-ui-clipboard-dialog-export-tab-library-filename").show(),d[s].focus())}})).addTab({id:"red-ui-clipboard-dialog-export-tab-clipboard",label:RED._("clipboard.clipboard")}),(RED.settings.libraries||[]).forEach(function(e){var t,o;e.readOnly||(t="red-ui-clipboard-dialog-export-tab-library-"+e.id,i.addTab({id:t,label:RED._(e.label||e.id)}),o=$('<div class="red-ui-clipboard-dialog-export-tab-library-browser red-ui-clipboard-dialog-tab-library"></div>').attr("id",t).hide().insertBefore("#red-ui-clipboard-dialog-export-tab-library-filename"),g(o=RED.library.createBrowser({container:o,folderTools:!0,onselect:function(e){e&&e.label&&!e.children&&$("#red-ui-clipboard-dialog-tab-library-name").val(e.label)}}),e),d[t]=o)}),$("#red-ui-clipboard-dialog-tab-library-name").on("keyup",a),$("#red-ui-clipboard-dialog-tab-library-name").on("paste",function(){setTimeout(a,10)}),$("#red-ui-clipboard-dialog-export").button("enable"),(t=RED.tabs.create({id:"red-ui-clipboard-dialog-export-tab-clipboard-tabs",onchange:function(e){$(".red-ui-clipboard-dialog-export-tab-clipboard-tab").hide(),$("#"+e.id).show()}})).addTab({id:"red-ui-clipboard-dialog-export-tab-clipboard-preview",label:RED._("clipboard.exportNodes")}),t.addTab({id:"red-ui-clipboard-dialog-export-tab-clipboard-json",label:RED._("editor.types.json")}),$("#red-ui-clipboard-dialog-export-tab-clipboard-preview-list").css({position:"absolute",top:0,right:0,bottom:0,left:0}).treeList({data:[]}),h(),$("#red-ui-clipboard-dialog-tab-library-name").val("flows.json").select(),b.i18n(),n=RED.settings.flowFilePretty?"red-ui-clipboard-dialog-export-fmt-full":"red-ui-clipboard-dialog-export-fmt-mini",$("#red-ui-clipboard-dialog-export-fmt-group > a").on("click",function(e){var t;e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")?$("#red-ui-clipboard-dialog-export-text").trigger("focus"):($(this).parent().children().removeClass("selected"),$(this).addClass("selected"),0<(e=$("#red-ui-clipboard-dialog-export-text").val()).length&&(t=JSON.parse(e),e="red-ui-clipboard-dialog-export-fmt-full"===(n=$(this).attr("id"))?JSON.stringify(t,null,4):JSON.stringify(t),$("#red-ui-clipboard-dialog-export-text").val(e),setTimeout(function(){$("#red-ui-clipboard-dialog-export-text").scrollTop(0)},50),$("#red-ui-clipboard-dialog-export-text").trigger("focus")))}),$("#red-ui-clipboard-dialog-export-rng-group > a").on("click",function(e){var t,o,i;e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"),t=$(this).attr("id").substring("red-ui-clipboard-dialog-export-rng-".length),e="",o=null,"selected"===t?(0<(i=RED.workspaces.selection()).length?(o=[],i.forEach(function(e){o.push(e),o=(o=o.concat(RED.nodes.groups(e.id))).concat(RED.nodes.filterNodes({z:e.id}))})):o=RED.view.selection().nodes||[],o=RED.nodes.createExportableNodeSet(o.filter(function(e){return"subflow"!==e.type}))):"flow"===t?(i=RED.workspaces.active(),o=(o=RED.nodes.groups(i)).concat(RED.nodes.filterNodes({z:i})),RED.nodes.eachConfig(function(e){e.z===RED.workspaces.active()&&!1===e._def.hasUsers&&o.push(e)}),i=RED.nodes.workspace(i)||RED.nodes.subflow(i),o.unshift(i),o=RED.nodes.createExportableNodeSet(o)):"full"===t&&(o=RED.nodes.createCompleteNodeSet(!1)),0<(e=null!==o?"red-ui-clipboard-dialog-export-fmt-full"===n?JSON.stringify(o,null,4):JSON.stringify(o):e).length?$("#red-ui-clipboard-dialog-export").removeClass("disabled"):$("#red-ui-clipboard-dialog-export").addClass("disabled"),$("#red-ui-clipboard-dialog-export-text").val(e),setTimeout(function(){$("#red-ui-clipboard-dialog-export-text").scrollTop(0),h(t)},50))}),$("#red-ui-clipboard-dialog-ok").hide(),$("#red-ui-clipboard-dialog-cancel").hide(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-import-conflict").hide(),0===RED.workspaces.active()?($("#red-ui-clipboard-dialog-export-rng-selected").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-export-rng-flow").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-export-rng-full").trigger("click")):0<RED.workspaces.selection().length||RED.view.selection().nodes?$("#red-ui-clipboard-dialog-export-rng-selected").trigger("click"):($("#red-ui-clipboard-dialog-export-rng-selected").addClass("disabled").removeClass("selected"),$("#red-ui-clipboard-dialog-export-rng-flow").trigger("click")),("red-ui-clipboard-dialog-export-fmt-full"===n?$("#red-ui-clipboard-dialog-export-fmt-full"):$("#red-ui-clipboard-dialog-export-fmt-mini")).trigger("click"),i.activateTab("red-ui-clipboard-dialog-export-tab-"+e),t=400,(e=$(window).height())<600&&(t=400-(600-e)),$(".red-ui-clipboard-dialog-box").height(t),m.dialog("option","title",RED._("clipboard.exportNodes")).dialog("option","width",700).dialog("open"),$("#red-ui-clipboard-dialog-export-text").trigger("focus"),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").show(),$("#red-ui-clipboard-dialog-download").show(),$("#red-ui-clipboard-dialog-import-conflict").hide())}function h(t){var e=$("#red-ui-clipboard-dialog-export-text").val()||"[]",e=JSON.parse(e),o={},i={},n=[],a=[],r=[],s=(e.forEach(function(e){"tab"===e.type?(o[e.id]={element:R(e),deferBuild:"flow"!==t,expanded:"flow"===t,children:[]},a.push(o[e.id])):"subflow"===e.type?(i[e.id]={element:x(e),deferBuild:!0,children:[]},r.push(i[e.id])):n.push(e)}),[]),d=[],e=(n.forEach(function(e){var t={element:x(e)};e.z?o[e.z]||i[e.z]?o[e.z]?o[e.z].children.push(t):i[e.z]&&i[e.z].children.push(t):d.push(t):s.push(t)}),[]);0<d.length&&(e=e.concat(d)),"flow"===t?e=e.concat(a):0<a.length&&e.push({label:RED._("menu.label.flows"),deferBuild:20<a.length,expanded:a.length<=20,children:a}),0<r.length&&e.push({label:RED._("menu.label.subflows"),deferBuild:10<r.length,expanded:r.length<=10,children:r}),0<s.length&&e.push({label:RED._("sidebar.info.globalConfig"),deferBuild:10<s.length,expanded:s.length<=10,children:s}),$("#red-ui-clipboard-dialog-export-tab-clipboard-preview-list").treeList("data",e)}function g(e,i){var t,o="fa fa-hdd-o";i.icon&&(o=("font-awesome"===(t=RED.utils.separateIconPath(i.icon)).module?"fa ":"")+t.file),e.data([{library:i.id,type:"flows",icon:o,label:RED._(i.label||i.id),path:"",expanded:!0,children:[{library:i.id,type:"flows",icon:"fa fa-cube",label:"flows",path:"",expanded:!0,children:function(t,o){RED.library.loadLibraryFolder(i.id,"flows","",function(e){o.children=e,t(e)})}}]}],!0)}function w(){$("#red-ui-drop-target").hide()}function E(e,t,o){var i,n=!1,a=document.activeElement,r=("string"!=typeof e&&(e=JSON.stringify(e,function(e,t){if(null!==t&&"object"==typeof t&&t.__enc__){if(t.hasOwnProperty("data")&&t.hasOwnProperty("length"))return n=t.data.length!==t.length,t.data;if("function"===t.type||"internal"===t.type)return;if("number"===t.type)return null;if("bigint"===t.type)return t.data.toString();if("undefined"===t.type)return}return t})),n&&(o+="_truncated"),$('<textarea type="text" id="red-ui-clipboard-hidden" tabIndex="-1">').appendTo(document.body)),e=(r.val(e).focus().select(),document.execCommand("copy"));return e&&t&&(i=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(o)}),setTimeout(function(){i.close()},1e3),i.open()),r.remove(),a&&$(a).focus(),e}function D(t,e){var o=t;if("string"==typeof t)try{if(0===(t=t.trim()).length)return;o=JSON.parse(t)}catch(e){t=new Error(RED._("clipboard.invalidFlow",{message:e.message}));throw t.code="NODE_RED",t}var p,f,h,g,t={generateIds:!1,addFlow:e};try{RED.view.importNodes(o,t)}catch(e){p=e.importConfig,f=o,h=t,g=RED.notify("<p>"+RED._("clipboard.import.conflictNotification1")+"</p>",{type:"info",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){g.close()}},{text:RED._("clipboard.import.viewNodes"),click:function(){g.close();var e,t,o,i,n,a,r=p,s=f,c=h,d=[],l=!(v={importConfig:r,importNodes:s,importOptions:c});for(e in r.subflows)r.subflows.hasOwnProperty(e)&&(l||(d.push({gutter:$('<span data-i18n="menu.label.subflows"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),l=!0),t=r.subflows[e],i=r.conflicted[t.id],a=y(t,i,n=!i),o={id:t.id,gutter:a.gutter.element,element:a.element,class:n?"":"disabled",deferBuild:!0,children:[]},d.push(o),r.zMap[e]&&r.zMap[e].forEach(function(e){var t=y(e,r.conflicted[e.id],n,a.gutter.cb);o.children.push({id:e.id,gutter:t.gutter.element,element:t.element,class:n?"":"disabled"})}));for(e in l=!1,r.tabs)r.tabs.hasOwnProperty(e)&&(l||(d.push({gutter:$('<span data-i18n="menu.label.flows"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),l=!0),t=r.tabs[e],i=r.conflicted[t.id],a=y(t,i,n=!0),o={id:t.id,gutter:a.gutter.element,element:a.element,icon:"red-ui-icons red-ui-icons-flow",deferBuild:!0,class:n?"":"disabled",children:[]},d.push(o),r.zMap[e]&&r.zMap[e].forEach(function(e){var t=y(e,r.conflicted[e.id],n,a.gutter.cb);o.children.push({id:e.id,gutter:t.gutter.element,element:t.element,class:n?"":"disabled"})}));l=!1;var u=[];r.all.forEach(function(e){var t,o;"tab"===e.type||"subflow"===e.type||r.tabs[e.z]||r.subflows[e.z]||(o=y(e,t=r.conflicted[e.id],t=!t||!r.configs[e.id]),o={id:e.id,gutter:o.gutter.element,element:o.element,class:t?"":"disabled"},r.configs[e.id]?u.push(o):(l||(d.push({gutter:$('<span data-i18n="menu.label.nodes"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),l=!0),d.push(o)))}),0<u.length&&(d.push({gutter:$('<span data-i18n="menu.label.displayConfig"></span>'),label:"",class:"red-ui-clipboard-dialog-import-conflicts-item-header"}),l=!0,d=d.concat(u)),b.empty(),b.append($(importConflictsDialog)),$("#red-ui-clipboard-dialog-import-conflicts-list").css({position:"absolute",top:0,right:0,bottom:0,left:0}).treeList({data:d}),b.i18n(),s=400,(c=$(window).height())<600&&(s=400-(600-c)),$(".red-ui-clipboard-dialog-box").height(s),$("#red-ui-clipboard-dialog-ok").hide(),$("#red-ui-clipboard-dialog-cancel").show(),$("#red-ui-clipboard-dialog-export").hide(),$("#red-ui-clipboard-dialog-download").hide(),$("#red-ui-clipboard-dialog-import-conflict").show(),m.dialog("option","title",RED._("clipboard.importNodes")).dialog("option","width",500).dialog("open")}},{text:RED._("clipboard.import.importCopy"),click:function(){g.close(),h.generateIds=!0,RED.view.importNodes(f,h)}}]})}}function y(e,t,o,i){var n="tab"===e.type?R(e):x(e),a=$("<div>",{class:"red-ui-clipboard-dialog-import-conflicts-controls"}).appendTo(n);return a.on("click",function(e){e.stopPropagation()}),t&&!i&&(t=$("<label><input "+(o?"":"disabled ")+'type="checkbox" data-node-id="'+e.id+'"> <span data-i18n="clipboard.import.replace"></span></label>').appendTo(a),("tab"===e.type||"subflow"!==e.type&&e.hasOwnProperty("x")&&e.hasOwnProperty("y"))&&t.hide()),{element:n,gutter:function(e,t,o){var i=$("<label>",{class:"red-ui-clipboard-dialog-import-conflicts-gutter"}),e=$('<input data-node-id="'+e.id+'" type="checkbox" '+(t?"checked":"")+">").appendTo(i);o&&(e.attr("disabled",!0),o.addChild(e));i.on("click",function(e){e.stopPropagation()}),e.on("change",function(e){var t=this.checked;i.parent().toggleClass("disabled",!t),i.parent().find('.red-ui-clipboard-dialog-import-conflicts-controls  input[type="checkbox"]').attr("disabled",!t),n.forEach(function(e){e.attr("checked",t),e.trigger("change")})});var n=[];return{cb:{addChild:function(e){n.push(e)}},element:i}}(e,o,i)}}function R(e){(e=JSON.parse(JSON.stringify(e)))._def=RED.nodes.getType(e.type)||{},e._def&&(e._=e._def._);var t=$("<div>",{class:"red-ui-info-outline-item red-ui-info-outline-item-flow"}),o=$("<div>",{class:"red-ui-search-result-description red-ui-info-outline-item-label"}).appendTo(t),e="string"==typeof e?e:e.label,i=e.indexOf("\\n");return-1<i&&(e=e.substring(0,i)+"..."),o.text(e),t}function x(e){(e=JSON.parse(JSON.stringify(e)))._def=RED.nodes.getType(e.type)||{},e._def&&(e._=e._def._);var t=$("<div>",{class:"red-ui-node-list-item"});return RED.utils.createNodeIcon(e,!0).appendTo(t),t}return{init:function(){i(),RED.actions.add("core:show-export-dialog",f),RED.actions.add("core:show-import-dialog",p),RED.actions.add("core:show-library-export-dialog",function(){f("library")}),RED.actions.add("core:show-library-import-dialog",function(){p("library")}),RED.actions.add("core:show-examples-import-dialog",function(){p("examples")}),RED.events.on("editor:open",function(){o=!0}),RED.events.on("editor:close",function(){o=!1}),RED.events.on("search:open",function(){o=!0}),RED.events.on("search:close",function(){o=!1}),RED.events.on("actionList:open",function(){o=!0}),RED.events.on("actionList:close",function(){o=!1}),RED.events.on("type-search:open",function(){o=!0}),RED.events.on("type-search:close",function(){o=!1}),$('<div id="red-ui-drop-target"><div data-i18n="[append]workspace.dropFlowHere"><i class="fa fa-download"></i><br></div></div>').appendTo("#red-ui-editor"),RED.keyboard.add("#red-ui-drop-target","escape",w),$("#red-ui-workspace-chart").on("dragenter",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||$("#red-ui-drop-target").css({display:"table"}).focus()}),$("#red-ui-drop-target").on("dragover",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()}).on("dragleave",function(e){w()}).on("drop",function(e){try{var t,o,i,n;-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)?D(t=(t=e.originalEvent.dataTransfer.getData("text/plain")).substring(t.indexOf("["),t.lastIndexOf("]")+1)):-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||1===(o=e.originalEvent.dataTransfer.files).length&&(i=o[0],(n=new FileReader).onload=function(e){D(e.target.result)},n.readAsText(i))}catch(e){}w(),e.preventDefault()})},import:p,export:f,copyText:E}}(),RED.library=function(){var a,c,r,u,e;function s(i,n,a,t){$.getJSON("library/"+i+"/"+n+"/"+a,function(e){e=e.map(function(e){return"string"==typeof e?{library:i,type:n,icon:"fa fa-folder",label:e,path:a+e+"/",children:function(t,o){s(i,n,a+e+"/",function(e){o.children=e,t(e)})}}:{library:i,type:n,icon:"fa fa-file-o",label:e.fn,path:a+e.fn,props:e}});e.sort(function(e,t){return e.children&&!t.children?-1:!e.children&&t.children?1:e.label.localeCompare(t.label)}),t(e)})}function t(t){e&&clearTimeout(e),e=setTimeout(function(){var e=t.val().trim();0<e.length&&!/[\/\\]/.test(e)?(t.removeClass("input-error"),$("#red-ui-library-dialog-save-button").button("enable")):(t.addClass("input-error"),$("#red-ui-library-dialog-save-button").button("disable"))},100)}return{init:function(){$('<div id="red-ui-library-dialog-save" class="hide"><form class="form-horizontal"><div class="red-ui-library-dialog-box" style="height: 400px; position:relative; "><div id="red-ui-library-dialog-save-browser"></div><div class="form-row"><label data-i18n="clipboard.export.exportAs"></label><input id="red-ui-library-dialog-save-filename" type="text"></div></div></form></div>').appendTo("#red-ui-editor").i18n(),$('<div id="red-ui-library-dialog-load" class="hide"><form class="form-horizontal"><div class="red-ui-library-dialog-box" style="height: 400px; position:relative; "><div id="red-ui-library-dialog-load-panes"><div class="red-ui-panel" id="red-ui-library-dialog-load-browser"></div><div class="red-ui-panel"><div id="red-ui-library-dialog-load-preview"><div class="red-ui-panel" id="red-ui-library-dialog-load-preview-text" style="position:relative; height: 50%; overflow-y: hidden;"></div><div class="red-ui-panel" id="red-ui-library-dialog-load-preview-details"><table id="red-ui-library-dialog-load-preview-details-table" class="red-ui-info-table"></table></div></div></div></div></div></form></div>').appendTo("#red-ui-editor").i18n(),$("#red-ui-library-dialog-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:800,resizable:!1,open:function(e,t){RED.keyboard.disable()},close:function(e,t){RED.keyboard.enable()},classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-library-dialog-save-button",text:RED._("common.label.save"),class:"primary",click:function(){for(var t,e,o=u.elementPrefix||"node-input-",i=$("#"+o+"name").val().trim(),n=(""===i&&(i=RED._("library.unnamedType",{type:u.type})),$("#red-ui-library-dialog-save-filename").val().trim()),a=c.getSelected(),r=(a.children||(a=a.parent),{}),s=0;s<u.fields.length;s++){var d=u.fields[s];"name"===d?r.name=i:"object"==typeof d?r[d.name]=d.get():r[d]=$("#"+o+d).val()}function l(){$.ajax({url:"library/"+a.library+"/"+a.type+"/"+a.path+n,type:"POST",data:JSON.stringify(r),contentType:"application/json; charset=utf-8"}).done(function(e,t,o){RED.notify(RED._("library.savedType",{type:u.type}),"success")}).fail(function(e,t,o){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}r.text=u.editor.getValue(),a.children?(t=!1,a.children.forEach(function(e){e.label===n&&(t=!0)}),t?($("#red-ui-library-dialog-save").dialog("close"),e=RED.notify(RED._("clipboard.export.exists",{file:RED.utils.sanitize(n)}),{type:"warning",fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){e.hideNotification(),$("#red-ui-library-dialog-save").dialog("open")}},{text:RED._("clipboard.export.overwrite"),click:function(){e.hideNotification(),l()}}]})):l()):l(),$(this).dialog("close")}}]}),c=RED.library.createBrowser({container:$("#red-ui-library-dialog-save-browser"),folderTools:!0,onselect:function(e){e.label&&(e.children||($("#red-ui-library-dialog-save-filename").val(e.label),e=e.parent),!1===e.writable?$("#red-ui-library-dialog-save-button").button("disable"):$("#red-ui-library-dialog-save-button").button("enable"))}}),$("#red-ui-library-dialog-save-filename").on("keyup",function(){t($(this))}),$("#red-ui-library-dialog-save-filename").on("paste",function(){var e=$(this);setTimeout(function(){t(e)},10)}),$("#red-ui-library-dialog-load").dialog({modal:!0,autoOpen:!1,width:800,resizable:!1,classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"},buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(selectedLibraryItem){for(var e=u.elementPrefix||"node-input-",t=0;t<u.fields.length;t++){var o,i=u.fields[t];"object"==typeof i?(o=selectedLibraryItem[i.name],i.set(o)):$("#"+e+i).val(selectedLibraryItem[i])}u.editor.setValue(r.getValue(),-1)}$(this).dialog("close")}}],open:function(e){RED.keyboard.disable(),$(this).parent().find(".ui-dialog-titlebar-close").hide(),r.resize()},close:function(e){RED.keyboard.enable(),r&&(r.destroy(),r=null)}}),a=RED.library.createBrowser({container:$("#red-ui-library-dialog-load-browser"),onselect:function(i){var n=$("#red-ui-library-dialog-load-preview-details-table").empty();selectedLibraryItem=i.props,i&&i.label&&!i.children?$.get("library/"+i.library+"/"+i.type+"/"+i.path,function(e){var t,o=$('<tr class="red-ui-help-info-row"><td>Type</td><td></td></tr>').appendTo(n);for(t in $(o.children()[1]).text(u.type),i.props.hasOwnProperty("name")&&(o=$('<tr class="red-ui-help-info-row"><td>Name</td><td>'+i.props.name+"</td></tr>").appendTo(n),$(o.children()[1]).text(i.props.name)),i.props)i.props.hasOwnProperty(t)&&"name"!==t&&"fn"!==t&&(o=$('<tr class="red-ui-help-info-row"><td></td><td></td></tr>').appendTo(n),$(o.children()[0]).text(t),RED.utils.createObjectElement(i.props[t]).appendTo(o.children()[1]));r.setValue(e,-1)}):r.setValue("",-1)}}),RED.panels.create({container:$("#red-ui-library-dialog-load-panes"),dir:"horizontal",resize:function(){r.resize()}}),RED.panels.create({container:$("#red-ui-library-dialog-load-preview"),dir:"vertical",resize:function(){r.resize()}})},create:function(i){var n=i.elementPrefix||"node-input-";i.editor.setText&&(i.editor.setValue=function(e,t){i.editor.setText.call(i.editor,e)}),i.editor.getText&&(i.editor.getValue=i.editor.getText),$("#"+n+"name").css("width","calc(100% - 52px)").after('<div style="margin-left:5px; display: inline-block;position: relative;"><a id="node-input-'+i.type+'-lookup" class="red-ui-button"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a></div>'),RED.menu.init({id:"node-input-"+i.type+"-lookup",options:[{id:"node-input-"+i.type+"-menu-open-library",label:RED._("library.openLibrary"),onselect:function(){var e={id:"red-ui-library-dialog-load-preview-text",mode:i.mode,readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1,contextmenu:!1},t=((r=RED.editor.createEditor(e)).isACE&&(i.mode&&r.getSession().setMode(i.mode),r.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),r.renderer.$cursorLayer.element.style.opacity=0,r.$blockScrolling=1/0),u=i,[]),e=((RED.settings.libraries||[]).forEach(function(e){e.types&&-1===e.types.indexOf(i.url)||t.push({library:e.id,type:i.url,icon:e.icon||"fa fa-hdd-o",label:RED._(e.label||e.id),path:"",expanded:!0,writable:!1,children:[{library:e.id,type:i.url,icon:"fa fa-cube",label:i.type,path:"",expanded:!1,children:function(t,o){s(e.id,i.url,"",function(e){o.children=e,t(e)})}}]})}),a.data(t),setTimeout(function(){a.select(t[0].children[0])},200),400),o=$(window).height();o<570&&(e=400-(570-o)),$("#red-ui-library-dialog-load .red-ui-library-dialog-box").height(e),$("#red-ui-library-dialog-load").dialog("option","title",RED._("library.typeLibrary",{type:i.type})).dialog("open")}},{id:"node-input-"+i.type+"-menu-save-library",label:RED._("library.saveToLibrary"),onselect:function(){u=i;var e=$("#"+n+"name").val().replace(/(^\s*)|(\s*$)/g,"").replace(/[^\w-]/g,"-"),t=(""===e&&(e="unnamed-"+i.type),$("#red-ui-library-dialog-save-filename").attr("value",e+"."+(i.ext||"txt")),[]),e=((RED.settings.libraries||[]).forEach(function(e){e.types&&-1===e.types.indexOf(i.url)||t.push({library:e.id,type:i.url,icon:e.icon||"fa fa-hdd-o",label:RED._(e.label||e.id),path:"",expanded:!0,writable:!1,children:[{library:e.id,type:i.url,icon:"fa fa-cube",label:i.type,path:"",expanded:!1,children:function(t,o){s(e.id,i.url,"",function(e){o.children=e,t(e)})}}]})}),c.data(t),setTimeout(function(){c.select(t[0].children[0])},200),400),o=$(window).height();o<570&&(e=400-(570-o)),$("#red-ui-library-dialog-save .red-ui-library-dialog-box").height(e),$("#red-ui-library-dialog-save").dialog("open")}}]})},createBrowser:function(o){var e=$('<div class="red-ui-library-browser"></div>').appendTo(o.container),i=$("<div>").css({width:"100%",height:"100%"}).appendTo(e).treeList({}).on("treelistselect",function(e,t){o.onselect&&o.onselect(t)}).on("treelistconfirm",function(e,t){o.onconfirm&&o.onconfirm(t)}),n=$("<div>").css({position:"absolute",bottom:"6px",right:"8px"}),a=$('<button class="red-ui-button red-ui-button-small" type="button"><i class="fa fa-ellipsis-h"></i></button>').on("click",function(e){e.preventDefault(),e.stopPropagation();var e=a.offset(),t=RED.menu.init({id:"red-ui-library-browser-menu",options:[{id:"red-ui-library-browser-menu-addFolder",label:RED._("library.newFolder"),onselect:function(){var o="new-folder",r={},s=i.treeList("selected");(s=s.children?s:s.parent).treeList.expand(function(){s.children.forEach(function(e){/^new-folder/.test(e.label)&&(r[e.label]=!0)});for(var e=2;r[o];)o="new-folder-"+e++;s.treeList.expand();function t(){var e=n.val().trim();if(""!==e){for(var t=0;t<s.children.length;t++)if(s.children[t].label===e)return i(),0;a.treeList.remove();var o={library:s.library,type:s.type,icon:"fa fa-folder",children:[],label:e,path:a.path+e+"/"};s.treeList.addChild(o,!0)}else i()}function i(){a.treeList.remove()}var n=$('<input type="text" class="red-ui-treeList-input">').val(o),a={icon:"fa fa-folder-o",children:[],path:s.path,element:n};n.on("keydown",function(e){e.stopPropagation(),13===e.keyCode?t():27===e.keyCode&&i()}),n.on("blur",function(){t()}),s.treeList.addChild(a),setTimeout(function(){n.trigger("focus"),n.select()},400)})}}]}).on("mouseleave",function(){$(this).remove(),i.focus()}).on("mouseup",function(){var e=$(this);e.hide(),i.focus(),setTimeout(function(){e.remove()},100)}).appendTo("body");t.css({position:"absolute",top:e.top+"px",left:e.left-t.width()+20+"px"}).show()}).appendTo(n);return o.folderTools&&i.on("treelistselect",function(e,t){!1!==t.writable&&t.treeList&&n.appendTo(t.treeList.label)}),{select:function(e){i.treeList("select",e)},getSelected:function(){return i.treeList("selected")},focus:function(){i.focus()},data:function(e,t){i.treeList("data",e),t&&setTimeout(function(){i.treeList("select",e[0])},100)}}},export:function(){console.warn("Deprecated call to RED.library.export")},loadLibraryFolder:s}}(),RED.notifications=function(){var e,m,b={},v={show:function(){e++,$("#red-ui-full-shade").show()},hide:function(){0===--e&&$("#red-ui-full-shade").hide()}},y=[],w=e=0;function t(e,n,a,c){var r={};if(null!==n&&"object"==typeof n?(a=(r=n).fixed,c=r.timeout,n=r.type):(r.type=n,r.fixed=a,r.timeout=r.timeout),r.id&&b.hasOwnProperty(r.id))return b[r.id].update(e,r),b[r.id];if(r.modal&&v.show(),4<y.length)for(var u=y.length,p=0;4<u&&p<y.length;p+=1){var f=y[p];f.fixed||(window.clearTimeout(f.timeoutid),f.close(),--u)}var t,h,o,i,s,d,g,l=document.createElement("div");return l.id="red-ui-notification-"+w,l.className="red-ui-notification",l.options=r,l.fixed=a,n&&(l.className="red-ui-notification red-ui-notification-"+n),r.width&&(t=$("#red-ui-notifications").width(),r.width>t&&(t=-(r.width-t)/2,$(l).css({width:r.width+"px",marginLeft:t+"px"}))),l.style.display="none","string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),l.innerHTML=e):$(l).append(e),r.buttons&&(h=$('<div class="ui-dialog-buttonset"></div>').appendTo(l),r.buttons.forEach(function(e){var t=$("<button>").html(e.text).on("click",e.click).appendTo(h);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})),$("#red-ui-notifications").append(l),RED.notifications.hide||$(l).slideDown(300),l.close=(o=l,function(){o.closed||(o.closed=!0,y.splice(y.indexOf(o),1),r.id&&(delete b[r.id],0===Object.keys(b).length&&m.hide()),RED.notifications.hide?o.parentNode.removeChild(o):$(o).slideUp(300,function(){o.parentNode.removeChild(o)}),o.options.modal&&v.hide())}),l.hideNotification=(i=l,function(){i.closed||(i.hidden=!0,RED.notifications.hide||$(i).slideUp(300))}),l.showNotification=(s=l,function(){!s.closed&&s.hidden&&(s.hidden=!1,RED.notifications.hide||$(s).slideDown(300))}),l.update=(d=l,function(e,t){var o,i;"string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),d.innerHTML=e):$(d).empty().append(e),"number"==typeof t?d.options.timeout=o=t:void 0!==t&&(!r.modal&&t.modal?(d.options.modal=!0,v.show()):r.modal&&!1===t.modal&&(d.options.modal=!1,v.hide()),(e=t.hasOwnProperty("type")?t.type:n)&&(l.className="red-ui-notification red-ui-notification-"+e),a&&!1!==t.fixed||(o=(t.hasOwnProperty("timeout")?t.timeout:c)||5e3),t.buttons&&(i=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(d),t.buttons.forEach(function(e){var t=$("<button>").text(e.text).on("click",e.click).appendTo(i);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)}))),$(d).off("click.red-ui-notification-close"),void 0!==o&&0<o?(window.clearTimeout(d.timeoutid),d.timeoutid=window.setTimeout(d.close,o),setTimeout(function(){$(d).on("click.red-ui-notification-close",function(){d.close(),window.clearTimeout(d.timeoutid)})},50)):window.clearTimeout(d.timeoutid),d.hidden?d.showNotification():t&&t.silent||($(d).addClass("red-ui-notification-shake-horizontal"),setTimeout(function(){$(d).removeClass("red-ui-notification-shake-horizontal")},300))}),a||($(l).on("click.red-ui-notification-close",(g=l,function(){g.close(),window.clearTimeout(g.timeoutid)})),l.timeoutid=window.setTimeout(l.close,c||5e3)),y.push(l),r.id&&(b[r.id]=l,r.fixed&&m.show()),w+=1,l}return{init:function(){$('<div id="red-ui-notifications"></div>').appendTo("#red-ui-editor"),m=$("<li></li>").prependTo(".red-ui-header-toolbar").hide(),$('<a class="button" href="#"><i class="fa fa-warning"></i></a>').appendTo(m).on("click",function(){for(var e in b)b.hasOwnProperty(e)&&b[e].showNotification()})},notify:RED.notify=t}}(),RED.search=function(){var r,s,u,o=!1,n=null,a=-1,p=!1,d=[],m={},l=[];function f(t,o,e){if("string"==typeof e||"number"==typeof e)e=(""+e).toLowerCase(),m[e]=m[e]||{},m[e][t.id]={node:t,label:o};else if(Array.isArray(e))e.forEach(function(e){f(t,o,e)});else if("object"==typeof e)for(var i in e)e.hasOwnProperty(i)&&f(t,o,e[i])}function b(e,t,o){var i=new RegExp("(?:^| )is:"+t+"(?: |$)");return i.exec(e)&&(e=e.replace(i," ").trim(),o[t]=!0),e}function h(e){var t,c=[],o=[],i=/(?:^| )type:([^ ]+)/.exec(e),n=(i&&(e=e.replace(/(?:^| )type:[^ ]+/,""),t=i[1]),{}),i=(e=b(e,"invalid",n),e=b(e,"unused",n),e=b(e,"config",n),e=b(e,"subflow",n),e=function(e,t,o){for(var i,n=new RegExp("(?:^| )"+t+":([^ ]+)(?: |$)");i=n.exec(e);)e=e.replace(n," ").trim(),o[t]=o[t]||[],o[t].push(i[1]);return e}(e=b(e,"hidden",n),"uses",n),0<Object.keys(n).length);if(0<(e=e.trim()).length||t||i){e=e.toLowerCase();for(var a=[],r={},o=n.uses||Object.keys(m),s=0;s<o.length;s++){var d=o[s],u=o[s].indexOf(e);if(-1<u)for(var p=Object.keys(m[d]),f=0;f<p.length;f++){var l=m[d][p[f]],h="config"===l.node._def.category&&"group"!==l.node.type;if(!n.uses||d!==l.node.id){if(n.hasOwnProperty("invalid")){var g=!l.node.hasOwnProperty("valid")||l.node.valid;if(n.invalid===g)continue}if(!(n.hasOwnProperty("config")&&n.config!==h||n.hasOwnProperty("subflow")&&n.subflow!==("subflow"===l.node.type))){if(n.hasOwnProperty("hidden")){if("tab"!==l.node.type)continue;if(!RED.workspaces.isHidden(l.node.id))continue}if(n.hasOwnProperty("unused")){g="subflow"===l.node.type&&0===l.node.instances.length||h&&0===l.node.users.length;if(n.unused!==g)continue}t&&l.node.type!==t||(r[l.node.id]=r[l.node.id]={node:l.node,label:l.label},r[l.node.id].index=Math.min(r[l.node.id].index||1/0,u))}}}}for((a=Object.keys(r)).sort(function(e,t){return r[e].index-r[t].index}),s=0;s<a.length;s++)c.push(r[a[s]])}return c}function g(){var e,t,o,i=s.find("li.selected");1===i.length&&(t=(e=s.parent()).height(),e.scrollTop(),t<(o=i.position().top)+(i=i.height())?e.animate({scrollTop:"-="+(t-(o+i)-10)},50):o<0&&e.animate({scrollTop:"+="+(o-10)},50))}function v(){0<d.length&&(s.editableList("addItem",{historyHeader:!0}),d.forEach(function(e){s.editableList("addItem",{history:!0,value:e})}))}function y(e){var t=r.val(),t=d.indexOf(t);-1<t&&d.splice(t,1),d.unshift(r.val()),c(),RED.view.reveal(e.id)}function e(e){var t;o||(p||(u=document.activeElement,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-sidebar-separator").hide(),null===n?(n=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#red-ui-main-container"),t=$("<div>",{class:"red-ui-search-container"}).appendTo(n),r=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(t).searchBox({delay:200,change:function(){s.editableList("empty"),a=-1;var e=$(this).val();if(""!==e)if(0<(l=h(e)).length){for(i=0;i<Math.min(l.length,25);i++)s.editableList("addItem",l[i]);25<l.length&&s.editableList("addItem",{more:{results:l,start:25}})}else s.editableList("addItem",{});else v()}}),$('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-caret-right"></button>').appendTo(t).on("click",function(e){e.preventDefault(),RED.sidebar.info.outliner.search(r.val()),c()}),r.on("keydown",function(e){if(0<l.length)if(40===e.keyCode)o=s.children(),a<o.length-1&&(-1<a&&$(o[a]).removeClass("selected"),a++),$(o[a]).addClass("selected"),g(),e.preventDefault();else if(38===e.keyCode)o=s.children(),0<a&&(a<o.length&&$(o[a]).removeClass("selected"),a--),$(o[a]).addClass("selected"),g(),e.preventDefault();else if(13===e.keyCode){var t,o=s.children();if($(o[a]).hasClass("red-ui-search-more"))if(t=$(o[a]).find(".red-ui-editableList-item-content").data("data")){for(s.editableList("removeItem",t),i=t.more.start;i<Math.min(l.length,t.more.start+25);i++)s.editableList("addItem",l[i]);l.length>t.more.start+25&&s.editableList("addItem",{more:{results:l,start:t.more.start+25}})}$(o[a]).hasClass("red-ui-search-history")?(t=$(o[a]).find(".red-ui-editableList-item-content").data("data"))&&r.searchBox("value",t.value):$(o[a]).hasClass("red-ui-search-historyHeader")||0<l.length&&y(l[Math.max(0,a)].node)}}),r.i18n(),t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(n),s=$("<ol>",{style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(t).editableList({addButton:!1,addItem:function(e,t,o){var i,n,a=o.node;o.historyHeader?(e.parent().addClass("red-ui-search-historyHeader"),$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.history")).appendTo(e),$('<button type="button" class="red-ui-button red-ui-button-small"></button>').text(RED._("search.clear")).appendTo(e).on("click",function(e){e.preventDefault(),d=[],s.editableList("empty")})):o.history?(e.parent().addClass("red-ui-search-history"),(i=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e)).text(o.value),i.on("click",function(e){e.preventDefault(),r.searchBox("value",o.value),r.focus()}),$('<button type="button" class="red-ui-button red-ui-button-small"><i class="fa fa-remove"></i></button>').appendTo(e).on("click",function(e){e.preventDefault();e=d.indexOf(o.value);d.splice(e,1),s.editableList("removeItem",o)})):o.more?(e.parent().addClass("red-ui-search-more"),(i=$("<a>",{href:"#",class:"red-ui-search-result red-ui-search-empty"}).appendTo(e)).text(RED._("palette.editor.more",{count:o.more.results.length-o.more.start})),i.on("click",function(e){for(e.preventDefault(),s.editableList("removeItem",o),t=o.more.start;t<Math.min(l.length,o.more.start+25);t++)s.editableList("addItem",l[t]);l.length>o.more.start+25&&s.editableList("addItem",{more:{results:l,start:o.more.start+25}})})):void 0===a?$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e):(a._def,i=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),RED.utils.createNodeIcon(a).appendTo(i),e=$("<div>",{class:"red-ui-search-result-node-description"}).appendTo(i),a.z&&(n=(n=RED.nodes.workspace(a.z))?"flow:"+n.label:"subflow:"+(n=RED.nodes.subflow(a.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).text(n).appendTo(e)),$("<div>",{class:"red-ui-search-result-node-label"}).text(o.label||a.id).appendTo(e),$("<div>",{class:"red-ui-search-result-node-type"}).text(a.type).appendTo(e),$("<div>",{class:"red-ui-search-result-node-id"}).text(a.id).appendTo(e),i.on("click",function(e){e.preventDefault(),y(a)}))},scrollOnAdd:!1})):s.editableList("empty"),n.slideDown(300),r.searchBox("value",e),e&&""!==e||v(),RED.events.emit("search:open"),p=!0),r.trigger("focus"))}function c(){p&&(p=!1,$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-sidebar-separator").show(),null!==n&&n.slideUp(200,function(){r.searchBox("value","")}),RED.events.emit("search:close"),u&&($(u).trigger("focus"),u=null))}function t(){m={}}function w(e){{var t=e,o=RED.utils.getNodeLabel(t),i=(o&&(o=(""+o).toLowerCase(),m[o]=m[o]||{},m[o][t.id]={node:t,label:o}),o=o||t.label||t.name||t.id||"",["id","type","name","label","info"]);const r=t&&t._def;if(r&&(r.defaults&&(i=i.concat(Object.keys(r.defaults))),"group"!==t.type&&r.paletteLabel&&r.paletteLabel!==r.type))try{var n=(""+("function"==typeof r.paletteLabel?r.paletteLabel.call(r):r.paletteLabel)).toLowerCase();n&&n!==(""+r.type).toLowerCase()&&f(t,o,n)}catch(e){console.warn("error indexing "+o,e)}for(var a=0;a<i.length;a++)t.hasOwnProperty(i[a])&&("group"===t.type&&"nodes"===i[a]||f(t,o,t[i[a]]));return}}function E(e){for(var t=Object.keys(m),o=0,i=t.length;o<i;o++)delete m[t[o]][e.id],0===Object.keys(m[t[o]]).length&&delete m[t[o]]}function D(e){E(e),w(e)}return{init:function(){RED.actions.add("core:search",e),RED.events.on("editor:open",function(){o=!0}),RED.events.on("editor:close",function(){o=!1}),RED.events.on("type-search:open",function(){o=!0}),RED.events.on("type-search:close",function(){o=!1}),RED.events.on("actionList:open",function(){o=!0}),RED.events.on("actionList:close",function(){o=!1}),RED.keyboard.add("red-ui-search","escape",c),$("#red-ui-header-shade").on("mousedown",c),$("#red-ui-editor-shade").on("mousedown",c),$("#red-ui-palette-shade").on("mousedown",c),$("#red-ui-sidebar-shade").on("mousedown",c),RED.events.on("workspace:clear",t),RED.events.on("flows:add",w),RED.events.on("flows:remove",E),RED.events.on("flows:change",D),RED.events.on("subflows:add",w),RED.events.on("subflows:remove",E),RED.events.on("subflows:change",D),RED.events.on("nodes:add",w),RED.events.on("nodes:remove",E),RED.events.on("nodes:change",D),RED.events.on("groups:add",w),RED.events.on("groups:remove",E),RED.events.on("groups:change",D)},show:e,hide:c,search:h}}(),RED.actionList=function(){var o,n,i,a=!1,r=null,s=!1,d="",l=[];function c(){var e,t,o,i=n.find("li.selected");1===i.length&&(t=(e=n.parent()).height(),e.scrollTop(),t<(o=i.position().top)+(i=i.height())?e.animate({scrollTop:"-="+(t-(o+i)-10)},50):o<0&&e.animate({scrollTop:"+="+(o-10)},50))}function u(e){t(),e&&RED.actions.invoke(e.id)}function e(e){var t;a||(s||(i=document.activeElement,$("#red-ui-header-shade").show(),$("#red-ui-editor-shade").show(),$("#red-ui-palette-shade").show(),$("#red-ui-sidebar-shade").show(),$("#red-ui-sidebar-separator").hide(),null===r&&(r=$("<div>",{id:"red-ui-actionList",class:"red-ui-search"}).appendTo("#red-ui-main-container"),t=$("<div>",{class:"red-ui-search-container"}).appendTo(r),(o=$('<input type="text" data-i18n="[placeholder]keyboard.filterActions">').appendTo(t).searchBox({change:function(){d=$(this).val().trim(),l=d.split(" "),n.editableList("filter"),n.find("li.selected").removeClass("selected");var e=n.children(":visible");e.length&&$(e[0]).addClass("selected")}})).on("keydown",function(e){var t,o,i;40===e.keyCode?((o=n.find("li.selected")).length?(i=o.nextAll(":visible").first()).length&&(o.removeClass("selected"),i.addClass("selected")):(t=n.children(":visible")).length&&$(t[0]).addClass("selected"),c(),e.preventDefault()):38===e.keyCode?((i=(o=n.find("li.selected")).prevAll(":visible").first()).length&&(o.removeClass("selected"),i.addClass("selected")),c(),e.preventDefault()):13===e.keyCode&&(o=n.find("li.selected"),u(n.editableList("getItem",o)))}),o.i18n(),t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(r),n=$("<ol>",{style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(t).editableList({addButton:!1,addItem:function(e,t,o){var i;void 0===o.id?$("<div>",{class:"red-ui-search-empty"}).text(RED._("search.empty")).appendTo(e):(e=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),i=$("<div>",{class:"red-ui-search-result-action"}).appendTo(e),$("<div>").text(o.label).appendTo(i),o.key&&$("<div>",{class:"red-ui-search-result-action-key"}).html(RED.keyboard.formatKey(o.key)).appendTo(i),e.on("click",function(e){e.preventDefault(),u(o)}))},scrollOnAdd:!1,filter:function(e){if(""===d)return!0;for(var t=0,o=0;o<l.length;o++){var i=e._label.indexOf(l[o],t);if(!(-1<i))return!1;t=i}return!0}})),r.slideDown(300),o.searchBox("value",e),n.editableList("empty"),results=[],(t=RED.actions.list()).sort(function(e,t){e=e.label,t=t.label;return e.localeCompare(t)}),t.forEach(function(e){e._label=e.label.toLowerCase(),n.editableList("addItem",e)}),RED.events.emit("actionList:open"),s=!0),o.trigger("focus"),(e=n.children(":visible")).length&&$(e[0]).addClass("selected"))}function t(){s&&(s=!1,$("#red-ui-header-shade").hide(),$("#red-ui-editor-shade").hide(),$("#red-ui-palette-shade").hide(),$("#red-ui-sidebar-shade").hide(),$("#red-ui-sidebar-separator").show(),null!==r&&r.slideUp(200,function(){o.searchBox("value","")}),RED.events.emit("actionList:close"),i&&($(i).trigger("focus"),i=null))}return{init:function(){RED.actions.add("core:show-action-list",e),RED.events.on("editor:open",function(){a=!0}),RED.events.on("editor:close",function(){a=!1}),RED.events.on("search:open",function(){a=!0}),RED.events.on("search:close",function(){a=!1}),RED.events.on("type-search:open",function(){a=!0}),RED.events.on("type-search:close",function(){a=!1}),RED.keyboard.add("red-ui-actionList","escape",function(){t()}),$("#red-ui-header-shade").on("mousedown",t),$("#red-ui-editor-shade").on("mousedown",t),$("#red-ui-palette-shade").on("mousedown",t),$("#red-ui-sidebar-shade").on("mousedown",t)},show:e,hide:t}}(),RED.typeSearch=function(){var d,l,t,s,o,p,i=null,c=-1,n=!1,a="",u={};function f(){var e,t,o,i=l.find("li.selected");1===i.length&&(t=(e=l.parent()).height(),e.scrollTop(),t<(o=i.position().top)+(i=i.height())?e.animate({scrollTop:"-="+(t-(o+i)-10)},50):o<0&&e.animate({scrollTop:"+="+(o-10)},50))}function r(e,t){var o=i.position();o.top=o.top+t+"px",o.left=o.left+e+"px",i.css(o),p(e,t)}function h(){i=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#red-ui-main-container");var e=$("<div>",{class:"red-ui-search-container"}).appendTo(i);(d=$('<input type="text" id="red-ui-type-search-input">').attr("placeholder",RED._("search.addNode")).appendTo(e).searchBox({delay:50,change:function(){var e;e=$(this).val(),a=e.toLowerCase(),l.editableList("filter"),l.editableList("sort"),setTimeout(function(){c=0,l.children().removeClass("selected"),l.children(":visible:first").addClass("selected")},100)}})).on("keydown",function(e){var t,o,i=l.children(":visible");40===e.keyCode&&e.shiftKey?(e.preventDefault(),r(0,10)):38===e.keyCode&&e.shiftKey?(e.preventDefault(),r(0,-10)):39===e.keyCode&&e.shiftKey?(e.preventDefault(),r(10,0)):37===e.keyCode&&e.shiftKey?(e.preventDefault(),r(-10,0)):0<i.length?40===e.keyCode?(c<i.length-1&&(-1<c&&$(i[c]).removeClass("selected"),c++),$(i[c]).addClass("selected"),f(),e.preventDefault()):38===e.keyCode?(0<c&&(c<i.length&&$(i[c]).removeClass("selected"),c--),$(i[c]).addClass("selected"),f(),e.preventDefault()):(e.metaKey||e.ctrlKey)&&13===e.keyCode?(e.preventDefault(),(o=Math.max(0,c))<i.length&&(t=$(i[o]).find(".red-ui-editableList-item-content").data("data"),u[t.type]=Date.now(),0===t.def.outputs?g(t):s(t.type,!0),$("#red-ui-type-search-input").val("").trigger("keyup"),setTimeout(function(){$("#red-ui-type-search-input").focus()},100))):13===e.keyCode&&(e.preventDefault(),(o=Math.max(0,c))<i.length&&g($(i[o]).find(".red-ui-editableList-item-content").data("data"))):13===e.keyCode&&(e.stopPropagation(),e.preventDefault())}),t=$("<div>",{class:"red-ui-search-results-container"}).appendTo(i),l=$("<ol>",{style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(t).editableList({addButton:!1,filter:function(e){return""===a||!e.recent&&!e.common&&(""===a||-1<e.index.indexOf(a))},sort:function(e,t){if(""===a)return e.i-t.i;var o=e.index.indexOf(a),i=t.index.indexOf(a);return-1===o?1:-1===i?-1:o===i?y(e,t):o-i},addItem:function(e,t,o){var i=o.def,e=(o.index=o.type.toLowerCase(),o.separator&&e.addClass("red-ui-search-result-separator"),$("<div>",{class:"red-ui-search-result"}).appendTo(e)),n=$("<div>",{class:"red-ui-search-result-node"}).appendTo(e),a=RED.utils.getNodeColor(o.type,i),r=RED.utils.getNodeIcon(i),a=(n.css("backgroundColor",a),$("<div/>",{class:"red-ui-palette-icon-container"}).appendTo(n)),r=(RED.utils.createIconElement(r,a,!1),0<i.inputs&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(n),0<i.outputs&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(n),$("<div>",{class:"red-ui-search-result-description"}).appendTo(e)),a=o.label;o.index+="|"+a.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).text(a).appendTo(r),e.on("click",function(e){e.preventDefault(),g(o)})},scrollOnAdd:!1})}function g(e){b(),u[e.type]=Date.now(),s(e.type)}function m(e){if(n){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}b(!0),o&&o()}}function b(e){n&&(n=!1,null!==i&&t.slideUp(e?50:200,function(){i.hide(),d.searchBox("value","")}),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.red-ui-type-search"),$(document).off("mouseup.red-ui-type-search"),$(document).off("click.red-ui-type-search"),$(document).off("touchstart.red-ui-type-search"))}function v(t,e){var o=t;if(void 0!==e.paletteLabel)try{o=("function"==typeof e.paletteLabel?e.paletteLabel.call(e):e.paletteLabel)||"",o+=" ("+t+")"}catch(e){console.log("Definition error: "+t+".paletteLabel",e)}return o}function y(e,t){e=e.label.toLowerCase(),t=t.label.toLowerCase();return e<t?-1:e===t?0:1}function w(e,t,o){return!e||(!e.type||t===e.type)&&(!e.input||0<o.inputs)&&(!e.output||0<o.outputs)}function E(t){l.editableList("empty"),d.searchBox("value","").focus(),c=-1;for(var e,o=["inject","debug","function","change","switch"].filter(function(e){return w(t.filter,e,RED.nodes.getType(e))}),i=Object.keys(u),n=(i.sort(function(e,t){return u[t]-u[e]}),i=i.filter(function(e){return w(t.filter,e,RED.nodes.getType(e))&&-1===o.indexOf(e)}),[]),a=(RED.nodes.registry.getNodeTypes().forEach(function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&n.push({type:e,def:t,label:v(e,t)})}),n.sort(y),0),r=0;r<o.length;r++){var s=RED.nodes.getType(o[r]);s&&((e={type:o[r],common:!0,def:s,i:a++}).label=v(e.type,e.def),r===o.length-1&&(e.separator=!0),l.editableList("addItem",e))}for(r=0;r<Math.min(5,i.length);r++)(e={type:i[r],def:RED.nodes.getType(i[r]),recent:!0,i:a++}).label=v(e.type,e.def),r===i.length-1&&(e.separator=!0),l.editableList("addItem",e);for(r=0;r<n.length;r++)w(t.filter,n[r].type,n[r].def)&&(n[r].i=a++,l.editableList("addItem",n[r]));setTimeout(function(){c=0,l.children(":first").addClass("selected")},100)}return{show:function(e){n?(i.hide(),t.hide()):(null===i&&(h(),RED.keyboard.add("red-ui-type-search","escape",function(){b(),o&&o()})),n=!0),$(document).off("mousedown.red-ui-type-search"),$(document).off("mouseup.red-ui-type-search"),$(document).off("click.red-ui-type-search"),$(document).off("touchstart.red-ui-type-search"),$(document).off("mousedown.red-ui-type-search"),setTimeout(function(){$(document).on("mousedown.red-ui-type-search",m),$(document).on("mouseup.red-ui-type-search",m),$(document).on("click.red-ui-type-search",m),$(document).on("touchstart.red-ui-type-search",m)},200),E(e),s=e.add,o=e.cancel,p=e.move,RED.events.emit("type-search:open"),$("#red-ui-main-container").height()-e.y-150<0&&(e.y=e.y-235),i.css({left:e.x+"px",top:e.y+"px"}).show(),t.slideDown(300),setTimeout(function(){t.find(".red-ui-editableList-container").scrollTop(0),e.disableFocus||d.trigger("focus")},200)},refresh:E,hide:b}}(),RED.subflow=function(){function r(e,t){var o={x:50,y:30},i=(t||(o.x+=110),[].concat(e.out).concat(e.in));e.status&&i.push(e.status),i.sort(function(e,t){return e.x-t.x});for(var n=0;n<i.length;n++){var a=i[n];a.x==o.x&&a.y==o.y&&(o.x+=55)}return o}function n(){var t,o,i=RED.nodes.subflow(RED.workspaces.active());if(0!==i.in.length)return t=i.in[0],o=[],RED.nodes.eachLink(function(e){("subflow"==e.source.type&&e.source.z==i.id&&e.source.i==t.i||e.target.type=="subflow:"+i.id)&&o.push(e)}),o.forEach(function(e){RED.nodes.removeLink(e)}),i.in=[],$("#red-ui-subflow-input-add").removeClass("active"),$("#red-ui-subflow-input-remove").addClass("active"),i.changed=!0,RED.events.emit("subflows:change",i),{subflowInputs:[t],links:o}}function s(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){var o=[];for((e=void 0===e?[t.out[t.out.length-1]]:e).sort(function(e,t){return t.i-e.i}),i=0;i<e.length;i++){var n=e[i],a=(t.out.splice(n.i,1),[]),r=[];RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==n.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==n.i?a.push(e):e.sourcePort>n.i&&r.push(e))}),a.forEach(function(e){RED.nodes.removeLink(e)}),r.forEach(function(e){e.sourcePort--});for(var o=o.concat(a),s=n.i;s<t.out.length;s++)t.out[s].i--,t.out[s].dirty=!0}return t.changed=!0,RED.events.emit("subflows:change",t),{subflowOutputs:e,links:o}}}function d(){var t,o=RED.nodes.subflow(RED.workspaces.active());if(o.status)return t=[],RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==o.id&&"status"==e.target.direction&&t.push(e)}),t.forEach(function(e){RED.nodes.removeLink(e)}),delete o.status,$("#red-ui-subflow-status").prop("checked",!!o.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!o.status),{links:t}}function l(t){var o=RED.nodes.subflow(RED.workspaces.active()),i=(c(o),[]);if(o)return RED.nodes.filterNodes({type:"subflow:"+o.id}).forEach(function(e){i.push({id:e.id,changed:e.changed}),t&&(e.changed=!0),e.inputs=o.in.length,e.outputs=o.out.length,e.resize=!0,e.dirty=!0,RED.editor.updateNodeProperties(e)}),RED.editor.validateNode(o),{instances:i}}function c(e){e&&($("#red-ui-subflow-input-add").toggleClass("active",0!==e.in.length),$("#red-ui-subflow-input-remove").toggleClass("active",0===e.in.length),$("#red-ui-subflow-output .spinner-value").text(e.out.length),$("#red-ui-subflow-status").prop("checked",!!e.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!e.status))}function o(a){var e=$("#red-ui-workspace-toolbar");e.empty(),$('<a class="button" id="red-ui-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="red-ui-subflow-input-remove" class="button active" href="#">0</a><a id="red-ui-subflow-input-add" class="button" href="#">1</a></div>').appendTo(e),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="red-ui-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="red-ui-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="red-ui-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(e),$('<span class="button-group"><span class="button" style="padding:0"><label for="red-ui-subflow-status"><input id="red-ui-subflow-status" type="checkbox"> <span data-i18n="subflow.status"></span></label></span></span>').appendTo(e),$('<a class="button" id="red-ui-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(e),e.i18n(),$("#red-ui-subflow-output-remove").on("click",function(e){e.preventDefault();var t,e=RED.nodes.dirty(),o=a.changed,i=s();i&&(t=l(!0),RED.history.push({t:"delete",links:i.links,subflowOutputs:i.subflowOutputs,changed:o,dirty:e,subflow:{instances:t.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0))}),$("#red-ui-subflow-output-add").on("click",function(e){var t,o,i,n;e.preventDefault(),e=RED.nodes.subflow(RED.workspaces.active()),t=r(e,!1),t={type:"subflow",direction:"out",z:e.id,i:e.out.length,x:t.x,y:t.y,id:RED.nodes.id()},o=e.out.length,e.out.push(t),e.dirty=!0,t=RED.nodes.dirty(),i=e.changed,n=l(e.changed=!0),t={t:"edit",node:e,dirty:t,changed:i,subflow:{outputCount:o,instances:n.instances}},RED.history.push(t),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#red-ui-subflow-output .spinner-value").text(e.out.length),RED.events.emit("subflows:change",e)}),$("#red-ui-subflow-input-add").on("click",function(e){var t,o,i,n;e.preventDefault(),1!==(e=RED.nodes.subflow(RED.workspaces.active())).in.length&&(n=r(e,!0),n={type:"subflow",direction:"in",z:e.id,i:e.in.length,x:n.x,y:n.y,id:RED.nodes.id()},t=e.in.length,e.in.push(n),e.dirty=!0,n=RED.nodes.dirty(),o=e.changed,i=l(e.changed=!0),n={t:"edit",node:e,dirty:n,changed:o,subflow:{inputCount:t,instances:i.instances}},RED.history.push(n),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#red-ui-subflow-input-add").addClass("active"),$("#red-ui-subflow-input-remove").removeClass("active"),RED.events.emit("subflows:change",e))}),$("#red-ui-subflow-input-remove").on("click",function(e){e.preventDefault();var t,e=RED.nodes.dirty(),o=a.changed,i=(a.changed=!0,n());i&&(t=l(!0),RED.history.push({t:"delete",links:i.links,changed:o,subflowInputs:i.subflowInputs,dirty:e,subflow:{instances:t.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0))}),$("#red-ui-subflow-status").on("change",function(e){var t,o,i,n;this.checked?(n=RED.nodes.subflow(RED.workspaces.active())).status||(o=r(n,!1),o={type:"subflow",direction:"status",z:n.id,x:o.x,y:o.y,id:RED.nodes.id()},n.status=o,n.dirty=!0,o=RED.nodes.dirty(),i=n.changed,l(n.changed=!0),RED.history.push({t:"edit",node:n,dirty:o,changed:i,subflow:{status:!0}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),RED.events.emit("subflows:change",n),$("#red-ui-subflow-status").prop("checked",!!n.status),$("#red-ui-subflow-status").parent().parent().toggleClass("active",!!n.status)):(o=a.status,i=a.changed,(n=d())&&(a.changed=!0,t=RED.nodes.dirty(),RED.history.push({t:"delete",links:n.links,changed:i,dirty:t,subflow:{id:a.id,status:o}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw()))}),$("#red-ui-subflow-edit").on("click",function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()}),$("#red-ui-subflow-delete").on("click",function(e){e.preventDefault();var t,o,e=RED.nodes.subflow(RED.workspaces.active());function i(){var e=RED.nodes.dirty(),t=u(RED.workspaces.active());t.t="delete",t.dirty=e,RED.history.push(t)}0<e.instances.length?(t=$("<div>"),$("<p>").text(RED._("subflow.subflowInstances",{count:e.instances.length})).appendTo(t),$("<p>").text(RED._("subflow.confirmDelete")).appendTo(t),o=RED.notify(t,{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.close()}},{text:RED._("workspace.confirmDelete"),class:"primary",click:function(){o.close(),i()}}]})):i()}),c(a),$("#red-ui-workspace-chart").css({"margin-top":"40px"}),$("#red-ui-workspace-toolbar").show()}function u(t,o){for(var i=[],e=[],n=[],a=RED.nodes.subflow(t),r=(RED.nodes.eachNode(function(e){o||e.type!="subflow:"+t||i.push(e),e.z==t&&i.push(e)}),RED.nodes.eachConfig(function(e){e.z==t&&i.push(e)}),RED.nodes.groups(t).forEach(function(e){n.push(e)}),[]),s=0;s<i.length;s++)var d=RED.nodes.remove(i[s].id),e=e.concat(d.links),r=r.concat(d.nodes);for(i=i.concat(r),n=RED.nodes.groups(t).filter(function(e){return!e.g}),s=0;s<n.length;s++)n[s].nodes.forEach(function(e){"group"===e.type&&n.push(e)});for(s=n.length-1;0<=s;s--)RED.nodes.removeGroup(n[s]);return RED.nodes.removeSubflow(a),RED.workspaces.remove(a),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:i,links:e,groups:n,subflows:[a]}}function e(){var t=0,e=(RED.nodes.eachSubflow(function(e){e=new RegExp("^Subflow (\\d+)$").exec(e.name);e&&(t=Math.max(t,e[1]))}),"Subflow "+(t+1)),o=RED.nodes.id(),e={type:"subflow",id:o,name:e,info:"",in:[],out:[]};RED.nodes.addSubflow(e),RED.history.push({t:"createSubflow",subflow:{subflow:e},dirty:RED.nodes.dirty()}),RED.workspaces.show(o),RED.nodes.dirty(!0)}function R(e){return e=RED.settings.get("editor").view["view-snap-grid"]?Math.round(e/RED.view.gridSize())*RED.view.gridSize():e}function t(){var c=RED.view.selection();if(c.nodes){for(var i,e=new Set,u=c.nodes.slice(),p=new Set;0<u.length;)"group"===(i=u.shift()).type&&(p.add(i.id),u=u.concat(i.nodes)),e.add(i);for(var o=(e=Array.from(e))[0].g,f=[],t=0;t<e.length;t++)if(e[t].g&&!p.has(e[t].g)&&o!==e[t].g)return void RED.notify("Cannot create subflow across multiple groups","error");var o=o&&RED.nodes.group(o),n={},h=[],g=[],m=[],b=[],a={},r=[e[0].x,e[0].y,e[0].x,e[0].y];for(t=0;t<e.length;t++)i=e[t],n[i.id]={n:i,outputs:{}},r=[Math.min(r[0],i.x),Math.min(r[1],i.y),Math.max(r[2],i.x),Math.max(r[3],i.y)];var v=R(r[0]-200),y=R(r[1]-80),c=[R((r[2]+r[0])/2),R((r[3]+r[1])/2)],w=(RED.nodes.eachLink(function(e){n[e.source.id]&&n[e.target.id],n[e.source.id]&&!n[e.target.id]&&(b.push(e),g.push(e)),!n[e.source.id]&&n[e.target.id]&&(m.push(e),a[e.target.id]=e.target,g.push(e))}),{});if((b=b.filter(function(e){return w[e.source.id+":"+e.sourcePort]?(w[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),w[e.source.id+":"+e.sourcePort]=e,!0)})).sort(function(e,t){return e.source.y-t.source.y}),1<Object.keys(a).length)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var E=0,s=(RED.nodes.eachSubflow(function(e){e=new RegExp("^Subflow (\\d+)$").exec(e.name);e&&(E=Math.max(E,e[1]))}),"Subflow "+(E+1)),D=RED.nodes.id(),d={type:"subflow",id:D,name:s,info:"",in:Object.keys(a).map(function(e,t){return{type:"subflow",direction:"in",x:R(a[e].x-a[e].w/2-80-v),y:R(a[e].y-y),z:D,i:t,id:RED.nodes.id(),wires:[{id:a[e].id}]}}),out:b.map(function(e,t){return{type:"subflow",direction:"out",x:R(e.source.x+e.source.w/2+80-v),y:R(e.source.y-y),z:D,i:t,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}})},l=(RED.nodes.addSubflow(d),{id:RED.nodes.id(),type:"subflow:"+d.id,x:c[0],y:c[1],z:RED.workspaces.active(),inputs:d.in.length,outputs:d.out.length,h:Math.max(30,15*(d.out.length||0)),changed:!0});for(l._def=RED.nodes.getType(l.type),RED.editor.validateNode(l),RED.nodes.add(l),o&&(RED.group.addToGroup(o,l),e.forEach(function(e){var t;e.g===o.id&&(delete e.g,t=o.nodes.indexOf(e),o.nodes.splice(t,1),f.push(e))}),o.dirty=!0),m.forEach(function(e){e={source:e.source,sourcePort:e.sourcePort,target:l};h.push(e),RED.nodes.addLink(e)}),b.forEach(function(e,t){e.targets.forEach(function(e){e={source:l,sourcePort:t,target:e};h.push(e),RED.nodes.addLink(e)})}),d.in.forEach(function(t){t.wires.forEach(function(e){e={source:t,sourcePort:0,target:RED.nodes.node(e.id)};h.push(e),RED.nodes.addLink(e)})}),d.out.forEach(function(t,e){t.wires.forEach(function(e){e={source:RED.nodes.node(e.id),sourcePort:e.port,target:t};h.push(e),RED.nodes.addLink(e)})}),t=0;t<g.length;t++)RED.nodes.removeLink(g[t]);for(t=0;t<e.length;t++)i=e[t],/^link /.test(i.type)&&(i.links=i.links.filter(function(e){var t,o=n.hasOwnProperty(e);return o||(e=RED.nodes.node(e))&&e.links&&(-1<(t=e.links.indexOf(i.id))&&e.links.splice(t,1)),o})),i.x-=v,i.y-=y,RED.nodes.moveNodeToTab(i,d.id);s={t:"createSubflow",nodes:[l.id],links:h,subflow:{subflow:d,offsetX:v,offsetY:y},activeWorkspace:RED.workspaces.active(),removedLinks:g,dirty:RED.nodes.dirty()};o&&((s={t:"multi",events:[s]}).events.push({t:"addToGroup",group:o,nodes:[l]}),s.events.push({t:"removeFromGroup",group:o,nodes:f,reparent:!1})),RED.history.push(s),RED.editor.validateNode(d),RED.nodes.dirty(!0),RED.view.updateActive(),RED.view.select(null)}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")}function p(e,t,o){e.empty();for(var i=0;i<t.length;i++){var n=t[i];n.ui&&"hide"===n.ui.type||!function(e,t,o,i){o.label=o.label||{},("cred"===t.type||t.parent&&"cred"===t.parent.type)&&!o.type?(o.type="cred",o.opts={}):o.type?o.opts||(o.opts="select"===o.type?{opts:[]}:{}):(o.type="input",o.opts={types:RED.editor.envVarList.DEFAULT_ENV_TYPE_LIST});var n=o.label||{},a=RED.i18n.lang(),c=RED.editor.envVarList.lookupLabel(n,n["en-US"]||t.name,a),r=$("<label>").appendTo(e),u=($("<span>&nbsp;</span>").appendTo(e),$("<span></span>").appendTo(r)),s=(!o.icon||(n=RED.utils.separateIconPath(o.icon))&&$("<i class='fa "+n.file+"'/>").appendTo(u),"checkbox"!==o.type&&(n=o.icon?{"padding-left":"5px"}:{},$("<span>").css(n).text(c).appendTo(r),"none"===o.type&&r.width("100%")),{value:"",type:"str"});switch(t.parent&&(s.value=t.parent.value,s.type=t.parent.type),t.hasOwnProperty("value")&&(s.value=t.value),t.hasOwnProperty("type")&&(s.type=t.type),o.type){case"input":var d=$('<input type="text">').css("width","70%").appendTo(e);o.opts.types&&0<o.opts.types.length?(l=s.type,-1===o.opts.types.indexOf(l)&&(l=o.opts.types[0]),d.typedInput({types:o.opts.types,default:l}),d.typedInput("value",s.value)):d.val(s.value);break;case"select":d=$("<select>").css("width","70%").appendTo(e),o.opts.opts&&o.opts.opts.forEach(function(e){$("<option>").val(e.v).text(RED.editor.envVarList.lookupLabel(e.l,e.l["en-US"]||e.v,a)).appendTo(d)}),d.val(s.value);break;case"checkbox":r.css("cursor","default");var l=$("<label>").css("width","70%").appendTo(e),l=(d=$('<input type="checkbox">').css({marginTop:0,width:"auto",height:"34px"}).appendTo(l),u.css({"padding-left":"5px"}).appendTo(l),$("<span>").css({"padding-left":"5px"}).text(c).appendTo(l),!1),l="bool"===s.type?"true"===s.value:"num"===s.type?"0"!==s.value:""!==s.value;d.prop("checked",l);break;case"spinner":d=$("<input>").css("width","70%").appendTo(e);l={};o.opts.hasOwnProperty("min")&&(l.min=o.opts.min),o.opts.hasOwnProperty("max")&&(l.max=o.opts.max),d.spinner(l).parent().width("70%"),d.val(s.value);break;case"cred":d=$('<input type="password">').css("width","70%").appendTo(e),i.credentials?i.credentials[t.name]?d.val(i.credentials[t.name]):i.credentials["has_"+t.name]?d.val("__PWRD__"):d.val(""):d.val(""),d.typedInput({types:["cred"],default:"cred"})}d&&d.attr("id",g(t.name))}($("<div/>",{class:"form-row"}).appendTo(e),n,n.ui||{},o)}}function f(e,s){var d;return e?(d=[],e.each(function(e){var t=$(this).data("data"),o=(t.parent?t.name:t.nameField.val()).trim();if(""!==o||t.ui&&"none"===t.ui.type){var i=t.valueField,n=i.typedInput("value"),i=i.typedInput("type");if(s||!t.parent||t.parent.value!==n||t.parent.type!==i){var a={name:o,type:i,value:n};if(t.ui){var r={icon:t.ui.icon,label:$.extend(!0,{},t.ui.label),type:t.ui.type,opts:$.extend(!0,{},t.ui.opts)};switch(r.icon||delete r.icon,$.isEmptyObject(r.label)&&delete r.label,r.type){case"input":JSON.stringify(r.opts)===JSON.stringify({types:RED.editor.envVarList.DEFAULT_ENV_TYPE_LIST})&&(delete r.type,delete r.opts);break;case"cred":"cred"===a.type&&delete r.type,delete r.opts;break;case"select":r.opts&&$.isEmptyObject(r.opts.opts)&&delete r.opts;break;case"spinner":$.isEmptyObject(r.opts)&&delete r.opts;break;default:delete r.opts}$.isEmptyObject(r)||(a.ui=r)}d.push(a)}}}),d):null}function h(a){var o={},r=[];if(/^subflow:/.test(a.type)){var e=RED.nodes.subflow(a.type.substring(8));if(e.env&&e.env.forEach(function(e){var t={name:e.name,parent:{type:e.type,value:e.value},ui:$.extend(!0,{},e.ui)};r.push(t),o[e.name]=t}),a.env)for(var t=0;t<a.env.length;t++){var i=a.env[t];o.hasOwnProperty(i.name)&&(o[i.name].type=i.type,o[i.name].value=i.value)}}else a._def.subflowModule&&Object.keys(a._def.defaults).forEach(function(e){if("name"!==e){var t,o=a._def.defaults[e],i=a[e],n=i;if(o.ui&&"cred"===o.ui.type)t="cred";else switch(typeof i){case"string":t="str";break;case"number":t="num";break;case"boolean":t="bool",n=i?"true":"false";break;default:t=i.type,n=i.value}e={name:e,type:t,value:n,parent:{type:o.type,value:o.value},ui:$.extend(!0,{},o.ui)};r.push(e)}});return r}function g(e){return"node-input-subflow-env-"+e.replace(/[^a-z0-9-_]/gi,"_")}return{init:function(){RED.events.on("workspace:change",function(e){e=RED.nodes.subflow(e.workspace);e?o(e):($("#red-ui-workspace-toolbar").hide().empty(),$("#red-ui-workspace-chart").css({"margin-top":"0"}))}),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)}),RED.actions.add("core:create-subflow",e),RED.actions.add("core:convert-to-subflow",t),$('<script type="text/x-red" data-template-name="subflow"><div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div><div id="subflow-input-ui"></div><\/script>').appendTo("#red-ui-editor-node-configs"),$('<script type="text/x-red" data-template-name="subflow-template"><div class="form-row"><label for="subflow-input-name" data-i18n="[append]common.label.name"><i class="fa fa-tag"></i>  </label><input type="text" id="subflow-input-name" data-i18n="[placeholder]common.label.name"></div><div class="form-row"><ul style="margin-bottom: 20px;" id="subflow-env-tabs"></ul></div><div id="subflow-env-tabs-content"><div id="subflow-env-tab-edit"><div class="form-row node-input-env-container-row" id="subflow-input-edit-ui"><ol id="node-input-env-container"></ol><div class="node-input-env-locales-row"><i class="fa fa-language"></i> <select id="subflow-input-env-locale"></select></div></div></div><div id="subflow-env-tab-preview"><div id="subflow-input-ui"/></div></div><\/script>').appendTo("#red-ui-editor-node-configs")},createSubflow:e,convertToSubflow:t,removeSubflow:u,refresh:l,removeInput:n,removeOutput:s,removeStatus:d,buildEditForm:function(e,t){var o,i,n,a;"subflow-template"===e?(o=$("#node-input-env-container"),i=t,(n=RED.tabs.create({id:"subflow-env-tabs",onchange:function(e){"subflow-env-tab-preview"===e.id&&p($("#subflow-input-ui"),f(o.editableList("items"),!0),i),$("#subflow-env-tabs-content").children().hide(),$("#"+e.id).show()}})).addTab({id:"subflow-env-tab-edit",label:RED._("editor-tab.envProperties")}),n.addTab({id:"subflow-env-tab-preview",label:RED._("editor-tab.preview")}),n=RED.settings.theme("languages").map(function(e){var t=RED._("languages."+e);return{text:t||e,val:e}}).sort(function(e,t){return e.text.localeCompare(t.text)}),RED.popover.tooltip($(".node-input-env-locales-row i"),RED._("editor.locale")),a=$("#subflow-input-env-locale"),n.forEach(function(e){var t={value:e.val};"en-US"===e.val&&(t.selected=""),$("<option/>",t).text(e.text).appendTo(a)}),n=RED.i18n.lang(),a.val(n),a.on("change",function(){RED.editor.envVarList.setLocale($(this).val(),$("#node-input-env-container"))}),RED.editor.envVarList.setLocale(n),RED.editor.envVarList.create($("#node-input-env-container"),t)):"subflow"===e&&p($("#subflow-input-ui"),h(t),t)},exportSubflowTemplateEnv:f,exportSubflowInstanceEnv:function(e){var n=[];return h(e).forEach(function(e){var t,o=e.ui||{},i=(o.type?o.opts=o.opts||{}:e.parent&&"cred"===e.parent.type?o.type="cred":(o.type="input",o.opts={types:RED.editor.envVarList.DEFAULT_ENV_TYPE_LIST}),$("#"+g(e.name)));if(i.length||"cred"===o.type){switch(t={name:e.name},o.type){case"input":o.opts.types&&0<o.opts.types.length?(t.value=i.typedInput("value"),t.type=i.typedInput("type")):(t.value=i.val(),t.type="str");break;case"cred":t.value=i.val(),t.type="cred";break;case"spinner":t.value=i.val(),t.type="num";break;case"select":t.value=i.val(),t.type="str";break;case"checkbox":t.type="bool",t.value=""+i.prop("checked")}"cred"!==o.type&&t.type===e.parent.type&&t.value===e.parent.value||n.push(t)}}),n}}}(),RED.group=function(){for(var n=["#ff0000","#ffC000","#ffff00","#92d04f","#0070c0","#001f60","#6f2fa0","#000000","#777777"],a=n.length,e=0,c=3*n.length;e<c;e++){var t=e%a,o=Math.floor(e/a)+1,i=n[t],r=parseInt(i.substring(1,3),16),u=parseInt(i.substring(3,5),16),i=parseInt(i.substring(5,7),16),p=(255-u)/(3+(t==a-1?0:1)),f=(255-i)/(3+(t==a-1?0:1)),r=((Math.min(255,Math.floor(r+o*((255-r)/(3+(t==a-1?0:1)))))<<16)+(Math.min(255,Math.floor(u+o*p))<<8)+Math.min(255,Math.floor(i+o*f))).toString(16);n.push("#"+"000000".slice(0,6-r.length)+r)}var s,d={label:!0,"label-position":"nw"};function l(e){var t=/^rgb\((\d+), (\d+), (\d+)\)$/.exec(e);return t?(t=((parseInt(t[1])<<16)+(parseInt(t[2])<<8)+parseInt(t[3])).toString(16),"#"+"000000".slice(0,6-t.length)+t):e}function h(e){var t=[],o=RED.nodes.group(e.g);return e.nodes.forEach(function(e){t.push(e),o?(e.g=o.id,o.nodes.push(e),o.dirty=!0,e.dirty=!0):delete e.g,"group"===e.type?RED.events.emit("groups:change",e):RED.events.emit("nodes:change",e)}),RED.nodes.removeGroup(e),t}function g(e){if(0!==e.length){if(!(0<e.filter(function(e){return"subflow"===e.type}).length)){var t={id:RED.nodes.id(),type:"group",nodes:[],style:JSON.parse(JSON.stringify(d)),x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,w:0,h:0,_def:RED.group.def};t.z=e[0].z,RED.nodes.addGroup(t);try{m(t,e)}catch(e){return void RED.notify(e,"error")}return t}RED.notify(RED._("group.errors.cannotAddSubflowPorts"),"error")}}function m(e,t){var o,i,n,a,r;for(Array.isArray(t)||(t=[t]),o=0;o<t.length;o++){if(!(r=t[o]).z)throw new Error("Cannot add node without a z property to a group");if(i){if(i!==r.z)throw new Error("Cannot add nooes with different z properties")}else i=r.z;if(r.g&&!n){if(0!==o)throw new Error(RED._("group.errors.cannotCreateDiffGroups"));n=r.g}if(n!==r.g)throw new Error(RED._("group.errors.cannotCreateDiffGroups"))}for(n&&((n=RED.nodes.group(n)).nodes.push(e),n.dirty=!0,e.g=n.id),o=0;o<t.length;o++)"subflow"!==(r=t[o]).type&&(!n||r.g!==n.id||-1<(a=n.nodes.indexOf(r))&&n.nodes.splice(a,1),r.g=e.id,r.dirty=!0,e.nodes.push(r),e.x=Math.min(e.x,r.x-r.w/2-25-(r._def.button&&"right"!==r._def.align?20:0)),e.y=Math.min(e.y,r.y-r.h/2-25),e.w=Math.max(e.w,r.x+r.w/2+25+(r._def.button&&"right"==r._def.align?20:0)-e.x),e.h=Math.max(e.h,r.y+r.h/2+25-e.y),"group"===r.type?RED.events.emit("groups:change",r):RED.events.emit("nodes:change",r));n&&RED.events.emit("groups:change",e),v(e)}function b(e,t,o){var i;Array.isArray(t)||(t=[t]);for(var n=0;n<t.length;n++)if(t[n].g!==e.id)return;for(var a=RED.nodes.group(e.g),n=0;n<t.length;n++){(i=t[n]).dirty=!0;var r=e.nodes.indexOf(i);e.nodes.splice(r,1),o&&e.g?(i.g=e.g,a.nodes.push(i)):delete i.g,"group"===i.type?RED.events.emit("groups:change",i):RED.events.emit("nodes:change",i)}v(e)}function v(e){for(e.dirty=!0;e;)e.dirty=!0,e=RED.nodes.group(e.g)}return{def:{defaults:{name:{value:""},style:{value:{label:!0}},nodes:{value:[]},env:{value:[]}},category:"config",oneditprepare:function(){var e,t,c,u,o,i=this.style||{};function p(){var e=c.val();o.removeClass().addClass("red-ui-group-layout-picker-cell-text red-ui-group-layout-text-pos-"+e)}RED.editor.colorPicker.create({id:"node-input-style-stroke",value:i.stroke||d.stroke||"#a4a4a4",palette:n,cellPerRow:a,cellWidth:16,cellHeight:16,cellMargin:3,none:!0,opacity:i.hasOwnProperty("stroke-opacity")?i["stroke-opacity"]:d.hasOwnProperty("stroke-opacity")?d["stroke-opacity"]:1}).appendTo("#node-input-row-style-stroke"),RED.editor.colorPicker.create({id:"node-input-style-fill",value:i.fill||d.fill||"none",palette:n,cellPerRow:a,cellWidth:16,cellHeight:16,cellMargin:3,none:!0,opacity:i.hasOwnProperty("fill-opacity")?i["fill-opacity"]:d.hasOwnProperty("fill-opacity")?d["fill-opacity"]:1}).appendTo("#node-input-row-style-fill"),e={id:"node-input-style-label-position",value:i["label-position"]||"nw"},t=$("<div>",{style:"display:inline-block"}),c=$("<input/>",{id:e.id,type:"hidden",value:e.value}).appendTo(t),u=$('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(t),$('<i class="fa fa-caret-down"></i>').appendTo(u),e=$("<div>",{class:"red-ui-search-result-node"}).appendTo(u),o=$("<div>",{class:"red-ui-group-layout-picker-cell-text red-ui-group-layout-text-pos-"}).appendTo(e),u.on("click",function(l){var e,t=$("<div/>",{class:"red-ui-group-layout-picker"}).css({width:"126px"});$("<div/>").appendTo(t);for(var o=0;o<2;o++)for(var i="ns"[o],n=$("<div/>").appendTo(t),a=0;a<3;a++){var r=i+["w","","e"][a],s=$("<button/>",{class:"red-ui-search-result-node red-ui-button","data-pos":r}).appendTo(n);s.on("click",function(e){e.preventDefault(),c.val($(this).data("pos")),d.hide(),p()}),$("<div>",{class:"red-ui-group-layout-picker-cell-text red-ui-group-layout-text-pos-"+r}).appendTo(s),r===c.val()&&(e=s)}p();var d=RED.popover.panel(t);d.show({target:u,onclose:function(){u.focus()}}),e&&e.focus()}),p(),t.appendTo("#node-input-row-style-label-position"),RED.editor.colorPicker.create({id:"node-input-style-color",value:i.color||d.color||"#a4a4a4",palette:n,cellPerRow:a,cellWidth:16,cellHeight:16,cellMargin:3}).appendTo("#node-input-row-style-label-color"),$("#node-input-style-label").toggleButton({enabledLabel:RED._("editor.show"),disabledLabel:RED._("editor.show")}),$("#node-input-style-label").on("change",function(e){$("#node-input-row-style-label-options").toggle($(this).prop("checked"))}),$("#node-input-style-label").prop("checked",this.style.label),$("#node-input-style-label").trigger("change")},oneditresize:function(e){},oneditsave:function(){this.style.stroke=$("#node-input-style-stroke").val(),this.style.fill=$("#node-input-style-fill").val(),this.style["stroke-opacity"]=$("#node-input-style-stroke-opacity").val(),this.style["fill-opacity"]=$("#node-input-style-fill-opacity").val(),this.style.label=$("#node-input-style-label").prop("checked"),this.style.label?(this.style["label-position"]=$("#node-input-style-label-position").val(),this.style.color=$("#node-input-style-color").val()):(delete this.style["label-position"],delete this.style.color);var t=this;["stroke","fill","stroke-opacity","fill-opacity","color","label-position"].forEach(function(e){t.style[e]===d[e]&&delete t.style[e]}),this.resize=!0},set:{module:"node-red"}},init:function(){RED.events.on("view:selection-changed",function(e){var t=!!e.nodes,o=!1,i=!1,n=!1,a=!1;t&&(a=1===e.nodes.length&&"group"===e.nodes[0].type,e.nodes.forEach(function(e){"group"===e.type&&(o=!0),e.g&&(n=!0)}),o&&(i=1<e.nodes.length)),RED.menu.setDisabled("menu-item-group-group",!t),RED.menu.setDisabled("menu-item-group-ungroup",!o),RED.menu.setDisabled("menu-item-group-merge",!i),RED.menu.setDisabled("menu-item-group-remove",!n),RED.menu.setDisabled("menu-item-edit-copy-group-style",!a),RED.menu.setDisabled("menu-item-edit-paste-group-style",!o)}),RED.actions.add("core:group-selection",function(){var e,t;RED.view.state()===RED.state.DEFAULT&&(!(e=RED.view.selection()).nodes||(e=g(e.nodes))&&(t={t:"createGroup",groups:[e],dirty:RED.nodes.dirty()},RED.history.push(t),RED.view.select({nodes:[e]}),RED.nodes.dirty(!0)))}),RED.actions.add("core:ungroup-selection",function(){var e,t,o;RED.view.state()!==RED.state.DEFAULT||(e=RED.view.selection()).nodes&&(t=[],groups=e.nodes.filter(function(e){return"group"===e.type}),o={t:"ungroup",groups:[],dirty:RED.nodes.dirty()},RED.history.push(o),groups.forEach(function(e){t=t.concat(h(e)),o.groups.push(e)}),RED.history.push(o),RED.view.select({nodes:t}),RED.nodes.dirty(!0))}),RED.actions.add("core:merge-selection-to-group",function(){if(RED.view.state()===RED.state.DEFAULT){var e=RED.view.selection();if(e.nodes){for(var t,o,i,n=[],a={t:"multi",events:[]},r={t:"ungroup",groups:[]},s=0;s<e.nodes.length;s++)if(t=e.nodes[s],0===s)o=t.g;else if(t.g!==o)return void RED.notify(RED._("group.errors.cannotCreateDiffGroups"),"error");for(s=0;s<e.nodes.length;s++)"group"===(t=e.nodes[s]).type?(i=i||t,r.groups.push(t),n=n.concat(h(t))):n.push(t),t.dirty=!0;0<r.groups.length&&a.events.push(r);var d=g(n);d&&(i&&(d.style=i.style,d.name=i.name),RED.view.select({nodes:[d]})),a.events.push({t:"createGroup",groups:[d],dirty:RED.nodes.dirty()}),RED.history.push(a),RED.nodes.dirty(!0)}}}),RED.actions.add("core:remove-selection-from-group",function(){if(RED.view.state()===RED.state.DEFAULT){var e=RED.view.selection();if(e.nodes){var t=RED.nodes.group(e.nodes[0].g);if(t)try{b(t,e.nodes,!0);var o={t:"removeFromGroup",dirty:RED.nodes.dirty(),group:t,nodes:e.nodes};RED.history.push(o),RED.nodes.dirty(!0)}catch(e){return void RED.notify(e,"error")}RED.view.select({nodes:e.nodes})}}}),RED.actions.add("core:copy-group-style",function(){var e;RED.view.state()!==RED.state.DEFAULT||(e=RED.view.selection()).nodes&&1===e.nodes.length&&"group"===e.nodes[0].type&&(s=JSON.parse(JSON.stringify(e.nodes[0].style)),RED.notify(RED._("clipboard.groupStyleCopied"),{id:"clipboard"}),RED.menu.setDisabled("menu-item-edit-paste-group-style",!1))}),RED.actions.add("core:paste-group-style",function(){var e,t;RED.view.state()===RED.state.DEFAULT&&(!s||(e=RED.view.selection()).nodes&&(t={t:"multi",events:[],dirty:RED.nodes.dirty()},e.nodes.forEach(function(e){"group"===e.type&&(t.events.push({t:"edit",node:e,changes:{style:JSON.parse(JSON.stringify(e.style))},dirty:RED.nodes.dirty()}),e.style=JSON.parse(JSON.stringify(s)),e.dirty=!0)}),0<t.events.length&&(RED.history.push(t),RED.nodes.dirty(!0),RED.view.redraw())))}),$('<script type="text/x-red" data-template-name="group"><div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div><div class="form-row" id="node-input-row-style-stroke"><label data-i18n="editor:common.label.style"></label><label style="width: 70px;margin-right:10px" for="node-input-style-stroke" data-i18n="editor:common.label.line"></label></div><div class="form-row" style="padding-left: 100px;" id="node-input-row-style-fill"><label style="width: 70px;margin-right: 10px "  for="node-input-style-fill" data-i18n="editor:common.label.fill"></label></div><div class="form-row"><label for="node-input-style-label" data-i18n="editor:common.label.label"></label><input type="checkbox" id="node-input-style-label"/></div><div class="form-row" id="node-input-row-style-label-options"><div style="margin-left: 100px; display: inline-block"><div class="form-row"><span style="display: inline-block; min-width: 140px"  id="node-input-row-style-label-color"><label style="width: 70px;margin-right: 10px" for="node-input-style-fill" data-i18n="editor:common.label.color"></label></span></div><div class="form-row"><span style="display: inline-block; min-width: 140px;" id="node-input-row-style-label-position"><label style="width: 70px;margin-right: 10px " for="node-input-style-label-position" data-i18n="editor:common.label.position"></label></span></div></div></div><\/script>').appendTo("#red-ui-editor-node-configs");var e=$("<div>",{class:"red-ui-flow-group-body",style:"position: absolute; top: -1000px;"}).appendTo(document.body),t=getComputedStyle(e[0]);d={stroke:l(t.stroke),"stroke-opacity":t.strokeOpacity,fill:l(t.fill),"fill-opacity":t.fillOpacity,label:!0,"label-position":"nw"},e.remove(),e=$("<div>",{class:"red-ui-flow-group-label",style:"position: absolute; top: -1000px;"}).appendTo(document.body),t=getComputedStyle(e[0]),d.color=l(t.fill),e.remove()},createGroup:g,ungroup:h,addToGroup:m,removeFromGroup:b,getNodes:function t(e,o,i){var n=[];return e.nodes.forEach(function(e){"group"===e.type&&i||n.push(e),o&&"group"===e.type&&(n=n.concat(t(e,o,i)))}),n},contains:function e(t,o){if(o.g===t.id)return!0;for(var i=0;i<t.nodes.length;i++)if("group"===t.nodes[i].type&&e(t.nodes[i],o))return!0;return!1},markDirty:v}}(),RED.userSettings=function(){var t=700,o=!1,a=[];function e(e){a.push(e)}function r(n){var e;o||(RED.user.hasPermission("settings.write")?(o=!0,e={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){t=e.width},open:function(e){var e=e.find(".red-ui-tray-body"),e=$("<div></div>").appendTo(e),t=$("<div></div>",{class:"red-ui-settings-tabs-container"}).appendTo(e),o=($("<ul></ul>",{id:"user-settings-tabs"}).appendTo(t),RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){i.children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}})),i=$("<div></div>",{class:"red-ui-settings-tabs-content"}).appendTo(e);a.forEach(function(e){o.addTab({id:"red-ui-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(i)}),e.i18n(),o.activateTab("red-ui-settings-tab-"+(n||"view")),$("#red-ui-sidebar-shade").show()},close:function(){o=!1,a.forEach(function(e){e.close&&e.close()}),$("#red-ui-sidebar-shade").hide()},show:function(){}},null!==t&&(e.width=t),RED.tray.show(e)):RED.notify(RED._("user.errors.settings"),"error"))}function i(e){var t=RED._("languages."+e);return{text:t||e,val:e}}function n(e,t){return e.text.localeCompare(t.text)}var s=[{options:[{setting:"editor-language",local:!0,label:"menu.label.view.language",options:function(e){e([{val:"",text:RED._("menu.label.view.browserDefault")}].concat(RED.settings.theme("languages").map(i).sort(n)))}}]},{title:"menu.label.view.view",options:[{setting:"view-store-zoom",label:"menu.label.view.storeZoom",default:!1,toggle:!0,onchange:function(e){e||RED.settings.removeLocal("zoom-level")}},{setting:"view-store-position",label:"menu.label.view.storePosition",default:!1,toggle:!0,onchange:function(e){e||RED.settings.removeLocal("scroll-positions")}}]},{title:"menu.label.view.grid",options:[{setting:"view-show-grid",oldSetting:"menu-menu-item-view-show-grid",label:"menu.label.view.showGrid",default:!0,toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",oldSetting:"menu-menu-item-view-snap-grid",label:"menu.label.view.snapGrid",default:!0,toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:20,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"},{setting:"view-node-show-label",label:"menu.label.showNodeLabelDefault",default:!0,toggle:!0}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"},{setting:"view-show-welcome-tours",label:"menu.label.showWelcomeTours",toggle:!0,default:!0}]}],d={};function c(){var n=$('<div id="red-ui-settings-tab-view" class="red-ui-help"></div>'),a=RED.settings.get("editor")||{};return a.view=a.view||{},s.forEach(function(e){e.title&&$("<h3></h3>").text(RED._(e.title)).appendTo(n),e.options.forEach(function(e){var i,t=e.local?localStorage.getItem(e.setting):a.view[e.setting],o=$('<div class="red-ui-settings-row"></div>').appendTo(n);e.toggle?$('<label for="user-settings-'+e.setting+'"><input id="user-settings-'+e.setting+'" type="checkbox"> '+RED._(e.label)+"</label>").appendTo(o).find("input").prop("checked",t):e.options?($('<label for="user-settings-'+e.setting+'">'+RED._(e.label)+"</label>").appendTo(o),i=$('<select id="user-settings-'+e.setting+'"></select>').appendTo(o),"function"==typeof e.options&&(e.options(function(e){e.forEach(function(e){var t=e,o=e;"string"!=typeof e&&(t=e.val,o=e.text),$("<option>").val(t).text(o).appendTo(i)})}),i.val(t))):($('<label for="user-settings-'+e.setting+'">'+RED._(e.label)+"</label>").appendTo(o),$('<input id="user-settings-'+e.setting+'" type="'+(e.type||"text")+'">').appendTo(o).val(t))})}),n}function l(e,t){var o,e=d[e];e.local?localStorage.setItem(e.setting,t):((o=RED.settings.get("editor")||{}).view=o.view||{},o.view[e.setting]=t,RED.settings.set("editor",o),(o="string"==typeof(o=e.onchange)?RED.actions.get(o):o)&&o.call(e,t))}return{init:function(){RED.actions.add("core:show-user-settings",r),RED.actions.add("core:show-help",function(){r("keyboard")}),e({id:"view",title:RED._("menu.label.view.view"),get:c,close:function(){s.forEach(function(e){e.options.forEach(function(e){var t=$("#user-settings-"+e.setting);e.toggle?l(e.setting,t.prop("checked")):l(e.setting,t.val())})})}});var i=RED.settings.get("editor")||{},n=(i.view=i.view||{},!1);s.forEach(function(e){e.options.forEach(function(e){var t,o;e.local?d[e.setting]=e:(!e.oldSetting||null!=(t=RED.settings.get(e.oldSetting))&&(i.view[e.setting]=t,n=!0,RED.settings.remove(e.oldSetting)),d[e.setting]=e,null==(t=i.view[e.setting])&&e.hasOwnProperty("default")&&(t=e.default,i.view[e.setting]=t,n=!0),!e.onchange||(o="string"==typeof(o=e.onchange)?RED.actions.get(o):o)&&o.call(e,t))})}),n&&RED.settings.set("editor",i)},toggle:function(e){var t=d[e],o=RED.settings.get("editor")||{};o.view=o.view||{},l(e,!o.view[t.setting])},show:r,add:e}}(),RED.projects=function(){var T,n,U;function p(e){var t="git_missing_user"===e.code?RED.notify("<p>"+RED._("projects.errors.no-username-email")+"</p>",{fixed:!0,type:"error",buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:RED._("projects.config-git"),click:function(){RED.userSettings.show("gitconfig"),t.close()}}]}):(console.log(e),RED.notify("<p>"+RED._("projects.errors.unexpected")+":</p><p>"+e.message+"</p><small>"+RED._("projects.errors.code")+": "+e.code+"</small>",{fixed:!0,modal:!0,type:"error",buttons:[{text:RED._("common.label.close"),click:function(){t.close()}}]}))}var a={};function o(){var L,I,S,P,O,A,M,z,B,N,G,F,d,r,s,v,w,y,E,D,R,x,_,f,g,l,c,k=$('<div class="red-ui-projects-dialog-screen-start-hero"></div>'),h=($('<span><i class="fa fa-files-o fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-long-arrow-right fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-archive fa-2x"></i></span>').appendTo(k),$("<hr>").appendTo(k),{});a={welcome:{content:function(e){var t=$('<div class="red-ui-projects-dialog-screen-start"></div>'),o=(k.appendTo(t),$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t)),o=($("<p>").text(RED._("projects.welcome.hello")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc0")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc1")).appendTo(o),$("<p>").text(RED._("projects.welcome.desc2")).appendTo(o),$('<div style="text-align: center"></div>').appendTo(o)),i=$('<button data-type="empty" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.welcome.create")+"</button>").appendTo(o),o=$('<button data-type="clone" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.welcome.clone")+"</button>").appendTo(o);return i.on("click",function(e){e.preventDefault(),h={action:"create"},u("git-config")}),o.on("click",function(e){e.preventDefault(),h={action:"clone"},u("git-config")}),t},buttons:[{text:RED._("projects.welcome.openExistingProject"),class:"secondary",click:function(){h={action:"open"},u("git-config")}},{text:RED._("projects.welcome.not-right-now"),click:function(){h={},$(this).dialog("close")}}]},"git-config":{content:function(e){function t(){var e=l.val().trim(),t=c.val().trim(),e=0<e.length&&0<t.length;$("#red-ui-projects-dialog-git-config").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)}var o=!1,i=RED.settings.get("git"),n=(i&&i.user?i=i.user:RED.settings.git&&RED.settings.git.globalUser&&(o=!0,i=RED.settings.git.globalUser),$('<div class="red-ui-projects-dialog-screen-start"></div>')),a=(k.appendTo(n),$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(n)),o=($("<p>").text(RED._("projects.git-config.setup")).appendTo(a),$("<p>").text(RED._("projects.git-config.desc0")).appendTo(a),$("<p>").text(RED._("projects.git-config.desc1")).appendTo(a),o&&$("<p>").text(RED._("projects.git-config.desc2")).appendTo(a),$("<p>").text(RED._("projects.git-config.desc3")).appendTo(a),$('<div class="form-row"></div>').appendTo(a));return $('<label for="">'+RED._("projects.git-config.username")+"</label>").appendTo(o),(l=$('<input type="text">').val(i&&i.name||"").appendTo(o)).on("change keyup paste",t),o=$('<div class="form-row"></div>').appendTo(a),$('<label for="">'+RED._("projects.git-config.email")+"</label>").appendTo(o),(c=$('<input type="text">').val(i&&i.email||"").appendTo(o)).on("change keyup paste",t),setTimeout(function(){l.trigger("focus"),t()},50),n},buttons:[{text:RED._("common.label.back"),click:function(){u("welcome")}},{id:"red-ui-projects-dialog-git-config",text:RED._("common.label.next"),class:"primary",click:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=l.val(),e.user.email=c.val(),RED.settings.set("git",e),"create"===h.action?u("project-details"):"clone"===h.action?u("clone-project"):"open"===h.action&&u("create",{screen:"open"})}}]},"project-details":{content:function(c){var o,e,i=null,n=!1,t=($.getJSON("projects",function(e){i={},e.projects.forEach(function(e){i[e]=!0,n&&(n=!1,r())})}),$('<div class="red-ui-projects-dialog-screen-start"></div>')),a=(k.appendTo(t),$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t)),r=($("<p>").text(RED._("projects.project-details.create")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc0")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc1")).appendTo(a),$("<p>").text(RED._("projects.project-details.desc2")).appendTo(a),function(){var e=f.val(),t=!0;if(l){if(null===i)return void(n=!0);d.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||i[e]?(f.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(d),t=o=!1,i[e]?projectNameSublabel.text(RED._("projects.project-details.already-exists")):projectNameSublabel.text(RED._("projects.project-details.must-contain"))):(f.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(d),projectNameSublabel.text(RED._("projects.project-details.must-contain")),o=!0),p=e}t=o,$("#red-ui-projects-dialog-create-name").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)}),s=$('<div class="form-row"></div>').appendTo(a),u=($('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.project-details.project-name")+"</label>").appendTo(s),$('<div style="position:relative;"></div>').appendTo(s)),d=(f=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').val(h.name||"").appendTo(u),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(u)),l=!1,p="";return f.on("change keyup paste",function(){if(l=f.val()!==p,e)clearTimeout(e);else if(l&&(d.empty(),$('<img src="red/images/spin.svg"/>').appendTo(d),""===f.val()))return void r();e=setTimeout(function(){r(),e=null},300)}),projectNameSublabel=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.project-details.must-contain")+"</small></label>").appendTo(s).find("small"),s=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(a),$('<label for="red-ui-projects-dialog-screen-create-project-desc">'+RED._("projects.project-details.desc")+"</label>").appendTo(s),g=$('<input id="red-ui-projects-dialog-screen-create-project-desc" type="text">').val(h.summary||"").appendTo(s),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.project-details.opt")+"</small></label>").appendTo(s),setTimeout(function(){f.trigger("focus"),f.trigger("change")},50),t},buttons:function(e){return[{text:RED._("common.label.back"),click:function(){u("git-config")}},{id:"red-ui-projects-dialog-create-name",disabled:!0,text:RED._("common.label.next"),class:"primary disabled",click:function(){h.name=f.val(),h.summary=g.val(),u("default-files",e)}}]}},"clone-project":{content:function(c){var i,e,u=$('<div class="red-ui-projects-dialog-screen-start"></div>'),t=(k.appendTo(u),$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(u)),n=($("<p>").text(RED._("projects.clone-project.clone")).appendTo(t),$("<p>").text(RED._("projects.clone-project.desc0")).appendTo(t),null),p=!1,o=($.getJSON("projects",function(e){n={},e.projects.forEach(function(e){n[e]=!0,p&&(p=!1,o())})}),function(){var e=v.val(),t=!0;if(f){if(null===n)return void(p=!0);s.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||n[e]?(v.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(s),t=i=!1,n[e]?R.text(RED._("projects.clone-project.already-exists")):R.text(RED._("projects.clone-project.must-contain"))):(v.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(s),R.text(RED._("projects.clone-project.must-contain")),i=!0),h=e}var t=i,e=y.val(),o=0<e.length&&!/\s/.test(e);/^https?:\/\/[^/]+@/i.test(e)&&($("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.no-info-in-url")),o=!1),o?y.removeClass("input-error"):(m&&y.addClass("input-error"),t=!1),/^https?:\/\//.test(e)?($(".red-ui-projects-dialog-screen-create-row-creds").show(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(e)?($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").show()):($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()),$("#red-ui-projects-dialog-clone-project").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)}),a=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(t),r=($('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.clone-project.project-name")+"</label>").appendTo(a),$('<div style="position:relative;"></div>').appendTo(a)),s=(v=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').appendTo(r),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(r)),f=!1,h="",g="",m=(v.on("change keyup paste",function(){if(f=v.val()!==h,e)clearTimeout(e);else if(f&&(s.empty(),$('<img src="red/images/spin.svg"/>').appendTo(s),""===v.val()))return void o();e=setTimeout(function(){o(),e=null},300)}),R=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.must-contain")+"</small></label>").appendTo(a).find("small"),a=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(t),$('<label for="red-ui-projects-dialog-screen-create-project-repo">'+RED._("projects.clone-project.git-url")+"</label>").appendTo(a),y=$('<input id="red-ui-projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(a),$('<label id="red-ui-projects-dialog-screen-create-project-repo-label" class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.clone-project.protocols")+"</small></label>").appendTo(a),!1),b="",d=(y.on("change keyup paste",function(){m=!0;var e,t=$(this).val(),t=(b!==t&&$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),b=t,/\/([^/]+?)(?:\.git)?$/.exec(t));t&&(""!==(e=v.val())&&e!==g||(g=t[1],v.val(g),v.trigger("change"))),o()}),$('<div class="red-ui-projects-dialog-screen-create-row"></div>').appendTo(t)),r=(a=$('<div class="form-row red-ui-projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(d),$('<div><i class="fa fa-warning"></i> '+RED._("projects.clone-project.auth-failed")+"</div>").appendTo(a),a=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row-creds"></div>').hide().appendTo(d),$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(a)),l=($('<label for="red-ui-projects-dialog-screen-create-project-repo-user">'+RED._("projects.clone-project.username")+"</label>").appendTo(r),E=$('<input id="red-ui-projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(r),r=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(a),$('<label for="red-ui-projects-dialog-screen-create-project-repo-pass">'+RED._("projects.clone-project.passwd")+"</label>").appendTo(r),(D=$('<input style="width:100%" id="red-ui-projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(r)).typedInput({type:"cred"}),a=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(d),r=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(a),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.ssh-key")+"</label>").appendTo(r),x=$("<select>",{style:"width: 100%"}).appendTo(r),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){x.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(x.addClass("input-error"),x.attr("disabled",!0),l.show()):(x.removeClass("input-error"),x.attr("disabled",!1),l.hide())}),r=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(a),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.clone-project.passphrase")+"</label>").appendTo(r),(_=$('<input id="red-ui-projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(r)).typedInput({type:"cred"}),r=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').appendTo(d),$('<div class="red-ui-projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(r));return $('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.clone-project.ssh-key-desc")+"</div>").appendTo(l),r=$('<div style="text-align: center">').appendTo(l),$('<button class="red-ui-button red-ui-projects-dialog-button">'+RED._("projects.clone-project.ssh-key-add")+"</button>").appendTo(r).on("click",function(e){e.preventDefault(),T.dialog("close"),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").trigger("click")},500)}),a=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(t),$("<label>"+RED._("projects.clone-project.credential-key")+"</label>").appendTo(a),(w=$('<input style="width: 100%" type="password"></input>').appendTo(a)).typedInput({type:"cred"}),u},buttons:function(e){return[{text:RED._("common.label.back"),click:function(){u("git-config")}},{id:"red-ui-projects-dialog-clone-project",disabled:!0,text:RED._("common.label.clone"),class:"primary disabled",click:function(){$(".red-ui-projects-dialog-screen-create-type.selected").data("type");var e={name:v.val()},t=(e.credentialSecret=w.val(),y.val());if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(t)){var o=x.val();if(!o)return void console.log(RED._("projects.clone-project.cant-get-ssh-key"));e.git={remotes:{origin:{url:t,keyFile:o,passphrase:_.val()}}}}else e.git={remotes:{origin:{url:t,username:E.val(),password:D.val()}}};$(".red-ui-projects-dialog-screen-create-row-auth-error").hide(),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.protocols")),E.removeClass("input-error"),D.removeClass("input-error"),x.removeClass("input-error"),_.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(e.name),J({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){T.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.clone-project.already-exists2"))},git_error:function(e){console.log(RED._("projects.clone-project.git-error"),e)},git_connection_failed:function(e){y.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.connection-failed"))},git_not_a_repository:function(e){y.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.not-git-repo"))},git_repository_not_found:function(e){y.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.clone-project.repo-not-found"))},git_auth_failed:function(e){$(".red-ui-projects-dialog-screen-create-row-auth-error").show(),E.addClass("input-error"),D.addClass("input-error"),x.addClass("input-error"),_.addClass("input-error")},missing_flow_file:function(e){T.dialog("close")},missing_package_file:function(e){T.dialog("close")},project_empty:function(e){T.dialog("close")},credentials_load_failed:function(e){T.dialog("close")},"*":function(e){p(e),$(T).dialog("close")}}}},e).then(function(){RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1),RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"default-files":{content:function(e){function t(){var e=!0,t=r.val();""!==t&&/\.json$/.test(t)?(r.hasClass("input-error")&&(r.removeClass("input-error"),r.next().empty()),s.hasClass("input-error")&&(s.removeClass("input-error"),s.next().empty()),s.text(t.substring(0,t.length-5)+"_cred.json")):(e=!1,r.hasClass("input-error")||(r.addClass("input-error"),r.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>')),s.text(""),s.hasClass("input-error")||(s.addClass("input-error"),s.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),$("#red-ui-projects-dialog-create-default-files").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)}var o=$('<div class="red-ui-projects-dialog-screen-start"></div>'),i=(k.appendTo(o),$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(o)),e=($("<p>").text(RED._("projects.default-files.create")).appendTo(i),$("<p>").text(RED._("projects.default-files.desc0")).appendTo(i),$("<p>").text(RED._("projects.default-files.desc1")).appendTo(i),!e.existingProject&&RED.settings.files&&$("<p>").text(RED._("projects.default-files.desc2")).appendTo(i),$('<div class="form-row"></div>').appendTo(i)),n=($('<label for="red-ui-projects-dialog-screen-create-project-file">'+RED._("projects.default-files.flow-file")+"</label>").appendTo(e),$('<div style="position:relative;"></div>').appendTo(e)),a=h.files&&h.files.flow||RED.settings.files&&RED.settings.files.flow||"flow.json",a=(r=$('<input id="red-ui-projects-dialog-screen-create-project-file" type="text">').val(a).on("change keyup paste",t).appendTo(n),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(n),$('<label class="red-ui-projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(e),h.files&&h.files.credentials||RED.settings.files&&RED.settings.files.credentials||"flow_cred.json"),e=$('<div class="form-row"></div>').appendTo(i);return $('<label for="red-ui-projects-dialog-screen-create-project-credfile">'+RED._("projects.default-files.credentials-file")+"</label>").appendTo(e),n=$('<div style="position:relative;"></div>').appendTo(e),s=$('<div style="width: 100%" class="uneditable-input" id="red-ui-projects-dialog-screen-create-project-credentials">').text(a).appendTo(n),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(n),setTimeout(function(){r.trigger("focus"),t()},50),o},buttons:function(e){return[{text:RED._(e.existingProject?"common.label.cancel":"common.label.back"),click:function(){e.existingProject?$(this).dialog("close"):u("project-details",e)}},{id:"red-ui-projects-dialog-create-default-files",text:RED._("common.label.next"),class:"primary",click:function(){h.files={flow:r.val(),credentials:s.text()},e.existingProject||(h.migrateFiles=!0),u("encryption-config",e)}}]}},"encryption-config":{content:function(e){function i(){var e=!0;"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(e=e&&""!==d.val()),$("#red-ui-projects-dialog-create-encryption").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)}var t=$('<div class="red-ui-projects-dialog-screen-start"></div>'),o=(k.appendTo(t),$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t)),e=($("<p>").text(RED._("projects.encryption-config.setup")).appendTo(o),e.existingProject?($("<p>").text(RED._("projects.encryption-config.desc0")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc1")).appendTo(o)):"disabled"===RED.settings.flowEncryptionType?($("<p>").text(RED._("projects.encryption-config.desc2")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc3")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc4")).appendTo(o)):("user"===RED.settings.flowEncryptionType?$("<p>").text(RED._("projects.encryption-config.desc5")).appendTo(o):"system"===RED.settings.flowEncryptionType&&$("<p>").text(RED._("projects.encryption-config.desc6")).appendTo(o),$("<p>").text(RED._("projects.encryption-config.desc7")).appendTo(o)),$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(o)),o=($("<label>"+RED._("projects.encryption-config.credentials")+"</label>").appendTo(e),$('<div class="red-ui-projects-dialog-credentials-box">').appendTo(e)),n=$('<div class="red-ui-projects-dialog-credentials-box-right">').appendTo(o),a=$('<div class="red-ui-projects-dialog-credentials-box-left">').appendTo(o),r=$('<div class="form-row red-ui-projects-dialog-credentials-box-enabled"></div>').appendTo(a),s=($('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="enabled"> <i class="fa fa-lock"></i> <span>'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(r),$('<div class="form-row red-ui-projects-dialog-credentials-box-disabled"></div>').appendTo(a));return $('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="disabled"> <i class="fa fa-unlock"></i> <span>'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(s),a.find("input[name=projects-encryption-type]").on("click",function(e){var t,o;"enabled"===$(this).val()?(t=r,o=s,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&d.trigger("focus")):(o=r,t=s,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.removeClass("disabled"),o.addClass("disabled"),i()}),e=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(n),$('<label class="red-ui-projects-edit-form-inline-label '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+'" style="margin-left: 5px"><input '+("user"!==RED.settings.flowEncryptionType?RED._("projects.encryption-config.disabled"):"")+' type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="default" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.copy")+"</span></label>").appendTo(e),e=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(n),$('<label class="red-ui-projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="custom" name="projects-encryption-key"> <span style="vertical-align: middle;">'+RED._("projects.encryption-config.use-custom")+"</span></label>").appendTo(e),e=$('<div class="projects-encryption-enabled-row"></div>').appendTo(n),(d=$('<input disabled type="password" style="margin-left: 25px; width: calc(100% - 30px);"></input>').appendTo(e)).typedInput({type:"cred"}),d.on("change keyup paste",i),e=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(n),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.encryption-config.desc8")+"</div>").appendTo(e),n.find("input[name=projects-encryption-key]").on("click",function(){var e=$(this).val();d.attr("disabled","default"===e),"custom"===e&&d.trigger("focus"),i()}),setTimeout(function(){a.find("input[name=projects-encryption-type][value=enabled]").trigger("click"),("user"!==RED.settings.flowEncryptionType?n.find("input[name=projects-encryption-key][value=custom]"):n.find("input[name=projects-encryption-key][value=default]")).trigger("click"),i()},100),t},buttons:function(i){return[{text:RED._("common.label.back"),click:function(){u("default-files",i)}},{id:"red-ui-projects-dialog-create-encryption",text:RED._(i.existingProject?"projects.encryption-config.create-project-files":"projects.encryption-config.create-project"),class:"primary disabled",disabled:!0,click:function(){"enabled"===$("input[name=projects-encryption-type]:checked").val()?"custom"===$("input[name=projects-encryption-key]:checked").val()&&(h.credentialSecret=d.val()):h.credentialSecret=!1,RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(h.name);var e="POST",t="projects",o=(i.existingProject&&(h.initialise=!0,e="PUT",t="projects/"+U.name),this);J({url:t,type:e,requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){h={},i.existingProject?$(o).dialog("close"):(u("create-success"),RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1))},400:{project_exists:function(e){console.log(RED._("projects.encryption-config.already-exists"))},git_error:function(e){console.log(RED._("projects.encryption-config.git-error"),e)},git_connection_failed:function(e){projectRepoInput.addClass("input-error")},git_auth_failed:function(e){projectRepoUserInput.addClass("input-error"),projectRepoPasswordInput.addClass("input-error"),console.log(RED._("projects.encryption-config.git-auth-error"),e)},"*":function(e){p(e),$(T).dialog("close")}}}},h).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"create-success":{content:function(e){var t=$('<div class="red-ui-projects-dialog-screen-start"></div>'),o=(k.appendTo(t),$('<div class="red-ui-projects-dialog-screen-start-body"></div>').appendTo(t));return $("<p>").text(RED._("projects.create-success.success")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc0")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc1")).appendTo(o),$("<p>").text(RED._("projects.create-success.desc2")).appendTo(o),t},buttons:[{text:RED._("common.label.done"),click:function(){$(this).dialog("close")}}]},create:{title:RED._("projects.create.projects"),content:function(c){var r,i,u,p,s,f,d,h,g,n=null,m=(F=null,!1),t=($.getJSON("projects",function(e){n={},e.projects.forEach(function(e){n[e]=!0,m&&(m=!1,a())})}),$('<div class="red-ui-projects-dialog-screen-create"></div>')),a=function(){var e=L.val(),t=!0;if(E){if(null===n)return void(m=!0);w.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||n[e]?(L.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(w),t=h=!1,n[e]?B.text(RED._("projects.create.already-exists")):B.text(RED._("projects.create.must-contain"))):(L.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(w),B.text(RED._("projects.create.must-contain")),h=!0),D=e}var o,i,t=h,e=$(".red-ui-projects-dialog-screen-create-type.selected").data("type");"copy"===e?t=!1:"clone"===e?(i=0<(o=O.val()).length&&!/\s/.test(o),/^https?:\/\/[^/]+@/i.test(o)&&($("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-info-in-url")),i=!1),i?O.removeClass("input-error"):(T&&O.addClass("input-error"),t=!1),/^https?:\/\//.test(o)?($(".red-ui-projects-dialog-screen-create-row-creds").show(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(o)?($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").show()):($(".red-ui-projects-dialog-screen-create-row-creds").hide(),$(".red-ui-projects-dialog-screen-create-row-sshkey").hide())):"empty"===e?(""!==(i=S.val())&&/\.json$/.test(i)?S.hasClass("input-error")&&(S.removeClass("input-error"),S.next().empty()):(t=!1,S.hasClass("input-error")||(S.addClass("input-error"),S.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(t=t&&""!==A.val())):"open"===e&&(t=!!F),$("#red-ui-projects-dialog-create").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)},e=$('<div class="form-row button-group"></div>').appendTo(t),b=$('<button data-type="open" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-folder-open"></i><br/>'+RED._("projects.create.open")+"</button>").appendTo(e),v=$('<button data-type="empty" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>'+RED._("projects.create.create")+"</button>").appendTo(e),y=$('<button data-type="clone" class="red-ui-button red-ui-projects-dialog-button red-ui-projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>'+RED._("projects.create.clone")+"</button>").appendTo(e),o=(e.find(".red-ui-projects-dialog-screen-create-type").on("click",function(e){switch(e.preventDefault(),t.find(".red-ui-projects-dialog-screen-create-type").removeClass("selected"),$(this).addClass("selected"),t.find(".red-ui-projects-dialog-screen-create-row").hide(),t.find(".red-ui-projects-dialog-screen-create-row-"+$(this).data("type")).show(),a(),L.trigger("focus"),$(this).data("type")){case"open":$("#red-ui-projects-dialog-create").text(RED._("projects.create.open"));break;case"empty":$("#red-ui-projects-dialog-create").text(RED._("projects.create.create"));break;case"clone":$("#red-ui-projects-dialog-create").text(RED._("projects.create.clone"))}}),e=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-open"></div>').hide().appendTo(t),r=(r={canSelectActive:!1,dblclick:function(e){F=e,$("#red-ui-projects-dialog-create").trigger("click")},select:function(e){F=e,a()},delete:function(e){n&&delete n[e.name],F=null,a()}})||{},l=$("<div></div>",{class:"red-ui-projects-dialog-project-list-container"}),u="",o=$("<div>",{class:"red-ui-search-container"}).appendTo(l),(p=$('<input id="red-ui-projects-dialog-project-list-search" type="text" placeholder="'+RED._("projects.create-project-list.search")+'">').appendTo(o).searchBox({delay:200,change:function(){u=$(this).val().toLowerCase(),d.editableList("filter"),i&&!i.is(":visible")&&i.children().children().removeClass("selected"),(i=d.children(":visible").first()).children().children().addClass("selected"),r.select&&r.select(i.children().data("data")),s()}})).on("keydown",function(e){if(40===e.keyCode){e.preventDefault();var t=i;if(i){for(;0!==(t=t.next()).length&&!t.is(":visible"););if(0===t.length)return;i.children().children().removeClass("selected")}else t=d.children(":visible").first();(i=t).children().children().addClass("selected"),r.select&&r.select(i.children().data("data")),s()}else if(38===e.keyCode){e.preventDefault();var o=i;if(i){for(;0!==(o=o.prev()).length&&!o.is(":visible"););if(0===o.length)return;i.children().children().removeClass("selected")}else o=d.children(":visible").first();(i=o).children().children().addClass("selected"),r.select&&r.select(i.children().data("data")),s()}else 13===e.keyCode&&(e.preventDefault(),i&&r.dblclick&&r.dblclick(i.children().data("data")))}),p.i18n(),s=function(){var e,t,o,i=d.find(".red-ui-projects-dialog-project-list-entry.selected").parent().parent();1===i.length&&(t=(e=f).height(),e.scrollTop(),t<(o=i.position().top)+(i=i.height())?e.animate({scrollTop:"-="+(t-o-i)},50):o<0&&e.animate({scrollTop:"+="+o},50))},f=$("<div></div>",{class:"red-ui-projects-dialog-project-list-inner-container"}).appendTo(l),d=$("<ol>",{class:"red-ui-projects-dialog-project-list"}).appendTo(f).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(n,e,a){var t,o=$("<div></div>",{class:"red-ui-projects-dialog-project-list-entry"}).appendTo(n);$('<span class="red-ui-projects-dialog-project-list-entry-icon"><i class="fa fa-archive"></i></span>').appendTo(o),$('<span class="red-ui-projects-dialog-project-list-entry-name" style=""></span>').text(a.name).appendTo(o),U&&U.name===a.name&&(o.addClass("projects-list-entry-current"),$('<span class="red-ui-projects-dialog-project-list-entry-current">'+RED._("projects.create-project-list.current")+"</span>").appendTo(o),!1===r.canSelectActive)||(o.addClass("selectable"),t=$('<div class="red-ui-projects-dialog-project-list-entry-tools"></div>').appendTo(o),$('<button class="red-ui-button red-ui-projects-dialog-button red-ui-button-small" style="float: right;"><i class="fa fa-trash"></i></button>').appendTo(t).on("click",function(e){var t,o,i;e.stopPropagation(),e.preventDefault(),e=n,t=a.name,o=function(e){e||n.fadeOut(300,function(){d.editableList("removeItem",a),r.delete&&r.delete(a)})},i=$('<div class="red-ui-projects-dialog-project-list-entry-delete-confirm"></div>').on("click",function(e){e.stopPropagation()}).appendTo(e),$("<span>").text(RED._("projects.delete.confirm")).appendTo(i),$('<button class="red-ui-button red-ui-projects-dialog-button">'+RED._("common.label.cancel")+"</button>").appendTo(i).on("click",function(e){e.stopPropagation(),i.remove(),o(!0)}),$('<button class="red-ui-button red-ui-projects-dialog-button primary">'+RED._("common.label.delete")+"</button>").appendTo(i).on("click",function(e){e.stopPropagation(),i.remove(),J({url:"projects/"+t,type:"DELETE",responses:{200:function(e){o(!1)},400:{unexpected_error:function(e){i.remove(),o(!0)}}}})}),setTimeout(function(){i.css("left",0)},50)}),n.on("click",function(e){$(".red-ui-projects-dialog-project-list-entry").removeClass("selected"),o.addClass("selected"),i=n.parent(),r.select&&r.select(a),s(),p.trigger("focus")}),r.dblclick&&n.on("dblclick",function(e){e.preventDefault(),r.dblclick(a)}))},filter:function(e){return""===u||-1!==e.name.toLowerCase().indexOf(u)}}),$.getJSON("projects",function(e){e.projects.forEach(function(e){d.editableList("addItem",{name:e})})}),l.appendTo(e),e=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-open"></div>').hide().appendTo(t),$('<span style="display: flex; align-items: center;"><input style="padding:0; margin: 0 5px 0 0" checked type="checkbox" id="red-ui-projects-dialog-screen-clear-context"> <label for="red-ui-projects-dialog-screen-clear-context" style="padding:0; margin: 0"> <span data-i18n="projects.create.clearContext"></span></label></span>').appendTo(e).i18n(),e=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(t),$('<label for="red-ui-projects-dialog-screen-create-project-name">'+RED._("projects.create.project-name")+"</label>").appendTo(e),$('<div style="position:relative;"></div>').appendTo(e)),w=(L=$('<input id="red-ui-projects-dialog-screen-create-project-name" type="text"></input>').appendTo(o),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(o)),E=!1,D="",R="",l=(L.on("change keyup paste",function(){if(E=L.val()!==D,g)clearTimeout(g);else if(E&&(w.empty(),$('<img src="red/images/spin.svg"/>').appendTo(w),""===L.val()))return void a();g=setTimeout(function(){a(),g=null},300)}),B=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.must-contain")+"</small></label>").appendTo(e).find("small"),e=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(t),$('<label for="red-ui-projects-dialog-screen-create-project-desc">'+RED._("projects.create.desc")+"</label>").appendTo(e),I=$('<input id="red-ui-projects-dialog-screen-create-project-desc" type="text">').appendTo(e),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.opt")+"</small></label>").appendTo(e),e=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(t),$('<label for="red-ui-projects-dialog-screen-create-project-file">'+RED._("projects.create.flow-file")+"</label>").appendTo(e),o=$('<div style="position:relative;"></div>').appendTo(e),S=$('<input id="red-ui-projects-dialog-screen-create-project-file" type="text">').val("flow.json").on("change keyup paste",a).appendTo(o),$('<div class="red-ui-projects-dialog-screen-input-status"></div>').appendTo(o),$('<label class="red-ui-projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(e),e=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-empty"></div>').appendTo(t),$("<label>"+RED._("projects.create.credentials")+"</label>").appendTo(e),$('<div class="red-ui-projects-dialog-credentials-box">').appendTo(e)),x=$('<div class="red-ui-projects-dialog-credentials-box-right">').appendTo(l),l=$('<div class="red-ui-projects-dialog-credentials-box-left">').appendTo(l),_=$('<div class="form-row red-ui-projects-dialog-credentials-box-enabled"></div>').appendTo(l),k=($('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="enabled"> <i class="fa fa-lock"></i> <span>'+RED._("projects.encryption-config.enable")+"</span></label>").appendTo(_),$('<div class="form-row red-ui-projects-dialog-credentials-box-disabled disabled"></div>').appendTo(l)),T=($('<label class="red-ui-projects-edit-form-inline-label"><input type="radio" name="projects-encryption-type" value="disabled"> <i class="fa fa-unlock"></i> <span>'+RED._("projects.encryption-config.disable")+"</span></label>").appendTo(k),l.find("input[name=projects-encryption-type]").on("click",function(e){var t,o;"enabled"===$(this).val()?(t=_,o=k,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&A.trigger("focus")):(o=_,t=k,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.removeClass("disabled"),o.addClass("disabled"),a()}),e=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(x),$('<label class="red-ui-projects-edit-form-inline-label">'+RED._("projects.create.encryption-key")+"</label>").appendTo(e),(A=$('<input type="password"></input>').appendTo(e)).typedInput({type:"cred"}),A.on("change keyup paste",a),$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.desc0")+"</small></label>").appendTo(e),e=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(x),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> '+RED._("projects.create.desc1")+"</div>").appendTo(e),x.find("input[name=projects-encryption-key]").on("click",function(){var e=$(this).val();A.attr("disabled","default"===e),"custom"===e&&A.trigger("focus"),a()}),e=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(t),$('<label for="red-ui-projects-dialog-screen-create-project-repo">'+RED._("projects.create.git-url")+"</label>").appendTo(e),O=$('<input id="red-ui-projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(e),$('<label id="red-ui-projects-dialog-screen-create-project-repo-label" class="red-ui-projects-edit-form-sublabel"><small>'+RED._("projects.create.protocols")+"</small></label>").appendTo(e),!1),C="",l=(O.on("change keyup paste",function(){T=!0;var e,t=$(this).val(),t=(C!==t&&$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),C=t,/\/([^/]+?)(?:\.git)?$/.exec(t));t&&(""!==(e=L.val())&&e!==R||(R=t[1],L.val(R),L.trigger("change"))),a()}),$('<div class="hide red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').hide().appendTo(t)),o=(e=$('<div class="form-row red-ui-projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(l),$('<div><i class="fa fa-warning"></i> '+RED._("projects.create.auth-failed")+"</div>").appendTo(e),e=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row-creds"></div>').hide().appendTo(l),$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(e)),j=($('<label for="red-ui-projects-dialog-screen-create-project-repo-user">'+RED._("projects.create.username")+"</label>").appendTo(o),M=$('<input id="red-ui-projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(o),o=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(e),$('<label for="red-ui-projects-dialog-screen-create-project-repo-pass">'+RED._("projects.create.password")+"</label>").appendTo(o),(z=$('<input style="width:100%" id="red-ui-projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(o)).typedInput({type:"cred"}),e=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(l),o=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(e),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.ssh-key")+"</label>").appendTo(o),N=$("<select>",{style:"width: 100%"}).appendTo(o),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){N.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(N.addClass("input-error"),N.attr("disabled",!0),j.show()):(N.removeClass("input-error"),N.attr("disabled",!1),j.hide())}),o=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(e),$('<label for="red-ui-projects-dialog-screen-create-project-repo-passphrase">'+RED._("projects.create.passphrase")+"</label>").appendTo(o),(G=$('<input id="red-ui-projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(o)).typedInput({type:"cred"}),o=$('<div class="form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-sshkey"></div>').appendTo(l),$('<div class="red-ui-projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(o));switch($('<div class="form-row"><i class="fa fa-warning"></i> '+RED._("projects.create.desc2")+"</div>").appendTo(j),o=$('<div style="text-align: center">').appendTo(j),$('<button class="red-ui-button red-ui-projects-dialog-button">'+RED._("projects.create.add-ssh-key")+"</button>").appendTo(o).on("click",function(e){e.preventDefault(),$("#red-ui-projects-dialog-cancel").trigger("click"),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").trigger("click")},500)}),e=$('<div class="hide form-row red-ui-projects-dialog-screen-create-row red-ui-projects-dialog-screen-create-row-clone"></div>').appendTo(t),$("<label>"+RED._("projects.create.credentials-encryption-key")+"</label>").appendTo(e),(P=$('<input style="width:100%" type="password"></input>').appendTo(e)).typedInput({type:"cred"}),c.screen||"empty"){case"empty":v.trigger("click");break;case"open":b.trigger("click");break;case"clone":y.trigger("click")}return setTimeout(function(){("open"!==(c.screen||"empty")?L:$("#red-ui-projects-dialog-project-list-search")).trigger("focus")},50),t},buttons:function(e){var t;switch(e.screen||"empty"){case"open":t=RED._("projects.create.open");break;case"empty":t=RED._("projects.create.create");break;case"clone":t=RED._("projects.create.clone")}return[{id:"red-ui-projects-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"red-ui-projects-dialog-create",text:t,class:"primary disabled",disabled:!0,click:function(){var t,o,e=$(".red-ui-projects-dialog-screen-create-type.selected").data("type"),i={name:L.val()};if("empty"===e){i.summary=I.val(),i.files={flow:S.val()};var n=$("input[name=projects-encryption-type]:checked").val();i.credentialSecret="enabled"===n&&A.val()}else if("copy"===e)i.copy=(void 0).name;else if("clone"===e){i.credentialSecret=P.val();var n=O.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(n)){var a=N.val();if(!a)return void console.log(RED._("projects.create.cant-get-ssh-key-path"));i.git={remotes:{origin:{url:n,keyFile:a,passphrase:G.val()}}}}else i.git={remotes:{origin:{url:n,username:M.val(),password:z.val()}}}}else if("open"===e)return a=$("#red-ui-projects-dialog-screen-clear-context").prop("checked"),t=F.name,n=a,o=function(e,t){e&&"credentials_load_failed"!==e.code&&console.log(RED._("projects.create.unexpected_error"),e)},RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(t),void J({url:"projects/"+t,type:"PUT",responses:{200:function(e){o(null,e)},400:{credentials_load_failed:function(e){T.dialog("close"),RED.events.emit("project:change",{name:t}),o(null,e)},"*":o}}},{active:!0,clearContext:n}).then(function(){T.dialog("close"),RED.events.emit("project:change",{name:t})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)});$(".red-ui-projects-dialog-screen-create-row-auth-error").hide(),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.protocols")),M.removeClass("input-error"),z.removeClass("input-error"),N.removeClass("input-error"),G.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(i.name),J({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(e){T.dialog("close")},400:{project_exists:function(e){console.log(RED._("projects.create.already-exists-2"))},git_error:function(e){console.log(RED._("projects.create.git-error"),e)},git_connection_failed:function(e){O.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.con-failed"))},git_not_a_repository:function(e){O.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.not-git"))},git_repository_not_found:function(e){O.addClass("input-error"),$("#red-ui-projects-dialog-screen-create-project-repo-label small").text(RED._("projects.create.no-resource"))},git_auth_failed:function(e){$(".red-ui-projects-dialog-screen-create-row-auth-error").show(),M.addClass("input-error"),z.addClass("input-error"),N.addClass("input-error"),G.addClass("input-error")},missing_flow_file:function(e){T.dialog("close")},missing_package_file:function(e){T.dialog("close")},project_empty:function(e){T.dialog("close")},credentials_load_failed:function(e){T.dialog("close")},"*":function(e){p(e),$(T).dialog("close")}}}},i).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}}function u(e,t){T||RED.projects.init();var e=a[e],o=e.content(t||{}),i=(n.empty(),e.buttons),t=("function"==typeof i&&(i=i(t||{})),T.dialog("option","buttons",i),n.append(o),590),i=$(window).height();i<750&&(t=590-(750-i)),$(".red-ui-projects-dialog-box").height(t),$(".red-ui-projects-dialog-project-list-inner-container").height(Math.max(500,t)-210),T.dialog("option","title",e.title||""),T.dialog("open")}function e(e){var t,o;RED.nodes.dirty()&&(t=RED._("projects.require-clean.confirm"),o=RED.notify(t,{type:"info",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.close(),e(!0)}},{text:RED._("common.label.cont"),click:function(){o.close(),e(!1)}}]}))}function J(l,c){var t,o;if(l.requireCleanWorkspace&&RED.nodes.dirty())return e(function(e){e?l.cancel&&(l.cancel(),o&&o()):(delete l.requireCleanWorkspace,J(l,c).then(function(){t&&t()}).always(function(){o&&o()}))}),{then:function(e){return t=e,{always:function(e){o=e}}},always:function(e){o=e}};var u,p,i=Date.now();return $(".red-ui-component-spinner").show(),$("#red-ui-projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility","hidden"),c&&(l.data=JSON.stringify(c),l.contentType="application/json; charset=utf-8"),$.ajax(l).done(function(e,t,o){l.responses&&l.responses[200]&&(u=l.responses[200],p=e)}).fail(function(o,e,t){var i,n,a,r,s,d;if(l.responses&&l.responses[o.status]){if("function"==typeof(i=l.responses[o.status]))return void(p={error:(u=i).statusText});if(!1===l.handleAuthFail||"git_auth_failed"!==o.responseJSON.code&&"git_host_key_verification_failed"!==o.responseJSON.code){if(i[o.responseJSON.code])return u=i[o.responseJSON.code],void(p=o.responseJSON);if(i["*"])return u=i["*"],void(p=o.responseJSON)}else{if("git_auth_failed"===o.responseJSON.code)return a=U.git.remotes[o.responseJSON.remote||l.remote||"origin"].fetch,s=$('<div><div class="form-row">'+RED._("projects.send-req.auth-req")+':</div><div class="form-row"><div style="margin-left: 20px;">'+a+"</div></div></div>"),n=!1,/^https?:\/\//.test(a)?($('<div class="form-row"><label for="projects-user-auth-username">'+RED._("projects.send-req.username")+'</label><input id="projects-user-auth-username" type="text"></input></div><div class="form-row"><label for="projects-user-auth-password">'+RED._("projects.send-req.password")+'</label><input id="projects-user-auth-password" type="password"></input></div>').appendTo(s),s.find("#projects-user-auth-password").typedInput({type:"cred"})):/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(a)&&(n=!0,a=$('<div class="form-row"></div>').appendTo(s),$('<label for="projects-user-auth-key">SSH Key</label>').appendTo(a),r=$('<select id="projects-user-auth-key">').width("70%").appendTo(a),$.getJSON("settings/user/keys",function(e){e.keys.forEach(function(e){r.append($("<option></option>").val(e.name).text(e.name)),0})}),a=$('<div class="form-row"></div>').appendTo(s),$('<label for="projects-user-auth-passphrase">'+RED._("projects.send-req.passphrase")+"</label>").appendTo(a),$('<input id="projects-user-auth-passphrase" type="password"></input>').appendTo(a).typedInput({type:"cred"})),void(d=RED.notify(s,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){d.close()}},{text:'<span><i class="fa fa-refresh"></i> '+RED._("projects.send-req.retry")+"</span>",click:function(){c=c||{};function t(e){e?(console.log(RED._("projects.send-req.update-failed")),console.log(e)):(J(l,c),d.close())}var e={};n?(e.keyFile=$("#projects-user-auth-key").val(),e.passphrase=$("#projects-user-auth-passphrase").val()):(e.username=$("#projects-user-auth-username").val(),e.password=$("#projects-user-auth-password").val());J({url:"projects/"+U.name+"/remotes/"+(o.responseJSON.remote||l.remote||"origin"),type:"PUT",responses:{0:function(e){t(e)},200:function(e){t(null)},400:{unexpected_error:function(e){t(e)}}}},{auth:e})}}]}));if("git_host_key_verification_failed"===o.responseJSON.code)return s=$('<div><div class="form-row">'+RED._("projects.send-req.host-key-verify-failed")+"</div></div>"),void(d=RED.notify(s,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.close"),click:function(){d.close()}}]}))}}console.log(i),console.log(RED._("projects.send-req.unhandled")+":"),console.log(o),console.log(e),console.log(t)}).always(function(){var e=Date.now()-i,e=Math.max(0,500-e);setTimeout(function(){$(".red-ui-component-spinner").hide(),$("#red-ui-projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility",""),u&&u(p)},e)})}function i(i){var n,a="",r=new Set,s=[],d="",l=$('<div class="red-ui-projects-branch-list">').appendTo(i.container),c=$('<input type="text">').attr("placeholder",i.placeholder).appendTo(l).searchBox({delay:200,change:function(){a=$(this).val();var e=!1,t=!1,o=/^([^/]+)\/[^/.~*?\[]/.exec(a);o&&-1<s.indexOf(o[1])&&(t=e=!0),!e&&/(\.\.|\/\.|[?*[~^: \\]|\/\/|\/.$|\/$)/.test(a)?(n.hasClass("input-error")||(n.addClass("input-error"),n.find("i").addClass("fa-warning").removeClass("fa-code-fork")),n.find("span").text(RED._("projects.create-branch-list.invalid")+": "+(t?"":d)+a)):(n.hasClass("input-error")&&(n.removeClass("input-error"),n.find("i").removeClass("fa-warning").addClass("fa-code-fork")),n.find("span").text(RED._("projects.create-branch-list.create")+":"),n.find(".red-ui-sidebar-vc-branch-list-entry-create-name").text((t?"":d)+a)),u.editableList("filter")}}),u=$("<ol>",{style:"height: 130px;"}).appendTo(l);return u.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){e=$('<div class="red-ui-sidebar-vc-branch-list-entry">').appendTo(e);o.hasOwnProperty("commit")?($('<i class="fa fa-code-fork"></i>').appendTo(e),$("<span>").text(o.name).appendTo(e),o.current&&(e.addClass("selected"),$('<span class="current"></span>').text(i.currentLabel||RED._("projects.create-branch-list.current")).appendTo(e))):(n=e,$('<i class="fa fa-code-fork"></i>').appendTo(e),$("<span>").text(RED._("projects.create-branch-list.create")+":").appendTo(e),$('<div class="red-ui-sidebar-vc-branch-list-entry-create-name" style="margin-left: 10px;">').text(o.name).appendTo(e)),e.on("click",function(e){var t;e.preventDefault(),$(this).hasClass("input-error")||(e={},o.hasOwnProperty("commit")?($(this).hasClass("selected")&&(e.current=!0),e.name=o.name):(e.name=c.val(),e.create=!0,i.remotes&&((t=/^([^/]+)\/[^/.~*?\[]/.exec(e.name))&&-1!==s.indexOf(t[1])||(e.name=s[0]+"/"+e.name))),i.onselect&&i.onselect(e))})},filter:function(e){var t,o=!e.hasOwnProperty("commit"),i=a;return 0<s.length&&(t=/^([^/]+)\/[^/.~*?\[]/.exec(i),""===i||t&&-1!=s.indexOf(t[1])||(i=s[0]+"/"+i)),o&&""!==i&&!r.has(i)||!o&&-1!==e.name.indexOf(a)}}),{refresh:function(e){c.searchBox("value",""),u.editableList("empty");var t=Date.now(),o=f(l).addClass("red-ui-component-spinner-contain");i.remotes?(s=i.remotes(),d=s[0]+"/"):(d="",s=[]),r=new Set,J({url:e,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){e.branches,e.branches.forEach(function(e){u.editableList("addItem",e),r.add(e.name)}),u.editableList("addItem",{}),setTimeout(function(){o.remove()},Math.max(300-(Date.now()-t),0))},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){p(e)}}}})},filter:function(){u.editableList("filter")},focus:function(){c.trigger("focus")}}}function f(e){return $('<div class="red-ui-component-spinner"><img src="red/images/spin.svg"/></div>').appendTo(e)}function t(){createProjectOptions={},U?u("create",{screen:"empty"}):u("welcome")}return{init:function(){T=$('<div id="red-ui-projects-dialog" class="hide red-ui-projects-edit-form"><div class="red-ui-projects-dialog-box"><form class="form-horizontal"></form><div class="red-ui-component-spinner hide"><img src="red/images/spin.svg"/></div></div></div>').appendTo("#red-ui-editor").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){RED.keyboard.disable()},close:function(e){RED.keyboard.enable()},classes:{"ui-dialog":"red-ui-editor-dialog","ui-dialog-titlebar-close":"hide","ui-widget-overlay":"red-ui-editor-dialog"}}),n=T.find("form"),RED.actions.add("core:new-project",RED.projects.newProject),RED.actions.add("core:open-project",RED.projects.selectProject),RED.actions.add("core:show-project-settings",RED.projects.settings.show);var e={sendRequest:J,createBranchList:i,addSpinnerOverlay:f,reportUnexpectedError:p};RED.projects.settings.init(e),RED.projects.userSettings.init(e),RED.sidebar.versionControl.init(e),o()},showStartup:function(){console.warn("showStartup"),RED.user.hasPermission("projects.write")?u("welcome"):RED.notify(RED._("user.errors.notAuthorized"),"error")},newProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?e(function(e){e||t()}):void t();RED.notify(RED._("user.errors.notAuthorized"),"error")},selectProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?e(function(e){e||u("create",{screen:"open"})}):void u("create",{screen:"open"});RED.notify(RED._("user.errors.notAuthorized"),"error")},showCredentialsPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showFilesPrompt:function(){RED.user.hasPermission("projects.write")?(RED.projects.settings.show("settings"),setTimeout(function(){$("#project-settings-tab-settings-file-edit").trigger("click")},200)):RED.notify(RED._("user.errors.notAuthorized"),"error")},showProjectDependencies:function(){RED.projects.settings.show("deps")},createDefaultFileSet:function(){if(!U)throw new Error(RED._("projects.create-default-file-set.no-active"));if(!U.empty)throw new Error(RED._("projects.create-default-file-set.no-empty"));RED.user.hasPermission("projects.write")?(createProjectOptions={},u("default-files",{existingProject:!0})):RED.notify(RED._("user.errors.notAuthorized"),"error")},createDefaultPackageFile:function(){RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(U.name),J({url:"projects/"+U.name,type:"PUT",requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){},400:{git_error:function(e){console.log(RED._("projects.create-default-file-set.git-error"),e)},missing_flow_file:function(e){$(T).dialog("close")},"*":function(e){p(e),$(T).dialog("close")}}}},{initialise:!0}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})},refresh:function(t){$.getJSON("projects",function(e){e.active?$.getJSON("projects/"+e.active,function(e){U=e,RED.events.emit("projects:load",U),RED.sidebar.versionControl.refresh(!0),t&&t(U)}):t&&t(null)})},editProject:function(){RED.projects.settings.show()},getActiveProject:function(){return U}}}(),RED.projects.settings=function(){var B,G,t=700,o=!1,r=[];function i(e){r.push(e)}function s(i,n){RED.editor.editMarkdown({title:RED._("sidebar.project.editDescription"),header:$('<span><i class="fa fa-book"></i> README.md</span>'),value:i.description,complete:function(o){n.empty();function t(e,t){if(e)return s(i,n);i.description=o,d(i,n)}var e=G.addSpinnerOverlay(n);G.sendRequest({url:"projects/"+i.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){t(null),RED.sidebar.versionControl.refresh(!0)},400:{"*":function(e){G.reportUnexpectedError(e),t(e)}}}},{description:o}).always(function(){e.remove()})}})}function d(e,t){t.empty(),e=e.description?RED.utils.renderMarkdown(e.description):'<span class="red-ui-help-info-none">'+RED._("sidebar.project.noDescriptionAvailable")+"</span>",e=$('<span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span>"),$(e).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),e.appendTo(t).find(".red-ui-text-bidi-aware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>")}function g(a,r,s,d,l){var c=s.prev(),e=(c.hide(),s.empty(),l.empty(),$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').appendTo(s)),u=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(r||"").appendTo(s),p=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(d||"").appendTo(l);$('<button class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(e).on("click",function(e){e.preventDefault(),f(a.summary,s),h(a.version,l),c.show()}),$('<button class="red-ui-button">'+RED._("common.label.save")+"</button>").appendTo(e).on("click",function(e){e.preventDefault();function t(e,t){if(e)return n.remove(),g(a,r,s,d,l);a.summary=o,a.version=i,n.remove(),f(a.summary,s),h(a.version,l),c.show()}var o=u.val(),i=p.val(),n=(f(o,s),h(i,l),G.addSpinnerOverlay(s).addClass("red-ui-component-spinner-contain"));G.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),t(null)},400:{"*":function(e){G.reportUnexpectedError(e),t(e)}}}},{summary:o,version:i})})}function f(e,t){t.empty(),e?t.text(e).removeClass("red-ui-help-info-none"):t.text(RED._("sidebar.project.noSummaryAvailable")).addClass("red-ui-help-info-none")}function h(e,t){t.empty(),e&&t.text(e)}function n(t){var e=$('<div id="red-ui-project-settings-tab-main" class="red-ui-project-settings-tab-pane red-ui-help"></div>'),o=($("<h1>").text(t.name).appendTo(e),$('<div style="position: relative">').appendTo(e)),i=$("<div></div>").appendTo(o),n=$("<div></div>").addClass("red-ui-help-info-none").appendTo(o),o=(f(t.summary,i),h(t.version,n),RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.editDescription")+"</button>").prependTo(o).on("click",function(e){e.preventDefault(),g(t,t.summary,i,t.version,n)}),$("<hr>").appendTo(e),$('<div class="red-ui-help" style="position: relative"></div>').appendTo(e)),a=$("<div>",{style:"min-height: 200px"}).appendTo(o);return d(t,a),RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.editReadme")+"</button>").prependTo(o).on("click",function(e){e.preventDefault(),s(t,a)}),e}function u(e,t){t.editableList("empty");var o,i=0;for(n in c)c.hasOwnProperty(n)&&(t.editableList("addItem",{id:c[n].module,version:c[n].version,count:c[n].count,known:e.dependencies.hasOwnProperty(n),installed:!0}),i++,0===c[n].count&&0,e.dependencies.hasOwnProperty(n)||0);if(e.dependencies)for(var n in e.dependencies)e.dependencies.hasOwnProperty(n)&&!c.hasOwnProperty(n)&&(o=!!RED.nodes.registry.getModule(n),t.editableList("addItem",{id:n,version:e.dependencies[n],count:0,known:!0,installed:o}),i++,o?0:0);0===i&&t.editableList("addItem",{index:0,label:RED._("sidebar.project.projectSettings.none")})}function l(e,t,o,i){function n(e,t){if(r.remove(),e)return i(e);a.dependencies=o,RED.sidebar.versionControl.refresh(!0),i()}var a=RED.projects.getActiveProject(),r=G.addSpinnerOverlay(t).addClass("red-ui-component-spinner-contain");G.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){n(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),n(null)},400:{"*":function(e){n(e)}}}},{dependencies:o})}function a(s){var t=$('<div id="red-ui-project-settings-tab-deps" class="red-ui-project-settings-tab-pane red-ui-help"></div>'),d=(RED.user.hasPermission("projects.write")&&$('<button class="red-ui-button red-ui-button-small" style="margin-top:10px;float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(t).on("click",function(e){e.preventDefault(),function i(n,e,a,r){e=e||JSON.stringify(n.dependencies||{},"",4);"{}"===e&&(e="{\n\n}"),RED.editor.editJSON({title:RED._("sidebar.project.editDependencies"),value:e,requireValid:!0,complete:function(t){try{var o=JSON.parse(t);l(0,a,o,function(e){if(e)return i(n,t,a,r);n.dependencies=o,u(n,r)})}catch(e){i(n,t,a,r)}}})}(s,null,t,d)}),$("<ol>",{style:"position: absolute;top: 60px;bottom: 20px;left: 20px;right: 20px;"}).appendTo(t));return d.editableList({addButton:!1,addItem:function(t,e,o){var i,n,a,r=$("<div>",{class:"red-ui-palette-module-header"}).appendTo(t);o.label?(0===o.index?r.addClass("red-ui-search-empty"):t.parent().addClass("red-ui-palette-module-section"),r.text(o.label)):(r.addClass("red-ui-palette-module-header"),o.installed?0===o.count?r.addClass("red-ui-palette-module-unused"):o.known||r.addClass("red-ui-palette-module-unknown"):r.addClass("red-ui-palette-module-not-installed"),o.element=r,i=$('<div class="red-ui-palette-module-meta red-ui-palette-module-name"></div>').appendTo(r),n="fa-cube",o.installed||(n="fa-warning"),n=$('<i class="fa '+n+'"></i>').appendTo(i),o.icon=n,$("<span>").text(o.id).appendTo(i),n=$('<div class="red-ui-palette-module-meta red-ui-palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(r),$("<span>").text(o.version).appendTo(n),n=$('<div class="red-ui-palette-module-meta"></div>').appendTo(r),a=$('<div class="red-ui-palette-module-button-group"></div>').appendTo(n),RED.user.hasPermission("projects.write")&&(o.installed||!1===RED.settings.get("externalModules.palette.allowInstall",!0)?o.known&&0===o.count?$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.removeFromProject")+"</a>").appendTo(a).on("click",function(e){e.preventDefault();e=$.extend(!0,{},s.dependencies);delete e[o.id],l(0,t,e,function(e){e?console.log(e):t.fadeOut(200,function(){d.editableList("removeItem",o)})})}):o.known||$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.addToProject")+"</a>").appendTo(a).on("click",function(e){e.preventDefault();e=$.extend(!0,{},s.dependencies);e[o.id]=c[o.id].version,l(0,t,e,function(e){e?console.log(e):(a.remove(),r.removeClass("red-ui-palette-module-unknown"))})}):$('<a href="#" class="red-ui-button red-ui-button-small">'+RED._("sidebar.project.projectSettings.install")+"</a>").appendTo(a).on("click",function(e){e.preventDefault(),RED.palette.editor.install(o,t,function(e){e||(o.installed=!0,RED.utils.addSpinnerOverlay(t,!0),setTimeout(function(){d.editableList("removeItem",o),c={},RED.nodes.eachNode(v),RED.nodes.eachConfig(v),c.hasOwnProperty(o.id)?o.count=c[o.id].count:o.count=0,d.editableList("addItem",o)},500))})})))},sort:function(e,t){return e.id.localeCompare(t.id)}}),u(s,d),t}function F(e,t,i,a,r){var s=$('<div class="red-ui-projects-file-listing-container"></div>',{style:"position: relative; min-height: 175px; height: 175px;"}).hide().appendTo(e),d=G.addSpinnerOverlay(s);return $.getJSON("projects/"+t.name+"/files",function(t){var e=(e=Object.keys(t)).filter(function(e){return!t[e].status||!/D/.test(t[e].status)}),o={},n=(e.sort(),e.forEach(function(e){e.split("/").reduce(function(e,t,o,i){if(t)return o<i.length-1?e[t]=e[t]||{}:e[t]=!0,e[t]},o)}),function(e,t,o){var i={name:e||"/",path:o+(o?"/":"")+e};return!0===t?i.type="f":(i.type="d",i.children=[],i.path=i.path,Object.keys(t).forEach(function(e){i.children.push(n(e,t[e],i.path))}),i.children.sort(function(e,t){return e.hasOwnProperty("children")&&!t.hasOwnProperty("children")?-1:!e.hasOwnProperty("children")&&t.hasOwnProperty("children")?1:e.name.localeCompare(t.name)})),i}),o=n("",o,"");!function a(e,t,r,s,d,o){o=o||"";var i=$("<ol>",{class:"red-ui-projects-dialog-file-list",style:o}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){var i,n=$("<div></div>",{class:"red-ui-projects-dialog-file-list-entry"}).appendTo(e);o.children?($('<span class="red-ui-projects-dialog-file-list-entry-folder"><i class="fa fa-angle-right"></i> <i class="fa fa-folder-o"></i></span>').appendTo(n),0<o.children.length&&(i=$("<div></div>",{style:"padding-left: 20px;"}).appendTo(e),0===r.indexOf(o.path+"/")?n.addClass("expanded"):i.hide(),a(i,o.children,r,s,d),n.addClass("selectable"),n.on("click",function(e){$(this).hasClass("expanded")?($(this).removeClass("expanded"),i.slideUp(200)):($(this).addClass("expanded"),i.slideDown(200))}))):(e="fa-file-o",/\.json$/i.test(o.name)?e="fa-file-code-o":/\.md$/i.test(o.name)?e="fa-book":/^\.git/i.test(o.name)&&(e="fa-code-fork",n.addClass("red-ui-projects-dialog-file-list-entry-file-type-git")),$('<span class="red-ui-projects-dialog-file-list-entry-file"> <i class="fa '+e+'"></i></span>').appendTo(n),s(o)?(n.addClass("selectable"),o.path===r&&n.addClass("selected"),n.on("click",function(e){$(".red-ui-projects-dialog-file-list-entry.selected").removeClass("selected"),$(this).addClass("selected"),d(o.path,!0)}),n.on("dblclick",function(e){e.preventDefault(),d(o.path,!0)})):n.addClass("unselectable")),$('<span class="red-ui-projects-dialog-file-list-entry-name" style=""></span>').text(o.name).appendTo(n)}});o||i.parent().css("overflow-y","");t.forEach(function(e){i.editableList("addItem",e)})}(s,o.children,i,a,r,"height: 175px"),d.remove()}),s}function p(a,e){function c(){u.show(),A.hide(),g.hide(),v.show(),s.hide(),w.hide(),n.removeClass("uneditable-input"),n.css("height",""),w.removeClass("selected"),r.find(".red-ui-projects-file-listing-container").remove(),r.css("height",""),r.css("color",""),$(".red-ui-settings-row-credentials").hide(),l.hide(),_.hide(),k.removeClass("selected"),T.removeClass("selected")}var u,t=$("<h3></h3>").text(RED._("sidebar.project.projectSettings.files")).appendTo(e),p=$('<div class="red-ui-settings-section"></div>').appendTo(e),o=(RED.user.hasPermission("projects.write")&&(u=$('<button type="button" id="red-ui-project-settings-tab-settings-file-edit" class="red-ui-button red-ui-button-small" style="float: right;">'+RED._("sidebar.project.projectSettings.edit")+"</button>").appendTo(t).on("click",function(e){e.preventDefault(),A.show(),u.hide(),a.files.package||(i.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.packageCreate")),i.show()),g.show(),v.hide(),s.show(),w.show(),y(),n.addClass("uneditable-input"),$(".red-ui-settings-row-credentials").show(),n.css("height","auto"),l.hide(),_.show()})),e=$('<div class="red-ui-settings-row"></div>').appendTo(p),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.package")).appendTo(e),$('<div class="uneditable-input" style="padding:0">').appendTo(e)),f=$('<span style="display:inline-block;  padding: 6px">').text(a.files.package||"package.json").appendTo(o),h=$('<input type="hidden">').val(a.files.package||"package.json").appendTo(o),g=$('<button type="button" class="red-ui-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(o).on("click",function(e){var t;$(this).hasClass("selected")?($(this).removeClass("selected"),o.find(".red-ui-projects-file-listing-container").slideUp(200,function(){$(this).remove(),o.css("height","")}),o.css("color","")):($(this).addClass("selected"),o.css("color","inherit"),t=F(o,a,h.val(),function(e){return e.children||/package\.json$/.test(e.path)},function(e,t){e&&(h.val(e),f.text(e),e=e.substring(0,e.length-12),m.text(e),D.text(e),y(),i.hide()),t&&$(g).trigger("click"),d()}),o.css("height","auto"),setTimeout(function(){t.slideDown(200)},50))}),i=(RED.popover.tooltip(g,RED._("sidebar.project.projectSettings.selectFile")),$('<label style="margin-left: 110px" class="red-ui-projects-edit-form-sublabel"><small><span class="form-warning"><i class="fa fa-warning"></i> <span class="red-ui-projects-edit-form-sublabel-text"></span></small></label>').appendTo(e).hide()),t=(a.files.package||(i.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),i.show()),a.files.package||"package.json"),t=t.substring(0,t.length-12),e=$('<div class="red-ui-settings-row"></div>').appendTo(p),r=($('<label for=""></label>').text(RED._("sidebar.project.projectSettings.flow")).appendTo(e),$('<div class="uneditable-input" style="padding:0">').appendTo(e)),m=$('<span style="display:inline-block; padding: 6px 0 6px 6px">').text(t).appendTo(r),b="flows.json",v=(a.files.flow&&(b=0===a.files.flow.indexOf(t)?a.files.flow.substring(t.length):a.files.flow),$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(b).appendTo(r)),y=function(){s.css({width:"calc(100% - "+(w.width()+m.width())+"px)"})},s=$('<input type="text" style="padding-left:1px; margin-top: -2px; margin-bottom: 0;border: none;">').val(b).hide().appendTo(r),w=$('<button type="button" class="red-ui-button toggle single" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(r).on("click",function(e){var t,o,i,n;$(this).hasClass("selected")?($(this).removeClass("selected"),r.find(".red-ui-projects-file-listing-container").slideUp(200,function(){$(this).remove(),r.css("height","")}),r.css("color","")):($(this).addClass("selected"),r.css("color","inherit"),t=h.val(),o=t.substring(0,t.length-12),i=new RegExp("^"+o+".*.json$"),n=F(r,a,s.val(),function(e){return!/package.json$/.test(e.path)&&i.test(e.path)&&!/_cred\.json$/.test(e.path)},function(e,t){e&&s.val(e.substring(o.length)),t&&$(w).trigger("click"),d()}),r.css("height","auto"),setTimeout(function(){n.slideDown(200)},50))}),E=(RED.popover.tooltip(w,RED._("sidebar.project.projectSettings.selectFile")),e=$('<div class="red-ui-settings-row"></div>').appendTo(p),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.credentials")).appendTo(e),"flows_cred.json"),b=(a.files.credentials&&(E=0===a.files.flow.indexOf(t)?a.files.credentials.substring(t.length):a.files.credentials),$('<div class="uneditable-input" style="padding:0">').appendTo(e)),D=$('<span style="display:inline-block;padding: 6px 0 6px 6px">').text(t).appendTo(b),R=$('<span style="display:inline-block; padding: 6px 6px 6px 0">').text(E).appendTo(b),x=$('<input type="hidden">').val(E).insertAfter(b),d=function(){var e=s.val(),t=/^(.+?)(\.[^.]*)?$/.exec(e),t=(t?R.text(t[1]+"_cred"+(t[2]||".json")):""===e&&R.text(""),x.val(R.text()),""===e||/\.\./.test(e)||/\/$/.test(e)),e=t||""===R.text();S.is(":visible")&&(O.toggleClass("input-error",""===O.val()),e=e||""===O.val()),N.is(":visible")&&(I.toggleClass("input-error",""===I.val()),e=e||""===I.val()),s.toggleClass("input-error",t),M.toggleClass("disabled",e),M.prop("disabled",e)},n=(s.on("change keyup paste",d),e=$('<div class="red-ui-settings-row"></div>').appendTo(p),$("<label></label>").appendTo(e),$('<span><i class="user-settings-credentials-state-icon fa"></i> <span class="user-settings-credentials-state"></span></span>').appendTo(e)),_=$('<span class="button-group" style="margin-left: -72px;">').hide().appendTo(e),k=(n.css("color","#666"),_.css("vertical-align","top"),$('<button type="button" class="red-ui-button" style="vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-trash-o"></i></button>').appendTo(_).on("click",function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),l.hide()):(I.val(""),S.hide(),N.show(),$(this).addClass("selected"),T.removeClass("selected"),L.show(),P.show(),C.hide(),j.hide(),l.show()),d()})),T=(RED.popover.tooltip(k,RED._("sidebar.project.projectSettings.resetTheEncryptionKey")),$('<button type="button" class="red-ui-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-pencil"></i></button>').appendTo(_).on("click",function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),l.hide()):(O.val(""),I.val(""),a.settings.credentialSecretInvalid||!a.settings.credentialsEncrypted?(C.show(),j.hide(),S.hide()):(S.show(),C.hide(),j.show()),N.show(),T.addClass("selected"),k.removeClass("selected"),L.hide(),P.hide(),l.show()),d()})),l=(RED.popover.tooltip(T,RED._("sidebar.project.projectSettings.changeTheEncryptionKey")),$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').hide().appendTo(p),$("<div>",{style:"margin-top:10px"}).hide().appendTo(n)),C=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.setTheEncryptionKey")+"</div>").hide().appendTo(l),j=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.changeTheEncryptionKey")+"</div>").hide().appendTo(l),L=$('<div style="margin: 20px 0 10px 5px;">'+RED._("sidebar.project.projectSettings.resetTheEncryptionKey")+"</div>").hide().appendTo(l),S=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').appendTo(l),O=($('<label for=""></label>').text(RED._("sidebar.project.projectSettings.currentKey")).appendTo(S),$('<input type="text">').appendTo(S).typedInput({type:"cred"}).on("change keyup paste",function(){B&&(B.close(),B=null),d()})),N=$('<div class="red-ui-settings-row red-ui-settings-row-credentials"></div>').appendTo(l),I=($('<label for=""></label>').text(RED._("sidebar.project.projectSettings.newKey")).appendTo(N),$('<input type="text">').appendTo(N).typedInput({type:"cred"}).on("change keyup paste",d)),P=$('<div class="form-tips form-warning" style="margin: 10px;"><i class="fa fa-warning"></i>'+RED._("sidebar.project.projectSettings.credentialsAlert")+"</div>").hide().appendTo(l),A=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').hide().appendTo(p),M=($('<button type="button" class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(A).on("click",function(e){e.preventDefault();e=a.files.package||"package.json",e=e.substring(0,e.length-12);m.text(e),D.text(e),f.text(a.files.package||"package.json"),a.files.package?i.hide():(i.find(".red-ui-projects-edit-form-sublabel-text").text(RED._("sidebar.project.projectSettings.fileNotExist")),i.show()),s.val(v.text()),R.text(E),c()}),$('<button type="button" class="red-ui-button">'+RED._("common.label.save")+"</button>").appendTo(A).on("click",function(e){e.preventDefault();function t(e){o.remove(),e?G.reportUnexpectedError(e):(v.text(s.val()),R.text(x.val()),i.hide(),c())}var o=G.addSpinnerOverlay(p),e=(e=h.val()).substring(0,e.length-12),e={files:{package:h.val(),flow:e+s.val(),credentials:e+x.val()}};k.hasClass("selected")&&(e.resetCredentialSecret=!0),(k.hasClass("selected")||T.hasClass("selected"))&&(e.credentialSecret=I.val(),S.is(":visible")&&(e.currentCredentialSecret=O.val())),RED.deploy.setDeployInflight(!0),G.sendRequest({url:"projects/"+a.name,type:"PUT",responses:{0:function(e){t(e)},200:function(e){a=e,RED.sidebar.versionControl.refresh(!0),z(),t()},400:{credentials_load_failed:function(e){t(e)},missing_current_credential_key:function(e){O.addClass("input-error"),B=RED.popover.create({target:O,direction:"right",size:"small",content:"Incorrect key",autoClose:3e3}).open(),t(e)},"*":function(e){t(e)}}}},e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})})),z=function(){a.settings.credentialSecretInvalid?(n.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-warning"),n.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.invalidEncryptionKey"))):a.settings.credentialsEncrypted?(n.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-lock"),n.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionEnabled"))):(n.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-unlock"),n.find(".user-settings-credentials-state").text(RED._("sidebar.project.projectSettings.encryptionDisabled"))),k.toggleClass("disabled",!a.settings.credentialSecretInvalid&&!a.settings.credentialsEncrypted),k.prop("disabled",!a.settings.credentialSecretInvalid&&!a.settings.credentialsEncrypted)};d(),z()}function m(a,e){function u(){o.attr("disabled",!1),n.hide(),l.val(""),c.val(""),i&&(i.close(),i=null)}$("<h3></h3>").text(RED._("sidebar.project.projectSettings.versionControl")).appendTo(e),r=a,t=e,t=$('<div class="red-ui-settings-section"></div>').appendTo(t),$("<h4></h4>").text(RED._("sidebar.project.projectSettings.branches")).appendTo(t),t=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(t),s=$("<ol>").appendTo(t).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(n,e,a){var t=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(n);if(a.empty)return t.addClass("red-ui-search-empty"),void t.text(RED._("sidebar.project.projectSettings.noBranches"));a.current&&t.addClass("current"),$('<span class="entry-icon"><i class="fa fa-code-fork"></i></span>').appendTo(t);var o=$("<span>").appendTo(t),i=$("<div>").appendTo(o);$('<span class="entry-name">').text(a.name).appendTo(i),a.commit&&$('<span class="entry-detail">').text(a.commit.sha).appendTo(i),a.remote&&(i=$("<div>").appendTo(o),$('<span class="entry-detail entry-remote-name">').text(a.remote||"").appendTo(i),0<a.status.ahead+a.status.behind&&$('<span class="entry-detail"><i class="fa fa-long-arrow-up"></i> <span>'+a.status.ahead+'</span> <i class="fa fa-long-arrow-down"></i> <span>'+a.status.behind+"</span></span>").appendTo(i)),a.current||(o=$('<span class="entry-tools">').appendTo(t),$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(o).on("click",function(e){e.preventDefault();var o=G.addSpinnerOverlay(n).addClass("red-ui-component-spinner-contain"),i=RED.notify(RED._("sidebar.project.projectSettings.deleteConfirm",{name:a.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.remove(),i.close()}},{text:"Delete branch",click:function(){i.close();var t={url:"projects/"+r.name+"/branches/"+a.name,type:"DELETE",responses:{200:function(e){n.fadeOut(200,function(){s.editableList("removeItem",a),o.remove()})},400:{git_delete_branch_unmerged:function(e){i=RED.notify(RED._("sidebar.project.projectSettings.unmergedConfirm",{name:a.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.remove(),i.close()}},{text:RED._("sidebar.project.projectSettings.deleteUnmergedBranch"),click:function(){t.url+="?force=true",i.close(),G.sendRequest(t)}}]})},"*":function(e){G.reportUnexpectedError(e),o.remove()}}}};G.sendRequest(t)}}]})}))}}),$.getJSON("projects/"+r.name+"/branches",function(e){e.branches&&(0<e.branches.length?(e.branches.sort(function(e,t){return e.current?-1:t.current?1:e.name.localeCompare(t.name)}),e.branches.forEach(function(e){s.editableList("addItem",e)})):s.editableList("addItem",{empty:!0}))});var r,s,i,t=$('<div class="red-ui-settings-section"></div>').appendTo(e),e=$("<h4></h4>").text(RED._("sidebar.project.projectSettings.gitRemotes")).appendTo(t),o=$('<button class="red-ui-button red-ui-button-small" style="float: right; margin-right: 10px;">'+RED._("sidebar.project.projectSettings.addRemote")+"</button>").appendTo(e).on("click",function(e){o.attr("disabled",!0),n.slideDown(200,function(){n[0].scrollIntoView(),f?(l.val("origin"),c.trigger("focus")):l.trigger("focus"),h()})}),p={empty:!0},f=!0,e=$('<div class="red-ui-settings-row"></div>').appendTo(t),n=$('<div class="red-ui-projects-dialog-list-dialog"></div>').hide().appendTo(e),e=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(t),d=$("<ol>").appendTo(e),h=(d.editableList({addButton:!1,height:"auto",addItem:function(i,e,n){var t,o=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(i);n.empty?(o.addClass("red-ui-search-empty"),o.text(RED._("sidebar.project.projectSettings.noRemotes"))):($('<span class="entry-icon"><i class="fa fa-globe"></i></span>').appendTo(o),t=$("<span>").appendTo(o),$('<div class="entry-name">').text(n.name).appendTo(t),n.urls.fetch===n.urls.push?$('<div class="entry-detail">').text(n.urls.fetch).appendTo(t):($('<div class="entry-detail">').text("fetch: "+n.urls.fetch).appendTo(t),$('<div class="entry-detail">').text("push: "+n.urls.push).appendTo(t)),t=$('<span class="entry-tools">').appendTo(o),$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(t).on("click",function(e){e.preventDefault();var t=G.addSpinnerOverlay(i).addClass("red-ui-component-spinner-contain"),o=RED.notify(RED._("sidebar.project.projectSettings.deleteRemoteConfrim",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),o.close()}},{text:RED._("sidebar.project.projectSettings.deleteRemote"),click:function(){o.close(),a.git.branches.remote&&0===a.git.branches.remote.indexOf(n.name+"/")&&delete a.git.branches.remote,a.git.branches.remoteAlt&&0===a.git.branches.remoteAlt.indexOf(n.name+"/")&&delete a.git.branches.remoteAlt;var e="projects/"+a.name+"/remotes/"+n.name;G.sendRequest({url:e,type:"DELETE",responses:{200:function(e){i.fadeOut(200,function(){d.editableList("removeItem",n),setTimeout(t.remove,100),0===e.remotes.length?(delete a.git.remotes,f=!0,d.editableList("addItem",p)):(a.git.remotes={},e.remotes.forEach(function(e){var t=e.name;delete e.name,a.git.remotes[t]=e})),delete a.git.branches.remoteAlt,RED.sidebar.versionControl.refresh()})},400:{"*":function(e){G.reportUnexpectedError(e),t.remove()}}}})}}]})}))}}),function(){var e=/^[a-zA-Z0-9\-_]+$/.test(l.val()),t=c.val(),o=0<t.length&&!/\s/.test(t);/^https?:\/\/[^/]+@/i.test(t)?(b.text(RED._("sidebar.project.projectSettings.urlRule2")),o=!1):b.text(RED._("sidebar.project.projectSettings.urlRule")),v.attr("disabled",!e||!o),l.toggleClass("input-error",g&&!e),c.toggleClass("input-error",m&&!o),i&&(i.close(),i=null)}),g=!1,m=!1,l=($('<div class="red-ui-projects-dialog-list-dialog-header">').text(RED._("sidebar.project.projectSettings.addRemote2")).appendTo(n),e=$('<div class="red-ui-settings-row"></div>').appendTo(n),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.remoteName")).appendTo(e),$('<input type="text">').appendTo(e).on("change keyup paste",function(){g=!0,h()})),c=($('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.nameRule")+"</small></label>").appendTo(e).find("small"),e=$('<div class="red-ui-settings-row"></div>').appendTo(n),$('<label for=""></label>').text(RED._("sidebar.project.projectSettings.url")).appendTo(e),$('<input type="text">').appendTo(e).on("change keyup paste",function(){m=!0,h()})),b=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("sidebar.project.projectSettings.urlRule")+"</small></label>").appendTo(e).find("small"),t=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(n),v=($('<button class="red-ui-button">'+RED._("common.label.cancel")+"</button>").appendTo(t).on("click",function(e){e.preventDefault(),u()}),$('<button class="red-ui-button">'+RED._("sidebar.project.projectSettings.addRemote2")+"</button>").appendTo(t).on("click",function(e){e.preventDefault();function t(e){o.remove(),e||u()}var o=G.addSpinnerOverlay(n).addClass("red-ui-component-spinner-contain"),e={name:l.val(),url:c.val()};RED.deploy.setDeployInflight(!0),G.sendRequest({url:"projects/"+a.name+"/remotes",type:"POST",responses:{0:function(e){t(e)},200:function(e){a.git.remotes={},e.remotes.forEach(function(e){var t=e.name;delete e.name,a.git.remotes[t]=e}),y(),RED.sidebar.versionControl.refresh(),t()},400:{git_remote_already_exists:function(e){i=RED.popover.create({target:l,direction:"right",size:"small",content:"Remote already exists",autoClose:6e3}).open(),l.addClass("input-error"),t(e)},"*":function(e){G.reportUnexpectedError(e),t(e)}}}},e)})),y=function(){d.editableList("empty");var e=0;if(a.git.hasOwnProperty("remotes"))for(var t in a.git.remotes)a.git.remotes.hasOwnProperty(t)&&(e++,d.editableList("addItem",{name:t,urls:a.git.remotes[t]}));(f=0===e)&&d.editableList("addItem",p)};y()}function b(e){var t=$('<div id="red-ui-project-settings-tab-settings" class="red-ui-project-settings-tab-pane red-ui-help"></div>');return p(e,t),m(e,t),t}function v(e){/^subflow:/.test(e.type)||"node-red"!==(e=RED.nodes.registry.getNodeSetForType(e.type).module)&&(c.hasOwnProperty(e)||(c[e]={module:e,version:RED.nodes.registry.getModule(e).version,count:0,known:!1}),c[e].count++)}var c={};return{init:function(e){G=e,i({id:"main",title:RED._("sidebar.project.name"),get:n,close:function(){}}),i({id:"deps",title:RED._("sidebar.project.dependencies"),get:a,close:function(){}}),i({id:"settings",title:RED._("sidebar.project.settings"),get:b,close:function(){B&&(B.close(),B=null)}}),RED.events.on("nodes:add",v),RED.events.on("nodes:remove",function(e){/^subflow:/.test(e.type)||"node-red"!==(e=RED.nodes.registry.getNodeSetForType(e.type).module)&&c.hasOwnProperty(e)&&(c[e].count--,0===c[e].count&&(c[e].known||delete c[e]))})},show:function(a){var e;o||(RED.user.hasPermission("projects.write")?(o=!0,e={title:RED._("sidebar.project.projectSettings.title"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){t=e.width},open:function(e){var t=RED.projects.getActiveProject(),e=e.find(".red-ui-tray-body"),e=$("<div></div>").appendTo(e),o=$("<div></div>",{class:"red-ui-settings-tabs-container"}).appendTo(e),i=($("<ul></ul>",{id:"user-settings-tabs"}).appendTo(o),RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){n.children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}})),n=$("<div></div>",{class:"red-ui-settings-tabs-content"}).appendTo(e);r.forEach(function(e){i.addTab({id:"red-ui-project-settings-tab-"+e.id,label:e.title,pane:e}),e.get(t).hide().appendTo(n)}),e.i18n(),i.activateTab("red-ui-project-settings-tab-"+(a||"main")),$("#red-ui-sidebar-shade").show()},close:function(){o=!1,r.forEach(function(e){e.close&&e.close()}),$("#red-ui-sidebar-shade").hide()},show:function(){}},null!==t&&(e.width=t),RED.tray.show(e)):RED.notify(RED._("user.errors.notAuthorized"),"error"))},switchProject:function(e){c={}}}}(),RED.projects.userSettings=function(){var a,b,v;function r(e){$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.sshKeys")).appendTo(e);function c(){var e=/^[a-zA-Z0-9\-_]+$/.test(r.val()),t=(r.toggleClass("input-error",a&&!e),s.val()),o=0===t.length||8<=t.length;s.toggleClass("input-error",!o),o?0===t.length?d.text(RED._("editor:sidebar.project.userSettings.optional")):d.text(""):d.text(RED._("editor:sidebar.project.userSettings.passphraseShort")),h.attr("disabled",!(e=e&&o)),i&&(i.close(),i=null)}function u(){f.attr("disabled",!1),n.hide(),r.val(""),a=!1,s.val(""),i&&(i.close(),i=null)}function p(e,t){var e=$('<div class="red-ui-projects-dialog-ssh-public-key">',{style:"position:relative"}).appendTo(e),o=$("<pre>",{style:"min-height: 80px"}).appendTo(e),i=v.addSpinnerOverlay(o).addClass("red-ui-component-spinner-contain"),t={url:"settings/user/keys/"+t.name,type:"GET",responses:{200:function(e){o.text(e.publickey),i.remove()},400:{unexpected_error:function(e){console.log(e),i.remove()}}}},t=(v.sendRequest(t),$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(e));return $('<button class="red-ui-button red-ui-button-small">'+RED._("editor:sidebar.project.userSettings.copyPublicKey")+"</button>").appendTo(t).on("click",function(e){try{e.stopPropagation(),e.preventDefault(),document.getSelection().selectAllChildren(o[0]);document.execCommand("copy");document.getSelection().empty()}catch(e){}}),e}var i,e=$('<div class="red-ui-settings-section"></div>').appendTo(e),t=$('<div class="red-ui-settings-section-description"></div>').appendTo(e).text(RED._("editor:sidebar.project.userSettings.sshKeysTip")),f=$('<button id="user-settings-gitconfig-add-key" class="red-ui-button red-ui-button-small" style="float: right; margin-right: 10px;">'+RED._("editor:sidebar.project.userSettings.add")+"</button>").appendTo(t).on("click",function(e){f.attr("disabled",!0),h.attr("disabled",!0),n.slideDown(200),r.trigger("focus")}),t=$('<div class="red-ui-settings-row"></div>').appendTo(e),n=$('<div class="red-ui-projects-dialog-list-dialog"></div>').hide().appendTo(t),o=($('<div class="red-ui-projects-dialog-list-dialog-header">').text(RED._("editor:sidebar.project.userSettings.addSshKey")).appendTo(n),$("<div>").appendTo(n)),t=$('<div class="red-ui-settings-row"></div>').appendTo(o),a=($('<div class="red-ui-settings-section-description"></div>').appendTo(t).text(RED._("editor:sidebar.project.userSettings.addSshKeyTip")),t=$('<div class="red-ui-settings-row"></div>').appendTo(o),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.name")).appendTo(t),!1),r=$('<input type="text">').appendTo(t).on("change keyup paste",function(){a=!0,c()}),o=($('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.nameRule")+"</small></label>").appendTo(t).find("small"),$("<div>").appendTo(o)),s=(t=$('<div class="red-ui-settings-row"></div>').appendTo(o),$('<label for=""></label>').text(RED._("editor:sidebar.project.userSettings.passphrase")).appendTo(t),$('<input type="password">').appendTo(t).on("change keyup paste",c)),d=$('<label class="red-ui-projects-edit-form-sublabel"><small>'+RED._("editor:sidebar.project.userSettings.optional")+"</small></label>").appendTo(t).find("small"),o=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(n),h=($('<button class="red-ui-button">'+RED._("editor:sidebar.project.userSettings.cancel")+"</button>").appendTo(o).on("click",function(e){e.preventDefault(),u()}),$('<button class="red-ui-button">'+RED._("editor:sidebar.project.userSettings.generate")+"</button>").appendTo(o).on("click",function(e){e.preventDefault();function t(e){o.remove(),e||u()}var o=v.addSpinnerOverlay(n).addClass("red-ui-component-spinner-contain"),i={name:r.val(),type:"generate"};i.comment=b.val(),i.password=s.val(),i.size=4096;RED.deploy.setDeployInflight(!0),v.sendRequest({url:"settings/user/keys",type:"POST",responses:{0:function(e){t(e)},200:function(e){m(i.name),t()},400:{unexpected_error:function(e){console.log(e),t(e)}}}},i)})),g=(t=$('<div class="red-ui-settings-row red-ui-projects-dialog-list"></div>').appendTo(e),{empty:!0}),l=$('<ol class="red-ui-projects-dialog-ssh-key-list">').appendTo(t).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(i,e,n){var t=$('<div class="red-ui-projects-dialog-list-entry">').appendTo(i);if(n.empty)return t.addClass("red-ui-search-empty"),void t.text(RED._("editor:sidebar.project.userSettings.noSshKeys"));var o,a=$('<div class="red-ui-projects-dialog-ssh-key-header">').appendTo(t),r=($('<span class="entry-icon"><i class="fa fa-key"></i></span>').appendTo(a),$('<span class="entry-name">').text(n.name).appendTo(a),$('<span class="button-row entry-tools">').appendTo(a));a.on("click",function(e){o?o.slideUp(200,function(){o.remove(),o=null}):o=p(t,n)}),n.system||$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-trash"></i></button>').appendTo(r).on("click",function(e){e.stopPropagation();var t=v.addSpinnerOverlay(i).addClass("red-ui-component-spinner-contain"),o=RED.notify(RED._("editor:sidebar.project.userSettings.deleteConfirm",{name:n.name}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),o.close()}},{text:RED._("editor:sidebar.project.userSettings.delete"),click:function(){o.close();var e="settings/user/keys/"+n.name;v.sendRequest({url:e,type:"DELETE",responses:{200:function(e){i.fadeOut(200,function(){l.editableList("removeItem",n),setTimeout(t.remove,100),0===l.editableList("length")&&l.editableList("addItem",g)})},400:{unexpected_error:function(e){console.log(e),t.remove()}}}})}}]})}),n.expand&&(o=p(t,n))}}),m=function(t){$.getJSON("settings/user/keys",function(e){e.keys&&(e.keys.sort(function(e,t){return e.name.localeCompare(t.name)}),l.editableList("empty"),e.keys.forEach(function(e){e.name===t&&(e.expand=!0),l.editableList("addItem",e)}),0===l.editableList("length")&&l.editableList("addItem",g))})};m()}function t(e){var t,o,i,n=$('<div id="red-ui-settings-tab-gitconfig" class="project-settings-tab-pane red-ui-help"></div>');return t=n,(i=RED.settings.get("git")||{}).user=i.user||{},$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.committerDetail")).appendTo(t),t=$('<div class="red-ui-settings-section"></div>').appendTo(t),$('<div class="red-ui-settings-section-description"></div>').appendTo(t).text(RED._("editor:sidebar.project.userSettings.committerTip")),o=$('<div class="red-ui-settings-row"></div>').appendTo(t),$('<label for="user-settings-gitconfig-username"></label>').text(RED._("editor:sidebar.project.userSettings.userName")).appendTo(o),(a=$('<input type="text" id="user-settings-gitconfig-username">').appendTo(o)).val(i.user.name||""),o=$('<div class="red-ui-settings-row"></div>').appendTo(t),$('<label for="user-settings-gitconfig-email"></label>').text(RED._("editor:sidebar.project.userSettings.email")).appendTo(o),(b=$('<input type="text" id="user-settings-gitconfig-email">').appendTo(o)).val(i.user.email||""),t=n,o=RED.settings.theme("projects.workflow.mode","manual"),(i=RED.settings.get("git")||{}).workflow=i.workflow||{},i.workflow.mode=i.workflow.mode||o,$("<h3></h3>").text(RED._("editor:sidebar.project.userSettings.workflow")).appendTo(t),o=$('<div class="red-ui-settings-section"></div>').appendTo(t),$('<div class="red-ui-settings-section-description"></div>').appendTo(o).text(RED._("editor:sidebar.project.userSettings.workfowTip")),t=$('<div class="red-ui-settings-row"></div>').appendTo(o),$('<label><input type="radio" name="user-setting-gitworkflow" value="manual"> <div style="margin-left: 3px; display: inline-block"><div data-i18n="editor:sidebar.project.userSettings.workflowManual"></div><div style="color:#aaa;" data-i18n="editor:sidebar.project.userSettings.workflowManualTip"></div></div></label>').appendTo(t),t=$('<div class="red-ui-settings-row"></div>').appendTo(o),$('<label><input type="radio" name="user-setting-gitworkflow" value="auto"> <div style="margin-left: 3px; display: inline-block"><div data-i18n="editor:sidebar.project.userSettings.workflowAuto"></div><div style="color:#aaa;" data-i18n="editor:sidebar.project.userSettings.workflowAutoTip"></div></div></label>').appendTo(t),o.find('[name="user-setting-gitworkflow"][type="radio"][value="'+i.workflow.mode+'"]').prop("checked",!0),r(n),n}return{init:function(e){v=e,RED.userSettings.add({id:"gitconfig",title:RED._("editor:sidebar.project.userSettings.gitConfig"),get:t,close:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=a.val(),e.user.email=b.val(),e.workflow=e.workflow||{},e.workflow.mode=$('[name="user-setting-gitworkflow"][type="radio"]:checked').val(),RED.settings.set("git",e)}})}}}(),RED.sidebar.versionControl=function(){var D,O,R,N,x,I,a,_,k,P,T,C,A,r,j,M,z,L={};function B(t,a,c,r){t.addClass("red-ui-sidebar-vc-change-entry");var i=$("<div>").appendTo(t);if(a.label)return t.addClass("red-ui-help-info-none"),i.text(a.label),void(a.button&&(i.css({display:"inline-block",maxWidth:"300px",textAlign:"left"}),o=$('<div style="float: right; margin: 5px; height: 50px;"></div>').appendTo(i),$('<button class="red-ui-button red-ui-button-small"></button>').text(a.button.label).appendTo(o).on("click",a.button.click)));var e,n,s=$('<i class=""></i>').appendTo(i),d=$('<a href="#">').appendTo(i).on("click",function(e){var o,i,n;e.preventDefault(),o=a,i=r,n=RED.projects.getActiveProject(),j.sendRequest({url:"projects/"+n.name+"/diff/"+("staged"===i?"index":"tree")+"/"+encodeURIComponent(o.file),type:"GET",responses:{0:function(e){console.log(e)},200:function(e){var t="unstaged"===i?RED._("sidebar.project.versionControl.unstagedChanges")+" : "+o.file:"staged"===i?RED._("sidebar.project.versionControl.stagedChanges")+" : "+o.file:RED._("sidebar.project.versionControl.resolveConflicts")+" : "+o.file,e={diff:e.diff,title:t,unmerged:"unmerged"===i,project:n};"unstaged"==i?(e.oldRevTitle=" "===o.indexStatus?RED._("sidebar.project.versionControl.head"):RED._("sidebar.project.versionControl.staged"),e.newRevTitle=RED._("sidebar.project.versionControl.unstaged"),e.oldRev=" "===o.indexStatus?"@":":0",e.newRev="_"):"staged"===i?(e.oldRevTitle=RED._("sidebar.project.versionControl.head"),e.newRevTitle=RED._("sidebar.project.versionControl.staged"),e.oldRev="@",e.newRev=":0"):(e.oldRevTitle=RED._("sidebar.project.versionControl.local"),e.newRevTitle=RED._("sidebar.project.versionControl.remote"),e.commonRev=":1",e.oldRev=":2",e.newRev=":3",e.onresolve=function(e){j.sendRequest({url:"projects/"+n.name+"/resolve/"+encodeURIComponent(o.file),type:"POST",responses:{0:function(e){console.log(e)},200:function(e){S(!0)},400:{unexpected_error:function(e){console.log(e)}}}},{resolutions:e.resolutions[o.file]})}),RED.diff.showUnifiedDiff(e)},400:{unexpected_error:function(e){console.log(e)}}}})}),l=$("<span>").appendTo(d),o=$('<div class="red-ui-sidebar-vc-change-entry-tools">').appendTo(t);"unstaged"===r&&(e=$('<span class="button-group" style="margin-right: 5px;"></span>').appendTo(o),n=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-reply"></i></button>').appendTo(e).on("click",function(e){e.preventDefault();var t=j.addSpinnerOverlay(i).addClass("red-ui-component-spinner-contain"),o=RED.notify(RED._("sidebar.project.versionControl.revert",{file:a.file}),{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.remove(),o.close()}},{text:RED._("sidebar.project.versionControl.revertChanges"),click:function(){o.close();var e={url:"projects/"+RED.projects.getActiveProject().name+"/files/_/"+a.file,type:"DELETE",responses:{200:function(e){t.remove()},400:{unexpected_error:function(e){t.remove(),console.log(e)}}}};RED.deploy.setDeployInflight(!0),j.sendRequest(e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]})}),RED.popover.tooltip(n,RED._("sidebar.project.versionControl.revertChanges"))),e=$('<span class="button-group"></span>').appendTo(o),"unmerged"!==r&&(o=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-'+("unstaged"===r?"plus":"minus")+'"></i></button>').appendTo(e).on("click",function(e){e.preventDefault();e=RED.projects.getActiveProject();a.spinner=j.addSpinnerOverlay(t).addClass("projects-version-control-spinner-sidebar"),j.sendRequest({url:"projects/"+e.name+"/stage/"+encodeURIComponent(a.file),type:"unstaged"===r?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){J(e)},400:{unexpected_error:function(e){console.log(e)}}}},{})}),RED.popover.tooltip(o,RED._("sidebar.project.versionControl."+("unstaged"===r?"stage":"unstage")+"Change"))),a["update"+("unstaged"===r?"Unstaged":"Staged")]=function(e,t){i.removeClass();var o="",o="A"===t?(i.addClass("red-ui-diff-state-added"),"fa-plus-square"):"?"===t?(i.addClass("red-ui-diff-state-unchanged"),"fa-question-circle-o"):"D"===t?(i.addClass("red-ui-diff-state-deleted"),"fa-minus-square"):"M"===t?(i.addClass("red-ui-diff-state-changed"),"fa-square"):"R"===t?(i.addClass("red-ui-diff-state-changed"),"fa-toggle-right"):("U"===t&&i.addClass("red-ui-diff-state-conflicted"),"fa-exclamation-triangle");l.empty(),$("<span>").text(e.file.replace(/\\(.)/g,"$1")).appendTo(l),e.oldName&&($('<i class="fa fa-long-arrow-right"></i>').prependTo(l),$("<span>").text(e.oldName.replace(/\\(.)/g,"$1")).prependTo(l)),s.removeClass(),s.addClass("fa "+o),e.spinner&&(e.spinner.remove(),delete e.spinner),n&&n.toggle("?"!==t),d.toggleClass("disabled","D"===t||"?"===t)},a["update"+("unstaged"===r?"Unstaged":"Staged")](a,c)}function G(e){var t=Date.now()/1e3-e,o=Math.floor(t/86400);if(30<o)return new Date(1e3*e).toLocaleDateString();if(0<o)return RED._("sidebar.project.versionControl.daysAgo",{count:o});e=Math.floor(t/3600);if(0<e)return RED._("sidebar.project.versionControl.hoursAgo",{count:e});o=Math.floor(t/60);return 0<o?RED._("sidebar.project.versionControl.minsAgo",{count:o}):RED._("sidebar.project.versionControl.secondsAgo")}function F(e,t){var o=RED.projects.getActiveProject(),e=((a=t?j.addSpinnerOverlay(R.parent()):j.addSpinnerOverlay(x.parent())).addClass("red-ui-component-spinner-sidebar"),t?{files:e}:void 0);j.sendRequest({url:"projects/"+o.name+"/stage",type:t?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){J(e)},400:{unexpected_error:function(e){console.log(e)}}}},e)}var n=!1;function U(i,n,e,a,t){var r=j.addSpinnerOverlay(e),e=i+"?limit="+(a||20);t&&(e+="&before="+t),j.sendRequest({url:e,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){e.commits.forEach(function(e){n.editableList("addItem",e),t=e.sha}),n.loadMoreItem&&(n.editableList("removeItem",n.loadMoreItem),delete n.loadMoreItem);var t,o=n.editableList("length");o<e.total&&(n.loadMoreItem={totalKnown:o,total:e.total,url:i,before:t+"~1",limit:a},n.editableList("addItem",n.loadMoreItem)),r.remove()},400:{unexpected_error:function(e){console.log(e)}}}})}function J(e){var i=e.files,e=(a&&(a.remove(),a=null),(r=!!e.merging)?(D.addClass("red-ui-sidebar-vc-merging"),_.show()):(D.removeClass("red-ui-sidebar-vc-merging"),_.hide()),R.editableList("removeItem",M),x.editableList("removeItem",M),k.editableList("removeItem",z),Object.keys(i).filter(function(e){return"f"===i[e].type})),n=(e.sort(),Date.now()+Math.floor(100*Math.random())),e=(e.forEach(function(e){var t=i[e],o=!1;t.status&&(t.file=e,t.indexStatus=t.status[0],t.treeStatus=t.status[1],("A"===t.indexStatus&&/[AU]/.test(t.treeStatus)||"U"===t.indexStatus&&/[DAU]/.test(t.treeStatus)||"D"===t.indexStatus&&/[DU]/.test(t.treeStatus))&&(t.unmerged=!0),L[e]?(L[e].unmerged&&!t.unmerged?(k.editableList("removeItem",L[e]),o=!0):!L[e].unmerged&&t.unmerged&&(R.editableList("removeItem",L[e]),x.editableList("removeItem",L[e])),L[e].status!==t.status&&(" "!==L[e].treeStatus?" "===t.treeStatus?R.editableList("removeItem",L[e]):t.treeStatus!==L[e].treeStatus&&L[e].updateUnstaged(t,t.treeStatus):o=!0," "!==L[e].indexStatus&&"?"!==L[e].indexStatus?" "===t.indexStatus||"?"===t.indexStatus?x.editableList("removeItem",L[e]):t.indexStatus!==L[e].indexStatus&&L[e].updateStaged(t,t.indexStatus):o=!0),L[e].status=t.status,L[e].indexStatus=t.indexStatus,L[e].treeStatus=t.treeStatus,L[e].oldName=t.oldName,L[e].unmerged=t.unmerged):(o=!0,L[e]=t),L[e].updateIndex=n,o&&(t.unmerged?k.editableList("addItem",L[e]):(" "!==t.treeStatus&&R.editableList("addItem",L[e])," "!==t.indexStatus&&"?"!==t.indexStatus&&x.editableList("addItem",L[e]))))}),Object.keys(L).forEach(function(e){L[e].updateIndex!==n&&(R.editableList("removeItem",L[e]),x.editableList("removeItem",L[e]),delete L[e])}),x.editableList("length")),t=R.editableList("length"),o=k.editableList("length");P.prop("disabled",r&&0<o||!r&&0===e),N.prop("disabled",0===t),I.prop("disabled",0===e),0===e&&x.editableList("addItem",M),0===t&&R.editableList("addItem",M),0===o&&k.editableList("addItem",z)}function S(e,t){var i;n||(e&&(L={},R.editableList("empty"),x.editableList("empty"),k.editableList("empty")),RED.user.hasPermission("projects.write")&&(n=!0,C.editableList("empty"),(e=RED.projects.getActiveProject())&&U("projects/"+e.name+"/commits",C,C.parent()),(i=RED.projects.getActiveProject())?(e="projects/"+i.name+"/status",t&&(e+="?remote=true"),$.getJSON(e,function(e){J(e),$("#red-ui-sidebar-vc-local-branch").text(e.branches.local),$("#red-ui-sidebar-vc-remote-branch").text(e.branches.remote||RED._("sidebar.project.versionControl.none"));var t=e.commits.ahead||0,o=e.commits.behind||0;i.git.hasOwnProperty("remotes")?e.branches.hasOwnProperty("remoteError")&&"git_remote_gone"!==e.branches.remoteError.code?($("#red-ui-sidebar-vc-repo-status-auth-issue").show(),$("#red-ui-sidebar-vc-repo-status-stats").hide(),$("#red-ui-sidebar-vc-repo-branch").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-toolbar-message").hide(),$("#red-ui-sidebar-vc-repo-toolbar-error-message").show()):($("#red-ui-sidebar-vc-repo-toolbar-message").show(),$("#red-ui-sidebar-vc-repo-toolbar-error-message").hide(),$("#red-ui-sidebar-vc-repo-status-auth-issue").hide(),$("#red-ui-sidebar-vc-repo-status-stats").show(),$("#red-ui-sidebar-vc-repo-branch").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-status-button").show(),e.branches.hasOwnProperty("remote")?V(t,o):($("#red-ui-sidebar-vc-commits-ahead").text(""),$("#red-ui-sidebar-vc-commits-behind").text(""),$("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.notTracking")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0))):$("#red-ui-sidebar-vc-repo-status-button").hide(),n=!1,$(".red-ui-sidebar-vc-shade").hide()}).fail(function(){n=!1})):($(".red-ui-sidebar-vc-shade").show(),R.editableList("empty"),x.editableList("empty"),k.editableList("empty"))))}function V(e,t){$("#red-ui-sidebar-vc-commits-ahead").text(e),$("#red-ui-sidebar-vc-commits-behind").text(t),r?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.statusUnmergedChanged")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):0<e&&0===t?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAhead",{count:e})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!1)):0===e&&0<t?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsBehind",{count:t})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):0<e&&0<t?($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.commitsAheadAndBehind1",{count:t})+RED._("sidebar.project.versionControl.commitsAheadAndBehind2",{count:e})+RED._("sidebar.project.versionControl.commitsAheadAndBehind3",{count:t})),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!1),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0)):0===e&&0===t&&($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.repositoryUpToDate")),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!0))}function q(){S(),RED.sidebar.show("version-control")}return{init:function(e){function c(o){o=o||{};var e=j.addSpinnerOverlay(s).addClass("red-ui-component-spinner-contain"),t=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(e),i=($('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(t).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.projects.getActiveProject()),t=(RED.eventLog.startEvent("Pull changes"+(i.git.branches.remoteAlt?" : "+i.git.branches.remoteAlt:"")),"projects/"+i.name+"/pull");i.git.branches.remoteAlt&&(t+="/"+i.git.branches.remoteAlt),(o.setUpstream||o.allowUnrelatedHistories)&&(t+="?"),o.setUpstream&&(t+="setUpstream=true",o.allowUnrelatedHistories&&(t+="&")),o.allowUnrelatedHistories&&(t+="allowUnrelatedHistories=true"),j.sendRequest({url:t,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){o.setUpstream&&i.git.branches.remoteAlt&&(i.git.branches.remote=i.git.branches.remoteAlt,delete i.git.branches.remoteAlt),S(!0),d()},400:{git_local_overwrite:function(e){RED.notify(RED._("sidebar.project.versionControl.unablePull")+'<p><a href="#" onclick="RED.sidebar.versionControl.showLocalChanges(); return false;">'+RED._("sidebar.project.versionControl.showUnstagedChanges")+"</a></p>","error",!1,1e7)},git_pull_merge_conflict:function(e){S(!0),d()},git_connection_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.connectionFailed")+e.toString(),"warning")},git_pull_unrelated_history:function(e){var t=RED.notify(RED._("sidebar.project.versionControl.pullUnrelatedHistory"),{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.close()}},{text:RED._("sidebar.project.versionControl.pullChanges"),click:function(){t.close(),o.allowUnrelatedHistories=!0,c(o)}}]})},"*":function(e){j.reportUnexpectedError(e)}}}},{}).always(function(){e.remove()})}j=e,RED.actions.add("core:show-version-control-tab",q),RED.events.on("deploy",function(){var e,t=RED.projects.getActiveProject();t&&(e=RED.settings.theme("projects.workflow.mode","manual"),"auto"===(((RED.settings.get("git")||{}).workflow||{}).mode||e)?S(!0):(L={},R.editableList("empty"),x.editableList("empty"),k.editableList("empty"),$.getJSON("projects/"+t.name+"/status",function(e){J(e)})))}),RED.events.on("login",function(){S(!0)}),D=$("<div>",{class:"red-ui-sidebar-vc"});var e=$("<div>",{class:"red-ui-sidebar-vc-stack"}).appendTo(D),e=(O=RED.stack.create({container:e,fill:!0,singleExpanded:!0}),(T=O.add({title:RED._("sidebar.project.versionControl.localChanges"),collapsible:!0})).expand(),T.content.css({height:"100%"}),$('<div style="float: right"></div>').appendTo(T.header)),t=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(e).on("click",function(e){e.preventDefault(),e.stopPropagation(),S(!0)}),o=(RED.popover.tooltip(t,RED._("sidebar.project.versionControl.refreshChanges")),M={label:RED._("sidebar.project.versionControl.none")},z={label:RED._("sidebar.project.versionControl.conflictResolve")},$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(T.content)),i=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.localFiles")+"</div>").appendTo(o),u=(N=$('<button class="red-ui-button red-ui-button-small" style="position: absolute; right: 5px; top: 5px;"><i class="fa fa-plus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(i).on("click",function(e){e.preventDefault(),e.stopPropagation(),F(Object.keys(L).filter(function(e){return" "!==L[e].treeStatus}),!0)}),RED.popover.tooltip(N,RED._("sidebar.project.versionControl.stageAllChange")),(R=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(o)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){B(e,o,o.treeStatus,"unstaged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),_=$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(T.content),i=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.unmergedChanges")+"</div>").appendTo(_),e=$('<div style="position: absolute; right: 5px; top: 5px;"></div>').appendTo(i),$('<button class="red-ui-button red-ui-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.abortMerge")+"</button>").appendTo(e).on("click",function(e){e.preventDefault(),e.stopPropagation();var t=j.addSpinnerOverlay(_),e=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),j.sendRequest({url:"projects/"+e.name+"/merge",type:"DELETE",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),S(!0)},400:{unexpected_error:function(e){console.log(e)}}}}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})})),n=((k=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(_)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){o===z&&(o.button={label:RED._("sidebar.project.versionControl.commit"),click:function(e){e.preventDefault(),e.stopPropagation(),p()}}),B(e,o,o.treeStatus,"unmerged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),$('<div class="red-ui-sidebar-vc-change-container"></div>').appendTo(T.content)),i=$('<div class="red-ui-sidebar-vc-change-header">'+RED._("sidebar.project.versionControl.changeToCommit")+"</div>").appendTo(n),e=$('<div style="position: absolute; right: 5px; top: 5px;"></div>').appendTo(i),p=function(){a.val(""),h.prop("disabled",!0),o.css("height","30px"),_.is(":visible")?(_.css("height","30px"),n.css("height","calc(100% - 60px - 175px)")):n.css("height","calc(100% - 30px - 175px)"),commitBox.show(),setTimeout(function(){commitBox.css("height","175px")},10),N.prop("disabled",!0),I.prop("disabled",!0),P.prop("disabled",!0),u.prop("disabled",!0),a.trigger("focus")},a=(P=$('<button class="red-ui-button red-ui-button-small" style="margin-right: 5px;">'+RED._("sidebar.project.versionControl.commit")+"</button>").appendTo(e).on("click",function(e){e.preventDefault(),e.stopPropagation(),p()}),RED.popover.tooltip(P,RED._("sidebar.project.versionControl.commitChanges")),I=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-minus"></i> '+RED._("sidebar.project.versionControl.all")+"</button>").appendTo(e).on("click",function(e){e.preventDefault(),e.stopPropagation(),F(Object.keys(L).filter(function(e){return" "!==L[e].indexStatus&&"?"!==L[e].indexStatus}),!1)}),RED.popover.tooltip(I,RED._("sidebar.project.versionControl.unstageAllChange")),(x=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(n)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){B(e,o,o.indexStatus,"staged")},sort:function(e,t){return e.file.localeCompare(t.file)}}),commitBox=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-bottom"></div>').hide().appendTo(T.content),$("<textarea></textarea>").attr("placeholder",RED._("sidebar.project.versionControl.commitPlaceholder")).appendTo(commitBox).on("change keyup paste",function(){h.prop("disabled",""===$(this).val().trim())})),i=$('<div class="red-ui-sidebar-vc-slide-box-toolbar button-group">').appendTo(commitBox),f=$('<button class="red-ui-button">'+RED._("sidebar.project.versionControl.cancelCapital")+"</button>").appendTo(i).on("click",function(e){e.preventDefault(),a.val(""),o.css("height",""),_.css("height",""),n.css("height",""),commitBox.css("height",0),setTimeout(function(){commitBox.hide()},200),N.prop("disabled",!1),I.prop("disabled",!1),P.prop("disabled",!1),u.prop("disabled",!1)}),h=$('<button class="red-ui-button">'+RED._("sidebar.project.versionControl.commitCapital")+"</button>").appendTo(i).on("click",function(e){e.preventDefault();var t=j.addSpinnerOverlay(h).addClass("red-ui-component-spinner-sidebar"),e=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),j.sendRequest({url:"projects/"+e.name+"/commit",type:"POST",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),f.trigger("click"),S(!0)},400:{"*":function(e){j.reportUnexpectedError(e)}}}},{message:a.val()}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),i=O.add({title:RED._("sidebar.project.versionControl.commitHistory"),collapsible:!0}),e=(e=$('<div style="float: right"></div>').appendTo(i.header),t=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-refresh"></i></button>').appendTo(e).on("click",function(e){e.preventDefault(),e.stopPropagation(),S(!0,!0)}),RED.popover.tooltip(t,RED._("sidebar.project.versionControl.refreshCommitHistory")),$('<div class="red-ui-sidebar-vc-change-header" style="text-align: right;"></div>').appendTo(i.content)),g=$('<button class="red-ui-button red-ui-button-small"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.branch")+' <span id="red-ui-sidebar-vc-local-branch"></span></button>').appendTo(e).on("click",function(e){e.preventDefault(),$(this).hasClass("selected")?b():(d(),A.show(),$(this).addClass("selected"),e=RED.projects.getActiveProject(),v.refresh("projects/"+e.name+"/branches"),r.show(),setTimeout(function(){r.css("height","215px"),v.focus()},100))}),m=(RED.popover.tooltip(g,RED._("sidebar.project.versionControl.changeLocalBranch")),$('<button class="red-ui-button red-ui-button-small" style="margin-left: 10px;" id="red-ui-sidebar-vc-repo-status-button"><span id="red-ui-sidebar-vc-repo-status-stats"><i class="fa fa-long-arrow-up"></i> <span id="red-ui-sidebar-vc-commits-ahead"></span> <i class="fa fa-long-arrow-down"></i> <span id="red-ui-sidebar-vc-commits-behind"></span></span><span id="red-ui-sidebar-vc-repo-status-auth-issue"><i class="fa fa-warning"></i></span></button>').appendTo(e).on("click",function(e){e.preventDefault(),$(this).hasClass("selected")?d():(b(),A.show(),$(this).addClass("selected"),e=RED.projects.getActiveProject(),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream-row").toggle(!!e.git.branches.remoteAlt),s.show(),setTimeout(function(){s.css("height","265px")},100))})),b=(RED.popover.tooltip(m,RED._("sidebar.project.versionControl.manageRemoteBranch")),C=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0px; right:0; left:0;"}).appendTo(i.content),A=$('<div class="red-ui-shade" style="z-Index: 3"></div>').css("top","30px").hide().appendTo(i.content),C.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,e,o){var i,n;t.addClass("red-ui-sidebar-vc-commit-entry"),o.url?(t.addClass("red-ui-sidebar-vc-commit-more"),t.text("+ "+(o.total-o.totalKnown)+RED._("sidebar.project.versionControl.moreCommits")),t.on("click",function(e){e.preventDefault(),U(o.url,C,t,o.limit,o.before)})):(t.on("click",function(e){var t=RED.projects.getActiveProject();t&&$.getJSON("projects/"+t.name+"/commits/"+o.sha,function(e){e.project=t,e.parents=o.parents,e.oldRev=o.sha+"~1",e.newRev=o.sha,e.oldRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+o.sha.substring(0,7)+"~1",e.newRevTitle=RED._("sidebar.project.versionControl.commitCapital")+" "+o.sha.substring(0,7),e.date=G(parseInt(o.date)),RED.diff.showCommitDiff(e)})}),i=$("<div>").appendTo(t),$('<div class="red-ui-sidebar-vc-commit-subject">').text(o.subject).appendTo(i),o.refs&&(n=$('<div class="red-ui-sidebar-vc-commit-refs">').appendTo(i),o.refs.forEach(function(e){var t=e;/HEAD -> /.test(e)&&(t=e.substring(8)),$('<span class="red-ui-sidebar-vc-commit-ref">').text(t).appendTo(n)}),t.addClass("red-ui-sidebar-vc-commit-head")),$('<div class="red-ui-sidebar-vc-commit-sha">').text(o.sha.substring(0,7)).appendTo(i),$('<div class="red-ui-sidebar-vc-commit-date">').text(G(parseInt(o.date))).appendTo(i))}}),function(e){g.removeClass("selected"),r.css("height","0"),A.hide(),setTimeout(function(){r.hide(),e&&e()},200)}),r=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-top" style="top:30px;"></div>').hide().appendTo(i.content),v=($('<div class="red-ui-sidebar-vc-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.changeLocalBranch")).appendTo(r),j.createBranchList({placeholder:RED._("sidebar.project.versionControl.createBranchPlaceholder"),container:r,onselect:function(e){if(e.current)return b();var t=j.addSpinnerOverlay(r),o=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),j.sendRequest({url:"projects/"+o.name+"/branches",type:"POST",requireCleanWorkspace:!0,cancel:function(){t.remove()},responses:{0:function(e){t.remove(),console.log(e)},200:function(e){b(function(){t.remove()})},400:{git_local_overwrite:function(e){t.remove(),RED.notify(RED._("sidebar.project.versionControl.localOverwrite"),{type:"error",timeout:8e3})},unexpected_error:function(e){t.remove(),console.log(e)}}}},e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}})),s=$('<div class="red-ui-sidebar-vc-slide-box red-ui-sidebar-vc-slide-box-top" style="top:30px"></div>').hide().appendTo(i.content),d=function(){$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!1),m.removeClass("selected"),s.css("height","0"),A.hide(),setTimeout(function(){s.hide(),y()},200)},y=function(e){w.hasClass("selected")&&(w.removeClass("selected"),l.height(0),s.css("height","265px"),setTimeout(function(){l.hide(),e&&e()},200))},t=($('<div class="red-ui-sidebar-vc-slide-box-header"></div>').text(RED._("sidebar.project.versionControl.manageRemoteBranch")).appendTo(s),$('<div style="margin-bottom: 5px;"></div>').appendTo(s)),w=$('<button id="red-ui-sidebar-vc-repo-branch" class="red-ui-sidebar-vc-repo-action red-ui-button"><i class="fa fa-code-fork"></i> '+RED._("sidebar.project.versionControl.remote")+': <span id="red-ui-sidebar-vc-remote-branch"></span></button>').appendTo(t).on("click",function(e){e.preventDefault(),$(this).hasClass("selected")?y():($(this).addClass("selected"),e=RED.projects.getActiveProject(),E.refresh("projects/"+e.name+"/branches/remote"),l.show(),setTimeout(function(){l.height(180),s.css("height","445px"),E.focus()},100))}),e=($('<div id="red-ui-sidebar-vc-repo-toolbar-message" class="red-ui-sidebar-vc-slide-box-header" style="min-height: 100px;"></div>').appendTo(s),$('<div id="red-ui-sidebar-vc-repo-toolbar-error-message" class="red-ui-sidebar-vc-slide-box-header" style="min-height: 100px;"></div>').hide().appendTo(s)),i=($('<div style="margin-top: 10px;"><i class="fa fa-warning"></i> '+RED._("sidebar.project.versionControl.unableToAccess")+"</div>").appendTo(e),$('<div style="margin: 10px 30px; text-align: center"></div>').appendTo(e)),l=($('<button class="red-ui-button" style="width: 80%;"><i class="fa fa-refresh"></i> '+RED._("sidebar.project.versionControl.retry")+"</button>").appendTo(i).on("click",function(e){e.preventDefault();var e=RED.projects.getActiveProject(),t=j.addSpinnerOverlay(s).addClass("red-ui-component-spinner-contain");j.sendRequest({url:"projects/"+e.name+"/branches/remote",type:"GET",responses:{0:function(e){console.log(e)},200:function(e){S(!0)},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){console.log(e)}}}}).always(function(){t.remove()})}),$('<div class="red-ui-sidebar-vc-slide-box-header" style="height: 20px;"><label id="red-ui-sidebar-vc-repo-toolbar-set-upstream-row" for="red-ui-sidebar-vc-repo-toolbar-set-upstream" class="hide"><input type="checkbox" id="red-ui-sidebar-vc-repo-toolbar-set-upstream"> '+RED._("sidebar.project.versionControl.setUpstreamBranch")+"</label></div>").appendTo(s),$('<div style="height: 0;overflow:hidden; transition: height 0.2s ease-in-out;"></div>').hide().appendTo(t)),E=j.createBranchList({placeholder:RED._("sidebar.project.versionControl.createRemoteBranchPlaceholder"),currentLabel:RED._("sidebar.project.versionControl.upstream"),remotes:function(){var e=RED.projects.getActiveProject();return Object.keys(e.git.remotes)},container:l,onselect:function(e){$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!1),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("disabled",!1),$("#red-ui-sidebar-vc-remote-branch").text(e.name+(e.create?" *":""));var i=RED.projects.getActiveProject();i.git.branches.remote===e.name?delete i.git.branches.remoteAlt:i.git.branches.remoteAlt=e.name,$("#red-ui-sidebar-vc-repo-toolbar-set-upstream-row").toggle(!!i.git.branches.remoteAlt),y(function(){var t,o;e.create?(i.git.branches.remote?$("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.selectUpstreamBranch")):($("#red-ui-sidebar-vc-repo-toolbar-message").text(RED._("sidebar.project.versionControl.trackedUpstreamBranch")),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked",!0),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("disabled",!0)),$("#red-ui-sidebar-vc-repo-pull").prop("disabled",!0),$("#red-ui-sidebar-vc-repo-push").prop("disabled",!1)):(t=Date.now(),o=j.addSpinnerOverlay($("#red-ui-sidebar-vc-repo-toolbar-message")).addClass("red-ui-component-spinner-contain"),$.getJSON("projects/"+i.name+"/branches/remote/"+e.name+"/status",function(e){setTimeout(function(){V(e.commits.ahead,e.commits.behind),o.remove()},Math.max(400-(Date.now()-t),0))}))})}}),e=$('<div style="margin-bottom: 5px;"></div>').appendTo(s);$('<button id="red-ui-sidebar-vc-repo-push" class="red-ui-sidebar-vc-repo-sub-action red-ui-button"><i class="fa fa-long-arrow-up"></i> <span data-i18n="sidebar.project.versionControl.push"></span></button>').appendTo(e).on("click",function(e){e.preventDefault();var t=j.addSpinnerOverlay(s).addClass("red-ui-component-spinner-contain"),e=$('<div style="position: relative; bottom: 60px;"></div>').appendTo(t),o=($('<button class="red-ui-button"></button>').text(RED._("eventLog.view")).appendTo(e).on("click",function(e){e.preventDefault(),RED.actions.invoke("core:show-event-log")}),RED.projects.getActiveProject()),e=(RED.eventLog.startEvent("Push changes"+(o.git.branches.remoteAlt?" : "+o.git.branches.remoteAlt:"")),"projects/"+o.name+"/push"),i=(o.git.branches.remoteAlt&&(e+="/"+o.git.branches.remoteAlt),$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked"));i&&(e+="?u=true"),j.sendRequest({url:e,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){i&&o.git.branches.remoteAlt&&(o.git.branches.remote=o.git.branches.remoteAlt,delete o.git.branches.remoteAlt),S(!0),d()},400:{git_push_failed:function(e){RED.notify(RED._("sidebar.project.versionControl.pushFailed"),"error")},unexpected_error:function(e){console.log(e)}}}},{}).always(function(){t.remove()})}),$('<button id="red-ui-sidebar-vc-repo-pull" class="red-ui-sidebar-vc-repo-sub-action red-ui-button"><i class="fa fa-long-arrow-down"></i> <span data-i18n="sidebar.project.versionControl.pull"></span></button>').appendTo(e).on("click",function(e){e.preventDefault(),c({setUpstream:$("#red-ui-sidebar-vc-repo-toolbar-set-upstream").prop("checked")})}),$('<div class="red-ui-shade red-ui-sidebar-vc-shade">').appendTo(D),RED.sidebar.addTab({id:"version-control",label:RED._("sidebar.project.versionControl.history"),name:RED._("sidebar.project.versionControl.projectHistory"),content:D,enableOnEdit:!1,pinned:!0,iconClass:"fa fa-code-fork",action:"core:show-version-control-tab",onchange:function(){setTimeout(function(){O.resize()},10)}})},show:q,refresh:S,showLocalChanges:function(){RED.sidebar.show("version-control"),T.expand()}}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var p=null,f=!1,h=!1,g=null;return{show:function(e,a,t){f=!0;try{for(var i=(p=d3.select("body").append("div").classed("red-ui-editor-radial-menu",!0).on("touchstart",function(){l(),d3.event.preventDefault()})).append("div").style({top:a[1]-80+"px",left:a[0]-80+"px"}),r=[],o=t.length,n=Math.max(Math.PI/(o-1),Math.PI/4),s=Math.PI,d=0;d<o;d++){var c=Math.floor(80*Math.cos(s)),u=Math.floor(80*Math.sin(s));t[d].name&&!function(e,t,o){o.el=i.append("div").classed("red-ui-editor-radial-menu-opt",!0).style({top:t+80-25+"px",left:e+80-25+"px"}).classed("red-ui-editor-radial-menu-opt-disabled",!!o.disabled),o.el.html(o.name),o.x=e,o.y=t,r.push(o),o.el.on("touchstart",function(){o.el.classed("red-ui-editor-radial-menu-opt-active",!0),d3.event.preventDefault(),d3.event.stopPropagation()}),o.el.on("touchend",function(){l(),o.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})}(c,u,t[d]),s+=n}var l=function(){f=!1,g=null,p.remove(),p=null};e.on("touchend.radial",function(){if(e.on("touchend.radial",null),e.on("touchmenu.radial",null),g){try{g.onselect()}catch(e){RED._debug(e)}l()}else h&&l()}),e.on("touchmove.radial",function(){try{for(var e,t=d3.event.touches.item(0),o=[t.pageX-a[0],t.pageY-a[1]],i=0;i<r.length;i++){var n=r[i];n.disabled||(o[0]>n.x-30&&o[0]<n.x+30&&o[1]>n.y-30&&o[1]<n.y+30?n!==g&&(n.el.classed("selected",!0),g=n):(n===g&&(g=null),n.el.classed("selected",!1)))}g||(e=Math.abs(o[0]*o[0]+o[1]*o[1]),h=6400<e)}catch(e){RED._debug(e)}})}catch(e){RED._debug(e)}},active:function(){return f}}}(),RED.tourGuide=function(){var u,p,f,h,g,m,b=[],i={};function t(t,o){i[t]?o(null,i[t]):import(t).then(function(e){i[t]=e.default,o(null,i[t])}).catch(function(e){o(e)})}function v(){var e,t;g&&(m?p.css({left:$(window).width()/2+"px",top:$(window).height()/2+"px",width:"0px",height:"0px"}):(e=g[0].getBoundingClientRect(),t=Math.max(50,1.5*Math.max(e.width,e.height)),p.css({left:e.left+e.width/2+"px",top:e.top+e.height/2+"px",width:2*t+"px",height:2*t+"px"}),p[0].offsetHeight,p.addClass("transition"),p.css({width:t+"px",height:t+"px"})),f&&f.move({target:g}))}function y(e,t,o){function i(){b.forEach(function(e){"dom-event"===e.type?e.target[0].removeEventListener(e.event,e.listener,e.opts):"nr-event"===e.type&&RED.events.off(e.event,e.listener)}),b=[],setTimeout(function(){o()},0)}if(e.complete){if(0!==e.complete.length)return f&&(f.element.hide(),m||(m=!0,v())),void e.complete.call(t,function(){f&&f.element.show(),i()});e.complete.call(t)}i()}function w(e){if("string"==typeof e)return e;var t=RED.i18n.lang()||"en-US",o=Object.keys(e);return e[t]||e["en-US"]||e[o[0]]}return{load:t,run:function(e,s){s=s||function(e){e&&console.error(e)},t(e,function(e,t){var o,i,n,a;function r(e){$(window).off("resize.red-ui-tourGuide"),$(document).off("keydown.red-ui-tourGuide"),f&&f.close(),f=h=null,u.remove(),u=null,i(e)}e?console.warn("Error loading tour:",e):(o=t,i=s,u=$('<div class="red-ui-tourGuide-shade"></div>').appendTo(document.body),p=$('<div class="red-ui-tourGuide-shade-focus"></div>').appendTo(u),$(window).on("resize.red-ui-tourGuide",function(){v()}),a={index:n=0,count:o.steps.length},function e(t){if(!1!==t)if(n!==o.steps.length){a.index=n;try{d=o.steps[n++],l=a,c=e,u.fadeIn(),function(e,t,o){if(e.prepare){if(0!==e.prepare.length)return f&&(f.element.hide(),m||(m=!0,v())),e.prepare.call(t,function(){f&&f.element.show(),o()});e.prepare.call(t)}o()}(d,l,function(){var e,t=d.direction||"bottom";if(m=!1,"string"==typeof d.element?g=$(d.element):"function"==typeof d.element?g=d.element.call(l):d.element?g=d.element:(g=$(".red-ui-editor"),m=!0,t="inset"),0===g.length)throw g=null,u.hide(),new Error("Element not found");$(window).width()<400&&(g=$(".red-ui-editor"),m=!0,t="inset"),e=g.css("z-index"),m||!d.interactive&&!d.wait||g.css("z-index",2002),v(),h?h.empty():h=$('<div style="position:relative"></div>'),$('<button type="button" class="red-ui-button red-ui-button-small" style="float: right; margin-top: -4px; margin-right: -4px;"><i class="fa fa-times"></i></button>').appendTo(h).click(function(e){e.preventDefault(),y(d,l,function(){c(!1)})});var o,i,n=$('<div class="red-ui-tourGuide-popover-description"></div>').appendTo(h),n=(d.titleIcon&&$('<h2><i class="'+d.titleIcon+'"></i></h2>').appendTo(n),d.title&&$("<h2>").text(w(d.title)).appendTo(n),$("<div>").css("text-align","left").html(w(d.description)).appendTo(n),d.image&&$(`<img src="red/tours/${d.image}" />`).appendTo(n),$("<div>",{class:"red-ui-tourGuide-toolbar"}).appendTo(h)),n=($("<small>").text(l.index+1+"/"+l.count).appendTo(n),!m&&d.wait||(o=$('<button type="button" class="red-ui-button" style="position: absolute; right:0;bottom:0;"></button>').appendTo(n).one("click",function(e){e.preventDefault(),s()}),l.index===l.count-1?$("<span></span>").text(RED._("common.label.close")).appendTo(o):0===l.index?($("<span>start</span>").text(RED._("tourGuide.start")).appendTo(o),$('<span style="margin-left: 6px"><i class="fa fa-chevron-right"></i></span>').appendTo(o)):l.index<l.count-1&&($("<span></span>").text(RED._("tourGuide.next")).appendTo(o),$('<span style="margin-left: 6px"><i class="fa fa-chevron-right"></i></span>').appendTo(o))),d.width),a=(m&&(n=500),Math.min($(window).width()-10,Math.max(n||0,300))),r=(f=f||RED.popover.create({target:g,width:n||"auto",maxWidth:a+"px",direction:t,class:"red-ui-tourGuide-popover"+(m?" ":""),trigger:"manual",content:h}).open(),$(document).off("keydown.red-ui-tourGuide"),$(document).on("keydown.red-ui-tourGuide",function(e){"Escape"!==e.key&&"Esc"!==e.key||(e.preventDefault(),e.stopPropagation(),y(d,l,function(){c(!1)}))}),f.element.toggleClass("red-ui-tourGuide-popover-full",!!m),f.move({target:g,width:n||"auto",maxWidth:a+"px",direction:t}),setTimeout(function(){f.element.position().left<0&&f.element.css({left:0})},100),o&&setTimeout(function(){o.focus()},100),g[0]instanceof SVGElement),s=(d.fallback&&p.one("mouseenter",function(e){setTimeout(function(){var e=g[0].getBoundingClientRect(),e=Math.max(50,1.5*Math.max(e.width,e.height));p.css({width:4*e+"px",height:4*e+"px"}),u.fadeOut(),f.move({target:$(".red-ui-editor"),direction:d.fallback,offset:10,transition:!0})},r?0:500)}),function(){p.removeClass("transition"),g.css("z-index",e),y(d,l,c)});d.wait&&("dom-event"===d.wait.type?(n=g,d.wait.element&&("string"==typeof d.wait.element?n=$(d.wait.element):"function"==typeof d.wait.element&&(n=d.wait.element.call(l))),i={type:d.wait.type,target:n,event:d.wait.event,listener:function(){s()},opts:{once:!0}},b.push(i),n[0].addEventListener(i.event,i.listener,i.opts)):"nr-event"===d.wait.type&&(i={type:d.wait.type,event:d.wait.event,listener:function(){d.wait.filter&&!d.wait.filter.apply(l,arguments)||s()}},b.push(i),RED.events.on(i.event,i.listener)))})}catch(e){return void r(e)}var d,l,c}else r();else r(!1)}())})},reset:function(){RED.settings.set("editor.tours.welcome","")}}}();